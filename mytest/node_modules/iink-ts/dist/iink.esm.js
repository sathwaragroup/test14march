var i,s,r,n;!function(i){i.Write="write",i.Erase="erase",i.Select="select",i.Move="move"}(i||(i={})),function(i){i.Pencil="pencil",i.Rectangle="rectangle",i.Rhombus="rhombus",i.Circle="circle",i.Ellipse="ellipse",i.Triangle="triangle",i.Parallelogram="parallelogram",i.Line="line",i.Arrow="arrow",i.DoubleArrow="double-arrow"}(s||(s={})),function(i){i.Guide="guide",i.InteractElementsGroup="interact-elements-group",i.Translate="translate",i.Resize="resize",i.Rotate="rotate"}(r||(r={})),function(i){i.North="n-resize",i.East="e-resize",i.South="s-resize",i.West="w-resize",i.NorthEast="ne-resize",i.NorthWest="nw-resize",i.SouthEast="se-resize",i.SouthWest="sw-resize"}(n||(n={}));const a=10;function __awaiter(i,s,r,n){return new(r||(r=Promise))((function(a,l){function fulfilled(i){try{step(n.next(i))}catch(i){l(i)}}function rejected(i){try{step(n.throw(i))}catch(i){l(i)}}function step(i){i.done?a(i.value):function adopt(i){return i instanceof r?i:new r((function(s){s(i)}))}(i.value).then(fulfilled,rejected)}step((n=n.apply(i,s||[])).next())}))}function __classPrivateFieldGet(i,s,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof s?i!==s||!n:!s.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(i):n?n.value:s.get(i)}function __classPrivateFieldSet(i,s,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof s?i!==s||!a:!s.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(i,r):a?a.value=r:s.set(i,r),r}"function"==typeof SuppressedError&&SuppressedError;var l,d,h,c;!function(i){i.DEBUG="1",i.INFO="2",i.WARN="3",i.ERROR="4"}(l||(l={})),function(i){i.EDITOR="EDITOR",i.RECOGNIZER="RECOGNIZER",i.GRABBER="GRABBER",i.BEHAVIORS="BEHAVIORS",i.GESTURE="GESTURE",i.CONFIGURATION="CONFIGURATION",i.PUBLIC_EVENT="PUBLIC_EVENT",i.MODEL="MODEL",i.RENDERER="RENDERER",i.SMARTGUIDE="SMARTGUIDE",i.STYLE="STYLE",i.HISTORY="HISTORY",i.SYMBOL="SYMBOL",i.INTERNAL_EVENT="INTERNAL_EVENT",i.WRITE="WRITE",i.TRANSFORMER="TRANSFORMER",i.CONVERTER="CONVERTER",i.SELECTION="SELECTION",i.SVGDEBUG="SVGDEBUG",i.MENU="MENU"}(d||(d={}));class Logger{constructor(i,s){this.instanceName=i,this.level=s}debug(i,...s){if(l.DEBUG>=this.level){const r={from:`${this.instanceName}.${i}`,message:s};console.debug(r)}}info(i,...s){if(l.INFO>=this.level){const r={from:`${this.instanceName}.${i}`,message:s};console.info(r)}}warn(i,...s){if(l.WARN>=this.level){const r={from:`${this.instanceName}.${i}`,message:s};console.warn(r)}}error(i,...s){const r={from:`${this.instanceName}.${i}`,error:s};console.error(r)}}class LoggerManager{static getLogger(i){return __classPrivateFieldGet(this,h,"f",c).has(i)||__classPrivateFieldGet(this,h,"f",c).set(i,new Logger(i,l.ERROR)),__classPrivateFieldGet(this,h,"f",c).get(i)}static setLoggerLevel(i){Object.keys(i).forEach((s=>{h.getLogger(s).level=i[s]}))}}h=LoggerManager,c={value:new Map};class DeferredPromise{constructor(){this.isFullFilled=!1,this.isPending=!0,this.promise=new Promise(((i,s)=>{this.reject=i=>__awaiter(this,void 0,void 0,(function*(){return this.isFullFilled=!0,this.isPending=!1,s(i)})),this.resolve=s=>__awaiter(this,void 0,void 0,(function*(){return this.isFullFilled=!0,this.isPending=!1,i(s)}))}))}}function isValidNumber(i){return null!=i&&(!isNaN(parseFloat(i.toString()))&&isFinite(+i))}function isBetween(i,s,r){return i>=s&&i<=r}function computeAverage(i){return i.reduce(((i,s)=>i+s),0)/(i.length||1)}function computeDistance(i,s){const r=Math.hypot(s.y-i.y,s.x-i.x);return isNaN(r)?0:r}function computeAngleAxeRadian(i,s){return Math.atan2(s.y-i.y,s.x-i.x)}function createPointsOnSegment(i,s,r=1){const n=[],a=computeDistance(i,s);let l=r;for(;l<a;){const d={x:i.x+l*(s.x-i.x)/a,y:i.y+l*(s.y-i.y)/a};n.push(d),l+=r}return n}function scalaire(i,s){return i.x*s.x+i.y*s.y}function computeNearestPointOnSegment(i,s){const r={x:i.x-s.p1.x,y:i.y-s.p1.y},n={x:s.p2.x-s.p1.x,y:s.p2.y-s.p1.y};if(0===n.x&&0===n.y)return s.p1;const a=scalaire(r,n),l=scalaire(n,n),d=Math.min(1,Math.max(0,a/l));return{x:s.p1.x+n.x*d,y:s.p1.y+n.y*d}}function isPointInsideBox(i,s){return isBetween(i.x,s.x,s.x+s.width)&&isBetween(i.y,s.y,s.y+s.height)}function convertRadianToDegree(i){return+(i%(2*Math.PI)/Math.PI*180).toFixed(4)}function convertDegreeToRadian(i){return+(i%360/180*Math.PI).toFixed(4)}function computeRotatedPoint(i,s,r){const n=i.x-s.x,a=i.y-s.y,l=Math.cos(r),d=Math.sin(r);return{x:+(s.x+l*n-d*a).toFixed(3),y:+(s.y+d*n+l*a).toFixed(3)}}function computePointOnEllipse(i,s,r,n,a){const l=Math.cos(n),d=Math.sin(n),h=Math.abs(s)*Math.cos(a),c=Math.abs(r)*Math.sin(a);return{x:+(i.x+l*h-d*c).toFixed(3),y:+(i.y+d*h+l*c).toFixed(3)}}function computeDistanceBetweenPointAndSegment(i,s){return computeDistance(i,computeNearestPointOnSegment(i,s))}function findIntersectionBetween2Segment(i,s){if(i.p1.x===s.p1.x&&i.p1.y===s.p1.y)return i.p1;if(i.p1.x===s.p2.x&&i.p1.y===s.p2.y)return i.p1;if(i.p2.x===s.p1.x&&i.p2.y===s.p1.y)return i.p2;if(i.p2.x===s.p2.x&&i.p2.y===s.p2.y)return i.p2;const r=i.p2.x-i.p1.x,n=i.p2.y-i.p1.y,a=s.p2.x-s.p1.x,l=s.p2.y-s.p1.y,d=i.p1.x-s.p1.x,h=i.p1.y-s.p1.y,c=a*h-l*d,u=r*h-n*d,p=l*r-a*n;if(0===c||0===u||0===p)return;const m=c/p,v=u/p;return isBetween(m,0,1)&&isBetween(v,0,1)?{x:i.p1.x+m*r,y:i.p1.y+m*n}:void 0}function findIntersectBetweenSegmentAndCircle(i,s,r){const n=[],a=Math.pow(i.p2.x-i.p1.x,2)+Math.pow(i.p2.y-i.p1.y,2),l=2*((i.p2.x-i.p1.x)*(i.p1.x-s.x)+(i.p2.y-i.p1.y)*(i.p1.y-s.y)),d=Math.pow(s.x,2)+Math.pow(s.y,2)+Math.pow(i.p1.x,2)+Math.pow(i.p1.y,2)-2*(s.x*i.p1.x+s.y*i.p1.y)-Math.pow(r,2),h=Math.pow(l,2)-4*a*d;if(h<=0)return[];const c=Math.sqrt(h),u=(-l+c)/(2*a),p=(-l-c)/(2*a);return(u<0||u>1)&&(p<0||p>1)||(isBetween(u,0,1)&&n.push({x:(i.p2.x-i.p1.x)*u+i.p1.x,y:(i.p2.y-i.p1.y)*u+i.p1.y}),isBetween(p,0,1)&&n.push({x:(i.p2.x-i.p1.x)*p+i.p1.x,y:(i.p2.y-i.p1.y)*p+i.p1.y})),n}function computeAngleRadian(i,s,r){const n=Math.sqrt(Math.pow(s.x-i.x,2)+Math.pow(s.y-i.y,2)),a=Math.sqrt(Math.pow(s.x-r.x,2)+Math.pow(s.y-r.y,2)),l=Math.sqrt(Math.pow(r.x-i.x,2)+Math.pow(r.y-i.y,2));return Math.acos((a*a+n*n-l*l)/(2*a*n))}function getClosestPoints(i,s){let r=i[0],n=s[0],a=Number.MAX_SAFE_INTEGER;return i.forEach((i=>{s.forEach((s=>{const l=computeDistance(i,s);a>l&&(a=l,r=i,n=s)}))})),{p1:r,p2:n}}function getClosestPoint(i,s){let r,n=Number.MAX_SAFE_INTEGER,a=-1;return i.forEach(((i,l)=>{const d=computeDistance(i,s);n>d&&(n=d,r=i,a=l)})),{point:r,index:a}}function isPointInsidePolygon(i,s){let r=!1;for(let n=0,a=s.length-1;n<s.length;a=n++){const l=s[n],d=s[a];l.y>i.y!=d.y>i.y&&i.x<(d.x-l.x)*(i.y-l.y)/(d.y-l.y)+l.x&&(r=!r)}return r}const isVersionSuperiorOrEqual=(i,s)=>{const r=i.split("."),n=s.split(".");for(let i=0;i<n.length;i++){const s=Number(n[i]),a=Number(r[i]);if(s>a)return!1;if(s<a)return!0}return!0};function computeHmac(i,s,r){return __awaiter(this,void 0,void 0,(function*(){const n=new TextEncoder,a=n.encode(i),l=n.encode(s+r),d=yield crypto.subtle.importKey("raw",l,{name:"HMAC",hash:{name:"SHA-512"}},!1,["sign"]),h=yield crypto.subtle.sign("HMAC",d,a),c=new Uint8Array(h);return Array.prototype.map.call(c,(i=>i.toString(16).padStart(2,"0"))).join("")}))}function convertMillimeterToPixel(i){return+(96*i/25.4).toFixed(3)}function convertPixelToMillimeter(i){return+(i/96*25.4).toFixed(3)}function convertBoundingBoxMillimeterToPixel(i){return i?{x:convertMillimeterToPixel(i.x),y:convertMillimeterToPixel(i.y),width:convertMillimeterToPixel(i.width),height:convertMillimeterToPixel(i.height)}:{height:0,width:0,x:0,y:0}}function createUUID(){let i=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(s){const r=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==s?r:3&r|8).toString(16)}))}const mergeDeep=(i,...s)=>{const isObject=i=>i&&"object"==typeof i&&!Array.isArray(i);if(!s.length)return i;const r=s.shift();if(isObject(i)&&isObject(r))for(const s in r)isObject(r[s])?(i[s]||Object.assign(i,{[s]:{}}),mergeDeep(i[s],r[s])):Array.isArray(i[s])&&Array.isArray(r[s])?i[s].concat(r[s]):Object.assign(i,{[s]:r[s]});else Array.isArray(i)&&Array.isArray(r)?i=i.concat(r):r&&(i=r);return mergeDeep(i,...s)};function getAvailableFontList(i){var s,r,n;return __awaiter(this,void 0,void 0,(function*(){if(!(null===(s=null==i?void 0:i.server)||void 0===s?void 0:s.scheme)&&!(null===(r=null==i?void 0:i.server)||void 0===r?void 0:r.host))return Promise.reject("Failed to get fonts: configuration.server.scheme & configuration.server.host are required!");if(!(null===(n=null==i?void 0:i.recognition)||void 0===n?void 0:n.lang))return Promise.reject("Failed to get fonts: configuration.recognition.lang is required!");const a=i.server,l=yield fetch(`${a.scheme}://${a.host}/api/v4.0/iink/font/google/language/`+i.recognition.lang),{result:d}=yield l.json();return d.sort()}))}function getAvailableLanguageList(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){if((null===(s=null==i?void 0:i.server)||void 0===s?void 0:s.scheme)&&(null===(r=null==i?void 0:i.server)||void 0===r?void 0:r.host)){const s=i.server;return(yield fetch(`${s.scheme}://${s.host}/api/v4.0/iink/availableLanguageList`)).json()}return Promise.reject("Failed to get languages: configuration.server.scheme & configuration.server.host are required!")}))}function computeLinksPointers(i,s,r){const n=i.p*r;return[{x:+(i.x-Math.sin(s)*n).toFixed(3),y:+(i.y+Math.cos(s)*n).toFixed(3)},{x:+(i.x+Math.sin(s)*n).toFixed(3),y:+(i.y-Math.cos(s)*n).toFixed(3)}]}function computeMiddlePointer(i,s){return{x:+((s.x+i.x)/2).toFixed(3),y:+((s.y+i.y)/2).toFixed(3),p:+((s.p+i.p)/2).toFixed(3),t:+((s.t+i.t)/2).toFixed(3)}}const u={capture:!1,passive:!0},p={listenerOptions:u,xyFloatPrecision:0,timestampFloatPrecision:0,delayLongTouch:500},m={enable:!0,style:{enable:!0},intention:{enable:!0},action:{enable:!0},context:{enable:!0}},v={"erase-precisely":!1},g={types:["text","shape"],"match-text-size":!0},y={convert:g,eraser:v,mimeTypes:["application/vnd.myscript.jiix"]},f={"bounding-box":!1,strokes:!1,ids:!1,"full-stroke-ids":!1,text:{chars:!1,words:!0}},b={"image-resolution":300,jiix:f},x={top:20,left:10,right:10,bottom:10},w={enable:!0,"fractional-part-digits":3,"decimal-separator":".","rounding-mode":"half up","angle-unit":"deg"},S={mode:"stroke"},_={solver:w,margin:x,eraser:v,"undo-redo":S,mimeTypes:["application/vnd.myscript.jiix"]},P={recognition:{types:["text","shape"]},eraser:v,gestures:["underline","scratch-out","join","insert","strike-through","surround"]},k={"draw-text-boxes":!1,"draw-image-boxes":!1},E={debug:k},M={enable:!0},G={guides:M,eraser:v,margin:x,mimeTypes:["application/vnd.myscript.jiix"]},C={force:{"on-stylesheet-change":!1}},F={diagram:y,export:b,math:_,"raw-content":P,renderer:E,text:G,type:"TEXT",alwaysConnected:!0,lang:"en_US",gesture:{enable:!0,ignoreGestureStrokes:!1},convert:C},L={enable:!0,gap:50,type:"point"},I={enable:!0},T={guides:L,smartGuide:I,minHeight:100,minWidth:100},O={protocol:"WEBSOCKET",scheme:"https",host:"cloud.myscript.com",applicationKey:"",hmacKey:"",version:"2.3.0",useWindowLocation:!1,websocket:{pingEnabled:!0,pingDelay:15e3,maxPingLostCount:20,autoReconnect:!0,maxRetryCount:2,fileChunkSize:3e5}},D={exportContent:"POINTER_UP",exportContentDelay:1e3,resizeTriggerDelay:100},R={maxStackSize:100};var A;const B={offscreen:!1,server:O,recognition:F,grabber:p,rendering:T,triggers:D,"undo-redo":R,menu:m};class Configuration{constructor(i){A.set(this,LoggerManager.getLogger(d.CONFIGURATION)),__classPrivateFieldGet(this,A,"f").info("constructor",{configuration:i}),this.offscreen=B.offscreen,this.grabber=structuredClone(B.grabber),this.recognition=structuredClone(B.recognition),this.rendering=structuredClone(B.rendering),this.server=structuredClone(B.server),this["undo-redo"]=structuredClone(B["undo-redo"]),this.triggers=structuredClone(B.triggers),this.menu=structuredClone(B.menu),this.overrideDefaultConfiguration(i)}overrideDefaultConfiguration(i){var s,r,n,a,l,d,h,c,u,p,m,v,g,y,f;__classPrivateFieldGet(this,A,"f").info("overrideDefaultConfiguration",{configuration:i});const b=structuredClone(B);this.offscreen=Boolean(null==i?void 0:i.offscreen),this.grabber=mergeDeep({},b.grabber,null==i?void 0:i.grabber),this.recognition=mergeDeep({},b.recognition,null==i?void 0:i.recognition),this.rendering=mergeDeep({},b.rendering,null==i?void 0:i.rendering),this.server=mergeDeep({},b.server,null==i?void 0:i.server),this.triggers=mergeDeep({},b.triggers,null==i?void 0:i.triggers),this["undo-redo"]=mergeDeep({},b["undo-redo"],null==i?void 0:i["undo-redo"]),this.menu=mergeDeep({},b.menu,null==i?void 0:i.menu),(null===(r=null===(s=null==i?void 0:i.recognition)||void 0===s?void 0:s.text)||void 0===r?void 0:r.mimeTypes)&&(this.recognition.text.mimeTypes=i.recognition.text.mimeTypes),(null===(a=null===(n=null==i?void 0:i.recognition)||void 0===n?void 0:n.math)||void 0===a?void 0:a.mimeTypes)&&(this.recognition.math.mimeTypes=i.recognition.math.mimeTypes),(null===(d=null===(l=null==i?void 0:i.recognition)||void 0===l?void 0:l.diagram)||void 0===d?void 0:d.mimeTypes)&&(this.recognition.diagram.mimeTypes=i.recognition.diagram.mimeTypes),(null===(u=null===(c=null===(h=null==i?void 0:i.recognition)||void 0===h?void 0:h.diagram)||void 0===c?void 0:c.convert)||void 0===u?void 0:u.types)&&(this.recognition.diagram.convert.types=i.recognition.diagram.convert.types),(null===(m=null===(p=null==i?void 0:i.recognition)||void 0===p?void 0:p["raw-content"])||void 0===m?void 0:m.gestures)&&(this.recognition["raw-content"].gestures=i.recognition["raw-content"].gestures),(null===(y=null===(g=null===(v=null==i?void 0:i.recognition)||void 0===v?void 0:v["raw-content"])||void 0===g?void 0:g.recognition)||void 0===y?void 0:y.types)&&(this.recognition["raw-content"].recognition.types=i.recognition["raw-content"].recognition.types),(null===(f=this.server)||void 0===f?void 0:f.useWindowLocation)&&(this.server.scheme=window.location.protocol.indexOf("s")>-1?"https":"http",this.server.host=window.location.host),this.offscreen?(this.recognition.type="Raw Content",this.rendering.smartGuide.enable=!1,this.server.protocol="WEBSOCKET",this.recognition.export.jiix["full-stroke-ids"]=!0,this.recognition.export.jiix.ids=!0,this.recognition.export.jiix.text.words=!0,this.recognition.export.jiix.text.chars=!0,this.recognition.export.jiix["bounding-box"]=!0):("REST"===this.server.protocol&&"POINTER_UP"===this.triggers.exportContent&&(this.triggers.exportContent="QUIET_PERIOD",this.triggers.exportContentDelay=Math.max(this.triggers.exportContentDelay,50)),"WEBSOCKET"===this.server.protocol&&"TEXT"===this.recognition.type?this.rendering.smartGuide.enable&&!this.recognition.text.mimeTypes.includes("application/vnd.myscript.jiix")&&this.recognition.text.mimeTypes.push("application/vnd.myscript.jiix"):this.rendering.smartGuide.enable=!1,delete this.recognition["raw-content"].gestures,this.menu.style.enable=!1),__classPrivateFieldGet(this,A,"f").debug("overrideDefaultConfiguration",{configuration:this})}}A=new WeakMap;const $={[d.EDITOR]:l.ERROR,[d.BEHAVIORS]:l.ERROR,[d.RECOGNIZER]:l.ERROR,[d.GRABBER]:l.ERROR,[d.RENDERER]:l.ERROR,[d.CONFIGURATION]:l.ERROR,[d.PUBLIC_EVENT]:l.ERROR,[d.INTERNAL_EVENT]:l.ERROR,[d.MODEL]:l.ERROR,[d.SYMBOL]:l.ERROR,[d.SMARTGUIDE]:l.ERROR,[d.GESTURE]:l.ERROR,[d.STYLE]:l.ERROR,[d.HISTORY]:l.ERROR,[d.TRANSFORMER]:l.ERROR,[d.CONVERTER]:l.ERROR,[d.WRITE]:l.ERROR,[d.SELECTION]:l.ERROR,[d.SVGDEBUG]:l.ERROR,[d.MENU]:l.ERROR};var N,z,j,V,H,U,W,Y,X,q,J,Z,K,Q,ee,te,ie,se,re,ne,oe;!function(i){i.SVG_PATCH="internal_svg_patch",i.EXPORTED="internal_exported",i.CLEAR_MESSAGE="internal_clear_message",i.ERROR="internal_error",i.NOTIF="internal_notif",i.IMPORT_JIIX="internal_import_jiix",i.CONVERT="internal_convert",i.CLEAR="internal_clear",i.CONTEXT_CHANGE="internal_context_change",i.IDLE="internal_idle",i.SELECTED="internal_selected",i.INTENTION="internal_intention"}(W||(W={}));class InternalEvent extends EventTarget{constructor(){super(),N.add(this),V.set(this,void 0),H.set(this,LoggerManager.getLogger(d.INTERNAL_EVENT)),__classPrivateFieldGet(this,H,"f").info("constructor"),__classPrivateFieldSet(this,V,new AbortController,"f")}static getInstance(){return __classPrivateFieldGet(z,z,"f",j)||__classPrivateFieldSet(z,z,new z,"f",j),__classPrivateFieldGet(z,z,"f",j)}removeAllListeners(){__classPrivateFieldGet(this,H,"f").info("removeAllListeners"),__classPrivateFieldGet(this,V,"f").abort(),__classPrivateFieldSet(this,V,new AbortController,"f")}emitSVGPatch(i){__classPrivateFieldGet(this,H,"f").info("emitSVGPatch",{patchChange:i}),__classPrivateFieldGet(this,N,"m",U).call(this,W.SVG_PATCH,i)}addSVGPatchListener(i){__classPrivateFieldGet(this,H,"f").info("addSVGPatchListener",{callback:i}),this.addEventListener(W.SVG_PATCH,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitExported(i){__classPrivateFieldGet(this,H,"f").info("emitExported",{exports:i}),__classPrivateFieldGet(this,N,"m",U).call(this,W.EXPORTED,i)}addExportedListener(i){__classPrivateFieldGet(this,H,"f").info("addExportedListener",{callback:i}),this.addEventListener(W.EXPORTED,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitClearMessage(){__classPrivateFieldGet(this,H,"f").info("emitClearMessage"),__classPrivateFieldGet(this,N,"m",U).call(this,W.CLEAR_MESSAGE)}addClearMessageListener(i){__classPrivateFieldGet(this,H,"f").info("addClearMessageListener",{callback:i}),this.addEventListener(W.CLEAR_MESSAGE,(()=>i()),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitError(i){__classPrivateFieldGet(this,H,"f").info("emitError",{err:i}),__classPrivateFieldGet(this,N,"m",U).call(this,W.ERROR,i)}addErrorListener(i){__classPrivateFieldGet(this,H,"f").info("addErrorListener",{callback:i}),this.addEventListener(W.ERROR,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitNotif(i){__classPrivateFieldGet(this,H,"f").info("emitWNotif",{notif:i}),__classPrivateFieldGet(this,N,"m",U).call(this,W.NOTIF,i)}addNotifListener(i){__classPrivateFieldGet(this,H,"f").info("addNotifListener",{callback:i}),this.addEventListener(W.NOTIF,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitImportJIIX(i){__classPrivateFieldGet(this,H,"f").info("emitImportJIIX",{jiix:i}),__classPrivateFieldGet(this,N,"m",U).call(this,W.IMPORT_JIIX,i)}addImportJIIXListener(i){__classPrivateFieldGet(this,H,"f").info("addImportJIIXListener",{callback:i}),this.addEventListener(W.IMPORT_JIIX,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitConvert(i="DIGITAL_EDIT"){__classPrivateFieldGet(this,H,"f").info("emitConvert",{conversionState:i}),__classPrivateFieldGet(this,N,"m",U).call(this,W.CONVERT,i)}addConvertListener(i){__classPrivateFieldGet(this,H,"f").info("addConvertListener",{callback:i}),this.addEventListener(W.CONVERT,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitClear(){__classPrivateFieldGet(this,H,"f").info("emitClear"),__classPrivateFieldGet(this,N,"m",U).call(this,W.CLEAR)}addClearListener(i){__classPrivateFieldGet(this,H,"f").info("addClearListener",{callback:i}),this.addEventListener(W.CLEAR,(()=>i()),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitContextChange(i){__classPrivateFieldGet(this,H,"f").info("emitContextChange",{context:i}),__classPrivateFieldGet(this,N,"m",U).call(this,W.CONTEXT_CHANGE,i)}addContextChangeListener(i){__classPrivateFieldGet(this,H,"f").info("addContextChangeListener",{callback:i}),this.addEventListener(W.CONTEXT_CHANGE,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitIdle(i){__classPrivateFieldGet(this,H,"f").info("emitIdle",{idle:i}),__classPrivateFieldGet(this,N,"m",U).call(this,W.IDLE,i)}addIdleListener(i){__classPrivateFieldGet(this,H,"f").info("addIdleListener",{callback:i}),this.addEventListener(W.IDLE,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitSelected(i){__classPrivateFieldGet(this,N,"m",U).call(this,W.SELECTED,i)}addSelectedListener(i){__classPrivateFieldGet(this,H,"f").info("addSelectedListener",{callback:i}),this.addEventListener(W.SELECTED,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}emitIntention(i){__classPrivateFieldGet(this,N,"m",U).call(this,W.INTENTION,i)}addIntentionListener(i){__classPrivateFieldGet(this,H,"f").info("addSelectedListener",{callback:i}),this.addEventListener(W.INTENTION,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,V,"f").signal})}}z=InternalEvent,V=new WeakMap,H=new WeakMap,N=new WeakSet,U=function _InternalEvent_emit(i,s){this.dispatchEvent(new CustomEvent(i,Object.assign({bubbles:!0,composed:!0},s?{detail:s}:void 0)))},j={value:void 0},function(i){i.CHANGED="changed",i.CLEARED="cleared",i.CONVERTED="converted",i.ERROR="error",i.POINTEREVENTS="pointer_events",i.EXPORTED="exported",i.IMPORTED="imported",i.IDLE="idle",i.LOADED="loaded",i.SELECTED="selected",i.INTENTION="intention"}(Q||(Q={}));class PublicEvent extends EventTarget{constructor(){super(),Y.add(this),J.set(this,void 0),Z.set(this,LoggerManager.getLogger(d.PUBLIC_EVENT))}static getInstance(){return __classPrivateFieldGet(X,X,"f",q)||__classPrivateFieldSet(X,X,new X,"f",q),__classPrivateFieldGet(X,X,"f",q)}setElement(i){__classPrivateFieldGet(this,Z,"f").info("setElement",{el:i}),__classPrivateFieldSet(this,J,i,"f")}emitLoaded(){__classPrivateFieldGet(this,Z,"f").info("emitLoaded"),__classPrivateFieldGet(this,Y,"m",K).call(this,Q.LOADED)}emitExported(i){__classPrivateFieldGet(this,Z,"f").info("emitExported",{exports:i}),__classPrivateFieldGet(this,Y,"m",K).call(this,Q.EXPORTED,i)}emitChanged(i){__classPrivateFieldGet(this,Z,"f").info("emitChanged",{undoRedoContext:i}),__classPrivateFieldGet(this,Y,"m",K).call(this,Q.CHANGED,Object.assign(Object.assign({},i),{canClear:!i.empty}))}emitIdle(i){__classPrivateFieldGet(this,Z,"f").info("emitIdle",{idle:i}),__classPrivateFieldGet(this,Y,"m",K).call(this,Q.IDLE,i)}emitCleared(i){__classPrivateFieldGet(this,Z,"f").info("emitCleared",{model:i}),__classPrivateFieldGet(this,Y,"m",K).call(this,Q.CLEARED,i)}emitConverted(i){__classPrivateFieldGet(this,Z,"f").info("emitConverted",{exports:i}),__classPrivateFieldGet(this,Y,"m",K).call(this,Q.CONVERTED,i)}emitImported(i){__classPrivateFieldGet(this,Z,"f").info("emitImported",{exports:i}),__classPrivateFieldGet(this,Y,"m",K).call(this,Q.IMPORTED,i)}emitSelected(i){__classPrivateFieldGet(this,Y,"m",K).call(this,Q.SELECTED,i)}emitIntention(i){__classPrivateFieldGet(this,Y,"m",K).call(this,Q.INTENTION,i)}}X=PublicEvent,J=new WeakMap,Z=new WeakMap,Y=new WeakSet,K=function _PublicEvent_emit(i,s){var r;const n=new CustomEvent(i,Object.assign({bubbles:!0,composed:!0},s?{detail:s}:void 0));this.dispatchEvent(n),null===(r=__classPrivateFieldGet(this,J,"f"))||void 0===r||r.dispatchEvent(n)},q={value:void 0};class OIPointerEventGrabber{constructor(i){ee.set(this,LoggerManager.getLogger(d.GRABBER)),this.prevent=i=>i.preventDefault(),this.pointerDownHandler=i=>{if(__classPrivateFieldGet(this,ee,"f").info("pointerDown",{evt:i}),0===i.button&&1===i.buttons&&(this.activePointerId=i.pointerId,this.onPointerDown)){const s=this.extractPoint(i);this.onPointerDown(i,s)}},this.pointerMoveHandler=i=>{if(__classPrivateFieldGet(this,ee,"f").info("pointerMove",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId&&this.onPointerMove){const s=this.extractPoint(i);this.onPointerMove(i,s)}},this.pointerUpHandler=i=>{if(__classPrivateFieldGet(this,ee,"f").info("pointerUp",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId&&(this.activePointerId=void 0,i.stopPropagation(),this.onPointerUp)){const s=this.extractPoint(i);this.onPointerUp(i,s)}},this.pointerOutHandler=i=>{if(null!=this.activePointerId&&this.activePointerId===i.pointerId&&!this.domElement.contains(i.target)&&(i.stopPropagation(),this.activePointerId=void 0,this.onPointerUp)){const s=this.extractPoint(i);this.onPointerUp(i,s)}},this.contextMenuHandler=i=>{const s=this.extractPoint(i);this.onContextMenu(i.target,s)},__classPrivateFieldGet(this,ee,"f").info("constructor",{configuration:i}),this.configuration=i}roundFloat(i,s){if(s>=0){const r=Math.pow(10,s);return Math.round(i/r)*r}return __classPrivateFieldGet(this,ee,"f").debug("roundFloat",{oneFloat:i,requestedFloatPrecision:s}),i}extractPoint(i){let s,r;({clientX:s,clientY:r}="changedTouches"in i?i.changedTouches[0]:i);const n=this.domElement.getBoundingClientRect(),a={x:this.roundFloat(s-n.left-this.domElement.clientLeft+this.domElement.scrollLeft,this.configuration.xyFloatPrecision),y:this.roundFloat(r-n.top-this.domElement.clientTop+this.domElement.scrollTop,this.configuration.xyFloatPrecision),t:this.roundFloat(Date.now(),this.configuration.timestampFloatPrecision),p:i.pressure};return __classPrivateFieldGet(this,ee,"f").debug("extractPoint",{event:i,pointer:a}),a}stopPointerEvent(){this.activePointerId=void 0}attach(i){__classPrivateFieldGet(this,ee,"f").info("attach",{domElement:i}),this.domElement&&this.detach(),this.domElement=i,this.domElement.addEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),this.domElement.addEventListener("contextmenu",this.contextMenuHandler)}detach(){var i,s,r,n,a,l,d;__classPrivateFieldGet(this,ee,"f").info("detach"),null===(i=this.domElement)||void 0===i||i.removeEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),null===(s=this.domElement)||void 0===s||s.removeEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),null===(r=this.domElement)||void 0===r||r.removeEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),null===(n=this.domElement)||void 0===n||n.removeEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),null===(a=this.domElement)||void 0===a||a.removeEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),null===(l=this.domElement)||void 0===l||l.removeEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),null===(d=this.domElement)||void 0===d||d.removeEventListener("contextmenu",this.contextMenuHandler)}}ee=new WeakMap;class PointerEventGrabber{constructor(i){this.prevent=i=>i.preventDefault(),te.set(this,LoggerManager.getLogger(d.GRABBER)),this.pointerDownHandler=i=>{if(__classPrivateFieldGet(this,te,"f").info("pointerDown",{evt:i}),0===i.button&&1===i.buttons&&(this.activePointerId=i.pointerId,this.onPointerDown)){const s=this.extractPoint(i);this.onPointerDown(i,s)}},this.pointerMoveHandler=i=>{if(__classPrivateFieldGet(this,te,"f").info("pointerMove",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId){if(i.target.classList.contains("smartguide"))return void this.pointerUpHandler(i);if(this.onPointerMove){const s=this.extractPoint(i);this.onPointerMove(i,s)}}},this.pointerUpHandler=i=>{if(__classPrivateFieldGet(this,te,"f").info("pointerUp",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId&&(this.activePointerId=void 0,i.stopPropagation(),this.onPointerUp)){const s=this.extractPoint(i);this.onPointerUp(i,s)}},this.pointerOutHandler=i=>{if(null!=this.activePointerId&&this.activePointerId===i.pointerId&&!this.domElement.contains(i.target)&&(i.stopPropagation(),this.activePointerId=void 0,this.onPointerUp)){const s=this.extractPoint(i);this.onPointerUp(i,s)}},__classPrivateFieldGet(this,te,"f").info("constructor",{configuration:i}),this.configuration=i}roundFloat(i,s){if(s>=0){const r=Math.pow(10,s);return Math.round(i/r)*r}return __classPrivateFieldGet(this,te,"f").debug("roundFloat",{oneFloat:i,requestedFloatPrecision:s}),i}extractPoint(i){let s,r;({clientX:s,clientY:r}="changedTouches"in i?i.changedTouches[0]:i);const n=this.domElement.getBoundingClientRect(),a={x:this.roundFloat(s-n.left-this.domElement.clientLeft+this.domElement.scrollLeft,this.configuration.xyFloatPrecision),y:this.roundFloat(r-n.top-this.domElement.clientTop+this.domElement.scrollTop,this.configuration.xyFloatPrecision),t:this.roundFloat(Date.now(),this.configuration.timestampFloatPrecision),p:i.pressure||1};return __classPrivateFieldGet(this,te,"f").debug("extractPoint",{event:i,pointer:a}),a}attach(i){__classPrivateFieldGet(this,te,"f").info("attach",{domElement:i}),this.domElement&&this.detach(),this.domElement=i,this.domElement.addEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),this.domElement.addEventListener("touchmove",this.prevent),document.documentElement.addEventListener("pointerdown",(()=>{}))}detach(){var i,s,r,n,a,l,d;__classPrivateFieldGet(this,te,"f").info("detach"),null===(i=this.domElement)||void 0===i||i.removeEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),null===(s=this.domElement)||void 0===s||s.removeEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),null===(r=this.domElement)||void 0===r||r.removeEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),null===(n=this.domElement)||void 0===n||n.removeEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),null===(a=this.domElement)||void 0===a||a.removeEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),null===(l=this.domElement)||void 0===l||l.removeEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),null===(d=this.domElement)||void 0===d||d.removeEventListener("touchmove",this.prevent),document.documentElement.removeEventListener("pointerdown",(()=>{}))}}te=new WeakMap,function(i){i.JIIX="application/vnd.myscript.jiix",i.TEXT="text/plain",i.LATEX="application/x-latex",i.MATHML="application/mathml+xml",i.SVG="image/svg+xml",i.OFFICE_DOCUMENT="application/vnd.openxmlformats-officedocument.presentationml.presentation"}(ie||(ie={})),function(i){i.Text="Text",i.Node="Node",i.Edge="Edge",i.RawContent="Raw Content"}(se||(se={})),function(i){i.Circle="circle",i.Ellipse="ellipse",i.Rectangle="rectangle",i.Triangle="triangle",i.Parallelogram="parallelogram",i.Polygon="polygon",i.Rhombus="rhombus"}(re||(re={})),function(i){i.Line="line",i.PolyEdge="polyedge",i.Arc="arc"}(ne||(ne={}));class Box{constructor(i){if(i.width<0)throw new Error("width must be positive");if(i.height<0)throw new Error("height must be positive");this.height=i.height,this.width=i.width,this.x=i.x,this.y=i.y}static createFromBoxes(i){if(!(null==i?void 0:i.length))return new Box({height:0,width:0,x:0,y:0});const s=Math.min(...i.map((i=>i.x))),r=Math.max(...i.map((i=>i.x+i.width)))-s,n=Math.min(...i.map((i=>i.y))),a=Math.max(...i.map((i=>i.y+i.height)))-n;return new Box({x:s,y:n,width:r,height:a})}static createFromPoints(i){if(!(null==i?void 0:i.length))return new Box({height:0,width:0,x:0,y:0});const s=Math.min(...i.map((i=>i.x))),r=Math.max(...i.map((i=>i.x)))-s,n=Math.min(...i.map((i=>i.y))),a=Math.max(...i.map((i=>i.y)))-n;return new Box({x:s,y:n,width:r,height:a})}static getCorners(i){return[{x:i.x,y:i.y},{x:i.x+i.width,y:i.y},{x:i.x+i.width,y:i.y+i.height},{x:i.x,y:i.y+i.height}]}static getCenter(i){return{x:i.x+i.width/2,y:i.y+i.height/2}}static getSides(i){const s=Box.getCorners(i);return s.map(((i,r)=>3===r?{p1:s[0],p2:i}:{p1:i,p2:s[r+1]}))}static isContained(i,s){return isBetween(i.x,s.x,s.x+s.width)&&isBetween(i.x+i.width,s.x,s.x+s.width)&&isBetween(i.y,s.y,s.y+s.height)&&isBetween(i.y+i.height,s.y,s.y+s.height)}static containsPoint(i,s){return isBetween(s.x,i.x,i.x+i.width)&&isBetween(s.y,i.y,i.y+i.height)}static contains(i,s){return isBetween(s.x,i.x,i.x+i.width)&&isBetween(s.x+s.width,i.x,i.x+i.width)&&isBetween(s.y,i.y,i.y+i.height)&&isBetween(s.y+s.height,i.y,i.y+i.height)}static overlaps(i,s){return!(i.x>s.x+s.width)&&(!(i.x+i.width<s.x)&&(!(i.y>s.y+s.height)&&!(i.y+i.height<s.y)))}get xMin(){return this.x}get xMid(){return this.x+this.width/2}get xMax(){return this.x+this.width}get yMin(){return this.y}get yMid(){return this.y+this.height/2}get yMax(){return this.y+this.height}get corners(){return Box.getCorners(this)}get center(){return Box.getCenter(this)}get snapPoints(){return[...this.corners,this.center]}isContained(i){return Box.isContained(this,i)}contains(i){return Box.contains(this,i)}containsPoint(i){return Box.containsPoint(this,i)}overlaps(i){return Box.overlaps(this,i)}}!function(i){i.Highlight="highlight",i.Surround="surround",i.Underline="underline",i.Strikethrough="strikethrough"}(oe||(oe={}));class OIDecorator{constructor(i,s){this.id=`${i}-${createUUID()}`,this.style=structuredClone(s),this.kind=i}clone(){const i=new OIDecorator(this.kind,structuredClone(this.style));return i.id=this.id,i}}const ae={width:2,color:"#000000",opacity:1,fill:"transparent"},le={},de={ink:{color:"#000000",width:1,"-myscript-pen-width":1,"-myscript-pen-fill-style":"none","-myscript-pen-fill-color":"#FFFFFF00"},".math":{"font-family":"STIXGeneral"},".math-solved":{"font-family":"STIXGeneral",color:"#A8A8A8FF"},".text":{"font-family":"MyScriptInter","font-size":10}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var he=function createCommonjsModule(i,s){return i(s={exports:{}},s.exports),s.exports}((function(i,s){i.exports=function(i){function e(r){if(s[r])return s[r].exports;var n=s[r]={i:r,l:!1,exports:{}};return i[r].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var s={};return e.m=i,e.c=s,e.i=function(i){return i},e.d=function(i,s,r){e.o(i,s)||Object.defineProperty(i,s,{configurable:!1,enumerable:!0,get:r})},e.n=function(i){var s=i&&i.__esModule?function(){return i.default}:function(){return i};return e.d(s,"a",s),s},e.o=function(i,s){return Object.prototype.hasOwnProperty.call(i,s)},e.p="",e(e.s=1)}([function(i,s,r){function o(i,s){if(!(i instanceof s))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(s,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(i){return typeof i}:function(i){return i&&"function"==typeof Symbol&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i},a=function t(i){var s=this;o(this,t),this.toJSON=function(i){if("string"!=typeof i)return console.error("Need a CSS string but given ",void 0===i?"undefined":n(i),i),"Not a valid CSS..!";var r={},a=void 0,l=void 0,d=void 0;try{i.split("{").forEach((function(i){if(l=i.trim())if(-1===l.indexOf("}"))r[l]={},a=l;else{l.substring(0,l.indexOf("}")).split(";").forEach((function(i){(d=i.split(":"))&&2===d.length&&(r[a][d[0].trim().replace(/^\"|\"$/g,"")]=s._trimSemiColon(d[1].trim().replace(/^\"|\"$/g,"")))}));try{(a=l.split("}")[1].trim())&&(r[a]={})}catch(i){}}}))}catch(i){return"Not a valid CSS..!"}return r},this.toCSS=function(i){if("object"!==(void 0===i?"undefined":n(i)))return console.error("Need a JSON object but given ",void 0===i?"undefined":n(i),i),"Not a valid JSON..!";var s="";try{for(var r in i)if(i.hasOwnProperty(r)){for(var a in s+=r+" {\n",i[r])i[r].hasOwnProperty(a)&&(s+=a+": "+i[r][a]+";\n");s+="}\n"}}catch(i){return"Not a valid JSON..!"}return s},this._trimSemiColon=function(i){return";"===i.slice(-1)?i.slice(0,s.length-1):i}};s.default=a},function(i,s,r){i.exports=r(0).default}])})),ce=function unwrapExports(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}(he);he.JsonCSS;const ue=new ce,pe={themeToCSS:i=>ue.toCSS(i),themeToJSON(i){const s=ue.toJSON(i);return s[".text"]["font-size"]=Number(s[".text"]["font-size"]),s.ink["-myscript-pen-width"]=Number(s.ink["-myscript-pen-width"]),s.ink.width=Number(s.ink.width),s},penStyleToCSS(i){let s=ue.toCSS({css:i});return s=s.substring(6,s.length-3),s},penStyleToJSON(i){const s=ue.toJSON(`css {${i}}`).css;return s.width?s.width=Number(s.width):delete s.width,s["-myscript-pen-width"]?s["-myscript-pen-width"]=Number(s["-myscript-pen-width"]):delete s["-myscript-pen-width"],s},stringToJSON:i=>ue.toJSON(`css {${i}}`).css,JSONToString:i=>Object.entries(i).map((([i,s])=>`${i}:${s}`)).join(";")};var me,ve,ge,ye,fe,be,xe,we,Se;class StyleManager{constructor(i,s){me.set(this,void 0),ve.set(this,void 0),ge.set(this,void 0),ye.set(this,void 0),fe.set(this,LoggerManager.getLogger(d.STYLE)),__classPrivateFieldGet(this,fe,"f").info("constructor",{penStyle:i,theme:s}),this.setTheme(s),this.setPenStyleClasses(),this.setPenStyle(i)}get currentPenStyle(){return __classPrivateFieldGet(this,ye,"f")||__classPrivateFieldGet(this,me,"f")}get penStyle(){return __classPrivateFieldGet(this,me,"f")}setPenStyle(i){__classPrivateFieldGet(this,fe,"f").info("setPenStyle",{style:i}),__classPrivateFieldSet(this,me,mergeDeep(structuredClone(le),i||{}),"f"),__classPrivateFieldSet(this,ye,i||this.theme[`.${__classPrivateFieldGet(this,ge,"f")}`],"f"),__classPrivateFieldGet(this,fe,"f").debug("setPenStyle",__classPrivateFieldGet(this,ye,"f"))}get theme(){return __classPrivateFieldGet(this,ve,"f")}setTheme(i){__classPrivateFieldGet(this,fe,"f").info("setTheme",{theme:i}),__classPrivateFieldSet(this,ve,mergeDeep(structuredClone(de),i||{}),"f"),__classPrivateFieldGet(this,fe,"f").debug("setTheme",__classPrivateFieldGet(this,ve,"f"))}get penStyleClasses(){return __classPrivateFieldGet(this,ge,"f")}setPenStyleClasses(i=""){__classPrivateFieldGet(this,fe,"f").info("setPenStyleClasses",{penStyleClass:i}),__classPrivateFieldSet(this,ge,i,"f"),__classPrivateFieldSet(this,ye,this.theme[`.${__classPrivateFieldGet(this,ge,"f")}`],"f"),__classPrivateFieldGet(this,fe,"f").debug("setPenStyleClasses",__classPrivateFieldGet(this,ye,"f"))}}me=new WeakMap,ve=new WeakMap,ge=new WeakMap,ye=new WeakMap,fe=new WeakMap;class MatrixTransform{constructor(i,s,r,n,a,l){this.xx=i,this.yx=s,this.xy=r,this.yy=n,this.tx=a,this.ty=l}static identity(){return new MatrixTransform(1,0,0,1,0,0)}static applyToPoint(i,s){return{x:i.xx*s.x+i.xy*s.y+i.tx,y:i.yx*s.x+i.yy*s.y+i.ty}}static rotation(i){let s;if(0!==i.xx||0!==i.xy){const r=Math.hypot(i.xx,i.xy);s=Math.acos(i.xx/r)*(i.xy>0?-1:1)}else if(0!==i.yx||0!==i.yy){const r=Math.hypot(i.yx,i.yy);s=Math.PI/2+Math.acos(i.yx/r)*(i.yy>0?-1:1)}else s=0;return s}static toCssString(i){return`matrix(${i.xx}, ${i.yx}, ${i.xy}, ${i.yy}, ${i.tx}, ${i.ty})`}invert(){const{xx:i,yx:s,xy:r,yy:n,tx:a,ty:l}=this,d=i*n-s*r;return this.xx=n/d,this.yx=s/-d,this.xy=r/-d,this.yy=i/d,this.tx=(n*a-r*l)/-d,this.ty=(s*a-i*l)/d,this}multiply(i){const{xx:s,yx:r,xy:n,yy:a,tx:l,ty:d}=this;return this.xx=s*i.xx+n*i.yx,this.yx=r*i.xx+a*i.yx,this.xy=s*i.xy+n*i.yy,this.yy=r*i.xy+a*i.yy,this.tx=s*i.tx+n*i.ty+l,this.ty=r*i.tx+a*i.ty+d,this}translate(i,s){return this.multiply({xx:1,yx:0,xy:0,yy:1,tx:i,ty:s})}rotate(i,s){s&&this.translate(s.x,s.y);const r=Math.round(1e3*Math.cos(i))/1e3,n=Math.round(1e3*Math.sin(i))/1e3;return this.multiply({xx:r,yx:n,xy:-n,yy:r,tx:0,ty:0}),s&&this.translate(-s.x,-s.y),this}scale(i,s,r){return r&&this.translate(r.x,r.y),this.multiply({xx:i,yx:0,xy:0,yy:s,tx:0,ty:0}),r&&this.translate(-r.x,-r.y),this}applyToPoint(i){return MatrixTransform.applyToPoint(this,i)}clone(){return new MatrixTransform(this.xx,this.yx,this.xy,this.yy,this.tx,this.ty)}toCssString(){return MatrixTransform.toCssString(this)}}class OISymbolBase{constructor(i,s){this.type=i,this.id=`${this.type}-${createUUID()}`,this.creationTime=Date.now(),this.modificationDate=this.creationTime,this.selected=!1,this.deleting=!1,this.transform=MatrixTransform.identity(),this.style=Object.assign({},ae,s),this.style.opacity=+this.style.opacity,this.style.width=+this.style.width}get edges(){return this.isClosed?this.vertices.map(((i,s)=>s===this.vertices.length-1?{p1:i,p2:this.vertices[0]}:{p1:i,p2:this.vertices[s+1]})):this.vertices.slice(0,-1).map(((i,s)=>({p1:i,p2:this.vertices[s+1]})))}isIntersected(i){return this.edges.some((s=>findIntersectionBetween2Segment(s,i)))}}!function(i){i.Stroke="stroke",i.Group="group",i.Shape="shape",i.Edge="edge",i.Text="text",i.Eraser="eraser"}(be||(be={})),function(i){i.Line="line",i.PolyEdge="polyedge",i.Arc="arc"}(xe||(xe={})),function(i){i.Arrow="arrow-head"}(we||(we={}));class OIEdgeBase extends OISymbolBase{constructor(i,s,r,n){super(be.Edge,n),this.isClosed=!1,this.kind=i,this.startDecoration=s,this.endDecoration=r}get bounds(){const i=Box.createFromPoints(this.vertices);return i.x-=5,i.y-=5,i.height+=a,i.width+=a,(this.startDecoration||this.endDecoration)&&(i.x-=2.5*(this.style.width||1),i.y-=2.5*(this.style.width||1),i.height+=5*(this.style.width||1),i.width+=5*(this.style.width||1)),i}get snapPoints(){return this.vertices}overlaps(i){return this.bounds.isContained(i)||this.edges.some((s=>Box.getSides(i).some((i=>!!findIntersectionBetween2Segment(s,i)))))}}function isValidPoint(i){return!!i&&(!!isValidNumber(i.x)&&!!isValidNumber(i.y))}class OIEdgeArc extends OIEdgeBase{constructor(i,s,r,n,a,l,d,h,c){super(xe.Arc,d,h,c),this.center=i,this.startAngle=s,this.sweepAngle=r,this.radiusX=n,this.radiusY=a,this.phi=l,this._vertices=new Map,this._vertices.set(this.verticesId,this.computedVertices())}get verticesId(){return`${this.center.x}-${this.center.y}-${this.startAngle}-${this.sweepAngle}-${this.radiusX}-${this.radiusY}-${this.phi}`}computedVertices(){const i=Math.abs(this.sweepAngle)*Math.sqrt((Math.pow(this.radiusX,2)+Math.pow(this.radiusY,2))/2),s=Math.max(8,Math.round(i/a)),r=this.sweepAngle/s,n=[],l=this.startAngle+this.sweepAngle;if(this.sweepAngle>0)for(let i=this.startAngle;i<l;i+=r)n.push(computePointOnEllipse(this.center,this.radiusX,this.radiusY,this.phi,i));else for(let i=this.startAngle;i>l;i+=r)n.push(computePointOnEllipse(this.center,this.radiusX,this.radiusY,this.phi,i));return n.push(computePointOnEllipse(this.center,this.radiusX,this.radiusY,this.phi,l)),n}get vertices(){return this._vertices.has(this.verticesId)||this._vertices.set(this.verticesId,this.computedVertices()),this._vertices.get(this.verticesId)}get snapPoints(){return[this.vertices[0],this.vertices.at(-1)]}clone(){const i=new OIEdgeArc(structuredClone(this.center),this.startAngle,this.sweepAngle,this.radiusX,this.radiusY,this.phi,this.startDecoration,this.endDecoration,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,center:this.center,startAngle:this.startAngle,sweepAngle:this.sweepAngle,radiusX:this.radiusX,radiusY:this.radiusY,phi:this.phi,startDecoration:this.startDecoration,style:this.style,endDecoration:this.endDecoration}}static create(i){if(!isValidPoint(null==i?void 0:i.center))throw new Error("Unable to create a arc, center point is invalid");if(!isValidNumber(null==i?void 0:i.startAngle))throw new Error("Unable to create a arc, startAngle is invalid");if(!isValidNumber(null==i?void 0:i.sweepAngle))throw new Error("Unable to create a arc, sweepAngle is invalid");if(!isValidNumber(null==i?void 0:i.radiusX))throw new Error("Unable to create a arc, radiusX is invalid");if(!isValidNumber(null==i?void 0:i.radiusY))throw new Error("Unable to create a arc, radiusY is invalid");const s=new OIEdgeArc(null==i?void 0:i.center,i.startAngle,i.sweepAngle,i.radiusX,i.radiusY,i.phi||0,i.startDecoration,i.endDecoration,i.style);return i.id&&(s.id=i.id),s}}class OIEdgeLine extends OIEdgeBase{constructor(i,s,r,n,a){super(xe.Line,r,n,a),this.start=i,this.end=s}get vertices(){return[this.start,this.end]}clone(){const i=new OIEdgeLine(structuredClone(this.start),structuredClone(this.end),this.startDecoration,this.endDecoration,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,start:this.start,end:this.end,style:this.style,startDecoration:this.startDecoration,endDecoration:this.endDecoration}}static create(i){if(!isValidPoint(null==i?void 0:i.start))throw new Error("Unable to create a arc, start point is invalid");if(!isValidPoint(null==i?void 0:i.end))throw new Error("Unable to create a arc, end point is invalid");const s=new OIEdgeLine(null==i?void 0:i.start,null==i?void 0:i.end,i.startDecoration,i.endDecoration,i.style);return i.id&&(s.id=i.id),s}}class OIEdgePolyLine extends OIEdgeBase{constructor(i,s,r,n){super(xe.PolyEdge,s,r,n),this.points=i}get vertices(){return this.points}clone(){const i=new OIEdgePolyLine(structuredClone(this.points),this.startDecoration,this.endDecoration,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,points:this.points,style:this.style,startDecoration:this.startDecoration,endDecoration:this.endDecoration}}static create(i){var s;if(!(null===(s=null==i?void 0:i.points)||void 0===s?void 0:s.map((i=>isValidPoint(i)))))throw new Error("Unable to create a PolyLine, points are invalid");const r=new OIEdgePolyLine(null==i?void 0:i.points,i.startDecoration,i.endDecoration,i.style);return i.id&&(r.id=i.id),r}}!function(i){i.Circle="circle",i.Ellipse="ellipse",i.Polygon="polygon",i.Table="table"}(Se||(Se={}));class OIShapeBase extends OISymbolBase{constructor(i,s){super(be.Shape,s),this.isClosed=!0,this.kind=i}get bounds(){return Box.createFromPoints(this.vertices)}get snapPoints(){return this.bounds.snapPoints}overlaps(i){return this.bounds.isContained(i)||this.edges.some((s=>Box.getSides(i).some((i=>!!findIntersectionBetween2Segment(s,i)))))}}class OIShapeEllipse extends OIShapeBase{constructor(i,s,r,n,a){super(Se.Ellipse,a),this.center=i,this.radiusX=s,this.radiusY=r,this.orientation=n,this._vertices=new Map}get verticesId(){return`${this.center.x}-${this.center.y}-${this.radiusX}-${this.radiusY}-${this.orientation}`}computedVertices(){const i=[],s=2*Math.PI*Math.sqrt((Math.pow(this.radiusX,2)+Math.pow(this.radiusY,2))/2),r=Math.max(8,Math.round(s/a));for(let s=0;s<r;s++){const n=2*Math.PI*(s/r);i.push(computePointOnEllipse(this.center,this.radiusX,this.radiusY,this.orientation,n))}return i}get vertices(){return this._vertices.has(this.verticesId)||this._vertices.set(this.verticesId,this.computedVertices()),this._vertices.get(this.verticesId)}overlaps(i){return this.bounds.isContained(i)||this.edges.some((s=>Box.getSides(i).some((i=>!!findIntersectionBetween2Segment(s,i)))))}clone(){const i=new OIShapeEllipse(structuredClone(this.center),this.radiusX,this.radiusY,this.orientation,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,center:this.center,orientation:this.orientation,radiusX:this.radiusX,radiusY:this.radiusY,style:this.style}}static createBetweenPoints(i,s,r){const n={x:(i.x+s.x)/2,y:(i.y+s.y)/2},a=Math.abs(i.x-s.x)/2,l=Math.abs(i.y-s.y)/2;return new OIShapeEllipse(n,a,l,0,r)}static updateBetweenPoints(i,s,r){return i.center={x:(s.x+r.x)/2,y:(s.y+r.y)/2},i.radiusX=Math.abs(s.x-r.x)/2,i.radiusY=Math.abs(s.y-r.y)/2,i}static create(i){if(!isValidPoint(i.center))throw new Error("Unable to create ellipse, center is undefined");if(!isValidNumber(i.radiusX))throw new Error("Unable to create ellipse, radiusX is undefined");if(!isValidNumber(i.radiusY))throw new Error("Unable to create ellipse, radiusY is undefined");const s=new OIShapeEllipse(i.center,i.radiusX,i.radiusY,i.orientation||0,i.style);return i.id&&(s.id=i.id),s}}class OIShapeCircle extends OIShapeBase{constructor(i,s,r){super(Se.Circle,r),this.center=i,this.radius=s,this._vertices=new Map,this._vertices.set(this.verticesId,this.computedVertices()),this._bounds=new Map,this._bounds.set(this.verticesId,this.computedBondingBox())}get verticesId(){return`${this.center.x}-${this.center.y}-${this.radius}`}computedVertices(){const i={x:this.center.x,y:this.radius+this.center.y},s=2*Math.PI*this.radius,r=Math.max(8,Math.round(s/a)),n=[];for(let s=0;s<r;s++){const a=2*Math.PI*(s/r);n.push(computeRotatedPoint(i,this.center,a))}return n}computedBondingBox(){const i={x:this.center.x-this.radius,y:this.center.y-this.radius,height:2*this.radius,width:2*this.radius};return this._bounds,new Box(i)}get bounds(){return this._bounds.has(this.verticesId)||this._bounds.set(this.verticesId,this.computedBondingBox()),this._bounds.get(this.verticesId)}get vertices(){return this._vertices.has(this.verticesId)||this._vertices.set(this.verticesId,this.computedVertices()),this._vertices.get(this.verticesId)}overlaps(i){return this.bounds.isContained(i)||Box.getSides(i).some((i=>findIntersectBetweenSegmentAndCircle(i,this.center,this.radius).length))}clone(){const i=new OIShapeCircle(structuredClone(this.center),this.radius,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,center:this.center,radius:this.radius,style:this.style}}static createBetweenPoints(i,s,r){const n={x:(i.x+s.x)/2,y:(i.y+s.y)/2},a=Math.abs(i.x-s.x),l=Math.abs(i.y-s.y),d=Math.min(a,l)/2;return new OIShapeCircle(n,d,r)}static updateBetweenPoints(i,s,r){i.center={x:(s.x+r.x)/2,y:(s.y+r.y)/2};const n=Math.abs(s.x-r.x),a=Math.abs(s.y-r.y);return i.radius=Math.min(n,a)/2,i}static create(i){if(!isValidPoint(i.center))throw new Error("Unable to create circle, center is invalid");if(!isValidNumber(i.radius))throw new Error("Unable to create circle, radius is undefined");const s=new OIShapeCircle(i.center,i.radius,i.style);return i.id&&(s.id=i.id),s}}class OIShapePolygon extends OIShapeBase{constructor(i,s){super(Se.Polygon,s),this.points=i}get vertices(){return this.points}get bounds(){return Box.createFromPoints(this.vertices)}clone(){const i=new OIShapePolygon(structuredClone(this.points),structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,points:this.points,style:this.style}}static create(i){var s,r;if(!(null==i?void 0:i.points)||(null===(s=null==i?void 0:i.points)||void 0===s?void 0:s.length)<3)throw new Error("Unable to create polygon at least 3 points required");if(null===(r=null==i?void 0:i.points)||void 0===r?void 0:r.some((i=>!isValidPoint(i))))throw new Error("Unable to create a polygon, one or more points are invalid");const n=new OIShapePolygon(i.points,i.style);return i.id&&(n.id=i.id),n}static createTriangleBetweenPoints(i,s,r){const n=[{x:i.x,y:i.y},{x:s.x,y:i.y},{x:(i.x+s.x)/2,y:s.y}];return new OIShapePolygon(n,r)}static updateTriangleBetweenPoints(i,s,r){return i.points=[{x:s.x,y:s.y},{x:r.x,y:s.y},{x:(s.x+r.x)/2,y:r.y}],i.modificationDate=Date.now(),i}static createParallelogramBetweenPoints(i,s,r){const n=[{x:i.x,y:i.y},{x:i.x+.75*(s.x-i.x),y:i.y},{x:s.x,y:s.y},{x:i.x+.25*(s.x-i.x),y:s.y}];return new OIShapePolygon(n,r)}static updateParallelogramBetweenPoints(i,s,r){const n=[{x:s.x,y:s.y},{x:s.x+.75*(r.x-s.x),y:s.y},{x:r.x,y:r.y},{x:s.x+.25*(r.x-s.x),y:r.y}];return i.points=n,i.modificationDate=Date.now(),i}static createRectangleBetweenPoints(i,s,r){const n=Box.createFromPoints([i,s]),a=[{x:n.xMin,y:n.yMin},{x:n.xMax,y:n.yMin},{x:n.xMax,y:n.yMax},{x:n.xMin,y:n.yMax}];return new OIShapePolygon(a,r)}static updateRectangleBetweenPoints(i,s,r){const n=Box.createFromPoints([s,r]),a=[{x:n.xMin,y:n.yMin},{x:n.xMax,y:n.yMin},{x:n.xMax,y:n.yMax},{x:n.xMin,y:n.yMax}];return i.points=a,i.modificationDate=Date.now(),i}static createRhombusBetweenPoints(i,s,r){const n=Box.createFromPoints([i,s]),a=[{x:n.xMid,y:n.yMin},{x:n.xMax,y:n.yMid},{x:n.xMid,y:n.yMax},{x:n.xMin,y:n.yMid}];return new OIShapePolygon(a,r)}static updateRhombusBetweenPoints(i,s,r){const n=Box.createFromPoints([s,r]),a=[{x:n.xMid,y:n.yMin},{x:n.xMax,y:n.yMid},{x:n.xMid,y:n.yMax},{x:n.xMin,y:n.yMid}];return i.points=a,i.modificationDate=Date.now(),i}}class OIStroke extends OISymbolBase{constructor(i,s="pen"){super(be.Stroke,i),this.isClosed=!1,this.pointerType=s,this.pointers=[],this.decorators=[],this.length=0}get bounds(){return Box.createFromPoints(this.vertices)}static split(i,s){const r=new OIStroke(i.style,i.pointerType);r.pointers=i.pointers.slice(0,s);const n=new OIStroke(i.style,i.pointerType);return n.pointers=i.pointers.slice(s),{before:r,after:n}}static substract(i,s){var r,n;if(!s.length)return{before:i};const a={},l={x:s.pointers[0].x,y:s.pointers[0].y},d=getClosestPoint(i.pointers,l);if(d.index>-1){const s=OIStroke.split(i,d.index);a.before=s.before,a.after=s.after}const h=a.after||i,c={x:s.pointers.at(-1).x,y:s.pointers.at(-1).y},u=getClosestPoint(h.pointers,c);if(u.index>-1){const i=OIStroke.split(h,u.index);a.after=i.after}return(null===(r=a.before)||void 0===r?void 0:r.pointers.length)||(a.before=void 0),(null===(n=a.after)||void 0===n?void 0:n.pointers.length)||(a.after=void 0),a}get snapPoints(){return this.bounds.snapPoints}get vertices(){return this.pointers}computePressure(i){let s=1;i===this.length?s=1:i<10?s=.2+Math.pow(.1*i,.4):i>this.length-10&&(s=.2+Math.pow(.1*(this.length-i),.4));const r=s*Math.max(.1,1-.1*Math.sqrt(i));return isNaN(r)?.5:Math.round(100*r)/100}filterPointByAcquisitionDelta(i){const s=this.pointers.at(-1),r=2+(this.style.width||1)/4;return!s||Math.abs(s.x-i.x)>=r||Math.abs(s.y-i.y)>=r}addPointer(i){if(this.filterPointByAcquisitionDelta(i)){const s=this.pointers.at(-1),r=s?computeDistance(i,s):0;this.length+=r,i.p=this.computePressure(r),this.pointers.push(i),this.modificationDate=Date.now()}}overlaps(i){return this.pointers.some((s=>s.x>=i.x&&s.x<=i.x+i.width&&s.y>=i.y&&s.y<=i.y+i.height))}clone(){const i=new OIStroke(this.style,this.pointerType);return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.pointers=structuredClone(this.pointers),i.decorators=this.decorators.map((i=>i.clone())),i.length=this.length,i}formatToSend(){const i={id:this.id,pointerType:this.pointerType,p:[],t:[],x:[],y:[]};return this.pointers.forEach((s=>{i.p.push(s.p),i.t.push(s.t),i.x.push(s.x),i.y.push(s.y)})),i}toJSON(){return{id:this.id,type:this.type,pointers:this.pointers,style:this.style,decorators:this.decorators.length?this.decorators:void 0}}static create(i){var s,r,n;if(!(null===(s=i.pointers)||void 0===s?void 0:s.length))throw new Error("not pointers");const a=new OIStroke(i.style,i.pointerType);i.id&&(a.id=i.id);const l=[];let d=!0;if(null===(r=i.pointers)||void 0===r||r.forEach(((i,s)=>{if(!i)return l.push(`no pointer at ${s}`),void(d=!1);const r={p:i.p||1,t:i.t||s,x:0,y:0};return null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(l.push(`no x at pointer at ${s}`),void(d=!1)):(r.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(l.push(`no y at pointer at ${s}`),void(d=!1)):(r.y=i.y,void(d&&a.addPointer(r))))})),l.length)throw new Error(l.join(" and "));return(null===(n=i.decorators)||void 0===n?void 0:n.length)&&i.decorators.forEach((i=>{(null==i?void 0:i.kind)&&a.decorators.push(new OIDecorator(i.kind,Object.assign({},a.style,i.style)))})),a}}function convertPartialStrokesToOIStrokes(i){const s=[],r=[];if(i.forEach(((i,n)=>{try{r.push(OIStroke.create(i))}catch(i){s.push(`stroke ${n+1} has ${i.message}`)}})),s.length)throw new Error(s.join("\n"));return r}class OISymbolGroup extends OISymbolBase{constructor(i,s){super(be.Group,s),this.isClosed=!1,this.children=i,this.decorators=[]}get snapPoints(){return this.bounds.snapPoints}get vertices(){return this.children.flatMap((i=>i.vertices))}get bounds(){return Box.createFromBoxes(this.children.map((i=>i.bounds)))}updateChildrenStyle(){this.children.forEach((i=>{i.style=Object.assign({},i.style,this.style),i.type===be.Text?i.chars.forEach((s=>{i.style.color&&(s.color=i.style.color)})):i.type===be.Group&&i.updateChildrenStyle()}))}overlaps(i){return this.children.some((s=>s.overlaps(i)))}containsSymbol(i){return OISymbolGroup.containsSymbol(this,i)}containsOnlyStroke(){return OISymbolGroup.containsOnlyStroke(this)}extractSymbols(){return OISymbolGroup.extractSymbols(this)}extractStrokes(){return OISymbolGroup.extractStrokes(this)}removeChilds(i){return OISymbolGroup.removeChilds(this,i)}static containsOnlyStroke(i){return i.children.every((i=>i.type===be.Group?OISymbolGroup.containsOnlyStroke(i):i.type===be.Stroke))}static extractSymbols(i){return i.children.flatMap((i=>i.type===be.Group?OISymbolGroup.extractSymbols(i).concat(i):i))}static extractStrokes(i){return i.children.flatMap((i=>i.type===be.Stroke?i:i.type===be.Group?OISymbolGroup.extractStrokes(i):void 0)).filter((i=>!!i))}static containsSymbol(i,s){return i.children.some((i=>i.type===be.Group?OISymbolGroup.containsSymbol(i,s):i.id===s))}static removeChilds(i,s){i.children=i.children.filter((i=>!s.includes(i.id)));return i.children.slice().forEach((r=>{r.type===be.Group&&(r.removeChilds(s).children.length||(i.children=i.children.filter((i=>i.id!==r.id))))})),i}clone(){const i=new OISymbolGroup(this.children.map((i=>i.clone())),structuredClone(Object.assign({},this.style)));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.decorators=this.decorators.map((i=>i.clone())),i}toJSON(){return{id:this.id,type:this.type,children:JSON.parse(JSON.stringify(this.children)),decorators:this.decorators.length?JSON.parse(JSON.stringify(this.decorators)):void 0}}}class OIText extends OISymbolBase{constructor(i,s,r,n){super(be.Text,n),this.isClosed=!0,this.point=s,this.bounds=new Box(r),this.chars=i,this.decorators=[]}get label(){return this.chars.map((i=>i.label)).join("")}get vertices(){if(this.rotation){const i=this.rotation.center,s=convertDegreeToRadian(-this.rotation.degree);return this.bounds.corners.map((r=>computeRotatedPoint(r,i,s)))}return this.bounds.corners}get snapPoints(){const i=this.bounds.yMax-this.point.y,s=[{x:this.bounds.x,y:this.bounds.yMin+i},{x:this.bounds.xMax,y:this.bounds.yMin+i},{x:this.bounds.xMax,y:this.bounds.yMax-i},{x:this.bounds.x,y:this.bounds.yMax-i},this.bounds.center];if(this.rotation){const i=this.rotation.center,r=convertDegreeToRadian(-this.rotation.degree);return s.map((s=>computeRotatedPoint(s,i,r)))}return s}getCharCorners(i){const s=new Box(i.bounds);if(this.rotation){const i=this.rotation.center,r=convertDegreeToRadian(-this.rotation.degree);return s.corners.map((s=>computeRotatedPoint(s,i,r)))}return s.corners}getCharsOverlaps(i){return this.chars.filter((s=>{const r=this.getCharCorners(s);return i.some((i=>isPointInsidePolygon(i,r)))}))}overlaps(i){return this.vertices.some((s=>Box.containsPoint(i,s)))||this.edges.some((s=>Box.getSides(i).some((i=>!!findIntersectionBetween2Segment(s,i)))))}clone(){const i=new OIText(structuredClone(this.chars),structuredClone(this.point),this.bounds,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.decorators=this.decorators.map((i=>i.clone())),i.rotation=this.rotation?structuredClone(this.rotation):void 0,i}toJSON(){return{id:this.id,type:this.type,point:this.point,chars:this.chars,style:this.style,rotation:this.rotation,bounds:this.bounds,decorators:this.decorators.length?this.decorators:void 0}}static create(i){var s,r;if(!isValidPoint(null==i?void 0:i.point))throw new Error("Unable to create a OIText, point are invalid");if(!(null===(s=i.chars)||void 0===s?void 0:s.length))throw new Error("Unable to create a OIText, no chars");if(!i.bounds)throw new Error("Unable to create a OIText, no boundingBox");const n=new OIText(i.chars,i.point,i.bounds,i.style);return i.id&&(n.id=i.id),(null===(r=i.decorators)||void 0===r?void 0:r.length)&&i.decorators.forEach((i=>{(null==i?void 0:i.kind)&&n.decorators.push(new OIDecorator(i.kind,Object.assign({},n.style,i.style)))})),n}}const _e={color:"grey",fill:"none",width:12,opacity:.2};class OIEraser extends OISymbolBase{constructor(){super(be.Eraser,_e),this.isClosed=!1,this.id=`${this.type}-${createUUID()}`,this.creationTime=Date.now(),this.modificationDate=this.creationTime,this.pointers=[]}get bounds(){return Box.createFromPoints(this.vertices)}get vertices(){return this.pointers}get snapPoints(){return[]}clone(){const i=new OIEraser;return i.id=this.id,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.pointers=structuredClone(this.pointers),i}overlaps(i){return this.pointers.some((s=>s.x>=i.x&&s.x<=i.x+i.width&&s.y>=i.y&&s.y<=i.y+i.height))}toJSON(){return{id:this.id,pointers:this.pointers,style:this.style}}}class Stroke{constructor(i,s="pen"){this.type=be.Stroke,this.id=`${this.type}-${createUUID()}`,this.creationTime=Date.now(),this.modificationDate=this.creationTime,this.style=i,this.pointerType=s,this.pointers=[],this.length=0}clone(){const i=new Stroke(this.style,this.pointerType);return i.id=this.id,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.pointers=structuredClone(this.pointers),i.length=this.length,i}formatToSend(){const i={id:this.id,pointerType:this.pointerType,p:[],t:[],x:[],y:[]};return this.pointers.forEach((s=>{i.p.push(s.p),i.t.push(s.t),i.x.push(s.x),i.y.push(s.y)})),i}}function convertPartialStrokesToStrokes(i){const s=[],r=[];if(i.forEach(((i,n)=>{var a,l;let d=!0;const h=new Stroke(i.style||le,i.pointerType);if(i.id&&(h.id=i.id),!(null===(a=i.pointers)||void 0===a?void 0:a.length))return s.push(`stroke ${n+1} has not pointers`),void(d=!1);null===(l=i.pointers)||void 0===l||l.forEach(((i,r)=>{if(!i)return s.push(`stroke ${n+1} has no pointer at ${r}`),void(d=!1);const a={p:i.p||1,t:i.t||r,x:0,y:0};return null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(s.push(`stroke ${n+1} has no x at pointer at ${r}`),void(d=!1)):(a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(s.push(`stroke ${n+1} has no y at pointer at ${r}`),void(d=!1)):(a.y=i.y,void(d&&h.pointers.push(a))))})),d&&r.push(h)})),s.length)throw new Error(s.join("\n"));return r}var Pe,ke,Ee,Me;class Model{constructor(i=100,s=100,r=0,n=Date.now()){Pe.set(this,LoggerManager.getLogger(d.MODEL)),__classPrivateFieldGet(this,Pe,"f").info("constructor",{width:i,height:s,creationDate:n}),this.creationTime=n,this.modificationDate=n,this.width=i,this.height=s,this.rowHeight=r,this.symbols=[],this.positions={lastSentPosition:0,lastReceivedPosition:0},this.idle=!0}computePressure(i,s){let r=1;i===s?r=1:i<10?r=.2+Math.pow(.1*i,.4):i>s-10&&(r=.2+Math.pow(.1*(s-i),.4));const n=r*Math.max(.1,1-.1*Math.sqrt(i));return isNaN(n)?.5:Math.round(100*n)/100}filterPointByAcquisitionDelta(i,s,r){const n=2+(i.style["-myscript-pen-width"]||0)/4;return!r||0===i.pointers.length||Math.abs(r.x-s.x)>=n||Math.abs(r.y-s.y)>=n}getStrokeFromPoint(i){__classPrivateFieldGet(this,Pe,"f").info("getStrokeFromPoint",{point:i});const isBetween=(i,s,r)=>i>=s&&i<=r,s=[];return this.symbols.forEach((r=>{for(let n=0;n<r.pointers.length;n++){const a=r.pointers[n];if(isBetween(a.x,i.x-5,i.x+5)&&isBetween(a.y,i.y-5,i.y+5)){s.push(r);break}if(computeDistance(i,a)<10){s.push(r);break}}})),__classPrivateFieldGet(this,Pe,"f").debug("getStrokeFromPoint",{strokes:s}),s}addPoint(i,s){__classPrivateFieldGet(this,Pe,"f").debug("addPoint",{stroke:i,pointer:s});const r=i.pointers.at(-1);if(this.filterPointByAcquisitionDelta(i,s,r)){const n=r?computeDistance(s,r):0;i.length+=n,s.p=this.computePressure(n,i.length),i.pointers.push(s),i.modificationDate=Date.now()}}addStroke(i){__classPrivateFieldGet(this,Pe,"f").info("addStroke",{stroke:i}),this.symbols.push(i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0}updateStroke(i){__classPrivateFieldGet(this,Pe,"f").info("updateStroke",{updatedStroke:i});const s=this.symbols.findIndex((s=>s.id===i.id));-1!==s&&(i.modificationDate=Date.now(),this.symbols.splice(s,1,i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,Pe,"f").debug("updateStroke",this.symbols)}removeStroke(i){__classPrivateFieldGet(this,Pe,"f").info("removeStroke",{id:i});const s=this.symbols.findIndex((s=>s.id===i));-1!==s&&(this.positions.lastSentPosition--,this.positions.lastReceivedPosition--,this.symbols.splice(s,1),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,Pe,"f").debug("removeStroke",this.symbols)}removeStrokesFromPoint(i){__classPrivateFieldGet(this,Pe,"f").info("removeStrokesFromPoint",{point:i});const s=this.getStrokeFromPoint(i);return s.forEach((i=>{this.removeStroke(i.id)})),__classPrivateFieldGet(this,Pe,"f").debug("removeStrokesFromPoint",s.map((i=>i.id))),s.map((i=>i.id))}extractUnsentStrokes(){return this.symbols.slice(this.positions.lastSentPosition)}initCurrentStroke(i,s,r,n=96){if(__classPrivateFieldGet(this,Pe,"f").info("initCurrentStroke",{point:i,pointerType:s,style:r,dpi:n}),r["-myscript-pen-width"]){const i=r["-myscript-pen-width"]*n/25.4;r.width=i/2}this.modificationDate=Date.now(),this.exports=void 0,this.currentSymbol=new Stroke(r,s),__classPrivateFieldGet(this,Pe,"f").debug("initCurrentStroke",this.currentSymbol),this.addPoint(this.currentSymbol,i)}appendToCurrentStroke(i){__classPrivateFieldGet(this,Pe,"f").info("appendToCurrentStroke",{point:i}),this.currentSymbol&&this.addPoint(this.currentSymbol,i),__classPrivateFieldGet(this,Pe,"f").debug("appendToCurrentStroke",this.currentSymbol)}endCurrentStroke(i){__classPrivateFieldGet(this,Pe,"f").info("endCurrentStroke",{point:i}),this.currentSymbol&&(this.addPoint(this.currentSymbol,i),this.addStroke(this.currentSymbol),this.currentSymbol=void 0),__classPrivateFieldGet(this,Pe,"f").debug("endCurrentStroke",this.currentSymbol)}updatePositionSent(i=this.symbols.length){__classPrivateFieldGet(this,Pe,"f").info("updatePositionSent",{position:i}),this.positions.lastSentPosition=i,__classPrivateFieldGet(this,Pe,"f").debug("updatePositionSent",this.positions.lastSentPosition)}updatePositionReceived(){__classPrivateFieldGet(this,Pe,"f").info("updatePositionReceived"),this.positions.lastReceivedPosition=this.positions.lastSentPosition,__classPrivateFieldGet(this,Pe,"f").debug("updatePositionReceived",this.positions.lastReceivedPosition)}mergeExport(i){__classPrivateFieldGet(this,Pe,"f").info("mergeExport",{exports:i}),this.exports?Object.assign(this.exports,i):this.exports=i,__classPrivateFieldGet(this,Pe,"f").debug("mergeExport",this.exports)}mergeConvert(i){__classPrivateFieldGet(this,Pe,"f").info("mergeConvert",{converts:i}),this.converts?Object.assign(this.converts,i):this.converts=i,__classPrivateFieldGet(this,Pe,"f").debug("mergeConvert",this.converts)}clone(){__classPrivateFieldGet(this,Pe,"f").info("clone");const i=new Model(this.width,this.height,this.rowHeight,this.creationTime);return i.modificationDate=JSON.parse(JSON.stringify(this.modificationDate)),i.currentSymbol=this.currentSymbol?this.currentSymbol.clone():void 0,i.symbols=this.symbols.map((i=>i.clone())),i.positions=JSON.parse(JSON.stringify(this.positions)),i.exports=this.exports?JSON.parse(JSON.stringify(this.exports)):void 0,i.converts=this.converts?JSON.parse(JSON.stringify(this.converts)):void 0,i.idle=this.idle,__classPrivateFieldGet(this,Pe,"f").debug("clone",{clonedModel:i}),i}clear(){__classPrivateFieldGet(this,Pe,"f").info("clear"),this.modificationDate=Date.now(),this.currentSymbol=void 0,this.symbols=[],this.positions.lastSentPosition=0,this.positions.lastReceivedPosition=0,this.exports=void 0,this.converts=void 0,this.idle=!0}}Pe=new WeakMap;class OIModel{constructor(i=100,s=100,r=0,n=Date.now()){ke.set(this,LoggerManager.getLogger(d.MODEL)),this.creationTime=n,this.modificationDate=n,this.width=i,this.height=s,this.rowHeight=r,this.symbols=[],this.exports=void 0,this.converts=void 0,this.idle=!0}get symbolsSelected(){return this.symbols.filter((i=>i.selected))}get symbolsToDelete(){return this.symbols.filter((i=>i.deleting))}selectSymbol(i){const s=this.symbols.find((s=>s.id===i||s.type===be.Group&&s.containsSymbol(i)));s&&(s.selected=!0)}unselectSymbol(i){const s=this.symbols.find((s=>s.id===i));s&&(s.selected=!1)}resetSelection(){this.symbols.forEach((i=>i.selected=!1))}getRootSymbol(i){return this.symbols.find((s=>s.id===i||s.type===be.Group&&s.containsSymbol(i)?s:void 0))}getSymbolRowIndex(i){return Math.round(i.bounds.yMid/this.rowHeight)}getSymbolsByRowOrdered(){const i=[];return this.symbols.forEach((s=>{const r=this.getSymbolRowIndex(s),n=i.find((i=>i.rowIndex===r));n?n.symbols.push(s):i.push({rowIndex:r,symbols:[s]})})),i.forEach((i=>{i.symbols.sort(((i,s)=>i.bounds.xMid-s.bounds.xMid))})),i.sort(((i,s)=>i.rowIndex-s.rowIndex))}roundToLineGuide(i){return Math.round(i/this.rowHeight)*this.rowHeight}isSymbolAbove(i,s){return i.bounds.yMid-this.rowHeight/2>s.bounds.yMid}isSymbolInRow(i,s){return Math.abs(i.bounds.yMid-s.bounds.yMid)<=this.rowHeight/2}isSymbolBelow(i,s){return i.bounds.yMid+this.rowHeight/2<s.bounds.yMid}getFirstSymbol(i){if(i.length)return i.reduce(((i,s)=>{if(i){if(Math.round(i.bounds.yMid/this.rowHeight)<Math.round(s.bounds.yMid/this.rowHeight))return i;if(Math.round(i.bounds.yMid/this.rowHeight)==Math.round(s.bounds.yMid/this.rowHeight)&&i.bounds.xMid<s.bounds.xMid)return i}return s}))}getLastSymbol(i){if(i.length)return i.reduce(((i,s)=>{if(i){if(i.bounds.yMid-s.bounds.yMid>this.rowHeight/2)return i;if(i.bounds.yMid-s.bounds.yMid<this.rowHeight/2)return s;if(i.bounds.xMid>s.bounds.xMid)return i}return s}))}addSymbol(i){__classPrivateFieldGet(this,ke,"f").info("addSymbol",{symbol:i});if(this.symbols.findIndex((s=>s.id===i.id))>-1)throw new Error(`Symbol id already exist: ${i.id}`);this.symbols.push(i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0,__classPrivateFieldGet(this,ke,"f").debug("addSymbol",this.symbols)}updateSymbol(i){__classPrivateFieldGet(this,ke,"f").info("updateSymbol",{updatedSymbol:i});const s=this.symbols.findIndex((s=>s.id===i.id));-1!==s&&(i.modificationDate=Date.now(),this.symbols.splice(s,1,i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,ke,"f").debug("updateSymbol",this.symbols)}replaceSymbol(i,s){const r=this.symbols.findIndex((s=>s.id===i));-1!==r&&(this.symbols.splice(r,1,...s),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0)}changeOrderSymbol(i,s){const r=this.symbols.findIndex((s=>s.id===i));if(r>-1){let i=r;switch(s){case"first":i=0;break;case"last":i=this.symbols.length-1;break;case"forward":i=Math.min(i+1,this.symbols.length-1);break;case"backward":i=Math.max(i-1,0)}const n=this.symbols.splice(r,1)[0];this.symbols.splice(i,0,n)}}removeSymbol(i){__classPrivateFieldGet(this,ke,"f").info("removeSymbol",{id:i});const s=this.symbols.findIndex((s=>s.id===i));-1!==s&&(this.symbols.splice(s,1),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,ke,"f").debug("removeSymbol",this.symbols)}extractDifferenceSymbols(i){return{added:this.symbols.filter((s=>-1===i.symbols.findIndex((i=>s.id===i.id&&s.modificationDate===i.modificationDate)))),removed:i.symbols.filter((i=>-1===this.symbols.findIndex((s=>i.id===s.id&&i.modificationDate===s.modificationDate))))}}mergeExport(i){__classPrivateFieldGet(this,ke,"f").info("mergeExport",{exports:i}),this.exports?Object.assign(this.exports,i):this.exports=i,__classPrivateFieldGet(this,ke,"f").debug("mergeExport",this.exports)}clone(){__classPrivateFieldGet(this,ke,"f").info("clone");const i=new OIModel(this.width,this.height,this.rowHeight,this.creationTime);return i.modificationDate=this.modificationDate,i.symbols=this.symbols.map((i=>{const s=i.clone();return s.selected=!1,s})),i.exports=structuredClone(this.exports),i.idle=this.idle,__classPrivateFieldGet(this,ke,"f").debug("clone",{clonedModel:i}),i}clear(){__classPrivateFieldGet(this,ke,"f").info("clear"),this.modificationDate=Date.now(),this.symbols=[],this.currentSymbol=void 0,this.exports=void 0,this.converts=void 0,this.idle=!0}}ke=new WeakMap,function(i){i.NO_ACTIVITY="Session closed due to no activity. Without a connection on your part, it will be permanently lost after an hour.",i.WRONG_CREDENTIALS="Application credentials are invalid. Please check or regenerate your application key and hmackey.",i.TOO_OLD="Session is too old. Max Session Duration Reached.",i.NO_SESSION_FOUND="No sessions found. Without activation for 1 hour, sessions are deleted from the server. To avoid losing your work, use the json export, then import it this will create a new session.",i.UNKNOW="An unknown error has occurred.",i.ABNORMAL_CLOSURE="MyScript recognition server is not reachable.",i.CANT_ESTABLISH="Unable to establish a connection to MyScript recognition server. Check the host and your connectivity.",i.GOING_AWAY="MyScript recognition server is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.",i.PROTOCOL_ERROR="MyScript recognition server terminated the connection due to a protocol error.",i.UNSUPPORTED_DATA="MyScript recognition server terminated the connection because the endpoint received data of a type it cannot accept. (For example, a text-only endpoint received binary data.)",i.INVALID_FRAME_PAYLOAD="MyScript recognition server terminated the connection because a message was received that contained inconsistent data (e.g., non-UTF-8 data within a text message).",i.POLICY_VIOLATION="MyScript recognition server terminated the connection because it received a message that violates its policy.",i.MESSAGE_TOO_BIG="MyScript recognition server terminated the connection because a data frame was received that is too large.",i.INTERNAL_ERROR="MyScript recognition server terminated the connection because it encountered an unexpected condition that prevented it from fulfilling the request.",i.SERVICE_RESTART="MyScript recognition server terminated the connection because it is restarting.",i.TRY_AGAIN="MyScript recognition server terminated the connection due to a temporary condition, e.g. it is overloaded and is casting off some of its clients.",i.BAD_GATEWAY="MyScript recognition server was acting as a gateway or proxy and received an invalid response from the upstream server.",i.TLS_HANDSHAKE="MyScript recognition server connection was closed due to a failure to perform a TLS handshake"}(Ee||(Ee={})),function(i){i.HMAC_Challenge="hmacChallenge",i.Authenticated="authenticated",i.SessionDescription="sessionDescription",i.NewPart="newPart",i.PartChanged="partChanged",i.ContentChanged="contentChanged",i.Idle="idle",i.Pong="pong",i.Exported="exported",i.GestureDetected="gestureDetected",i.ContextlessGesture="contextlessGesture",i.Error="error"}(Me||(Me={}));var Ge=null;try{var Ce="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");Ge=Ce.Worker}catch(i){}function createBase64WorkerFactory$2(i,s,r){var n=void 0===s?null:s,a=function decodeBase64$1(i,s){return Buffer.from(i,"base64").toString(s?"utf16":"utf8")}(i,void 0!==r&&r),l=a.indexOf("\n",10)+1,d=a.substring(l)+(n?"//# sourceMappingURL="+n:"");return function WorkerFactory(i){return new Ge(d,Object.assign({},i,{eval:!0}))}}function createURL(i,s,r){var n=void 0===s?null:s,a=function decodeBase64(i,s){var r=atob(i);if(s){for(var n=new Uint8Array(r.length),a=0,l=r.length;a<l;++a)n[a]=r.charCodeAt(a);return String.fromCharCode.apply(null,new Uint16Array(n.buffer))}return r}(i,void 0!==r&&r),l=a.indexOf("\n",10)+1,d=a.substring(l)+(n?"//# sourceMappingURL="+n:""),h=new Blob([d],{type:"application/javascript"});return URL.createObjectURL(h)}var Fe="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var Le,Ie,Te,Oe,De,Re,Ae,Be,$e,Ne=function createBase64WorkerFactory(i,s,r){return function isNodeJS(){return Fe}()?createBase64WorkerFactory$2(i,s,r):function createBase64WorkerFactory$1(i,s,r){var n;return function WorkerFactory(a){return n=n||createURL(i,s,r),new Worker(n,a)}}(i,s,r)}("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7c2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwoZT0+e3NldEludGVydmFsKCgoKT0+e3Bvc3RNZXNzYWdlKHt0eXBlOiJwaW5nIn0pfSksZS5kYXRhLnBpbmdEZWxheSl9KSl9KCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPXBpbmcud29ya2VyLmpzLm1hcAoK",null,!1);class OIRecognizer{constructor(i,s){Le.add(this),Ie.set(this,LoggerManager.getLogger(d.RECOGNIZER)),this.pingCount=0,this.reconnectionCount=0,__classPrivateFieldGet(this,Ie,"f").info("constructor",{serverConfig:i,recognitionConfig:s}),this.serverConfiguration=i,this.recognitionConfiguration=s;const r="https"===this.serverConfiguration.scheme?"wss":"ws";this.url=`${r}://${this.serverConfiguration.host}/api/v4.0/iink/offscreen?applicationKey=${this.serverConfiguration.applicationKey}`,this.exportDeferredMap=new Map,this.contextlessGestureDeferred=new Map,this.connected=new DeferredPromise,this.initialized=new DeferredPromise}get mimeTypes(){return["application/vnd.myscript.jiix"]}get event(){return InternalEvent.getInstance()}rejectDeferredPending(i){var s,r,n,a,l,d,h,c;this.initialized.reject(i),null===(s=this.addStrokeDeferred)||void 0===s||s.reject(i),null===(r=this.transformStrokeDeferred)||void 0===r||r.reject(i),null===(n=this.eraseStrokeDeferred)||void 0===n||n.reject(i),null===(a=this.replaceStrokeDeferred)||void 0===a||a.reject(i),null===(l=this.undoDeferred)||void 0===l||l.reject(i),null===(d=this.redoDeferred)||void 0===d||d.reject(i),null===(h=this.clearDeferred)||void 0===h||h.reject(i),Array.from(this.contextlessGestureDeferred.values()).forEach((s=>{s.reject(i)})),Array.from(this.exportDeferredMap.values()).forEach((s=>{s.reject(i)})),null===(c=this.waitForIdleDeferred)||void 0===c||c.reject(i)}resetAllDeferred(){this.connected=new DeferredPromise,this.initialized=new DeferredPromise,this.addStrokeDeferred=void 0,this.contextlessGestureDeferred.clear(),this.transformStrokeDeferred=void 0,this.eraseStrokeDeferred=void 0,this.replaceStrokeDeferred=void 0,this.exportDeferredMap.clear(),this.waitForIdleDeferred=void 0,this.closeDeferred=void 0}clearSocketListener(){this.socket.removeEventListener("open",this.openCallback.bind(this)),this.socket.removeEventListener("close",this.closeCallback.bind(this)),this.socket.removeEventListener("message",this.messageCallback.bind(this))}closeCallback(i){var s,r;__classPrivateFieldGet(this,Ie,"f").info("closeCallback",{evt:i});let n=i.reason;if(!this.currentErrorCode)switch(i.code){case 1e3:break;case 1001:n=Ee.GOING_AWAY;break;case 1002:n=Ee.PROTOCOL_ERROR;break;case 1003:n=Ee.UNSUPPORTED_DATA;break;case 1006:n=Ee.ABNORMAL_CLOSURE;break;case 1007:n=Ee.INVALID_FRAME_PAYLOAD;break;case 1008:n=Ee.POLICY_VIOLATION;break;case 1009:n=Ee.MESSAGE_TOO_BIG;break;case 1011:n=Ee.INTERNAL_ERROR;break;case 1012:n=Ee.SERVICE_RESTART;break;case 1013:n=Ee.TRY_AGAIN;break;case 1014:n=Ee.BAD_GATEWAY;break;case 1015:n=Ee.TLS_HANDSHAKE;break;default:n=Ee.CANT_ESTABLISH}if(this.clearSocketListener(),null===(s=this.closeDeferred)||void 0===s||s.resolve(),!this.currentErrorCode&&1e3!==i.code){const i=new Error(n);this.event.emitError(i),this.rejectDeferredPending(n)}null===(r=this.pingWorker)||void 0===r||r.terminate(),this.resetAllDeferred()}openCallback(){this.connected.resolve(),this.reconnectionCount=0,__classPrivateFieldGet(this,Le,"m",Te).call(this,{type:"authenticate","myscript-client-name":"iink-ts","myscript-client-version":"2.0.1"})}manageHMACChallenge(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Le,"m",Te).call(this,{type:"hmac",hmac:yield computeHmac(i.hmacChallenge,this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey)})}))}initPing(){this.pingWorker=new Ne,this.pingWorker.postMessage({pingDelay:this.serverConfiguration.websocket.pingDelay}),this.pingWorker.onmessage=()=>{var i;this.pingCount<this.serverConfiguration.websocket.maxPingLostCount?__classPrivateFieldGet(this,Le,"m",Te).call(this,{type:"ping"}):(this.close(1e3,"MAXIMUM_PING_REACHED"),null===(i=this.pingWorker)||void 0===i||i.terminate()),this.pingCount++}}manageAuthenticated(){const i=25.4/96;__classPrivateFieldGet(this,Le,"m",Te).call(this,{type:this.sessionId?"restoreSession":"initSession",iinkSessionId:this.sessionId,scaleX:i,scaleY:i,configuration:this.recognitionConfiguration})}manageSessionDescriptionMessage(i){i.iinkSessionId&&(this.sessionId=i.iinkSessionId),this.currentPartId?__classPrivateFieldGet(this,Le,"m",Te).call(this,{type:"openContentPart",id:this.currentPartId}):__classPrivateFieldGet(this,Le,"m",Te).call(this,{type:"newContentPart",contentType:this.recognitionConfiguration.type,mimeTypes:this.mimeTypes})}manageNewPartMessage(i){this.initialized.resolve(),this.currentPartId=i.id}managePartChangeMessage(i){var s;null===(s=this.initialized)||void 0===s||s.resolve(),this.currentPartId=i.partId}manageContentChangedMessage(i){var s,r,n,a,l,d,h;null===(s=this.initialized)||void 0===s||s.resolve(),null===(r=this.replaceStrokeDeferred)||void 0===r||r.resolve(),null===(n=this.transformStrokeDeferred)||void 0===n||n.resolve(),null===(a=this.eraseStrokeDeferred)||void 0===a||a.resolve(),null===(l=this.undoDeferred)||void 0===l||l.resolve(),null===(d=this.redoDeferred)||void 0===d||d.resolve(),null===(h=this.clearDeferred)||void 0===h||h.resolve(),this.event.emitContextChange({canRedo:i.canRedo,canUndo:i.canRedo})}manageExportMessage(i){i.exports["application/vnd.myscript.jiix"]&&(i.exports["application/vnd.myscript.jiix"]=JSON.parse(i.exports["application/vnd.myscript.jiix"].toString())),Object.keys(i.exports).forEach((s=>{this.exportDeferredMap.has(s)&&this.exportDeferredMap.get(s).resolve(i.exports)})),this.event.emitExported(i.exports)}manageWaitForIdle(){var i;null===(i=this.waitForIdleDeferred)||void 0===i||i.resolve(),this.event.emitIdle(!0)}manageErrorMessage(i){var s,r;this.currentErrorCode=(null===(s=i.data)||void 0===s?void 0:s.code)||i.code;let n=(null===(r=i.data)||void 0===r?void 0:r.message)||i.message||Ee.UNKNOW;if("no.activity"===this.currentErrorCode)this.rejectDeferredPending(n),this.event.emitNotif({message:Ee.NO_ACTIVITY,timeout:1/0});else{switch(this.currentErrorCode){case"access.not.granted":n=Ee.WRONG_CREDENTIALS;break;case"session.too.old":n=Ee.TOO_OLD;break;case"restore.session.not.found":n=Ee.NO_SESSION_FOUND}this.rejectDeferredPending(n),this.event.emitError(new Error(n))}}manageGestureDetected(i){var s;null===(s=this.addStrokeDeferred)||void 0===s||s.resolve(i)}manageContextlessGesture(i){var s;null===(s=this.contextlessGestureDeferred.get(i.strokeId))||void 0===s||s.resolve(i)}messageCallback(i){this.currentErrorCode=void 0;try{const s=JSON.parse(i.data);if(s.type===Me.Pong)return;switch(this.pingCount=0,s.type){case Me.HMAC_Challenge:this.manageHMACChallenge(s);break;case Me.Authenticated:this.manageAuthenticated();break;case Me.SessionDescription:this.manageSessionDescriptionMessage(s);break;case Me.NewPart:this.manageNewPartMessage(s);break;case Me.PartChanged:this.managePartChangeMessage(s);break;case Me.ContentChanged:this.manageContentChangedMessage(s);break;case Me.Exported:this.manageExportMessage(s);break;case Me.GestureDetected:this.manageGestureDetected(s);break;case Me.ContextlessGesture:this.manageContextlessGesture(s);break;case Me.Error:this.manageErrorMessage(s);break;case Me.Idle:this.manageWaitForIdle();break;default:__classPrivateFieldGet(this,Ie,"f").warn("messageCallback",`Message type unknow: "${s}".`)}}catch(s){this.event.emitError(new Error(i.data))}}init(){return __awaiter(this,void 0,void 0,(function*(){"restore.session.not.found"===this.currentErrorCode&&(this.currentErrorCode,this.sessionId=void 0,this.currentPartId=void 0),this.socket=new WebSocket(this.url),this.clearSocketListener(),this.socket.addEventListener("open",this.openCallback.bind(this)),this.socket.addEventListener("close",this.closeCallback.bind(this)),this.socket.addEventListener("message",this.messageCallback.bind(this)),yield this.initialized.promise,this.serverConfiguration.websocket.pingEnabled&&(this.pingCount=0,this.initPing())}))}send(i){return __awaiter(this,void 0,void 0,(function*(){if(!this.socket)return Promise.reject(new Error("Recognizer must be initilized"));switch(this.socket.readyState){case this.socket.CONNECTING:case this.socket.OPEN:return yield this.initialized.promise,__classPrivateFieldGet(this,Le,"m",Te).call(this,i),Promise.resolve();case this.socket.CLOSING:case this.socket.CLOSED:return this.serverConfiguration.websocket.autoReconnect?(this.reconnectionCount++,this.serverConfiguration.websocket.maxRetryCount>this.reconnectionCount?(this.event.emitClearMessage(),yield this.init(),yield this.waitForIdle(),this.send(i)):Promise.reject(new Error("Unable to send message. The maximum number of connection attempts has been reached."))):Promise.reject(new Error("Unable to send message. Connection closed and automatic reconnection disabled"))}}))}buildAddStrokesMessage(i,s=!0){return{type:"addStrokes",processGestures:s,strokes:i.map((i=>i.formatToSend()))}}addStrokes(i,s=!0){var r,n;return __awaiter(this,void 0,void 0,(function*(){return this.addStrokeDeferred=new DeferredPromise,0===i.length?(this.addStrokeDeferred.resolve(void 0),null===(r=this.addStrokeDeferred)||void 0===r?void 0:r.promise):(yield this.send(this.buildAddStrokesMessage(i,s)),null===(n=this.addStrokeDeferred)||void 0===n?void 0:n.promise)}))}buildReplaceStrokesMessage(i,s){return{type:"replaceStrokes",oldStrokeIds:i,newStrokes:s.map((i=>i.formatToSend()))}}replaceStrokes(i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){return this.replaceStrokeDeferred=new DeferredPromise,0===i.length?(this.replaceStrokeDeferred.resolve(),null===(r=this.replaceStrokeDeferred)||void 0===r?void 0:r.promise):(yield this.send(this.buildReplaceStrokesMessage(i,s)),null===(n=this.replaceStrokeDeferred)||void 0===n?void 0:n.promise)}))}buildTransformTranslateMessage(i,s,r){return{type:"transform",transformationType:"TRANSLATE",strokeIds:i,tx:s,ty:r}}transformTranslate(i,s,r){var n,a;return __awaiter(this,void 0,void 0,(function*(){return this.transformStrokeDeferred=new DeferredPromise,0===i.length?(this.transformStrokeDeferred.resolve(),null===(n=this.transformStrokeDeferred)||void 0===n?void 0:n.promise):(yield this.send(this.buildTransformTranslateMessage(i,s,r)),null===(a=this.transformStrokeDeferred)||void 0===a?void 0:a.promise)}))}buildTransformRotateMessage(i,s,r=0,n=0){return{type:"transform",transformationType:"ROTATE",strokeIds:i,angle:s,x0:r,y0:n}}transformRotate(i,s,r=0,n=0){var a,l;return __awaiter(this,void 0,void 0,(function*(){return this.transformStrokeDeferred=new DeferredPromise,0===i.length?(this.transformStrokeDeferred.resolve(),null===(a=this.transformStrokeDeferred)||void 0===a?void 0:a.promise):(yield this.send(this.buildTransformRotateMessage(i,s,r,n)),null===(l=this.transformStrokeDeferred)||void 0===l?void 0:l.promise)}))}buildTransformScaleMessage(i,s,r,n=0,a=0){return{type:"transform",transformationType:"SCALE",strokeIds:i,scaleX:s,scaleY:r,x0:n,y0:a}}transformScale(i,s,r,n=0,a=0){var l,d;return __awaiter(this,void 0,void 0,(function*(){return this.transformStrokeDeferred=new DeferredPromise,0===i.length?(this.transformStrokeDeferred.resolve(),null===(l=this.transformStrokeDeferred)||void 0===l?void 0:l.promise):(yield this.send(this.buildTransformScaleMessage(i,s,r,n,a)),null===(d=this.transformStrokeDeferred)||void 0===d?void 0:d.promise)}))}buildTransformMatrixMessage(i,s){return Object.assign({type:"transform",transformationType:"MATRIX",strokeIds:i},s)}transformMatrix(i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){return this.transformStrokeDeferred=new DeferredPromise,0===i.length?(this.transformStrokeDeferred.resolve(),null===(r=this.transformStrokeDeferred)||void 0===r?void 0:r.promise):(yield this.send(this.buildTransformMatrixMessage(i,s)),null===(n=this.transformStrokeDeferred)||void 0===n?void 0:n.promise)}))}buildEraseStrokesMessage(i){return{type:"eraseStrokes",strokeIds:i}}eraseStrokes(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){return this.eraseStrokeDeferred=new DeferredPromise,0===i.length?(this.eraseStrokeDeferred.resolve(),null===(s=this.eraseStrokeDeferred)||void 0===s?void 0:s.promise):(yield this.send(this.buildEraseStrokesMessage(i)),null===(r=this.eraseStrokeDeferred)||void 0===r?void 0:r.promise)}))}recognizeGesture(i){return __awaiter(this,void 0,void 0,(function*(){if(!i)return;this.contextlessGestureDeferred.set(i.id,new DeferredPromise);const s=25.4/96;return yield this.send({type:"contextlessGesture",scaleX:s,scaleY:s,stroke:i.formatToSend()}),this.contextlessGestureDeferred.get(i.id).promise}))}waitForIdle(){var i;return __awaiter(this,void 0,void 0,(function*(){this.waitForIdleDeferred&&!this.waitForIdleDeferred.isFullFilled||(this.waitForIdleDeferred=new DeferredPromise);return yield this.send({type:"waitForIdle"}),null===(i=this.waitForIdleDeferred)||void 0===i?void 0:i.promise}))}buildUndoRedoChanges(i){var s,r,n,a,l,d,h;const c=[];return(null===(s=i.added)||void 0===s?void 0:s.length)&&c.push(this.buildAddStrokesMessage(i.added,!1)),(null===(r=i.erased)||void 0===r?void 0:r.length)&&c.push(this.buildEraseStrokesMessage(i.erased.map((i=>i.id)))),(null===(n=i.replaced)||void 0===n?void 0:n.newStrokes.length)&&c.push(this.buildReplaceStrokesMessage(i.replaced.oldStrokes.map((i=>i.id)),i.replaced.newStrokes)),(null===(a=i.matrix)||void 0===a?void 0:a.strokes.length)&&c.push(this.buildTransformMatrixMessage(i.matrix.strokes.map((i=>i.id)),i.matrix.matrix)),(null===(l=i.translate)||void 0===l?void 0:l.length)&&i.translate.forEach((i=>{c.push(this.buildTransformTranslateMessage(i.strokes.map((i=>i.id)),i.tx,i.ty))})),(null===(d=i.rotate)||void 0===d?void 0:d.length)&&i.rotate.forEach((i=>{c.push(this.buildTransformRotateMessage(i.strokes.map((i=>i.id)),i.angle,i.center.x,i.center.y))})),(null===(h=i.scale)||void 0===h?void 0:h.length)&&i.scale.forEach((i=>{c.push(this.buildTransformScaleMessage(i.strokes.map((i=>i.id)),i.scaleX,i.scaleY,i.origin.x,i.origin.y))})),c}undo(i){var s;return __awaiter(this,void 0,void 0,(function*(){const r=this.buildUndoRedoChanges(i);if(0===r.length)return;this.undoDeferred=new DeferredPromise;const n={type:"undo",changes:r};return yield this.send(n),null===(s=this.undoDeferred)||void 0===s?void 0:s.promise}))}redo(i){var s;return __awaiter(this,void 0,void 0,(function*(){const r=this.buildUndoRedoChanges(i);if(0===r.length)return;this.redoDeferred=new DeferredPromise;const n={type:"redo",changes:r};return yield this.send(n),null===(s=this.redoDeferred)||void 0===s?void 0:s.promise}))}export(i){return __awaiter(this,void 0,void 0,(function*(){const s=i||this.mimeTypes.slice();yield Promise.all(s.map((i=>{var s;return null===(s=this.exportDeferredMap.get(i))||void 0===s?void 0:s.promise}))),s.forEach((i=>{this.exportDeferredMap.set(i,new DeferredPromise)}));const r={type:"export",partId:this.currentPartId,mimeTypes:s};yield this.send(r);const n=yield Promise.all(s.map((i=>this.exportDeferredMap.get(i).promise)));return Object.assign({},...n)}))}clear(){var i;return __awaiter(this,void 0,void 0,(function*(){return this.clearDeferred=new DeferredPromise,yield this.send({type:"clear"}),null===(i=this.clearDeferred)||void 0===i?void 0:i.promise}))}close(i,s){return __awaiter(this,void 0,void 0,(function*(){return this.closeDeferred=new DeferredPromise,this.socket.readyState===this.socket.OPEN||this.socket.readyState===this.socket.CONNECTING?this.socket.close(i,s):this.closeDeferred.resolve(),this.closeDeferred.promise}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){this.resetAllDeferred(),this.socket&&(yield this.close(1e3,"Recognizer destroyed"))}))}}Ie=new WeakMap,Le=new WeakSet,Te=function _OIRecognizer_send(i){if(!this.socket)throw new Error("Recognizer must be initilized");if(this.socket.readyState!==this.socket.OPEN)throw new Error(`Connection not ready, state: ${this.socket.readyState}}`);this.socket.send(JSON.stringify(i))};class RestRecognizer{constructor(i,s){Oe.set(this,LoggerManager.getLogger(d.RECOGNIZER)),__classPrivateFieldGet(this,Oe,"f").info("constructor",{serverConfig:i,recognitionConfig:s}),this.serverConfiguration=i,this.recognitionConfiguration=s}get url(){return`${this.serverConfiguration.scheme}://${this.serverConfiguration.host}/api/v4.0/iink/batch`}get postConfig(){switch(this.recognitionConfiguration.type){case"DIAGRAM":return{lang:this.recognitionConfiguration.lang,diagram:this.recognitionConfiguration.diagram,export:this.recognitionConfiguration.export};case"MATH":return{lang:this.recognitionConfiguration.lang,math:this.recognitionConfiguration.math,export:this.recognitionConfiguration.export};case"Raw Content":return{lang:this.recognitionConfiguration.lang,"raw-content":this.recognitionConfiguration["raw-content"],export:this.recognitionConfiguration.export};case"TEXT":return{lang:this.recognitionConfiguration.lang,text:this.recognitionConfiguration.text,export:this.recognitionConfiguration.export};default:throw new Error(`get postConfig error Recognition type unkow "${this.recognitionConfiguration.type}"`)}}buildData(i){__classPrivateFieldGet(this,Oe,"f").info("buildData",{model:i});const s=[];i.symbols.forEach((i=>{const r=s.findIndex((s=>{return r=s.penStyle,n=i.style,r&&n&&r["-myscript-pen-fill-color"]===n["-myscript-pen-fill-color"]&&r["-myscript-pen-fill-style"]===n["-myscript-pen-fill-style"]&&r["-myscript-pen-width"]===n["-myscript-pen-width"]&&r.color===n.color&&r.width===n.width;var r,n}));r>-1?s[r].strokes.push(i):s.push({penStyle:i.style,strokes:[i]})}));const r=[];s.forEach((i=>{const s={penStyle:"{}"===JSON.stringify(i.penStyle)?void 0:pe.penStyleToCSS(i.penStyle),strokes:i.strokes.map((i=>i.formatToSend()))};r.push(s)}));const n="Raw Content"===this.recognitionConfiguration.type?"Raw Content":this.recognitionConfiguration.type.charAt(0).toUpperCase()+this.recognitionConfiguration.type.slice(1).toLowerCase(),a={configuration:this.postConfig,xDPI:96,yDPI:96,contentType:n,height:i.height,width:i.width,strokeGroups:r};return __classPrivateFieldGet(this,Oe,"f").debug("buildData",{data:a}),a}post(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Oe,"f").info("post",{data:i,mimeType:s});const r=new Headers;r.append("Accept","application/json,"+s),r.append("applicationKey",this.serverConfiguration.applicationKey);try{const s=yield computeHmac(JSON.stringify(i),this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey);r.append("hmac",s)}catch(i){__classPrivateFieldGet(this,Oe,"f").error("post.computeHmac",i)}r.append("Content-Type","application/json"),isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.0.4")&&(r.append("myscript-client-name","iink-ts"),r.append("myscript-client-version","2.0.1"));const n={method:"POST",headers:r,body:JSON.stringify(i)},a=new Request(this.url,n),l=yield fetch(a);if(l.ok){let i;switch(l.headers.get("content-type")){case"application/vnd.openxmlformats-officedocument.presentationml.presentation":case"image/png":case"image/jpeg":i=yield l.blob();break;case"application/json":i=yield l.json();break;case"application/vnd.myscript.jiix":i=yield l.clone().json().catch((()=>__awaiter(this,void 0,void 0,(function*(){return yield l.text()}))));break;default:i=yield l.text()}return __classPrivateFieldGet(this,Oe,"f").debug("post",{result:i}),i}{const i=yield l.json();throw __classPrivateFieldGet(this,Oe,"f").error("post",{err:i}),i}}))}tryFetch(i,s){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Oe,"f").debug("tryFetch",{data:i,mimeType:s}),this.post(i,s).then((i=>{const r={};return r[s]=i,__classPrivateFieldGet(this,Oe,"f").debug("tryFetch",{exports:r}),r})).catch((r=>{__classPrivateFieldGet(this,Oe,"f").error("tryFetch",{data:i,mimeType:s,err:r});let n=r.message||Ee.UNKNOW;r.code?"access.not.granted"===r.code&&(n=Ee.WRONG_CREDENTIALS):n=Ee.CANT_ESTABLISH;throw new Error(n)}))}))}getMimeTypes(i){__classPrivateFieldGet(this,Oe,"f").info("getMimeTypes",{requestedMimeTypes:i});let s=i||[];if(!s.length)switch(this.recognitionConfiguration.type){case"DIAGRAM":s=this.recognitionConfiguration.diagram.mimeTypes;break;case"MATH":s=this.recognitionConfiguration.math.mimeTypes;break;case"Raw Content":s=["application/vnd.myscript.jiix"];break;case"TEXT":s=this.recognitionConfiguration.text.mimeTypes;break;default:throw new Error(`Recognition type "${this.recognitionConfiguration.type}" is unknown.\n Possible types are:\n -DIAGRAM\n -MATH\n -Raw Content\n -TEXT`)}return s}convert(i,s,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Oe,"f").info("convert",{model:i,conversionState:s,requestedMimeTypes:r});const n=i.clone(),a=this.getMimeTypes(r),l=this.buildData(n);l.conversionState=s;const d=a.map((i=>this.tryFetch(l,i)));return(yield Promise.all(d)).forEach((i=>{n.mergeConvert(i)})),__classPrivateFieldGet(this,Oe,"f").debug("convert",{model:n}),n}))}export(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Oe,"f").info("export",{model:i,requestedMimeTypes:s});const r=i.clone();if(0===r.symbols.length)return Promise.resolve(r);const n=this.getMimeTypes(s);if(!n.length)return __classPrivateFieldGet(this,Oe,"f").error("export",{model:i,requestedMimeTypes:s,"Export failed, no mimeTypes define in recognition configuration":String}),Promise.reject(new Error("Export failed, no mimeTypes define in recognition configuration"));const a=n.filter((i=>!r.exports||!r.exports[i])),l=this.buildData(i);return(yield Promise.all(a.map((i=>this.tryFetch(l,i))))).forEach((i=>{r.mergeExport(i)})),__classPrivateFieldGet(this,Oe,"f").debug("export",{model:r}),r}))}resize(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Oe,"f").info("resize",{model:i}),this.export(i)}))}}Oe=new WeakMap;class WSRecognizer{constructor(i,s){De.set(this,LoggerManager.getLogger(d.RECOGNIZER)),this.pingCount=0,this.reconnectionCount=0,this.serverConfiguration=i,this.recognitionConfiguration=s;const r="https"===this.serverConfiguration.scheme?"wss":"ws";this.url=`${r}://${this.serverConfiguration.host}/api/v4.0/iink/document?applicationKey=${this.serverConfiguration.applicationKey}`,__classPrivateFieldGet(this,De,"f").info("constructor",{serverConfig:i,recognitionConfig:s,url:this.url})}get mimeTypes(){switch(this.recognitionConfiguration.type.toLocaleLowerCase()){case"text":return this.recognitionConfiguration.text.mimeTypes;case"math":return this.recognitionConfiguration.math.mimeTypes;default:throw new Error(`Unauthorized recognition type: "${this.recognitionConfiguration.type}"`)}}get internalEvent(){return InternalEvent.getInstance()}infinitePing(){this.pingCount++,this.serverConfiguration.websocket.maxPingLostCount<this.pingCount?this.socket.close(1e3,"MAXIMUM_PING_REACHED"):this.socket.readyState<=1&&setTimeout((()=>{this.socket.readyState<=1&&(this.socket.send(JSON.stringify({type:"ping"})),this.infinitePing())}),this.serverConfiguration.websocket.pingDelay)}openCallback(){var i;null===(i=this.connected)||void 0===i||i.resolve();const s={type:this.sessionId?"restoreIInkSession":"newContentPackage",iinkSessionId:this.sessionId,applicationKey:this.serverConfiguration.applicationKey,xDpi:96,yDpi:96,viewSizeHeight:this.viewSizeHeight,viewSizeWidth:this.viewSizeWidth};isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.0.4")&&(s["myscript-client-name"]="iink-ts",s["myscript-client-version"]="2.0.1"),this.send(s)}rejectDeferredPending(i){var s,r,n,a,l,d,h,c,u,p,m,v,g,y,f,b,x,w,S,_;(null===(s=this.connected)||void 0===s?void 0:s.isPending)&&(null===(r=this.connected)||void 0===r||r.reject(i)),(null===(n=this.initialized)||void 0===n?void 0:n.isPending)&&(null===(a=this.initialized)||void 0===a||a.reject(i)),(null===(l=this.addStrokeDeferred)||void 0===l?void 0:l.isPending)&&(null===(d=this.addStrokeDeferred)||void 0===d||d.reject(i)),(null===(h=this.exportDeferred)||void 0===h?void 0:h.isPending)&&(null===(c=this.exportDeferred)||void 0===c||c.reject(i)),(null===(u=this.convertDeferred)||void 0===u?void 0:u.isPending)&&(null===(p=this.convertDeferred)||void 0===p||p.reject(i)),(null===(m=this.importDeferred)||void 0===m?void 0:m.isPending)&&(null===(v=this.importDeferred)||void 0===v||v.reject(i)),(null===(g=this.resizeDeferred)||void 0===g?void 0:g.isPending)&&(null===(y=this.resizeDeferred)||void 0===y||y.reject(i)),(null===(f=this.undoDeferred)||void 0===f?void 0:f.isPending)&&(null===(b=this.undoDeferred)||void 0===b||b.reject(i)),(null===(x=this.redoDeferred)||void 0===x?void 0:x.isPending)&&(null===(w=this.redoDeferred)||void 0===w||w.reject(i)),(null===(S=this.clearDeferred)||void 0===S?void 0:S.isPending)&&this.clearDeferred.reject(i),(null===(_=this.waitForIdleDeferred)||void 0===_?void 0:_.isPending)&&this.waitForIdleDeferred.reject(i)}closeCallback(i){let s="";if(!this.currentErrorCode)switch(i.code){case 1e3:break;case 1001:s=Ee.GOING_AWAY;break;case 1002:s=Ee.PROTOCOL_ERROR;break;case 1003:s=Ee.UNSUPPORTED_DATA;break;case 1006:s=Ee.ABNORMAL_CLOSURE;break;case 1007:s=Ee.INVALID_FRAME_PAYLOAD;break;case 1008:s=Ee.POLICY_VIOLATION;break;case 1009:s=Ee.MESSAGE_TOO_BIG;break;case 1011:s=Ee.INTERNAL_ERROR;break;case 1012:s=Ee.SERVICE_RESTART;break;case 1013:s=Ee.TRY_AGAIN;break;case 1014:s=Ee.BAD_GATEWAY;break;case 1015:s=Ee.TLS_HANDSHAKE;break;default:__classPrivateFieldGet(this,De,"f").warn("closeCallback","unknow CloseEvent.code",{evt:i}),s=Ee.CANT_ESTABLISH}const r=new Error(s||i.reason);this.rejectDeferredPending(r),this.currentErrorCode||1e3===i.code||this.internalEvent.emitError(r)}manageAckMessage(i){var s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("manageAckMessage",{websocketMessage:i});const r=i;r.hmacChallenge&&this.send({type:"hmac",hmac:yield computeHmac(r.hmacChallenge,this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey)}),r.iinkSessionId&&(this.sessionId=r.iinkSessionId);const n=structuredClone(this.recognitionConfiguration);isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.3.0")||delete n.convert,this.send(Object.assign(Object.assign({},n),{type:"configuration"})),null===(s=this.ackDeferred)||void 0===s||s.resolve()}))}manageContentPackageDescriptionMessage(){var i;return __awaiter(this,void 0,void 0,(function*(){this.reconnectionCount=0,yield null===(i=this.ackDeferred)||void 0===i?void 0:i.promise,__classPrivateFieldGet(this,De,"f").info("manageContentPackageDescriptionMessage"),this.currentPartId?this.send({type:"openContentPart",id:this.currentPartId,mimeTypes:this.mimeTypes}):this.send({type:"newContentPart",contentType:this.recognitionConfiguration.type,mimeTypes:this.mimeTypes})}))}managePartChangeMessage(i){var s;__classPrivateFieldGet(this,De,"f").info("managePartChangeMessage",{websocketMessage:i});const r=i;this.currentPartId=r.partId,null===(s=this.initialized)||void 0===s||s.resolve()}manageExportMessage(i){var s,r,n,a,l,d,h,c,u;__classPrivateFieldGet(this,De,"f").info("manageExportMessage",{websocketMessage:i});const p=i;p.exports["application/vnd.myscript.jiix"]&&(p.exports["application/vnd.myscript.jiix"]=JSON.parse(p.exports["application/vnd.myscript.jiix"].toString())),null===(s=this.initialized)||void 0===s||s.resolve(),null===(r=this.addStrokeDeferred)||void 0===r||r.resolve(p.exports),null===(n=this.exportDeferred)||void 0===n||n.resolve(p.exports),null===(a=this.convertDeferred)||void 0===a||a.resolve(p.exports),null===(l=this.importDeferred)||void 0===l||l.resolve(p.exports),null===(d=this.undoDeferred)||void 0===d||d.resolve(p.exports),null===(h=this.redoDeferred)||void 0===h||h.resolve(p.exports),null===(c=this.clearDeferred)||void 0===c||c.resolve(p.exports),null===(u=this.importPointEventsDeferred)||void 0===u||u.resolve(p.exports),this.internalEvent.emitExported(p.exports)}manageWaitForIdle(){var i;return __awaiter(this,void 0,void 0,(function*(){this.internalEvent.emitIdle(!0),null===(i=this.waitForIdleDeferred)||void 0===i||i.resolve()}))}manageErrorMessage(i){var s,r;const n=i;this.currentErrorCode=(null===(s=n.data)||void 0===s?void 0:s.code)||n.code;let a=(null===(r=n.data)||void 0===r?void 0:r.message)||n.message||Ee.UNKNOW;switch(this.currentErrorCode){case"no.activity":a=Ee.NO_ACTIVITY;break;case"access.not.granted":a=Ee.WRONG_CREDENTIALS;break;case"session.too.old":a=Ee.TOO_OLD}const l=new Error(a);this.rejectDeferredPending(l),this.internalEvent.emitError(l)}manageContentChangeMessage(i){__classPrivateFieldGet(this,De,"f").info("manageContentChangeMessage",{websocketMessage:i});const s=i,r={canRedo:s.canRedo,canUndo:s.canUndo,empty:s.empty,stackIndex:s.undoStackIndex,possibleUndoCount:s.possibleUndoCount};this.internalEvent.emitContextChange(r)}manageSVGPatchMessage(i){var s;__classPrivateFieldGet(this,De,"f").info("manageSVGPatchMessage",{websocketMessage:i}),null===(s=this.resizeDeferred)||void 0===s||s.resolve();const r=i;this.internalEvent.emitSVGPatch(r)}messageCallback(i){var s;__classPrivateFieldGet(this,De,"f").debug("messageCallback",{message:i}),this.currentErrorCode=void 0;const r=JSON.parse(i.data);if("pong"!==r.type)switch(this.pingCount=0,r.type){case"ack":this.manageAckMessage(r);break;case"contentPackageDescription":this.manageContentPackageDescriptionMessage();break;case"partChanged":this.managePartChangeMessage(r);break;case"newPart":null===(s=this.initialized)||void 0===s||s.resolve();break;case"contentChanged":this.manageContentChangeMessage(r);break;case"exported":this.manageExportMessage(r);break;case"svgPatch":this.manageSVGPatchMessage(r);break;case"error":this.manageErrorMessage(r);break;case"idle":this.manageWaitForIdle();break;default:__classPrivateFieldGet(this,De,"f").warn("messageCallback",`Message type unknow: "${r.type}".`)}}init(i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){try{return __classPrivateFieldGet(this,De,"f").info("init",{height:i,width:s}),this.destroy(),this.connected=new DeferredPromise,this.initialized=new DeferredPromise,this.ackDeferred=new DeferredPromise,this.viewSizeHeight=i,this.viewSizeWidth=s,this.pingCount=0,this.socket=new WebSocket(this.url),this.serverConfiguration.websocket.pingEnabled&&this.infinitePing(),this.socket.addEventListener("open",this.openCallback.bind(this)),this.socket.addEventListener("close",this.closeCallback.bind(this)),this.socket.addEventListener("message",this.messageCallback.bind(this)),this.initialized.promise}catch(i){const s=new Error(Ee.CANT_ESTABLISH);return this.internalEvent.emitError(s),null===(r=this.initialized)||void 0===r||r.reject(s),null===(n=this.initialized)||void 0===n?void 0:n.promise}}))}send(i){return __awaiter(this,void 0,void 0,(function*(){return this.connected?(yield this.connected.promise,this.socket.readyState===this.socket.OPEN?(__classPrivateFieldGet(this,De,"f").debug("send",{message:i}),this.socket.send(JSON.stringify(i)),Promise.resolve()):this.socket.readyState!=this.socket.CONNECTING&&this.serverConfiguration.websocket.autoReconnect?(this.reconnectionCount++,this.serverConfiguration.websocket.maxRetryCount>=this.reconnectionCount?(__classPrivateFieldGet(this,De,"f").debug("send",`try to reconnect number: ${this.reconnectionCount}.`),this.internalEvent.emitClearMessage(),yield this.init(this.viewSizeHeight,this.viewSizeWidth),yield this.setPenStyle(this.penStyle),yield this.setPenStyleClasses(this.penStyleClasses),yield this.setTheme(this.theme),this.send(i)):Promise.reject(new Error("Unable to send message. The maximum number of connection attempts has been reached."))):void 0):Promise.reject(new Error("Recognizer must be initilized"))}))}addStrokes(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,De,"f").info("addStrokes",{strokes:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.addStrokeDeferred=new DeferredPromise,0===i.length?this.addStrokeDeferred.resolve({}):yield this.send({type:"addStrokes",strokes:i.map((i=>i.formatToSend()))}),null===(r=this.addStrokeDeferred)||void 0===r?void 0:r.promise}))}setPenStyle(i){var s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("setPenStyle",{penStyle:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.penStyle=i;const r={type:"setPenStyle",style:pe.penStyleToCSS(i)};return this.send(r)}))}setPenStyleClasses(i){var s;return __awaiter(this,void 0,void 0,(function*(){yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.penStyleClasses=i,__classPrivateFieldGet(this,De,"f").info("setPenStyleClasses",{penStyleClasses:i});const r={type:"setPenStyleClasses",styleClasses:i};return this.send(r)}))}setTheme(i){var s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("setTheme",{theme:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.theme=i;const r={type:"setTheme",theme:pe.themeToCSS(i)};return this.send(r)}))}export(i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("export",{model:i,requestedMimeTypes:s}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.exportDeferred=new DeferredPromise;const a=i.clone();let l=s||[];if(!l.length)switch(this.recognitionConfiguration.type){case"DIAGRAM":l=this.recognitionConfiguration.diagram.mimeTypes;break;case"MATH":l=this.recognitionConfiguration.math.mimeTypes;break;case"Raw Content":l=["application/vnd.myscript.jiix"];break;case"TEXT":l=this.recognitionConfiguration.text.mimeTypes;break;default:throw new Error(`Recognition type "${this.recognitionConfiguration.type}" is unknown.\n Possible types are:\n -DIAGRAM\n -MATH\n -Raw Content\n -TEXT`)}if(!l.length)return Promise.reject(new Error(`Export failed, no mimeTypes define in recognition ${this.recognitionConfiguration.type} configuration`));const d={type:"export",partId:this.currentPartId,mimeTypes:l};yield this.send(d);const h=yield null===(n=this.exportDeferred)||void 0===n?void 0:n.promise;return a.updatePositionReceived(),a.mergeExport(h),__classPrivateFieldGet(this,De,"f").debug("export",{model:a}),a}))}import(i,s,r){var n,a;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("import",{data:s,mimeType:r}),yield null===(n=this.initialized)||void 0===n?void 0:n.promise;const l=i.clone(),d=this.serverConfiguration.websocket.fileChunkSize,h=Math.random().toString(10).substring(2,6);this.importDeferred=new DeferredPromise;const readBlob=i=>{const s=new FileReader;return new Promise(((r,n)=>{s.onloadend=i=>{var s;return r(null===(s=i.target)||void 0===s?void 0:s.result)},s.onerror=()=>n(),s.readAsText(i)}))},c={type:"importFile",importFileId:h,mimeType:r};yield this.send(c);for(let i=0;i<s.size;i+=d){const r=s.slice(i,i+d,s.type),n={type:"fileChunk",importFileId:h,data:yield readBlob(r),lastChunk:i+d>s.size};yield this.send(n)}const u=yield null===(a=this.importDeferred)||void 0===a?void 0:a.promise;return this.importDeferred=void 0,l.mergeExport(u),l}))}resize(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("resize",{model:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.resizeDeferred=new DeferredPromise;const n=i.clone();this.viewSizeHeight=n.height,this.viewSizeWidth=n.width;const a={type:"changeViewSize",height:this.viewSizeHeight,width:this.viewSizeWidth};return yield this.send(a),yield null===(r=this.resizeDeferred)||void 0===r?void 0:r.promise,n}))}importPointEvents(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("importPointsEvents",{strokes:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.importPointEventsDeferred=new DeferredPromise;const n={type:"pointerEvents",events:i.map((i=>i.formatToSend()))};this.send(n);const a=yield null===(r=this.importPointEventsDeferred)||void 0===r?void 0:r.promise;return this.importPointEventsDeferred=void 0,__classPrivateFieldGet(this,De,"f").debug("importPointEvents",{exportPoints:a}),a}))}convert(i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("convert",{model:i,conversionState:s}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.convertDeferred=new DeferredPromise;const a=i.clone(),l={type:"convert",conversionState:s};yield this.send(l);const d=yield null===(n=this.convertDeferred)||void 0===n?void 0:n.promise;return a.updatePositionReceived(),a.mergeConvert(d),__classPrivateFieldGet(this,De,"f").debug("convert",{model:a}),a}))}waitForIdle(){var i,s;return __awaiter(this,void 0,void 0,(function*(){yield null===(i=this.initialized)||void 0===i?void 0:i.promise,this.waitForIdleDeferred=new DeferredPromise;return yield this.send({type:"waitForIdle"}),null===(s=this.waitForIdleDeferred)||void 0===s?void 0:s.promise}))}undo(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("undo",{model:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise;const n=i.clone();this.undoDeferred=new DeferredPromise;yield this.send({type:"undo"});const a=yield null===(r=this.undoDeferred)||void 0===r?void 0:r.promise;return n.updatePositionReceived(),n.mergeExport(a),__classPrivateFieldGet(this,De,"f").debug("undo",{model:n}),this.undoDeferred=void 0,n}))}redo(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("redo",{model:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise;const n=i.clone();this.redoDeferred=new DeferredPromise;yield this.send({type:"redo"});const a=yield null===(r=this.redoDeferred)||void 0===r?void 0:r.promise;return n.updatePositionReceived(),n.mergeExport(a),__classPrivateFieldGet(this,De,"f").debug("redo",{model:a}),this.redoDeferred=void 0,n}))}clear(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("clear",{model:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise;const n=i.clone();n.modificationDate=Date.now(),this.clearDeferred=new DeferredPromise;yield this.send({type:"clear"});const a=yield null===(r=this.clearDeferred)||void 0===r?void 0:r.promise;return n.updatePositionReceived(),n.mergeExport(a),this.clearDeferred=void 0,__classPrivateFieldGet(this,De,"f").info("clear",{model:n}),n}))}close(i,s){this.socket.readyState!==this.socket.OPEN&&this.socket.readyState!==this.socket.CONNECTING||(__classPrivateFieldGet(this,De,"f").info("close",{code:i,reason:s}),this.socket.removeEventListener("close",this.closeCallback),this.socket.removeEventListener("message",this.messageCallback),this.socket.removeEventListener("open",this.openCallback),this.socket.close(i,s))}destroy(){__classPrivateFieldGet(this,De,"f").info("destroy"),this.connected=void 0,this.initialized=void 0,this.ackDeferred=void 0,this.addStrokeDeferred=void 0,this.exportDeferred=void 0,this.convertDeferred=void 0,this.importDeferred=void 0,this.resizeDeferred=void 0,this.undoDeferred=void 0,this.redoDeferred=void 0,this.clearDeferred=void 0,this.socket&&(this.socket.removeEventListener("close",this.closeCallback),this.socket.removeEventListener("message",this.messageCallback),this.socket.removeEventListener("open",this.openCallback),this.close(1e3,"Recognizer destroyed"))}}De=new WeakMap;class CanvasRendererShape{constructor(){Re.set(this,LoggerManager.getLogger(d.RENDERER)),this.symbols={table:"table",ellipse:"ellipse",line:"line"}}phi(i){let s=(i+Math.PI)%(2*Math.PI)-Math.PI;return s<-Math.PI&&(s+=2*Math.PI),__classPrivateFieldGet(this,Re,"f").debug("phi",{angle:i,returnedAngle:s}),s}drawEllipseArc(i,s){__classPrivateFieldGet(this,Re,"f").debug("drawEllipseArc",{context2D:i,shapeEllipse:s});const{centerPoint:r,maxRadius:n,minRadius:a,orientation:l,startAngle:d,sweepAngle:h}=s,c=Math.cos(l)*n,u=Math.cos(l)*a,p=Math.sin(l)*n,m=Math.sin(l)*a,v=Math.floor(Math.abs(h)/.02),g=[];i.save();try{i.beginPath();for(let s=0;s<=v;s++){const l=d+s/v*h,y=Math.atan2(Math.sin(l)/a,Math.cos(l)/n),f=Math.cos(y),b=Math.sin(y),x=r.x+c*f-m*b,w=r.y+u*b+p*f;0===s?i.moveTo(x,w):i.lineTo(x,w),0!==s&&s!==v||g.push({x:x,y:w})}i.stroke()}catch(i){__classPrivateFieldGet(this,Re,"f").error("drawEllipseArc",{error:i})}finally{i.restore()}return g}drawLine(i,s,r){__classPrivateFieldGet(this,Re,"f").debug("drawLine",{context2D:i,p1:s,p2:r}),i.save();try{i.beginPath(),i.moveTo(s.x,s.y),i.lineTo(r.x,r.y),i.stroke()}catch(i){__classPrivateFieldGet(this,Re,"f").error("drawLine",{error:i})}finally{i.restore()}}drawArrowHead(i,s,r,n){__classPrivateFieldGet(this,Re,"f").debug("drawArrowHead",{context2D:i,headPoint:s,angle:r,length:n});const a=this.phi(r+Math.PI*(7/8)),l=this.phi(r-Math.PI*(7/8));i.save();try{i.fillStyle=i.strokeStyle,i.moveTo(s.x,s.y),i.beginPath(),i.lineTo(s.x+n*Math.cos(a),s.y+n*Math.sin(a)),i.lineTo(s.x+n*Math.cos(l),s.y+n*Math.sin(l)),i.lineTo(s.x,s.y),i.fill()}catch(i){__classPrivateFieldGet(this,Re,"f").error("drawArrowHead",{error:i})}finally{i.restore()}}drawShapeEllipse(i,s){__classPrivateFieldGet(this,Re,"f").debug("drawShapeEllipse",{context2D:i,shapeEllipse:s});const r=this.drawEllipseArc(i,s);"ARROW_HEAD"===(null==s?void 0:s.beginDecoration)&&this.drawArrowHead(i,r[0],s.beginTangentAngle,12),"ARROW_HEAD"===(null==s?void 0:s.endDecoration)&&this.drawArrowHead(i,r[1],s.endTangentAngle,12)}drawShapeLine(i,s){__classPrivateFieldGet(this,Re,"f").debug("drawShapeLine",{context2D:i,shapeLine:s}),this.drawLine(i,s.firstPoint,s.lastPoint),"ARROW_HEAD"===s.beginDecoration&&this.drawArrowHead(i,s.firstPoint,s.beginTangentAngle,12),"ARROW_HEAD"===s.endDecoration&&this.drawArrowHead(i,s.lastPoint,s.endTangentAngle,12)}draw(i,s){switch(__classPrivateFieldGet(this,Re,"f").info("draw",{context2D:i,symbol:s}),i.save(),i.lineWidth=s.style.width,i.strokeStyle=s.style.color,s.type){case this.symbols.table:s.lines.forEach((s=>this.drawLine(i,s.p1,s.p2)));break;case this.symbols.ellipse:this.drawShapeEllipse(i,s);break;case this.symbols.line:this.drawShapeLine(i,s);break;default:__classPrivateFieldGet(this,Re,"f").warn("draw",`${s.type} not implemented`)}}}Re=new WeakMap;class CanvasRendererStroke{constructor(){Ae.set(this,LoggerManager.getLogger(d.RENDERER))}renderArc(i,s,r){__classPrivateFieldGet(this,Ae,"f").debug("renderArc",{context2d:i,center:s,radius:r}),i.arc(s.x,s.y,r,0,2*Math.PI,!0)}renderLine(i,s,r,n){__classPrivateFieldGet(this,Ae,"f").debug("renderLine",{context2d:i,begin:s,end:r,width:n});const a=computeLinksPointers(s,computeAngleAxeRadian(s,r),n),l=computeLinksPointers(r,computeAngleAxeRadian(s,r),n);i.moveTo(a[0].x,a[0].y),i.lineTo(l[0].x,l[0].y),i.lineTo(l[1].x,l[1].y),i.lineTo(a[1].x,a[1].y)}renderFinal(i,s,r,n){__classPrivateFieldGet(this,Ae,"f").debug("renderFinal",{context2d:i,begin:s,end:r,width:n});const a=computeAngleAxeRadian(s,r),l=computeLinksPointers(r,a,n);i.moveTo(l[0].x,l[0].y);for(let s=1;s<=6;s++){const l=a-s*Math.PI/6;i.lineTo(r.x-r.p*n*Math.sin(l),r.y+r.p*n*Math.cos(l))}}renderQuadratic(i,s,r,n,a){__classPrivateFieldGet(this,Ae,"f").debug("renderQuadratic",{context2d:i,begin:s,end:r,ctrl:n,width:a});const l=computeLinksPointers(s,computeAngleAxeRadian(s,n),a),d=computeLinksPointers(r,computeAngleAxeRadian(n,r),a),h=computeLinksPointers(n,computeAngleAxeRadian(s,r),a);i.moveTo(l[0].x,l[0].y),i.quadraticCurveTo(h[0].x,h[0].y,d[0].x,d[0].y),i.lineTo(d[1].x,d[1].y),i.quadraticCurveTo(h[1].x,h[1].y,l[1].x,l[1].y)}draw(i,s){__classPrivateFieldGet(this,Ae,"f").info("draw",{context2d:i,stroke:s});const r=s.pointers.length,n=r-2,a=s.style.width>0?s.style.width:i.lineWidth,l=s.style.color?s.style.color:i.strokeStyle,d=s.pointers[0];i.save();try{if(i.beginPath(),r<3)this.renderArc(i,d,.6*a);else{this.renderArc(i,d,a*d.p);const l=computeMiddlePointer(d,s.pointers[1]);this.renderLine(i,d,l,a);for(let r=0;r<n;r++){const n=computeMiddlePointer(s.pointers[r],s.pointers[r+1]),l=computeMiddlePointer(s.pointers[r+1],s.pointers[r+2]),d=s.pointers[r+1];this.renderQuadratic(i,n,l,d,a)}const h=computeMiddlePointer(s.pointers[r-2],s.pointers[r-1]),c=s.pointers[r-1];this.renderLine(i,h,c,a);const u=s.pointers[r-2],p=s.pointers[r-1];this.renderFinal(i,u,p,a)}i.closePath(),void 0!==l&&(i.fillStyle=l,i.fill()),i.save()}catch(i){__classPrivateFieldGet(this,Ae,"f").error("draw",{error:i})}finally{i.restore()}}}Ae=new WeakMap;class CanvasRendererText{constructor(){Be.set(this,LoggerManager.getLogger(d.RENDERER)),this.symbols={char:"char",string:"string",textLine:"textLine"}}drawUnderline(i,s,r){__classPrivateFieldGet(this,Be,"f").debug("#drawUnderline",{context2D:i,textUnderline:s,underline:r}),i.save();try{const n=s.data.width/s.label.length,a={x:s.data.topLeftPoint.x+r.data.firstCharacter*n,y:s.data.topLeftPoint.y+s.data.height},l={x:s.data.topLeftPoint.x+r.data.lastCharacter*n,y:s.data.topLeftPoint.y+s.data.height};i.beginPath(),i.moveTo(a.x,a.y),i.lineTo(l.x,l.y),i.stroke()}catch(i){__classPrivateFieldGet(this,Be,"f").error("#drawUnderline",{error:i})}finally{i.restore()}}drawText(i,s){__classPrivateFieldGet(this,Be,"f").debug("#drawText",{context2D:i,text:s}),i.save();try{i.font=`${s.data.textHeight}px serif`,i.textAlign="CENTER"===s.data.justificationType?"center":"left",i.textBaseline="bottom",i.fillStyle=i.strokeStyle,i.fillText(s.label,s.data.topLeftPoint.x,s.data.topLeftPoint.y+s.data.height)}catch(i){__classPrivateFieldGet(this,Be,"f").error("#drawText",{error:i})}finally{i.restore()}}drawTextLine(i,s){__classPrivateFieldGet(this,Be,"f").debug("#drawTextLine",{context2D:i,textUnderline:s}),this.drawText(i,s),s.underlineList.forEach((r=>{this.drawUnderline(i,s,r)}))}draw(i,s){switch(__classPrivateFieldGet(this,Be,"f").info("draw",{context2D:i,symbol:s}),i.lineWidth=s.style.width,i.strokeStyle=s.style.color,s.type){case this.symbols.char:case this.symbols.string:this.drawText(i,s);break;case this.symbols.textLine:this.drawTextLine(i,s);break;default:__classPrivateFieldGet(this,Be,"f").warn("draw",`${s.type} not implemented`)}}}Be=new WeakMap;class CanvasRenderer{constructor(i){$e.set(this,LoggerManager.getLogger(d.RENDERER)),__classPrivateFieldGet(this,$e,"f").info("constructor",{config:i}),this.configuration=i,this.strokeRenderer=new CanvasRendererStroke,this.shapeRenderer=new CanvasRendererShape,this.textRenderer=new CanvasRendererText}createCanvas(i){__classPrivateFieldGet(this,$e,"f").debug("createCanvas",{type:i});const s=document.createElement("canvas");return s.id=i,s.classList.add(i),s.classList.add("ms-canvas"),s}resizeContent(){const i=window.devicePixelRatio;[this.context.renderingCanvas,this.context.capturingCanvas].forEach((s=>{var r;const n=s.parentNode,a=Math.max(this.configuration.minWidth,n.clientWidth),l=Math.max(this.configuration.minHeight,n.clientHeight);s.width=a*i,s.height=l*i,null===(r=s.getContext("2d"))||void 0===r||r.scale(i,i),s.style.width=`${a}px`,s.style.height=`${l}px`}))}drawSymbol(i,s){if(__classPrivateFieldGet(this,$e,"f").debug("drawSymbol",{symbol:s}),"stroke"===s.type){const r=s;"eraser"!==r.pointerType&&this.strokeRenderer.draw(i,r)}else Object.keys(this.textRenderer.symbols).includes(s.type)?this.textRenderer.draw(i,s):Object.keys(this.shapeRenderer.symbols).includes(s.type)?this.shapeRenderer.draw(i,s):__classPrivateFieldGet(this,$e,"f").warn("drawSymbol",`symbol type unknow: ${s.type}`)}init(i){__classPrivateFieldGet(this,$e,"f").info("init",{element:i});const s=this.createCanvas("ms-rendering-canvas");i.appendChild(s);const r=this.createCanvas("ms-capture-canvas");i.appendChild(r),this.context={parent:i,renderingCanvas:s,renderingCanvasContext:s.getContext("2d"),capturingCanvas:r,capturingCanvasContext:r.getContext("2d")},this.resizeContent()}drawModel(i){var s;__classPrivateFieldGet(this,$e,"f").info("drawModel",{model:i}),null===(s=this.context.renderingCanvasContext)||void 0===s||s.clearRect(0,0,this.context.renderingCanvas.width,this.context.renderingCanvas.height),i.symbols.forEach((i=>this.drawSymbol(this.context.renderingCanvasContext,i))),this.context.capturingCanvasContext.clearRect(0,0,this.context.capturingCanvas.width,this.context.capturingCanvas.height)}drawPendingStroke(i){__classPrivateFieldGet(this,$e,"f").info("drawPendingStroke",{stroke:i}),this.context.capturingCanvasContext.clearRect(0,0,this.context.capturingCanvas.width,this.context.capturingCanvas.height),i&&"eraser"!==(null==i?void 0:i.pointerType)&&this.strokeRenderer.draw(this.context.capturingCanvasContext,i)}resize(i){__classPrivateFieldGet(this,$e,"f").info("resize",{model:i}),this.resizeContent(),this.drawModel(i)}destroy(){__classPrivateFieldGet(this,$e,"f").info("destroy"),this.context.parent&&(this.context.parent.innerHTML="")}}$e=new WeakMap;const ze={arrowHeadStartMarker:"arrow-head-start",arrowHeadEndMaker:"arrow-head-end",selectionFilterId:"selection-filter",removalFilterId:"removal-filter",crossMarker:"cross-marker",noSelection:"pointer-events: none; -webkit-touch-callout: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;"},je="http://www.w3.org/2000/svg";class SVGBuilder{static createLayer(i,s={}){const r=document.createElementNS(je,"svg");return r.setAttribute("width",`${i.width}px`),r.setAttribute("height",`${i.height}px`),r.setAttribute("viewBox",`${i.x}, ${i.y}, ${i.width}, ${i.height}`),Object.keys(s).forEach((i=>{r.setAttribute(i,s[i])})),r}static createFilter(i,s={}){const r=document.createElementNS(je,"filter");return r.id=i,Object.keys(s).forEach((i=>{r.setAttribute(i,s[i])})),r}static createDefs(){return document.createElementNS(je,"defs")}static createMarker(i,s={}){const r=document.createElementNS(je,"marker");return r.setAttribute("id",i),Object.keys(s).forEach((i=>{r.setAttribute(i,s[i])})),r}static createComponentTransfert(){return document.createElementNS(je,"feComponentTransfer")}static createDropShadow({dx:i=0,dy:s=0,deviation:r=0,color:n="#3e68ff",opacity:a=1}){const l=document.createElementNS(je,"feDropShadow");return l.setAttribute("dx",i.toString()),l.setAttribute("dy",s.toString()),l.setAttribute("stdDeviation",r.toString()),l.setAttribute("flood-color",n),l.setAttribute("flood-opacity",a.toString()),l}static createTransfertFunctionTable(i,s){const r=document.createElementNS(je,i);return r.setAttribute("type","table"),r.setAttribute("tableValues",s),r}static createGroup(i={}){const s=document.createElementNS(je,"g");return Object.keys(i).forEach((r=>{s.setAttribute(r,i[r])})),s}static createLine(i,s,r={}){const n=document.createElementNS(je,"line");return n.setAttribute("x1",i.x.toString()),n.setAttribute("y1",i.y.toString()),n.setAttribute("x2",s.x.toString()),n.setAttribute("y2",s.y.toString()),Object.keys(r).forEach((i=>{n.setAttribute(i,r[i])})),n}static createCircle(i,s,r={}){const n=document.createElementNS(je,"circle");return n.setAttribute("cx",i.x.toString()),n.setAttribute("cy",i.y.toString()),n.setAttribute("r",s.toString()),Object.keys(r).forEach((i=>{n.setAttribute(i,r[i])})),n}static createPath(i={}){const s=document.createElementNS(je,"path");return Object.keys(i).forEach((r=>{s.setAttribute(r,i[r])})),s}static createPolygon(i,s={}){const r=document.createElementNS(je,"polygon");return r.setAttribute("points",i.join(",")),Object.keys(s).forEach((i=>{r.setAttribute(i,s[i])})),r}static createRect(i,s={}){const r=document.createElementNS(je,"rect");return r.setAttribute("x",i.x.toString()),r.setAttribute("y",i.y.toString()),r.setAttribute("width",i.width.toString()),r.setAttribute("height",i.height.toString()),Object.keys(s).forEach((i=>{r.setAttribute(i,s[i])})),r}static createTSpan(i,s={}){const r=document.createElementNS(je,"tspan");return r.textContent=i,Object.keys(s).forEach((i=>{r.setAttribute(i,s[i])})),r}static createForeignObject(i,s,r={}){const n=document.createElementNS(je,"foreignObject");return n.setAttribute("x",i.x.toString()),n.setAttribute("y",i.y.toString()),n.setAttribute("width",i.width.toString()),n.setAttribute("height",i.height.toString()),Object.keys(r).forEach((i=>{n.setAttribute(i,r[i])})),n.appendChild(s),n}static createText(i,s,r={}){const n=document.createElementNS(je,"text");return n.textContent=s,n.setAttribute("x",i.x.toString()),n.setAttribute("y",i.y.toString()),Object.keys(r).forEach((i=>{n.setAttribute(i,r[i])})),n}}class OISVGRendererEdgeUtil{static getLinePath(i){return`M ${i.start.x} ${i.start.y} L ${i.end.x} ${i.end.y}`}static getPolyLinePath(i){return`M ${i.vertices[0].x} ${i.vertices[0].y} ${i.vertices.map((i=>`L ${i.x} ${i.y}`)).join(" ")}`}static getArcPath(i){return`M ${i.vertices[0].x} ${i.vertices[0].y} Q ${i.vertices.map((i=>`${i.x} ${i.y}`)).join(" ")}`}static getSVGPath(i){switch(i.kind){case xe.Line:return OISVGRendererEdgeUtil.getLinePath(i);case xe.PolyEdge:return OISVGRendererEdgeUtil.getPolyLinePath(i);case xe.Arc:return OISVGRendererEdgeUtil.getArcPath(i);default:throw new Error(`Can't getSVGPath for edge cause kind is unknow: "${JSON.stringify(i)}"`)}}static getSVGElement(i){const s={id:i.id,type:i.type,kind:i.kind,"vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round"};i.selected&&(s.filter=`url(#${ze.selectionFilterId})`),i.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const r=SVGBuilder.createGroup(s),n={fill:"transparent",stroke:i.style.color||ae.color,"stroke-width":(i.style.width||ae.width).toString(),opacity:(i.style.opacity||ae.opacity).toString(),d:OISVGRendererEdgeUtil.getSVGPath(i)};return i.startDecoration===we.Arrow&&(n["marker-start"]=`url(#${ze.arrowHeadStartMarker})`),i.endDecoration===we.Arrow&&(n["marker-end"]=`url(#${ze.arrowHeadEndMaker})`),r.appendChild(SVGBuilder.createPath(n)),r}}class OISVGRendererEraserUtil{static getSVGPath(i){if(i.pointers.length<1)return"";const s=i.pointers.at(0);if(1===i.pointers.length){const r=i.style.width||4;return`C ${s.x-r/2} ${s.y} Q ${s.x+r/2} ${s.y}`}const r=i.pointers.slice(1);return`${`M ${s.x} ${s.y}`} ${r.reduce(((i,s)=>`${i} ${s.x} ${s.y}`),"Q")}`}static getSVGElement(i){const s={id:i.id,type:"eraser","stroke-width":"12",stroke:"grey",opacity:"0.2",shadowBlur:"5","stroke-linecap":"round",fill:"transparent",d:OISVGRendererEraserUtil.getSVGPath(i)};return SVGBuilder.createPath(s)}}class OISVGRendererDecoratorUtil{static getSVGElement(i,{deleting:s,style:r,bounds:n}){const a={id:i.id,type:"decorator",kind:i.kind,"vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round"};let l;switch(a.opacity=(i.style.opacity||ae.opacity).toString(),s&&(a.opacity=(.5*(i.style.opacity||ae.opacity)).toString()),i.kind){case oe.Highlight:{a.opacity=s?"0.25":"0.5",a.stroke="transparent",a.fill=i.style.color||ae.color;const d={x:n.x-+(r.width||ae.width),y:n.y-+(r.width||ae.width),height:n.height+2*+(r.width||ae.width),width:n.width+2*+(r.width||ae.width)};l=SVGBuilder.createRect(d,a);break}case oe.Surround:{a.fill="transparent",a.stroke=i.style.color||ae.color,a["stroke-width"]=(i.style.width||ae.width).toString();const s={x:n.x-+(r.width||ae.width),y:n.y-+(r.width||ae.width),height:n.height+2*+(r.width||ae.width),width:n.width+2*+(r.width||ae.width)};l=SVGBuilder.createRect(s,a);break}case oe.Strikethrough:{a.fill="transparent",a.stroke=i.style.color||ae.color,a["stroke-width"]=(i.style.width||ae.width).toString();const s={x:n.xMin,y:n.yMid},r={x:n.xMax,y:n.yMid};l=SVGBuilder.createLine(s,r,a);break}case oe.Underline:{a.fill="transparent",a.stroke=i.style.color||ae.color,a["stroke-width"]=(i.style.width||ae.width).toString();const s={x:n.xMin,y:n.yMax+ +(r.width||ae.width)},d={x:n.xMax,y:n.yMax+ +(r.width||ae.width)};l=SVGBuilder.createLine(s,d,a);break}}return l}}class OISVGRendererShapeUtil{static getPolygonePath(i){return`M ${i.points[0].x} ${i.points[0].y} ${i.points.slice(1).map((i=>`L ${i.x} ${i.y}`)).join(" ")} Z`}static getCirclePath(i){return`M ${i.center.x-i.radius} ${i.center.y} a ${i.radius} ${i.radius} 0 1 1 ${2*i.radius} 0 a ${i.radius} ${i.radius} 0 1 1 -${2*i.radius} 0 Z`}static getEllipsePath(i){return`M ${i.center.x-i.radiusX} ${i.center.y} a ${i.radiusX} ${i.radiusY} 0 1 1 ${2*i.radiusX} 0 a ${i.radiusX} ${i.radiusY} 0 1 1 -${2*i.radiusX} 0 Z`}static getSVGPath(i){switch(i.kind){case Se.Polygon:return OISVGRendererShapeUtil.getPolygonePath(i);case Se.Circle:return OISVGRendererShapeUtil.getCirclePath(i);case Se.Ellipse:return OISVGRendererShapeUtil.getEllipsePath(i);default:throw new Error(`Can't getSVGPath for shape cause kind is unknow: "${JSON.stringify(i)}"`)}}static getSVGElement(i){const s={id:i.id,type:i.type,kind:i.kind,"vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round"};i.selected&&(s.filter=`url(#${ze.selectionFilterId})`),i.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const r=SVGBuilder.createGroup(s),n={fill:i.style.fill||"transparent",stroke:i.style.color||ae.color,"stroke-width":(i.style.width||ae.width).toString(),opacity:(i.style.opacity||ae.opacity).toString(),d:OISVGRendererShapeUtil.getSVGPath(i)};return i.kind===Se.Ellipse&&(n.transform=`rotate(${convertRadianToDegree(i.orientation)}, ${i.center.x}, ${i.center.y})`),r.appendChild(SVGBuilder.createPath(n)),r}}class OISVGRendererStrokeUtil{static getArcPath(i,s){return[`M ${i.x} ${i.y}`,`m ${-s} 0`,`a ${s} ${s} 0 1 0 ${2*s} 0`,`a ${s} ${s} 0 1 0 ${-2*s} 0`].join(" ")}static getLinePath(i,s,r){const n=computeLinksPointers(i,computeAngleAxeRadian(i,s),r),a=computeLinksPointers(s,computeAngleAxeRadian(i,s),r);return[`M ${n[0].x} ${n[0].y}`,`L ${a[0].x} ${a[0].y}`,`L ${a[1].x} ${a[1].y}`,`L ${n[1].x} ${n[1].y}`].join(" ")}static getFinalPath(i,s,r){const n=computeAngleAxeRadian(i,s),a=computeLinksPointers(s,n,r),l=[`M ${a[0].x} ${a[0].y}`];for(let i=1;i<=6;i++){const a=n-i*(Math.PI/6),d=+(s.x-s.p*r*Math.sin(a)).toFixed(3),h=+(s.y+s.p*r*Math.cos(a)).toFixed(3);l.push(`L ${d} ${h}`)}return l.join(" ")}static getQuadraticPath(i,s,r,n){const a=computeLinksPointers(i,computeAngleAxeRadian(i,r),n),l=computeLinksPointers(s,computeAngleAxeRadian(r,s),n),d=computeLinksPointers(r,computeAngleAxeRadian(i,s),n);return[`M ${a[0].x} ${a[0].y}`,`Q ${d[0].x} ${d[0].y} ${l[0].x} ${l[0].y}`,`L ${l[1].x} ${l[1].y}`,`Q ${d[1].x} ${d[1].y} ${a[1].x} ${a[1].y}`].join(" ")}static getSVGPath(i){const s=i.pointers.length;if(!s)return"";const r=i.style.width,n=s-2,a=i.pointers[0],l=[];if(s<3)l.push(this.getArcPath(a,.6*r));else{l.push(this.getArcPath(a,r*a.p)),l.push(this.getLinePath(a,computeMiddlePointer(a,i.pointers[1]),r));for(let s=0;s<n;s++){const n=computeMiddlePointer(i.pointers[s],i.pointers[s+1]),a=computeMiddlePointer(i.pointers[s+1],i.pointers[s+2]),d=i.pointers[s+1];l.push(this.getQuadraticPath(n,a,d,r))}const d=i.pointers[s-2],h=i.pointers[s-1];l.push(this.getLinePath(computeMiddlePointer(d,h),h,r)),l.push(this.getFinalPath(d,h,r))}return l.join(" ")}static getSVGElement(i){const s={id:i.id,type:"stroke","vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round"};i.selected&&(s.filter=`url(#${ze.selectionFilterId})`),i.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const r=SVGBuilder.createGroup(s),n={fill:i.style.color||ae.color,"stroke-width":(i.style.width||ae.width).toString(),opacity:(i.style.opacity||ae.opacity).toString(),d:OISVGRendererStrokeUtil.getSVGPath(i)};return r.append(SVGBuilder.createPath(n)),i.decorators.forEach((s=>{const n=OISVGRendererDecoratorUtil.getSVGElement(s,i);n&&(s.kind===oe.Highlight?r.prepend(n):r.append(n))})),r}}class OISVGRendererTextUtil{static getSVGElement(i){const s={id:i.id,type:i.type,"vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round",style:ze.noSelection,opacity:(i.style.opacity||ae.opacity).toString()};i.rotation&&(s.transform=`rotate(${i.rotation.degree}, ${i.rotation.center.x}, ${i.rotation.center.y})`),i.selected&&(s.filter=`url(#${ze.selectionFilterId})`),i.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const r=SVGBuilder.createGroup(s),n=SVGBuilder.createText(i.point,"");return i.chars.forEach((i=>{const s={id:i.id,fill:i.color,"font-size":`${i.fontSize}px`,"font-weight":i.fontWeight.toString()};n.appendChild(SVGBuilder.createTSpan(i.label,s))})),r.append(n),i.decorators.forEach((s=>{const n=OISVGRendererDecoratorUtil.getSVGElement(s,i);n&&(s.kind===oe.Highlight?r.prepend(n):r.append(n))})),r}}class OISVGRendererGroupUtil{static getChildElement(i){let s;switch(i.type){case be.Stroke:s=OISVGRendererStrokeUtil.getSVGElement(i);break;case be.Shape:s=OISVGRendererShapeUtil.getSVGElement(i);break;case be.Edge:s=OISVGRendererEdgeUtil.getSVGElement(i);break;case be.Text:s=OISVGRendererTextUtil.getSVGElement(i);break;case be.Group:s=OISVGRendererGroupUtil.getSVGElement(i)}return s}static getSVGElement(i){const s={id:i.id,type:"group","vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round",fill:i.style.color||ae.color,"stroke-width":(i.style.width||ae.width).toString(),opacity:(i.style.opacity||ae.opacity).toString()};i.selected&&(s.filter=`url(#${ze.selectionFilterId})`),i.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const r=SVGBuilder.createGroup(s);return i.children.forEach((i=>{r.append(OISVGRendererGroupUtil.getChildElement(i))})),i.decorators.forEach((s=>{const n=OISVGRendererDecoratorUtil.getSVGElement(s,i);n&&(s.kind===oe.Highlight?r.prepend(n):r.append(n))})),r}}var Ve,He,Ue,We,Ye,Xe,qe,Je,Ze,Ke,Qe,et,tt,it,st,rt,nt,ot,at,lt,dt,ht,ct;class OISVGRenderer{constructor(i){Ve.set(this,LoggerManager.getLogger(d.RENDERER)),this.groupGuidesId="guides-wrapper",this.verticalGuides=[],this.horizontalGuides=[],__classPrivateFieldGet(this,Ve,"f").info("constructor",{configuration:i}),this.configuration=i}initLayer(){const i=Math.max(this.configuration.minWidth,this.parent.clientWidth),s=Math.max(this.configuration.minHeight,this.parent.clientHeight);this.layer=SVGBuilder.createLayer({x:0,y:0,width:i,height:s}),this.layer.style.setProperty("height","auto"),this.layer.style.setProperty("width","auto"),this.layer.appendChild(this.createSVGTools()),this.parent.style.setProperty("overflow","auto"),this.parent.appendChild(this.layer)}createDefs(){const i=SVGBuilder.createDefs(),s=4,r=2.5,n={style:ze.noSelection,fill:"context-stroke",markerWidth:5..toString(),markerHeight:5..toString(),refX:s.toString(),refY:r.toString()},a=SVGBuilder.createMarker(ze.arrowHeadStartMarker,Object.assign(Object.assign({},n),{orient:"auto-start-reverse"}));a.appendChild(SVGBuilder.createPolygon([0,0,5,r,0,5],n)),i.appendChild(a);const l=SVGBuilder.createMarker(ze.arrowHeadEndMaker,Object.assign(Object.assign({},n),{orient:"auto"}));l.appendChild(SVGBuilder.createPolygon([0,0,5,r,0,5],n)),i.appendChild(l);const d={style:ze.noSelection,markerWidth:"5",markerHeight:"5",refX:"0",refY:"0",viewBox:"-5 -5 10 10"},h=SVGBuilder.createMarker(ze.crossMarker,d);return h.appendChild(SVGBuilder.createPath({d:"M -4,-4 L 4,4 M -4,4 L 4,-4",stroke:"white","stroke-width":"3"})),h.appendChild(SVGBuilder.createPath({d:"M -4,-4 L 4,4 M -4,4 L 4,-4",stroke:"context-stroke","stroke-width":"2"})),i.appendChild(h),i}createFilters(){const i=SVGBuilder.createGroup({id:"definition-group"}),s=SVGBuilder.createFilter(ze.removalFilterId,{filterUnits:"userSpaceOnUse"}),r=SVGBuilder.createComponentTransfert(),n=SVGBuilder.createTransfertFunctionTable("feFuncA","0 0.25");r.appendChild(n),s.appendChild(r),i.appendChild(s);const a=SVGBuilder.createFilter(ze.selectionFilterId,{filterUnits:"userSpaceOnUse"});return a.appendChild(SVGBuilder.createDropShadow({dx:-1,dy:-1,deviation:1})),i.appendChild(a),i}drawGuides(){var i,s;this.verticalGuides=[],this.horizontalGuides=[];const n=Number(null===(i=this.layer.getAttribute("height"))||void 0===i?void 0:i.replace("px","")),a=Number(null===(s=this.layer.getAttribute("width"))||void 0===s?void 0:s.replace("px","")),l=this.configuration.guides.gap,d=this.configuration.guides.gap/5,h={id:this.groupGuidesId,stroke:"grey",opacity:"0.5",style:ze.noSelection,role:r.Guide},c=SVGBuilder.createGroup(h);switch(this.configuration.guides.type){case"line":for(let i=l;i<n;i+=l){const s={x:l,y:i},r={x:a-l,y:i};this.horizontalGuides.push(i);const n=SVGBuilder.createLine(s,r,{"stroke-width":"1",style:ze.noSelection});c.appendChild(n)}break;case"grid":for(let i=0;i<n;i+=l){const s={x:0,y:i},r={x:a,y:i},n=SVGBuilder.createLine(s,r,{"stroke-width":"1",style:ze.noSelection});c.appendChild(n),this.horizontalGuides.push(i);for(let s=i+d;s<i+l;s+=d){this.horizontalGuides.push(s);const i=SVGBuilder.createLine({x:0,y:s},{x:a,y:s},{"stroke-width":"0.25",style:ze.noSelection});c.appendChild(i)}}for(let i=0;i<a;i+=l){const s={x:i,y:0},r={x:i,y:n},a=SVGBuilder.createLine(s,r,{"stroke-width":"1",style:ze.noSelection});c.appendChild(a),this.verticalGuides.push(i);for(let s=i+d;s<i+l;s+=d){this.verticalGuides.push(s);const i=SVGBuilder.createLine({x:s,y:0},{x:s,y:n},{"stroke-width":"0.25",style:ze.noSelection});c.appendChild(i)}}break;case"point":for(let i=l;i<a;i+=l){this.verticalGuides.push(i);for(let s=l;s<n;s+=l){this.horizontalGuides.push(s);const r=SVGBuilder.createCircle({x:i,y:s},1);c.appendChild(r)}}break;default:__classPrivateFieldGet(this,Ve,"f").error("drawGuides",`Guide type unknow: ${this.configuration.guides.type}`)}this.horizontalGuides=[...new Set(this.horizontalGuides)],this.verticalGuides=[...new Set(this.verticalGuides)],this.definitionGroup.appendChild(c)}removeGuides(){var i;this.verticalGuides=[],this.horizontalGuides=[],null===(i=this.layer.querySelector(`#${this.groupGuidesId}`))||void 0===i||i.remove()}createSVGTools(){return this.definitionGroup=SVGBuilder.createGroup({id:"definition-group"}),this.definitionGroup.appendChild(this.createDefs()),this.definitionGroup.appendChild(this.createFilters()),this.configuration.guides.enable&&this.drawGuides(),this.definitionGroup}init(i){__classPrivateFieldGet(this,Ve,"f").info("init",{element:i}),this.parent=i,this.parent.oncontextmenu=()=>!1,this.initLayer()}getAttribute(i,s){const r=this.layer.querySelector(`#${i}`);return null==r?void 0:r.getAttribute(s)}setAttribute(i,s,r){const n=this.layer.querySelector(`#${i}`);null==n||n.setAttribute(s,r)}buildElementFromSymbol(i){let s;switch(i.type){case be.Stroke:s=OISVGRendererStrokeUtil.getSVGElement(i);break;case be.Eraser:s=OISVGRendererEraserUtil.getSVGElement(i);break;case be.Shape:s=OISVGRendererShapeUtil.getSVGElement(i);break;case be.Edge:s=OISVGRendererEdgeUtil.getSVGElement(i);break;case be.Text:s=OISVGRendererTextUtil.getSVGElement(i);break;case be.Group:s=OISVGRendererGroupUtil.getSVGElement(i);break;default:__classPrivateFieldGet(this,Ve,"f").error("buildElementFromSymbol",`symbol unknow: "${JSON.stringify(i)}"`)}return s}prependElement(i){this.layer.prepend(i)}changeOrderSymbol(i,s){var r,n;const a=this.layer.querySelector(`#${i.id}`);if(a)switch(s){case"first":this.definitionGroup.insertAdjacentElement("afterend",a);break;case"last":this.layer.insertAdjacentElement("beforeend",a);break;case"forward":null===(r=a.nextElementSibling)||void 0===r||r.insertAdjacentElement("afterend",a);break;case"backward":a.previousElementSibling!==this.definitionGroup&&(null===(n=a.previousElementSibling)||void 0===n||n.insertAdjacentElement("beforebegin",a))}}appendElement(i){this.layer.appendChild(i)}removeElement(i){__classPrivateFieldGet(this,Ve,"f").debug("Element",{id:i});const s=this.layer.querySelector(`#${i}`);s&&s.remove()}drawSymbol(i){__classPrivateFieldGet(this,Ve,"f").debug("drawSymbol",{symbol:i});const s=this.layer.querySelector(`#${null==i?void 0:i.id}`),r=this.buildElementFromSymbol(i);return r&&(s?s.replaceWith(r):this.layer.appendChild(r)),r}replaceSymbol(i,s){__classPrivateFieldGet(this,Ve,"f").debug("drawSymbol",{symbols:s});const r=this.layer.querySelector(`#${i}`),n=s.map((i=>this.buildElementFromSymbol(i))).filter((i=>!!i));return n.length&&(r?(n.forEach((i=>r.insertAdjacentElement("beforebegin",i))),r.remove()):n.forEach((i=>this.layer.appendChild(i)))),n}removeSymbol(i){__classPrivateFieldGet(this,Ve,"f").debug("removeSymbol",{id:i}),this.removeElement(i)}drawCircle(i,s,r={}){__classPrivateFieldGet(this,Ve,"f").info("drawCircle",{point:i,radius:s,attrs:r}),this.layer.appendChild(SVGBuilder.createCircle(i,s,r))}drawRect(i,s={}){__classPrivateFieldGet(this,Ve,"f").info("drawCircle",{box:i,attrs:s}),this.layer.appendChild(SVGBuilder.createRect(i,s))}drawLine(i,s,r={}){__classPrivateFieldGet(this,Ve,"f").info("drawLine",{p1:i,p2:s,attrs:r}),this.layer.appendChild(SVGBuilder.createLine(i,s,r))}drawConnectionBetweenBox(i,s,r,n){const a=new Box(s).corners,l=new Box(r).corners,{p1:d,p2:h}=getClosestPoints(a,l),c=Object.assign({id:i,fill:"transparent",style:ze.noSelection},n);this.drawLine(d,h,c)}resize(i,s){__classPrivateFieldGet(this,Ve,"f").info("resize",{height:i,width:s}),this.layer.setAttribute("width",`${s}px`),this.layer.setAttribute("height",`${i}px`),this.layer.setAttribute("viewBox",`0, 0, ${s}, ${i}`),this.removeGuides(),this.configuration.guides.enable&&this.drawGuides()}getElementById(i){return this.layer.querySelector(`#${i}`)}getElements({tagName:i,attrs:s}){__classPrivateFieldGet(this,Ve,"f").info("getElements",{tagName:i,attrs:s});let r=i||"*";return s&&Object.keys(s).forEach((i=>{r+=`[${i}=${s[i]}]`})),this.layer.querySelectorAll(r)}clearElements({tagName:i,attrs:s}){__classPrivateFieldGet(this,Ve,"f").info("clearElements",{tagName:i,attrs:s}),this.getElements({tagName:i,attrs:s}).forEach((i=>i.remove()))}clear(){if(__classPrivateFieldGet(this,Ve,"f").info("clear"),this.layer){for(;this.layer.firstChild;)this.layer.firstChild.remove();this.layer.appendChild(this.createSVGTools())}}destroy(){this.layer&&this.layer.remove()}}Ve=new WeakMap;class SVGStroker{getArcPath(i,s){return[`M ${i.x},${i.y}`,`m ${-s},0`,`a ${s},${s} 0 1 0 ${2*s},0`,`a ${s},${s} 0 1 0 ${-2*s},0`].join(" ")}getLinePath(i,s,r){const n=computeLinksPointers(i,computeAngleAxeRadian(i,s),r),a=computeLinksPointers(s,computeAngleAxeRadian(i,s),r);return[`M ${n[0].x},${n[0].y}`,`L ${a[0].x},${a[0].y}`,`L ${a[1].x},${a[1].y}`,`L ${n[1].x},${n[1].y}`].join(" ")}getFinalPath(i,s,r){const n=computeAngleAxeRadian(i,s),a=computeLinksPointers(s,n,r),l=[`M ${a[0].x},${a[0].y}`];for(let i=1;i<=6;i++){const a=n-i*(Math.PI/6);l.push(`L ${s.x-s.p*r*Math.sin(a)},${s.y+s.p*r*Math.cos(a)}`)}return l.join(" ")}getQuadraticPath(i,s,r,n){const a=computeLinksPointers(i,computeAngleAxeRadian(i,r),n),l=computeLinksPointers(s,computeAngleAxeRadian(r,s),n),d=computeLinksPointers(r,computeAngleAxeRadian(i,s),n);return[`M ${a[0].x},${a[0].y}`,`Q ${d[0].x},${d[0].y} ${l[0].x},${l[0].y}`,`L ${l[1].x},${l[1].y}`,`Q ${d[1].x},${d[1].y} ${a[1].x},${a[1].y}`].join(" ")}buildSVGPath(i){const s=i.pointers.length,r=i.style.width,n=s-2,a=i.pointers[0],l=[];if(s<3)l.push(this.getArcPath(a,.6*r));else{l.push(this.getArcPath(a,r*a.p)),l.push(this.getLinePath(a,computeMiddlePointer(a,i.pointers[1]),r));for(let s=0;s<n;s++){const n=computeMiddlePointer(i.pointers[s],i.pointers[s+1]),a=computeMiddlePointer(i.pointers[s+1],i.pointers[s+2]),d=i.pointers[s+1];l.push(this.getQuadraticPath(n,a,d,r))}const d=i.pointers[s-2],h=i.pointers[s-1];l.push(this.getLinePath(computeMiddlePointer(d,h),h,r)),l.push(this.getFinalPath(d,h,r))}return l.join(" ")}drawStroke(i,s,r){const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.classList.add("pending-stroke"),n.setAttribute("id",s.id),n.setAttribute("type",s.pointerType),null==r||r.forEach((i=>{n.setAttribute(i.name,i.value)}));const a=this.buildSVGPath(s);n.setAttribute("d",`${a}Z`),i.appendChild(n)}}class WSSVGRenderer{constructor(i){He.set(this,LoggerManager.getLogger(d.RENDERER)),__classPrivateFieldGet(this,He,"f").info("constructor",{config:i}),this.config=i,this.stroker=new SVGStroker}init(i){__classPrivateFieldGet(this,He,"f").info("init",{element:i}),i.style.fontSize="10px",this.context={parent:i}}drawStroke(i,s){let r;"eraser"===s.pointerType?(s.style.width=12,r="fill:grey;stroke:transparent;shadowBlur:5;opacity:0.2;"):r=`fill:${s.style.color};stroke:transparent;`,this.stroker.drawStroke(i,s,[{name:"style",value:r}])}replaceAll(i,s){const r=this.context.parent.querySelector(`svg[data-layer="${i}"]`);null==r||r.remove(),this.context.parent.insertAdjacentHTML("beforeend",s.svg);const n=this.context.parent.querySelector(`svg[data-layer="${i}"]`);if("MODEL"===i){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.id="pendingStrokes",n.appendChild(i)}}replaceElement(i){const s=this.context.parent.querySelector(`#${i.id}`);if(s){const r=s.parentNode;null==s||s.remove(),null==r||r.insertAdjacentHTML("beforeend",i.svg)}}appendChild(i,s){const r=s.parentId?`#${s.parentId}`:`svg[data-layer="${i}"]`,n=this.context.parent.querySelector(r);null==n||n.insertAdjacentHTML("beforeend",s.svg)}removeChild(i){var s;null===(s=this.context.parent.querySelector(`#${i.parentId} > *:nth-child(${i.index+1})`))||void 0===s||s.remove()}removeElement(i){const s=this.context.parent.querySelector(`#${i.id}`);s&&(i.id.includes("s")||i.id.includes("MODEL")?s.remove():(s.setAttribute("class","removed-stroke"),setTimeout((()=>{null==s||s.remove()}),100)))}insertBefore(i){const s=this.context.parent.querySelector(`#${i.refId}`);null==s||s.insertAdjacentHTML("beforebegin",i.svg)}setAttribute(i){const s=i.id?`#${i.id}`:"svg",r=this.context.parent.querySelector(s);null==r||r.setAttribute(i.name,i.value)}removeAttribute(i){const s=i.id?`#${i.id}`:"svg",r=this.context.parent.querySelector(s);null==r||r.removeAttribute(i.name)}updateLayer(i,s){switch(__classPrivateFieldGet(this,He,"f").info("updateLayer",{layerName:i,update:s}),s.type){case"REPLACE_ALL":this.replaceAll(i,s);break;case"REPLACE_ELEMENT":this.replaceElement(s);break;case"APPEND_CHILD":this.appendChild(i,s);break;case"REMOVE_ELEMENT":this.removeElement(s);break;case"REMOVE_CHILD":this.removeChild(s);break;case"INSERT_BEFORE":this.insertBefore(s);break;case"SET_ATTRIBUTE":this.setAttribute(s);break;case"REMOVE_ATTRIBUTE":this.removeAttribute(s);break;default:__classPrivateFieldGet(this,He,"f").warn("updateLayer",`update.type unknow ${s.type}`)}}updatesLayer(i,s){__classPrivateFieldGet(this,He,"f").info("updatesLayer",{layerName:i,updates:s}),s.forEach((s=>this.updateLayer(i,s))),this.clearPendingStroke()}clearPendingStroke(){__classPrivateFieldGet(this,He,"f").info("clearPendingStroke");const i=this.context.parent.querySelector("#pendingStrokes");i&&(i.innerHTML="")}drawPendingStroke(i){if(__classPrivateFieldGet(this,He,"f").info("drawPendingStroke",{stroke:i}),i){const s=this.context.parent.querySelector("#pendingStrokes");if(s){const r=s.querySelector(`#${null==i?void 0:i.id}`);r&&r.remove(),this.drawStroke(s,i)}}}clearErasingStrokes(){this.context.parent.querySelectorAll("[type=eraser]").forEach((i=>{i.remove()}))}resize(i){__classPrivateFieldGet(this,He,"f").info("resize",{model:i});const s=this.context.parent.getBoundingClientRect(),r=this.context.parent.querySelectorAll("svg"),n=Math.max(s.width,i.width),a=Math.max(s.height,i.height);r.forEach((i=>{i.setAttribute("viewBox",`0 0 ${n}, ${a}`),i.setAttribute("width",`${n}px`),i.setAttribute("height",`${a}px`)}))}destroy(){var i;__classPrivateFieldGet(this,He,"f").info("destroy",{context:this.context}),(null===(i=this.context)||void 0===i?void 0:i.parent)&&this.context.parent.querySelectorAll("svg").forEach((i=>i.remove()))}}He=new WeakMap;class OIConversionManager{constructor(i,s){Ue.set(this,LoggerManager.getLogger(d.CONVERTER)),__classPrivateFieldGet(this,Ue,"f").info("constructor"),this.behaviors=i,this.fontSize=null==s?void 0:s.size,this.fontWeight=null==s?void 0:s.weight}get model(){return this.behaviors.model}get rowHeight(){return this.behaviors.configuration.rendering.guides.gap}computeFontSize(i){if(i.some((i=>i["bounding-box"]))){const s=convertMillimeterToPixel(computeAverage(i.map((i=>{var s;return(null===(s=i["bounding-box"])||void 0===s?void 0:s.height)||1}))));return 2*Math.round(Math.round(s*this.rowHeight)/this.rowHeight/2)}return Math.round(this.rowHeight/2)}buildChar(i,s,r){const n=i.grid.map((i=>({x:convertMillimeterToPixel(i.x),y:convertMillimeterToPixel(i.y)})));let a=this.fontWeight;a||(a=(s[0].style.width||1)>2?"bold":"normal");const l=s[0].style.color||"black";return{id:`text-char-${createUUID()}`,label:i.label,color:l,fontSize:r,fontWeight:a,bounds:Box.createFromPoints(n)}}buildWord(i,s,r,n){const a=Box.createFromBoxes([convertBoundingBoxMillimeterToPixel(i["bounding-box"])]),l=[];n=n||this.computeFontSize(s),s.forEach((i=>{const s=r.filter((s=>{var r;return null===(r=i.items)||void 0===r?void 0:r.some((i=>i["full-id"]===s.id))}));s.length&&l.push(this.buildChar(i,s,n))}));const d={x:a.xMin,y:a.yMax},h=new OIText(l,d,a,r[0].style),c=r.flatMap((i=>i.decorators));if(r.forEach((i=>{const s=this.model.getRootSymbol(i.id);if((null==s?void 0:s.type)===be.Group){const i=s,r=i.decorators.find((i=>i.kind===oe.Highlight));r&&c.push(r);const n=i.decorators.find((i=>i.kind===oe.Strikethrough));n&&c.push(n);const a=i.decorators.find((i=>i.kind===oe.Surround));a&&c.push(a);const l=i.decorators.find((i=>i.kind===oe.Underline));l&&c.push(l)}})),c.length){const i=c.find((i=>i.kind===oe.Highlight));i&&h.decorators.push(new OIDecorator(oe.Highlight,i.style));const s=c.find((i=>i.kind===oe.Strikethrough));s&&h.decorators.push(new OIDecorator(oe.Strikethrough,s.style));const r=c.find((i=>i.kind===oe.Surround));r&&h.decorators.push(new OIDecorator(oe.Surround,r.style));const n=c.find((i=>i.kind===oe.Underline));n&&h.decorators.push(new OIDecorator(oe.Underline,n.style))}return h}convertText(i,s,r){var n;if(!i.words)throw new Error("You need to active configuration.recognition.export.jiix.text.words = true");if(!i.chars)throw new Error("You need to active configuration.recognition.export.jiix.text.chars = true");if(!i.chars.some((i=>i.items)))throw new Error("You need to active configuration.recognition.export.jiix.strokes = true");const a=i.words,l=i.chars,d=[],h=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);let c=this.fontSize;r&&!c&&(c=2*Math.round(this.computeFontSize(l.filter((i=>{var s;return null===(s=i.items)||void 0===s?void 0:s.length})))/2));let u=!1,p=h.y+this.rowHeight,m=convertMillimeterToPixel((null===(n=a[0]["bounding-box"])||void 0===n?void 0:n.x)||0);return a.forEach((i=>{var n;if(" "===i.label)return void(m+=this.behaviors.texter.getSpaceWidth((null===(n=d.at(-1))||void 0===n?void 0:n.symbol.chars[0].fontSize)||this.rowHeight/2));const a=s.filter((s=>{var r;return null===(r=i.items)||void 0===r?void 0:r.some((i=>i["full-id"]===s.id))}));if(a.length){const s=l.slice(i["first-char"],(i["last-char"]||0)+1),n=this.buildWord(i,s,a,c);if(r){if(u){u=!1;const i=Math.round((n.point.y-p)/this.rowHeight)||1;p+=i*this.rowHeight,Math.abs(n.point.x-h.x)<2*this.behaviors.texter.getSpaceWidth(c)&&(m=h.x)}n.point.x=m,n.point.y=this.model.roundToLineGuide(p)}this.behaviors.texter.setBounds(n),m+=n.bounds.width,d.push({symbol:n,strokes:a})}u="\n"===i.label})),d}buildCircle(i,s){var r;const n={x:convertMillimeterToPixel(i.cx),y:convertMillimeterToPixel(i.cy)};return new OIShapeCircle(n,convertMillimeterToPixel(i.r),null===(r=s[0])||void 0===r?void 0:r.style)}buildEllipse(i,s){var r;const n={x:convertMillimeterToPixel(i.cx),y:convertMillimeterToPixel(i.cy)};return new OIShapeEllipse(n,convertMillimeterToPixel(i.rx),convertMillimeterToPixel(i.ry),i.orientation,null===(r=s[0])||void 0===r?void 0:r.style)}buildRectangle(i,s){var r;const n=convertMillimeterToPixel(i.height),a=convertMillimeterToPixel(i.width),l=convertMillimeterToPixel(i.x),d=convertMillimeterToPixel(i.y);return new OIShapePolygon([{x:l,y:d},{x:l+a,y:d},{x:l+a,y:d+n},{x:l,y:d+n}],null===(r=s[0])||void 0===r?void 0:r.style)}buildPolygon(i,s){var r;const n=[];for(let s=0;s<i.points.length;s+=2)n.push({x:convertMillimeterToPixel(i.points[s]),y:convertMillimeterToPixel(i.points[s+1])});return new OIShapePolygon(n,null===(r=s[0])||void 0===r?void 0:r.style)}buildRhombus(i,s){var r;const n=[];for(let s=0;s<i.points.length;s+=2)n.push({x:convertMillimeterToPixel(i.points[s]),y:convertMillimeterToPixel(i.points[s+1])});return new OIShapePolygon(n,null===(r=s[0])||void 0===r?void 0:r.style)}buildTriangle(i,s){var r;const n=[];for(let s=0;s<i.points.length;s+=2)n.push({x:convertMillimeterToPixel(i.points[s]),y:convertMillimeterToPixel(i.points[s+1])});return new OIShapePolygon(n,null===(r=s[0])||void 0===r?void 0:r.style)}buildParallelogram(i,s){var r;const n=[];for(let s=0;s<i.points.length;s+=2)n.push({x:convertMillimeterToPixel(i.points[s]),y:convertMillimeterToPixel(i.points[s+1])});return new OIShapePolygon(n,null===(r=s[0])||void 0===r?void 0:r.style)}convertNode(i,s){const r=s.filter((s=>{var r;return null===(r=i.items)||void 0===r?void 0:r.some((i=>i["full-id"]===s.id))}));if(!r.length)return;const n=r.filter(((i,s)=>r.findIndex((s=>i.id===s.id))===s));let a;switch(i.kind){case re.Circle:a=this.buildCircle(i,n);break;case re.Ellipse:a=this.buildEllipse(i,n);break;case re.Rectangle:a=this.buildRectangle(i,n);break;case re.Triangle:a=this.buildTriangle(i,n);break;case re.Parallelogram:a=this.buildParallelogram(i,n);break;case re.Polygon:a=this.buildPolygon(i,n);break;case re.Rhombus:a=this.buildRhombus(i,n);break;default:return void __classPrivateFieldGet(this,Ue,"f").warn("convertNode",`Conversion of Node with kind equal to ${JSON.stringify(i)} is unknow`)}return{symbol:a,strokes:n}}buildLine(i,s){var r;const n={x:convertMillimeterToPixel(i.x1),y:convertMillimeterToPixel(i.y1)},a={x:convertMillimeterToPixel(i.x2),y:convertMillimeterToPixel(i.y2)},l=computeAngleAxeRadian(n,a);return Math.abs(l%Math.PI)<.1?(n.y=+((n.y+a.y)/2).toFixed(3),a.y=n.y):Math.abs(l%(Math.PI/2))<.1&&(n.x=+((n.x+a.x)/2).toFixed(3),a.x=n.x),new OIEdgeLine(n,a,i.p1Decoration,i.p2Decoration,null===(r=s[0])||void 0===r?void 0:r.style)}buildPolyEdge(i,s){var r;const n={x:convertMillimeterToPixel(i.edges[0].x1),y:convertMillimeterToPixel(i.edges[0].y1)},a=i.edges.map((i=>({x:convertMillimeterToPixel(i.x2),y:convertMillimeterToPixel(i.y2)})));a.unshift(n);for(let i=0;i<a.length-1;i++){const s=a[i],r=a[i+1],n=computeAngleAxeRadian(s,r);Math.abs(n%Math.PI)<.1?(s.y=+((s.y+r.y)/2).toFixed(3),r.y=s.y):Math.abs(n%(Math.PI/2))<.1&&(s.x=+((s.x+r.x)/2).toFixed(3),r.x=s.x)}return new OIEdgePolyLine(a,i.edges[0].p1Decoration,i.edges.at(-1).p2Decoration,null===(r=s[0])||void 0===r?void 0:r.style)}buildArc(i,s){var r;const n={x:convertMillimeterToPixel(i.cx),y:convertMillimeterToPixel(i.cy)},a=convertMillimeterToPixel(i.rx),l=convertMillimeterToPixel(i.ry);return new OIEdgeArc(n,i.startAngle,i.sweepAngle,a,l,i.phi,i.startDecoration,i.endDecoration,null===(r=s[0])||void 0===r?void 0:r.style)}convertEdge(i,s){switch(i.kind){case ne.Line:{const r=s.filter((s=>{var r;return null===(r=i.items)||void 0===r?void 0:r.some((i=>i["full-id"]===s.id))}));if(!r.length)return;const n=r.filter(((i,s)=>r.findIndex((s=>i.id===s.id))===s));return{symbol:this.buildLine(i,n),strokes:n}}case ne.Arc:{const r=s.filter((s=>{var r;return null===(r=i.items)||void 0===r?void 0:r.some((i=>i["full-id"]===s.id))}));if(!r.length)return;const n=r.filter(((i,s)=>r.findIndex((s=>i.id===s.id))===s));return{symbol:this.buildArc(i,n),strokes:n}}case ne.PolyEdge:{const r=s.filter((s=>{var r;return null===(r=i.edges.flatMap((i=>i.items)))||void 0===r?void 0:r.some((i=>i["full-id"]===s.id))}));if(!r.length)return;const n=r.filter(((i,s)=>r.findIndex((s=>i.id===s.id))===s));return{symbol:this.buildPolyEdge(i,n),strokes:n}}default:return void __classPrivateFieldGet(this,Ue,"f").error("convertEdge",`Conversion of Edge with kind equal to ${JSON.stringify(i)} is unknow`)}}apply(i=[]){var s,r,n,a;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ue,"f").info("convert"),(null===(s=this.model.exports)||void 0===s?void 0:s["application/vnd.myscript.jiix"])||(yield this.behaviors.export(["application/vnd.myscript.jiix"])),this.behaviors.selector.removeSelectedGroup();const l=null===(r=this.model.exports)||void 0===r?void 0:r["application/vnd.myscript.jiix"];if(null===(n=null==l?void 0:l.elements)||void 0===n?void 0:n.length){const s=this.behaviors.extractStrokesFromSymbols(i.length?i:this.model.symbols),r=!(null===(a=l.elements)||void 0===a?void 0:a.some((i=>"Text"!==i.type))),n=[];l.elements.forEach((i=>{switch(i.type){case"Text":{const a=this.convertText(i,s,r);a&&n.push(...a);break}case"Node":{const r=this.convertNode(i,s);r&&n.push(r);break}case"Edge":{const r=this.convertEdge(i,s);r&&n.push(r);break}default:__classPrivateFieldGet(this,Ue,"f").warn("buildConversions",`Unknow jiix element type: ${i.type}`)}})),this.behaviors.addSymbols(n.map((i=>i.symbol)),!1),this.behaviors.removeSymbols(n.flatMap((i=>i.strokes.map((i=>i.id)))),!1),this.behaviors.history.push(this.model,{added:n.map((i=>i.symbol)),erased:n.flatMap((i=>i.strokes))})}}))}}Ue=new WeakMap,function(i){i.Select="select",i.Surround="surround",i.Highlight="highlight"}(We||(We={})),function(i){i.Erase="erase",i.Draw="draw"}(Ye||(Ye={})),function(i){i.LineBreak="line-break",i.Insert="insert"}(Xe||(Xe={}));class OIGestureManager{constructor(i,s){qe.set(this,LoggerManager.getLogger(d.GESTURE)),this.insertAction=Xe.LineBreak,this.surroundAction=We.Select,this.strikeThroughAction=Ye.Draw,__classPrivateFieldGet(this,qe,"f").info("constructor"),this.behaviors=i,this.surroundAction=(null==s?void 0:s.surround)||We.Select,this.strikeThroughAction=(null==s?void 0:s.strikeThrough)||Ye.Draw,this.insertAction=(null==s?void 0:s.insert)||Xe.LineBreak}get renderer(){return this.behaviors.renderer}get recognizer(){return this.behaviors.recognizer}get translator(){return this.behaviors.translator}get texter(){return this.behaviors.texter}get model(){return this.behaviors.model}get history(){return this.behaviors.history}get currentStyle(){return this.behaviors.styler.currentPenStyle}get rowHeight(){return this.behaviors.configuration.rendering.guides.gap}get strokeSpaceWidth(){return this.behaviors.configuration.rendering.guides.gap/2}applySurroundGesture(s,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,qe,"f").info("applySurroundGesture",{gestureStroke:s,gesture:r});const n={},a=this.model.symbols.filter((i=>s.bounds.contains(i.bounds))).map((i=>i.id));switch(this.surroundAction){case We.Select:a.length&&(this.behaviors.internalEvent.emitIntention(i.Select),this.behaviors.select(a));break;case We.Highlight:{const i=[];n.decorator=[],a.forEach((s=>{const r=this.model.getRootSymbol(s);if(r&&[be.Group,be.Stroke,be.Text].includes(r.type)&&!i.includes(r.id)){const s=r,a=new OIDecorator(oe.Highlight,this.currentStyle),l=s.decorators.findIndex((i=>i.kind===oe.Highlight)),d=-1===l;d?s.decorators.push(a):s.decorators.splice(l,1),this.model.updateSymbol(s),this.renderer.drawSymbol(s),i.push(s.id),n.decorator.push({symbol:s,decorator:a,added:d})}})),n.decorator.length&&this.history.push(this.model,n);break}case We.Surround:{const i=[];n.decorator=[],a.forEach((s=>{const r=this.model.getRootSymbol(s);if(r&&[be.Group,be.Stroke,be.Text].includes(r.type)&&!i.includes(r.id)){const s=r,a=new OIDecorator(oe.Surround,this.currentStyle),l=s.decorators.findIndex((i=>i.kind===oe.Surround)),d=-1===l;d?s.decorators.push(a):s.decorators.splice(l,1),this.model.updateSymbol(s),this.renderer.drawSymbol(s),n.decorator.push({symbol:s,decorator:a,added:d}),i.push(s.id)}})),this.history.push(this.model,n);break}default:__classPrivateFieldGet(this,qe,"f").error("applySurroundGesture",`Unknow surroundAction: ${this.surroundAction}, values allowed are: ${We.Highlight}, ${We.Select}, ${We.Surround}`)}}))}computeScratchOnStrokes(i,s){var r;const n=[],a=null===(r=i.subStrokes)||void 0===r?void 0:r.find((i=>i.fullStrokeId===s.id));if(a){const i=new OIStroke;a.x.forEach(((s,r)=>i.addPointer({x:s,y:a.y[r],p:1,t:1})));const r=OIStroke.substract(s,i);r.before&&n.push(r.before),r.after&&n.push(r.after)}return n}computeScratchOnText(i,s){const r=s.getCharsOverlaps(i.pointers);return s.chars.length==r.length?void 0:(r.forEach((i=>{const r=s.chars.findIndex((s=>s.id===i.id));s.chars.splice(r,1)})),this.texter.updateBounds(s),s)}computeScratchOnSymbol(i,s,r){switch(r.type){case be.Stroke:{const i=this.computeScratchOnStrokes(s,r);return i.length?{replaced:i}:{erased:!0}}case be.Group:{const n=r.extractSymbols().filter((s=>!i.bounds.overlaps(s.bounds))),a=r.extractSymbols().filter((s=>i.bounds.overlaps(s.bounds))).map((r=>({symbol:r,result:this.computeScratchOnSymbol(i,s,r)})));if(0===n.length&&a.every((i=>i.result.erased)))return{erased:!0};{const i=n;a.forEach((s=>{s.result.replaced&&i.push(...s.result.replaced)}));const s=new OISymbolGroup(i,r.style);return s.decorators=r.decorators,{replaced:[s]}}}case be.Text:{const s=this.computeScratchOnText(i,r);return s?{replaced:[s]}:{erased:!0}}case be.Shape:case be.Edge:return{erased:!0}}}applyScratch(i,s){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,qe,"f").debug("applyScratchGesture",{gestureStroke:i,gesture:s}),!s.strokeIds.length)return void __classPrivateFieldGet(this,qe,"f").warn("applyScratchGesture","Unable to apply underline because there are no strokes");const r=[],n=[],a={oldSymbols:[],newSymbols:[]};s.strokeIds.forEach((r=>{const l=this.model.getRootSymbol(r);if(l&&!n.some((i=>i.id===l.id))&&!a.oldSymbols.some((i=>i.id===l.id))){const r=this.computeScratchOnSymbol(i,s,l);r.erased?n.push(l):r.replaced&&(a.newSymbols.push(...r.replaced),a.oldSymbols.push(l))}}));const l=[],d={};r.length&&(l.push(this.behaviors.updateSymbols(r,!1)),d.updated=r),n.length&&(l.push(this.behaviors.removeSymbols(n.map((i=>i.id)),!1)),d.erased=n),a.newSymbols.length&&(d.replaced=a,l.push(this.behaviors.replaceSymbols(a.oldSymbols,a.newSymbols,!1))),this.history.push(this.model,d),yield Promise.all(l)}))}applyJoinGesture(i,s){var r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,qe,"f").debug("applyJoinGesture",{gestureStroke:i,gesture:s});const n=this.model.symbols.filter((s=>this.model.isSymbolAbove(i,s))),a=this.model.symbols.filter((s=>i.id!==s.id&&this.model.isSymbolInRow(i,s))),l=a.filter((s=>s.bounds.xMax<=i.bounds.xMid)),d=a.filter((s=>s.bounds.xMax>i.bounds.xMid&&s.bounds.xMin<=i.bounds.xMid)),h=a.filter((s=>s.bounds.xMin>i.bounds.xMid)),c=this.model.symbols.filter((s=>this.model.isSymbolBelow(i,s))),u={},p=[];if(d.length){const s=d[0];if((null==s?void 0:s.type)===be.Group){const r=s.extractSymbols().map((i=>i.clone())),n=r.filter((s=>s.bounds.xMid<=i.bounds.xMid)),a=r.filter((s=>s.bounds.xMid>i.bounds.xMid));if(n.length&&a.length){const i=Math.max(...n.map((i=>i.bounds.xMax)))-Math.min(...a.map((i=>i.bounds.xMin)));a.forEach((s=>this.translator.applyToSymbol(s,i,0)));const l=new OISymbolGroup(r,s.style);l.decorators=s.decorators.map((i=>i.clone())),u.replaced={oldSymbols:[s],newSymbols:[l]},h.length&&p.push({symbols:h,tx:i,ty:0});const d=c.filter((i=>this.model.isSymbolBelow(s,i)));d.length&&p.push({symbols:d,tx:0,ty:-this.rowHeight})}else if(h.length){const i=s.bounds.xMax-Math.min(...h.map((i=>i.bounds.xMin)));p.push({symbols:h,tx:i,ty:0})}}}else if(l.length&&h.length){const i=this.model.getLastSymbol(l),s=this.model.getFirstSymbol(h),r=Math.max(...l.map((i=>i.bounds.xMax)))-Math.min(...h.map((i=>i.bounds.xMin))),n=i.clone(),a=s.clone();this.translator.applyToSymbol(a,r,0);const d=i.type===be.Group?n.extractSymbols():[n];if(d.push(...a.type===be.Group?a.extractSymbols():[a]),d.every((i=>i.type===be.Text))){const r=d,n=new OIText(r.flatMap((i=>i.chars)),r[0].point,Box.createFromBoxes(r.map((i=>i.bounds))));this.texter.setBounds(n),u.replaced={oldSymbols:[i,s],newSymbols:[n]}}else{const r=new OISymbolGroup(d,i.style);[be.Group,be.Stroke,be.Text].includes(i.type)&&i.decorators.forEach((i=>{r.decorators.push(new OIDecorator(i.kind,i.style))})),[be.Group,be.Stroke,be.Text].includes(s.type)&&s.decorators.forEach((i=>{r.decorators.some((s=>s.kind==i.kind))||r.decorators.push(new OIDecorator(i.kind,i.style))})),u.replaced={oldSymbols:[i,s],newSymbols:[r]}}const c=h.filter((i=>i.id!==s.id));c.length&&p.push({symbols:c,tx:r,ty:0})}else if(l.length){const i=this.model.getLastSymbol(l),s=this.model.getFirstSymbol(c);if(s){if(this.model.roundToLineGuide(i.bounds.yMid)>=this.model.roundToLineGuide(s.bounds.yMid-this.rowHeight)){const r=c.filter((i=>this.model.isSymbolInRow(s,i)));if(r.length){const n=i.bounds.xMax+this.strokeSpaceWidth-s.bounds.xMin;p.push({symbols:r,tx:n,ty:-this.rowHeight})}const n=c.filter((i=>this.model.isSymbolBelow(s,i)));n.length&&p.push({symbols:n,tx:0,ty:-this.rowHeight})}}else p.push({symbols:c,tx:0,ty:-this.rowHeight})}else if(h.length){const i=this.model.getFirstSymbol(h),s=this.model.getLastSymbol(n);if(s){if(this.model.roundToLineGuide(s.bounds.yMid)>=this.model.roundToLineGuide(i.bounds.yMid-this.rowHeight)){const r=s.bounds.xMax+this.strokeSpaceWidth-i.bounds.xMin;p.push({symbols:h,tx:r,ty:-this.rowHeight})}else p.push({symbols:h,tx:0,ty:-this.rowHeight});c.length&&p.push({symbols:c,tx:0,ty:-this.rowHeight})}else p.push({symbols:h.concat(...c),tx:0,ty:-this.rowHeight})}(null===(r=u.replaced)||void 0===r?void 0:r.oldSymbols.length)&&this.behaviors.replaceSymbols(u.replaced.oldSymbols,u.replaced.newSymbols,!1),p.length&&(u.translate=p,Promise.all(p.map((i=>this.translator.translate(i.symbols,i.tx,i.ty,!1))))),this.history.push(this.model,u)}))}createStrokesFromGestureSubStroke(i,s){const r=[];if(s[0]){const n=new OIStroke(i.style);s[0].x.forEach(((r,a)=>{var l,d;n.pointers.push({x:r,y:s[0].y[a],p:(null===(l=i.pointers.at(a))||void 0===l?void 0:l.p)||1,t:(null===(d=i.pointers.at(a))||void 0===d?void 0:d.t)||Math.max(...n.pointers.map((i=>i.t+20)))})})),r.push(n)}if(s[1]){const n=new OIStroke(i.style);s[1].x.forEach(((r,a)=>{var l,d;n.pointers.push({x:r,y:s[1].y[a],p:(null===(l=i.pointers.at(n.pointers.length+a))||void 0===l?void 0:l.p)||1,t:(null===(d=i.pointers.at(n.pointers.length+a))||void 0===d?void 0:d.t)||Math.max(...n.pointers.map((i=>i.t+20)))})})),r.push(n)}return r}computeSplitStroke(i,s){let r;const n=this.createStrokesFromGestureSubStroke(i,s);return n[1]&&(r=n[1],this.translator.applyToSymbol(r,this.strokeSpaceWidth,0)),{before:n[0],after:r}}computeSplitStrokeInGroup(i,s,r){const n=[],a=s.extractSymbols(),l=[],d=[],h=r[0].fullStrokeId;return a.forEach((s=>{if(s.id===h){const i=this.computeSplitStroke(s,r);i.before&&l.push(i.before),i.after&&d.push(i.after)}else s.bounds.xMid<i.bounds.xMid?l.push(s):s.bounds.xMid>i.bounds.xMid&&(this.translator.applyToSymbol(s,this.strokeSpaceWidth,0),d.push(s))})),l.length&&n.push(new OISymbolGroup(l,s.style)),d.length&&n.push(new OISymbolGroup(d,s.style)),n}computeChangesOnSplitStroke(i,s,r){const n=[],a={oldSymbols:[],newSymbols:[]},l=this.model.symbols.filter((s=>i.id!==s.id&&this.model.isSymbolInRow(i,s)&&i.bounds.xMid<s.bounds.xMin)),d=this.model.getRootSymbol(s);if((null==d?void 0:d.type)===be.Group){const s=this.computeSplitStrokeInGroup(i,d,r);a.newSymbols.push(...s),a.oldSymbols.push(d)}else if((null==d?void 0:d.type)===be.Stroke){const i=this.computeSplitStroke(d,r);i.before&&a.newSymbols.push(i.before),i.after&&a.newSymbols.push(i.after),a.oldSymbols.push(d)}return l.length&&n.push({symbols:l,tx:this.strokeSpaceWidth,ty:0}),{translate:n,replaced:a}}computeChangesOnSplitGroup(i,s){const r=[],n={oldSymbols:[],newSymbols:[]},a=this.model.symbols.filter((s=>i.id!==s.id&&this.model.isSymbolInRow(i,s)&&i.bounds.xMid<s.bounds.xMin)),l=s.children.filter((s=>s.bounds.xMid<=i.bounds.xMid)),d=s.children.filter((s=>s.bounds.xMid>i.bounds.xMid));if(n.oldSymbols.push(s),l.length){const i=new OISymbolGroup(l.map((i=>i.clone())),s.style);i.decorators=s.decorators.map((i=>new OIDecorator(i.kind,i.style))),n.newSymbols.push(i)}if(d.length){const i=new OISymbolGroup(d.map((i=>i.clone())),s.style);i.decorators=s.decorators.map((i=>new OIDecorator(i.kind,i.style))),this.translator.applyToSymbol(i,this.strokeSpaceWidth,0),n.newSymbols.push(i)}return(null==a?void 0:a.length)&&r.push({symbols:a.filter((i=>i.id!==s.id)),tx:this.strokeSpaceWidth,ty:0}),{translate:r,replaced:n}}computeChangesOnSplitText(i,s){const r=[],n={oldSymbols:[],newSymbols:[]},a=this.model.symbols.filter((s=>i.id!==s.id&&this.model.isSymbolInRow(i,s)&&i.bounds.xMid<s.bounds.xMin)),l=s.chars.filter((s=>s.bounds.x+s.bounds.width/2<=i.bounds.xMid)),d=s.chars.filter((s=>s.bounds.x+s.bounds.width/2>i.bounds.xMid)),h=[];if(l.length&&d.length){const i=new OIText(l,s.point,Box.createFromBoxes(l.map((i=>i.bounds))));this.texter.setBounds(i),h.push(i);const r={x:i.point.x+i.bounds.width+this.texter.getSpaceWidth(computeAverage(i.chars.map((i=>i.fontSize)))),y:i.point.y},a=new OIText(d,r,Box.createFromBoxes(d.map((i=>i.bounds))));this.texter.setBounds(a),h.push(a),n.newSymbols=h,n.oldSymbols=[s]}return(null==a?void 0:a.length)&&r.push({symbols:a.filter((s=>s.id!==i.id)),tx:this.strokeSpaceWidth,ty:0}),{translate:r,replaced:n}}applyInsertGesture(i,s){var r,n,a;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,qe,"f").debug("applyInsertGesture",{gestureStroke:i,gesture:s});const l=this.model.symbols.filter((s=>i.id!==s.id&&this.model.isSymbolInRow(i,s))),d=l.find((s=>s.type===be.Text&&isBetween(i.bounds.xMid,s.bounds.xMin,s.bounds.xMax))),h=l.find((s=>s.type===be.Group&&isBetween(i.bounds.xMid,s.bounds.xMin,s.bounds.xMax))),c=l.filter((s=>i.bounds.xMid>s.bounds.xMax)),u=l.filter((s=>i.bounds.xMid<s.bounds.xMin)),p=this.model.symbols.filter((s=>this.model.isSymbolBelow(i,s)));let m;if(s.strokeIds.length&&(null===(r=s.subStrokes)||void 0===r?void 0:r.length))m=this.computeChangesOnSplitStroke(i,s.strokeIds[0],s.subStrokes);else if(h)m=this.computeChangesOnSplitGroup(i,h);else if(d)m=this.computeChangesOnSplitText(i,d);else if(u.length){const i=[];let s=0;switch(c.length&&(s=Math.min(...c.map((i=>i.bounds.xMin)))-Math.min(...u.map((i=>i.bounds.xMin)))),this.insertAction){case Xe.LineBreak:i.push({symbols:u,tx:s,ty:this.rowHeight}),p.length&&i.push({symbols:p,tx:0,ty:this.rowHeight});break;case Xe.Insert:i.push({symbols:u,tx:2*this.strokeSpaceWidth,ty:0})}m={translate:i}}else c.length&&p.length&&this.insertAction===Xe.LineBreak&&(m={translate:[{symbols:p,tx:0,ty:this.rowHeight}]});if(m){const i=[];(null===(n=m.translate)||void 0===n?void 0:n.length)&&i.push(...m.translate.map((i=>this.translator.translate(i.symbols,i.tx,i.ty,!1)))),(null===(a=m.replaced)||void 0===a?void 0:a.newSymbols.length)&&i.push(this.behaviors.replaceSymbols(m.replaced.oldSymbols,m.replaced.newSymbols,!1)),this.history.push(this.model,m),yield Promise.all(i)}}))}applyUnderlineGesture(i,s){var r;return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,qe,"f").debug("applyUnderlineGesture",{gestureStroke:i,gesture:s}),!s.strokeIds.length)return void __classPrivateFieldGet(this,qe,"f").warn("applyUnderlineGesture","Unable to apply underline because there are no strokes");const n={decorator:[]},a=[];s.strokeIds.forEach((i=>{var s;const r=this.model.getRootSymbol(i);if(r&&[be.Group,be.Stroke,be.Text].includes(r.type)&&!a.includes(r.id)){const i=r,l=new OIDecorator(oe.Underline,this.currentStyle),d=i.decorators.findIndex((i=>i.kind===oe.Underline)),h=-1===d;h?i.decorators.push(l):i.decorators.splice(d,1),this.model.updateSymbol(i),this.renderer.drawSymbol(i),null===(s=n.decorator)||void 0===s||s.push({symbol:i,decorator:l,added:h}),a.push(i.id)}})),(null===(r=n.decorator)||void 0===r?void 0:r.length)&&this.history.push(this.model,n)}))}applyStrikeThroughGesture(i,s){var r;return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,qe,"f").debug("applyStrikeThroughGesture",{gestureStroke:i,gesture:s}),s.strokeIds.length)switch(this.strikeThroughAction){case Ye.Draw:{const i={decorator:[]},n=[];s.strokeIds.forEach((s=>{var r;const a=this.model.getRootSymbol(s);if(a&&[be.Group,be.Stroke,be.Text].includes(a.type)&&!n.includes(a.id)){const s=a,l=new OIDecorator(oe.Strikethrough,this.currentStyle),d=s.decorators.findIndex((i=>i.kind===oe.Strikethrough)),h=-1===d;h?s.decorators.push(l):s.decorators.splice(d,1),this.model.updateSymbol(s),this.renderer.drawSymbol(s),null===(r=i.decorator)||void 0===r||r.push({symbol:s,decorator:l,added:h}),n.push(s.id)}})),(null===(r=i.decorator)||void 0===r?void 0:r.length)&&this.history.push(this.model,i);break}case Ye.Erase:return this.behaviors.removeSymbols(s.strokeIds);default:__classPrivateFieldGet(this,qe,"f").warn("#applyStrikeThroughGesture",`Unknow OnStrikeThrough: ${this.strikeThroughAction}, values allowed are: ${Ye.Draw}, ${Ye.Erase}`)}else __classPrivateFieldGet(this,qe,"f").warn("applyStrikeThroughGesture","Unable to apply strikethrough because there are no strokes")}))}apply(i,s){return __awaiter(this,void 0,void 0,(function*(){switch(__classPrivateFieldGet(this,qe,"f").info("apply",{gestureStroke:i,gesture:s}),this.behaviors.updateSymbolsStyle([i.id],{opacity:(i.style.opacity||1)/2},!1),yield this.behaviors.groupStrokesByJIIXElement(),yield this.behaviors.removeSymbol(i.id,!1),s.gestureType){case"UNDERLINE":yield this.applyUnderlineGesture(i,s);break;case"SCRATCH":yield this.applyScratch(i,s);break;case"JOIN":yield this.applyJoinGesture(i,s);break;case"INSERT":yield this.applyInsertGesture(i,s);break;case"STRIKETHROUGH":yield this.applyStrikeThroughGesture(i,s);break;case"SURROUND":yield this.applySurroundGesture(i,s);break;default:__classPrivateFieldGet(this,qe,"f").warn("apply",`Gesture unknow: ${s.gestureType}`)}return this.behaviors.svgDebugger.apply(),Promise.resolve()}))}getGestureFromContextLess(i){return __awaiter(this,void 0,void 0,(function*(){const s=yield this.recognizer.recognizeGesture(i);if(s)switch(s.gestureType){case"surround":return this.model.symbols.some((s=>!(s.id===i.id||!i.bounds.contains(s.bounds))&&(this.surroundAction===We.Select||[be.Group,be.Stroke,be.Text].includes(s.type))))?{gestureType:"SURROUND",gestureStrokeId:i.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:[]}:void 0;case"left-right":case"right-left":{const s=this.model.symbols.filter((s=>[be.Text,be.Stroke,be.Group].includes(s.type)&&isBetween(s.bounds.xMid,i.bounds.xMin,i.bounds.xMax)&&isBetween(i.bounds.yMid,s.bounds.y+3*s.bounds.height/4,s.bounds.y+5*s.bounds.height/4)));if(s.length)return{gestureType:"UNDERLINE",gestureStrokeId:i.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:s.map((i=>i.id))};const r=this.model.symbols.filter((s=>[be.Text,be.Stroke,be.Group].includes(s.type)&&isBetween(s.bounds.xMid,i.bounds.xMin,i.bounds.xMax)&&isBetween(i.bounds.yMid,s.bounds.y+s.bounds.height/4,s.bounds.y+3*s.bounds.height/4)));return r.length?{gestureType:"STRIKETHROUGH",gestureStrokeId:i.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:r.map((i=>i.id))}:void 0}case"scratch":{const s=this.model.symbols.filter((s=>s.id!==i.id&&(i.bounds.overlaps(s.bounds)&&[be.Stroke,be.Text,be.Group].includes(s.type)||i.bounds.contains(s.bounds)&&[be.Shape,be.Edge].includes(s.type))));return s.length?{gestureType:"SCRATCH",gestureStrokeId:i.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:s.map((i=>i.id))}:void 0}case"bottom-top":return this.model.symbols.some((s=>s.id!==i.id&&[be.Text,be.Stroke,be.Group].includes(s.type)&&isBetween(s.bounds.yMid,i.bounds.yMin,i.bounds.yMax)))?{gestureType:"JOIN",gestureStrokeId:i.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:[]}:void 0;case"top-bottom":return this.model.symbols.some((s=>s.id!==i.id&&[be.Text,be.Stroke,be.Group].includes(s.type)&&isBetween(s.bounds.yMid,i.bounds.yMin,i.bounds.yMax)))?{gestureType:"INSERT",gestureStrokeId:i.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:[]}:void 0;default:return}}))}}qe=new WeakMap;class OIResizeManager{constructor(i){Je.set(this,LoggerManager.getLogger(d.TRANSFORMER)),this.keepRatio=!1,__classPrivateFieldGet(this,Je,"f").info("constructor"),this.behaviors=i}get model(){return this.behaviors.model}applyToStroke(i,s,r,n){return __classPrivateFieldGet(this,Je,"f").debug("applyToStroke",{stroke:i,origin:s,scaleX:r,scaleY:n}),i.pointers.forEach((i=>{i.x=+(s.x+r*(i.x-s.x)).toFixed(3),i.y=+(s.y+n*(i.y-s.y)).toFixed(3)})),i}applyToShape(i,s,r,n){switch(__classPrivateFieldGet(this,Je,"f").debug("applyToShape",{shape:i,origin:s,scaleX:r,scaleY:n}),i.kind){case Se.Ellipse:{const a=Math.cos(i.orientation),l=Math.sin(i.orientation);return i.center.x=+(i.center.x+((r-1)*a+(n-1)*l)*(i.center.x-s.x)).toFixed(3),i.center.y=+(i.center.y+((r-1)*-l+(n-1)*a)*(i.center.y-s.y)).toFixed(3),i.radiusX=+Math.abs(i.radiusX*(r*a-n*l)).toFixed(3),i.radiusY=+Math.abs(i.radiusY*(r*l+n*a)).toFixed(3),i}case Se.Circle:return i.radius=+(i.radius*(r+n)/2).toFixed(3),i.center.x=+(s.x+r*(i.center.x-s.x)).toFixed(3),i.center.y=+(s.y+n*(i.center.y-s.y)).toFixed(3),i;case Se.Polygon:return i.points.forEach((i=>{i.x=+(s.x+r*(i.x-s.x)).toFixed(3),i.y=+(s.y+n*(i.y-s.y)).toFixed(3)})),i;default:throw new Error(`Can't apply resize on shape, kind unknow: ${JSON.stringify(i)}`)}}applyToEdge(i,s,r,n){switch(__classPrivateFieldGet(this,Je,"f").debug("applyToEdge",{edge:i,origin:s,scaleX:r,scaleY:n}),i.kind){case xe.Arc:{const a=Math.cos(i.phi),l=Math.sin(i.phi);return i.center.x=+(i.center.x+((r-1)*a+(n-1)*l)*(i.center.x-s.x)).toFixed(3),i.center.y=+(i.center.y+((r-1)*-l+(n-1)*a)*(i.center.y-s.y)).toFixed(3),i.radiusX=+(i.radiusX*Math.abs(r*a+n*l)).toFixed(3),i.radiusY=+(i.radiusY*Math.abs(r*l+n*a)).toFixed(3),r<0?(i.startAngle=+(Math.PI-i.startAngle).toFixed(3),i.sweepAngle*=-1):n<0&&(i.sweepAngle*=-1),i}case xe.Line:return i.start.x=+(s.x+r*(i.start.x-s.x)).toFixed(3),i.start.y=+(s.y+n*(i.start.y-s.y)).toFixed(3),i.end.x=+(s.x+r*(i.end.x-s.x)).toFixed(3),i.end.y=+(s.y+n*(i.end.y-s.y)).toFixed(3),i;case xe.PolyEdge:return i.points.forEach((i=>(i.x=+(s.x+r*(i.x-s.x)).toFixed(3),i.y=+(s.y+n*(i.y-s.y)).toFixed(3),i))),i;default:throw new Error(`Can't apply resize on edge, kind unknow: ${JSON.stringify(i)}`)}}applyOnText(i,s,r,n){return i.point.x=+(s.x+r*(i.point.x-s.x)).toFixed(3),i.point.y=+(s.y+n*(i.point.y-s.y)).toFixed(3),i.chars.forEach((i=>{i.fontSize=+(i.fontSize*(r+n)/2).toFixed(3)})),this.behaviors.texter.updateBounds(i)}applyOnGroup(i,s,r,n){return i.children.forEach((i=>this.applyToSymbol(i,s,r,n))),i}applyToSymbol(i,s,r,n){switch(__classPrivateFieldGet(this,Je,"f").info("applyToSymbol",{symbol:i,scaleX:r,scaleY:n}),i.type){case be.Stroke:return this.applyToStroke(i,s,r,n);case be.Shape:return this.applyToShape(i,s,r,n);case be.Edge:return this.applyToEdge(i,s,r,n);case be.Text:return this.applyOnText(i,s,r,n);case be.Group:return this.applyOnGroup(i,s,r,n);default:throw new Error(`Can't apply resize on symbol, type unknow: ${JSON.stringify(i)}`)}}setTransformOrigin(i,s,r){this.behaviors.renderer.setAttribute(i,"transform-origin",`${s}px ${r}px`)}scaleElement(i,s,r){__classPrivateFieldGet(this,Je,"f").info("scaleElement",{id:i,sx:s,sy:r}),this.behaviors.renderer.setAttribute(i,"transform",`scale(${s},${r})`)}start(i,s){__classPrivateFieldGet(this,Je,"f").info("start",{target:i}),this.interactElementsGroup=i.closest(`[role=${r.InteractElementsGroup}]`),this.direction=i.getAttribute("resize-direction"),this.keepRatio=this.model.symbolsSelected.some((i=>i.type===be.Text||i.type===be.Shape&&i.kind===Se.Circle)),this.transformOrigin=s,this.boundingBox=Box.createFromPoints(this.model.symbolsSelected.flatMap((i=>i.vertices))),this.setTransformOrigin(this.interactElementsGroup.id,this.transformOrigin.x,this.transformOrigin.y),this.model.symbolsSelected.forEach((i=>{this.setTransformOrigin(i.id,this.transformOrigin.x,this.transformOrigin.y)})),this.behaviors.selector.hideInteractElements()}continue(i){if(__classPrivateFieldGet(this,Je,"f").info("continue",{point:i}),!this.interactElementsGroup)throw new Error("Can't resize, you must call start before");const s=i,r=["e-resize","ne-resize","se-resize","w-resize","nw-resize","sw-resize"].includes(this.direction),n=["n-resize","ne-resize","nw-resize","s-resize","se-resize","sw-resize"].includes(this.direction),{x:a,y:l}=this.behaviors.snaps.snapResize(i,r,n);s.x=a,s.y=l;let d=0,h=0;["e-resize","ne-resize","se-resize"].includes(this.direction)?d=s.x-this.boundingBox.xMax:["w-resize","nw-resize","sw-resize"].includes(this.direction)&&(d=this.boundingBox.xMin-s.x),["n-resize","ne-resize","nw-resize"].includes(this.direction)?h=this.boundingBox.yMin-s.y:["s-resize","se-resize","sw-resize"].includes(this.direction)&&(h=s.y-this.boundingBox.yMax);let c=this.boundingBox.width?1+d/this.boundingBox.width:1,u=this.boundingBox.height?1+h/this.boundingBox.height:1;return this.keepRatio&&(["n-resize","s-resize"].includes(this.direction)?c=u:(["e-resize","w-resize"].includes(this.direction)||(c=Math.max(c,u)),u=c)),this.scaleElement(this.interactElementsGroup.id,c,u),this.model.symbolsSelected.forEach((i=>{this.scaleElement(i.id,c,u)})),{scaleX:c,scaleY:u}}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Je,"f").info("end",{point:i});const{scaleX:s,scaleY:r}=this.continue(i);this.behaviors.snaps.clearSnapToElementLines();const n=this.model.symbolsSelected.map((i=>i.clone()));this.model.symbolsSelected.forEach((i=>{this.applyToSymbol(i,this.transformOrigin,s,r),this.behaviors.renderer.drawSymbol(i),this.model.updateSymbol(i)}));const a=this.behaviors.extractStrokesFromSymbols(this.model.symbolsSelected);this.behaviors.recognizer.transformScale(a.map((i=>i.id)),s,r,this.transformOrigin.x,this.transformOrigin.y),this.behaviors.history.push(this.model,{scale:[{symbols:n,origin:Object.assign({},this.transformOrigin),scaleX:s,scaleY:r}]}),this.behaviors.selector.resetSelectedGroup(this.model.symbolsSelected),this.interactElementsGroup=void 0,this.behaviors.selector.showInteractElements(),this.behaviors.svgDebugger.apply()}))}}Je=new WeakMap;class OIRotationManager{constructor(i){Ze.set(this,LoggerManager.getLogger(d.TRANSFORMER)),__classPrivateFieldGet(this,Ze,"f").info("constructor"),this.behaviors=i}get model(){return this.behaviors.model}applyToStroke(i,s,r){return i.pointers.forEach((i=>{const{x:n,y:a}=computeRotatedPoint(i,s,r);i.x=n,i.y=a})),i}applyToShape(i,s,r){switch(i.kind){case Se.Ellipse:return i.center=computeRotatedPoint(i.center,s,r),i.orientation=(i.orientation+r)%(2*Math.PI),i;case Se.Circle:return i.center=computeRotatedPoint(i.center,s,r),i;case Se.Polygon:return i.points.forEach((i=>{const{x:n,y:a}=computeRotatedPoint(i,s,r);i.x=n,i.y=a})),i;default:throw new Error(`Can't apply rotate on shape, kind unknow: ${JSON.stringify(i)}`)}}applyToEdge(i,s,r){switch(i.kind){case xe.Arc:return i.phi=(i.phi-r)%(2*Math.PI),i.center=computeRotatedPoint(i.center,s,r),i;case xe.Line:return i.start=computeRotatedPoint(i.start,s,r),i.end=computeRotatedPoint(i.end,s,r),i;case xe.PolyEdge:return i.points=i.points.map((i=>computeRotatedPoint(i,s,r))),i;default:throw new Error(`Can't apply rotate on edge, kind unknow: ${JSON.stringify(i)}`)}}applyOnText(i,s,r){var n;return i.rotation={degree:convertRadianToDegree(r)+((null===(n=i.rotation)||void 0===n?void 0:n.degree)||0),center:s},this.behaviors.texter.updateBounds(i)}applyOnGroup(i,s,r){return i.children.forEach((i=>this.applyToSymbol(i,s,r))),i}applyToSymbol(i,s,r){switch(i.type){case be.Stroke:return this.applyToStroke(i,s,r);case be.Shape:return this.applyToShape(i,s,r);case be.Edge:return this.applyToEdge(i,s,r);case be.Text:return this.applyOnText(i,s,r);case be.Group:return this.applyOnGroup(i,s,r);default:throw new Error(`Can't apply rotate on symbol, type unknow: ${JSON.stringify(i)}`)}}setTransformOrigin(i,s,r){this.behaviors.renderer.setAttribute(i,"transform-origin",`${s}px ${r}px`)}rotateElement(i,s){__classPrivateFieldGet(this,Ze,"f").info("rotateElement",{id:i,degree:s}),this.behaviors.renderer.setAttribute(i,"transform",`rotate(${s})`)}start(i,s){__classPrivateFieldGet(this,Ze,"f").info("start",{target:i}),this.interactElementsGroup=i.closest(`[role=${r.InteractElementsGroup}]`);const n=Box.createFromPoints(this.model.symbolsSelected.flatMap((i=>i.vertices)));this.center={x:n.xMin+n.width/2,y:n.yMid},this.origin=s,this.setTransformOrigin(this.interactElementsGroup.id,this.center.x,this.center.y),this.model.symbolsSelected.forEach((i=>{this.setTransformOrigin(i.id,this.center.x,this.center.y)})),this.behaviors.selector.hideInteractElements()}continue(i){if(__classPrivateFieldGet(this,Ze,"f").info("continue",{point:i}),!this.interactElementsGroup)throw new Error("Can't rotate, you must call start before");let s=Math.round(convertRadianToDegree(computeAngleRadian(this.origin,this.center,i)));return s=this.behaviors.snaps.snapRotation(s),i.x-this.center.x<0&&(s=360-s),this.rotateElement(this.interactElementsGroup.id,s),this.model.symbolsSelected.forEach((i=>{this.rotateElement(i.id,s)})),s}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ze,"f").info("end",{point:i});const s=convertDegreeToRadian(this.continue(i))%(2*Math.PI),r=this.model.symbolsSelected.map((i=>i.clone()));this.model.symbolsSelected.forEach((i=>{this.applyToSymbol(i,this.center,s),this.behaviors.renderer.drawSymbol(i),this.model.updateSymbol(i)}));const n=this.behaviors.extractStrokesFromSymbols(this.model.symbolsSelected);this.behaviors.recognizer.transformRotate(n.map((i=>i.id)),s,this.center.x,this.center.y),this.behaviors.history.push(this.model,{rotate:[{symbols:r,angle:s,center:Object.assign({},this.center)}]}),this.behaviors.selector.resetSelectedGroup(this.model.symbolsSelected),this.interactElementsGroup=void 0,this.behaviors.selector.showInteractElements(),this.behaviors.svgDebugger.apply()}))}}Ze=new WeakMap;class OISelectionManager{constructor(i){Ke.set(this,LoggerManager.getLogger(d.SELECTION)),Qe.set(this,"selecting-rect"),__classPrivateFieldGet(this,Ke,"f").info("constructor"),this.behaviors=i}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}get internalEvent(){return this.behaviors.internalEvent}get rotator(){return this.behaviors.rotator}get translator(){return this.behaviors.translator}get resizer(){return this.behaviors.resizer}get selectionBox(){if(this.startSelectionPoint&&this.endSelectionPoint)return Box.createFromPoints([this.startSelectionPoint,this.endSelectionPoint])}drawSelectingRect(i){this.clearSelectingRect();const s={id:__classPrivateFieldGet(this,Qe,"f"),fill:"transparent",stroke:"grey",opacity:"0.25"};this.renderer.appendElement(SVGBuilder.createRect(i,s))}clearSelectingRect(){this.renderer.clearElements({attrs:{id:__classPrivateFieldGet(this,Qe,"f")}})}getPoint(i){const{clientLeft:s,scrollLeft:r,clientTop:n,scrollTop:a}=this.renderer.parent,l=this.renderer.parent.getBoundingClientRect();return{x:i.clientX-l.left-s+r,y:i.clientY-l.top-n+a}}createTranslateRect(i){const s={role:r.Translate,style:"cursor:move",fill:"transparent",stroke:"transparent"},n={height:i.height,width:i.width,x:i.x,y:i.y},a=SVGBuilder.createRect(n,s),handler=i=>{i.preventDefault(),i.stopPropagation(),this.translator.continue(this.getPoint(i))},endHandler=i=>{i.preventDefault(),i.stopPropagation(),this.translator.end(this.getPoint(i)),this.renderer.layer.removeEventListener("pointermove",handler),this.renderer.layer.removeEventListener("pointercancel",endHandler),this.renderer.layer.removeEventListener("pointerleave",endHandler),this.renderer.layer.removeEventListener("pointerup",endHandler)};return a.addEventListener("pointerdown",(i=>{0===i.button&&1===i.buttons&&(i.preventDefault(),i.stopPropagation(),this.translator.start(i.target,this.getPoint(i)),this.renderer.layer.addEventListener("pointermove",handler),this.renderer.layer.addEventListener("pointercancel",endHandler),this.renderer.layer.addEventListener("pointerleave",endHandler),this.renderer.layer.addEventListener("pointerup",endHandler))})),a}createRotateGroup(i){const s=SVGBuilder.createGroup({role:r.Rotate,"vector-effect":"non-scaling-size",style:"cursor:pointer;",opacity:"1"}),n={x:i.x+i.width/2,y:i.y-40},l={role:r.Rotate,"stroke-width":"2",stroke:"black",fill:"white"};s.appendChild(SVGBuilder.createCircle(n,8,l));const d={role:r.Rotate,fill:"black"};s.appendChild(SVGBuilder.createCircle(n,4,d));const h={role:r.Rotate,stroke:"black","stroke-width":"2"};s.appendChild(SVGBuilder.createLine({x:n.x,y:n.y+8},{x:n.x,y:i.y-a},h));const handler=i=>{i.preventDefault(),i.stopPropagation(),this.rotator.continue(this.getPoint(i))},endHandler=i=>{i.preventDefault(),i.stopPropagation(),this.rotator.end(this.getPoint(i)),this.renderer.layer.removeEventListener("pointermove",handler),this.renderer.layer.removeEventListener("pointercancel",endHandler),this.renderer.layer.removeEventListener("pointerleave",endHandler),this.renderer.layer.removeEventListener("pointerup",endHandler)};return s.addEventListener("pointerdown",(i=>{0===i.button&&1===i.buttons&&(i.preventDefault(),i.stopPropagation(),this.rotator.start(i.target,this.getPoint(i)),this.renderer.layer.addEventListener("pointermove",handler),this.renderer.layer.addEventListener("pointercancel",endHandler),this.renderer.layer.addEventListener("pointerleave",endHandler),this.renderer.layer.addEventListener("pointerup",endHandler))})),s}createResizeGroup(i){const s=SVGBuilder.createGroup({role:r.Resize,"vector-effect":"non-scaling-size","stroke-width":"4",stroke:"#3e68ff"}),n={x:i.x-a,y:i.y-a},l={x:i.x+i.width+a,y:i.y-a},d={x:i.x+i.width+a,y:i.y+i.height+a},h={x:i.x-a,y:i.y+i.height+a},bindEl=(i,s)=>{const handler=i=>{i.preventDefault(),i.stopPropagation(),this.resizer.continue(this.getPoint(i))},endHandler=i=>{i.preventDefault(),i.stopPropagation(),this.resizer.end(this.getPoint(i)),this.renderer.layer.removeEventListener("pointermove",handler),this.renderer.layer.removeEventListener("pointercancel",endHandler),this.renderer.layer.removeEventListener("pointerleave",endHandler),this.renderer.layer.removeEventListener("pointerup",endHandler)};i.addEventListener("pointerdown",(i=>{0===i.button&&1===i.buttons&&(i.preventDefault(),i.stopPropagation(),this.resizer.start(i.target,s),this.renderer.layer.addEventListener("pointermove",handler),this.renderer.layer.addEventListener("pointercancel",endHandler),this.renderer.layer.addEventListener("pointerleave",endHandler),this.renderer.layer.addEventListener("pointerup",endHandler))}))};[{direction:"n-resize",p1:n,p2:l,transformOrigin:{x:i.x+i.width/2,y:i.y+i.height}},{direction:"e-resize",p1:l,p2:d,transformOrigin:{x:i.x,y:i.y+i.height/2}},{direction:"s-resize",p1:h,p2:d,transformOrigin:{x:i.x+i.width/2,y:i.y}},{direction:"w-resize",p1:n,p2:h,transformOrigin:{x:i.x+i.width,y:i.y+i.height/2}}].forEach((i=>{const n={role:r.Resize,"resize-direction":i.direction,"transform-origin":JSON.stringify(i.transformOrigin),style:`cursor:${i.direction};`},a=SVGBuilder.createLine(i.p1,i.p2,n);bindEl(a,i.transformOrigin),s.appendChild(a)}));return[{direction:"nw-resize",p:n,transformOrigin:{x:i.x+i.width,y:i.y+i.height}},{direction:"ne-resize",p:l,transformOrigin:{x:i.x,y:i.y+i.height}},{direction:"se-resize",p:d,transformOrigin:{x:i.x,y:i.y}},{direction:"sw-resize",p:h,transformOrigin:{x:i.x+i.width,y:i.y}}].forEach((i=>{const n={"stroke-width":"4",role:r.Resize,"resize-direction":i.direction,"transform-origin":JSON.stringify(i.transformOrigin),transform:"scale(1, 1)",fill:"white",style:`cursor:${i.direction};`},a=SVGBuilder.createCircle(i.p,5,n);bindEl(a,i.transformOrigin),s.appendChild(a)})),s}createInteractElementsGroup(i){if(__classPrivateFieldGet(this,Ke,"f").info("createInteractElementsGroup",{symbols:i}),!i.length)return;const s=i.map((i=>({symbol:i,element:this.renderer.getElementById(i.id)}))),n=Box.createFromBoxes(i.map((i=>({x:i.bounds.x-(i.style.width||1),y:i.bounds.y-(i.style.width||1),height:i.bounds.height+2*(i.style.width||1),width:i.bounds.width+2*(i.style.width||1)})))),a=Box.createFromPoints(i.flatMap((i=>i.vertices))),l=Box.createFromBoxes([n,a]),d={id:`selected-${Date.now()}`,role:r.InteractElementsGroup},h=SVGBuilder.createGroup(d);h.appendChild(this.createTranslateRect(l)),h.appendChild(this.createResizeGroup(l)),h.appendChild(this.createRotateGroup(l));const c={style:"pointer-events: none",fill:"transparent",stroke:"#3e68ff","stroke-width":"1","stroke-dasharray":"4","vector-effect":"non-scaling-size",transform:"rotate(0, 0, 0)"};return s.forEach((i=>{var s,r,n;if(i.element){const a={x:i.symbol.bounds.x-(i.symbol.style.width||1),y:i.symbol.bounds.y-(i.symbol.style.width||1),height:i.symbol.bounds.height+2*(i.symbol.style.width||1),width:i.symbol.bounds.width+2*(i.symbol.style.width||1)};if(i.symbol.type===be.Text){const a=i.symbol;c.transform=`rotate(${(null===(s=a.rotation)||void 0===s?void 0:s.degree)||0}, ${(null===(r=a.rotation)||void 0===r?void 0:r.center.x)||0}, ${(null===(n=a.rotation)||void 0===n?void 0:n.center.y)||0})`}else c.transform="rotate(0, 0, 0)";h.prepend(SVGBuilder.createRect(a,c))}})),h}drawSelectedGroup(i){if(i.length){if(this.selectedGroup=this.createInteractElementsGroup(i),this.selectedGroup){this.renderer.layer.appendChild(this.selectedGroup);const i=this.selectedGroup.getBBox();this.behaviors.menu.context.position.x=i.x+i.width/2-this.renderer.parent.clientLeft,this.behaviors.menu.context.position.y=i.y+i.height-this.renderer.parent.clientTop,this.behaviors.menu.context.show()}this.behaviors.menu.update()}}resetSelectedGroup(i){__classPrivateFieldGet(this,Ke,"f").info("resetSelectedGroup",{symbols:i}),this.removeSelectedGroup(),this.drawSelectedGroup(i)}removeSelectedGroup(){var i;__classPrivateFieldGet(this,Ke,"f").info("removeSelectedGroup"),this.behaviors.menu.context.hide(),null===(i=this.selectedGroup)||void 0===i||i.remove(),this.selectedGroup=void 0}hideInteractElements(){var i;this.behaviors.menu.context.hide();const s=`[role=${r.Resize}],[role=${r.Rotate}],[role=${r.Translate}]`;null===(i=this.selectedGroup)||void 0===i||i.querySelectorAll(s).forEach((i=>{i.setAttribute("visibility","hidden")}))}showInteractElements(){var i;this.behaviors.menu.context.show();const s=`[role=${r.Resize}],[role=${r.Rotate}],[role=${r.Translate}]`;null===(i=this.selectedGroup)||void 0===i||i.querySelectorAll(s).forEach((i=>i.setAttribute("visibility","visible")))}start(i){this.startSelectionPoint=i,this.endSelectionPoint=i,this.drawSelectingRect(this.selectionBox)}continue(i){if(!this.startSelectionPoint)throw new Error("You need to call startSelectionByBox before");this.endSelectionPoint=i;const s=[];return this.model.symbols.forEach((i=>{i.selected!==i.overlaps(this.selectionBox)&&(i.selected=i.overlaps(this.selectionBox),s.push(i),this.renderer.drawSymbol(i))})),this.drawSelectingRect(this.selectionBox),s}end(i){this.endSelectionPoint=i;const s=this.continue(i);return this.startSelectionPoint=void 0,this.endSelectionPoint=void 0,this.clearSelectingRect(),this.drawSelectedGroup(this.model.symbolsSelected),this.internalEvent.emitSelected(this.model.symbolsSelected),this.behaviors.menu.style.update(),s}}Ke=new WeakMap,Qe=new WeakMap;class OISnapManager{constructor(i,s){et.set(this,LoggerManager.getLogger(d.CONVERTER)),__classPrivateFieldGet(this,et,"f").info("constructor"),this.behaviors=i,this.snapToElement=void 0===(null==s?void 0:s.element)||s.element,this.snapToGrid=void 0===(null==s?void 0:s.grid)||s.grid,this.snapAngle=void 0!==(null==s?void 0:s.angle)?s.angle:0}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}get selectionSnapPoints(){return Box.createFromPoints(this.model.symbolsSelected.flatMap((i=>i.snapPoints))).snapPoints}get otherSnapPoints(){const i=this.model.symbolsSelected.map((i=>i.id));return this.model.symbols.filter((s=>!i.includes(s.id))).flatMap((i=>i.snapPoints))}get snapThreshold(){return this.behaviors.configuration.rendering.guides.gap/2}getNearestVerticalGuide(i){return this.renderer.verticalGuides.length?this.renderer.verticalGuides.reduce(((s,r)=>Math.abs(r-i)<Math.abs(s-i)?r:s)):i}getNearestHorizontalGuide(i){return this.renderer.horizontalGuides.length?this.renderer.horizontalGuides.reduce(((s,r)=>Math.abs(r-i)<Math.abs(s-i)?r:s)):i}getGuidePointToSnap(i){return{x:this.getNearestVerticalGuide(i.x),y:this.getNearestHorizontalGuide(i.y)}}drawSnapToElementLines(i){const s={role:"snap-to-element",fill:"transparent",stroke:"blue","stroke-width":"2",style:ze.noSelection,"marker-start":`url(#${ze.crossMarker})`,"marker-end":`url(#${ze.crossMarker})`};i.forEach((i=>{this.renderer.drawLine(i.p1,i.p2,s)}))}clearSnapToElementLines(){this.renderer.clearElements({attrs:{role:"snap-to-element"}})}getSnapLinesInfos(i,s){const r={nudge:{x:1/0,y:1/0},verticales:[],horizontales:[]};return i.length&&s.length?(i.forEach((i=>{s.forEach((s=>{this.snapThreshold>Math.abs(s.x-i.x)&&(Math.abs(r.nudge.x)>Math.abs(s.x-i.x)?(r.nudge.x=s.x-i.x,r.verticales=[{p1:Object.assign({},i),p2:s}]):r.nudge.x===s.x-i.x&&r.verticales.push({p1:Object.assign({},i),p2:s})),this.snapThreshold>Math.abs(s.y-i.y)&&(Math.abs(r.nudge.y)>Math.abs(s.y-i.y)?(r.nudge.y=s.y-i.y,r.horizontales=[{p1:Object.assign({},i),p2:s}]):r.nudge.y===s.y-i.y&&r.horizontales.push({p1:Object.assign({},i),p2:s}))}))})),r):r}snapResize(i,s=!0,r=!0){if(this.clearSnapToElementLines(),!this.snapToElement&&!this.snapToGrid)return i;let n={x:1/0,y:1/0};this.snapToGrid&&(n=this.getGuidePointToSnap(i));const a=[];if(this.snapToElement){const l=this.getSnapLinesInfos([i],this.otherSnapPoints);s&&Math.abs(l.nudge.x)<=Math.abs(i.x-n.x)&&(n.x=i.x+l.nudge.x,a.push(...l.verticales)),r&&Math.abs(l.nudge.y)<=Math.abs(i.y-n.y)&&(n.y=i.y+l.nudge.y,a.push(...l.horizontales))}return n.x===1/0&&(n.x=i.x),n.y===1/0&&(n.y=i.y),a.forEach((i=>i.p1=n)),this.drawSnapToElementLines(a),n}snapTranslate(i,s){this.clearSnapToElementLines();const r={x:i,y:s};if(!this.snapToElement&&!this.snapToGrid)return r;const n=this.selectionSnapPoints.map((r=>({x:r.x+i,y:r.y+s})));let a=1/0,l=1/0;this.snapToGrid&&n.forEach((n=>{const d=this.getGuidePointToSnap(n);a>Math.abs(d.x-n.x)&&(r.x=d.x-n.x+i,a=Math.abs(d.x-n.x)),l>Math.abs(d.y-n.y)&&(r.y=d.y-n.y+s,l=Math.abs(d.y-n.y))}));const d=[];if(this.snapToElement){const h=this.getSnapLinesInfos(n,this.otherSnapPoints);a>=Math.abs(h.nudge.x)&&h.verticales.length&&(r.x=h.nudge.x+i,d.push(...h.verticales)),l>=Math.abs(h.nudge.y)&&h.horizontales.length&&(r.y=h.nudge.y+s,d.push(...h.horizontales))}return d.length&&(d.forEach((n=>{n.p1.x+=r.x-i,n.p1.y+=r.y-s})),this.drawSnapToElementLines(d)),r}snapRotation(i){return this.snapAngle>0?this.snapAngle*Math.round(i/this.snapAngle):i}}et=new WeakMap;class OITextManager{constructor(i){tt.set(this,LoggerManager.getLogger(d.CONVERTER)),__classPrivateFieldGet(this,tt,"f").info("constructor"),this.behaviors=i}get renderer(){return this.behaviors.renderer}get rowHeight(){return this.behaviors.configuration.rendering.guides.gap}get model(){return this.behaviors.model}drawSymbolHidden(i){var s;const r=i.clone();r.id="text-to-measure",r.chars.forEach((i=>i.id+="to-measure")),null===(s=this.renderer.layer.querySelector(`#${r.id}`))||void 0===s||s.remove();const n=this.renderer.buildElementFromSymbol(r);return n.setAttribute("visibility","hidden"),this.renderer.prependElement(n),n}setCharsBounds(i,s){const r=s.querySelector("text");if(r)for(let s=0;s<r.getNumberOfChars();s++){const n=i.chars.at(s);if(n){const i=r.getExtentOfChar(s);n.bounds=new Box(i)}}return i}setBounds(i){const s=this.drawSymbolHidden(i);i.bounds=this.getElementBoundingBox(s),this.setCharsBounds(i,s)}getElementBoundingBox(i){return new Box(i.querySelector("text").getBBox({stroke:!0,markers:!0,clipped:!0,fill:!0}))}getBoundingBox(i){const s=this.drawSymbolHidden(i);return this.getElementBoundingBox(s)}getSpaceWidth(i){var s;const r=new Box({height:0,width:0,x:0,y:0}),n={id:"text-char-space",label:"-",color:"",fontSize:i,fontWeight:"normal",bounds:r};return null===(s=this.getBoundingBox(new OIText([n],{x:0,y:0},r)))||void 0===s?void 0:s.width}updateBounds(i){return this.setBounds(i),this.model.updateSymbol(i),i}moveTextAfter(i,s){const r=this.model.getSymbolsByRowOrdered().find((s=>s.rowIndex===this.model.getSymbolRowIndex(i)));if(r){const n=r.symbols.filter((s=>s.type===be.Text&&s.bounds.xMid>i.bounds.xMid));return n.forEach((i=>{i.point.x+=s,this.updateBounds(i),this.model.updateSymbol(i),this.renderer.drawSymbol(i)})),n}}}tt=new WeakMap;class OITranslateManager{constructor(i){it.set(this,LoggerManager.getLogger(d.TRANSFORMER)),__classPrivateFieldGet(this,it,"f").info("constructor"),this.behaviors=i}get model(){return this.behaviors.model}applyToStroke(i,s,r){return i.pointers.forEach((i=>{i.x+=s,i.y+=r})),i}applyToShape(i,s,r){switch(i.kind){case Se.Ellipse:case Se.Circle:return i.center.x+=s,i.center.y+=r,i;case Se.Polygon:return i.points.forEach((i=>{i.x+=s,i.y+=r})),i;default:throw new Error(`Can't apply translate on shape, kind unknow: ${JSON.stringify(i)}`)}}applyToEdge(i,s,r){switch(i.kind){case xe.Arc:return i.center.x+=s,i.center.y+=r,i;case xe.Line:return i.start.x+=s,i.start.y+=r,i.end.x+=s,i.end.y+=r,i;case xe.PolyEdge:return i.points.forEach((i=>{i.x+=s,i.y+=r})),i}return i}applyOnText(i,s,r){return i.rotation&&(i.rotation.center={x:i.rotation.center.x+s,y:i.rotation.center.y+r}),i.point.x+=s,i.point.y+=r,this.behaviors.texter.updateBounds(i)}applyOnGroup(i,s,r){return i.children.forEach((i=>this.applyToSymbol(i,s,r))),i}applyToSymbol(i,s,r){switch(__classPrivateFieldGet(this,it,"f").info("applyToSymbol",{symbol:i,tx:s,ty:r}),i.type){case be.Stroke:return this.applyToStroke(i,s,r);case be.Shape:return this.applyToShape(i,s,r);case be.Edge:return this.applyToEdge(i,s,r);case be.Text:return this.applyOnText(i,s,r);case be.Group:return this.applyOnGroup(i,s,r);default:throw new Error(`Can't apply translate on symbol, type unknow: ${JSON.stringify(i)}`)}}translate(i,s,r,n=!0){__classPrivateFieldGet(this,it,"f").info("translate",{symbols:i,tx:s,ty:r}),i.forEach((i=>{this.applyToSymbol(i,s,r),this.model.updateSymbol(i),this.behaviors.renderer.drawSymbol(i)})),n&&this.behaviors.history.push(this.model,{translate:[{symbols:this.model.symbolsSelected,tx:s,ty:r}]});const a=this.behaviors.extractStrokesFromSymbols(i);return this.behaviors.recognizer.transformTranslate(a.map((i=>i.id)),s,r)}translateElement(i,s,r){__classPrivateFieldGet(this,it,"f").info("translateElement",{id:i,tx:s,ty:r}),this.behaviors.renderer.setAttribute(i,"transform",`translate(${s},${r})`)}start(i,s){__classPrivateFieldGet(this,it,"f").info("start",{origin:s}),this.interactElementsGroup=i.closest(`[role=${r.InteractElementsGroup}]`),this.transformOrigin=s,this.behaviors.selector.hideInteractElements()}continue(i){if(__classPrivateFieldGet(this,it,"f").info("continue",{point:i}),!this.interactElementsGroup)throw new Error("Can't translate, you must call start before");let s=i.x-this.transformOrigin.x,r=i.y-this.transformOrigin.y;const n=this.behaviors.snaps.snapTranslate(s,r);return s=n.x,r=n.y,this.translateElement(this.interactElementsGroup.id,s,r),this.model.symbolsSelected.forEach((i=>{this.translateElement(i.id,s,r)})),{tx:s,ty:r}}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,it,"f").info("end",{point:i});const{tx:s,ty:r}=this.continue(i);this.behaviors.snaps.clearSnapToElementLines(),this.translate(this.model.symbolsSelected,s,r),this.behaviors.selector.resetSelectedGroup(this.model.symbolsSelected),this.interactElementsGroup=void 0,this.behaviors.svgDebugger.apply()}))}}it=new WeakMap;class OIWriteManager{constructor(i){st.set(this,LoggerManager.getLogger(d.WRITE)),rt.set(this,s.Pencil),this.detectGesture=!0,__classPrivateFieldGet(this,st,"f").info("constructor"),this.behaviors=i}get tool(){return __classPrivateFieldGet(this,rt,"f")}set tool(i){__classPrivateFieldSet(this,rt,i,"f"),i!==s.Pencil?this.renderer.parent.classList.add("shape"):this.renderer.parent.classList.remove("shape"),this.behaviors.unselectAll()}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}get history(){return this.behaviors.history}get gestureManager(){return this.behaviors.gesture}get snaps(){return this.behaviors.snaps}get recognizer(){return this.behaviors.recognizer}needContextLessGesture(i){const s=new Box(i.bounds);return s.x-=a,s.y-=a,s.width+=20,s.height+=20,this.detectGesture&&this.model.symbols.some((i=>{switch(i.type){case be.Stroke:return!1;case be.Group:return!i.containsOnlyStroke()&&i.extractSymbols().some((i=>i.bounds.overlaps(s)));default:return i.bounds.overlaps(s)}}))}createCurrentSymbol(i,r,n){switch(__classPrivateFieldGet(this,st,"f").debug("createCurrentSymbol",{pointer:i,style:r,pointerType:n}),this.tool){case s.Pencil:this.model.currentSymbol=new OIStroke(r,n);break;case s.Rectangle:this.model.currentSymbol=OIShapePolygon.createRectangleBetweenPoints(i,i,r);break;case s.Triangle:this.model.currentSymbol=OIShapePolygon.createTriangleBetweenPoints(i,i,r);break;case s.Parallelogram:this.model.currentSymbol=OIShapePolygon.createParallelogramBetweenPoints(i,i,r);break;case s.Rhombus:this.model.currentSymbol=OIShapePolygon.createRhombusBetweenPoints(i,i,r);break;case s.Circle:this.model.currentSymbol=OIShapeCircle.createBetweenPoints(i,i,r);break;case s.Ellipse:this.model.currentSymbol=OIShapeEllipse.createBetweenPoints(i,i,r);break;case s.Line:case s.Arrow:case s.DoubleArrow:{let n,a;this.tool===s.Arrow?a=we.Arrow:this.tool===s.DoubleArrow&&(n=we.Arrow,a=we.Arrow),this.model.currentSymbol=new OIEdgeLine(i,i,n,a,r);break}default:throw new Error(`Can't create symbol, tool is unknow: "${this.tool}"`)}return this.updateCurrentSymbol(i)}updateCurrentSymbolShape(i){switch(this.tool){case s.Rectangle:OIShapePolygon.updateRectangleBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,i);break;case s.Triangle:OIShapePolygon.updateTriangleBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,i);break;case s.Parallelogram:OIShapePolygon.updateParallelogramBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,i);break;case s.Rhombus:OIShapePolygon.updateRhombusBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,i);break;case s.Circle:OIShapeCircle.updateBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,i);break;case s.Ellipse:OIShapeEllipse.updateBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,i)}}updateCurrentSymbolEdge(i){const s=this.model.currentSymbol;if(s.kind===xe.Line)s.end=i}updateCurrentSymbol(i){if(__classPrivateFieldGet(this,st,"f").debug("updateCurrentSymbol",{pointer:i}),!this.model.currentSymbol)throw new Error("Can't update current symbol because currentSymbol is undefined");switch(this.model.currentSymbol.type){case be.Stroke:this.model.currentSymbol.addPointer(i);break;case be.Shape:this.updateCurrentSymbolShape(i);break;case be.Edge:this.updateCurrentSymbolEdge(i)}return this.model.currentSymbol}start(i,r,n){__classPrivateFieldGet(this,st,"f").info("startWriting",{style:i,pointer:r,pointerType:n});const a=r;if(this.tool!==s.Pencil){const{x:i,y:s}=this.snaps.snapResize(r);a.x=i,a.y=s}this.currentSymbolOrigin=a,this.createCurrentSymbol(a,i,n),this.renderer.drawSymbol(this.model.currentSymbol)}continue(i){__classPrivateFieldGet(this,st,"f").info("continueWriting",{pointer:i});const r=i;if(this.tool!==s.Pencil){const{x:s,y:n}=this.snaps.snapResize(i);r.x=s,r.y=n}this.updateCurrentSymbol(r),this.renderer.drawSymbol(this.model.currentSymbol)}interactWithBackend(i){return __awaiter(this,void 0,void 0,(function*(){const s=i.clone();let r;if(this.needContextLessGesture(i)&&(r=yield this.gestureManager.getGestureFromContextLess(s)),r)this.history.pop(),this.recognizer.addStrokes([s],this.detectGesture),this.gestureManager.apply(s,r);else{const i=yield this.recognizer.addStrokes([s],this.detectGesture);i&&(this.history.pop(),this.gestureManager.apply(this.model.getRootSymbol(i.gestureStrokeId),i))}}))}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,st,"f").info("finishWriting",{pointer:i});const r=i;if(this.tool!==s.Pencil){const{x:s,y:n}=this.snaps.snapResize(i);r.x=s,r.y=n}const n=this.updateCurrentSymbol(r);this.model.currentSymbol=void 0,this.currentSymbolOrigin=void 0,this.snaps.clearSnapToElementLines(),this.renderer.drawSymbol(n),this.model.addSymbol(n),this.history.push(this.model,{added:[n]}),n.type===be.Stroke&&(yield this.interactWithBackend(n))}))}}st=new WeakMap,rt=new WeakMap;class OIEraseManager{constructor(i){nt.set(this,LoggerManager.getLogger(d.WRITE)),__classPrivateFieldGet(this,nt,"f").info("constructor"),this.behaviors=i}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}start(i){__classPrivateFieldGet(this,nt,"f").info("startErase",{pointer:i}),this.currentEraser=new OIEraser,this.currentEraser.pointers.push(i),this.renderer.drawSymbol(this.currentEraser)}continue(i){if(__classPrivateFieldGet(this,nt,"f").info("continueErase",{pointer:i}),!this.currentEraser)throw new Error("Can't update current eraser because currentEraser is undefined");this.currentEraser.pointers.push(i),this.renderer.drawSymbol(this.currentEraser);const s={p1:this.currentEraser.pointers.at(-1),p2:this.currentEraser.pointers.at(-2)};this.model.symbols.forEach((i=>{i.isIntersected(s)&&(i.deleting=!0)})),this.model.symbolsToDelete.map((i=>this.renderer.drawSymbol(i)))}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,nt,"f").info("finishErasing",{pointer:i}),this.continue(i),this.renderer.removeSymbol(this.currentEraser.id),this.currentEraser=void 0,this.behaviors.removeSymbols(this.model.symbolsToDelete.map((i=>i.id)))}))}}nt=new WeakMap;class OIDebugSVGManager{constructor(i){ot.set(this,LoggerManager.getLogger(d.SVGDEBUG)),at.set(this,!1),lt.set(this,!1),dt.set(this,!1),ht.set(this,!1),ct.set(this,!1),__classPrivateFieldGet(this,ot,"f").info("constructor"),this.behaviors=i}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}get snapPointsVisibility(){return __classPrivateFieldGet(this,at,"f")}set snapPointsVisibility(i){__classPrivateFieldSet(this,at,i,"f"),this.debugSnapPoints()}get verticesVisibility(){return __classPrivateFieldGet(this,lt,"f")}set verticesVisibility(i){__classPrivateFieldSet(this,lt,i,"f"),this.debugVertices()}get boundingBoxVisibility(){return __classPrivateFieldGet(this,dt,"f")}set boundingBoxVisibility(i){__classPrivateFieldSet(this,dt,i,"f"),__classPrivateFieldGet(this,dt,"f")?this.showBoundingBox():this.hideBoundingBox()}get recognitionBoxVisibility(){return __classPrivateFieldGet(this,ht,"f")}set recognitionBoxVisibility(i){__classPrivateFieldSet(this,ht,i,"f"),this.debugRecognitionBox()}get recognitionItemBoxVisibility(){return __classPrivateFieldGet(this,ct,"f")}set recognitionItemBoxVisibility(i){__classPrivateFieldSet(this,ct,i,"f"),this.debugRecognitionItemBox()}showSnapPoints(){__classPrivateFieldGet(this,ot,"f").info("showSnapPoints"),this.model.currentSymbol&&this.model.currentSymbol.snapPoints.forEach((i=>this.renderer.drawCircle(i,2,{fill:"blue",debug:"snap-points"}))),this.model.symbols.forEach((i=>i.snapPoints.forEach((i=>this.renderer.drawCircle(i,2,{fill:"blue",debug:"snap-points"})))))}hideSnapPoints(){__classPrivateFieldGet(this,ot,"f").info("hideSnapPoints"),this.renderer.clearElements({attrs:{debug:"snap-points"}})}debugSnapPoints(){this.hideSnapPoints(),this.snapPointsVisibility&&this.showSnapPoints()}showVertices(){__classPrivateFieldGet(this,ot,"f").info("showVertices"),this.model.currentSymbol&&this.model.currentSymbol.vertices.forEach((i=>this.renderer.drawCircle(i,2,{fill:"red",debug:"vertices"}))),this.model.symbols.forEach((i=>i.vertices.forEach((i=>this.renderer.drawCircle(i,2,{fill:"red",debug:"vertices"})))))}hideVertices(){__classPrivateFieldGet(this,ot,"f").info("hideVertices"),this.renderer.clearElements({attrs:{debug:"vertices"}})}debugVertices(){this.hideVertices(),this.verticesVisibility&&this.showVertices()}drawBoundingBox(i){const s={style:"pointer-events: none",fill:"transparent",stroke:"red","stroke-width":"1","stroke-dasharray":"5 5","vector-effect":"non-scaling-stroke",debug:"bounding-box"},r={style:"pointer-events: none",fill:"transparent",stroke:"orange","stroke-width":"1","stroke-dasharray":"0 5 0","vector-effect":"non-scaling-stroke",debug:"bounding-box"};i.forEach((i=>{const n=this.renderer.getElementById(i.id);if(n)if(i.type===be.Text){const a=i;let l="";a.rotation&&(l=`rotate(${a.rotation.degree}, ${a.rotation.center.x}, ${a.rotation.center.y})`),a.chars.forEach((i=>{const s=Object.assign(Object.assign({},r),{char:i.label,transform:l});n.insertAdjacentElement("beforebegin",SVGBuilder.createRect(i.bounds,s))}));const d=Object.assign(Object.assign({},s),{symbol:i.id,transform:l});n.insertAdjacentElement("beforebegin",SVGBuilder.createRect(i.bounds,d))}else{const r=Object.assign(Object.assign({},s),{symbol:i.id});n.insertAdjacentElement("beforebegin",SVGBuilder.createRect(i.bounds,r))}}))}showBoundingBox(){__classPrivateFieldGet(this,ot,"f").info("showBoundingBox"),this.model.currentSymbol&&this.drawBoundingBox([this.model.currentSymbol]),this.drawBoundingBox(this.model.symbols)}hideBoundingBox(){__classPrivateFieldGet(this,ot,"f").info("hideBoundingBox"),this.renderer.clearElements({attrs:{debug:"bounding-box"}})}debugBoundingBox(){this.hideBoundingBox(),this.boundingBoxVisibility&&this.showBoundingBox()}drawRecognitionBox(i,s){const r="green",n=SVGBuilder.createGroup({debug:"recognition-box"}),a=SVGBuilder.createRect(i,{fill:"transparent",stroke:r,style:ze.noSelection});n.appendChild(a);const l=SVGBuilder.createGroup({id:`infos-group-${createUUID()}`}),d=i.x+i.width;let h=i.y+10;null==s||s.forEach((i=>{l.appendChild(SVGBuilder.createText({x:d,y:h},i,{stroke:r,style:ze.noSelection})),h+=20})),n.appendChild(l),this.renderer.layer.appendChild(n);const c=l.getBBox(),u={width:c.width+10,height:c.height+10,x:c.x-5,y:c.y-5},p=SVGBuilder.createRect(u,{fill:"white",style:"cursor:move",stroke:r});l.prepend(p);const translateEl=s=>{s.preventDefault(),s.stopPropagation();const n=Number(this.renderer.getAttribute(l.id,"originX")),a=Number(this.renderer.getAttribute(l.id,"originY")),d=s.clientX-n,h=s.clientY-a;this.renderer.setAttribute(l.id,"transform",`translate(${d},${h})`);const c={width:u.width,height:u.height,x:u.x+d,y:u.y+h};this.renderer.removeSymbol(`connection-${l.id}`),this.renderer.drawConnectionBetweenBox(`connection-${l.id}`,i,c,{stroke:r,debug:"recognition-box-link"})};p.addEventListener("pointerdown",(i=>{i.preventDefault(),i.stopPropagation(),this.renderer.getAttribute(l.id,"originX")||(this.renderer.setAttribute(l.id,"originX",i.clientX.toString()),this.renderer.setAttribute(l.id,"originY",i.clientY.toString())),this.renderer.layer.addEventListener("pointermove",translateEl),this.renderer.layer.addEventListener("pointerup",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl))),this.renderer.layer.addEventListener("pointerleave",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl))),this.renderer.layer.addEventListener("pointercancel",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl)))}))}showRecognitionBox(){var i,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,ot,"f").info("showRecognitionBox"),yield this.behaviors.export(["application/vnd.myscript.jiix"]);const r=null===(i=this.model.exports)||void 0===i?void 0:i["application/vnd.myscript.jiix"];if(__classPrivateFieldGet(this,ot,"f").debug("showRecognitionBox",{jiix:r}),r){if(!r["bounding-box"])return void __classPrivateFieldGet(this,ot,"f").warn("drawRecognitionBox",'You must to enabled configuration.recognition.exports["bounding-box"]');null===(s=r.elements)||void 0===s||s.forEach((i=>{var s;switch(i.type){case"Node":if(i["bounding-box"]){const s=convertBoundingBoxMillimeterToPixel(i["bounding-box"]),r=["bounding-box","items","id"],n=Object.keys(i).filter((i=>!r.includes(i))).map((s=>`${s}: ${JSON.stringify(i[s])}`));this.drawRecognitionBox(s,n)}break;case"Text":null===(s=i.words)||void 0===s||s.forEach((s=>{if(null==s?void 0:s["bounding-box"]){const r=convertBoundingBoxMillimeterToPixel(s["bounding-box"]);this.drawRecognitionBox(r,[`type: ${i.type}`,`candidates: ${JSON.stringify(s.candidates||[])}`])}}));break;case"Edge":if(i.kind===ne.PolyEdge){const s=[`type: ${i.type}`,`kind: ${i.kind}`];i.edges.forEach(((i,r)=>{let n=`edge-${r}: [{ x1: ${i.x1}, y2: ${i.y1} },{ x2: ${i.x2}, y2: ${i.y2} }]`;i.p1Decoration&&(n+=`, p1Decoration: ${i.p1Decoration}`),i.p2Decoration&&(n+=`, p2Decoration: ${i.p2Decoration}`),s.push(n)}));const r=convertBoundingBoxMillimeterToPixel(Box.createFromBoxes(i.edges.map((i=>i["bounding-box"]))));this.drawRecognitionBox(r,s)}else if(i["bounding-box"]){const s=convertBoundingBoxMillimeterToPixel(i["bounding-box"]),r=["bounding-box","items","id","ports","connected"],n=Object.keys(i).filter((i=>!r.includes(i))).map((s=>`${s}: ${JSON.stringify(i[s])}`));this.drawRecognitionBox(s,n)}break;default:__classPrivateFieldGet(this,ot,"f").warn("drawRecognitionBox",`Unknow jiix element type: ${i.type}`)}}))}}))}clearRecognitionBox(){__classPrivateFieldGet(this,ot,"f").info("clearRecognitionBox"),this.renderer.clearElements({attrs:{debug:"recognition-box"}}),this.renderer.clearElements({attrs:{debug:"recognition-box-link"}})}debugRecognitionBox(){return __awaiter(this,void 0,void 0,(function*(){this.clearRecognitionBox(),__classPrivateFieldGet(this,ht,"f")&&this.showRecognitionBox()}))}drawRecognitionItemBox(i,s,r){const n="blue",a=SVGBuilder.createGroup({debug:"recognition-item-box"}),l=SVGBuilder.createRect(i,{fill:"transparent",stroke:n,style:ze.noSelection});a.appendChild(l);const d=i.x;let h=i.y-14;const c=SVGBuilder.createGroup({id:`chars-group-${createUUID()}`});s&&c.appendChild(SVGBuilder.createText({x:d,y:h},`label: ${s}`,{fill:n,"font-size":14..toString(),style:ze.noSelection})),(null==r?void 0:r.length)&&(h+=14,c.appendChild(SVGBuilder.createText({x:d,y:h},`[${r.join(", ")}]`,{fill:n,"font-size":14..toString(),style:ze.noSelection}))),a.appendChild(c),this.renderer.layer.appendChild(a);const u=c.getBBox(),p={width:u.width+10,height:u.height+10,x:u.x-5,y:u.y-5},m=SVGBuilder.createRect(p,{fill:"white",style:"cursor:move",stroke:n});c.prepend(m);const translateEl=s=>{s.preventDefault(),s.stopPropagation();const r=Number(this.renderer.getAttribute(c.id,"originX")),a=Number(this.renderer.getAttribute(c.id,"originY")),l=s.clientX-r,d=s.clientY-a;this.renderer.setAttribute(c.id,"transform",`translate(${l},${d})`);const h={width:p.width,height:p.height,x:p.x+l,y:p.y+d};this.renderer.removeSymbol(`connection-${c.id}`),this.renderer.drawConnectionBetweenBox(`connection-${c.id}`,i,h,{stroke:n,debug:"recognition-item-box-link"})};m.addEventListener("pointerdown",(i=>{i.preventDefault(),i.stopPropagation(),this.renderer.getAttribute(c.id,"originX")||(this.renderer.setAttribute(c.id,"originX",i.clientX.toString()),this.renderer.setAttribute(c.id,"originY",i.clientY.toString())),this.renderer.layer.addEventListener("pointermove",translateEl)})),this.renderer.layer.addEventListener("pointerup",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl))),this.renderer.layer.addEventListener("pointerleave",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl))),this.renderer.layer.addEventListener("pointercancel",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl)))}showRecognitionItemBox(){var i,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,ot,"f").info("showRecognitionBoxItem"),yield this.behaviors.export(["application/vnd.myscript.jiix"]);const r=null===(i=this.model.exports)||void 0===i?void 0:i["application/vnd.myscript.jiix"];__classPrivateFieldGet(this,ot,"f").debug("showRecognitionBoxItem",{jiix:r}),r&&(null===(s=r.elements)||void 0===s||s.forEach((i=>{var s;switch(i.type){case"Text":null===(s=i.chars)||void 0===s||s.forEach((i=>{if(null==i?void 0:i["bounding-box"]){const s=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);this.drawRecognitionItemBox(s,i.label,i.candidates)}}));break;case"Node":if(null==i?void 0:i["bounding-box"]){const s=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);this.drawRecognitionItemBox(s,i.kind)}break;case"Edge":if(i.kind===ne.PolyEdge)i.edges.forEach((i=>{const s=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);this.drawRecognitionItemBox(s,i.kind)}));else if(i["bounding-box"]){const s=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);this.drawRecognitionItemBox(s,i.kind)}break;default:__classPrivateFieldGet(this,ot,"f").warn("drawRecognitionBoxItem",`Unknow jiix element type: ${i.type}`)}})))}))}clearRecognitionItemBox(){__classPrivateFieldGet(this,ot,"f").info("clearRecognitionBoxItem"),this.renderer.clearElements({attrs:{debug:"recognition-item-box"}}),this.renderer.clearElements({attrs:{debug:"recognition-item-box-link"}})}debugRecognitionItemBox(){return __awaiter(this,void 0,void 0,(function*(){this.clearRecognitionItemBox(),__classPrivateFieldGet(this,ct,"f")&&this.showRecognitionItemBox()}))}apply(){this.debugBoundingBox(),this.debugVertices(),this.debugSnapPoints(),this.debugRecognitionBox(),this.debugRecognitionItemBox()}}ot=new WeakMap,at=new WeakMap,lt=new WeakMap,dt=new WeakMap,ht=new WeakMap,ct=new WeakMap;var ut='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';class OIMenu{constructor(){this.thicknessList=[{label:"S",value:1},{label:"M",value:2},{label:"L",value:4},{label:"XL",value:8}],this.fontSizeList=[{label:"Auto",value:0},{label:"S",value:.5},{label:"M",value:.75},{label:"L",value:1}],this.fontWeightList=[{label:"Auto",value:void 0},{label:"Normal",value:"normal"},{label:"Bold",value:"bold"}],this.colors=["#000000","#808080","#ffffff","transparent","#ff0000","#ff6400","#ffc800","#ffff00","#0000ff","#0064ff","#00c8ff","#00ffff","#008000","#00af00","#00e100","#00ff00"]}createToolTip(i,s,r="top"){i.classList.add("ms-tooltip");const n=document.createElement("span");return n.classList.add("ms-tooltip-content",r),n.textContent=s,i.appendChild(n),i}createWrapCollapsible(i,s){const r=document.createElement("div");r.classList.add("collapsible-wrapper");const n=document.createElement("div");n.classList.add("collapsible-header"),n.textContent=s;const a=document.createElement("span");a.classList.add("collapsible-header-icon"),a.innerHTML=ut,n.appendChild(a),n.style.setProperty("pointer","cursor");const l=document.createElement("div");return l.classList.add("collapsible-content"),n.addEventListener("pointerup",(()=>r.classList.toggle("active"))),r.appendChild(n),l.appendChild(i),r.appendChild(l),r}createSeparatorHorizontal(){const i=document.createElement("hr");return i.classList.add("separator"),i.classList.add("horizontal"),i}createSeparatorVertical(){const i=document.createElement("hr");return i.classList.add("separator"),i.classList.add("vertical"),i}createMenuItemBoolean(i){const s=document.createElement("div");s.classList.add("ms-menu-item",i.type);const r=document.createElement("span");r.textContent=i.label,s.appendChild(r);const n=document.createElement("input");return n.id=i.id,n.setAttribute("type","checkbox"),i.disabled&&(n.disabled=!0),"indeterminate"===i.initValue?n.indeterminate=!0:n.checked=i.initValue,n.addEventListener("change",(s=>i.callback(s.target.checked))),s.appendChild(n),s}createMenuItemSelect(i){const s=document.createElement("div");s.classList.add("ms-menu-item",i.type);const r=document.createElement("span");r.textContent=i.label,s.appendChild(r);const n=document.createElement("select");return n.id=i.id,i.disabled&&(n.disabled=!0),i.values.forEach((s=>{const r=s.value===i.initValue,a=new Option(s.label,s.value.toString(),r,r);n.appendChild(a)})),n.addEventListener("change",(s=>i.callback(s.target.value))),s.appendChild(n),s}createMenuItemButton(i){const s=document.createElement("button");return s.classList.add("ms-menu-item","ms-menu-button"),s.innerHTML=i.icon||i.label,s.addEventListener("pointerup",i.callback),i.tooltip?this.createToolTip(s,i.tooltip.label,i.tooltip.position):s}createMenuItemButtonList(i){const s=document.createElement("div");s.classList.add("ms-menu-item",i.type),s.id=i.id;const r=document.createElement("span");return r.textContent=i.label,s.appendChild(r),i.values.forEach((r=>{const n=document.createElement("button");i.disabled&&(n.disabled=!0),n.id=`${i.id}-${r.value}-btn`,i.initValue===r.value&&n.classList.add("active"),n.textContent=r.label,n.addEventListener("pointerup",(()=>{i.callback(r.value),s.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),n.classList.add("active")})),s.appendChild(n)})),s}createMenuItemColorList(i){const s=document.createElement("div");s.classList.add("ms-menu-item",i.type),s.id=i.id;const r=document.createElement("span");return r.textContent=i.label,s.appendChild(r),s.appendChild(this.createColorList(i)),s}createColorList(i){const s=document.createElement("div");return s.id=`${i.id}-list`,s.classList.add("ms-menu-row","color-list"),i.values.forEach((r=>{const n=document.createElement("button");i.disabled&&(n.disabled=!0),n.id=`${i.id}-${r.replace("#","")}-btn`,n.classList.add("ms-menu-button","square");const a=document.createElement("div");a.classList.add("color"),i.fill?(a.style.setProperty("background-color",r),a.style.setProperty("border","1px solid lightgrey")):(a.style.setProperty("background-color","transparent"),a.style.setProperty("border",`3px solid ${r}`)),"#ffffff"===r&&a.style.setProperty("border","1px solid black"),"transparent"===r&&a.style.setProperty("background-image","linear-gradient(45deg, #AAA 10%, transparent 20%, #AAA 30%, transparent 40%, #AAA 50%, transparent 60%, #AAA 70%, transparent 80%, #AAA 90%, transparent 100%)"),i.initValue===r&&n.classList.add("active"),n.appendChild(a),n.addEventListener("pointerup",(a=>{a.preventDefault(),a.stopPropagation(),i.callback(r),s.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),n.classList.add("active")})),s.appendChild(n)})),s}createMenuItem(i){switch(i.type){case"checkbox":return this.createMenuItemBoolean(i);case"select":return this.createMenuItemSelect(i);case"list":return this.createMenuItemButtonList(i);case"colors":return this.createMenuItemColorList(i);default:return this.createMenuItemButton(i)}}}var pt;class OIMenuSub{constructor(i){if(this.element=document.createElement("div"),this.element.classList.add("sub-menu"),this.element.appendChild(i.trigger),this.content=document.createElement("div"),i.menuTitle){const s=document.createElement("h3");s.classList.add("ms-menu-title"),s.textContent=i.menuTitle,this.content.appendChild(s)}this.content.classList.add("sub-menu-content",i.position),this.content.appendChild(i.subMenu),this.element.appendChild(this.content),i.trigger.addEventListener("pointerdown",(()=>this.toggle())),document.addEventListener("pointerdown",(i=>{this.element.contains(i.target)||this.close()}))}open(){this.content.classList.add("open")}close(){this.content.classList.remove("open")}toggle(){this.content.classList.toggle("open")}unwrap(){this.content.classList.remove("sub-menu-content"),this.element.insertAdjacentElement("beforebegin",this.content),this.element.style.display="none"}wrap(){this.content.classList.add("sub-menu-content"),this.element.appendChild(this.content),this.element.style.display="block"}}class OIMenuAction extends OIMenu{constructor(i,s="ms-menu-action"){super(),pt.set(this,LoggerManager.getLogger(d.MENU)),this.guideGaps=[{label:"S",value:"25"},{label:"M",value:"50"},{label:"L",value:"100"},{label:"XL",value:"150"}],this.id=s,this.behaviors=i}get model(){return this.behaviors.model}get isMobile(){return this.behaviors.renderer.parent.clientWidth<700}createMenuClear(){return this.menuClear=document.createElement("button"),this.menuClear.id=`${this.id}-clear`,this.menuClear.classList.add("ms-menu-button","square"),this.menuClear.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M20 9L18.005 20.3463C17.8369 21.3026 17.0062 22 16.0353 22H7.96474C6.99379 22 6.1631 21.3026 5.99496 20.3463L4 9"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M21 6L15.375 6M3 6L8.625 6M8.625 6V4C8.625 2.89543 9.52043 2 10.625 2H13.375C14.4796 2 15.375 2.89543 15.375 4V6M8.625 6L15.375 6"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuClear.addEventListener("pointerup",(()=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.clear`),this.behaviors.clear()})),this.createToolTip(this.menuClear,"Clear","bottom")}createMenuLanguage(){const i=document.createElement("button");i.id=this.id,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M13 2.04932C13 2.04932 16 5.99994 16 11.9999C16 17.9999 13 21.9506 13 21.9506"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M11 21.9506C11 21.9506 8 17.9999 8 11.9999C8 5.99994 11 2.04932 11 2.04932"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path d="M2.62964 15.5H21.3704" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M2.62964 8.5H21.3704" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const s=document.createElement("select");s.classList.add("select-language"),s.id=`${this.id}-language`,getAvailableLanguageList(this.behaviors.configuration).then((i=>{const r=i.result;Object.keys(r).forEach((i=>{const n=i===this.behaviors.configuration.recognition.lang,a=new Option(r[i],i,n,n);s.appendChild(a)}))})),s.addEventListener("change",(i=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.selectLanguage`);const s=i.target.value;this.behaviors.changeLanguage(s)}));const r={trigger:i,subMenu:s,position:"bottom-right"};return this.menuLanguage=new OIMenuSub(r),this.menuLanguage.element}createMenuUndo(){return this.menuUndo=document.createElement("button"),this.menuUndo.id=`${this.id}-undo`,this.menuUndo.classList.add("ms-menu-button","square"),this.menuUndo.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M4.5 8C8.5 8 11 8 15 8C15 8 15 8 15 8C15 8 20 8 20 12.7059C20 18 15 18 15 18C11.5714 18 9.71429 18 6.28571 18"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M7.5 11.5C6.13317 10.1332 5.36683 9.36683 4 8C5.36683 6.63317 6.13317 5.86683 7.5 4.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuUndo.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,pt,"f").info(`${this.id}.undo`),yield this.behaviors.undo()})))),this.createToolTip(this.menuUndo,"Undo","bottom")}createMenuRedo(){return this.menuRedo=document.createElement("button"),this.menuRedo.id=`${this.id}-redo`,this.menuRedo.classList.add("ms-menu-button","square"),this.menuRedo.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M19.5 8C15.5 8 13 8 9 8C9 8 9 8 9 8C9 8 4 8 4 12.7059C4 18 9 18 9 18C12.4286 18 14.2857 18 17.7143 18"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M16.5 11.5C17.8668 10.1332 18.6332 9.36683 20 8C18.6332 6.63317 17.8668 5.86683 16.5 4.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuRedo.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,pt,"f").info(`${this.id}.redo`),yield this.behaviors.redo()})))),this.createToolTip(this.menuRedo,"Redo","bottom")}createMenuConvert(){return this.menuConvert=document.createElement("button"),this.menuConvert.id=`${this.id}-convert`,this.menuConvert.classList.add("ms-menu-button","square"),this.menuConvert.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M2 5H9M16 5H13.5M9 5L13.5 5M9 5V3M13.5 5C12.6795 7.73513 10.9612 10.3206 9 12.5929M4 17.5C5.58541 16.1411 7.376 14.4744 9 12.5929M9 12.5929C8 11.5 6.4 9.3 6 8.5M9 12.5929L12 15.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M13.5 21L14.6429 18M21.5 21L20.3571 18M14.6429 18L17.5 10.5L20.3571 18M14.6429 18H20.3571"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuConvert.addEventListener("pointerup",(()=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.convert`),this.behaviors.convert()})),this.createToolTip(this.menuConvert,"Convert","bottom")}createMenuGesture(){const r=document.createElement("button");r.id=`${this.id}-gesture`,r.classList.add("ms-menu-button","square"),r.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M18 7.5L18.9187 7.65312C20.0497 7.84162 20.791 8.94046 20.5423 10.0598L20.0143 12.4357C20.0048 12.4784 20 12.5223 20 12.5661C20 15.1904 20 17.5 20 17.5C20 17.5 20 17.5 20 17.5C20 19.5 18.4 21.5 16 21.5C14.1259 21.5 11.0119 21.5 9.41979 21.5C8.83594 21.5 8.28132 21.2449 7.90136 20.8016L3.35288 15.495C2.85811 14.9178 2.84375 14.0703 3.31868 13.4767V13.4767C3.93438 12.707 5.09624 12.6814 5.74526 13.4231L8 16V12.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M9 5L8.20966 5.13172C7.03189 5.32802 6.28739 6.50588 6.61542 7.65395L8 12.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M11 12.5L8.92263 4.60598C8.69579 3.744 9.25886 2.87352 10.1381 2.72699V2.72699C10.9097 2.59838 11.6523 3.07873 11.8514 3.83526L14 12"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M17 12.5L18 7.5L18.2475 6.01515C18.3869 5.17836 17.8216 4.38694 16.9848 4.24747V4.24747C16.16 4.11 15.3767 4.65763 15.2226 5.47955L14 12"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n';const n=document.createElement("div");n.classList.add("ms-menu-colmun");const a=[];for(const i in We){const s=We[i];a.push({label:i,value:s})}const l=[];for(const i in Ye){const s=Ye[i];l.push({label:i,value:s})}const d=[];for(const i in Xe){const s=Xe[i];d.push({label:i,value:s})}[{type:"checkbox",id:`${this.id}-gesture-detect`,label:"Detect gesture",initValue:this.behaviors.writer.detectGesture,callback:r=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.gesture-detect`,{value:r}),this.behaviors.writer.detectGesture=r,this.behaviors.intention=i.Write,this.behaviors.writer.tool=s.Pencil}},{type:"select",id:`${this.id}-gesture-surround`,label:"On surround",values:a,initValue:this.behaviors.gesture.surroundAction,callback:r=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.gesture-surround`,{value:r}),this.behaviors.gesture.surroundAction=r,this.behaviors.intention=i.Write,this.behaviors.writer.tool=s.Pencil}},{type:"select",id:`${this.id}-gesture-strikethrough`,label:"On strikethrough",values:l,initValue:this.behaviors.gesture.strikeThroughAction,callback:r=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.gesture-strikethrough`,{value:r}),this.behaviors.gesture.strikeThroughAction=r,this.behaviors.intention=i.Write,this.behaviors.writer.tool=s.Pencil}},{type:"select",id:`${this.id}-gesture-strikethrough`,label:"On insert",values:d,initValue:this.behaviors.gesture.insertAction,callback:r=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.gesture-InsertAction`,{value:r}),this.behaviors.gesture.insertAction=r,this.behaviors.intention=i.Write,this.behaviors.writer.tool=s.Pencil}}].forEach((i=>{n.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:r,menuTitle:"Gesture",subMenu:n,position:"right-top"}).element}createMenuGuide(){const i=document.createElement("button");i.id=`${this.id}-guide`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 21V3H21V21H3Z" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 16.5H12H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 12H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 7.5H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M16.5 3V12V21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M12 3V21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M7.5 3V21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const s=document.createElement("div");s.classList.add("ms-menu-colmun");[{type:"checkbox",id:`${this.id}-guide-enable`,label:"Show guide",initValue:this.behaviors.configuration.rendering.guides.enable,callback:i=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.guide-enable`,{value:i}),this.behaviors.configuration.rendering.guides.enable=i,this.behaviors.renderingConfiguration=this.behaviors.configuration.rendering}},{type:"select",id:`${this.id}-guide-type`,label:"Guide style",values:[{label:"Line",value:"line"},{label:"Grid",value:"grid"},{label:"Point",value:"point"}],initValue:this.behaviors.configuration.rendering.guides.type,callback:i=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.guide-type`,{value:i}),this.behaviors.configuration.rendering.guides.type=i,this.behaviors.renderingConfiguration=this.behaviors.configuration.rendering}},{type:"list",id:`${this.id}-guide-size`,label:"Guide style",values:this.guideGaps,initValue:this.behaviors.configuration.rendering.guides.gap.toString(),callback:i=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.guide-size`,{value:i}),this.behaviors.configuration.rendering.guides.gap=+i,this.behaviors.renderingConfiguration=this.behaviors.configuration.rendering}}].forEach((i=>{s.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:i,menuTitle:"Guide",subMenu:s,position:"right-top"}).element}createMenuSnap(){const i=document.createElement("button");i.id=`${this.id}-snap`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M 19 14 C 17.8954 14 17 13.1046 17 12 C 17 10.8954 17.8954 10 19 10 C 20.1046 10 21 10.8954 21 12 C 21 13.1046 20.1046 14 19 14 Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path d="M 4 12 H 17 M 17 12 L 14 9 M 17 12 L 14 15" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const s=document.createElement("div");s.classList.add("ms-menu-colmun");[{type:"checkbox",id:`${this.id}-snap-to-guide`,label:"Snap to guide",initValue:this.behaviors.snaps.snapToGrid,callback:i=>this.behaviors.snaps.snapToGrid=i},{type:"checkbox",id:`${this.id}-snap-to-element`,label:"Snap to element",initValue:this.behaviors.snaps.snapToElement,callback:i=>this.behaviors.snaps.snapToElement=i},{type:"select",id:`${this.id}-snap-angle`,label:"Snap angle",values:[{label:"None",value:"0"},{label:"10",value:"10"},{label:"30",value:"30"},{label:"45",value:"45"},{label:"90",value:"90"},{label:"180",value:"180"}],initValue:this.behaviors.snaps.snapAngle.toString(),callback:i=>this.behaviors.snaps.snapAngle=+i}].forEach((i=>{s.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:i,menuTitle:"Snap",subMenu:s,position:"right-top"}).element}createMenuDebug(){const i=document.createElement("button");i.id=`${this.id}-debug`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  stroke-width="1"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M5.81249 7C5.81249 7 5.35861 7.62759 4.81552 8.66667M18.1875 7C18.1875 7 18.6414 7.62759 19.1845 8.66667M4.81552 8.66667C4.0067 10.2142 3 12.6743 3 15.3333C5.8125 15.3333 7.49999 17 7.49999 17C7.49999 17 8.62499 22 12 22C15.375 22 16.5 17 16.5 17C16.5 17 18.1875 15.3333 21 15.3333C21 12.6743 19.9933 10.2142 19.1845 8.66667M4.81552 8.66667C4.81552 8.66667 1.875 6.44436 4.81552 2C5.81249 2.55556 8.625 4.77778 8.625 4.77778C8.625 4.77778 10.3125 3.66667 12 3.66667C13.6875 3.66667 15.375 4.77778 15.375 4.77778C15.375 4.77778 18.1875 2.55556 19.3125 2C22.125 6.44456 19.1845 8.66667 19.1845 8.66667"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path d="M11 18L12 18M13 18L12 18M12 18L12 19" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M8.5 12.5L10 14" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M15.5 12.5L14 14" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const s=[{type:"checkbox",id:`${this.id}-debug-bounding-box`,label:"Show bounding box",initValue:this.behaviors.svgDebugger.boundingBoxVisibility,callback:i=>this.behaviors.svgDebugger.boundingBoxVisibility=i},{type:"checkbox",id:`${this.id}-debug-recognition-box`,label:"Show recognition box",initValue:this.behaviors.svgDebugger.recognitionBoxVisibility,callback:i=>this.behaviors.svgDebugger.recognitionBoxVisibility=i},{type:"checkbox",id:`${this.id}-debug-bounding-item-box`,label:"Show recognition item box",initValue:this.behaviors.svgDebugger.recognitionItemBoxVisibility,callback:i=>this.behaviors.svgDebugger.recognitionItemBoxVisibility=i},{type:"checkbox",id:`${this.id}-debug-snap-points`,label:"Show snap points",initValue:this.behaviors.svgDebugger.snapPointsVisibility,callback:i=>this.behaviors.svgDebugger.snapPointsVisibility=i},{type:"checkbox",id:`${this.id}-debug-vertices`,label:"Show vertices",initValue:this.behaviors.svgDebugger.verticesVisibility,callback:i=>this.behaviors.svgDebugger.verticesVisibility=i}],r=document.createElement("div");r.classList.add("ms-menu-colmun"),s.forEach((i=>{r.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:i,menuTitle:"Debug",subMenu:r,position:"right-top"}).element}createMenuExport(){const i=document.createElement("button");i.id=`${this.id}-export`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="#000000"\n>\n  <path d="M6 20L18 20" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M12 4V16M12 16L15.5 12.5M12 16L8.5 12.5" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const s=[{type:"button",id:`${this.id}-export-json`,label:"json",callback:()=>{this.behaviors.downloadAsJson()}},{type:"button",id:`${this.id}-export-svg`,label:"svg",callback:()=>{this.behaviors.downloadAsSVG()}},{type:"button",id:`${this.id}-export-png`,label:"png",callback:()=>{this.behaviors.downloadAsPNG()}}],r=document.createElement("div");r.classList.add("ms-menu-colmun"),s.forEach((i=>{r.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:i,menuTitle:"Export",subMenu:r,position:"right-top"}).element}readFileAsText(i){return __awaiter(this,void 0,void 0,(function*(){return new Promise(((s,r)=>{const n=new FileReader;n.onerror=r,n.onload=()=>{s(n.result)},i&&n.readAsText(i)}))}))}createMenuImport(){const i=document.createElement("button");i.id=`${this.id}-import`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="#000000"\n>\n  <path d="M6 20L18 20" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M12 16V4M12 4L15.5 7.5M12 4L8.5 7.5" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const s=document.createElement("div");s.classList.add("ms-menu-colmun");const r=document.createElement("input");r.type="file",r.accept=".json",r.multiple=!1,r.addEventListener("change",(()=>{var i;n.disabled=!(null===(i=r.files)||void 0===i?void 0:i.length)})),s.appendChild(r);const n=document.createElement("button");n.classList.add("ms-menu-button"),n.innerText="Import",n.disabled=!0,s.appendChild(n),n.addEventListener("pointerup",(i=>__awaiter(this,void 0,void 0,(function*(){var s;i.preventDefault(),i.stopPropagation();try{if(null===(s=r.files)||void 0===s?void 0:s.length){const i=yield this.readFileAsText(r.files[0]),s=JSON.parse(i);yield this.behaviors.createSymbols(s),r.value="",n.disabled=!0}}catch(i){this.behaviors.internalEvent.emitError(new Error(i))}}))));return new OIMenuSub({trigger:i,menuTitle:"Import",subMenu:s,position:"right-top"}).element}unselectAll(){var i;null===(i=this.wrapper)||void 0===i||i.querySelectorAll("*").forEach((i=>i.classList.remove("active")))}closeAllSubMenu(){var i;null===(i=this.wrapper)||void 0===i||i.querySelectorAll(".open").forEach((i=>i.classList.remove("open")))}render(i){if(this.behaviors.configuration.menu.action.enable){const s=document.createElement("button");s.id=this.id,s.classList.add("ms-menu-button","square"),s.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 5H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 12H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 19H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const r=document.createElement("div");r.classList.add("ms-menu-colmun"),r.appendChild(this.createMenuGesture()),r.appendChild(this.createMenuGuide()),r.appendChild(this.createMenuSnap()),r.appendChild(this.createMenuDebug()),r.appendChild(this.createMenuImport()),r.appendChild(this.createMenuExport()),this.wrapper=document.createElement("div"),this.wrapper.classList.add("ms-menu","ms-menu-top-left","ms-menu-row"),this.wrapper.appendChild(new OIMenuSub({trigger:s,subMenu:r,position:"bottom"}).element),this.wrapper.appendChild(this.createMenuLanguage()),this.wrapper.appendChild(this.createMenuClear()),this.wrapper.appendChild(this.createMenuUndo()),this.wrapper.appendChild(this.createMenuRedo()),this.wrapper.appendChild(this.createMenuConvert()),i.appendChild(this.wrapper),this.update(),this.show()}}update(){this.menuLanguage&&(this.isMobile?this.menuLanguage.wrap():this.menuLanguage.unwrap()),this.menuClear&&(this.menuClear.disabled=this.behaviors.history.context.empty),this.menuUndo&&(this.menuUndo.disabled=!this.behaviors.history.context.canUndo),this.menuRedo&&(this.menuRedo.disabled=!this.behaviors.history.context.canRedo),this.menuConvert&&(this.menuConvert.disabled=!this.behaviors.extractStrokesFromSymbols(this.model.symbols).length)}show(){this.wrapper&&(this.wrapper.style.visibility="visible")}hide(){this.wrapper&&(this.wrapper.style.visibility="hidden")}destroy(){if(this.wrapper){for(;this.wrapper.lastChild;)this.wrapper.removeChild(this.wrapper.lastChild);this.wrapper.remove(),this.wrapper=void 0,this.menuClear=void 0,this.menuUndo=void 0,this.menuRedo=void 0,this.menuConvert=void 0}}}pt=new WeakMap;var mt,vt='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M 21 5 V 17.986 C 21 19 21 19 20 19 H 4 C 3 19 3 19 3.015 17.986 V 5 C 3 4 3 4 4 4 H 20.4 C 21 4 21 4 21 5 Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',gt='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 20L21 4" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';class OIMenuIntention extends OIMenu{constructor(i,s="ms-menu-intention"){super(),mt.set(this,LoggerManager.getLogger(d.MENU)),this.id=s,__classPrivateFieldGet(this,mt,"f").info("constructor"),this.behaviors=i}createMenuWrite(){return this.writeBtn=document.createElement("button"),this.writeBtn.id=`${this.id}-write-pencil`,this.writeBtn.classList.add("ms-menu-button","square"),this.writeBtn.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M14.3632 5.65156L15.8431 4.17157C16.6242 3.39052 17.8905 3.39052 18.6716 4.17157L20.0858 5.58579C20.8668 6.36683 20.8668 7.63316 20.0858 8.41421L18.6058 9.8942M14.3632 5.65156L4.74749 15.2672C4.41542 15.5993 4.21079 16.0376 4.16947 16.5054L3.92738 19.2459C3.87261 19.8659 4.39148 20.3848 5.0115 20.33L7.75191 20.0879C8.21972 20.0466 8.65806 19.8419 8.99013 19.5099L18.6058 9.8942M14.3632 5.65156L18.6058 9.8942"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.writeBtn.addEventListener("pointerup",(()=>{this.unselectAll(),this.writeBtn.classList.add("active"),this.behaviors.intention=i.Write,this.behaviors.writer.tool=s.Pencil})),this.createToolTip(this.writeBtn,"Write")}createMenuMove(){return this.menuMove=document.createElement("button"),this.menuMove.id=`${this.id}-move`,this.menuMove.classList.add("ms-menu-button","square"),this.menuMove.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M7 10.5L4.99591 13.1721C4.41845 13.9421 4.47127 15.0141 5.1216 15.7236L8.9055 19.8515C9.28432 20.2647 9.81826 20.5 10.3789 20.5C11.4651 20.5 13.2415 20.5 15 20.5C17.4 20.5 19 19 19 16.5C19 16.5 19 16.5 19 16.5C19 16.5 19 9.64287 19 7.92859"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M16 8.49995C16 8.49995 16 8.37483 16 7.92852C16 5.6428 19 5.6428 19 7.92852"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M13 8.50008C13 8.50008 13 7.91978 13 7.02715M13 6.50008C13 6.50008 13 6.804 13 7.02715M16 8.50008C16 8.50008 16 8.37496 16 7.92865C16 7.70549 16 7.25031 16 7.02715C16 4.74144 13 4.74144 13 7.02715"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M13 8.50008C13 8.50008 13 7.91978 13 7.02715C13 4.74144 16 4.74144 16 7.02715C16 7.25031 16 7.70549 16 7.92865C16 8.37496 16 8.50008 16 8.50008"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M10 8.50005C10 8.50005 10 7.85719 10 6.50005C10 4.21434 13 4.21434 13 6.50005C13 6.50005 13 6.50005 13 6.50005C13 6.50005 13 6.80397 13 7.02713C13 7.91975 13 8.50005 13 8.50005"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M7 13.5001V6.50006C7 5.67164 7.67157 5.00006 8.5 5.00006V5.00006C9.32843 5.00006 10 5.55527 10 6.38369C10 6.42151 10 6.4603 10 6.50006C10 7.85721 10 8.50006 10 8.50006"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuMove.addEventListener("pointerup",(()=>{this.unselectAll(),this.menuMove.classList.add("active"),this.behaviors.intention=i.Move})),this.createToolTip(this.menuMove,"Move")}createMenuSelect(){return this.menuSelect=document.createElement("button"),this.menuSelect.id=`${this.id}-select`,this.menuSelect.classList.add("ms-menu-button","square"),this.menuSelect.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M4.9984 2H2V4.9984H4.9984V2Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M4.99854 3.50098H18.9987"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path d="M3.5 4.99854V19.0005" stroke="currentColor" stroke-width="1" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M20.4978 5V19.002" stroke="currentColor" stroke-width="1" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M4.99854 20.501H18.9987" stroke="currentColor" stroke-width="1" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path\n    d="M4.9984 19H2V21.9984H4.9984V19Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M21.9974 2.00195H18.999V5.00035H21.9974V2.00195Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M21.9974 19.002H18.999V22.0004H21.9974V19.002Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    fill-rule="evenodd"\n    clip-rule="evenodd"\n    d="M10.9966 15.002L7.99658 8.00195L14.9966 11.002L11.9986 12.0009L10.9966 15.002Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    fill-rule="evenodd"\n    clip-rule="evenodd"\n    d="M11.999 12.002L14.997 15.002L11.999 12.002Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuSelect.addEventListener("pointerup",(()=>{this.unselectAll(),this.menuSelect.classList.add("active"),this.behaviors.intention=i.Select})),this.createToolTip(this.menuSelect,"Select")}createMenuErase(){return this.menuErase=document.createElement("button"),this.menuErase.id=`${this.id}-erase`,this.menuErase.classList.add("ms-menu-button","square"),this.menuErase.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M21 21L9 21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M15.889 14.8891L8.46436 7.46448" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path\n    d="M2.8934 12.6066L12.0858 3.41421C12.8668 2.63317 14.1332 2.63317 14.9142 3.41421L19.864 8.36396C20.645 9.14501 20.645 10.4113 19.864 11.1924L10.6213 20.435C10.2596 20.7968 9.76894 21 9.25736 21C8.74577 21 8.25514 20.7968 7.8934 20.435L2.8934 15.435C2.11235 14.654 2.11235 13.3877 2.8934 12.6066Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuErase.addEventListener("pointerup",(()=>{this.unselectAll(),this.menuErase.classList.add("active"),this.behaviors.intention=i.Erase})),this.createToolTip(this.menuErase,"Erase")}createShapeSubMenu(s,r){const n=document.createElement("button");return n.id=`${this.id}-write-shape-${r}`,n.classList.add("ms-menu-button","square"),n.innerHTML=s,n.addEventListener("pointerup",(()=>{this.unselectAll(),this.behaviors.intention=i.Write,this.behaviors.writer.tool=r,n.classList.add("active"),this.menuShape.innerHTML=s,this.menuShape.classList.add("active");const a=this.menuShape.nextSibling;a&&a.classList.remove("open")})),this.createToolTip(n,r.toString())}createMenuShape(){this.menuShape=document.createElement("button"),this.menuShape.id=`${this.id}-write-shape`,this.menuShape.classList.add("ms-menu-button","square"),this.menuShape.innerHTML=vt,this.subMenuShape={circle:this.createShapeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',s.Circle),rectangle:this.createShapeSubMenu(vt,s.Rectangle),triangle:this.createShapeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M11.4752 2.94682C11.7037 2.53464 12.2963 2.53464 12.5248 2.94682L21.8985 19.8591C22.1202 20.259 21.831 20.75 21.3738 20.75H2.62625C2.16902 20.75 1.87981 20.259 2.10146 19.8591L11.4752 2.94682Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',s.Triangle),ellipse:this.createShapeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M 12 19 C 18 19 22 17 22 12 C 22 7 18 5 12 5 C 6 5 2 7 2 12 C 2 17 6 19 12 19 Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',s.Ellipse),rhombus:this.createShapeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M11.5757 1.42426C11.81 1.18995 12.1899 1.18995 12.4243 1.42426L22.5757 11.5757C22.81 11.81 22.8101 12.1899 22.5757 12.4243L12.4243 22.5757C12.19 22.81 11.8101 22.8101 11.5757 22.5757L1.42426 12.4243C1.18995 12.19 1.18995 11.8101 1.42426 11.5757L11.5757 1.42426Z"\n    stroke="#000000"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',s.Rhombus)};const i=document.createElement("div");i.id=`${this.id}-write-shape-list`,i.classList.add("ms-menu-row","sub-menu-content-shape"),i.appendChild(this.subMenuShape.rectangle),i.appendChild(this.subMenuShape.circle),i.appendChild(this.subMenuShape.ellipse),i.appendChild(this.subMenuShape.triangle),i.appendChild(this.subMenuShape.rhombus);const r={trigger:this.menuShape,subMenu:i,position:"top"};return new OIMenuSub(r).element}createEdgeSubMenu(s,r){const n=document.createElement("button");return n.id=`${this.id}-write-edge-${r}`,n.classList.add("ms-menu-button","square"),n.innerHTML=s,n.addEventListener("pointerup",(()=>{this.unselectAll(),this.behaviors.intention=i.Write,this.behaviors.writer.tool=r,n.classList.add("active"),this.menuEdge.innerHTML=s,this.menuEdge.classList.add("active");const a=this.menuEdge.nextSibling;a&&a.classList.remove("open")})),this.createToolTip(n,r.toString())}createMenuEdge(){this.menuEdge=document.createElement("button"),this.menuEdge.id=`${this.id}-write-edge`,this.menuEdge.classList.add("ms-menu-button","square"),this.menuEdge.innerHTML=gt,this.subMenuEdge={line:this.createEdgeSubMenu(gt,s.Line),arrow:this.createEdgeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 20L21 4" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M15 5L21 4L 20 10" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n',s.Arrow),doubleArrow:this.createEdgeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 20L21 4" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M9 19L3 20L 4 14" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M15 5L21 4L 20 10" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n',s.DoubleArrow)};const i=document.createElement("div");i.id=`${this.id}-write-edge-list`,i.classList.add("ms-menu-row","sub-menu-content-edge"),i.appendChild(this.subMenuEdge.line),i.appendChild(this.subMenuEdge.arrow),i.appendChild(this.subMenuEdge.doubleArrow);const r={trigger:this.menuEdge,subMenu:i,position:"top"};return new OIMenuSub(r).element}unselectAll(){var i;null===(i=this.wrapper)||void 0===i||i.querySelectorAll("*").forEach((i=>i.classList.remove("active")))}update(){var r,n,a,l,d,h,c,u,p,m,v,g,y,f,b,x,w,S,_,P,k,E,M,G,C;switch(this.unselectAll(),this.behaviors.intention){case i.Erase:null===(r=this.menuErase)||void 0===r||r.classList.add("active");break;case i.Move:null===(n=this.menuMove)||void 0===n||n.classList.add("active");break;case i.Select:null===(a=this.menuSelect)||void 0===a||a.classList.add("active");break;case i.Write:switch(this.behaviors.writer.tool){case s.Circle:null===(l=this.menuShape)||void 0===l||l.classList.add("active"),null===(h=null===(d=this.subMenuShape)||void 0===d?void 0:d.circle)||void 0===h||h.classList.add("active");break;case s.Ellipse:null===(c=this.menuShape)||void 0===c||c.classList.add("active"),null===(p=null===(u=this.subMenuShape)||void 0===u?void 0:u.ellipse)||void 0===p||p.classList.add("active");break;case s.Triangle:null===(m=this.menuShape)||void 0===m||m.classList.add("active"),null===(g=null===(v=this.subMenuShape)||void 0===v?void 0:v.triangle)||void 0===g||g.classList.add("active");break;case s.Rectangle:null===(y=this.menuShape)||void 0===y||y.classList.add("active"),null===(b=null===(f=this.subMenuShape)||void 0===f?void 0:f.rectangle)||void 0===b||b.classList.add("active");break;case s.Line:null===(x=this.menuEdge)||void 0===x||x.classList.add("active"),null===(S=null===(w=this.subMenuEdge)||void 0===w?void 0:w.line)||void 0===S||S.classList.add("active");break;case s.Arrow:null===(_=this.menuEdge)||void 0===_||_.classList.add("active"),null===(k=null===(P=this.subMenuEdge)||void 0===P?void 0:P.arrow)||void 0===k||k.classList.add("active");break;case s.DoubleArrow:null===(E=this.menuEdge)||void 0===E||E.classList.add("active"),null===(G=null===(M=this.subMenuEdge)||void 0===M?void 0:M.doubleArrow)||void 0===G||G.classList.add("active");break;default:null===(C=this.writeBtn)||void 0===C||C.classList.add("active")}}}render(i){this.behaviors.configuration.menu.intention.enable&&(this.wrapper=document.createElement("div"),this.wrapper.classList.add("ms-menu","ms-menu-bottom","ms-menu-row"),this.wrapper.appendChild(this.createMenuWrite()),this.wrapper.appendChild(this.createMenuMove()),this.wrapper.appendChild(this.createMenuSelect()),this.wrapper.appendChild(this.createMenuErase()),this.wrapper.appendChild(this.createMenuEdge()),this.wrapper.appendChild(this.createMenuShape()),i.appendChild(this.wrapper),this.update(),this.show())}show(){this.wrapper&&(this.wrapper.style.visibility="visible")}hide(){this.wrapper&&(this.wrapper.style.visibility="hidden")}destroy(){if(this.wrapper){for(;this.wrapper.lastChild;)this.wrapper.removeChild(this.wrapper.lastChild);this.wrapper.remove(),this.writeBtn=void 0,this.menuSelect=void 0,this.menuMove=void 0,this.menuErase=void 0,this.menuShape=void 0,this.subMenuShape=void 0,this.menuEdge=void 0,this.subMenuEdge=void 0,this.wrapper=void 0}}}mt=new WeakMap;var yt,ft,bt;class OIMenuStyle extends OIMenu{constructor(i,s="ms-menu-style"){super(),yt.set(this,LoggerManager.getLogger(d.MENU)),this.id=s,__classPrivateFieldGet(this,yt,"f").info("constructor"),this.behaviors=i}get model(){return this.behaviors.model}get symbolsSelected(){return this.model.symbolsSelected}get writeShape(){return![s.Arrow,s.DoubleArrow,s.Line,s.Pencil].includes(this.behaviors.writer.tool)}get rowHeight(){return this.behaviors.configuration.rendering.guides.gap}get isMobile(){return this.behaviors.renderer.parent.clientWidth<700}createMenuStroke(){var i,s;const r=this.symbolsSelected.map((i=>i.style)),n=r.length&&r.every((i=>{var s;return i.color===(null===(s=r[0])||void 0===s?void 0:s.color)})),a=n&&(null===(i=r[0])||void 0===i?void 0:i.color)?null===(s=r[0])||void 0===s?void 0:s.color:this.behaviors.currentPenStyle.color||"rgb(0, 0, 0)",l={type:"colors",label:"Colors",id:`${this.id}-color`,fill:!1,values:this.colors,initValue:a,callback:i=>{this.behaviors.setPenStyle({color:i}),this.behaviors.updateSymbolsStyle(this.symbolsSelected.map((i=>i.id)),{color:i})}},d=this.createColorList(l);return this.menuColorStroke=this.createWrapCollapsible(d,"Colors"),this.menuColorStroke.id=`${this.id}-color`,this.menuColorStroke}createMenuColorFill(){var i,s;const r=this.symbolsSelected.map((i=>i.style)),n=r.length&&r.every((i=>{var s;return i.color===(null===(s=r[0])||void 0===s?void 0:s.color)})),a=n&&(null===(i=r[0])||void 0===i?void 0:i.color)?null===(s=r[0])||void 0===s?void 0:s.color:this.behaviors.currentPenStyle.color||"rgb(0, 0, 0)",l={type:"colors",label:"Fill",id:`${this.id}-fill`,fill:!0,values:this.colors,initValue:a,callback:i=>{this.behaviors.setPenStyle({fill:i}),this.behaviors.updateSymbolsStyle(this.symbolsSelected.map((i=>i.id)),{fill:i})}},d=this.createColorList(l);return this.menuColorFill=this.createWrapCollapsible(d,"Fill"),this.menuColorFill.id=`${this.id}-fill`,this.menuColorFill}createMenuThickness(){var i;const s=document.createElement("div");s.id=`${this.id}-thickness-list`,s.classList.add("ms-menu-row","thickness-list");const r=this.symbolsSelected.map((i=>i.style)),n=r.length&&r.every((i=>{var s;return i.width===(null===(s=r[0])||void 0===s?void 0:s.width)})),a=n?null===(i=r[0])||void 0===i?void 0:i.width:this.behaviors.currentPenStyle.width||2;return this.thicknessList.forEach((i=>{const r=document.createElement("button");r.id=`${this.id}-thickness-${i.label}-btn`,r.classList.add("ms-menu-button","square"),r.textContent=i.label,a===i.value&&r.classList.add("active"),r.addEventListener("pointerup",(n=>{n.preventDefault(),n.stopPropagation(),this.behaviors.setPenStyle({width:i.value}),s.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),r.classList.add("active"),this.symbolsSelected.length&&(this.behaviors.updateSymbolsStyle(this.symbolsSelected.map((i=>i.id)),{width:i.value}),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected))})),s.appendChild(r)})),this.menuThickness=this.createWrapCollapsible(s,"Thickness"),this.menuThickness.id=`${this.id}-thickness`,this.menuThickness}createMenuFontSize(){const i=document.createElement("div");return i.id=`${this.id}-font-size-list`,i.classList.add("ms-menu-row","font-size-list"),this.fontSizeList.forEach((s=>{const r=document.createElement("button");r.id=`${this.id}-font-size-${s.label}-btn`,r.classList.add("ms-menu-button","square"),r.textContent=s.label,(this.behaviors.converter.fontSize||0)===s.value*this.rowHeight&&r.classList.add("active"),r.addEventListener("pointerup",(n=>{if(n.preventDefault(),n.stopPropagation(),i.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),r.classList.add("active"),0===s.value)this.behaviors.converter.fontSize=void 0;else{const i=s.value*this.rowHeight;this.behaviors.converter.fontSize=i;const r=this.symbolsSelected.filter((i=>i.type===be.Text||i.type===be.Group&&i.extractSymbols().some((i=>i.type===be.Text))));this.behaviors.updateTextFontStyle(r.map((i=>i.id)),{fontSize:i}),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}})),i.appendChild(r)})),this.menuFontSize=this.createWrapCollapsible(i,"Font size"),this.menuFontSize.id=`${this.id}-font-size`,this.menuFontSize}createMenuFontWeight(){const i=document.createElement("div");return i.id=`${this.id}-font-weight-list`,i.classList.add("ms-menu-row","font-weight-list"),this.fontWeightList.forEach((s=>{const r=document.createElement("button");r.id=`${this.id}-font-weight-${s.label}-btn`,r.classList.add("ms-menu-button","center"),r.textContent=s.label,this.behaviors.converter.fontWeight===s.value&&r.classList.add("active"),r.addEventListener("pointerup",(n=>{if(n.preventDefault(),n.stopPropagation(),i.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),r.classList.add("active"),this.behaviors.converter.fontWeight=""===s.value?void 0:s.value,this.behaviors.converter.fontWeight){const i=this.symbolsSelected.filter((i=>i.type===be.Text||i.type===be.Group&&i.extractSymbols().some((i=>i.type===be.Text))));this.behaviors.updateTextFontStyle(i.map((i=>i.id)),{fontWeight:this.behaviors.converter.fontWeight}),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}})),i.appendChild(r)})),this.menuFontWeight=this.createWrapCollapsible(i,"Font weight"),this.menuFontWeight.id=`${this.id}-font-weight`,this.menuFontWeight}createMenuOpacity(){var i,s;const r=this.symbolsSelected.map((i=>i.style)),n=r.length&&r.every((i=>{var s;return i.opacity===(null===(s=r[0])||void 0===s?void 0:s.opacity)})),a=100*(n&&(null===(i=r[0])||void 0===i?void 0:i.opacity)?null===(s=r[0])||void 0===s?void 0:s.opacity:this.behaviors.currentPenStyle.opacity||1),l=document.createElement("div");l.id=`${this.id}-opacity-input-wrapper`;const d=document.createElement("input");d.id=`${this.id}-opacity-input`,d.setAttribute("name","opacity"),d.setAttribute("type","range"),d.setAttribute("step","1"),d.setAttribute("min","1"),d.setAttribute("max","100"),l.appendChild(d);const h=document.createElement("output");return h.setAttribute("for","opacity"),h.classList.add("tooltip"),h.innerHTML=a?`${a}`:"-",l.appendChild(h),a&&d.setAttribute("value",a.toString()),d.addEventListener("input",(i=>{const s=i.target.value;h.innerHTML=`${s}%`,this.behaviors.setPenStyle({opacity:s/100}),this.symbolsSelected.length&&this.behaviors.updateSymbolsStyle(this.symbolsSelected.map((i=>i.id)),{opacity:s/100})})),this.menuStrokeOpacity=this.createWrapCollapsible(l,"Opacity"),this.menuStrokeOpacity.id=`${this.id}-opacity`,this.menuStrokeOpacity}render(i){if(this.behaviors.configuration.menu.style.enable){this.triggerBtn=document.createElement("button"),this.triggerBtn.id=this.id,this.triggerBtn.classList.add("ms-menu-button","square"),this.triggerBtn.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M20.5096 9.54C20.4243 9.77932 20.2918 9.99909 20.12 10.1863C19.9483 10.3735 19.7407 10.5244 19.5096 10.63C18.2796 11.1806 17.2346 12.0745 16.5002 13.2045C15.7659 14.3345 15.3733 15.6524 15.3696 17C15.3711 17.4701 15.418 17.9389 15.5096 18.4C15.5707 18.6818 15.5747 18.973 15.5215 19.2564C15.4682 19.5397 15.3588 19.8096 15.1996 20.05C15.0649 20.2604 14.8877 20.4403 14.6793 20.5781C14.4709 20.7158 14.2359 20.8085 13.9896 20.85C13.4554 20.9504 12.9131 21.0006 12.3696 21C11.1638 21.0006 9.97011 20.7588 8.85952 20.2891C7.74893 19.8194 6.74405 19.1314 5.90455 18.2657C5.06506 17.4001 4.40807 16.3747 3.97261 15.2502C3.53714 14.1257 3.33208 12.9252 3.36959 11.72C3.4472 9.47279 4.3586 7.33495 5.92622 5.72296C7.49385 4.11097 9.60542 3.14028 11.8496 3H12.3596C14.0353 3.00042 15.6777 3.46869 17.1017 4.35207C18.5257 5.23544 19.6748 6.49885 20.4196 8C20.6488 8.47498 20.6812 9.02129 20.5096 9.52V9.54Z"\n    stroke="currentColor"\n    stroke-width="1"\n  ></path>\n  <path d="M8 16.01L8.01 15.9989" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M6 12.01L6.01 11.9989" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M8 8.01L8.01 7.99889" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M12 6.01L12.01 5.99889" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M16 8.01L16.01 7.99889" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const s=document.createElement("div");s.classList.add("ms-menu-colmun"),s.appendChild(this.createMenuStroke()),s.appendChild(this.createMenuColorFill()),s.appendChild(this.createMenuThickness()),s.appendChild(this.createMenuFontSize()),s.appendChild(this.createMenuFontWeight()),s.appendChild(this.createMenuOpacity());const r={trigger:this.triggerBtn,subMenu:s,position:"bottom-left"};this.subMenu=new OIMenuSub(r),this.wrapper=document.createElement("div"),this.wrapper.classList.add("ms-menu","ms-menu-top-right"),this.wrapper.appendChild(this.subMenu.element),i.appendChild(this.wrapper),this.update()}}update(){if(this.subMenu&&(this.isMobile?this.subMenu.wrap():this.subMenu.unwrap()),this.behaviors.intention===i.Write)this.show(),this.menuColorStroke&&(this.menuColorStroke.style.display="block"),this.menuColorFill&&(this.menuColorFill.style.display=this.writeShape?"block":"none"),this.menuThickness&&(this.menuThickness.style.display="block"),this.menuFontSize&&(this.menuFontSize.style.display="block"),this.menuFontWeight&&(this.menuFontWeight.style.display="block"),this.menuStrokeOpacity&&(this.menuStrokeOpacity.style.display="block");else if(this.behaviors.intention===i.Select){if(this.show(),this.menuColorStroke&&(this.menuColorStroke.style.display="block"),this.menuColorFill){const i=this.model.symbolsSelected.length&&this.model.symbolsSelected.some((i=>i.type===be.Shape));this.menuColorFill.style.display=i?"block":"none"}this.menuThickness&&(this.menuThickness.style.display="block"),this.menuFontSize&&(this.menuFontSize.style.display="block"),this.menuFontWeight&&(this.menuFontWeight.style.display="block"),this.menuStrokeOpacity&&(this.menuStrokeOpacity.style.display="block")}else this.hide()}show(){this.wrapper&&(this.wrapper.style.visibility="visible")}hide(){this.wrapper&&(this.wrapper.style.visibility="hidden")}destroy(){if(this.wrapper){for(;this.wrapper.lastChild;)this.wrapper.removeChild(this.wrapper.lastChild);this.wrapper.remove(),this.wrapper=void 0,this.subMenu=void 0,this.triggerBtn=void 0,this.menuColorStroke=void 0,this.menuColorFill=void 0,this.menuThickness=void 0,this.menuFontSize=void 0,this.menuFontWeight=void 0,this.menuStrokeOpacity=void 0}}}yt=new WeakMap;class OIMenuContext extends OIMenu{constructor(i,s="ms-menu-context"){super(),ft.set(this,LoggerManager.getLogger(d.MENU)),this.id=s,__classPrivateFieldGet(this,ft,"f").info("constructor"),this.behaviors=i,this.position={x:0,y:0,scrollLeft:0,scrollTop:0}}get symbolsSelected(){return this.behaviors.model.symbolsSelected}get haveSymbolsSelected(){return this.symbolsSelected.length>0}get symbolsDecorable(){return this.symbolsSelected.filter((i=>[be.Stroke.toString(),be.Text.toString(),be.Group.toString()].includes(i.type)))}get showDecorator(){return this.symbolsDecorable.length>0}createMenuEdit(){const i=document.createElement("button");i.id=`${this.id}-edit-trigger`,i.classList.add("ms-menu-button");const s=document.createElement("span");s.innerText="Edit",i.appendChild(s);const r=document.createElement("span");r.style.setProperty("width","32px"),r.style.setProperty("transform","rotate(270deg)"),r.innerHTML=ut,i.appendChild(r);const n=document.createElement("div");n.classList.add("ms-menu-colmun"),this.editInput=document.createElement("input"),n.appendChild(this.editInput),this.editSaveBtn=document.createElement("button"),this.editSaveBtn.classList.add("ms-menu-button"),this.editSaveBtn.innerText="Save",n.appendChild(this.editSaveBtn),this.editSaveBtn.addEventListener("pointerdown",(i=>__awaiter(this,void 0,void 0,(function*(){i.stopPropagation();const s=this.behaviors.model.symbolsSelected.find((i=>i.type===be.Text));if(s){const i=s.chars[0];s.chars=[];for(let r=0;r<this.editInput.value.length;r++)s.chars.push({label:this.editInput.value.charAt(r),id:createUUID(),color:i.color,fontSize:i.fontSize,fontWeight:i.fontWeight,bounds:i.bounds});yield this.behaviors.updateSymbol(s),this.behaviors.selector.resetSelectedGroup([s])}}))));const a={trigger:i,subMenu:n,position:"right"};return this.editMenu=new OIMenuSub(a).element,this.editMenu}createMenuDuplicate(){return this.duplicateBtn=document.createElement("button"),this.duplicateBtn.id=`${this.id}-duplicate`,this.duplicateBtn.textContent="Duplicate",this.duplicateBtn.classList.add("ms-menu-button"),this.duplicateBtn.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){const i=this.symbolsSelected.map((i=>{const s=i.clone();for(;this.behaviors.model.symbols.find((i=>i.id===s.id));)if(s.id=s.id.slice(0,-36)+`-${createUUID()}`,s.type===be.Group){s.extractSymbols().forEach((i=>i.id=i.id.slice(0,-36)+`-${createUUID()}`))}return s.selected=!0,this.behaviors.translator.applyToSymbol(s,a,a),s}));this.behaviors.unselectAll(),yield this.behaviors.addSymbols(i),this.behaviors.selector.drawSelectedGroup(i)})))),this.duplicateBtn}createMenuGroup(){return this.groupBtn=document.createElement("button"),this.groupBtn.id=`${this.id}-duplicate`,this.groupBtn.textContent="Group",this.groupBtn.classList.add("ms-menu-button"),this.groupBtn.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){if(1===this.symbolsSelected.length&&this.symbolsSelected[0].type===be.Group){const i=this.behaviors.ungroupSymbol(this.symbolsSelected[0]);this.behaviors.select(i.map((i=>i.id)))}else{const i=this.symbolsSelected.slice();this.behaviors.unselectAll();const s=this.behaviors.groupSymbols(i);s.selected=!0,this.behaviors.select([s.id])}})))),this.groupBtn}createMenuConvert(){return this.convertBtn=document.createElement("button"),this.convertBtn.id=`${this.id}-convert`,this.convertBtn.textContent="Convert",this.convertBtn.classList.add("ms-menu-button"),this.convertBtn.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){try{this.behaviors.internalEvent.emitIdle(!1),yield this.behaviors.converter.apply(this.symbolsSelected)}catch(i){throw __classPrivateFieldGet(this,ft,"f").error("convert",i),this.behaviors.internalEvent.emitError(i),i}finally{this.behaviors.updateLayerInfos()}})))),this.convertBtn}createMenuRemove(){return this.removeBtn=document.createElement("button"),this.removeBtn.id=`${this.id}-remove`,this.removeBtn.textContent="Remove",this.removeBtn.classList.add("ms-menu-button"),this.removeBtn.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){this.behaviors.selector.removeSelectedGroup(),yield this.behaviors.removeSymbols(this.symbolsSelected.map((i=>i.id))),this.behaviors.menu.update()})))),this.removeBtn}createMenuReorder(){const i=document.createElement("button");i.id=`${this.id}-reorder`,i.classList.add("ms-menu-button");const s=document.createElement("span");s.innerText="Reorder",i.appendChild(s);const r=document.createElement("span");r.style.setProperty("width","32px"),r.style.setProperty("transform","rotate(270deg)"),r.innerHTML=ut,i.appendChild(r);const n=[{type:"button",id:`${this.id}-reorder-first`,label:"Bring to front",callback:()=>{this.behaviors.changeOrderSymbols(this.symbolsSelected,"last"),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}},{type:"button",id:`${this.id}-reorder-forward`,label:"Bring forward",callback:()=>{this.behaviors.changeOrderSymbols(this.symbolsSelected,"forward"),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}},{type:"button",id:`${this.id}-reorder-backward`,label:"Send backward",callback:()=>{this.behaviors.changeOrderSymbols(this.symbolsSelected,"backward"),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}},{type:"button",id:`${this.id}-reorder-last`,label:"Send to back",callback:()=>{this.behaviors.changeOrderSymbols(this.symbolsSelected.slice().reverse(),"first"),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}}],a=document.createElement("div");a.classList.add("ms-menu-colmun"),n.forEach((i=>{a.appendChild(this.createMenuItem(i))}));const l={trigger:i,subMenu:a,position:"right"};return this.reorderMenu=new OIMenuSub(l).element,this.reorderMenu}createDecoratorSubMenu(i,s){const r=document.createElement("button");r.id=`${this.id}-decorator-${s}`,r.classList.add("ms-menu-button");const n=document.createElement("span");n.innerText=i,r.appendChild(n);const a=document.createElement("span");a.style.setProperty("width","32px"),a.style.setProperty("transform","rotate(270deg)"),a.innerHTML=ut,r.appendChild(a);const l=[{type:"checkbox",id:`${this.id}-decorator-${s}-enable`,label:"Enable",initValue:!1,callback:i=>{var r;this.symbolsDecorable.forEach((r=>{if(i)r.decorators.some((i=>i.kind===s))||r.decorators.push(new OIDecorator(s,this.behaviors.currentPenStyle));else{const i=r.decorators.findIndex((i=>i.kind===s));i>-1&&r.decorators.splice(i,1)}this.behaviors.model.updateSymbol(r),this.behaviors.renderer.drawSymbol(r)})),document.querySelectorAll(`#${this.id}-decorator-${s}-color button`).forEach((s=>{s.disabled=!i,s.classList.remove("active")})),i&&(null===(r=document.querySelector(`#${this.id}-decorator-${s}-color button`))||void 0===r||r.classList.add("active"))}},{type:"colors",label:"Colors",id:`${this.id}-decorator-${s}-color`,fill:!1,values:this.colors.filter(((i,s)=>!(s%4))),initValue:this.colors[0],disabled:!0,callback:i=>{this.symbolsDecorable.forEach((r=>{const n=r.decorators.find((i=>i.kind===s));n&&(n.style.color=i,this.behaviors.model.updateSymbol(r),this.behaviors.renderer.drawSymbol(r))}))}}],d=document.createElement("div");d.classList.add("ms-menu-colmun"),l.forEach((i=>{d.appendChild(this.createMenuItem(i))}));const h={trigger:r,subMenu:d,position:"right"};return this.decoratorMenu=new OIMenuSub(h).element}createMenuDecorator(){const i=document.createElement("button");i.id=`${this.id}-decorator`,i.classList.add("ms-menu-button");const s=document.createElement("span");s.innerText="Decorator",i.appendChild(s);const r=document.createElement("span");r.style.setProperty("width","32px"),r.style.setProperty("transform","rotate(270deg)"),r.innerHTML=ut,i.appendChild(r);const n=document.createElement("div");n.classList.add("ms-menu-colmun"),n.appendChild(this.createDecoratorSubMenu("Hightlight",oe.Highlight)),n.appendChild(this.createDecoratorSubMenu("Surround",oe.Surround)),n.appendChild(this.createDecoratorSubMenu("Underline",oe.Underline)),n.appendChild(this.createDecoratorSubMenu("Strikethrough",oe.Strikethrough));const a={trigger:i,subMenu:n,position:"right"};return this.decoratorMenu=new OIMenuSub(a).element,this.decoratorMenu}createMenuExport(){const i=document.createElement("button");i.id=`${this.id}-export`,i.classList.add("ms-menu-button");const s=document.createElement("span");s.innerText="Export",i.appendChild(s);const r=document.createElement("span");r.style.setProperty("width","32px"),r.style.setProperty("transform","rotate(270deg)"),r.innerHTML=ut,i.appendChild(r);const n=[{type:"button",id:`${this.id}-export-json`,label:"json",callback:()=>this.behaviors.downloadAsJson(this.haveSymbolsSelected)},{type:"button",id:`${this.id}-export-svg`,label:"svg",callback:()=>this.behaviors.downloadAsSVG(this.haveSymbolsSelected)},{type:"button",id:`${this.id}-export-png`,label:"png",callback:()=>this.behaviors.downloadAsPNG(this.haveSymbolsSelected)}],a=document.createElement("div");a.classList.add("ms-menu-colmun"),n.forEach((i=>{a.appendChild(this.createMenuItem(i))}));const l={trigger:i,subMenu:a,position:"right"};return this.menuExport=new OIMenuSub(l).element,this.menuExport}createMenuSelectAll(){const i=document.createElement("button");return i.id=`${this.id}-duplicate`,i.textContent="Select all",i.classList.add("ms-menu-button"),i.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){return this.behaviors.selectAll()})))),i}updateDecoratorSubMenu(){var i,s;this.showDecorator?(null===(i=this.decoratorMenu)||void 0===i||i.style.removeProperty("display"),Object.values(oe).forEach((i=>{var s;const r=document.getElementById(`${this.id}-decorator-${i}-enable`);if(r){document.querySelectorAll(`#${this.id}-decorator-${i}-color button`).forEach((i=>i.classList.remove("active")));const n=this.symbolsDecorable.flatMap((i=>i.decorators)).filter((s=>s.kind===i));if(n.length&&n.every((i=>i.style.color===n[0].style.color))){const r=document.getElementById(`${this.id}-decorator-${i}-color-${null===(s=n[0].style.color)||void 0===s?void 0:s.replace("#","")}-btn`);null==r||r.classList.add("active")}this.symbolsDecorable.filter((s=>s.decorators.some((s=>s.kind===i)))).length===this.symbolsDecorable.length?(r.checked=!0,document.querySelectorAll(`#${this.id}-decorator-${i}-color button`).forEach((i=>{i.disabled=!1})),r.indeterminate=!1):this.symbolsDecorable.filter((s=>!s.decorators.some((s=>s.kind===i)))).length===this.symbolsDecorable.length?(r.checked=!1,document.querySelectorAll(`#${this.id}-decorator-${i}-color button`).forEach((i=>{i.disabled=!0})),r.indeterminate=!1):(r.setAttribute("indeterminate","true"),r.indeterminate=!0,document.querySelectorAll(`#${this.id}-decorator-${i}-color button`).forEach((i=>{i.disabled=!1})))}}))):null===(s=this.decoratorMenu)||void 0===s||s.style.setProperty("display","none")}updateGroupMenu(){var i;this.groupBtn&&this.haveSymbolsSelected?(this.groupBtn.style.removeProperty("display"),1===this.symbolsSelected.length&&this.symbolsSelected[0].type===be.Group?this.groupBtn.textContent="UnGroup":this.groupBtn.textContent="Group"):null===(i=this.groupBtn)||void 0===i||i.style.setProperty("display","none")}update(){var i,s,r,n,a,l,d,h,c,u,p,m,v,g,y;if(null===(i=this.wrapper)||void 0===i||i.style.setProperty("left",this.position.x-this.position.scrollLeft+"px"),null===(s=this.wrapper)||void 0===s||s.style.setProperty("top",this.position.y-this.position.scrollTop+"px"),this.haveSymbolsSelected){const i=this.behaviors.model.symbolsSelected.find((i=>i.type===be.Text));this.editMenu&&this.editInput&&1===this.behaviors.model.symbolsSelected.length&&i?(this.editMenu.style.removeProperty("display"),this.editInput.value=i.label):null===(r=this.editMenu)||void 0===r||r.style.setProperty("display","none"),this.behaviors.extractStrokesFromSymbols(this.symbolsSelected).length?null===(n=this.convertBtn)||void 0===n||n.style.removeProperty("display"):null===(a=this.convertBtn)||void 0===a||a.style.setProperty("display","none"),null===(l=this.reorderMenu)||void 0===l||l.style.removeProperty("display"),null===(d=this.duplicateBtn)||void 0===d||d.style.removeProperty("display"),null===(h=this.removeBtn)||void 0===h||h.style.removeProperty("display"),null===(c=this.menuExport)||void 0===c||c.style.removeProperty("display")}else null===(u=this.editMenu)||void 0===u||u.style.setProperty("display","none"),null===(p=this.convertBtn)||void 0===p||p.style.setProperty("display","none"),null===(m=this.reorderMenu)||void 0===m||m.style.setProperty("display","none"),null===(v=this.duplicateBtn)||void 0===v||v.style.setProperty("display","none"),null===(g=this.removeBtn)||void 0===g||g.style.setProperty("display","none"),null===(y=this.menuExport)||void 0===y||y.style.setProperty("display","none");this.updateDecoratorSubMenu(),this.updateGroupMenu()}render(i){var s;this.wrapper=document.createElement("div"),this.wrapper.id=`${this.id}-wrapper`,this.wrapper.classList.add("ms-menu","ms-menu-context"),this.wrapper.appendChild(this.createMenuEdit()),this.wrapper.appendChild(this.createMenuDecorator()),this.wrapper.appendChild(this.createMenuReorder()),this.wrapper.appendChild(this.createMenuExport()),this.wrapper.appendChild(this.createMenuConvert()),this.wrapper.appendChild(this.createMenuGroup()),this.wrapper.appendChild(this.createMenuDuplicate()),this.wrapper.appendChild(this.createMenuRemove()),this.wrapper.appendChild(this.createMenuSelectAll()),this.wrapper.style.setProperty("display","none"),i.appendChild(this.wrapper),null===(s=i.parentElement)||void 0===s||s.addEventListener("scroll",(()=>{var s,r;this.position.scrollLeft=(null===(s=i.parentElement)||void 0===s?void 0:s.scrollLeft)||0,this.position.scrollTop=(null===(r=i.parentElement)||void 0===r?void 0:r.scrollTop)||0,this.update()}))}show(){var i;this.update(),null===(i=this.wrapper)||void 0===i||i.style.setProperty("display","block")}hide(){var i;null===(i=this.wrapper)||void 0===i||i.style.setProperty("display","none")}destroy(){}}ft=new WeakMap;class OIMenuManager{constructor(i,s){if(bt.set(this,LoggerManager.getLogger(d.MENU)),__classPrivateFieldGet(this,bt,"f").info("constructor"),this.behaviors=i,null==s?void 0:s.style){const i=s.style;this.style=new i(this.behaviors)}else this.style=new OIMenuStyle(this.behaviors);if(null==s?void 0:s.intention){const i=s.intention;this.intention=new i(this.behaviors)}else this.intention=new OIMenuIntention(this.behaviors);if(null==s?void 0:s.action){const i=s.action;this.action=new i(this.behaviors)}else this.action=new OIMenuAction(this.behaviors);if(null==s?void 0:s.context){const i=s.context;this.context=new i(this.behaviors)}else this.context=new OIMenuContext(this.behaviors)}render(i){this.behaviors.configuration.menu.enable&&(this.layer=i,this.behaviors.configuration.menu.action.enable&&this.action.render(this.layer),this.behaviors.configuration.menu.style.enable&&this.style.render(this.layer),this.behaviors.configuration.menu.intention.enable&&this.intention.render(this.layer),this.behaviors.configuration.menu.context.enable&&this.context.render(this.layer))}update(){this.action.update(),this.intention.update(),this.style.update()}show(){this.action.show(),this.intention.show(),this.style.show()}hide(){this.action.hide(),this.intention.hide(),this.style.hide()}destroy(){this.action.destroy(),this.intention.destroy(),this.style.destroy()}}bt=new WeakMap;class OIMoveManager{constructor(i){this.behaviors=i}get renderer(){return this.behaviors.renderer}start(i){this.origin={left:this.renderer.parent.scrollLeft,top:this.renderer.parent.scrollTop,x:i.clientX,y:i.clientY}}continue(i){if(!this.origin)throw new Error("Can't move cause origin is undefined");const s=i.clientX-this.origin.x,r=i.clientY-this.origin.y;this.renderer.parent.scrollTop=this.origin.top-r,this.renderer.parent.scrollLeft=this.origin.left-s}end(i){return __awaiter(this,void 0,void 0,(function*(){this.continue(i),this.origin=void 0}))}}const getInitialUndoRedoContext=()=>({stackIndex:0,possibleUndoCount:0,canRedo:!1,canUndo:!1,empty:!0});var xt,wt,St,_t,Pt,kt,Et,Mt,Gt,Ct,Ft,Lt,It,Tt,Ot,Dt,Rt,At,Bt,$t,Nt,zt,jt,Vt,Ht,Ut,Wt,Yt,Xt,qt,Jt,Zt,Kt,Qt,ei,ti,ii,si,ri,ni,oi,ai,li,di,hi,ci,ui,pi,mi,vi,gi,yi,fi,bi,xi,wi,Si,_i,Pi,ki,Ei,Mi,Gi,Ci,Fi,Li,Ii,Ti,Oi,Di,Ri,Ai,Bi,$i,Ni,zi,ji,Vi,Hi,Ui,Wi,Yi,Xi,qi,Ji,Zi,Ki;class HistoryManager{constructor(i){xt.set(this,LoggerManager.getLogger(d.HISTORY)),__classPrivateFieldGet(this,xt,"f").info("constructor",{configuration:i}),this.configuration=i,this.context={stackIndex:0,possibleUndoCount:0,canRedo:!1,canUndo:!1,empty:!0},this.stack=[]}get internalEvent(){return InternalEvent.getInstance()}updateContext(){this.context.canRedo=this.stack.length-1>this.context.stackIndex,this.context.canUndo=this.context.stackIndex>0,this.context.empty=0===this.stack[this.context.stackIndex].symbols.length}push(i){__classPrivateFieldGet(this,xt,"f").info("push",{model:i}),this.context.stackIndex+1<this.stack.length&&this.stack.splice(this.context.stackIndex+1),this.stack.push(i.clone()),this.context.stackIndex=this.stack.length-1,this.stack.length>this.configuration.maxStackSize&&(this.stack.shift(),this.context.stackIndex--),this.updateContext(),this.internalEvent.emitContextChange(this.context)}updateStack(i){__classPrivateFieldGet(this,xt,"f").info("updateStack",{model:i});const s=this.stack.findIndex((s=>s.modificationDate===i.modificationDate));s>-1&&this.stack.splice(s,1,i.clone()),this.updateContext(),this.internalEvent.emitContextChange(this.context)}undo(){__classPrivateFieldGet(this,xt,"f").info("undo"),this.context.canUndo&&(this.context.stackIndex--,this.updateContext(),this.internalEvent.emitContextChange(this.context));const i=this.stack[this.context.stackIndex].clone();return __classPrivateFieldGet(this,xt,"f").debug("undo",i),i}redo(){__classPrivateFieldGet(this,xt,"f").info("redo"),this.context.canRedo&&(this.context.stackIndex++,this.updateContext(),this.internalEvent.emitContextChange(this.context));const i=this.stack[this.context.stackIndex].clone();return __classPrivateFieldGet(this,xt,"f").debug("redo",i),i}}xt=new WeakMap;class OIHistoryManager{constructor(i){wt.set(this,LoggerManager.getLogger(d.HISTORY)),__classPrivateFieldGet(this,wt,"f").info("constructor",{configuration:i}),this.configuration=i,this.context={stackIndex:0,possibleUndoCount:0,canRedo:!1,canUndo:!1,empty:!0},this.stack=[]}get internalEvent(){return InternalEvent.getInstance()}updateContext(){this.context.canRedo=this.stack.length-1>this.context.stackIndex,this.context.canUndo=this.context.stackIndex>0,this.context.empty=0===this.stack[this.context.stackIndex].model.symbols.length}isChangesEmpty(i){var s,r,n,a,l,d,h,c,u,p,m,v,g,y,f;return!((null===(s=i.added)||void 0===s?void 0:s.length)||(null===(r=i.updated)||void 0===r?void 0:r.length)||(null===(n=i.erased)||void 0===n?void 0:n.length)||(null===(a=i.replaced)||void 0===a?void 0:a.oldSymbols.length)||(null===(l=i.matrix)||void 0===l?void 0:l.symbols.length)||(null===(d=i.translate)||void 0===d?void 0:d.length)||(null===(h=i.rotate)||void 0===h?void 0:h.length)||(null===(c=i.scale)||void 0===c?void 0:c.length)||(null===(p=null===(u=i.style)||void 0===u?void 0:u.symbols)||void 0===p?void 0:p.length)||(null===(v=null===(m=i.order)||void 0===m?void 0:m.symbols)||void 0===v?void 0:v.length)||(null===(g=i.decorator)||void 0===g?void 0:g.length)||(null===(y=i.group)||void 0===y?void 0:y.symbols.length)||(null===(f=i.ungroup)||void 0===f?void 0:f.group))}init(i){this.stack.push({model:i.clone(),changes:{}}),this.internalEvent.emitContextChange(this.context)}push(i,s){__classPrivateFieldGet(this,wt,"f").info("push",{model:i,changes:s}),this.isChangesEmpty(s)||(this.context.stackIndex+1<this.stack.length&&this.stack.splice(this.context.stackIndex+1),this.stack.push({model:i.clone(),changes:s}),this.context.stackIndex=this.stack.length-1,this.stack.length>this.configuration.maxStackSize&&(this.stack.shift(),this.context.stackIndex--),this.updateContext(),this.internalEvent.emitContextChange(this.context))}pop(){__classPrivateFieldGet(this,wt,"f").info("pop"),this.stack.pop(),this.context.stackIndex=this.stack.length-1,this.updateContext()}reverseChanges(i){var s,r,n;const a={};return i.added&&(a.erased=i.added),i.erased&&(a.added=i.erased),i.replaced&&(a.replaced={newSymbols:i.replaced.oldSymbols,oldSymbols:i.replaced.newSymbols}),i.matrix&&(a.matrix={symbols:i.matrix.symbols,matrix:new MatrixTransform(i.matrix.matrix.xx,i.matrix.matrix.yx,i.matrix.matrix.xy,i.matrix.matrix.yy,i.matrix.matrix.tx,i.matrix.matrix.ty).invert()}),(null===(s=i.translate)||void 0===s?void 0:s.length)&&(a.translate=i.translate.map((i=>({symbols:i.symbols,tx:-i.tx,ty:-i.ty})))),(null===(r=i.rotate)||void 0===r?void 0:r.length)&&(a.rotate=i.rotate.map((i=>({symbols:i.symbols,angle:2*Math.PI-i.angle,center:i.center})))),(null===(n=i.scale)||void 0===n?void 0:n.length)&&(a.scale=i.scale.map((i=>({symbols:i.symbols,origin:i.origin,scaleX:1/i.scaleX,scaleY:1/i.scaleY})))),a}undo(){__classPrivateFieldGet(this,wt,"f").info("undo");const i=this.stack[this.context.stackIndex];this.context.canUndo&&(this.context.stackIndex--,this.updateContext(),this.internalEvent.emitContextChange(this.context));const s=this.stack[this.context.stackIndex];return __classPrivateFieldGet(this,wt,"f").debug("undo",s),{model:s.model,changes:this.reverseChanges(i.changes)}}redo(){__classPrivateFieldGet(this,wt,"f").info("redo"),this.context.canRedo&&(this.context.stackIndex++,this.updateContext(),this.internalEvent.emitContextChange(this.context));const i=this.stack[this.context.stackIndex];return __classPrivateFieldGet(this,wt,"f").debug("redo",i),i}clear(){this.context={stackIndex:0,possibleUndoCount:0,canRedo:!1,canUndo:!1,empty:!0},this.stack=[]}}wt=new WeakMap;class OIBehaviors{constructor(s,r){var n,a,l;this.name="OIBehaviors",St.set(this,LoggerManager.getLogger(d.BEHAVIORS)),_t.set(this,void 0),Pt.set(this,void 0),kt.set(this,void 0),Et.set(this,void 0),__classPrivateFieldGet(this,St,"f").info("constructor",{options:s}),__classPrivateFieldSet(this,_t,new Configuration(null==s?void 0:s.configuration),"f"),this.layerInfos=r,this.styler=new StyleManager(Object.assign({},ae,null==s?void 0:s.penStyle),null==s?void 0:s.theme),this.grabber=new OIPointerEventGrabber(__classPrivateFieldGet(this,_t,"f").grabber),this.recognizer=new OIRecognizer(__classPrivateFieldGet(this,_t,"f").server,__classPrivateFieldGet(this,_t,"f").recognition),this.renderer=new OISVGRenderer(__classPrivateFieldGet(this,_t,"f").rendering),this.history=new OIHistoryManager(__classPrivateFieldGet(this,_t,"f")["undo-redo"]),this.writer=new OIWriteManager(this),this.eraser=new OIEraseManager(this),this.gesture=new OIGestureManager(this,null===(n=s.behaviors)||void 0===n?void 0:n.gesture),this.resizer=new OIResizeManager(this),this.rotator=new OIRotationManager(this),this.translator=new OITranslateManager(this),this.converter=new OIConversionManager(this,s.fontStyle),this.texter=new OITextManager(this),this.selector=new OISelectionManager(this),this.svgDebugger=new OIDebugSVGManager(this),this.snaps=new OISnapManager(this,null===(a=s.behaviors)||void 0===a?void 0:a.snap),this.move=new OIMoveManager(this),this.menu=new OIMenuManager(this,null===(l=s.behaviors)||void 0===l?void 0:l.menu),__classPrivateFieldSet(this,kt,i.Write,"f"),__classPrivateFieldSet(this,Pt,new OIModel(__classPrivateFieldGet(this,_t,"f").rendering.minWidth,__classPrivateFieldGet(this,_t,"f").rendering.minHeight,this.configuration.rendering.guides.gap),"f")}get internalEvent(){return InternalEvent.getInstance()}get intention(){return __classPrivateFieldGet(this,kt,"f")}set intention(s){var r,n,a,l,d,h,c,u,p,m,v,g,y,f,b,x;switch(__classPrivateFieldSet(this,kt,s,"f"),__classPrivateFieldGet(this,kt,"f")){case i.Erase:null===(r=this.renderer.parent)||void 0===r||r.classList.remove("draw"),null===(n=this.renderer.parent)||void 0===n||n.classList.add("erase"),null===(a=this.renderer.parent)||void 0===a||a.classList.remove("select"),null===(l=this.renderer.parent)||void 0===l||l.classList.remove("move");break;case i.Select:null===(d=this.renderer.parent)||void 0===d||d.classList.remove("draw"),null===(h=this.renderer.parent)||void 0===h||h.classList.remove("erase"),null===(c=this.renderer.parent)||void 0===c||c.classList.add("select"),null===(u=this.renderer.parent)||void 0===u||u.classList.remove("move");break;case i.Move:null===(p=this.renderer.parent)||void 0===p||p.classList.remove("draw"),null===(m=this.renderer.parent)||void 0===m||m.classList.remove("erase"),null===(v=this.renderer.parent)||void 0===v||v.classList.remove("select"),null===(g=this.renderer.parent)||void 0===g||g.classList.add("move");break;default:null===(y=this.renderer.parent)||void 0===y||y.classList.add("draw"),null===(f=this.renderer.parent)||void 0===f||f.classList.remove("erase"),null===(b=this.renderer.parent)||void 0===b||b.classList.remove("select"),null===(x=this.renderer.parent)||void 0===x||x.classList.remove("move")}this.unselectAll()}get model(){return __classPrivateFieldGet(this,Pt,"f")}get configuration(){return __classPrivateFieldGet(this,_t,"f")}set renderingConfiguration(i){this.configuration.rendering=mergeDeep(this.configuration.rendering,i);const s=Math.max(this.renderer.parent.clientHeight,this.configuration.rendering.minHeight),r=Math.max(this.renderer.parent.clientWidth,this.configuration.rendering.minWidth);this.renderer.resize(s,r),this.model.rowHeight=this.configuration.rendering.guides.gap,this.history.stack.forEach((i=>i.model.rowHeight=this.model.rowHeight))}get currentPenStyle(){return this.styler.currentPenStyle}get penStyle(){return this.styler.penStyle}setPenStyle(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,St,"f").info("setPenStyle",{penStyle:i}),this.styler.setPenStyle(Object.assign({},this.currentPenStyle,i)),Promise.resolve()}))}get penStyleClasses(){return this.styler.penStyleClasses}setPenStyleClasses(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,St,"f").info("setPenStyleClasses",{penStyleClasses:i}),this.styler.setPenStyleClasses(i),Promise.resolve()}))}get theme(){return this.styler.theme}setTheme(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,St,"f").info("setTheme",{theme:i}),this.styler.setTheme(i),Promise.resolve()}))}updateLayerInfos(){clearTimeout(__classPrivateFieldGet(this,Et,"f")),__classPrivateFieldSet(this,Et,setTimeout((()=>{this.menu.update(),this.svgDebugger.apply(),this.recognizer.waitForIdle()}),1500),"f")}onPointerDown(s,r){__classPrivateFieldGet(this,St,"f").debug("onPointerDown",{evt:s,pointer:r}),this.internalEvent.emitIdle(!1);try{switch(this.unselectAll(),__classPrivateFieldGet(this,kt,"f")){case i.Erase:this.eraser.start(r);break;case i.Select:this.selector.start(r);break;case i.Move:this.move.start(s);break;default:this.writer.start(this.currentPenStyle,r,s.pointerType)}}catch(i){__classPrivateFieldGet(this,St,"f").error("onPointerDown",i),this.grabber.stopPointerEvent(),this.internalEvent.emitError(i)}finally{this.svgDebugger.apply()}}onPointerMove(s,r){__classPrivateFieldGet(this,St,"f").debug("onPointerMove",{pointer:r});try{switch(__classPrivateFieldGet(this,kt,"f")){case i.Erase:this.eraser.continue(r);break;case i.Select:this.selector.continue(r);break;case i.Move:this.move.continue(s);break;default:this.writer.continue(r)}}catch(i){__classPrivateFieldGet(this,St,"f").error("onPointerMove",i),this.internalEvent.emitError(i)}finally{this.svgDebugger.apply()}}onPointerUp(s,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").debug("onPointerUp",{pointer:r});try{switch(__classPrivateFieldGet(this,kt,"f")){case i.Erase:this.eraser.end(r);break;case i.Select:this.selector.end(r);break;case i.Move:this.move.end(s);break;default:this.writer.end(r)}}catch(i){this.undo(),__classPrivateFieldGet(this,St,"f").error("onPointerUp",i),this.internalEvent.emitError(i)}finally{this.updateLayerInfos()}}))}onContextMenu(s,r){return __awaiter(this,void 0,void 0,(function*(){if(this.intention===i.Select){let i=!1,n=s;const a=[be.Edge.toString(),be.Shape.toString(),be.Stroke.toString(),be.Text.toString()];for(;n&&"svg"!==n.tagName&&!i;)a.includes(n.getAttribute("type"))?i=!0:n=n.parentElement;this.unselectAll(),(null==n?void 0:n.id)?(this.model.selectSymbol(n.id),this.renderer.drawSymbol(this.model.symbolsSelected[0]),this.selector.drawSelectedGroup(this.model.symbolsSelected)):(this.menu.context.position.x=r.x+this.renderer.parent.clientLeft,this.menu.context.position.y=r.y+this.renderer.parent.clientTop,this.menu.context.show())}}))}init(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("init",{domElement:i}),this.renderer.init(i),this.menu.render(this.layerInfos),this.grabber.attach(this.renderer.layer),this.grabber.onPointerDown=this.onPointerDown.bind(this),this.grabber.onPointerMove=this.onPointerMove.bind(this),this.grabber.onPointerUp=this.onPointerUp.bind(this),this.grabber.onContextMenu=this.onContextMenu.bind(this),this.model.width=Math.max(i.clientWidth,__classPrivateFieldGet(this,_t,"f").rendering.minWidth),this.model.height=Math.max(i.clientHeight,__classPrivateFieldGet(this,_t,"f").rendering.minHeight),this.model.rowHeight=this.configuration.rendering.guides.gap,this.history.init(this.model),yield this.recognizer.init(),yield this.setPenStyle(this.penStyle),yield this.setTheme(this.theme),yield this.setPenStyleClasses(this.penStyleClasses)}))}changeLanguage(i){return __awaiter(this,void 0,void 0,(function*(){try{__classPrivateFieldGet(this,St,"f").info("changeLanguage",{code:i}),this.internalEvent.emitIdle(!1),this.configuration.recognition.lang=i,yield this.recognizer.destroy(),this.recognizer=new OIRecognizer(__classPrivateFieldGet(this,_t,"f").server,__classPrivateFieldGet(this,_t,"f").recognition),yield this.recognizer.init(),yield this.recognizer.addStrokes(this.model.symbols.filter((i=>i.type===be.Stroke)),!1)}catch(i){throw __classPrivateFieldGet(this,St,"f").error("changeLanguage",i),this.internalEvent.emitError(i),i}finally{this.updateLayerInfos()}}))}createShape(i){switch(i.kind){case Se.Circle:return OIShapeCircle.create(i);case Se.Ellipse:return OIShapeEllipse.create(i);case Se.Polygon:return OIShapePolygon.create(i);default:throw new Error(`Unable to create shape, kind: "${i.kind}" is unknown`)}}createEdge(i){switch(i.kind){case xe.Arc:return OIEdgeArc.create(i);case xe.Line:return OIEdgeLine.create(i);case xe.PolyEdge:return OIEdgePolyLine.create(i);default:throw new Error(`Unable to create edge, kind: "${i.kind}" is unknown`)}}createGroup(i){var s;if(!(null===(s=i.children)||void 0===s?void 0:s.length))throw new Error("Unable to create group, no children");const r=i.children.map((i=>{switch(null==i?void 0:i.type){case be.Stroke:return OIStroke.create(i);case be.Shape:return this.createShape(i);case be.Edge:return this.createEdge(i);case be.Text:return OIText.create(i);case be.Group:return this.createGroup(i);default:throw new Error(`Unable to create group, symbol type '${JSON.stringify(i)} is unknow`)}})),n=new OISymbolGroup(r,i.style);return i.id&&(n.id=i.id),i.decorators&&(n.decorators=i.decorators.map((i=>new OIDecorator(i.kind,i.style)))),n}createStroke(i){return OIStroke.create(i)}createText(i){return OIText.create(i)}createSymbol(i){return __awaiter(this,void 0,void 0,(function*(){try{switch(i.type){case be.Stroke:return yield this.addSymbol(this.createStroke(i));case be.Shape:return yield this.addSymbol(this.createShape(i));case be.Edge:return yield this.addSymbol(this.createEdge(i));case be.Text:return yield this.addSymbol(this.createText(i));case be.Group:return yield this.addSymbol(this.createGroup(i));default:throw new Error(`Unable to create symbol, type: "${i.type}" is unknown`)}}catch(i){throw __classPrivateFieldGet(this,St,"f").error("createSymbol",i),this.updateLayerInfos(),this.internalEvent.emitError(i),i}}))}createSymbols(i){return __awaiter(this,void 0,void 0,(function*(){try{const s=[],r=[];if(i.forEach((i=>{try{switch(i.type){case be.Stroke:r.push(this.createStroke(i));break;case be.Shape:r.push(this.createShape(i));break;case be.Edge:r.push(this.createEdge(i));break;case be.Text:r.push(this.createText(i));break;case be.Group:r.push(this.createGroup(i));break;default:s.push(`Unable to create symbol, type: "${i.type}" is unknown`)}}catch(i){s.push(i.message||i)}})),s.length)throw new Error(s.join("\n"));return yield this.addSymbols(r)}catch(i){throw __classPrivateFieldGet(this,St,"f").error("importPointEvents",i),this.internalEvent.emitError(i),i}}))}addSymbol(i,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("addSymbol",{sym:i}),this.internalEvent.emitIdle(!1),i.type===be.Text?this.texter.updateBounds(i):i.type===be.Group&&i.extractSymbols().forEach((i=>{i.type===be.Text&&this.texter.updateBounds(i)})),this.model.addSymbol(i),this.renderer.drawSymbol(i);const r=this.extractStrokesFromSymbols([i]);return this.recognizer.addStrokes(r,!1),s&&this.history.push(this.model,{added:[i]}),this.updateLayerInfos(),i}))}addSymbols(i,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("addSymbol",{symList:i}),this.internalEvent.emitIdle(!1),i.forEach((i=>{i.type===be.Text?this.texter.updateBounds(i):i.type===be.Group&&i.extractSymbols().forEach((i=>{i.type===be.Text&&this.texter.updateBounds(i)})),this.model.addSymbol(i),this.renderer.drawSymbol(i)}));const r=this.extractStrokesFromSymbols(i);return this.recognizer.addStrokes(r,!1),s&&this.history.push(this.model,{added:i}),this.updateLayerInfos(),i}))}updateSymbol(i,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("updateSymbol",{sym:i}),this.internalEvent.emitIdle(!1),i.type===be.Text?this.texter.updateBounds(i):i.type===be.Group&&i.extractSymbols().forEach((i=>{i.type===be.Text&&this.texter.updateBounds(i)})),this.model.updateSymbol(i),this.renderer.drawSymbol(i);const r=this.extractStrokesFromSymbols([i]);return this.recognizer.replaceStrokes(r.map((i=>i.id)),r),s&&this.history.push(this.model,{updated:[i]}),this.updateLayerInfos(),i}))}updateSymbols(i,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("updateSymbol",{symList:i}),this.internalEvent.emitIdle(!1),i.forEach((i=>{i.type===be.Text?this.texter.updateBounds(i):i.type===be.Group&&i.extractSymbols().forEach((i=>{i.type===be.Text&&this.texter.updateBounds(i)})),this.model.updateSymbol(i),this.renderer.drawSymbol(i)}));const r=this.extractStrokesFromSymbols(i);return this.recognizer.replaceStrokes(r.map((i=>i.id)),r),s&&this.history.push(this.model,{updated:i}),this.updateLayerInfos(),i}))}updateSymbolsStyle(i,s,r=!0){__classPrivateFieldGet(this,St,"f").info("updateSymbolsStyle",{symbolIds:i,style:s});const n=[];this.model.symbols.forEach((r=>{i.includes(r.id)&&(r.style=Object.assign({},r.style,s),r.type===be.Text?r.chars.forEach((i=>{s.color&&(i.color=s.color)})):r.type===be.Group&&r.updateChildrenStyle(),this.renderer.drawSymbol(r),this.model.updateSymbol(r),r.modificationDate=Date.now(),n.push(r))})),n.length&&n.forEach((i=>{if(i.type===be.Text){const s=i.bounds.width;this.texter.updateBounds(i);const r=i.bounds.width-s;0!==r&&this.texter.moveTextAfter(i,r)}})),r&&n.length&&this.history.push(this.model,{style:{symbols:n,style:s}})}updateTextFontStyle(i,{fontSize:s,fontWeight:r}){__classPrivateFieldGet(this,St,"f").info("updateTextFontStyle",{textIds:i,fontSize:s,fontWeight:r});const n=[],a=[];this.model.symbols.forEach((l=>{if(i.includes(l.id))if(l.type===be.Text){l.chars.forEach((i=>{s&&(i.fontSize=s),r&&(i.fontWeight=r)}));const i=l.bounds.width;this.texter.updateBounds(l),this.renderer.drawSymbol(l);const d=l.bounds.width-i;if(0!==d){const i=this.texter.moveTextAfter(l,d);(null==i?void 0:i.length)&&a.push({symbols:i,tx:d,ty:0})}l.modificationDate=Date.now(),n.push(l)}else l.type===be.Group&&l.extractSymbols().some((i=>i.type===be.Text))&&(l.extractSymbols().forEach((i=>{if(i.type===be.Text){i.chars.forEach((i=>{s&&(i.fontSize=s),r&&(i.fontWeight=r)}));const n=l.bounds.width;this.texter.updateBounds(i);const d=l.bounds.width-n,h=this.texter.moveTextAfter(i,d);(null==h?void 0:h.length)&&a.push({symbols:h,tx:d,ty:0}),i.modificationDate=Date.now()}})),l.modificationDate=Date.now(),this.renderer.drawSymbol(l),n.push(l))})),n.length&&this.history.push(this.model,{style:{symbols:n,fontSize:s},translate:a})}replaceSymbols(i,s,r=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("replaceSymbol",{oldSymbols:i,newSymbols:s}),this.internalEvent.emitIdle(!1);const n=this.extractStrokesFromSymbols(i),a=this.extractStrokesFromSymbols(s),l=i[0];l&&(this.model.replaceSymbol(l.id,s),this.renderer.replaceSymbol(l.id,s),i.slice(1).forEach((i=>{this.renderer.removeSymbol(i.id),this.model.removeSymbol(i.id)})),n.length&&a.length?this.recognizer.replaceStrokes(n.map((i=>i.id)),a):n.length?this.recognizer.eraseStrokes(n.map((i=>i.id))):this.recognizer.addStrokes(a,!1),r&&this.history.push(this.model,{replaced:{oldSymbols:i,newSymbols:s}}),this.updateLayerInfos())}))}changeOrderSymbol(i,s){this.model.changeOrderSymbol(i.id,s),this.renderer.changeOrderSymbol(i,s),this.history.push(this.model,{order:{symbols:[i],position:s}})}changeOrderSymbols(i,s){i.forEach((i=>{this.model.changeOrderSymbol(i.id,s),this.renderer.changeOrderSymbol(i,s)})),this.history.push(this.model,{order:{symbols:i,position:s}})}groupSymbols(i){const s=this.createGroup({children:i});return i.forEach((i=>{this.model.removeSymbol(i.id),this.renderer.removeSymbol(i.id)})),this.model.addSymbol(s),this.history.push(this.model,{group:{symbols:i}}),s}ungroupSymbol(i){return i.children.forEach((i=>this.renderer.drawSymbol(i))),this.renderer.removeSymbol(i.id),this.model.replaceSymbol(i.id,i.children),this.history.push(this.model,{ungroup:{group:i}}),i.children}groupStrokesByJIIXElement(){var i,s;return __awaiter(this,void 0,void 0,(function*(){yield this.export(["application/vnd.myscript.jiix"]);const r=this.model.symbols.filter((i=>i.type===be.Stroke)),n=null===(i=this.model.exports)||void 0===i?void 0:i["application/vnd.myscript.jiix"];null===(s=null==n?void 0:n.elements)||void 0===s||s.forEach((i=>{var s;if("Text"===i.type){null===(s=i.words)||void 0===s||s.forEach((i=>{var s,n;const a=r.filter((s=>{var r;return null===(r=i.items)||void 0===r?void 0:r.map((i=>i["full-id"])).includes(s.id)}));if(a.length){const r=[];let l=a[0].style;(null===(s=i.items)||void 0===s?void 0:s.length)!==a.length&&(null===(n=i.items)||void 0===n||n.forEach((i=>{const s=this.model.getRootSymbol(i["full-id"]);(null==s?void 0:s.type)===be.Group&&(r.push(...s.decorators),l=Object.assign({},l,s.style),a.push(...s.extractStrokes()),this.model.removeSymbol(s.id),this.renderer.removeSymbol(s.id))})));const d=this.createGroup({children:a,style:l});r.forEach((i=>{d.decorators.some((s=>s.kind===i.kind))||d.decorators.push(i)})),a.map((i=>{this.model.removeSymbol(i.id),this.renderer.removeSymbol(i.id)})),this.model.addSymbol(d),this.renderer.drawSymbol(d)}}))}else{const s=r.filter((s=>{var r;return null===(r=i.items)||void 0===r?void 0:r.map((i=>i["full-id"])).includes(s.id)}));if(s.length){const i=this.createGroup({children:s});s.map((i=>{this.model.removeSymbol(i.id),this.renderer.removeSymbol(i.id)})),this.model.addSymbol(i),this.renderer.drawSymbol(i)}}}))}))}removeSymbol(i,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("removeSymbol",{id:i});const r=this.model.getRootSymbol(i);if(r){if(this.internalEvent.emitIdle(!1),r.type===be.Group){const s=r.extractStrokes().map((i=>i.id));r.removeChilds([i]),r.children.length?(this.model.updateSymbol(r),this.renderer.drawSymbol(r),s.includes(i)&&this.recognizer.eraseStrokes([i])):(this.recognizer.eraseStrokes(s),this.model.removeSymbol(r.id),this.renderer.removeSymbol(r.id))}else this.recognizer.eraseStrokes([i]),this.model.removeSymbol(r.id),this.renderer.removeSymbol(r.id);s&&this.history.push(this.model,{erased:[r]}),this.updateLayerInfos()}else this.renderer.removeSymbol(i),this.recognizer.eraseStrokes([i])}))}removeSymbols(i,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("removeSymbol",{ids:i});const r=[],n=[],a=[];if(i.forEach((s=>{const l=this.model.getRootSymbol(s);if(l)if(l.id===s)switch(r.push(l),l.type){case be.Stroke:a.push(l.id);break;case be.Group:a.push(...l.extractStrokes().map((i=>i.id)))}else{const s=l.clone();a.push(...s.extractStrokes().map((i=>i.id)).filter((s=>i.includes(s)))),s.removeChilds(i),s.children.length?n.push(s):r.push(s)}})),this.recognizer.eraseStrokes(a),r.forEach((i=>{this.model.removeSymbol(i.id),this.renderer.removeSymbol(i.id)})),n.forEach((i=>{this.model.updateSymbol(i),this.renderer.drawSymbol(i)})),s){const i={};(r.length||n.length)&&(r.length&&(i.erased=r),n.length&&(i.updated=n),this.history.push(this.model,i),this.updateLayerInfos())}return this.internalEvent.emitIdle(!1),r}))}select(i){this.selector.removeSelectedGroup(),this.model.symbols.forEach((s=>{s.selected=i.includes(s.id),this.renderer.drawSymbol(s)})),this.selector.drawSelectedGroup(this.model.symbolsSelected),this.internalEvent.emitSelected(this.model.symbolsSelected)}selectAll(){this.selector.removeSelectedGroup(),this.model.symbols.forEach((i=>{i.selected=!0,this.renderer.drawSymbol(i)})),this.selector.drawSelectedGroup(this.model.symbolsSelected),this.internalEvent.emitSelected(this.model.symbolsSelected)}unselectAll(){this.menu.context.hide(),this.menu.update(),this.model.symbolsSelected.length&&(this.model.symbolsSelected.forEach((i=>{i.selected=!1,this.renderer.drawSymbol(i)})),this.selector.removeSelectedGroup(),this.internalEvent.emitSelected(this.model.symbolsSelected))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,St,"f").info("importPointEvents",{partialStrokes:i}),this.internalEvent.emitIdle(!1);const s=convertPartialStrokesToOIStrokes(i);return s.forEach((i=>{this.model.addSymbol(i),this.renderer.drawSymbol(i)})),this.recognizer.addStrokes(s,!1),this.history.push(this.model,{added:s}),__classPrivateFieldGet(this,St,"f").debug("importPointEvents",this.model),this.updateLayerInfos(),this.model}))}triggerDownload(i,s){const r=document.createElement("a");r.setAttribute("href",s),r.setAttribute("download",i),document.body.appendChild(r),r.click(),r.remove()}getSymbolsBounds(i,s=10){const r=Box.createFromBoxes(i.map((i=>i.bounds)));return r.x-=s,r.y-=s,r.width+=2*s,r.height+=2*s,r}buildBlobFromSymbols(i,s){const r=SVGBuilder.createLayer(s);i.forEach((i=>{var s;const n=null===(s=this.renderer.getElementById(i.id))||void 0===s?void 0:s.cloneNode(!0);n&&r.appendChild(n)}));const n=(new XMLSerializer).serializeToString(r);return new Blob([n],{type:"image/svg+xml;charset=utf-8"})}getExportName(i){const s={year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"};try{return`iink-ts-${(new Date).toLocaleDateString(navigator.language,s)}.${i}`}catch(r){return`iink-ts-${(new Date).toLocaleDateString("en-US",s)}.${i}`}}downloadAsSVG(i=!1){const s=i?this.model.symbolsSelected:this.model.symbols,r=this.getSymbolsBounds(s),n=this.buildBlobFromSymbols(s,r),a=URL.createObjectURL(n);this.triggerDownload(this.getExportName("svg"),a)}downloadAsPNG(i=!1){const s=i?this.model.symbolsSelected:this.model.symbols,r=this.getSymbolsBounds(s),n=this.buildBlobFromSymbols(s,r),a=URL.createObjectURL(n),l=new Image;l.width=r.width,l.height=r.height,l.src=a,l.onload=()=>{const i=document.createElement("canvas");i.width=l.width,i.height=l.height;i.getContext("2d").drawImage(l,0,0),URL.revokeObjectURL(a);const s=i.toDataURL("image/png").replace("image/png","image/octet-stream");this.triggerDownload(this.getExportName("png"),s)}}downloadAsJson(i=!1){const s=i?this.model.symbolsSelected:this.model.symbols,r="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s,null,2));this.triggerDownload(this.getExportName("json"),r)}extractStrokesFromSymbols(i){if(!(null==i?void 0:i.length))return[];const s=[];return i.forEach((i=>{switch(i.type){case be.Stroke:s.push(i);break;case be.Group:s.push(...i.extractStrokes())}})),s}extractBackendChanges(i){var s,r,n,a,l;const d={};d.added=this.extractStrokesFromSymbols(i.added),d.erased=this.extractStrokesFromSymbols(i.erased);const h=this.extractStrokesFromSymbols(i.updated),c=h.concat(this.extractStrokesFromSymbols(null===(s=i.replaced)||void 0===s?void 0:s.oldSymbols)),u=h.concat(this.extractStrokesFromSymbols(null===(r=i.replaced)||void 0===r?void 0:r.newSymbols));return c.length&&u.length?d.replaced={oldStrokes:c,newStrokes:u}:(d.added.push(...u),d.erased.push(...c)),i.matrix&&(d.matrix={strokes:this.extractStrokesFromSymbols(i.matrix.symbols),matrix:i.matrix.matrix}),(null===(n=i.translate)||void 0===n?void 0:n.length)&&(d.translate=[],i.translate.forEach((i=>{const s=this.extractStrokesFromSymbols(i.symbols);s.length&&d.translate.push({strokes:s,tx:i.tx,ty:i.ty})}))),(null===(a=i.scale)||void 0===a?void 0:a.length)&&(d.scale=[],i.scale.forEach((i=>{const s=this.extractStrokesFromSymbols(i.symbols);s.length&&d.scale.push({strokes:s,origin:i.origin,scaleX:i.scaleX,scaleY:i.scaleY})}))),(null===(l=i.rotate)||void 0===l?void 0:l.length)&&(d.rotate=[],i.rotate.forEach((i=>{const s=this.extractStrokesFromSymbols(i.symbols);s.length&&d.rotate.push({strokes:s,center:i.center,angle:i.angle})}))),d}undo(){var i,s,r,n,a;return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,St,"f").info("undo"),this.history.context.canUndo){this.internalEvent.emitIdle(!1),this.unselectAll();const l=this.history.undo(),d=l.model.extractDifferenceSymbols(this.model);__classPrivateFieldSet(this,Pt,l.model.clone(),"f"),__classPrivateFieldGet(this,St,"f").debug("undo",{previousStackItem:l});const h=this.extractBackendChanges(l.changes);d.removed.forEach((i=>this.renderer.removeSymbol(i.id))),d.added.forEach((i=>this.renderer.drawSymbol(i))),((null===(i=h.added)||void 0===i?void 0:i.length)||(null===(s=h.erased)||void 0===s?void 0:s.length)||h.replaced||h.matrix||(null===(r=h.translate)||void 0===r?void 0:r.length)||(null===(n=h.scale)||void 0===n?void 0:n.length)||(null===(a=h.rotate)||void 0===a?void 0:a.length))&&(yield this.recognizer.undo(h)),this.updateLayerInfos()}return this.model}))}redo(){var i,s,r,n,a;return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,St,"f").info("redo"),this.history.context.canRedo){this.internalEvent.emitIdle(!1),this.unselectAll();const l=this.history.redo(),d=l.model.extractDifferenceSymbols(this.model);__classPrivateFieldSet(this,Pt,l.model.clone(),"f"),__classPrivateFieldGet(this,St,"f").debug("redo",{modifications:d});const h=this.extractBackendChanges(l.changes);d.removed.forEach((i=>this.renderer.removeSymbol(i.id))),d.added.forEach((i=>this.renderer.drawSymbol(i))),((null===(i=h.added)||void 0===i?void 0:i.length)||(null===(s=h.erased)||void 0===s?void 0:s.length)||h.replaced||h.matrix||(null===(r=h.translate)||void 0===r?void 0:r.length)||(null===(n=h.scale)||void 0===n?void 0:n.length)||(null===(a=h.rotate)||void 0===a?void 0:a.length))&&(yield this.recognizer.redo(h)),this.updateLayerInfos()}return this.model}))}export(i){return __awaiter(this,void 0,void 0,(function*(){try{__classPrivateFieldGet(this,St,"f").info("export",{mimeTypes:i});const s=yield this.recognizer.export(i);this.model.mergeExport(s)}catch(i){throw __classPrivateFieldGet(this,St,"f").error("export",{error:i}),this.internalEvent.emitError(i),i}return this.model}))}convert(){return __awaiter(this,void 0,void 0,(function*(){try{this.internalEvent.emitIdle(!1),yield this.converter.apply()}catch(i){throw __classPrivateFieldGet(this,St,"f").error("convert",i),this.internalEvent.emitError(i),i}finally{this.updateLayerInfos()}return this.model}))}resize(i,s){return __awaiter(this,void 0,void 0,(function*(){return this.internalEvent.emitIdle(!1),__classPrivateFieldGet(this,St,"f").info("resize",{height:i,width:s}),this.model.height=i,this.model.width=s,this.renderer.resize(i,s),this.menu.update(),this.internalEvent.emitIdle(!0),this.model}))}clear(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,St,"f").info("clear"),this.internalEvent.emitIdle(!1),this.model.symbols.length){this.selector.removeSelectedGroup();const i=this.model.symbols;this.renderer.clear(),this.model.clear(),this.history.push(this.model,{erased:i}),this.recognizer.clear(),this.internalEvent.emitSelected(this.model.symbolsSelected)}return this.updateLayerInfos(),this.model}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,St,"f").info("destroy"),this.grabber.detach(),this.renderer.destroy(),this.menu.destroy(),this.recognizer.destroy(),this.model.clear(),this.history.clear(),Promise.resolve()}))}}St=new WeakMap,_t=new WeakMap,Pt=new WeakMap,kt=new WeakMap,Et=new WeakMap;class RestBehaviors{constructor(s){var r,n,a,l;if(this.name="RestBehaviors",Mt.set(this,LoggerManager.getLogger(d.BEHAVIORS)),Gt.set(this,void 0),Ct.set(this,void 0),Ft.set(this,void 0),Lt.set(this,void 0),__classPrivateFieldGet(this,Mt,"f").info("constructor",{options:s}),__classPrivateFieldSet(this,Gt,new Configuration(null==s?void 0:s.configuration),"f"),this.styleManager=new StyleManager(null==s?void 0:s.penStyle,null==s?void 0:s.theme),null===(r=s.behaviors)||void 0===r?void 0:r.grabber){const i=null===(n=s.behaviors)||void 0===n?void 0:n.grabber;this.grabber=new i(__classPrivateFieldGet(this,Gt,"f").grabber)}else this.grabber=new PointerEventGrabber(__classPrivateFieldGet(this,Gt,"f").grabber);if(null===(a=s.behaviors)||void 0===a?void 0:a.recognizer){const i=null===(l=s.behaviors)||void 0===l?void 0:l.recognizer;this.recognizer=new i(__classPrivateFieldGet(this,Gt,"f").server,__classPrivateFieldGet(this,Gt,"f").recognition)}else this.recognizer=new RestRecognizer(__classPrivateFieldGet(this,Gt,"f").server,__classPrivateFieldGet(this,Gt,"f").recognition);this.renderer=new CanvasRenderer(__classPrivateFieldGet(this,Gt,"f").rendering),this.intention=i.Write,__classPrivateFieldSet(this,Ct,new Model,"f"),this.history=new HistoryManager(__classPrivateFieldGet(this,Gt,"f")["undo-redo"])}onPointerDown(s,r){var n;__classPrivateFieldGet(this,Mt,"f").info("onPointerDown",{intention:this.intention,evt:s,point:r});const{pointerType:a}=s,l=Object.assign({},null===(n=this.theme)||void 0===n?void 0:n.ink,this.currentPenStyle);switch(this.intention){case i.Erase:this.model.removeStrokesFromPoint(r).length>0&&this.renderer.drawModel(this.model);break;case i.Write:this.model.initCurrentStroke(r,a,l),this.drawCurrentStroke();break;default:__classPrivateFieldGet(this,Mt,"f").warn("#onPointerDown",`onPointerDown intention unknow: "${this.intention}"`)}}onPointerMove(s,r){switch(__classPrivateFieldGet(this,Mt,"f").info("onPointerMove",{intention:this.intention,point:r}),this.intention){case i.Erase:this.model.removeStrokesFromPoint(r).length>0&&this.renderer.drawModel(this.model);break;case i.Write:this.model.appendToCurrentStroke(r),this.drawCurrentStroke();break;default:__classPrivateFieldGet(this,Mt,"f").warn("#onPointerMove",`onPointerMove intention unknow: "${this.intention}"`)}}onPointerUp(s,r){var n;return __awaiter(this,void 0,void 0,(function*(){switch(__classPrivateFieldGet(this,Mt,"f").info("onPointerUp",{intention:this.intention,point:r}),this.intention){case i.Erase:this.model.removeStrokesFromPoint(r),(null===(n=this.history.stack.at(-1))||void 0===n?void 0:n.modificationDate)!==this.model.modificationDate&&(yield this.updateModelRendering());break;case i.Write:this.model.endCurrentStroke(r),yield this.updateModelRendering();break;default:__classPrivateFieldGet(this,Mt,"f").warn("#onPointerUp",`onPointerUp intention unknow: "${this.intention}"`)}}))}get internalEvent(){return InternalEvent.getInstance()}get model(){return __classPrivateFieldGet(this,Ct,"f")}get currentPenStyle(){return this.styleManager.currentPenStyle}get penStyle(){return this.styleManager.penStyle}setPenStyle(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("setPenStyle",{penStyle:i}),this.styleManager.setPenStyle(i),Promise.resolve()}))}get penStyleClasses(){return this.styleManager.penStyleClasses}setPenStyleClasses(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("setPenStyleClasses",{penStyleClasses:i}),this.styleManager.setPenStyleClasses(i),Promise.resolve()}))}get theme(){return this.styleManager.theme}setTheme(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("setTheme",{theme:i}),this.styleManager.setTheme(i),Promise.resolve()}))}get configuration(){return __classPrivateFieldGet(this,Gt,"f")}init(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("init",{domElement:i}),this.model.width=Math.max(i.clientWidth,__classPrivateFieldGet(this,Gt,"f").rendering.minWidth),this.model.height=Math.max(i.clientHeight,__classPrivateFieldGet(this,Gt,"f").rendering.minHeight),this.history.push(this.model),this.renderer.init(i),this.grabber.attach(i),this.grabber.onPointerDown=this.onPointerDown.bind(this),this.grabber.onPointerMove=this.onPointerMove.bind(this),this.grabber.onPointerUp=this.onPointerUp.bind(this),Promise.resolve()}))}drawCurrentStroke(){__classPrivateFieldGet(this,Mt,"f").debug("drawCurrentStroke",{stroke:this.model.currentSymbol}),this.renderer.drawPendingStroke(this.model.currentSymbol)}updateModelRendering(){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Mt,"f").info("updateModelRendering"),this.renderer.drawModel(this.model);const i=new DeferredPromise;if(this.history.push(this.model),"DEMAND"!==__classPrivateFieldGet(this,Gt,"f").triggers.exportContent){clearTimeout(__classPrivateFieldGet(this,Lt,"f"));let s=this.model.clone();__classPrivateFieldSet(this,Lt,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){try{s=yield this.recognizer.export(s),this.history.updateStack(s),this.model.modificationDate===s.modificationDate&&(this.model.exports=s.exports),i.resolve(this.model)}catch(s){__classPrivateFieldGet(this,Mt,"f").error("updateModelRendering",{error:s}),this.internalEvent.emitError(s),i.reject(s)}}))),"QUIET_PERIOD"===__classPrivateFieldGet(this,Gt,"f").triggers.exportContent?__classPrivateFieldGet(this,Gt,"f").triggers.exportContentDelay:0),"f")}else i.resolve(this.model);return yield i.promise,this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,Mt,"f").debug("updateModelRendering",this.model.exports),i.promise}))}export(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Mt,"f").info("export",{mimeTypes:i});const s=yield this.recognizer.export(this.model.clone(),i);return this.model.modificationDate===s.modificationDate&&this.model.mergeExport(s.exports),this.history.updateStack(s),__classPrivateFieldGet(this,Mt,"f").debug("export",this.model),this.model}))}convert(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Mt,"f").info("convert",{conversionState:i,requestedMimeTypes:s});const r=yield this.recognizer.convert(this.model,i,s);return Object.assign(__classPrivateFieldGet(this,Ct,"f"),r),__classPrivateFieldGet(this,Mt,"f").debug("convert",this.model),this.model}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){const s=[];i.forEach(((i,r)=>{var n,a;let l=!0;const d=new Stroke(i.style||le,i.pointerType);if(i.id&&(d.id=i.id),!(null===(n=i.pointers)||void 0===n?void 0:n.length))return s.push(`stroke ${r+1} has not pointers`),void(l=!1);null===(a=i.pointers)||void 0===a||a.forEach(((i,n)=>{if(!i)return s.push(`stroke ${r+1} has no pointer at ${n}`),void(l=!1);const a={p:i.p||1,t:i.t||n,x:0,y:0};return null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(s.push(`stroke ${r+1} has no x at pointer at ${n}`),void(l=!1)):(a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(s.push(`stroke ${r+1} has no y at pointer at ${n}`),void(l=!1)):(a.y=i.y,void(l&&d.pointers.push(a))))})),l&&this.model.addStroke(d)})),s.length&&this.internalEvent.emitError(new Error(s.join("\n")));try{const i=yield this.updateModelRendering();return Object.assign(__classPrivateFieldGet(this,Ct,"f"),i),this.model}catch(i){throw this.internalEvent.emitError(i),i}}))}resize(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Mt,"f").info("resize",{height:i,width:s});const r=new DeferredPromise;return this.model.height=i,this.model.width=s,this.renderer.resize(this.model),this.model.symbols.length?(clearTimeout(__classPrivateFieldGet(this,Ft,"f")),__classPrivateFieldSet(this,Ft,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){const i=yield this.recognizer.resize(this.model);r.resolve(i)}))),__classPrivateFieldGet(this,Gt,"f").triggers.resizeTriggerDelay),"f")):r.resolve(this.model),__classPrivateFieldSet(this,Ct,yield r.promise,"f"),__classPrivateFieldGet(this,Mt,"f").debug("resize",{model:this.model}),this.internalEvent.emitExported(this.model.exports),this.model}))}undo(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("undo"),__classPrivateFieldSet(this,Ct,this.history.undo(),"f"),this.renderer.drawModel(__classPrivateFieldGet(this,Ct,"f")),__classPrivateFieldSet(this,Ct,yield this.recognizer.export(__classPrivateFieldGet(this,Ct,"f")),"f"),this.history.updateStack(__classPrivateFieldGet(this,Ct,"f")),this.internalEvent.emitExported(__classPrivateFieldGet(this,Ct,"f").exports),__classPrivateFieldGet(this,Mt,"f").debug("undo",__classPrivateFieldGet(this,Ct,"f")),__classPrivateFieldGet(this,Ct,"f")}))}redo(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("redo"),__classPrivateFieldSet(this,Ct,this.history.redo(),"f"),this.renderer.drawModel(__classPrivateFieldGet(this,Ct,"f")),__classPrivateFieldSet(this,Ct,yield this.recognizer.export(__classPrivateFieldGet(this,Ct,"f")),"f"),this.history.updateStack(__classPrivateFieldGet(this,Ct,"f")),this.internalEvent.emitExported(__classPrivateFieldGet(this,Ct,"f").exports),__classPrivateFieldGet(this,Mt,"f").debug("redo",__classPrivateFieldGet(this,Ct,"f")),__classPrivateFieldGet(this,Ct,"f")}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("clear"),this.model.clear(),this.history.push(this.model),this.renderer.drawModel(this.model),this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,Mt,"f").debug("clear",this.model),this.model}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("destroy"),this.grabber.detach(),this.renderer.destroy(),Promise.resolve()}))}}Mt=new WeakMap,Gt=new WeakMap,Ct=new WeakMap,Ft=new WeakMap,Lt=new WeakMap;class WSBehaviors{constructor(s){var r,n,a,l;if(this.name="WSBehaviors",It.set(this,LoggerManager.getLogger(d.BEHAVIORS)),Tt.set(this,void 0),Ot.set(this,void 0),Dt.set(this,void 0),__classPrivateFieldGet(this,It,"f").info("constructor",{options:s}),__classPrivateFieldSet(this,Tt,new Configuration(null==s?void 0:s.configuration),"f"),this.styleManager=new StyleManager(null==s?void 0:s.penStyle,null==s?void 0:s.theme),null===(r=s.behaviors)||void 0===r?void 0:r.grabber){const i=null===(n=s.behaviors)||void 0===n?void 0:n.grabber;this.grabber=new i(__classPrivateFieldGet(this,Tt,"f").grabber)}else this.grabber=new PointerEventGrabber(__classPrivateFieldGet(this,Tt,"f").grabber);if(null===(a=s.behaviors)||void 0===a?void 0:a.recognizer){const i=null===(l=s.behaviors)||void 0===l?void 0:l.recognizer;this.recognizer=new i(__classPrivateFieldGet(this,Tt,"f").server,__classPrivateFieldGet(this,Tt,"f").recognition)}else this.recognizer=new WSRecognizer(__classPrivateFieldGet(this,Tt,"f").server,__classPrivateFieldGet(this,Tt,"f").recognition);this.renderer=new WSSVGRenderer(__classPrivateFieldGet(this,Tt,"f").rendering),this.intention=i.Write,__classPrivateFieldSet(this,Ot,new Model,"f"),this.history=new HistoryManager(__classPrivateFieldGet(this,Tt,"f")["undo-redo"])}get internalEvent(){return InternalEvent.getInstance()}get model(){return __classPrivateFieldGet(this,Ot,"f")}get configuration(){return __classPrivateFieldGet(this,Tt,"f")}get currentPenStyle(){return this.styleManager.currentPenStyle}get penStyle(){return this.styleManager.penStyle}setPenStyle(i){return __classPrivateFieldGet(this,It,"f").info("setPenStyle",{penStyle:i}),this.styleManager.setPenStyle(i),__classPrivateFieldGet(this,It,"f").debug("setPenStyle",this.styleManager.penStyle),this.recognizer.setPenStyle(this.styleManager.penStyle)}get penStyleClasses(){return this.styleManager.penStyleClasses}setPenStyleClasses(i){return __classPrivateFieldGet(this,It,"f").info("setPenStyleClasses",{penClass:i}),this.styleManager.setPenStyleClasses(i),__classPrivateFieldGet(this,It,"f").debug("setPenStyleClasses",this.styleManager.penStyleClasses),this.recognizer.setPenStyleClasses(this.styleManager.penStyleClasses)}get theme(){return this.styleManager.theme}setTheme(i){return __classPrivateFieldGet(this,It,"f").info("setTheme",{theme:i}),this.styleManager.setTheme(i),__classPrivateFieldGet(this,It,"f").debug("setTheme",this.styleManager.theme),this.recognizer.setTheme(this.styleManager.theme)}onExport(i){__classPrivateFieldGet(this,It,"f").debug("onExport",{exports:i}),this.model.mergeExport(i)}onPointerDown(s,r){var n;__classPrivateFieldGet(this,It,"f").info("onPointerDown",{intention:this.intention,evt:s,point:r});let{pointerType:a}=s;const l=Object.assign({},null===(n=this.theme)||void 0===n?void 0:n.ink,this.currentPenStyle);this.intention===i.Erase&&(a="eraser"),this.model.initCurrentStroke(r,a,l),this.drawCurrentStroke()}onPointerMove(i,s){__classPrivateFieldGet(this,It,"f").info("onPointerMove",{intention:this.intention,point:s}),this.model.appendToCurrentStroke(s),this.drawCurrentStroke()}onPointerUp(i,s){return __awaiter(this,void 0,void 0,(function*(){try{__classPrivateFieldGet(this,It,"f").info("onPointerUp",{intention:this.intention,point:s}),this.model.endCurrentStroke(s),yield this.synchronizeModelWithBackend()}catch(i){this.internalEvent.emitError(i)}}))}onSVGPatch(i){__classPrivateFieldGet(this,It,"f").info("onSVGPatch",{evt:i}),this.renderer.updatesLayer(i.layer,i.updates)}init(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,It,"f").info("init",{domElement:i});const s=window.getComputedStyle(i);this.model.width=Math.max(parseInt(s.width.replace("px","")),__classPrivateFieldGet(this,Tt,"f").rendering.minWidth),this.model.height=Math.max(parseInt(s.height.replace("px","")),__classPrivateFieldGet(this,Tt,"f").rendering.minHeight),this.history.push(this.model),this.renderer.init(i),this.grabber.attach(i),this.grabber.onPointerDown=this.onPointerDown.bind(this),this.grabber.onPointerMove=this.onPointerMove.bind(this),this.grabber.onPointerUp=this.onPointerUp.bind(this),this.internalEvent.addExportedListener(this.onExport.bind(this)),this.internalEvent.addSVGPatchListener(this.onSVGPatch.bind(this)),yield this.recognizer.init(this.model.height,this.model.width),yield this.setPenStyle(this.penStyle),yield this.setTheme(this.theme),yield this.setPenStyleClasses(this.penStyleClasses)}))}drawCurrentStroke(){__classPrivateFieldGet(this,It,"f").debug("drawCurrentStroke",{stroke:this.model.currentSymbol});const i=this.model.currentSymbol;i&&this.renderer.drawPendingStroke(i)}synchronizeModelWithBackend(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,It,"f").info("synchronizeModelWithBackend"),"DEMAND"!==__classPrivateFieldGet(this,Tt,"f").triggers.exportContent){const i=this.model.extractUnsentStrokes();this.model.updatePositionSent(),this.history.push(this.model),this.renderer.clearErasingStrokes();const s=yield this.recognizer.addStrokes(i);this.model.mergeExport(s),this.history.updateStack(this.model)}return __classPrivateFieldGet(this,It,"f").debug("synchronizeModelWithBackend",this.model),this.model}))}waitForIdle(){return __awaiter(this,void 0,void 0,(function*(){return this.recognizer.waitForIdle()}))}export(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,It,"f").info("export",{mimeTypes:i});try{if("DEMAND"===__classPrivateFieldGet(this,Tt,"f").triggers.exportContent){const i=this.model.extractUnsentStrokes();this.model.updatePositionSent();const s=yield this.recognizer.addStrokes(i);return this.model.updatePositionReceived(),this.model.mergeExport(s),__classPrivateFieldGet(this,It,"f").debug("export",this.model),this.model}return this.recognizer.export(this.model,i)}catch(i){return __classPrivateFieldGet(this,It,"f").error("export",{error:i}),this.internalEvent.emitError(i),Promise.reject(i)}}))}convert(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,It,"f").info("convert",{conversionState:i}),this.history.push(this.model),this.history.stack.push(this.model.clone()),__classPrivateFieldSet(this,Ot,yield this.recognizer.convert(this.model,i),"f"),__classPrivateFieldGet(this,It,"f").debug("convert",this.model),this.history.push(this.model),this.model}))}import(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,It,"f").info("import",{data:i,mimeType:s}),this.history.stack.push(this.model.clone());const r=yield this.recognizer.import(this.model,i,s);return this.history.push(r),r}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,It,"f").info("importPointEvents",{strokes:i});const s=[],r=i.map(((i,r)=>{var n,a;const l=new Stroke(i.style||le,i.pointerType);i.id&&(l.id=i.id),i.pointerType&&(l.pointerType=i.pointerType),(null===(n=i.pointers)||void 0===n?void 0:n.length)||s.push(`stroke ${r+1} has not pointers`);let d=!0;return null===(a=i.pointers)||void 0===a||a.forEach(((i,n)=>{if(d=!0,!i)return void s.push(`stroke ${r+1} has no pointer at ${n}`);const a={p:i.p||1,t:i.t||n,x:0,y:0};null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(s.push(`stroke ${r+1} has no x at pointer at ${n}`),d=!1):a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(s.push(`stroke ${r+1} has no y at pointer at ${n}`),d=!1):a.y=i.y,d&&l.pointers.push(a)})),l}));s.length&&this.internalEvent.emitError(new Error(s.join("\n"))),r.map((i=>this.model.addStroke(i)));const n=yield this.recognizer.importPointEvents(r);return this.model.mergeExport(n),__classPrivateFieldGet(this,It,"f").debug("importPointEvents",this.model),this.model}))}resize(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,It,"f").info("resize",{height:i,width:s});const r=new DeferredPromise;this.model.height=i,this.model.width=s;const n=this.model.clone();return this.renderer.resize(n),clearTimeout(__classPrivateFieldGet(this,Dt,"f")),__classPrivateFieldSet(this,Dt,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){try{const i=yield this.recognizer.resize(n);r.resolve(i)}catch(n){__classPrivateFieldGet(this,It,"f").error("resize",{height:i,width:s,error:n}),r.reject(n)}}))),__classPrivateFieldGet(this,Tt,"f").triggers.resizeTriggerDelay),"f"),__classPrivateFieldSet(this,Ot,yield r.promise,"f"),this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,It,"f").debug("resize",this.model),this.model}))}undo(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,It,"f").info("undo"),this.history.context.canUndo)return __classPrivateFieldSet(this,Ot,this.history.undo(),"f"),this.recognizer.undo(this.model);throw new Error("Undo not allowed")}))}redo(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,It,"f").info("redo"),this.history.context.canRedo)return __classPrivateFieldSet(this,Ot,this.history.redo(),"f"),__classPrivateFieldGet(this,It,"f").debug("undo",__classPrivateFieldGet(this,Ot,"f")),this.recognizer.redo(this.model);throw new Error("Redo not allowed")}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,It,"f").info("clear"),this.model.clear(),this.history.push(this.model),this.recognizer.clear(this.model)}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,It,"f").info("destroy"),this.grabber.detach(),this.renderer.destroy(),this.recognizer.destroy(),Promise.resolve()}))}}It=new WeakMap,Tt=new WeakMap,Ot=new WeakMap,Dt=new WeakMap;class SmartGuide{constructor(){Rt.add(this),At.set(this,void 0),Bt.set(this,void 0),$t.set(this,void 0),Nt.set(this,void 0),zt.set(this,void 0),jt.set(this,void 0),Vt.set(this,void 0),Ht.set(this,void 0),Ut.set(this,void 0),Wt.set(this,void 0),Yt.set(this,void 0),Xt.set(this,void 0),qt.set(this,LoggerManager.getLogger(d.SMARTGUIDE)),ai.set(this,(i=>{var s,r;__classPrivateFieldGet(this,qt,"f").info("showCandidates",{target:i});const n=parseInt(i.id.replace("word-","").replace(this.uuid,"")),a=null===(s=this.jiix)||void 0===s?void 0:s.words;this.wordToChange=a[n],this.wordToChange&&(this.wordToChange.id=n.toString(),__classPrivateFieldGet(this,Vt,"f").innerHTML="",(null===(r=this.wordToChange)||void 0===r?void 0:r.candidates)&&(__classPrivateFieldGet(this,Vt,"f").style.display="flex",this.wordToChange.candidates.forEach(((i,s)=>{var r;(null===(r=this.wordToChange)||void 0===r?void 0:r.label)===i?__classPrivateFieldGet(this,Vt,"f").innerHTML+=`<span id="cdt-${s}${this.uuid}" class="selected-word">${i}</span>`:__classPrivateFieldGet(this,Vt,"f").innerHTML+=`<span id="cdt-${s}${this.uuid}">${i}</span>`})),i.appendChild(__classPrivateFieldGet(this,Vt,"f"))))})),ci.set(this,(i=>{__classPrivateFieldGet(this,qt,"f").info("onClickEllipsis",{evt:i}),i.preventDefault(),i.stopPropagation(),__classPrivateFieldGet(this,Xt,"f")?__classPrivateFieldGet(this,Rt,"m",hi).call(this):__classPrivateFieldGet(this,Rt,"m",di).call(this),__classPrivateFieldGet(this,Rt,"m",li).call(this)})),ui.set(this,(i=>{__classPrivateFieldGet(this,qt,"f").info("onClickConvert",{evt:i}),i.preventDefault(),i.stopPropagation(),this.internalEvent.emitConvert(),__classPrivateFieldGet(this,Rt,"m",hi).call(this)})),vi.set(this,(i=>__awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,qt,"f").info("onClickCopy",{evt:i}),i.preventDefault(),i.stopPropagation();try{__classPrivateFieldGet(this,Rt,"m",hi).call(this);let i="Nothing to copy";if(__classPrivateFieldGet(this,Nt,"f").innerText){i=`"${__classPrivateFieldGet(this,Nt,"f").innerText}" copied to clipboard`;const s=__classPrivateFieldGet(this,Rt,"m",pi).call(this,__classPrivateFieldGet(this,Nt,"f").innerText);__classPrivateFieldGet(this,$t,"f").appendChild(s),__classPrivateFieldGet(this,Rt,"m",mi).call(this,s),document.execCommand("copy"),s.remove()}this.internalEvent.emitNotif({message:i,timeout:1500})}catch(i){__classPrivateFieldGet(this,qt,"f").error("onClickCopy",i),this.internalEvent.emitError(i)}})))),gi.set(this,(i=>{__classPrivateFieldGet(this,qt,"f").info("onClickDelete",{evt:i}),i.preventDefault(),i.stopPropagation(),this.internalEvent.emitClear(),__classPrivateFieldGet(this,Rt,"m",hi).call(this)})),yi.set(this,(i=>{var s,r,n,a,l;__classPrivateFieldGet(this,qt,"f").info("onClickCandidate",{evt:i}),i.preventDefault(),i.stopPropagation();const d=i.target.innerText;(null===(s=this.jiix)||void 0===s?void 0:s.words)&&d!==(null===(r=this.wordToChange)||void 0===r?void 0:r.label)&&(null===(a=null===(n=this.wordToChange)||void 0===n?void 0:n.candidates)||void 0===a?void 0:a.includes(d))&&(this.jiix.words[parseInt(null===(l=this.wordToChange)||void 0===l?void 0:l.id)].label=d,this.internalEvent.emitImportJIIX(this.jiix)),__classPrivateFieldGet(this,Vt,"f").style.display="none"})),fi.set(this,(i=>{__classPrivateFieldGet(this,qt,"f").info("onClickPrompter",{evt:i}),i.preventDefault(),i.stopPropagation(),__classPrivateFieldGet(this,Rt,"m",hi).call(this);const s=i.target;s.id!==__classPrivateFieldGet(this,Nt,"f").id?__classPrivateFieldGet(this,ai,"f").call(this,s):__classPrivateFieldGet(this,Rt,"m",li).call(this)})),bi.set(this,(i=>{i.preventDefault(),i.stopPropagation()})),xi.set(this,(()=>{__classPrivateFieldGet(this,Rt,"m",li).call(this),__classPrivateFieldGet(this,Rt,"m",hi).call(this)})),__classPrivateFieldGet(this,qt,"f").info("constructor"),this.uuid=createUUID(),this.margin={bottom:0,left:0,right:0,top:0},__classPrivateFieldGet(this,Rt,"m",Jt).call(this),__classPrivateFieldGet(this,Rt,"m",Zt).call(this),__classPrivateFieldGet(this,Rt,"m",Kt).call(this),__classPrivateFieldGet(this,Rt,"m",Qt).call(this),__classPrivateFieldGet(this,Rt,"m",ei).call(this),__classPrivateFieldGet(this,Rt,"m",ti).call(this),__classPrivateFieldGet(this,Rt,"m",ii).call(this),__classPrivateFieldGet(this,Rt,"m",si).call(this),__classPrivateFieldGet(this,Rt,"m",ri).call(this),__classPrivateFieldGet(this,Rt,"m",ni).call(this),__classPrivateFieldGet(this,Rt,"m",oi).call(this)}get internalEvent(){return InternalEvent.getInstance()}init(i,s,r){__classPrivateFieldGet(this,qt,"f").info("init",{domElement:i,margin:s,renderingConfiguration:r}),i.appendChild(__classPrivateFieldGet(this,At,"f")),__classPrivateFieldGet(this,At,"f").appendChild(__classPrivateFieldGet(this,Bt,"f")),__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,jt,"f")),__classPrivateFieldGet(this,$t,"f").appendChild(__classPrivateFieldGet(this,Nt,"f")),__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,$t,"f")),__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,zt,"f")),__classPrivateFieldGet(this,Ht,"f").appendChild(__classPrivateFieldGet(this,Ut,"f")),__classPrivateFieldGet(this,Ht,"f").appendChild(__classPrivateFieldGet(this,Wt,"f")),__classPrivateFieldGet(this,Ht,"f").appendChild(__classPrivateFieldGet(this,Yt,"f")),__classPrivateFieldGet(this,Ht,"f").classList.add("close"),__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,Ht,"f")),__classPrivateFieldSet(this,Xt,!1,"f"),__classPrivateFieldGet(this,Vt,"f").style.display="none",__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,Vt,"f")),this.margin=s,this.renderingConfiguration=r,__classPrivateFieldGet(this,Rt,"m",wi).call(this),this.resize()}resize(){__classPrivateFieldGet(this,qt,"f").info("resize");const i=convertMillimeterToPixel(this.margin.left),s=convertMillimeterToPixel(this.margin.right);__classPrivateFieldGet(this,Bt,"f").style.marginLeft=`${i}px`,__classPrivateFieldGet(this,Bt,"f").style.marginRight=`${s}px`}update(i){var s,r;__classPrivateFieldGet(this,qt,"f").info("update",{exports:i}),this.jiix=i;const createWordSpan=(i,s)=>{const r=document.createElement("span");return r.id=`word-${i}${this.uuid}`,s?r.textContent=s.label:r.innerHTML="&nbsp;",__classPrivateFieldGet(this,qt,"f").debug("update",{span:r}),r};(()=>{var i;if(__classPrivateFieldGet(this,qt,"f").info("populatePrompter"),__classPrivateFieldGet(this,Nt,"f").innerHTML="",null===(i=this.jiix)||void 0===i?void 0:i.words){const i=this.jiix.words,s=document.createDocumentFragment();i.forEach(((r,n)=>{var a,l,d;if(" "===r.label||r.label.includes("\n"))s.appendChild(createWordSpan(n));else if(n!==i.length-1)s.appendChild(createWordSpan(n,r));else{__classPrivateFieldGet(this,Nt,"f").appendChild(s),this.lastWord&&(this.lastWord=r);const i=createWordSpan(n,r);(null===(a=this.lastWord)||void 0===a?void 0:a.candidates)!==r.candidates&&(null===(l=this.lastWord)||void 0===l?void 0:l.label)!==r.label&&(this.lastWord=r),(null===(d=this.wordToChange)||void 0===d?void 0:d.id)===n.toString()?(i.classList.add("modified-word"),this.wordToChange=void 0):i.classList.add("added-word"),__classPrivateFieldGet(this,Nt,"f").appendChild(i),__classPrivateFieldGet(this,$t,"f").scrollLeft=i.offsetLeft,__classPrivateFieldGet(this,qt,"f").debug("update => populatePrompter",{span:i,lastWord:this.lastWord})}}))}})(),(null===(r=null===(s=this.jiix)||void 0===s?void 0:s.words)||void 0===r?void 0:r.length)?__classPrivateFieldGet(this,zt,"f").style.setProperty("pointer-events","auto"):__classPrivateFieldGet(this,zt,"f").style.setProperty("pointer-events","none")}clear(){__classPrivateFieldGet(this,qt,"f").info("clear"),__classPrivateFieldGet(this,Nt,"f").innerHTML="",__classPrivateFieldGet(this,Vt,"f").innerHTML=""}destroy(){__classPrivateFieldGet(this,qt,"f").info("destroy"),__classPrivateFieldGet(this,Rt,"m",Si).call(this),__classPrivateFieldGet(this,At,"f").remove()}}At=new WeakMap,Bt=new WeakMap,$t=new WeakMap,Nt=new WeakMap,zt=new WeakMap,jt=new WeakMap,Vt=new WeakMap,Ht=new WeakMap,Ut=new WeakMap,Wt=new WeakMap,Yt=new WeakMap,Xt=new WeakMap,qt=new WeakMap,ai=new WeakMap,ci=new WeakMap,ui=new WeakMap,vi=new WeakMap,gi=new WeakMap,yi=new WeakMap,fi=new WeakMap,bi=new WeakMap,xi=new WeakMap,Rt=new WeakSet,Jt=function _SmartGuide_createRootElement(){__classPrivateFieldSet(this,At,document.createElement("div"),"f"),__classPrivateFieldGet(this,At,"f").id=`smartguide-${this.uuid}`,__classPrivateFieldGet(this,At,"f").classList.add("smartguide"),__classPrivateFieldGet(this,At,"f").addEventListener("pointerdown",(i=>{i.preventDefault(),i.stopPropagation()}))},Zt=function _SmartGuide_createWrapperElement(){__classPrivateFieldSet(this,Bt,document.createElement("div"),"f"),__classPrivateFieldGet(this,Bt,"f").id=`smartguide-wrapper-${this.uuid}`,__classPrivateFieldGet(this,Bt,"f").classList.add("smartguide-wrapper")},Kt=function _SmartGuide_createPrompterContainerElement(){__classPrivateFieldSet(this,$t,document.createElement("div"),"f"),__classPrivateFieldGet(this,$t,"f").id=`prompter-container-${this.uuid}`,__classPrivateFieldGet(this,$t,"f").classList.add("prompter-container")},Qt=function _SmartGuide_createPrompterTextElement(){__classPrivateFieldSet(this,Nt,document.createElement("div"),"f"),__classPrivateFieldGet(this,Nt,"f").id=`prompter-text-${this.uuid}`,__classPrivateFieldGet(this,Nt,"f").classList.add("prompter-text"),__classPrivateFieldGet(this,Nt,"f").setAttribute("touch-action","none")},ei=function _SmartGuide_createEllipsisElement(){__classPrivateFieldSet(this,zt,document.createElement("div"),"f"),__classPrivateFieldGet(this,zt,"f").id=`ellipsis-${this.uuid}`,__classPrivateFieldGet(this,zt,"f").classList.add("ellipsis"),__classPrivateFieldGet(this,zt,"f").innerHTML="..."},ti=function _SmartGuide_createTagElement(){__classPrivateFieldSet(this,jt,document.createElement("div"),"f"),__classPrivateFieldGet(this,jt,"f").id=`tag-icon-${this.uuid}`,__classPrivateFieldGet(this,jt,"f").classList.add("tag-icon"),__classPrivateFieldGet(this,jt,"f").innerHTML="&#182;"},ii=function _SmartGuide_createCandidatesElement(){__classPrivateFieldSet(this,Vt,document.createElement("div"),"f"),__classPrivateFieldGet(this,Vt,"f").id=`candidates-${this.uuid}`,__classPrivateFieldGet(this,Vt,"f").classList.add("candidates")},si=function _SmartGuide_createMoreMenuElement(){__classPrivateFieldSet(this,Ht,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ht,"f").id=`more-menu-${this.uuid}`,__classPrivateFieldGet(this,Ht,"f").classList.add("more-menu")},ri=function _SmartGuide_createConvertElement(){__classPrivateFieldSet(this,Ut,document.createElement("button"),"f"),__classPrivateFieldGet(this,Ut,"f").id=`convert-${this.uuid}`,__classPrivateFieldGet(this,Ut,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,Ut,"f").innerHTML="Convert"},ni=function _SmartGuide_createCopyElement(){__classPrivateFieldSet(this,Wt,document.createElement("button"),"f"),__classPrivateFieldGet(this,Wt,"f").id=`copy-${this.uuid}`,__classPrivateFieldGet(this,Wt,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,Wt,"f").innerHTML="Copy"},oi=function _SmartGuide_createDeleteElement(){__classPrivateFieldSet(this,Yt,document.createElement("button"),"f"),__classPrivateFieldGet(this,Yt,"f").id=`delete-${this.uuid}`,__classPrivateFieldGet(this,Yt,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,Yt,"f").innerHTML="Delete"},li=function _SmartGuide_hideCandidates(){__classPrivateFieldGet(this,Vt,"f").style.display="none"},di=function _SmartGuide_openMenu(){__classPrivateFieldGet(this,Ht,"f").classList.add("open"),__classPrivateFieldGet(this,Ht,"f").classList.remove("close"),__classPrivateFieldSet(this,Xt,!0,"f")},hi=function _SmartGuide_closeMenu(){__classPrivateFieldGet(this,Ht,"f").classList.add("close"),__classPrivateFieldGet(this,Ht,"f").classList.remove("open"),__classPrivateFieldSet(this,Xt,!1,"f")},pi=function _SmartGuide_createTextAreaElement(i){const s="rtl"===document.documentElement.getAttribute("dir"),r=document.createElement("textarea");r.style.fontSize="12pt",r.style.display="absolute",r.style[s?"right":"left"]="-9999px";const n=window.pageYOffset||document.documentElement.scrollTop;return r.style.top=`${n}px`,r.setAttribute("readonly",""),r.value=i,r},mi=function _SmartGuide_selectText(i){if(navigator.userAgent.match(/ipad|iphone/i)){const s=document.createRange();s.selectNodeContents(i);const r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(s),i.setSelectionRange(0,999999))}else i.select()},wi=function _SmartGuide_addListeners(){__classPrivateFieldGet(this,At,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,bi,"f").bind(this)),__classPrivateFieldGet(this,zt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ci,"f").bind(this)),__classPrivateFieldGet(this,Ut,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ui,"f").bind(this)),__classPrivateFieldGet(this,Wt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,vi,"f").bind(this)),__classPrivateFieldGet(this,Yt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,gi,"f").bind(this)),__classPrivateFieldGet(this,Nt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,fi,"f").bind(this)),__classPrivateFieldGet(this,Vt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,yi,"f").bind(this)),document.addEventListener("pointerdown",__classPrivateFieldGet(this,xi,"f").bind(this))},Si=function _SmartGuide_removeListeners(){__classPrivateFieldGet(this,At,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,bi,"f")),__classPrivateFieldGet(this,zt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,ci,"f")),__classPrivateFieldGet(this,Ut,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,ui,"f")),__classPrivateFieldGet(this,Wt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,vi,"f")),__classPrivateFieldGet(this,Yt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,gi,"f")),__classPrivateFieldGet(this,Nt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,fi,"f")),__classPrivateFieldGet(this,Vt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,yi,"f")),document.removeEventListener("pointerdown",__classPrivateFieldGet(this,xi,"f"))};class Editor{constructor(i,s,r="ms-editor"){_i.add(this),this.logger=LoggerManager.getLogger(d.EDITOR),Pi.set(this,void 0),ki.set(this,void 0),Ei.set(this,void 0),Mi.set(this,void 0),Gi.set(this,void 0),Ci.set(this,void 0),Fi.set(this,void 0),Li.set(this,void 0),Ii.set(this,void 0),Ti.set(this,void 0),Oi.set(this,void 0),Di.set(this,void 0),Ri.set(this,void 0),Yi.set(this,(i=>{this.events.emitSelected(i)})),Xi.set(this,(i=>{this.intention=i,this.events.emitIntention(i)})),qi.set(this,(i=>{this.events.emitChanged(i)})),Ji.set(this,(i=>{__classPrivateFieldGet(this,_i,"m",zi).call(this,i),this.events.emitIdle(i)})),__classPrivateFieldSet(this,Di,new DeferredPromise,"f"),this.loggerConfiguration=mergeDeep({},s.logger,$),this.logger.info("constructor",{wrapperHTML:i,options:s,globalClassCss:r}),this.wrapperHTML=i,this.wrapperHTML.classList.add(r),this.wrapperHTML.classList.add("draw"),this.events.setElement(this.wrapperHTML);const n=document.createElement("style");n.appendChild(document.createTextNode(".ms-editor{color:#1a9fff;font-family:sans-serif;height:100%;overflow:auto;position:relative;width:100%;z-index:10}#editor:active,#editor:focus{-webkit-tap-highlight-color:transparent}.ms-editor input:not([type=checkbox]):not([type=color]):not([type=range]),.ms-editor select{-webkit-tap-highlight-color:transparent;-webkit-appearance:none;appearance:none;border:1px solid #ced5d9;border-radius:3px;color:#131f26;font:600 14px Source Sans Pro,sans-serif;height:2rem;padding:0 10px}.ms-editor input[type=file]{border:none!important}.ms-editor input[type=file]:focus{border:none!important;box-shadow:none!important}.ms-editor input[type=file]:focus::file-selector-button{border:1px solid #1a9fff!important}.ms-editor input[type=file]::file-selector-button{background-color:#fff;border:1px solid rgba(0,0,0,.16);border-radius:4px;box-shadow:0 1px 0 rgba(0,0,0,.05);cursor:pointer;height:2rem;margin:0 auto 0 8px;padding:0 16px;transition:background-color .2s}.ms-editor input[type=file]::file-selector-button:hover{background-color:#f3f4f6}.ms-editor input[type=file]::file-selector-button:active{background-color:#e5e7eb}.ms-editor select{background:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTQuNDIyLjI2Yy0uMjMzLS4zMzctLjYxLS4zMzctLjg0NCAwTC4xNzUgNS4xN0MtLjE0MiA1LjYyOC4wNDggNiAuNjEgNmg2Ljc4Yy41NTggMCAuNzU0LS4zNy40MzUtLjgzTDQuNDIyLjI2em0uMDIgMTMuNDdjLS4yMzYuMzQyLS42MTguMzQ3LS44NS4wMUwuMTY3IDguODE4Qy0uMTQ2IDguMzY3LjA0OCA4IC42MDggOGg2Ljc4M2MuNTU4IDAgLjc1NS4zNy40MzcuODNsLTMuMzg1IDQuOXoiIGZpbGw9IiMxMzFGMjYiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvc3ZnPg==) 100% no-repeat #fff;padding:0 25px 0 10px}.ms-editor input:not([type=checkbox]):not([type=color]):not([type=range]):not([type=file]):focus,.ms-editor select:focus{border:1px solid #1a9fff;box-shadow:0 1px 1px 0 rgba(0,0,0,.16);outline:0}.ms-editor.draw{cursor:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m14.363 5.652 1.48-1.48a2 2 0 0 1 2.829 0l1.414 1.414a2 2 0 0 1 0 2.828l-1.48 1.48m-4.243-4.242-9.616 9.615a2 2 0 0 0-.578 1.238l-.242 2.74a1 1 0 0 0 1.084 1.085l2.74-.242a2 2 0 0 0 1.24-.578l9.615-9.616m-4.243-4.242 4.243 4.242' stroke='%23000' fill='%23fff' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\") 5 20,pointer}.ms-editor.draw.shape{cursor:crosshair}.ms-editor.erase{cursor:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m2.893 12.607 9.193-9.193a2 2 0 0 1 2.828 0l4.95 4.95a2 2 0 0 1 0 2.828l-9.243 9.243a1.929 1.929 0 0 1-2.728 0l-5-5a2 2 0 0 1 0-2.828Z' stroke='%23000' fill='%23fff' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M21 21H9M15.889 14.89 8.464 7.463' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\") 5 20,auto}.ms-editor.move{cursor:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' xmlns='http://www.w3.org/2000/svg' fill='%23fff'%3E%3Cpath d='m7 10.5-2.004 2.672a2 2 0 0 0 .126 2.552l3.784 4.128c.378.413.912.648 1.473.648H15c2.4 0 4-1.5 4-4 0 0 0 0 0 0V7.929M16 8.5v-.571c0-2.286 3-2.286 3 0' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M13 8.5V7.027m0-.527v.527M16 8.5V7.027c0-2.286-3-2.286-3 0' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M13 8.5V7.027c0-2.286 3-2.286 3 0V8.5M10 8.5v-2c0-2.286 3-2.286 3 0 0 0 0 0 0 0v2M7 13.5v-7A1.5 1.5 0 0 1 8.5 5v0c.828 0 1.5.555 1.5 1.384V8.5' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\") 10 10,auto}.ms-editor.select{cursor:context-menu}.ms-editor canvas,.ms-editor svg{left:0;position:absolute;top:0;z-index:20}.ms-editor canvas.ms-rendering-canvas{background-image:linear-gradient(90deg,#f5f6f7 1px,transparent 0),linear-gradient(180deg,#f5f6f7 1px,transparent 0);background-size:18px 18px;pointer-events:none;z-index:9}.ms-editor .ms-layer-infos{height:100%;left:0;pointer-events:none;position:sticky;top:0;user-select:none;width:100%;z-index:25}.ms-editor .ms-layer-infos>*{cursor:auto;pointer-events:all;user-select:none}.ms-editor .loader{-webkit-animation:spin 2s linear infinite;animation:spin 2s linear infinite;border:16px solid #f5f6f7;border-radius:50%;border-top-color:#1a9fff;height:120px;left:calc(50% - 60px);position:absolute;top:calc(50% - 60px);width:120px;z-index:30}.ms-editor .state{background-color:#f5f6f7;box-shadow:1px 1px 5px rgba(0,0,0,.25),-1px -1px 5px rgba(0,0,0,.25);color:#717171;cursor:auto;height:50px;left:0;padding:12px;position:absolute;top:calc(100% - 50px);width:50px;z-index:99}.ms-editor .state .busy{-webkit-animation:spin 2s linear infinite;animation:spin 2s linear infinite;border:4px solid #1a9fff;border-radius:100%;border-right-color:#f5f6f7;color:#717171;height:100%;width:100%}.ms-editor .state .idle{align-items:center;display:flex;justify-content:center}.ms-editor .message-container,.ms-editor .message-overlay{height:100%;position:absolute;width:100%}.ms-editor .message-overlay{background-color:hsla(0,0%,73%,.25);z-index:99}.ms-editor .message-modal{word-wrap:break-word;background-color:#fff;box-shadow:1px 1px 5px rgba(0,0,0,.25),-1px -1px 5px rgba(0,0,0,.25);font-size:16px;left:calc(50% - 150px);max-height:50%;overflow:auto;padding:12px;position:absolute;text-align:center;top:50%;transform:translateY(-50%);width:300px;z-index:999}.ms-editor .message-modal.error-msg:before{content:url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgNzYuNSA2MTIgNDU5IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWluWU1pbiBtZWV0Ij48cGF0aCBmaWxsPSIjMUE5RkZGIiBkPSJNNDk0LjcgMjI5LjVjLTE3Ljg1MS04Ni43LTk0LjM1MS0xNTMtMTg4LjctMTUzLTM4LjI1IDAtNzMuOTUgMTAuMi0xMDIgMzAuNmwzOC4yNSAzOC4yNWMxNy44NS0xMi43NSA0MC44LTE3Ljg1IDYzLjc1LTE3Ljg1IDc2LjUgMCAxNDAuMjUgNjMuNzUgMTQwLjI1IDE0MC4yNXYxMi43NWgzOC4yNWM0My4zNSAwIDc2LjUgMzMuMTUgNzYuNSA3Ni41IDAgMjguMDUtMTUuMyA1My41NS00MC44IDY2LjNsMzguMjUgMzguMjVDNTkxLjYgNDM4LjYgNjEyIDQwMC4zNSA2MTIgMzU3YzAtNjYuMy01My41NS0xMjIuNC0xMTcuMy0xMjcuNXpNNzYuNSAxMDkuNjVsNzEuNCA2OC44NUM2Ni4zIDE4My42IDAgMjQ5LjkgMCAzMzEuNWMwIDg0LjE1IDY4Ljg1IDE1MyAxNTMgMTUzaDI5OC4zNWw1MSA1MSAzMy4xNS0zMy4xNUwxMDkuNjUgNzYuNSA3Ni41IDEwOS42NXpNMTk2LjM1IDIyOS41bDIwNCAyMDRIMTUzYy01Ni4xIDAtMTAyLTQ1LjktMTAyLTEwMnM0NS45LTEwMiAxMDItMTAyaDQzLjM1eiIvPjwvc3ZnPg==\")}.ms-editor .message-modal.info-msg:before{background-image:url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMUE5RkZGIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiLz48cGF0aCBkPSJNMTIgMTZ2LTRNMTIgOGguMDEiLz48L3N2Zz4=\");background-size:100% 100%;content:\"\";display:block;height:25px;margin:auto;padding-bottom:10px;width:25px}.ms-editor .message-modal .ms-button{background-color:#fff;background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' fill='none' xmlns='http://www.w3.org/2000/svg' color='%23000'%3E%3Cpath d='M9.172 14.828 12.001 12m2.828-2.828L12.001 12m0 0L9.172 9.172M12.001 12l2.828 2.828M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Z' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\");background-position:50%;background-repeat:no-repeat;border:none;border-radius:4px;color:#000;cursor:pointer;font-size:inherit;height:32px;padding:0;position:absolute;right:0;top:0;width:32px}.ms-editor .message-modal .ms-button:hover{background-color:#eee}.ms-editor .ms-tooltip .ms-tooltip-content{background-color:#fff;border-radius:5px;box-shadow:0 2px 5px 0 rgba(0,0,0,.225);color:#000;display:none;font-weight:700;opacity:1!important;padding:5px;position:absolute;white-space:nowrap;width:auto;z-index:9999}.ms-editor .ms-menu-title{background-color:#b3dfff;border-radius:5px 5px 0 0;font-size:16px;font-weight:700;margin-top:0;padding:2px;text-align:center}.ms-editor .ms-tooltip .ms-tooltip-content.top{left:50%;top:0;transform:translate(-50%,-100%)}.ms-editor .ms-tooltip .ms-tooltip-content.left{left:0;top:50%;transform:translate(-100%,-50%)}.ms-editor .ms-tooltip .ms-tooltip-content.right{right:0;top:50%;transform:translate(100%,-50%)}.ms-editor .ms-tooltip .ms-tooltip-content.bottom{bottom:0;left:50%;transform:translate(-50%,100%)}.ms-editor .smartguide{box-shadow:2px 2px 12px #bdbdbd;cursor:default;font-size:16px;left:0;line-height:48px;padding-bottom:12px;padding-top:12px;position:absolute;top:0;width:100%;z-index:40}.ms-editor .smartguide .smartguide-wrapper{border-bottom:1px solid #959da6;display:flex}.ms-editor .smartguide .tag-icon{background-color:hsla(0,0%,100%,.9);border-left:1px solid #959da6;border-right:1px solid #959da6;border-top:1px solid #959da6;font-size:large;height:100%;line-height:48px;padding:0 18px;z-index:31}.ms-editor .smartguide .ellipsis,.ms-editor .smartguide .tag-icon{color:#959da6;font-weight:700;height:48px;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;width:48px}.ms-editor .smartguide .ellipsis{-webkit-tap-highlight-color:transparent;cursor:pointer;font-size:x-large;line-height:38px;padding:0 8px}.ms-editor .smartguide .ellipsis:active{background-color:#e0e0e0}.ms-editor .smartguide .prompter-container{-webkit-tap-highlight-color:transparent;color:#bfbfbf;display:block;height:48px;line-height:48px;overflow:hidden;text-align:left;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap;width:calc(100% - 96px)}.ms-editor .smartguide .prompter-container>div>span{cursor:pointer;display:inline-block}.ms-editor .smartguide .prompter-container .prompter-text{margin-left:12px}.ms-editor .smartguide .prompter-container .prompter-text .added-word{animation:word-added .1s linear,color-input 3s ease-in-out}.ms-editor .smartguide .prompter-container .prompter-text .modified-word{animation:word-modified .1s linear,color-input 3s ease-in-out}.ms-editor .smartguide .candidates{-webkit-tap-highlight-color:transparent;background-color:#f5f5f5;border-radius:3px;box-shadow:2px 2px 12px #bdbdbd,-2px 2px 12px #bdbdbd;color:#000;flex-direction:column;line-height:30px;position:absolute;text-align:center;z-index:100}.ms-editor .smartguide .candidates>span{cursor:pointer;padding:2px 20px}.ms-editor .smartguide .candidates>span:hover{background-color:#eee}.ms-editor .smartguide .candidates>span:active{background-color:#e0e0e0}.ms-editor .smartguide .candidates .selected-word{background-color:#e0e0e0;font-weight:700}.ms-editor .smartguide .more-menu{background-color:#f5f5f5;border-radius:3px;bottom:0;box-shadow:2px 2px 12px #bdbdbd;display:flex;flex-direction:column;line-height:30px;margin-right:12px;overflow:hidden;position:absolute;right:0;transform:translateY(100%);transition:max-height 1s ease-out,opacity 1s,visibility .5s linear;z-index:100}.ms-editor .smartguide .more-menu.open{max-height:500px;opacity:1;visibility:visible}.ms-editor .smartguide .more-menu.close{max-height:0;opacity:0;visibility:hidden}.ms-editor .smartguide .more-menu .options-label-button{-webkit-tap-highlight-color:transparent;background:transparent;border:none;box-sizing:border-box;color:#000;cursor:pointer;font-size:16px;height:40px;margin:0;outline:none;padding:0 24px}.ms-editor .smartguide .more-menu .options-label-button:hover{background-color:#eee;padding:4px}.ms-editor .smartguide .more-menu .options-label-button:active{background-color:#e0e0e0}.ms-editor .ps__rail-x{top:32px!important}.ms-editor .collapsible-wrapper .collapsible-header{align-items:center;color:#424242;cursor:pointer;display:flex;justify-content:space-between}.ms-editor .collapsible-wrapper .collapsible-header:hover{background-color:#efefef}.ms-editor .collapsible-wrapper .collapsible-header .collapsible-header-icon{align-items:center;display:flex;height:32px;justify-content:center;padding:4px;position:relative;transition:transform .5s;width:32px}.ms-editor .collapsible-wrapper.active .collapsible-header .collapsible-header-icon{transform:rotate(180deg)}.ms-editor .collapsible-wrapper .collapsible-content{max-height:0;overflow:auto;transition:max-height .5s}.ms-editor .collapsible-wrapper.active .collapsible-content{max-height:200px}.ms-editor hr.separator.horizontal{border:none;border-top:1px solid #d3d3d3;margin:5px 0;max-height:1px;max-width:100%;min-height:1px;min-width:100%}.ms-editor hr.separator.vertical{border:none;border-left:1px solid #d3d3d3;margin:0 5px;max-height:100%;max-width:1px;min-height:100%;min-width:1px}.ms-editor .ms-menu{background-color:#fff;box-shadow:1px 1px 5px rgba(0,0,0,.25),-1px -1px 5px rgba(0,0,0,.25);cursor:auto;padding:5px;pointer-events:all;z-index:99}.ms-editor .ms-menu-top-left{border-radius:0 0 5px 5px;left:5px;position:absolute;top:0}.ms-editor .ms-menu-bottom{border-radius:5px;bottom:8px;left:50%;position:absolute;transform:translateX(-50%)}.ms-editor .ms-menu-top-right{border-radius:0 0 5px 5px;position:absolute;right:5px;top:0}.ms-editor .ms-menu-colmun{display:flex;flex-direction:column;justify-content:center}.ms-editor .ms-menu-row{display:flex;flex-direction:row;justify-content:center}.ms-editor .ms-menu-item{align-items:center;display:flex;gap:5px;justify-content:space-between;padding:5px;width:100%}.ms-editor .ms-menu .select-language{height:32px;padding:0 8px;width:auto}.ms-editor .ms-menu-item.list button{align-items:center;background-color:#fff;border:none;border-radius:4px;cursor:pointer;display:flex;font-size:inherit;height:32px;justify-content:center;padding:0;position:relative;width:32px}.ms-editor .ms-menu-item.list button:hover{background-color:#efefef}.ms-editor .ms-menu-item.list button.active{border:1px solid #1a9fff}.ms-editor .ms-menu .color-list{cursor:pointer;flex-wrap:wrap;gap:2px;margin:auto;max-width:150px;min-width:150px;padding:4px}.ms-editor .ms-menu .font-size-list,.ms-editor .ms-menu .thickness-list{cursor:pointer;flex-wrap:wrap;gap:2px;margin:auto;max-width:150px;min-width:150px;padding:0}.ms-editor .ms-menu .ms-menu-button{-webkit-touch-callout:none;align-items:center;background-color:#fff;border:none;border-radius:4px;color:#000;cursor:pointer;display:flex;font-size:inherit;height:32px;justify-content:space-between;padding:4px;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:100%}.ms-editor .ms-menu svg{height:20px;position:relative;width:20px}.ms-editor .ms-menu .ms-menu-button.center{justify-content:center}.ms-editor .ms-menu .ms-menu-button.square{justify-content:center;width:32px}.ms-editor .ms-menu .ms-menu-button .color{border-radius:100%;height:75%;margin:auto;width:75%}.ms-editor .ms-menu .ms-menu-button:hover{background-color:#efefef}.ms-editor .ms-menu .ms-menu-button:disabled{background-color:hsla(0,0%,100%,.4);color:rgba(0,0,0,.4);opacity:.5;pointer-events:none}.ms-editor .ms-menu .ms-menu-button:active,.ms-editor .ms-menu .ms-menu-button:focus{background-color:#1aa0ff55;outline:none}.ms-editor .ms-menu .ms-menu-button.active{border:1px solid #1a9fff;color:#1a9fff}.ms-editor .sub-menu{overflow:visible;position:relative}.ms-editor .sub-menu .sub-menu-content{background-color:#fff;border-radius:5px;box-shadow:1px 1px 5px rgba(0,0,0,.25),-1px -1px 5px rgba(0,0,0,.25);color:#000;display:none;padding:5px;position:absolute;white-space:nowrap;width:auto;z-index:100}.ms-editor .sub-menu .sub-menu-content.open{display:block}.ms-editor .sub-menu .sub-menu-content.top{left:50%;top:-8px;transform:translate(-50%,-100%)}.ms-editor .sub-menu .sub-menu-content.bottom{bottom:-8px;left:50%;transform:translate(-50%,100%)}.ms-editor .sub-menu .sub-menu-content.bottom-left{bottom:-8px;right:0;transform:translateY(100%)}.ms-editor .sub-menu .sub-menu-content.right-top{right:-8px;top:0;transform:translate(100%)}.ms-editor .sub-menu .sub-menu-content.right{right:-8px;top:50%;transform:translate(100%,-50%)}.ms-editor .ms-menu-context{position:absolute}.ms-editor output.tooltip{background-color:#fff;border-radius:5px;box-shadow:0 2px 5px 0 rgba(0,0,0,.225);color:#000;display:none;font-weight:700;left:50%;padding:5px;position:absolute;transform:translate(-50%,-250%);white-space:nowrap;width:auto}.ms-editor input:focus+output.tooltip,.ms-editor input:focus-visible+output.tooltip,.ms-editor input:hover+output.tooltip{display:block}.ms-editor .removed-stroke{opacity:0;transition:opacity .1s ease-in-out}.ms-editor .added-stroke{animation:opacity-appear .2s}@keyframes color-input{0%{color:#000}to{color:#bfbfbf}}@keyframes word-added{0%{transform:translate(5px)}to{transform:none}}@keyframes word-modified{0%{transform:translateY(5px)}to{transform:none}}@keyframes opacity-appear{0%{opacity:0}to{opacity:1}}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg)}to{-webkit-transform:rotate(1turn)}}")),this.wrapperHTML.appendChild(n),this.wrapperHTML.appendChild(__classPrivateFieldGet(this,_i,"m",ji).call(this)),__classPrivateFieldGet(this,_i,"m",Vi).call(this,s)}get loggerConfiguration(){return __classPrivateFieldGet(this,Ri,"f")}set loggerConfiguration(i){__classPrivateFieldSet(this,Ri,Object.assign({},$,i),"f"),LoggerManager.setLoggerLevel(__classPrivateFieldGet(this,Ri,"f"))}get initializationPromise(){return __classPrivateFieldGet(this,Di,"f").promise}get model(){return this.behaviors.model}get behaviors(){return __classPrivateFieldGet(this,Ti,"f")}get configuration(){return this.behaviors.configuration}set configuration(i){this.logger.info("set configuration",{configuration:i}),__classPrivateFieldGet(this,_i,"m",Vi).call(this,{configuration:i}),this.initialize()}get intention(){return this.behaviors.intention}set intention(i){this.logger.info("set intention",i),this.behaviors.intention=i,__classPrivateFieldGet(this,_i,"m",Ai).call(this)}get events(){return PublicEvent.getInstance()}get internalEvents(){return InternalEvent.getInstance()}get context(){return this.behaviors.history.context}get grabber(){return this.behaviors.grabber}get currentPenStyle(){return this.behaviors.currentPenStyle}get penStyle(){return this.behaviors.penStyle}set penStyle(i){this.logger.info("set penStyle",{ps:i}),this.behaviors.setPenStyle(i)}get theme(){return this.behaviors.theme}set theme(i){this.logger.info("set theme",{t:i}),this.behaviors.setTheme(i)}get penStyleClasses(){return this.behaviors.penStyleClasses}set penStyleClasses(i){this.logger.info("set penStyleClasses",{psc:i}),this.behaviors.setPenStyleClasses(i)}closeMessageModal(){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ei,"f").style.display="none",__classPrivateFieldGet(this,Ci,"f").innerText="",__classPrivateFieldGet(this,Mi,"f").classList.contains("error-msg")&&(__classPrivateFieldGet(this,Mi,"f").classList.remove("error-msg"),yield this.behaviors.destroy(),this.initialize())}))}showError(i){__classPrivateFieldGet(this,Mi,"f").classList.add("error-msg"),__classPrivateFieldGet(this,Mi,"f").classList.remove("info-msg"),__classPrivateFieldGet(this,Ei,"f").style.display="block",__classPrivateFieldGet(this,Ci,"f").innerText="string"==typeof i?i:i.message}showNotif(i){__classPrivateFieldGet(this,Mi,"f").classList.add("info-msg"),__classPrivateFieldGet(this,Mi,"f").classList.remove("error-msg"),__classPrivateFieldGet(this,Ei,"f").style.display="block",__classPrivateFieldGet(this,Ci,"f").innerText=i.message,setTimeout((()=>{this.closeMessageModal()}),i.timeout||2500)}initialize(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("initialize"),__classPrivateFieldGet(this,_i,"m",Wi).call(this),yield __classPrivateFieldGet(this,_i,"m",Hi).call(this),__classPrivateFieldGet(this,_i,"m",Ui).call(this)}))}waitForIdle(){return __awaiter(this,void 0,void 0,(function*(){if(this.behaviors.waitForIdle)return this.behaviors.waitForIdle()}))}undo(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("undo"),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.undo(),this.logger.debug("undo",this.model),this.model}))}redo(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("redo"),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.redo(),this.logger.debug("redo",this.model),this.model}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("clear"),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.clear(),this.events.emitCleared(this.model),this.logger.debug("clear",this.model),this.model}))}resize(){var i;return __awaiter(this,void 0,void 0,(function*(){this.logger.info("resize"),yield __classPrivateFieldGet(this,Di,"f").promise,this.configuration.rendering.smartGuide.enable&&(null===(i=__classPrivateFieldGet(this,Oi,"f"))||void 0===i||i.resize());const s=window.getComputedStyle(this.wrapperHTML),r=Math.max(parseInt(s.height.replace("px","")),this.configuration.rendering.minHeight),n=Math.max(parseInt(s.width.replace("px","")),this.configuration.rendering.minWidth);return yield this.behaviors.resize(r,n),this.logger.debug("resize",this.model),this.model}))}export(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("export",{mimeTypes:i}),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.export(i),this.logger.debug("export",this.model),this.model}))}convert(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("export",{params:i}),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.convert(null==i?void 0:i.conversionState,null==i?void 0:i.mimeTypes),this.events.emitConverted(this.model.converts),this.logger.debug("convert",this.model),this.model}))}import(i,s){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info("import",{data:i,mimeType:s}),yield __classPrivateFieldGet(this,Di,"f").promise,this.behaviors.import){let r;return r=i instanceof Blob?i:"string"==typeof i?new Blob([i]):new Blob([JSON.stringify(i)]),yield this.behaviors.import(r,s),this.events.emitImported(this.model.exports),this.logger.debug("import",this.model),this.model}return Promise.reject("Import impossible, behaviors has no import function")}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("importPointEvents",{strokes:i}),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.importPointEvents(i),this.events.emitImported(this.model.exports),this.logger.debug("importPointEvents",this.model),this.model}))}}Pi=new WeakMap,ki=new WeakMap,Ei=new WeakMap,Mi=new WeakMap,Gi=new WeakMap,Ci=new WeakMap,Fi=new WeakMap,Li=new WeakMap,Ii=new WeakMap,Ti=new WeakMap,Oi=new WeakMap,Di=new WeakMap,Ri=new WeakMap,Yi=new WeakMap,Xi=new WeakMap,qi=new WeakMap,Ji=new WeakMap,_i=new WeakSet,Ai=function _Editor_setCursorIntention(){switch(this.behaviors.intention){case i.Erase:this.wrapperHTML.classList.remove("draw"),this.wrapperHTML.classList.add("erase"),this.wrapperHTML.classList.remove("select");break;case i.Select:this.wrapperHTML.classList.remove("draw"),this.wrapperHTML.classList.remove("erase"),this.wrapperHTML.classList.add("select");break;default:this.wrapperHTML.classList.add("draw"),this.wrapperHTML.classList.remove("erase"),this.wrapperHTML.classList.remove("select")}},Bi=function _Editor_createLoader(){return __classPrivateFieldSet(this,ki,document.createElement("div"),"f"),__classPrivateFieldGet(this,ki,"f").classList.add("loader"),__classPrivateFieldGet(this,ki,"f").style.display="none",__classPrivateFieldGet(this,ki,"f")},$i=function _Editor_createMessage(){__classPrivateFieldSet(this,Ei,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ei,"f").classList.add("message-container"),__classPrivateFieldGet(this,Ei,"f").style.display="none",__classPrivateFieldSet(this,Gi,document.createElement("div"),"f"),__classPrivateFieldGet(this,Gi,"f").classList.add("message-overlay"),__classPrivateFieldGet(this,Ei,"f").appendChild(__classPrivateFieldGet(this,Gi,"f")),__classPrivateFieldSet(this,Mi,document.createElement("div"),"f"),__classPrivateFieldGet(this,Mi,"f").classList.add("message-modal");const i=document.createElement("button");return i.classList.add("ms-button","close"),i.addEventListener("pointerup",(()=>this.closeMessageModal())),__classPrivateFieldGet(this,Mi,"f").appendChild(i),__classPrivateFieldSet(this,Ci,document.createElement("p"),"f"),__classPrivateFieldGet(this,Mi,"f").appendChild(__classPrivateFieldGet(this,Ci,"f")),__classPrivateFieldGet(this,Ei,"f").appendChild(__classPrivateFieldGet(this,Mi,"f")),__classPrivateFieldGet(this,Ei,"f")},Ni=function _Editor_createEditorState(){return __classPrivateFieldSet(this,Fi,document.createElement("div"),"f"),__classPrivateFieldGet(this,Fi,"f").classList.add("state"),__classPrivateFieldSet(this,Ii,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ii,"f").textContent="idle",__classPrivateFieldGet(this,Ii,"f").style.display="block",__classPrivateFieldGet(this,Fi,"f").appendChild(__classPrivateFieldGet(this,Ii,"f")),__classPrivateFieldSet(this,Li,document.createElement("div"),"f"),__classPrivateFieldGet(this,Li,"f").classList.add("busy"),__classPrivateFieldGet(this,Li,"f").style.display="none",__classPrivateFieldGet(this,Fi,"f").appendChild(__classPrivateFieldGet(this,Li,"f")),__classPrivateFieldGet(this,Fi,"f").style.display="none",__classPrivateFieldGet(this,Fi,"f")},zi=function _Editor_updateEditorState(i){this.configuration.offscreen?(__classPrivateFieldGet(this,Fi,"f").style.display="block",i?(__classPrivateFieldGet(this,Ii,"f").style.display="block",__classPrivateFieldGet(this,Li,"f").style.display="none"):(__classPrivateFieldGet(this,Ii,"f").style.display="none",__classPrivateFieldGet(this,Li,"f").style.display="block")):__classPrivateFieldGet(this,Fi,"f").style.display="none"},ji=function _Editor_createLayerInfos(){return __classPrivateFieldSet(this,Pi,document.createElement("div"),"f"),__classPrivateFieldGet(this,Pi,"f").classList.add("ms-layer-infos"),__classPrivateFieldGet(this,Pi,"f").appendChild(__classPrivateFieldGet(this,_i,"m",Bi).call(this)),__classPrivateFieldGet(this,Pi,"f").appendChild(__classPrivateFieldGet(this,_i,"m",$i).call(this)),__classPrivateFieldGet(this,Pi,"f").appendChild(__classPrivateFieldGet(this,_i,"m",Ni).call(this)),__classPrivateFieldGet(this,Pi,"f")},Vi=function _Editor_instantiateBehaviors(i){var s;if(this.logger.info("instantiateBehaviors",{options:i}),!(null==i?void 0:i.configuration))throw new Error("Configuration required");this.internalEvents.removeAllListeners(),__classPrivateFieldGet(this,Ti,"f")&&__classPrivateFieldGet(this,Ti,"f").destroy(),i.configuration.offscreen?__classPrivateFieldSet(this,Ti,new OIBehaviors(i,__classPrivateFieldGet(this,Pi,"f")),"f"):"REST"===(null===(s=i.configuration.server)||void 0===s?void 0:s.protocol)?__classPrivateFieldSet(this,Ti,new RestBehaviors(i),"f"):__classPrivateFieldSet(this,Ti,new WSBehaviors(i),"f"),this.logger.debug("instantiateBehaviors",__classPrivateFieldGet(this,Ti,"f"))},Hi=function _Editor_initializeBehaviors(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("initializeBehaviors","start"),__classPrivateFieldSet(this,Di,new DeferredPromise,"f"),__classPrivateFieldGet(this,ki,"f").style.display="initial",this.closeMessageModal(),this.behaviors.init(this.wrapperHTML).then((()=>__awaiter(this,void 0,void 0,(function*(){this.logger.info("initializeBehaviors","then"),this.wrapperHTML.editor=this,__classPrivateFieldGet(this,Di,"f").resolve(),this.events.emitLoaded()})))).catch((i=>{this.logger.error("initializeBehaviors",i),__classPrivateFieldGet(this,Di,"f").reject(i),this.showError(i)})).finally((()=>(this.logger.debug("initializeBehaviors","finally"),__classPrivateFieldGet(this,ki,"f").style.display="none",__classPrivateFieldGet(this,_i,"m",zi).call(this,!0),__classPrivateFieldGet(this,Di,"f").promise)))}))},Ui=function _Editor_initializeSmartGuide(){var i;if(null===(i=__classPrivateFieldGet(this,Oi,"f"))||void 0===i||i.destroy(),this.logger.info("initializeSmartGuide",{smartGuide:this.configuration.rendering.smartGuide}),this.configuration.rendering.smartGuide.enable){let i;switch(__classPrivateFieldSet(this,Oi,new SmartGuide,"f"),this.configuration.recognition.type){case"TEXT":i=this.configuration.recognition.text.margin;break;case"MATH":i=this.configuration.recognition.math.margin;break;default:i={top:20,left:10,right:10,bottom:10}}__classPrivateFieldGet(this,Oi,"f").init(__classPrivateFieldGet(this,Pi,"f"),i,this.configuration.rendering)}},Wi=function _Editor_addInternalListeners(){this.internalEvents.removeAllListeners(),this.internalEvents.addConvertListener(this.convert.bind(this)),this.internalEvents.addClearListener(this.clear.bind(this)),this.internalEvents.addErrorListener(this.showError.bind(this)),this.internalEvents.addNotifListener(this.showNotif.bind(this)),this.internalEvents.addClearMessageListener(this.closeMessageModal.bind(this)),this.internalEvents.addImportJIIXListener(__classPrivateFieldGet(this,_i,"m",Ki).bind(this)),this.internalEvents.addExportedListener(__classPrivateFieldGet(this,_i,"m",Zi).bind(this)),this.internalEvents.addContextChangeListener(__classPrivateFieldGet(this,qi,"f").bind(this)),this.internalEvents.addIdleListener(__classPrivateFieldGet(this,Ji,"f").bind(this)),this.internalEvents.addSelectedListener(__classPrivateFieldGet(this,Yi,"f").bind(this)),this.internalEvents.addIntentionListener(__classPrivateFieldGet(this,Xi,"f").bind(this))},Zi=function _Editor_onExport(i){var s;if(this.logger.info("onExport",{exports:i}),this.configuration.rendering.smartGuide.enable&&i&&i["application/vnd.myscript.jiix"]){const r=i["application/vnd.myscript.jiix"];null===(s=__classPrivateFieldGet(this,Oi,"f"))||void 0===s||s.update(r)}this.events.emitExported(i)},Ki=function _Editor_onImportJIIX(i){this.logger.info("onImportJIIX",{jiix:i}),this.import(new Blob([JSON.stringify(i)],{type:ie.JIIX}),ie.JIIX)};export{Box,CanvasRenderer,CanvasRendererShape,CanvasRendererStroke,CanvasRendererText,Configuration,oe as DecoratorKind,B as DefaultConfiguration,C as DefaultConvertionConfiguration,k as DefaultDebugConfiguration,y as DefaultDiagramConfiguration,g as DefaultDiagramConvertConfiguration,v as DefaultEraserConfiguration,b as DefaultExportConfiguration,p as DefaultGrabberConfiguration,L as DefaultGuidesConfiguration,f as DefaultJiixConfiguration,u as DefaultListenerConfiguration,$ as DefaultLoggerConfiguration,x as DefaultMarginConfiguration,_ as DefaultMathConfiguration,S as DefaultMathUndoRedoConfiguration,m as DefaultMenuConfiguration,le as DefaultPenStyle,P as DefaultRawContentConfiguration,F as DefaultRecognitionConfiguration,E as DefaultRecognitionRendererConfiguration,T as DefaultRenderingConfiguration,O as DefaultServerConfiguration,I as DefaultSmartGuidesConfiguration,w as DefaultSolverConfiguration,ae as DefaultStyle,G as DefaultTextConfiguration,M as DefaultTextGuidesConfiguration,de as DefaultTheme,D as DefaultTriggerConfiguration,R as DefaultUndoRedoConfiguration,DeferredPromise,we as EdgeDecoration,xe as EdgeKind,Editor,Q as EventType,ie as ExportType,HistoryManager,Xe as InsertAction,i as Intention,InternalEvent,W as InternalEventType,se as JIIXELementType,ne as JIIXEdgeKind,re as JIIXNodeKind,Logger,d as LoggerClass,l as LoggerLevel,LoggerManager,MatrixTransform,Model,OIBehaviors,OIConversionManager,OIDebugSVGManager,OIDecorator,OIEdgeArc,OIEdgeBase,OIEdgeLine,OIEdgePolyLine,OIEraseManager,OIEraser,OIGestureManager,OIHistoryManager,OIMenu,OIMenuAction,OIMenuContext,OIMenuIntention,OIMenuManager,OIMenuStyle,OIMenuSub,OIModel,OIMoveManager,OIPointerEventGrabber,OIRecognizer,OIResizeManager,OIRotationManager,OISVGRenderer,ze as OISVGRendererConst,OISVGRendererDecoratorUtil,OISVGRendererEdgeUtil,OISVGRendererEraserUtil,OISVGRendererGroupUtil,OISVGRendererShapeUtil,OISVGRendererStrokeUtil,OISVGRendererTextUtil,OISelectionManager,OIShapeBase,OIShapeCircle,OIShapeEllipse,OIShapePolygon,OISnapManager,OIStroke,OISymbolBase,OISymbolGroup,OIText,OITextManager,OITranslateManager,OIWriteManager,PointerEventGrabber,PublicEvent,Ee as RecognizerError,n as ResizeDirection,RestBehaviors,RestRecognizer,a as SELECTION_MARGIN,SVGBuilder,SVGStroker,Se as ShapeKind,SmartGuide,Ye as StrikeThroughAction,Stroke,pe as StyleHelper,StyleManager,We as SurroundAction,r as SvgElementRole,be as SymbolType,Me as TOIMessageType,WSBehaviors,WSRecognizer,WSSVGRenderer,s as WriteTool,computeAngleAxeRadian,computeAngleRadian,computeAverage,computeDistance,computeDistanceBetweenPointAndSegment,computeHmac,computeLinksPointers,computeMiddlePointer,computeNearestPointOnSegment,computePointOnEllipse,computeRotatedPoint,convertBoundingBoxMillimeterToPixel,convertDegreeToRadian,convertMillimeterToPixel,convertPartialStrokesToOIStrokes,convertPartialStrokesToStrokes,convertPixelToMillimeter,convertRadianToDegree,createPointsOnSegment,createUUID,findIntersectBetweenSegmentAndCircle,findIntersectionBetween2Segment,getAvailableFontList,getAvailableLanguageList,getClosestPoint,getClosestPoints,getInitialUndoRedoContext,isBetween,isPointInsideBox,isPointInsidePolygon,isValidNumber,isValidPoint,isVersionSuperiorOrEqual,mergeDeep,scalaire};
//# sourceMappingURL=iink.esm.js.map
