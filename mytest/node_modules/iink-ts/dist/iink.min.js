!function(i,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((i="undefined"!=typeof globalThis?globalThis:i||self).iink={})}(this,(function(i){"use strict";var r,s,n,a;i.Intention=void 0,(r=i.Intention||(i.Intention={})).Write="write",r.Erase="erase",r.Select="select",r.Move="move",i.WriteTool=void 0,(s=i.WriteTool||(i.WriteTool={})).Pencil="pencil",s.Rectangle="rectangle",s.Rhombus="rhombus",s.Circle="circle",s.Ellipse="ellipse",s.Triangle="triangle",s.Parallelogram="parallelogram",s.Line="line",s.Arrow="arrow",s.DoubleArrow="double-arrow",i.SvgElementRole=void 0,(n=i.SvgElementRole||(i.SvgElementRole={})).Guide="guide",n.InteractElementsGroup="interact-elements-group",n.Translate="translate",n.Resize="resize",n.Rotate="rotate",i.ResizeDirection=void 0,(a=i.ResizeDirection||(i.ResizeDirection={})).North="n-resize",a.East="e-resize",a.South="s-resize",a.West="w-resize",a.NorthEast="ne-resize",a.NorthWest="nw-resize",a.SouthEast="se-resize",a.SouthWest="sw-resize";const l=10;function __awaiter(i,r,s,n){return new(s||(s=Promise))((function(a,l){function fulfilled(i){try{step(n.next(i))}catch(i){l(i)}}function rejected(i){try{step(n.throw(i))}catch(i){l(i)}}function step(i){i.done?a(i.value):function adopt(i){return i instanceof s?i:new s((function(r){r(i)}))}(i.value).then(fulfilled,rejected)}step((n=n.apply(i,r||[])).next())}))}function __classPrivateFieldGet(i,r,s,n){if("a"===s&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof r?i!==r||!n:!r.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(i):n?n.value:r.get(i)}function __classPrivateFieldSet(i,r,s,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof r?i!==r||!a:!r.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(i,s):a?a.value=s:r.set(i,s),s}"function"==typeof SuppressedError&&SuppressedError;var d,h,c,u;i.LoggerLevel=void 0,(d=i.LoggerLevel||(i.LoggerLevel={})).DEBUG="1",d.INFO="2",d.WARN="3",d.ERROR="4",i.LoggerClass=void 0,(h=i.LoggerClass||(i.LoggerClass={})).EDITOR="EDITOR",h.RECOGNIZER="RECOGNIZER",h.GRABBER="GRABBER",h.BEHAVIORS="BEHAVIORS",h.GESTURE="GESTURE",h.CONFIGURATION="CONFIGURATION",h.PUBLIC_EVENT="PUBLIC_EVENT",h.MODEL="MODEL",h.RENDERER="RENDERER",h.SMARTGUIDE="SMARTGUIDE",h.STYLE="STYLE",h.HISTORY="HISTORY",h.SYMBOL="SYMBOL",h.INTERNAL_EVENT="INTERNAL_EVENT",h.WRITE="WRITE",h.TRANSFORMER="TRANSFORMER",h.CONVERTER="CONVERTER",h.SELECTION="SELECTION",h.SVGDEBUG="SVGDEBUG",h.MENU="MENU";class Logger{constructor(i,r){this.instanceName=i,this.level=r}debug(r,...s){if(i.LoggerLevel.DEBUG>=this.level){const i={from:`${this.instanceName}.${r}`,message:s};console.debug(i)}}info(r,...s){if(i.LoggerLevel.INFO>=this.level){const i={from:`${this.instanceName}.${r}`,message:s};console.info(i)}}warn(r,...s){if(i.LoggerLevel.WARN>=this.level){const i={from:`${this.instanceName}.${r}`,message:s};console.warn(i)}}error(i,...r){const s={from:`${this.instanceName}.${i}`,error:r};console.error(s)}}class LoggerManager{static getLogger(r){return __classPrivateFieldGet(this,c,"f",u).has(r)||__classPrivateFieldGet(this,c,"f",u).set(r,new Logger(r,i.LoggerLevel.ERROR)),__classPrivateFieldGet(this,c,"f",u).get(r)}static setLoggerLevel(i){Object.keys(i).forEach((r=>{c.getLogger(r).level=i[r]}))}}c=LoggerManager,u={value:new Map};class DeferredPromise{constructor(){this.isFullFilled=!1,this.isPending=!0,this.promise=new Promise(((i,r)=>{this.reject=i=>__awaiter(this,void 0,void 0,(function*(){return this.isFullFilled=!0,this.isPending=!1,r(i)})),this.resolve=r=>__awaiter(this,void 0,void 0,(function*(){return this.isFullFilled=!0,this.isPending=!1,i(r)}))}))}}function isValidNumber(i){return null!=i&&(!isNaN(parseFloat(i.toString()))&&isFinite(+i))}function isBetween(i,r,s){return i>=r&&i<=s}function computeAverage(i){return i.reduce(((i,r)=>i+r),0)/(i.length||1)}function computeDistance(i,r){const s=Math.hypot(r.y-i.y,r.x-i.x);return isNaN(s)?0:s}function computeAngleAxeRadian(i,r){return Math.atan2(r.y-i.y,r.x-i.x)}function scalaire(i,r){return i.x*r.x+i.y*r.y}function computeNearestPointOnSegment(i,r){const s={x:i.x-r.p1.x,y:i.y-r.p1.y},n={x:r.p2.x-r.p1.x,y:r.p2.y-r.p1.y};if(0===n.x&&0===n.y)return r.p1;const a=scalaire(s,n),l=scalaire(n,n),d=Math.min(1,Math.max(0,a/l));return{x:r.p1.x+n.x*d,y:r.p1.y+n.y*d}}function convertRadianToDegree(i){return+(i%(2*Math.PI)/Math.PI*180).toFixed(4)}function convertDegreeToRadian(i){return+(i%360/180*Math.PI).toFixed(4)}function computeRotatedPoint(i,r,s){const n=i.x-r.x,a=i.y-r.y,l=Math.cos(s),d=Math.sin(s);return{x:+(r.x+l*n-d*a).toFixed(3),y:+(r.y+d*n+l*a).toFixed(3)}}function computePointOnEllipse(i,r,s,n,a){const l=Math.cos(n),d=Math.sin(n),h=Math.abs(r)*Math.cos(a),c=Math.abs(s)*Math.sin(a);return{x:+(i.x+l*h-d*c).toFixed(3),y:+(i.y+d*h+l*c).toFixed(3)}}function findIntersectionBetween2Segment(i,r){if(i.p1.x===r.p1.x&&i.p1.y===r.p1.y)return i.p1;if(i.p1.x===r.p2.x&&i.p1.y===r.p2.y)return i.p1;if(i.p2.x===r.p1.x&&i.p2.y===r.p1.y)return i.p2;if(i.p2.x===r.p2.x&&i.p2.y===r.p2.y)return i.p2;const s=i.p2.x-i.p1.x,n=i.p2.y-i.p1.y,a=r.p2.x-r.p1.x,l=r.p2.y-r.p1.y,d=i.p1.x-r.p1.x,h=i.p1.y-r.p1.y,c=a*h-l*d,u=s*h-n*d,p=l*s-a*n;if(0===c||0===u||0===p)return;const m=c/p,g=u/p;return isBetween(m,0,1)&&isBetween(g,0,1)?{x:i.p1.x+m*s,y:i.p1.y+m*n}:void 0}function findIntersectBetweenSegmentAndCircle(i,r,s){const n=[],a=Math.pow(i.p2.x-i.p1.x,2)+Math.pow(i.p2.y-i.p1.y,2),l=2*((i.p2.x-i.p1.x)*(i.p1.x-r.x)+(i.p2.y-i.p1.y)*(i.p1.y-r.y)),d=Math.pow(r.x,2)+Math.pow(r.y,2)+Math.pow(i.p1.x,2)+Math.pow(i.p1.y,2)-2*(r.x*i.p1.x+r.y*i.p1.y)-Math.pow(s,2),h=Math.pow(l,2)-4*a*d;if(h<=0)return[];const c=Math.sqrt(h),u=(-l+c)/(2*a),p=(-l-c)/(2*a);return(u<0||u>1)&&(p<0||p>1)||(isBetween(u,0,1)&&n.push({x:(i.p2.x-i.p1.x)*u+i.p1.x,y:(i.p2.y-i.p1.y)*u+i.p1.y}),isBetween(p,0,1)&&n.push({x:(i.p2.x-i.p1.x)*p+i.p1.x,y:(i.p2.y-i.p1.y)*p+i.p1.y})),n}function computeAngleRadian(i,r,s){const n=Math.sqrt(Math.pow(r.x-i.x,2)+Math.pow(r.y-i.y,2)),a=Math.sqrt(Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2)),l=Math.sqrt(Math.pow(s.x-i.x,2)+Math.pow(s.y-i.y,2));return Math.acos((a*a+n*n-l*l)/(2*a*n))}function getClosestPoints(i,r){let s=i[0],n=r[0],a=Number.MAX_SAFE_INTEGER;return i.forEach((i=>{r.forEach((r=>{const l=computeDistance(i,r);a>l&&(a=l,s=i,n=r)}))})),{p1:s,p2:n}}function getClosestPoint(i,r){let s,n=Number.MAX_SAFE_INTEGER,a=-1;return i.forEach(((i,l)=>{const d=computeDistance(i,r);n>d&&(n=d,s=i,a=l)})),{point:s,index:a}}function isPointInsidePolygon(i,r){let s=!1;for(let n=0,a=r.length-1;n<r.length;a=n++){const l=r[n],d=r[a];l.y>i.y!=d.y>i.y&&i.x<(d.x-l.x)*(i.y-l.y)/(d.y-l.y)+l.x&&(s=!s)}return s}const isVersionSuperiorOrEqual=(i,r)=>{const s=i.split("."),n=r.split(".");for(let i=0;i<n.length;i++){const r=Number(n[i]),a=Number(s[i]);if(r>a)return!1;if(r<a)return!0}return!0};function computeHmac(i,r,s){return __awaiter(this,void 0,void 0,(function*(){const n=new TextEncoder,a=n.encode(i),l=n.encode(r+s),d=yield crypto.subtle.importKey("raw",l,{name:"HMAC",hash:{name:"SHA-512"}},!1,["sign"]),h=yield crypto.subtle.sign("HMAC",d,a),c=new Uint8Array(h);return Array.prototype.map.call(c,(i=>i.toString(16).padStart(2,"0"))).join("")}))}function convertMillimeterToPixel(i){return+(96*i/25.4).toFixed(3)}function convertBoundingBoxMillimeterToPixel(i){return i?{x:convertMillimeterToPixel(i.x),y:convertMillimeterToPixel(i.y),width:convertMillimeterToPixel(i.width),height:convertMillimeterToPixel(i.height)}:{height:0,width:0,x:0,y:0}}function createUUID(){let i=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(r){const s=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==r?s:3&s|8).toString(16)}))}const mergeDeep=(i,...r)=>{const isObject=i=>i&&"object"==typeof i&&!Array.isArray(i);if(!r.length)return i;const s=r.shift();if(isObject(i)&&isObject(s))for(const r in s)isObject(s[r])?(i[r]||Object.assign(i,{[r]:{}}),mergeDeep(i[r],s[r])):Array.isArray(i[r])&&Array.isArray(s[r])?i[r].concat(s[r]):Object.assign(i,{[r]:s[r]});else Array.isArray(i)&&Array.isArray(s)?i=i.concat(s):s&&(i=s);return mergeDeep(i,...r)};function getAvailableLanguageList(i){var r,s;return __awaiter(this,void 0,void 0,(function*(){if((null===(r=null==i?void 0:i.server)||void 0===r?void 0:r.scheme)&&(null===(s=null==i?void 0:i.server)||void 0===s?void 0:s.host)){const r=i.server;return(yield fetch(`${r.scheme}://${r.host}/api/v4.0/iink/availableLanguageList`)).json()}return Promise.reject("Failed to get languages: configuration.server.scheme & configuration.server.host are required!")}))}function computeLinksPointers(i,r,s){const n=i.p*s;return[{x:+(i.x-Math.sin(r)*n).toFixed(3),y:+(i.y+Math.cos(r)*n).toFixed(3)},{x:+(i.x+Math.sin(r)*n).toFixed(3),y:+(i.y-Math.cos(r)*n).toFixed(3)}]}function computeMiddlePointer(i,r){return{x:+((r.x+i.x)/2).toFixed(3),y:+((r.y+i.y)/2).toFixed(3),p:+((r.p+i.p)/2).toFixed(3),t:+((r.t+i.t)/2).toFixed(3)}}const p={capture:!1,passive:!0},m={listenerOptions:p,xyFloatPrecision:0,timestampFloatPrecision:0,delayLongTouch:500},g={enable:!0,style:{enable:!0},intention:{enable:!0},action:{enable:!0},context:{enable:!0}},v={"erase-precisely":!1},y={types:["text","shape"],"match-text-size":!0},f={convert:y,eraser:v,mimeTypes:["application/vnd.myscript.jiix"]},b={"bounding-box":!1,strokes:!1,ids:!1,"full-stroke-ids":!1,text:{chars:!1,words:!0}},x={"image-resolution":300,jiix:b},S={top:20,left:10,right:10,bottom:10},w={enable:!0,"fractional-part-digits":3,"decimal-separator":".","rounding-mode":"half up","angle-unit":"deg"},_={mode:"stroke"},P={solver:w,margin:S,eraser:v,"undo-redo":_,mimeTypes:["application/vnd.myscript.jiix"]},E={recognition:{types:["text","shape"]},eraser:v,gestures:["underline","scratch-out","join","insert","strike-through","surround"]},k={"draw-text-boxes":!1,"draw-image-boxes":!1},M={debug:k},C={enable:!0},G={guides:C,eraser:v,margin:S,mimeTypes:["application/vnd.myscript.jiix"]},T={force:{"on-stylesheet-change":!1}},I={diagram:f,export:x,math:P,"raw-content":E,renderer:M,text:G,type:"TEXT",alwaysConnected:!0,lang:"en_US",gesture:{enable:!0,ignoreGestureStrokes:!1},convert:T},L={enable:!0,gap:50,type:"point"},F={enable:!0},O={guides:L,smartGuide:F,minHeight:100,minWidth:100},D={protocol:"WEBSOCKET",scheme:"https",host:"cloud.myscript.com",applicationKey:"",hmacKey:"",version:"2.3.0",useWindowLocation:!1,websocket:{pingEnabled:!0,pingDelay:15e3,maxPingLostCount:20,autoReconnect:!0,maxRetryCount:2,fileChunkSize:3e5}},R={exportContent:"POINTER_UP",exportContentDelay:1e3,resizeTriggerDelay:100},A={maxStackSize:100};var B;const $={offscreen:!1,server:D,recognition:I,grabber:m,rendering:O,triggers:R,"undo-redo":A,menu:g};class Configuration{constructor(r){B.set(this,LoggerManager.getLogger(i.LoggerClass.CONFIGURATION)),__classPrivateFieldGet(this,B,"f").info("constructor",{configuration:r}),this.offscreen=$.offscreen,this.grabber=structuredClone($.grabber),this.recognition=structuredClone($.recognition),this.rendering=structuredClone($.rendering),this.server=structuredClone($.server),this["undo-redo"]=structuredClone($["undo-redo"]),this.triggers=structuredClone($.triggers),this.menu=structuredClone($.menu),this.overrideDefaultConfiguration(r)}overrideDefaultConfiguration(i){var r,s,n,a,l,d,h,c,u,p,m,g,v,y,f;__classPrivateFieldGet(this,B,"f").info("overrideDefaultConfiguration",{configuration:i});const b=structuredClone($);this.offscreen=Boolean(null==i?void 0:i.offscreen),this.grabber=mergeDeep({},b.grabber,null==i?void 0:i.grabber),this.recognition=mergeDeep({},b.recognition,null==i?void 0:i.recognition),this.rendering=mergeDeep({},b.rendering,null==i?void 0:i.rendering),this.server=mergeDeep({},b.server,null==i?void 0:i.server),this.triggers=mergeDeep({},b.triggers,null==i?void 0:i.triggers),this["undo-redo"]=mergeDeep({},b["undo-redo"],null==i?void 0:i["undo-redo"]),this.menu=mergeDeep({},b.menu,null==i?void 0:i.menu),(null===(s=null===(r=null==i?void 0:i.recognition)||void 0===r?void 0:r.text)||void 0===s?void 0:s.mimeTypes)&&(this.recognition.text.mimeTypes=i.recognition.text.mimeTypes),(null===(a=null===(n=null==i?void 0:i.recognition)||void 0===n?void 0:n.math)||void 0===a?void 0:a.mimeTypes)&&(this.recognition.math.mimeTypes=i.recognition.math.mimeTypes),(null===(d=null===(l=null==i?void 0:i.recognition)||void 0===l?void 0:l.diagram)||void 0===d?void 0:d.mimeTypes)&&(this.recognition.diagram.mimeTypes=i.recognition.diagram.mimeTypes),(null===(u=null===(c=null===(h=null==i?void 0:i.recognition)||void 0===h?void 0:h.diagram)||void 0===c?void 0:c.convert)||void 0===u?void 0:u.types)&&(this.recognition.diagram.convert.types=i.recognition.diagram.convert.types),(null===(m=null===(p=null==i?void 0:i.recognition)||void 0===p?void 0:p["raw-content"])||void 0===m?void 0:m.gestures)&&(this.recognition["raw-content"].gestures=i.recognition["raw-content"].gestures),(null===(y=null===(v=null===(g=null==i?void 0:i.recognition)||void 0===g?void 0:g["raw-content"])||void 0===v?void 0:v.recognition)||void 0===y?void 0:y.types)&&(this.recognition["raw-content"].recognition.types=i.recognition["raw-content"].recognition.types),(null===(f=this.server)||void 0===f?void 0:f.useWindowLocation)&&(this.server.scheme=window.location.protocol.indexOf("s")>-1?"https":"http",this.server.host=window.location.host),this.offscreen?(this.recognition.type="Raw Content",this.rendering.smartGuide.enable=!1,this.server.protocol="WEBSOCKET",this.recognition.export.jiix["full-stroke-ids"]=!0,this.recognition.export.jiix.ids=!0,this.recognition.export.jiix.text.words=!0,this.recognition.export.jiix.text.chars=!0,this.recognition.export.jiix["bounding-box"]=!0):("REST"===this.server.protocol&&"POINTER_UP"===this.triggers.exportContent&&(this.triggers.exportContent="QUIET_PERIOD",this.triggers.exportContentDelay=Math.max(this.triggers.exportContentDelay,50)),"WEBSOCKET"===this.server.protocol&&"TEXT"===this.recognition.type?this.rendering.smartGuide.enable&&!this.recognition.text.mimeTypes.includes("application/vnd.myscript.jiix")&&this.recognition.text.mimeTypes.push("application/vnd.myscript.jiix"):this.rendering.smartGuide.enable=!1,delete this.recognition["raw-content"].gestures,this.menu.style.enable=!1),__classPrivateFieldGet(this,B,"f").debug("overrideDefaultConfiguration",{configuration:this})}}B=new WeakMap;const N={[i.LoggerClass.EDITOR]:i.LoggerLevel.ERROR,[i.LoggerClass.BEHAVIORS]:i.LoggerLevel.ERROR,[i.LoggerClass.RECOGNIZER]:i.LoggerLevel.ERROR,[i.LoggerClass.GRABBER]:i.LoggerLevel.ERROR,[i.LoggerClass.RENDERER]:i.LoggerLevel.ERROR,[i.LoggerClass.CONFIGURATION]:i.LoggerLevel.ERROR,[i.LoggerClass.PUBLIC_EVENT]:i.LoggerLevel.ERROR,[i.LoggerClass.INTERNAL_EVENT]:i.LoggerLevel.ERROR,[i.LoggerClass.MODEL]:i.LoggerLevel.ERROR,[i.LoggerClass.SYMBOL]:i.LoggerLevel.ERROR,[i.LoggerClass.SMARTGUIDE]:i.LoggerLevel.ERROR,[i.LoggerClass.GESTURE]:i.LoggerLevel.ERROR,[i.LoggerClass.STYLE]:i.LoggerLevel.ERROR,[i.LoggerClass.HISTORY]:i.LoggerLevel.ERROR,[i.LoggerClass.TRANSFORMER]:i.LoggerLevel.ERROR,[i.LoggerClass.CONVERTER]:i.LoggerLevel.ERROR,[i.LoggerClass.WRITE]:i.LoggerLevel.ERROR,[i.LoggerClass.SELECTION]:i.LoggerLevel.ERROR,[i.LoggerClass.SVGDEBUG]:i.LoggerLevel.ERROR,[i.LoggerClass.MENU]:i.LoggerLevel.ERROR};var z,j,V,W,H,U,X,K,Y,J,q,Z,Q,ee,te,ie,re,se,ne,oe,ae;i.InternalEventType=void 0,(X=i.InternalEventType||(i.InternalEventType={})).SVG_PATCH="internal_svg_patch",X.EXPORTED="internal_exported",X.CLEAR_MESSAGE="internal_clear_message",X.ERROR="internal_error",X.NOTIF="internal_notif",X.IMPORT_JIIX="internal_import_jiix",X.CONVERT="internal_convert",X.CLEAR="internal_clear",X.CONTEXT_CHANGE="internal_context_change",X.IDLE="internal_idle",X.SELECTED="internal_selected",X.INTENTION="internal_intention";class InternalEvent extends EventTarget{constructor(){super(),z.add(this),W.set(this,void 0),H.set(this,LoggerManager.getLogger(i.LoggerClass.INTERNAL_EVENT)),__classPrivateFieldGet(this,H,"f").info("constructor"),__classPrivateFieldSet(this,W,new AbortController,"f")}static getInstance(){return __classPrivateFieldGet(j,j,"f",V)||__classPrivateFieldSet(j,j,new j,"f",V),__classPrivateFieldGet(j,j,"f",V)}removeAllListeners(){__classPrivateFieldGet(this,H,"f").info("removeAllListeners"),__classPrivateFieldGet(this,W,"f").abort(),__classPrivateFieldSet(this,W,new AbortController,"f")}emitSVGPatch(r){__classPrivateFieldGet(this,H,"f").info("emitSVGPatch",{patchChange:r}),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.SVG_PATCH,r)}addSVGPatchListener(r){__classPrivateFieldGet(this,H,"f").info("addSVGPatchListener",{callback:r}),this.addEventListener(i.InternalEventType.SVG_PATCH,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitExported(r){__classPrivateFieldGet(this,H,"f").info("emitExported",{exports:r}),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.EXPORTED,r)}addExportedListener(r){__classPrivateFieldGet(this,H,"f").info("addExportedListener",{callback:r}),this.addEventListener(i.InternalEventType.EXPORTED,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitClearMessage(){__classPrivateFieldGet(this,H,"f").info("emitClearMessage"),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.CLEAR_MESSAGE)}addClearMessageListener(r){__classPrivateFieldGet(this,H,"f").info("addClearMessageListener",{callback:r}),this.addEventListener(i.InternalEventType.CLEAR_MESSAGE,(()=>r()),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitError(r){__classPrivateFieldGet(this,H,"f").info("emitError",{err:r}),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.ERROR,r)}addErrorListener(r){__classPrivateFieldGet(this,H,"f").info("addErrorListener",{callback:r}),this.addEventListener(i.InternalEventType.ERROR,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitNotif(r){__classPrivateFieldGet(this,H,"f").info("emitWNotif",{notif:r}),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.NOTIF,r)}addNotifListener(r){__classPrivateFieldGet(this,H,"f").info("addNotifListener",{callback:r}),this.addEventListener(i.InternalEventType.NOTIF,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitImportJIIX(r){__classPrivateFieldGet(this,H,"f").info("emitImportJIIX",{jiix:r}),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.IMPORT_JIIX,r)}addImportJIIXListener(r){__classPrivateFieldGet(this,H,"f").info("addImportJIIXListener",{callback:r}),this.addEventListener(i.InternalEventType.IMPORT_JIIX,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitConvert(r="DIGITAL_EDIT"){__classPrivateFieldGet(this,H,"f").info("emitConvert",{conversionState:r}),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.CONVERT,r)}addConvertListener(r){__classPrivateFieldGet(this,H,"f").info("addConvertListener",{callback:r}),this.addEventListener(i.InternalEventType.CONVERT,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitClear(){__classPrivateFieldGet(this,H,"f").info("emitClear"),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.CLEAR)}addClearListener(r){__classPrivateFieldGet(this,H,"f").info("addClearListener",{callback:r}),this.addEventListener(i.InternalEventType.CLEAR,(()=>r()),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitContextChange(r){__classPrivateFieldGet(this,H,"f").info("emitContextChange",{context:r}),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.CONTEXT_CHANGE,r)}addContextChangeListener(r){__classPrivateFieldGet(this,H,"f").info("addContextChangeListener",{callback:r}),this.addEventListener(i.InternalEventType.CONTEXT_CHANGE,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitIdle(r){__classPrivateFieldGet(this,H,"f").info("emitIdle",{idle:r}),__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.IDLE,r)}addIdleListener(r){__classPrivateFieldGet(this,H,"f").info("addIdleListener",{callback:r}),this.addEventListener(i.InternalEventType.IDLE,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitSelected(r){__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.SELECTED,r)}addSelectedListener(r){__classPrivateFieldGet(this,H,"f").info("addSelectedListener",{callback:r}),this.addEventListener(i.InternalEventType.SELECTED,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}emitIntention(r){__classPrivateFieldGet(this,z,"m",U).call(this,i.InternalEventType.INTENTION,r)}addIntentionListener(r){__classPrivateFieldGet(this,H,"f").info("addSelectedListener",{callback:r}),this.addEventListener(i.InternalEventType.INTENTION,(i=>r(i.detail)),{signal:__classPrivateFieldGet(this,W,"f").signal})}}j=InternalEvent,W=new WeakMap,H=new WeakMap,z=new WeakSet,U=function _InternalEvent_emit(i,r){this.dispatchEvent(new CustomEvent(i,Object.assign({bubbles:!0,composed:!0},r?{detail:r}:void 0)))},V={value:void 0},i.EventType=void 0,(ee=i.EventType||(i.EventType={})).CHANGED="changed",ee.CLEARED="cleared",ee.CONVERTED="converted",ee.ERROR="error",ee.POINTEREVENTS="pointer_events",ee.EXPORTED="exported",ee.IMPORTED="imported",ee.IDLE="idle",ee.LOADED="loaded",ee.SELECTED="selected",ee.INTENTION="intention";class PublicEvent extends EventTarget{constructor(){super(),K.add(this),q.set(this,void 0),Z.set(this,LoggerManager.getLogger(i.LoggerClass.PUBLIC_EVENT))}static getInstance(){return __classPrivateFieldGet(Y,Y,"f",J)||__classPrivateFieldSet(Y,Y,new Y,"f",J),__classPrivateFieldGet(Y,Y,"f",J)}setElement(i){__classPrivateFieldGet(this,Z,"f").info("setElement",{el:i}),__classPrivateFieldSet(this,q,i,"f")}emitLoaded(){__classPrivateFieldGet(this,Z,"f").info("emitLoaded"),__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.LOADED)}emitExported(r){__classPrivateFieldGet(this,Z,"f").info("emitExported",{exports:r}),__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.EXPORTED,r)}emitChanged(r){__classPrivateFieldGet(this,Z,"f").info("emitChanged",{undoRedoContext:r}),__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.CHANGED,Object.assign(Object.assign({},r),{canClear:!r.empty}))}emitIdle(r){__classPrivateFieldGet(this,Z,"f").info("emitIdle",{idle:r}),__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.IDLE,r)}emitCleared(r){__classPrivateFieldGet(this,Z,"f").info("emitCleared",{model:r}),__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.CLEARED,r)}emitConverted(r){__classPrivateFieldGet(this,Z,"f").info("emitConverted",{exports:r}),__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.CONVERTED,r)}emitImported(r){__classPrivateFieldGet(this,Z,"f").info("emitImported",{exports:r}),__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.IMPORTED,r)}emitSelected(r){__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.SELECTED,r)}emitIntention(r){__classPrivateFieldGet(this,K,"m",Q).call(this,i.EventType.INTENTION,r)}}Y=PublicEvent,q=new WeakMap,Z=new WeakMap,K=new WeakSet,Q=function _PublicEvent_emit(i,r){var s;const n=new CustomEvent(i,Object.assign({bubbles:!0,composed:!0},r?{detail:r}:void 0));this.dispatchEvent(n),null===(s=__classPrivateFieldGet(this,q,"f"))||void 0===s||s.dispatchEvent(n)},J={value:void 0};class OIPointerEventGrabber{constructor(r){te.set(this,LoggerManager.getLogger(i.LoggerClass.GRABBER)),this.prevent=i=>i.preventDefault(),this.pointerDownHandler=i=>{if(__classPrivateFieldGet(this,te,"f").info("pointerDown",{evt:i}),0===i.button&&1===i.buttons&&(this.activePointerId=i.pointerId,this.onPointerDown)){const r=this.extractPoint(i);this.onPointerDown(i,r)}},this.pointerMoveHandler=i=>{if(__classPrivateFieldGet(this,te,"f").info("pointerMove",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId&&this.onPointerMove){const r=this.extractPoint(i);this.onPointerMove(i,r)}},this.pointerUpHandler=i=>{if(__classPrivateFieldGet(this,te,"f").info("pointerUp",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId&&(this.activePointerId=void 0,i.stopPropagation(),this.onPointerUp)){const r=this.extractPoint(i);this.onPointerUp(i,r)}},this.pointerOutHandler=i=>{if(null!=this.activePointerId&&this.activePointerId===i.pointerId&&!this.domElement.contains(i.target)&&(i.stopPropagation(),this.activePointerId=void 0,this.onPointerUp)){const r=this.extractPoint(i);this.onPointerUp(i,r)}},this.contextMenuHandler=i=>{const r=this.extractPoint(i);this.onContextMenu(i.target,r)},__classPrivateFieldGet(this,te,"f").info("constructor",{configuration:r}),this.configuration=r}roundFloat(i,r){if(r>=0){const s=Math.pow(10,r);return Math.round(i/s)*s}return __classPrivateFieldGet(this,te,"f").debug("roundFloat",{oneFloat:i,requestedFloatPrecision:r}),i}extractPoint(i){let r,s;({clientX:r,clientY:s}="changedTouches"in i?i.changedTouches[0]:i);const n=this.domElement.getBoundingClientRect(),a={x:this.roundFloat(r-n.left-this.domElement.clientLeft+this.domElement.scrollLeft,this.configuration.xyFloatPrecision),y:this.roundFloat(s-n.top-this.domElement.clientTop+this.domElement.scrollTop,this.configuration.xyFloatPrecision),t:this.roundFloat(Date.now(),this.configuration.timestampFloatPrecision),p:i.pressure};return __classPrivateFieldGet(this,te,"f").debug("extractPoint",{event:i,pointer:a}),a}stopPointerEvent(){this.activePointerId=void 0}attach(i){__classPrivateFieldGet(this,te,"f").info("attach",{domElement:i}),this.domElement&&this.detach(),this.domElement=i,this.domElement.addEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),this.domElement.addEventListener("contextmenu",this.contextMenuHandler)}detach(){var i,r,s,n,a,l,d;__classPrivateFieldGet(this,te,"f").info("detach"),null===(i=this.domElement)||void 0===i||i.removeEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),null===(r=this.domElement)||void 0===r||r.removeEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),null===(s=this.domElement)||void 0===s||s.removeEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),null===(n=this.domElement)||void 0===n||n.removeEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),null===(a=this.domElement)||void 0===a||a.removeEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),null===(l=this.domElement)||void 0===l||l.removeEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),null===(d=this.domElement)||void 0===d||d.removeEventListener("contextmenu",this.contextMenuHandler)}}te=new WeakMap;class PointerEventGrabber{constructor(r){this.prevent=i=>i.preventDefault(),ie.set(this,LoggerManager.getLogger(i.LoggerClass.GRABBER)),this.pointerDownHandler=i=>{if(__classPrivateFieldGet(this,ie,"f").info("pointerDown",{evt:i}),0===i.button&&1===i.buttons&&(this.activePointerId=i.pointerId,this.onPointerDown)){const r=this.extractPoint(i);this.onPointerDown(i,r)}},this.pointerMoveHandler=i=>{if(__classPrivateFieldGet(this,ie,"f").info("pointerMove",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId){if(i.target.classList.contains("smartguide"))return void this.pointerUpHandler(i);if(this.onPointerMove){const r=this.extractPoint(i);this.onPointerMove(i,r)}}},this.pointerUpHandler=i=>{if(__classPrivateFieldGet(this,ie,"f").info("pointerUp",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId&&(this.activePointerId=void 0,i.stopPropagation(),this.onPointerUp)){const r=this.extractPoint(i);this.onPointerUp(i,r)}},this.pointerOutHandler=i=>{if(null!=this.activePointerId&&this.activePointerId===i.pointerId&&!this.domElement.contains(i.target)&&(i.stopPropagation(),this.activePointerId=void 0,this.onPointerUp)){const r=this.extractPoint(i);this.onPointerUp(i,r)}},__classPrivateFieldGet(this,ie,"f").info("constructor",{configuration:r}),this.configuration=r}roundFloat(i,r){if(r>=0){const s=Math.pow(10,r);return Math.round(i/s)*s}return __classPrivateFieldGet(this,ie,"f").debug("roundFloat",{oneFloat:i,requestedFloatPrecision:r}),i}extractPoint(i){let r,s;({clientX:r,clientY:s}="changedTouches"in i?i.changedTouches[0]:i);const n=this.domElement.getBoundingClientRect(),a={x:this.roundFloat(r-n.left-this.domElement.clientLeft+this.domElement.scrollLeft,this.configuration.xyFloatPrecision),y:this.roundFloat(s-n.top-this.domElement.clientTop+this.domElement.scrollTop,this.configuration.xyFloatPrecision),t:this.roundFloat(Date.now(),this.configuration.timestampFloatPrecision),p:i.pressure||1};return __classPrivateFieldGet(this,ie,"f").debug("extractPoint",{event:i,pointer:a}),a}attach(i){__classPrivateFieldGet(this,ie,"f").info("attach",{domElement:i}),this.domElement&&this.detach(),this.domElement=i,this.domElement.addEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),this.domElement.addEventListener("touchmove",this.prevent),document.documentElement.addEventListener("pointerdown",(()=>{}))}detach(){var i,r,s,n,a,l,d;__classPrivateFieldGet(this,ie,"f").info("detach"),null===(i=this.domElement)||void 0===i||i.removeEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),null===(r=this.domElement)||void 0===r||r.removeEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),null===(s=this.domElement)||void 0===s||s.removeEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),null===(n=this.domElement)||void 0===n||n.removeEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),null===(a=this.domElement)||void 0===a||a.removeEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),null===(l=this.domElement)||void 0===l||l.removeEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),null===(d=this.domElement)||void 0===d||d.removeEventListener("touchmove",this.prevent),document.documentElement.removeEventListener("pointerdown",(()=>{}))}}ie=new WeakMap,i.ExportType=void 0,(re=i.ExportType||(i.ExportType={})).JIIX="application/vnd.myscript.jiix",re.TEXT="text/plain",re.LATEX="application/x-latex",re.MATHML="application/mathml+xml",re.SVG="image/svg+xml",re.OFFICE_DOCUMENT="application/vnd.openxmlformats-officedocument.presentationml.presentation",i.JIIXELementType=void 0,(se=i.JIIXELementType||(i.JIIXELementType={})).Text="Text",se.Node="Node",se.Edge="Edge",se.RawContent="Raw Content",i.JIIXNodeKind=void 0,(ne=i.JIIXNodeKind||(i.JIIXNodeKind={})).Circle="circle",ne.Ellipse="ellipse",ne.Rectangle="rectangle",ne.Triangle="triangle",ne.Parallelogram="parallelogram",ne.Polygon="polygon",ne.Rhombus="rhombus",i.JIIXEdgeKind=void 0,(oe=i.JIIXEdgeKind||(i.JIIXEdgeKind={})).Line="line",oe.PolyEdge="polyedge",oe.Arc="arc";class Box{constructor(i){if(i.width<0)throw new Error("width must be positive");if(i.height<0)throw new Error("height must be positive");this.height=i.height,this.width=i.width,this.x=i.x,this.y=i.y}static createFromBoxes(i){if(!(null==i?void 0:i.length))return new Box({height:0,width:0,x:0,y:0});const r=Math.min(...i.map((i=>i.x))),s=Math.max(...i.map((i=>i.x+i.width)))-r,n=Math.min(...i.map((i=>i.y))),a=Math.max(...i.map((i=>i.y+i.height)))-n;return new Box({x:r,y:n,width:s,height:a})}static createFromPoints(i){if(!(null==i?void 0:i.length))return new Box({height:0,width:0,x:0,y:0});const r=Math.min(...i.map((i=>i.x))),s=Math.max(...i.map((i=>i.x)))-r,n=Math.min(...i.map((i=>i.y))),a=Math.max(...i.map((i=>i.y)))-n;return new Box({x:r,y:n,width:s,height:a})}static getCorners(i){return[{x:i.x,y:i.y},{x:i.x+i.width,y:i.y},{x:i.x+i.width,y:i.y+i.height},{x:i.x,y:i.y+i.height}]}static getCenter(i){return{x:i.x+i.width/2,y:i.y+i.height/2}}static getSides(i){const r=Box.getCorners(i);return r.map(((i,s)=>3===s?{p1:r[0],p2:i}:{p1:i,p2:r[s+1]}))}static isContained(i,r){return isBetween(i.x,r.x,r.x+r.width)&&isBetween(i.x+i.width,r.x,r.x+r.width)&&isBetween(i.y,r.y,r.y+r.height)&&isBetween(i.y+i.height,r.y,r.y+r.height)}static containsPoint(i,r){return isBetween(r.x,i.x,i.x+i.width)&&isBetween(r.y,i.y,i.y+i.height)}static contains(i,r){return isBetween(r.x,i.x,i.x+i.width)&&isBetween(r.x+r.width,i.x,i.x+i.width)&&isBetween(r.y,i.y,i.y+i.height)&&isBetween(r.y+r.height,i.y,i.y+i.height)}static overlaps(i,r){return!(i.x>r.x+r.width)&&(!(i.x+i.width<r.x)&&(!(i.y>r.y+r.height)&&!(i.y+i.height<r.y)))}get xMin(){return this.x}get xMid(){return this.x+this.width/2}get xMax(){return this.x+this.width}get yMin(){return this.y}get yMid(){return this.y+this.height/2}get yMax(){return this.y+this.height}get corners(){return Box.getCorners(this)}get center(){return Box.getCenter(this)}get snapPoints(){return[...this.corners,this.center]}isContained(i){return Box.isContained(this,i)}contains(i){return Box.contains(this,i)}containsPoint(i){return Box.containsPoint(this,i)}overlaps(i){return Box.overlaps(this,i)}}i.DecoratorKind=void 0,(ae=i.DecoratorKind||(i.DecoratorKind={})).Highlight="highlight",ae.Surround="surround",ae.Underline="underline",ae.Strikethrough="strikethrough";class OIDecorator{constructor(i,r){this.id=`${i}-${createUUID()}`,this.style=structuredClone(r),this.kind=i}clone(){const i=new OIDecorator(this.kind,structuredClone(this.style));return i.id=this.id,i}}const le={width:2,color:"#000000",opacity:1,fill:"transparent"},de={},he={ink:{color:"#000000",width:1,"-myscript-pen-width":1,"-myscript-pen-fill-style":"none","-myscript-pen-fill-color":"#FFFFFF00"},".math":{"font-family":"STIXGeneral"},".math-solved":{"font-family":"STIXGeneral",color:"#A8A8A8FF"},".text":{"font-family":"MyScriptInter","font-size":10}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var ce=function createCommonjsModule(i,r){return i(r={exports:{}},r.exports),r.exports}((function(i,r){i.exports=function(i){function e(s){if(r[s])return r[s].exports;var n=r[s]={i:s,l:!1,exports:{}};return i[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var r={};return e.m=i,e.c=r,e.i=function(i){return i},e.d=function(i,r,s){e.o(i,r)||Object.defineProperty(i,r,{configurable:!1,enumerable:!0,get:s})},e.n=function(i){var r=i&&i.__esModule?function(){return i.default}:function(){return i};return e.d(r,"a",r),r},e.o=function(i,r){return Object.prototype.hasOwnProperty.call(i,r)},e.p="",e(e.s=1)}([function(i,r,s){function o(i,r){if(!(i instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(i){return typeof i}:function(i){return i&&"function"==typeof Symbol&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i},a=function t(i){var r=this;o(this,t),this.toJSON=function(i){if("string"!=typeof i)return console.error("Need a CSS string but given ",void 0===i?"undefined":n(i),i),"Not a valid CSS..!";var s={},a=void 0,l=void 0,d=void 0;try{i.split("{").forEach((function(i){if(l=i.trim())if(-1===l.indexOf("}"))s[l]={},a=l;else{l.substring(0,l.indexOf("}")).split(";").forEach((function(i){(d=i.split(":"))&&2===d.length&&(s[a][d[0].trim().replace(/^\"|\"$/g,"")]=r._trimSemiColon(d[1].trim().replace(/^\"|\"$/g,"")))}));try{(a=l.split("}")[1].trim())&&(s[a]={})}catch(i){}}}))}catch(i){return"Not a valid CSS..!"}return s},this.toCSS=function(i){if("object"!==(void 0===i?"undefined":n(i)))return console.error("Need a JSON object but given ",void 0===i?"undefined":n(i),i),"Not a valid JSON..!";var r="";try{for(var s in i)if(i.hasOwnProperty(s)){for(var a in r+=s+" {\n",i[s])i[s].hasOwnProperty(a)&&(r+=a+": "+i[s][a]+";\n");r+="}\n"}}catch(i){return"Not a valid JSON..!"}return r},this._trimSemiColon=function(i){return";"===i.slice(-1)?i.slice(0,r.length-1):i}};r.default=a},function(i,r,s){i.exports=s(0).default}])})),ue=function unwrapExports(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}(ce);ce.JsonCSS;const pe=new ue,me={themeToCSS:i=>pe.toCSS(i),themeToJSON(i){const r=pe.toJSON(i);return r[".text"]["font-size"]=Number(r[".text"]["font-size"]),r.ink["-myscript-pen-width"]=Number(r.ink["-myscript-pen-width"]),r.ink.width=Number(r.ink.width),r},penStyleToCSS(i){let r=pe.toCSS({css:i});return r=r.substring(6,r.length-3),r},penStyleToJSON(i){const r=pe.toJSON(`css {${i}}`).css;return r.width?r.width=Number(r.width):delete r.width,r["-myscript-pen-width"]?r["-myscript-pen-width"]=Number(r["-myscript-pen-width"]):delete r["-myscript-pen-width"],r},stringToJSON:i=>pe.toJSON(`css {${i}}`).css,JSONToString:i=>Object.entries(i).map((([i,r])=>`${i}:${r}`)).join(";")};var ge,ve,ye,fe,be,xe,Se,we;class StyleManager{constructor(r,s){ge.set(this,void 0),ve.set(this,void 0),ye.set(this,void 0),fe.set(this,void 0),be.set(this,LoggerManager.getLogger(i.LoggerClass.STYLE)),__classPrivateFieldGet(this,be,"f").info("constructor",{penStyle:r,theme:s}),this.setTheme(s),this.setPenStyleClasses(),this.setPenStyle(r)}get currentPenStyle(){return __classPrivateFieldGet(this,fe,"f")||__classPrivateFieldGet(this,ge,"f")}get penStyle(){return __classPrivateFieldGet(this,ge,"f")}setPenStyle(i){__classPrivateFieldGet(this,be,"f").info("setPenStyle",{style:i}),__classPrivateFieldSet(this,ge,mergeDeep(structuredClone(de),i||{}),"f"),__classPrivateFieldSet(this,fe,i||this.theme[`.${__classPrivateFieldGet(this,ye,"f")}`],"f"),__classPrivateFieldGet(this,be,"f").debug("setPenStyle",__classPrivateFieldGet(this,fe,"f"))}get theme(){return __classPrivateFieldGet(this,ve,"f")}setTheme(i){__classPrivateFieldGet(this,be,"f").info("setTheme",{theme:i}),__classPrivateFieldSet(this,ve,mergeDeep(structuredClone(he),i||{}),"f"),__classPrivateFieldGet(this,be,"f").debug("setTheme",__classPrivateFieldGet(this,ve,"f"))}get penStyleClasses(){return __classPrivateFieldGet(this,ye,"f")}setPenStyleClasses(i=""){__classPrivateFieldGet(this,be,"f").info("setPenStyleClasses",{penStyleClass:i}),__classPrivateFieldSet(this,ye,i,"f"),__classPrivateFieldSet(this,fe,this.theme[`.${__classPrivateFieldGet(this,ye,"f")}`],"f"),__classPrivateFieldGet(this,be,"f").debug("setPenStyleClasses",__classPrivateFieldGet(this,fe,"f"))}}ge=new WeakMap,ve=new WeakMap,ye=new WeakMap,fe=new WeakMap,be=new WeakMap;class MatrixTransform{constructor(i,r,s,n,a,l){this.xx=i,this.yx=r,this.xy=s,this.yy=n,this.tx=a,this.ty=l}static identity(){return new MatrixTransform(1,0,0,1,0,0)}static applyToPoint(i,r){return{x:i.xx*r.x+i.xy*r.y+i.tx,y:i.yx*r.x+i.yy*r.y+i.ty}}static rotation(i){let r;if(0!==i.xx||0!==i.xy){const s=Math.hypot(i.xx,i.xy);r=Math.acos(i.xx/s)*(i.xy>0?-1:1)}else if(0!==i.yx||0!==i.yy){const s=Math.hypot(i.yx,i.yy);r=Math.PI/2+Math.acos(i.yx/s)*(i.yy>0?-1:1)}else r=0;return r}static toCssString(i){return`matrix(${i.xx}, ${i.yx}, ${i.xy}, ${i.yy}, ${i.tx}, ${i.ty})`}invert(){const{xx:i,yx:r,xy:s,yy:n,tx:a,ty:l}=this,d=i*n-r*s;return this.xx=n/d,this.yx=r/-d,this.xy=s/-d,this.yy=i/d,this.tx=(n*a-s*l)/-d,this.ty=(r*a-i*l)/d,this}multiply(i){const{xx:r,yx:s,xy:n,yy:a,tx:l,ty:d}=this;return this.xx=r*i.xx+n*i.yx,this.yx=s*i.xx+a*i.yx,this.xy=r*i.xy+n*i.yy,this.yy=s*i.xy+a*i.yy,this.tx=r*i.tx+n*i.ty+l,this.ty=s*i.tx+a*i.ty+d,this}translate(i,r){return this.multiply({xx:1,yx:0,xy:0,yy:1,tx:i,ty:r})}rotate(i,r){r&&this.translate(r.x,r.y);const s=Math.round(1e3*Math.cos(i))/1e3,n=Math.round(1e3*Math.sin(i))/1e3;return this.multiply({xx:s,yx:n,xy:-n,yy:s,tx:0,ty:0}),r&&this.translate(-r.x,-r.y),this}scale(i,r,s){return s&&this.translate(s.x,s.y),this.multiply({xx:i,yx:0,xy:0,yy:r,tx:0,ty:0}),s&&this.translate(-s.x,-s.y),this}applyToPoint(i){return MatrixTransform.applyToPoint(this,i)}clone(){return new MatrixTransform(this.xx,this.yx,this.xy,this.yy,this.tx,this.ty)}toCssString(){return MatrixTransform.toCssString(this)}}class OISymbolBase{constructor(i,r){this.type=i,this.id=`${this.type}-${createUUID()}`,this.creationTime=Date.now(),this.modificationDate=this.creationTime,this.selected=!1,this.deleting=!1,this.transform=MatrixTransform.identity(),this.style=Object.assign({},le,r),this.style.opacity=+this.style.opacity,this.style.width=+this.style.width}get edges(){return this.isClosed?this.vertices.map(((i,r)=>r===this.vertices.length-1?{p1:i,p2:this.vertices[0]}:{p1:i,p2:this.vertices[r+1]})):this.vertices.slice(0,-1).map(((i,r)=>({p1:i,p2:this.vertices[r+1]})))}isIntersected(i){return this.edges.some((r=>findIntersectionBetween2Segment(r,i)))}}i.SymbolType=void 0,(xe=i.SymbolType||(i.SymbolType={})).Stroke="stroke",xe.Group="group",xe.Shape="shape",xe.Edge="edge",xe.Text="text",xe.Eraser="eraser",i.EdgeKind=void 0,(Se=i.EdgeKind||(i.EdgeKind={})).Line="line",Se.PolyEdge="polyedge",Se.Arc="arc",i.EdgeDecoration=void 0,(i.EdgeDecoration||(i.EdgeDecoration={})).Arrow="arrow-head";class OIEdgeBase extends OISymbolBase{constructor(r,s,n,a){super(i.SymbolType.Edge,a),this.isClosed=!1,this.kind=r,this.startDecoration=s,this.endDecoration=n}get bounds(){const i=Box.createFromPoints(this.vertices);return i.x-=5,i.y-=5,i.height+=l,i.width+=l,(this.startDecoration||this.endDecoration)&&(i.x-=2.5*(this.style.width||1),i.y-=2.5*(this.style.width||1),i.height+=5*(this.style.width||1),i.width+=5*(this.style.width||1)),i}get snapPoints(){return this.vertices}overlaps(i){return this.bounds.isContained(i)||this.edges.some((r=>Box.getSides(i).some((i=>!!findIntersectionBetween2Segment(r,i)))))}}function isValidPoint(i){return!!i&&(!!isValidNumber(i.x)&&!!isValidNumber(i.y))}class OIEdgeArc extends OIEdgeBase{constructor(r,s,n,a,l,d,h,c,u){super(i.EdgeKind.Arc,h,c,u),this.center=r,this.startAngle=s,this.sweepAngle=n,this.radiusX=a,this.radiusY=l,this.phi=d,this._vertices=new Map,this._vertices.set(this.verticesId,this.computedVertices())}get verticesId(){return`${this.center.x}-${this.center.y}-${this.startAngle}-${this.sweepAngle}-${this.radiusX}-${this.radiusY}-${this.phi}`}computedVertices(){const i=Math.abs(this.sweepAngle)*Math.sqrt((Math.pow(this.radiusX,2)+Math.pow(this.radiusY,2))/2),r=Math.max(8,Math.round(i/l)),s=this.sweepAngle/r,n=[],a=this.startAngle+this.sweepAngle;if(this.sweepAngle>0)for(let i=this.startAngle;i<a;i+=s)n.push(computePointOnEllipse(this.center,this.radiusX,this.radiusY,this.phi,i));else for(let i=this.startAngle;i>a;i+=s)n.push(computePointOnEllipse(this.center,this.radiusX,this.radiusY,this.phi,i));return n.push(computePointOnEllipse(this.center,this.radiusX,this.radiusY,this.phi,a)),n}get vertices(){return this._vertices.has(this.verticesId)||this._vertices.set(this.verticesId,this.computedVertices()),this._vertices.get(this.verticesId)}get snapPoints(){return[this.vertices[0],this.vertices.at(-1)]}clone(){const i=new OIEdgeArc(structuredClone(this.center),this.startAngle,this.sweepAngle,this.radiusX,this.radiusY,this.phi,this.startDecoration,this.endDecoration,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,center:this.center,startAngle:this.startAngle,sweepAngle:this.sweepAngle,radiusX:this.radiusX,radiusY:this.radiusY,phi:this.phi,startDecoration:this.startDecoration,style:this.style,endDecoration:this.endDecoration}}static create(i){if(!isValidPoint(null==i?void 0:i.center))throw new Error("Unable to create a arc, center point is invalid");if(!isValidNumber(null==i?void 0:i.startAngle))throw new Error("Unable to create a arc, startAngle is invalid");if(!isValidNumber(null==i?void 0:i.sweepAngle))throw new Error("Unable to create a arc, sweepAngle is invalid");if(!isValidNumber(null==i?void 0:i.radiusX))throw new Error("Unable to create a arc, radiusX is invalid");if(!isValidNumber(null==i?void 0:i.radiusY))throw new Error("Unable to create a arc, radiusY is invalid");const r=new OIEdgeArc(null==i?void 0:i.center,i.startAngle,i.sweepAngle,i.radiusX,i.radiusY,i.phi||0,i.startDecoration,i.endDecoration,i.style);return i.id&&(r.id=i.id),r}}class OIEdgeLine extends OIEdgeBase{constructor(r,s,n,a,l){super(i.EdgeKind.Line,n,a,l),this.start=r,this.end=s}get vertices(){return[this.start,this.end]}clone(){const i=new OIEdgeLine(structuredClone(this.start),structuredClone(this.end),this.startDecoration,this.endDecoration,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,start:this.start,end:this.end,style:this.style,startDecoration:this.startDecoration,endDecoration:this.endDecoration}}static create(i){if(!isValidPoint(null==i?void 0:i.start))throw new Error("Unable to create a arc, start point is invalid");if(!isValidPoint(null==i?void 0:i.end))throw new Error("Unable to create a arc, end point is invalid");const r=new OIEdgeLine(null==i?void 0:i.start,null==i?void 0:i.end,i.startDecoration,i.endDecoration,i.style);return i.id&&(r.id=i.id),r}}class OIEdgePolyLine extends OIEdgeBase{constructor(r,s,n,a){super(i.EdgeKind.PolyEdge,s,n,a),this.points=r}get vertices(){return this.points}clone(){const i=new OIEdgePolyLine(structuredClone(this.points),this.startDecoration,this.endDecoration,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,points:this.points,style:this.style,startDecoration:this.startDecoration,endDecoration:this.endDecoration}}static create(i){var r;if(!(null===(r=null==i?void 0:i.points)||void 0===r?void 0:r.map((i=>isValidPoint(i)))))throw new Error("Unable to create a PolyLine, points are invalid");const s=new OIEdgePolyLine(null==i?void 0:i.points,i.startDecoration,i.endDecoration,i.style);return i.id&&(s.id=i.id),s}}i.ShapeKind=void 0,(we=i.ShapeKind||(i.ShapeKind={})).Circle="circle",we.Ellipse="ellipse",we.Polygon="polygon",we.Table="table";class OIShapeBase extends OISymbolBase{constructor(r,s){super(i.SymbolType.Shape,s),this.isClosed=!0,this.kind=r}get bounds(){return Box.createFromPoints(this.vertices)}get snapPoints(){return this.bounds.snapPoints}overlaps(i){return this.bounds.isContained(i)||this.edges.some((r=>Box.getSides(i).some((i=>!!findIntersectionBetween2Segment(r,i)))))}}class OIShapeEllipse extends OIShapeBase{constructor(r,s,n,a,l){super(i.ShapeKind.Ellipse,l),this.center=r,this.radiusX=s,this.radiusY=n,this.orientation=a,this._vertices=new Map}get verticesId(){return`${this.center.x}-${this.center.y}-${this.radiusX}-${this.radiusY}-${this.orientation}`}computedVertices(){const i=[],r=2*Math.PI*Math.sqrt((Math.pow(this.radiusX,2)+Math.pow(this.radiusY,2))/2),s=Math.max(8,Math.round(r/l));for(let r=0;r<s;r++){const n=2*Math.PI*(r/s);i.push(computePointOnEllipse(this.center,this.radiusX,this.radiusY,this.orientation,n))}return i}get vertices(){return this._vertices.has(this.verticesId)||this._vertices.set(this.verticesId,this.computedVertices()),this._vertices.get(this.verticesId)}overlaps(i){return this.bounds.isContained(i)||this.edges.some((r=>Box.getSides(i).some((i=>!!findIntersectionBetween2Segment(r,i)))))}clone(){const i=new OIShapeEllipse(structuredClone(this.center),this.radiusX,this.radiusY,this.orientation,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,center:this.center,orientation:this.orientation,radiusX:this.radiusX,radiusY:this.radiusY,style:this.style}}static createBetweenPoints(i,r,s){const n={x:(i.x+r.x)/2,y:(i.y+r.y)/2},a=Math.abs(i.x-r.x)/2,l=Math.abs(i.y-r.y)/2;return new OIShapeEllipse(n,a,l,0,s)}static updateBetweenPoints(i,r,s){return i.center={x:(r.x+s.x)/2,y:(r.y+s.y)/2},i.radiusX=Math.abs(r.x-s.x)/2,i.radiusY=Math.abs(r.y-s.y)/2,i}static create(i){if(!isValidPoint(i.center))throw new Error("Unable to create ellipse, center is undefined");if(!isValidNumber(i.radiusX))throw new Error("Unable to create ellipse, radiusX is undefined");if(!isValidNumber(i.radiusY))throw new Error("Unable to create ellipse, radiusY is undefined");const r=new OIShapeEllipse(i.center,i.radiusX,i.radiusY,i.orientation||0,i.style);return i.id&&(r.id=i.id),r}}class OIShapeCircle extends OIShapeBase{constructor(r,s,n){super(i.ShapeKind.Circle,n),this.center=r,this.radius=s,this._vertices=new Map,this._vertices.set(this.verticesId,this.computedVertices()),this._bounds=new Map,this._bounds.set(this.verticesId,this.computedBondingBox())}get verticesId(){return`${this.center.x}-${this.center.y}-${this.radius}`}computedVertices(){const i={x:this.center.x,y:this.radius+this.center.y},r=2*Math.PI*this.radius,s=Math.max(8,Math.round(r/l)),n=[];for(let r=0;r<s;r++){const a=2*Math.PI*(r/s);n.push(computeRotatedPoint(i,this.center,a))}return n}computedBondingBox(){const i={x:this.center.x-this.radius,y:this.center.y-this.radius,height:2*this.radius,width:2*this.radius};return this._bounds,new Box(i)}get bounds(){return this._bounds.has(this.verticesId)||this._bounds.set(this.verticesId,this.computedBondingBox()),this._bounds.get(this.verticesId)}get vertices(){return this._vertices.has(this.verticesId)||this._vertices.set(this.verticesId,this.computedVertices()),this._vertices.get(this.verticesId)}overlaps(i){return this.bounds.isContained(i)||Box.getSides(i).some((i=>findIntersectBetweenSegmentAndCircle(i,this.center,this.radius).length))}clone(){const i=new OIShapeCircle(structuredClone(this.center),this.radius,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,center:this.center,radius:this.radius,style:this.style}}static createBetweenPoints(i,r,s){const n={x:(i.x+r.x)/2,y:(i.y+r.y)/2},a=Math.abs(i.x-r.x),l=Math.abs(i.y-r.y),d=Math.min(a,l)/2;return new OIShapeCircle(n,d,s)}static updateBetweenPoints(i,r,s){i.center={x:(r.x+s.x)/2,y:(r.y+s.y)/2};const n=Math.abs(r.x-s.x),a=Math.abs(r.y-s.y);return i.radius=Math.min(n,a)/2,i}static create(i){if(!isValidPoint(i.center))throw new Error("Unable to create circle, center is invalid");if(!isValidNumber(i.radius))throw new Error("Unable to create circle, radius is undefined");const r=new OIShapeCircle(i.center,i.radius,i.style);return i.id&&(r.id=i.id),r}}class OIShapePolygon extends OIShapeBase{constructor(r,s){super(i.ShapeKind.Polygon,s),this.points=r}get vertices(){return this.points}get bounds(){return Box.createFromPoints(this.vertices)}clone(){const i=new OIShapePolygon(structuredClone(this.points),structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i}toJSON(){return{id:this.id,type:this.type,kind:this.kind,points:this.points,style:this.style}}static create(i){var r,s;if(!(null==i?void 0:i.points)||(null===(r=null==i?void 0:i.points)||void 0===r?void 0:r.length)<3)throw new Error("Unable to create polygon at least 3 points required");if(null===(s=null==i?void 0:i.points)||void 0===s?void 0:s.some((i=>!isValidPoint(i))))throw new Error("Unable to create a polygon, one or more points are invalid");const n=new OIShapePolygon(i.points,i.style);return i.id&&(n.id=i.id),n}static createTriangleBetweenPoints(i,r,s){const n=[{x:i.x,y:i.y},{x:r.x,y:i.y},{x:(i.x+r.x)/2,y:r.y}];return new OIShapePolygon(n,s)}static updateTriangleBetweenPoints(i,r,s){return i.points=[{x:r.x,y:r.y},{x:s.x,y:r.y},{x:(r.x+s.x)/2,y:s.y}],i.modificationDate=Date.now(),i}static createParallelogramBetweenPoints(i,r,s){const n=[{x:i.x,y:i.y},{x:i.x+.75*(r.x-i.x),y:i.y},{x:r.x,y:r.y},{x:i.x+.25*(r.x-i.x),y:r.y}];return new OIShapePolygon(n,s)}static updateParallelogramBetweenPoints(i,r,s){const n=[{x:r.x,y:r.y},{x:r.x+.75*(s.x-r.x),y:r.y},{x:s.x,y:s.y},{x:r.x+.25*(s.x-r.x),y:s.y}];return i.points=n,i.modificationDate=Date.now(),i}static createRectangleBetweenPoints(i,r,s){const n=Box.createFromPoints([i,r]),a=[{x:n.xMin,y:n.yMin},{x:n.xMax,y:n.yMin},{x:n.xMax,y:n.yMax},{x:n.xMin,y:n.yMax}];return new OIShapePolygon(a,s)}static updateRectangleBetweenPoints(i,r,s){const n=Box.createFromPoints([r,s]),a=[{x:n.xMin,y:n.yMin},{x:n.xMax,y:n.yMin},{x:n.xMax,y:n.yMax},{x:n.xMin,y:n.yMax}];return i.points=a,i.modificationDate=Date.now(),i}static createRhombusBetweenPoints(i,r,s){const n=Box.createFromPoints([i,r]),a=[{x:n.xMid,y:n.yMin},{x:n.xMax,y:n.yMid},{x:n.xMid,y:n.yMax},{x:n.xMin,y:n.yMid}];return new OIShapePolygon(a,s)}static updateRhombusBetweenPoints(i,r,s){const n=Box.createFromPoints([r,s]),a=[{x:n.xMid,y:n.yMin},{x:n.xMax,y:n.yMid},{x:n.xMid,y:n.yMax},{x:n.xMin,y:n.yMid}];return i.points=a,i.modificationDate=Date.now(),i}}class OIStroke extends OISymbolBase{constructor(r,s="pen"){super(i.SymbolType.Stroke,r),this.isClosed=!1,this.pointerType=s,this.pointers=[],this.decorators=[],this.length=0}get bounds(){return Box.createFromPoints(this.vertices)}static split(i,r){const s=new OIStroke(i.style,i.pointerType);s.pointers=i.pointers.slice(0,r);const n=new OIStroke(i.style,i.pointerType);return n.pointers=i.pointers.slice(r),{before:s,after:n}}static substract(i,r){var s,n;if(!r.length)return{before:i};const a={},l={x:r.pointers[0].x,y:r.pointers[0].y},d=getClosestPoint(i.pointers,l);if(d.index>-1){const r=OIStroke.split(i,d.index);a.before=r.before,a.after=r.after}const h=a.after||i,c={x:r.pointers.at(-1).x,y:r.pointers.at(-1).y},u=getClosestPoint(h.pointers,c);if(u.index>-1){const i=OIStroke.split(h,u.index);a.after=i.after}return(null===(s=a.before)||void 0===s?void 0:s.pointers.length)||(a.before=void 0),(null===(n=a.after)||void 0===n?void 0:n.pointers.length)||(a.after=void 0),a}get snapPoints(){return this.bounds.snapPoints}get vertices(){return this.pointers}computePressure(i){let r=1;i===this.length?r=1:i<10?r=.2+Math.pow(.1*i,.4):i>this.length-10&&(r=.2+Math.pow(.1*(this.length-i),.4));const s=r*Math.max(.1,1-.1*Math.sqrt(i));return isNaN(s)?.5:Math.round(100*s)/100}filterPointByAcquisitionDelta(i){const r=this.pointers.at(-1),s=2+(this.style.width||1)/4;return!r||Math.abs(r.x-i.x)>=s||Math.abs(r.y-i.y)>=s}addPointer(i){if(this.filterPointByAcquisitionDelta(i)){const r=this.pointers.at(-1),s=r?computeDistance(i,r):0;this.length+=s,i.p=this.computePressure(s),this.pointers.push(i),this.modificationDate=Date.now()}}overlaps(i){return this.pointers.some((r=>r.x>=i.x&&r.x<=i.x+i.width&&r.y>=i.y&&r.y<=i.y+i.height))}clone(){const i=new OIStroke(this.style,this.pointerType);return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.pointers=structuredClone(this.pointers),i.decorators=this.decorators.map((i=>i.clone())),i.length=this.length,i}formatToSend(){const i={id:this.id,pointerType:this.pointerType,p:[],t:[],x:[],y:[]};return this.pointers.forEach((r=>{i.p.push(r.p),i.t.push(r.t),i.x.push(r.x),i.y.push(r.y)})),i}toJSON(){return{id:this.id,type:this.type,pointers:this.pointers,style:this.style,decorators:this.decorators.length?this.decorators:void 0}}static create(i){var r,s,n;if(!(null===(r=i.pointers)||void 0===r?void 0:r.length))throw new Error("not pointers");const a=new OIStroke(i.style,i.pointerType);i.id&&(a.id=i.id);const l=[];let d=!0;if(null===(s=i.pointers)||void 0===s||s.forEach(((i,r)=>{if(!i)return l.push(`no pointer at ${r}`),void(d=!1);const s={p:i.p||1,t:i.t||r,x:0,y:0};return null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(l.push(`no x at pointer at ${r}`),void(d=!1)):(s.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(l.push(`no y at pointer at ${r}`),void(d=!1)):(s.y=i.y,void(d&&a.addPointer(s))))})),l.length)throw new Error(l.join(" and "));return(null===(n=i.decorators)||void 0===n?void 0:n.length)&&i.decorators.forEach((i=>{(null==i?void 0:i.kind)&&a.decorators.push(new OIDecorator(i.kind,Object.assign({},a.style,i.style)))})),a}}function convertPartialStrokesToOIStrokes(i){const r=[],s=[];if(i.forEach(((i,n)=>{try{s.push(OIStroke.create(i))}catch(i){r.push(`stroke ${n+1} has ${i.message}`)}})),r.length)throw new Error(r.join("\n"));return s}class OISymbolGroup extends OISymbolBase{constructor(r,s){super(i.SymbolType.Group,s),this.isClosed=!1,this.children=r,this.decorators=[]}get snapPoints(){return this.bounds.snapPoints}get vertices(){return this.children.flatMap((i=>i.vertices))}get bounds(){return Box.createFromBoxes(this.children.map((i=>i.bounds)))}updateChildrenStyle(){this.children.forEach((r=>{r.style=Object.assign({},r.style,this.style),r.type===i.SymbolType.Text?r.chars.forEach((i=>{r.style.color&&(i.color=r.style.color)})):r.type===i.SymbolType.Group&&r.updateChildrenStyle()}))}overlaps(i){return this.children.some((r=>r.overlaps(i)))}containsSymbol(i){return OISymbolGroup.containsSymbol(this,i)}containsOnlyStroke(){return OISymbolGroup.containsOnlyStroke(this)}extractSymbols(){return OISymbolGroup.extractSymbols(this)}extractStrokes(){return OISymbolGroup.extractStrokes(this)}removeChilds(i){return OISymbolGroup.removeChilds(this,i)}static containsOnlyStroke(r){return r.children.every((r=>r.type===i.SymbolType.Group?OISymbolGroup.containsOnlyStroke(r):r.type===i.SymbolType.Stroke))}static extractSymbols(r){return r.children.flatMap((r=>r.type===i.SymbolType.Group?OISymbolGroup.extractSymbols(r).concat(r):r))}static extractStrokes(r){return r.children.flatMap((r=>r.type===i.SymbolType.Stroke?r:r.type===i.SymbolType.Group?OISymbolGroup.extractStrokes(r):void 0)).filter((i=>!!i))}static containsSymbol(r,s){return r.children.some((r=>r.type===i.SymbolType.Group?OISymbolGroup.containsSymbol(r,s):r.id===s))}static removeChilds(r,s){r.children=r.children.filter((i=>!s.includes(i.id)));return r.children.slice().forEach((n=>{n.type===i.SymbolType.Group&&(n.removeChilds(s).children.length||(r.children=r.children.filter((i=>i.id!==n.id))))})),r}clone(){const i=new OISymbolGroup(this.children.map((i=>i.clone())),structuredClone(Object.assign({},this.style)));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.decorators=this.decorators.map((i=>i.clone())),i}toJSON(){return{id:this.id,type:this.type,children:JSON.parse(JSON.stringify(this.children)),decorators:this.decorators.length?JSON.parse(JSON.stringify(this.decorators)):void 0}}}class OIText extends OISymbolBase{constructor(r,s,n,a){super(i.SymbolType.Text,a),this.isClosed=!0,this.point=s,this.bounds=new Box(n),this.chars=r,this.decorators=[]}get label(){return this.chars.map((i=>i.label)).join("")}get vertices(){if(this.rotation){const i=this.rotation.center,r=convertDegreeToRadian(-this.rotation.degree);return this.bounds.corners.map((s=>computeRotatedPoint(s,i,r)))}return this.bounds.corners}get snapPoints(){const i=this.bounds.yMax-this.point.y,r=[{x:this.bounds.x,y:this.bounds.yMin+i},{x:this.bounds.xMax,y:this.bounds.yMin+i},{x:this.bounds.xMax,y:this.bounds.yMax-i},{x:this.bounds.x,y:this.bounds.yMax-i},this.bounds.center];if(this.rotation){const i=this.rotation.center,s=convertDegreeToRadian(-this.rotation.degree);return r.map((r=>computeRotatedPoint(r,i,s)))}return r}getCharCorners(i){const r=new Box(i.bounds);if(this.rotation){const i=this.rotation.center,s=convertDegreeToRadian(-this.rotation.degree);return r.corners.map((r=>computeRotatedPoint(r,i,s)))}return r.corners}getCharsOverlaps(i){return this.chars.filter((r=>{const s=this.getCharCorners(r);return i.some((i=>isPointInsidePolygon(i,s)))}))}overlaps(i){return this.vertices.some((r=>Box.containsPoint(i,r)))||this.edges.some((r=>Box.getSides(i).some((i=>!!findIntersectionBetween2Segment(r,i)))))}clone(){const i=new OIText(structuredClone(this.chars),structuredClone(this.point),this.bounds,structuredClone(this.style));return i.id=this.id,i.selected=this.selected,i.deleting=this.deleting,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.decorators=this.decorators.map((i=>i.clone())),i.rotation=this.rotation?structuredClone(this.rotation):void 0,i}toJSON(){return{id:this.id,type:this.type,point:this.point,chars:this.chars,style:this.style,rotation:this.rotation,bounds:this.bounds,decorators:this.decorators.length?this.decorators:void 0}}static create(i){var r,s;if(!isValidPoint(null==i?void 0:i.point))throw new Error("Unable to create a OIText, point are invalid");if(!(null===(r=i.chars)||void 0===r?void 0:r.length))throw new Error("Unable to create a OIText, no chars");if(!i.bounds)throw new Error("Unable to create a OIText, no boundingBox");const n=new OIText(i.chars,i.point,i.bounds,i.style);return i.id&&(n.id=i.id),(null===(s=i.decorators)||void 0===s?void 0:s.length)&&i.decorators.forEach((i=>{(null==i?void 0:i.kind)&&n.decorators.push(new OIDecorator(i.kind,Object.assign({},n.style,i.style)))})),n}}const _e={color:"grey",fill:"none",width:12,opacity:.2};class OIEraser extends OISymbolBase{constructor(){super(i.SymbolType.Eraser,_e),this.isClosed=!1,this.id=`${this.type}-${createUUID()}`,this.creationTime=Date.now(),this.modificationDate=this.creationTime,this.pointers=[]}get bounds(){return Box.createFromPoints(this.vertices)}get vertices(){return this.pointers}get snapPoints(){return[]}clone(){const i=new OIEraser;return i.id=this.id,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.pointers=structuredClone(this.pointers),i}overlaps(i){return this.pointers.some((r=>r.x>=i.x&&r.x<=i.x+i.width&&r.y>=i.y&&r.y<=i.y+i.height))}toJSON(){return{id:this.id,pointers:this.pointers,style:this.style}}}class Stroke{constructor(r,s="pen"){this.type=i.SymbolType.Stroke,this.id=`${this.type}-${createUUID()}`,this.creationTime=Date.now(),this.modificationDate=this.creationTime,this.style=r,this.pointerType=s,this.pointers=[],this.length=0}clone(){const i=new Stroke(this.style,this.pointerType);return i.id=this.id,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.pointers=structuredClone(this.pointers),i.length=this.length,i}formatToSend(){const i={id:this.id,pointerType:this.pointerType,p:[],t:[],x:[],y:[]};return this.pointers.forEach((r=>{i.p.push(r.p),i.t.push(r.t),i.x.push(r.x),i.y.push(r.y)})),i}}var Pe,Ee,ke,Me;class Model{constructor(r=100,s=100,n=0,a=Date.now()){Pe.set(this,LoggerManager.getLogger(i.LoggerClass.MODEL)),__classPrivateFieldGet(this,Pe,"f").info("constructor",{width:r,height:s,creationDate:a}),this.creationTime=a,this.modificationDate=a,this.width=r,this.height=s,this.rowHeight=n,this.symbols=[],this.positions={lastSentPosition:0,lastReceivedPosition:0},this.idle=!0}computePressure(i,r){let s=1;i===r?s=1:i<10?s=.2+Math.pow(.1*i,.4):i>r-10&&(s=.2+Math.pow(.1*(r-i),.4));const n=s*Math.max(.1,1-.1*Math.sqrt(i));return isNaN(n)?.5:Math.round(100*n)/100}filterPointByAcquisitionDelta(i,r,s){const n=2+(i.style["-myscript-pen-width"]||0)/4;return!s||0===i.pointers.length||Math.abs(s.x-r.x)>=n||Math.abs(s.y-r.y)>=n}getStrokeFromPoint(i){__classPrivateFieldGet(this,Pe,"f").info("getStrokeFromPoint",{point:i});const isBetween=(i,r,s)=>i>=r&&i<=s,r=[];return this.symbols.forEach((s=>{for(let n=0;n<s.pointers.length;n++){const a=s.pointers[n];if(isBetween(a.x,i.x-5,i.x+5)&&isBetween(a.y,i.y-5,i.y+5)){r.push(s);break}if(computeDistance(i,a)<10){r.push(s);break}}})),__classPrivateFieldGet(this,Pe,"f").debug("getStrokeFromPoint",{strokes:r}),r}addPoint(i,r){__classPrivateFieldGet(this,Pe,"f").debug("addPoint",{stroke:i,pointer:r});const s=i.pointers.at(-1);if(this.filterPointByAcquisitionDelta(i,r,s)){const n=s?computeDistance(r,s):0;i.length+=n,r.p=this.computePressure(n,i.length),i.pointers.push(r),i.modificationDate=Date.now()}}addStroke(i){__classPrivateFieldGet(this,Pe,"f").info("addStroke",{stroke:i}),this.symbols.push(i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0}updateStroke(i){__classPrivateFieldGet(this,Pe,"f").info("updateStroke",{updatedStroke:i});const r=this.symbols.findIndex((r=>r.id===i.id));-1!==r&&(i.modificationDate=Date.now(),this.symbols.splice(r,1,i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,Pe,"f").debug("updateStroke",this.symbols)}removeStroke(i){__classPrivateFieldGet(this,Pe,"f").info("removeStroke",{id:i});const r=this.symbols.findIndex((r=>r.id===i));-1!==r&&(this.positions.lastSentPosition--,this.positions.lastReceivedPosition--,this.symbols.splice(r,1),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,Pe,"f").debug("removeStroke",this.symbols)}removeStrokesFromPoint(i){__classPrivateFieldGet(this,Pe,"f").info("removeStrokesFromPoint",{point:i});const r=this.getStrokeFromPoint(i);return r.forEach((i=>{this.removeStroke(i.id)})),__classPrivateFieldGet(this,Pe,"f").debug("removeStrokesFromPoint",r.map((i=>i.id))),r.map((i=>i.id))}extractUnsentStrokes(){return this.symbols.slice(this.positions.lastSentPosition)}initCurrentStroke(i,r,s,n=96){if(__classPrivateFieldGet(this,Pe,"f").info("initCurrentStroke",{point:i,pointerType:r,style:s,dpi:n}),s["-myscript-pen-width"]){const i=s["-myscript-pen-width"]*n/25.4;s.width=i/2}this.modificationDate=Date.now(),this.exports=void 0,this.currentSymbol=new Stroke(s,r),__classPrivateFieldGet(this,Pe,"f").debug("initCurrentStroke",this.currentSymbol),this.addPoint(this.currentSymbol,i)}appendToCurrentStroke(i){__classPrivateFieldGet(this,Pe,"f").info("appendToCurrentStroke",{point:i}),this.currentSymbol&&this.addPoint(this.currentSymbol,i),__classPrivateFieldGet(this,Pe,"f").debug("appendToCurrentStroke",this.currentSymbol)}endCurrentStroke(i){__classPrivateFieldGet(this,Pe,"f").info("endCurrentStroke",{point:i}),this.currentSymbol&&(this.addPoint(this.currentSymbol,i),this.addStroke(this.currentSymbol),this.currentSymbol=void 0),__classPrivateFieldGet(this,Pe,"f").debug("endCurrentStroke",this.currentSymbol)}updatePositionSent(i=this.symbols.length){__classPrivateFieldGet(this,Pe,"f").info("updatePositionSent",{position:i}),this.positions.lastSentPosition=i,__classPrivateFieldGet(this,Pe,"f").debug("updatePositionSent",this.positions.lastSentPosition)}updatePositionReceived(){__classPrivateFieldGet(this,Pe,"f").info("updatePositionReceived"),this.positions.lastReceivedPosition=this.positions.lastSentPosition,__classPrivateFieldGet(this,Pe,"f").debug("updatePositionReceived",this.positions.lastReceivedPosition)}mergeExport(i){__classPrivateFieldGet(this,Pe,"f").info("mergeExport",{exports:i}),this.exports?Object.assign(this.exports,i):this.exports=i,__classPrivateFieldGet(this,Pe,"f").debug("mergeExport",this.exports)}mergeConvert(i){__classPrivateFieldGet(this,Pe,"f").info("mergeConvert",{converts:i}),this.converts?Object.assign(this.converts,i):this.converts=i,__classPrivateFieldGet(this,Pe,"f").debug("mergeConvert",this.converts)}clone(){__classPrivateFieldGet(this,Pe,"f").info("clone");const i=new Model(this.width,this.height,this.rowHeight,this.creationTime);return i.modificationDate=JSON.parse(JSON.stringify(this.modificationDate)),i.currentSymbol=this.currentSymbol?this.currentSymbol.clone():void 0,i.symbols=this.symbols.map((i=>i.clone())),i.positions=JSON.parse(JSON.stringify(this.positions)),i.exports=this.exports?JSON.parse(JSON.stringify(this.exports)):void 0,i.converts=this.converts?JSON.parse(JSON.stringify(this.converts)):void 0,i.idle=this.idle,__classPrivateFieldGet(this,Pe,"f").debug("clone",{clonedModel:i}),i}clear(){__classPrivateFieldGet(this,Pe,"f").info("clear"),this.modificationDate=Date.now(),this.currentSymbol=void 0,this.symbols=[],this.positions.lastSentPosition=0,this.positions.lastReceivedPosition=0,this.exports=void 0,this.converts=void 0,this.idle=!0}}Pe=new WeakMap;class OIModel{constructor(r=100,s=100,n=0,a=Date.now()){Ee.set(this,LoggerManager.getLogger(i.LoggerClass.MODEL)),this.creationTime=a,this.modificationDate=a,this.width=r,this.height=s,this.rowHeight=n,this.symbols=[],this.exports=void 0,this.converts=void 0,this.idle=!0}get symbolsSelected(){return this.symbols.filter((i=>i.selected))}get symbolsToDelete(){return this.symbols.filter((i=>i.deleting))}selectSymbol(r){const s=this.symbols.find((s=>s.id===r||s.type===i.SymbolType.Group&&s.containsSymbol(r)));s&&(s.selected=!0)}unselectSymbol(i){const r=this.symbols.find((r=>r.id===i));r&&(r.selected=!1)}resetSelection(){this.symbols.forEach((i=>i.selected=!1))}getRootSymbol(r){return this.symbols.find((s=>s.id===r||s.type===i.SymbolType.Group&&s.containsSymbol(r)?s:void 0))}getSymbolRowIndex(i){return Math.round(i.bounds.yMid/this.rowHeight)}getSymbolsByRowOrdered(){const i=[];return this.symbols.forEach((r=>{const s=this.getSymbolRowIndex(r),n=i.find((i=>i.rowIndex===s));n?n.symbols.push(r):i.push({rowIndex:s,symbols:[r]})})),i.forEach((i=>{i.symbols.sort(((i,r)=>i.bounds.xMid-r.bounds.xMid))})),i.sort(((i,r)=>i.rowIndex-r.rowIndex))}roundToLineGuide(i){return Math.round(i/this.rowHeight)*this.rowHeight}isSymbolAbove(i,r){return i.bounds.yMid-this.rowHeight/2>r.bounds.yMid}isSymbolInRow(i,r){return Math.abs(i.bounds.yMid-r.bounds.yMid)<=this.rowHeight/2}isSymbolBelow(i,r){return i.bounds.yMid+this.rowHeight/2<r.bounds.yMid}getFirstSymbol(i){if(i.length)return i.reduce(((i,r)=>{if(i){if(Math.round(i.bounds.yMid/this.rowHeight)<Math.round(r.bounds.yMid/this.rowHeight))return i;if(Math.round(i.bounds.yMid/this.rowHeight)==Math.round(r.bounds.yMid/this.rowHeight)&&i.bounds.xMid<r.bounds.xMid)return i}return r}))}getLastSymbol(i){if(i.length)return i.reduce(((i,r)=>{if(i){if(i.bounds.yMid-r.bounds.yMid>this.rowHeight/2)return i;if(i.bounds.yMid-r.bounds.yMid<this.rowHeight/2)return r;if(i.bounds.xMid>r.bounds.xMid)return i}return r}))}addSymbol(i){__classPrivateFieldGet(this,Ee,"f").info("addSymbol",{symbol:i});if(this.symbols.findIndex((r=>r.id===i.id))>-1)throw new Error(`Symbol id already exist: ${i.id}`);this.symbols.push(i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0,__classPrivateFieldGet(this,Ee,"f").debug("addSymbol",this.symbols)}updateSymbol(i){__classPrivateFieldGet(this,Ee,"f").info("updateSymbol",{updatedSymbol:i});const r=this.symbols.findIndex((r=>r.id===i.id));-1!==r&&(i.modificationDate=Date.now(),this.symbols.splice(r,1,i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,Ee,"f").debug("updateSymbol",this.symbols)}replaceSymbol(i,r){const s=this.symbols.findIndex((r=>r.id===i));-1!==s&&(this.symbols.splice(s,1,...r),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0)}changeOrderSymbol(i,r){const s=this.symbols.findIndex((r=>r.id===i));if(s>-1){let i=s;switch(r){case"first":i=0;break;case"last":i=this.symbols.length-1;break;case"forward":i=Math.min(i+1,this.symbols.length-1);break;case"backward":i=Math.max(i-1,0)}const n=this.symbols.splice(s,1)[0];this.symbols.splice(i,0,n)}}removeSymbol(i){__classPrivateFieldGet(this,Ee,"f").info("removeSymbol",{id:i});const r=this.symbols.findIndex((r=>r.id===i));-1!==r&&(this.symbols.splice(r,1),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,Ee,"f").debug("removeSymbol",this.symbols)}extractDifferenceSymbols(i){return{added:this.symbols.filter((r=>-1===i.symbols.findIndex((i=>r.id===i.id&&r.modificationDate===i.modificationDate)))),removed:i.symbols.filter((i=>-1===this.symbols.findIndex((r=>i.id===r.id&&i.modificationDate===r.modificationDate))))}}mergeExport(i){__classPrivateFieldGet(this,Ee,"f").info("mergeExport",{exports:i}),this.exports?Object.assign(this.exports,i):this.exports=i,__classPrivateFieldGet(this,Ee,"f").debug("mergeExport",this.exports)}clone(){__classPrivateFieldGet(this,Ee,"f").info("clone");const i=new OIModel(this.width,this.height,this.rowHeight,this.creationTime);return i.modificationDate=this.modificationDate,i.symbols=this.symbols.map((i=>{const r=i.clone();return r.selected=!1,r})),i.exports=structuredClone(this.exports),i.idle=this.idle,__classPrivateFieldGet(this,Ee,"f").debug("clone",{clonedModel:i}),i}clear(){__classPrivateFieldGet(this,Ee,"f").info("clear"),this.modificationDate=Date.now(),this.symbols=[],this.currentSymbol=void 0,this.exports=void 0,this.converts=void 0,this.idle=!0}}Ee=new WeakMap,i.RecognizerError=void 0,(ke=i.RecognizerError||(i.RecognizerError={})).NO_ACTIVITY="Session closed due to no activity. Without a connection on your part, it will be permanently lost after an hour.",ke.WRONG_CREDENTIALS="Application credentials are invalid. Please check or regenerate your application key and hmackey.",ke.TOO_OLD="Session is too old. Max Session Duration Reached.",ke.NO_SESSION_FOUND="No sessions found. Without activation for 1 hour, sessions are deleted from the server. To avoid losing your work, use the json export, then import it this will create a new session.",ke.UNKNOW="An unknown error has occurred.",ke.ABNORMAL_CLOSURE="MyScript recognition server is not reachable.",ke.CANT_ESTABLISH="Unable to establish a connection to MyScript recognition server. Check the host and your connectivity.",ke.GOING_AWAY="MyScript recognition server is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.",ke.PROTOCOL_ERROR="MyScript recognition server terminated the connection due to a protocol error.",ke.UNSUPPORTED_DATA="MyScript recognition server terminated the connection because the endpoint received data of a type it cannot accept. (For example, a text-only endpoint received binary data.)",ke.INVALID_FRAME_PAYLOAD="MyScript recognition server terminated the connection because a message was received that contained inconsistent data (e.g., non-UTF-8 data within a text message).",ke.POLICY_VIOLATION="MyScript recognition server terminated the connection because it received a message that violates its policy.",ke.MESSAGE_TOO_BIG="MyScript recognition server terminated the connection because a data frame was received that is too large.",ke.INTERNAL_ERROR="MyScript recognition server terminated the connection because it encountered an unexpected condition that prevented it from fulfilling the request.",ke.SERVICE_RESTART="MyScript recognition server terminated the connection because it is restarting.",ke.TRY_AGAIN="MyScript recognition server terminated the connection due to a temporary condition, e.g. it is overloaded and is casting off some of its clients.",ke.BAD_GATEWAY="MyScript recognition server was acting as a gateway or proxy and received an invalid response from the upstream server.",ke.TLS_HANDSHAKE="MyScript recognition server connection was closed due to a failure to perform a TLS handshake",i.TOIMessageType=void 0,(Me=i.TOIMessageType||(i.TOIMessageType={})).HMAC_Challenge="hmacChallenge",Me.Authenticated="authenticated",Me.SessionDescription="sessionDescription",Me.NewPart="newPart",Me.PartChanged="partChanged",Me.ContentChanged="contentChanged",Me.Idle="idle",Me.Pong="pong",Me.Exported="exported",Me.GestureDetected="gestureDetected",Me.ContextlessGesture="contextlessGesture",Me.Error="error";var Ce=null;try{var Ge="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");Ce=Ge.Worker}catch(i){}function createBase64WorkerFactory$2(i,r,s){var n=void 0===r?null:r,a=function decodeBase64$1(i,r){return Buffer.from(i,"base64").toString(r?"utf16":"utf8")}(i,void 0!==s&&s),l=a.indexOf("\n",10)+1,d=a.substring(l)+(n?"//# sourceMappingURL="+n:"");return function WorkerFactory(i){return new Ce(d,Object.assign({},i,{eval:!0}))}}function createURL(i,r,s){var n=void 0===r?null:r,a=function decodeBase64(i,r){var s=atob(i);if(r){for(var n=new Uint8Array(s.length),a=0,l=s.length;a<l;++a)n[a]=s.charCodeAt(a);return String.fromCharCode.apply(null,new Uint16Array(n.buffer))}return s}(i,void 0!==s&&s),l=a.indexOf("\n",10)+1,d=a.substring(l)+(n?"//# sourceMappingURL="+n:""),h=new Blob([d],{type:"application/javascript"});return URL.createObjectURL(h)}var Te="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var Ie,Le,Fe,Oe,De,Re,Ae,Be,$e,Ne=function createBase64WorkerFactory(i,r,s){return function isNodeJS(){return Te}()?createBase64WorkerFactory$2(i,r,s):function createBase64WorkerFactory$1(i,r,s){var n;return function WorkerFactory(a){return n=n||createURL(i,r,s),new Worker(n,a)}}(i,r,s)}("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7c2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwoZT0+e3NldEludGVydmFsKCgoKT0+e3Bvc3RNZXNzYWdlKHt0eXBlOiJwaW5nIn0pfSksZS5kYXRhLnBpbmdEZWxheSl9KSl9KCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPXBpbmcud29ya2VyLmpzLm1hcAoK",null,!1);class OIRecognizer{constructor(r,s){Ie.add(this),Le.set(this,LoggerManager.getLogger(i.LoggerClass.RECOGNIZER)),this.pingCount=0,this.reconnectionCount=0,__classPrivateFieldGet(this,Le,"f").info("constructor",{serverConfig:r,recognitionConfig:s}),this.serverConfiguration=r,this.recognitionConfiguration=s;const n="https"===this.serverConfiguration.scheme?"wss":"ws";this.url=`${n}://${this.serverConfiguration.host}/api/v4.0/iink/offscreen?applicationKey=${this.serverConfiguration.applicationKey}`,this.exportDeferredMap=new Map,this.contextlessGestureDeferred=new Map,this.connected=new DeferredPromise,this.initialized=new DeferredPromise}get mimeTypes(){return["application/vnd.myscript.jiix"]}get event(){return InternalEvent.getInstance()}rejectDeferredPending(i){var r,s,n,a,l,d,h,c;this.initialized.reject(i),null===(r=this.addStrokeDeferred)||void 0===r||r.reject(i),null===(s=this.transformStrokeDeferred)||void 0===s||s.reject(i),null===(n=this.eraseStrokeDeferred)||void 0===n||n.reject(i),null===(a=this.replaceStrokeDeferred)||void 0===a||a.reject(i),null===(l=this.undoDeferred)||void 0===l||l.reject(i),null===(d=this.redoDeferred)||void 0===d||d.reject(i),null===(h=this.clearDeferred)||void 0===h||h.reject(i),Array.from(this.contextlessGestureDeferred.values()).forEach((r=>{r.reject(i)})),Array.from(this.exportDeferredMap.values()).forEach((r=>{r.reject(i)})),null===(c=this.waitForIdleDeferred)||void 0===c||c.reject(i)}resetAllDeferred(){this.connected=new DeferredPromise,this.initialized=new DeferredPromise,this.addStrokeDeferred=void 0,this.contextlessGestureDeferred.clear(),this.transformStrokeDeferred=void 0,this.eraseStrokeDeferred=void 0,this.replaceStrokeDeferred=void 0,this.exportDeferredMap.clear(),this.waitForIdleDeferred=void 0,this.closeDeferred=void 0}clearSocketListener(){this.socket.removeEventListener("open",this.openCallback.bind(this)),this.socket.removeEventListener("close",this.closeCallback.bind(this)),this.socket.removeEventListener("message",this.messageCallback.bind(this))}closeCallback(r){var s,n;__classPrivateFieldGet(this,Le,"f").info("closeCallback",{evt:r});let a=r.reason;if(!this.currentErrorCode)switch(r.code){case 1e3:break;case 1001:a=i.RecognizerError.GOING_AWAY;break;case 1002:a=i.RecognizerError.PROTOCOL_ERROR;break;case 1003:a=i.RecognizerError.UNSUPPORTED_DATA;break;case 1006:a=i.RecognizerError.ABNORMAL_CLOSURE;break;case 1007:a=i.RecognizerError.INVALID_FRAME_PAYLOAD;break;case 1008:a=i.RecognizerError.POLICY_VIOLATION;break;case 1009:a=i.RecognizerError.MESSAGE_TOO_BIG;break;case 1011:a=i.RecognizerError.INTERNAL_ERROR;break;case 1012:a=i.RecognizerError.SERVICE_RESTART;break;case 1013:a=i.RecognizerError.TRY_AGAIN;break;case 1014:a=i.RecognizerError.BAD_GATEWAY;break;case 1015:a=i.RecognizerError.TLS_HANDSHAKE;break;default:a=i.RecognizerError.CANT_ESTABLISH}if(this.clearSocketListener(),null===(s=this.closeDeferred)||void 0===s||s.resolve(),!this.currentErrorCode&&1e3!==r.code){const i=new Error(a);this.event.emitError(i),this.rejectDeferredPending(a)}null===(n=this.pingWorker)||void 0===n||n.terminate(),this.resetAllDeferred()}openCallback(){this.connected.resolve(),this.reconnectionCount=0,__classPrivateFieldGet(this,Ie,"m",Fe).call(this,{type:"authenticate","myscript-client-name":"iink-ts","myscript-client-version":"2.0.1"})}manageHMACChallenge(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ie,"m",Fe).call(this,{type:"hmac",hmac:yield computeHmac(i.hmacChallenge,this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey)})}))}initPing(){this.pingWorker=new Ne,this.pingWorker.postMessage({pingDelay:this.serverConfiguration.websocket.pingDelay}),this.pingWorker.onmessage=()=>{var i;this.pingCount<this.serverConfiguration.websocket.maxPingLostCount?__classPrivateFieldGet(this,Ie,"m",Fe).call(this,{type:"ping"}):(this.close(1e3,"MAXIMUM_PING_REACHED"),null===(i=this.pingWorker)||void 0===i||i.terminate()),this.pingCount++}}manageAuthenticated(){const i=25.4/96;__classPrivateFieldGet(this,Ie,"m",Fe).call(this,{type:this.sessionId?"restoreSession":"initSession",iinkSessionId:this.sessionId,scaleX:i,scaleY:i,configuration:this.recognitionConfiguration})}manageSessionDescriptionMessage(i){i.iinkSessionId&&(this.sessionId=i.iinkSessionId),this.currentPartId?__classPrivateFieldGet(this,Ie,"m",Fe).call(this,{type:"openContentPart",id:this.currentPartId}):__classPrivateFieldGet(this,Ie,"m",Fe).call(this,{type:"newContentPart",contentType:this.recognitionConfiguration.type,mimeTypes:this.mimeTypes})}manageNewPartMessage(i){this.initialized.resolve(),this.currentPartId=i.id}managePartChangeMessage(i){var r;null===(r=this.initialized)||void 0===r||r.resolve(),this.currentPartId=i.partId}manageContentChangedMessage(i){var r,s,n,a,l,d,h;null===(r=this.initialized)||void 0===r||r.resolve(),null===(s=this.replaceStrokeDeferred)||void 0===s||s.resolve(),null===(n=this.transformStrokeDeferred)||void 0===n||n.resolve(),null===(a=this.eraseStrokeDeferred)||void 0===a||a.resolve(),null===(l=this.undoDeferred)||void 0===l||l.resolve(),null===(d=this.redoDeferred)||void 0===d||d.resolve(),null===(h=this.clearDeferred)||void 0===h||h.resolve(),this.event.emitContextChange({canRedo:i.canRedo,canUndo:i.canRedo})}manageExportMessage(i){i.exports["application/vnd.myscript.jiix"]&&(i.exports["application/vnd.myscript.jiix"]=JSON.parse(i.exports["application/vnd.myscript.jiix"].toString())),Object.keys(i.exports).forEach((r=>{this.exportDeferredMap.has(r)&&this.exportDeferredMap.get(r).resolve(i.exports)})),this.event.emitExported(i.exports)}manageWaitForIdle(){var i;null===(i=this.waitForIdleDeferred)||void 0===i||i.resolve(),this.event.emitIdle(!0)}manageErrorMessage(r){var s,n;this.currentErrorCode=(null===(s=r.data)||void 0===s?void 0:s.code)||r.code;let a=(null===(n=r.data)||void 0===n?void 0:n.message)||r.message||i.RecognizerError.UNKNOW;if("no.activity"===this.currentErrorCode)this.rejectDeferredPending(a),this.event.emitNotif({message:i.RecognizerError.NO_ACTIVITY,timeout:1/0});else{switch(this.currentErrorCode){case"access.not.granted":a=i.RecognizerError.WRONG_CREDENTIALS;break;case"session.too.old":a=i.RecognizerError.TOO_OLD;break;case"restore.session.not.found":a=i.RecognizerError.NO_SESSION_FOUND}this.rejectDeferredPending(a),this.event.emitError(new Error(a))}}manageGestureDetected(i){var r;null===(r=this.addStrokeDeferred)||void 0===r||r.resolve(i)}manageContextlessGesture(i){var r;null===(r=this.contextlessGestureDeferred.get(i.strokeId))||void 0===r||r.resolve(i)}messageCallback(r){this.currentErrorCode=void 0;try{const s=JSON.parse(r.data);if(s.type===i.TOIMessageType.Pong)return;switch(this.pingCount=0,s.type){case i.TOIMessageType.HMAC_Challenge:this.manageHMACChallenge(s);break;case i.TOIMessageType.Authenticated:this.manageAuthenticated();break;case i.TOIMessageType.SessionDescription:this.manageSessionDescriptionMessage(s);break;case i.TOIMessageType.NewPart:this.manageNewPartMessage(s);break;case i.TOIMessageType.PartChanged:this.managePartChangeMessage(s);break;case i.TOIMessageType.ContentChanged:this.manageContentChangedMessage(s);break;case i.TOIMessageType.Exported:this.manageExportMessage(s);break;case i.TOIMessageType.GestureDetected:this.manageGestureDetected(s);break;case i.TOIMessageType.ContextlessGesture:this.manageContextlessGesture(s);break;case i.TOIMessageType.Error:this.manageErrorMessage(s);break;case i.TOIMessageType.Idle:this.manageWaitForIdle();break;default:__classPrivateFieldGet(this,Le,"f").warn("messageCallback",`Message type unknow: "${s}".`)}}catch(i){this.event.emitError(new Error(r.data))}}init(){return __awaiter(this,void 0,void 0,(function*(){"restore.session.not.found"===this.currentErrorCode&&(this.currentErrorCode,this.sessionId=void 0,this.currentPartId=void 0),this.socket=new WebSocket(this.url),this.clearSocketListener(),this.socket.addEventListener("open",this.openCallback.bind(this)),this.socket.addEventListener("close",this.closeCallback.bind(this)),this.socket.addEventListener("message",this.messageCallback.bind(this)),yield this.initialized.promise,this.serverConfiguration.websocket.pingEnabled&&(this.pingCount=0,this.initPing())}))}send(i){return __awaiter(this,void 0,void 0,(function*(){if(!this.socket)return Promise.reject(new Error("Recognizer must be initilized"));switch(this.socket.readyState){case this.socket.CONNECTING:case this.socket.OPEN:return yield this.initialized.promise,__classPrivateFieldGet(this,Ie,"m",Fe).call(this,i),Promise.resolve();case this.socket.CLOSING:case this.socket.CLOSED:return this.serverConfiguration.websocket.autoReconnect?(this.reconnectionCount++,this.serverConfiguration.websocket.maxRetryCount>this.reconnectionCount?(this.event.emitClearMessage(),yield this.init(),yield this.waitForIdle(),this.send(i)):Promise.reject(new Error("Unable to send message. The maximum number of connection attempts has been reached."))):Promise.reject(new Error("Unable to send message. Connection closed and automatic reconnection disabled"))}}))}buildAddStrokesMessage(i,r=!0){return{type:"addStrokes",processGestures:r,strokes:i.map((i=>i.formatToSend()))}}addStrokes(i,r=!0){var s,n;return __awaiter(this,void 0,void 0,(function*(){return this.addStrokeDeferred=new DeferredPromise,0===i.length?(this.addStrokeDeferred.resolve(void 0),null===(s=this.addStrokeDeferred)||void 0===s?void 0:s.promise):(yield this.send(this.buildAddStrokesMessage(i,r)),null===(n=this.addStrokeDeferred)||void 0===n?void 0:n.promise)}))}buildReplaceStrokesMessage(i,r){return{type:"replaceStrokes",oldStrokeIds:i,newStrokes:r.map((i=>i.formatToSend()))}}replaceStrokes(i,r){var s,n;return __awaiter(this,void 0,void 0,(function*(){return this.replaceStrokeDeferred=new DeferredPromise,0===i.length?(this.replaceStrokeDeferred.resolve(),null===(s=this.replaceStrokeDeferred)||void 0===s?void 0:s.promise):(yield this.send(this.buildReplaceStrokesMessage(i,r)),null===(n=this.replaceStrokeDeferred)||void 0===n?void 0:n.promise)}))}buildTransformTranslateMessage(i,r,s){return{type:"transform",transformationType:"TRANSLATE",strokeIds:i,tx:r,ty:s}}transformTranslate(i,r,s){var n,a;return __awaiter(this,void 0,void 0,(function*(){return this.transformStrokeDeferred=new DeferredPromise,0===i.length?(this.transformStrokeDeferred.resolve(),null===(n=this.transformStrokeDeferred)||void 0===n?void 0:n.promise):(yield this.send(this.buildTransformTranslateMessage(i,r,s)),null===(a=this.transformStrokeDeferred)||void 0===a?void 0:a.promise)}))}buildTransformRotateMessage(i,r,s=0,n=0){return{type:"transform",transformationType:"ROTATE",strokeIds:i,angle:r,x0:s,y0:n}}transformRotate(i,r,s=0,n=0){var a,l;return __awaiter(this,void 0,void 0,(function*(){return this.transformStrokeDeferred=new DeferredPromise,0===i.length?(this.transformStrokeDeferred.resolve(),null===(a=this.transformStrokeDeferred)||void 0===a?void 0:a.promise):(yield this.send(this.buildTransformRotateMessage(i,r,s,n)),null===(l=this.transformStrokeDeferred)||void 0===l?void 0:l.promise)}))}buildTransformScaleMessage(i,r,s,n=0,a=0){return{type:"transform",transformationType:"SCALE",strokeIds:i,scaleX:r,scaleY:s,x0:n,y0:a}}transformScale(i,r,s,n=0,a=0){var l,d;return __awaiter(this,void 0,void 0,(function*(){return this.transformStrokeDeferred=new DeferredPromise,0===i.length?(this.transformStrokeDeferred.resolve(),null===(l=this.transformStrokeDeferred)||void 0===l?void 0:l.promise):(yield this.send(this.buildTransformScaleMessage(i,r,s,n,a)),null===(d=this.transformStrokeDeferred)||void 0===d?void 0:d.promise)}))}buildTransformMatrixMessage(i,r){return Object.assign({type:"transform",transformationType:"MATRIX",strokeIds:i},r)}transformMatrix(i,r){var s,n;return __awaiter(this,void 0,void 0,(function*(){return this.transformStrokeDeferred=new DeferredPromise,0===i.length?(this.transformStrokeDeferred.resolve(),null===(s=this.transformStrokeDeferred)||void 0===s?void 0:s.promise):(yield this.send(this.buildTransformMatrixMessage(i,r)),null===(n=this.transformStrokeDeferred)||void 0===n?void 0:n.promise)}))}buildEraseStrokesMessage(i){return{type:"eraseStrokes",strokeIds:i}}eraseStrokes(i){var r,s;return __awaiter(this,void 0,void 0,(function*(){return this.eraseStrokeDeferred=new DeferredPromise,0===i.length?(this.eraseStrokeDeferred.resolve(),null===(r=this.eraseStrokeDeferred)||void 0===r?void 0:r.promise):(yield this.send(this.buildEraseStrokesMessage(i)),null===(s=this.eraseStrokeDeferred)||void 0===s?void 0:s.promise)}))}recognizeGesture(i){return __awaiter(this,void 0,void 0,(function*(){if(!i)return;this.contextlessGestureDeferred.set(i.id,new DeferredPromise);const r=25.4/96;return yield this.send({type:"contextlessGesture",scaleX:r,scaleY:r,stroke:i.formatToSend()}),this.contextlessGestureDeferred.get(i.id).promise}))}waitForIdle(){var i;return __awaiter(this,void 0,void 0,(function*(){this.waitForIdleDeferred&&!this.waitForIdleDeferred.isFullFilled||(this.waitForIdleDeferred=new DeferredPromise);return yield this.send({type:"waitForIdle"}),null===(i=this.waitForIdleDeferred)||void 0===i?void 0:i.promise}))}buildUndoRedoChanges(i){var r,s,n,a,l,d,h;const c=[];return(null===(r=i.added)||void 0===r?void 0:r.length)&&c.push(this.buildAddStrokesMessage(i.added,!1)),(null===(s=i.erased)||void 0===s?void 0:s.length)&&c.push(this.buildEraseStrokesMessage(i.erased.map((i=>i.id)))),(null===(n=i.replaced)||void 0===n?void 0:n.newStrokes.length)&&c.push(this.buildReplaceStrokesMessage(i.replaced.oldStrokes.map((i=>i.id)),i.replaced.newStrokes)),(null===(a=i.matrix)||void 0===a?void 0:a.strokes.length)&&c.push(this.buildTransformMatrixMessage(i.matrix.strokes.map((i=>i.id)),i.matrix.matrix)),(null===(l=i.translate)||void 0===l?void 0:l.length)&&i.translate.forEach((i=>{c.push(this.buildTransformTranslateMessage(i.strokes.map((i=>i.id)),i.tx,i.ty))})),(null===(d=i.rotate)||void 0===d?void 0:d.length)&&i.rotate.forEach((i=>{c.push(this.buildTransformRotateMessage(i.strokes.map((i=>i.id)),i.angle,i.center.x,i.center.y))})),(null===(h=i.scale)||void 0===h?void 0:h.length)&&i.scale.forEach((i=>{c.push(this.buildTransformScaleMessage(i.strokes.map((i=>i.id)),i.scaleX,i.scaleY,i.origin.x,i.origin.y))})),c}undo(i){var r;return __awaiter(this,void 0,void 0,(function*(){const s=this.buildUndoRedoChanges(i);if(0===s.length)return;this.undoDeferred=new DeferredPromise;const n={type:"undo",changes:s};return yield this.send(n),null===(r=this.undoDeferred)||void 0===r?void 0:r.promise}))}redo(i){var r;return __awaiter(this,void 0,void 0,(function*(){const s=this.buildUndoRedoChanges(i);if(0===s.length)return;this.redoDeferred=new DeferredPromise;const n={type:"redo",changes:s};return yield this.send(n),null===(r=this.redoDeferred)||void 0===r?void 0:r.promise}))}export(i){return __awaiter(this,void 0,void 0,(function*(){const r=i||this.mimeTypes.slice();yield Promise.all(r.map((i=>{var r;return null===(r=this.exportDeferredMap.get(i))||void 0===r?void 0:r.promise}))),r.forEach((i=>{this.exportDeferredMap.set(i,new DeferredPromise)}));const s={type:"export",partId:this.currentPartId,mimeTypes:r};yield this.send(s);const n=yield Promise.all(r.map((i=>this.exportDeferredMap.get(i).promise)));return Object.assign({},...n)}))}clear(){var i;return __awaiter(this,void 0,void 0,(function*(){return this.clearDeferred=new DeferredPromise,yield this.send({type:"clear"}),null===(i=this.clearDeferred)||void 0===i?void 0:i.promise}))}close(i,r){return __awaiter(this,void 0,void 0,(function*(){return this.closeDeferred=new DeferredPromise,this.socket.readyState===this.socket.OPEN||this.socket.readyState===this.socket.CONNECTING?this.socket.close(i,r):this.closeDeferred.resolve(),this.closeDeferred.promise}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){this.resetAllDeferred(),this.socket&&(yield this.close(1e3,"Recognizer destroyed"))}))}}Le=new WeakMap,Ie=new WeakSet,Fe=function _OIRecognizer_send(i){if(!this.socket)throw new Error("Recognizer must be initilized");if(this.socket.readyState!==this.socket.OPEN)throw new Error(`Connection not ready, state: ${this.socket.readyState}}`);this.socket.send(JSON.stringify(i))};class RestRecognizer{constructor(r,s){Oe.set(this,LoggerManager.getLogger(i.LoggerClass.RECOGNIZER)),__classPrivateFieldGet(this,Oe,"f").info("constructor",{serverConfig:r,recognitionConfig:s}),this.serverConfiguration=r,this.recognitionConfiguration=s}get url(){return`${this.serverConfiguration.scheme}://${this.serverConfiguration.host}/api/v4.0/iink/batch`}get postConfig(){switch(this.recognitionConfiguration.type){case"DIAGRAM":return{lang:this.recognitionConfiguration.lang,diagram:this.recognitionConfiguration.diagram,export:this.recognitionConfiguration.export};case"MATH":return{lang:this.recognitionConfiguration.lang,math:this.recognitionConfiguration.math,export:this.recognitionConfiguration.export};case"Raw Content":return{lang:this.recognitionConfiguration.lang,"raw-content":this.recognitionConfiguration["raw-content"],export:this.recognitionConfiguration.export};case"TEXT":return{lang:this.recognitionConfiguration.lang,text:this.recognitionConfiguration.text,export:this.recognitionConfiguration.export};default:throw new Error(`get postConfig error Recognition type unkow "${this.recognitionConfiguration.type}"`)}}buildData(i){__classPrivateFieldGet(this,Oe,"f").info("buildData",{model:i});const r=[];i.symbols.forEach((i=>{const s=r.findIndex((r=>{return s=r.penStyle,n=i.style,s&&n&&s["-myscript-pen-fill-color"]===n["-myscript-pen-fill-color"]&&s["-myscript-pen-fill-style"]===n["-myscript-pen-fill-style"]&&s["-myscript-pen-width"]===n["-myscript-pen-width"]&&s.color===n.color&&s.width===n.width;var s,n}));s>-1?r[s].strokes.push(i):r.push({penStyle:i.style,strokes:[i]})}));const s=[];r.forEach((i=>{const r={penStyle:"{}"===JSON.stringify(i.penStyle)?void 0:me.penStyleToCSS(i.penStyle),strokes:i.strokes.map((i=>i.formatToSend()))};s.push(r)}));const n="Raw Content"===this.recognitionConfiguration.type?"Raw Content":this.recognitionConfiguration.type.charAt(0).toUpperCase()+this.recognitionConfiguration.type.slice(1).toLowerCase(),a={configuration:this.postConfig,xDPI:96,yDPI:96,contentType:n,height:i.height,width:i.width,strokeGroups:s};return __classPrivateFieldGet(this,Oe,"f").debug("buildData",{data:a}),a}post(i,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Oe,"f").info("post",{data:i,mimeType:r});const s=new Headers;s.append("Accept","application/json,"+r),s.append("applicationKey",this.serverConfiguration.applicationKey);try{const r=yield computeHmac(JSON.stringify(i),this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey);s.append("hmac",r)}catch(i){__classPrivateFieldGet(this,Oe,"f").error("post.computeHmac",i)}s.append("Content-Type","application/json"),isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.0.4")&&(s.append("myscript-client-name","iink-ts"),s.append("myscript-client-version","2.0.1"));const n={method:"POST",headers:s,body:JSON.stringify(i)},a=new Request(this.url,n),l=yield fetch(a);if(l.ok){let i;switch(l.headers.get("content-type")){case"application/vnd.openxmlformats-officedocument.presentationml.presentation":case"image/png":case"image/jpeg":i=yield l.blob();break;case"application/json":i=yield l.json();break;case"application/vnd.myscript.jiix":i=yield l.clone().json().catch((()=>__awaiter(this,void 0,void 0,(function*(){return yield l.text()}))));break;default:i=yield l.text()}return __classPrivateFieldGet(this,Oe,"f").debug("post",{result:i}),i}{const i=yield l.json();throw __classPrivateFieldGet(this,Oe,"f").error("post",{err:i}),i}}))}tryFetch(r,s){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Oe,"f").debug("tryFetch",{data:r,mimeType:s}),this.post(r,s).then((i=>{const r={};return r[s]=i,__classPrivateFieldGet(this,Oe,"f").debug("tryFetch",{exports:r}),r})).catch((n=>{__classPrivateFieldGet(this,Oe,"f").error("tryFetch",{data:r,mimeType:s,err:n});let a=n.message||i.RecognizerError.UNKNOW;n.code?"access.not.granted"===n.code&&(a=i.RecognizerError.WRONG_CREDENTIALS):a=i.RecognizerError.CANT_ESTABLISH;throw new Error(a)}))}))}getMimeTypes(i){__classPrivateFieldGet(this,Oe,"f").info("getMimeTypes",{requestedMimeTypes:i});let r=i||[];if(!r.length)switch(this.recognitionConfiguration.type){case"DIAGRAM":r=this.recognitionConfiguration.diagram.mimeTypes;break;case"MATH":r=this.recognitionConfiguration.math.mimeTypes;break;case"Raw Content":r=["application/vnd.myscript.jiix"];break;case"TEXT":r=this.recognitionConfiguration.text.mimeTypes;break;default:throw new Error(`Recognition type "${this.recognitionConfiguration.type}" is unknown.\n Possible types are:\n -DIAGRAM\n -MATH\n -Raw Content\n -TEXT`)}return r}convert(i,r,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Oe,"f").info("convert",{model:i,conversionState:r,requestedMimeTypes:s});const n=i.clone(),a=this.getMimeTypes(s),l=this.buildData(n);l.conversionState=r;const d=a.map((i=>this.tryFetch(l,i)));return(yield Promise.all(d)).forEach((i=>{n.mergeConvert(i)})),__classPrivateFieldGet(this,Oe,"f").debug("convert",{model:n}),n}))}export(i,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Oe,"f").info("export",{model:i,requestedMimeTypes:r});const s=i.clone();if(0===s.symbols.length)return Promise.resolve(s);const n=this.getMimeTypes(r);if(!n.length)return __classPrivateFieldGet(this,Oe,"f").error("export",{model:i,requestedMimeTypes:r,"Export failed, no mimeTypes define in recognition configuration":String}),Promise.reject(new Error("Export failed, no mimeTypes define in recognition configuration"));const a=n.filter((i=>!s.exports||!s.exports[i])),l=this.buildData(i);return(yield Promise.all(a.map((i=>this.tryFetch(l,i))))).forEach((i=>{s.mergeExport(i)})),__classPrivateFieldGet(this,Oe,"f").debug("export",{model:s}),s}))}resize(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Oe,"f").info("resize",{model:i}),this.export(i)}))}}Oe=new WeakMap;class WSRecognizer{constructor(r,s){De.set(this,LoggerManager.getLogger(i.LoggerClass.RECOGNIZER)),this.pingCount=0,this.reconnectionCount=0,this.serverConfiguration=r,this.recognitionConfiguration=s;const n="https"===this.serverConfiguration.scheme?"wss":"ws";this.url=`${n}://${this.serverConfiguration.host}/api/v4.0/iink/document?applicationKey=${this.serverConfiguration.applicationKey}`,__classPrivateFieldGet(this,De,"f").info("constructor",{serverConfig:r,recognitionConfig:s,url:this.url})}get mimeTypes(){switch(this.recognitionConfiguration.type.toLocaleLowerCase()){case"text":return this.recognitionConfiguration.text.mimeTypes;case"math":return this.recognitionConfiguration.math.mimeTypes;default:throw new Error(`Unauthorized recognition type: "${this.recognitionConfiguration.type}"`)}}get internalEvent(){return InternalEvent.getInstance()}infinitePing(){this.pingCount++,this.serverConfiguration.websocket.maxPingLostCount<this.pingCount?this.socket.close(1e3,"MAXIMUM_PING_REACHED"):this.socket.readyState<=1&&setTimeout((()=>{this.socket.readyState<=1&&(this.socket.send(JSON.stringify({type:"ping"})),this.infinitePing())}),this.serverConfiguration.websocket.pingDelay)}openCallback(){var i;null===(i=this.connected)||void 0===i||i.resolve();const r={type:this.sessionId?"restoreIInkSession":"newContentPackage",iinkSessionId:this.sessionId,applicationKey:this.serverConfiguration.applicationKey,xDpi:96,yDpi:96,viewSizeHeight:this.viewSizeHeight,viewSizeWidth:this.viewSizeWidth};isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.0.4")&&(r["myscript-client-name"]="iink-ts",r["myscript-client-version"]="2.0.1"),this.send(r)}rejectDeferredPending(i){var r,s,n,a,l,d,h,c,u,p,m,g,v,y,f,b,x,S,w,_;(null===(r=this.connected)||void 0===r?void 0:r.isPending)&&(null===(s=this.connected)||void 0===s||s.reject(i)),(null===(n=this.initialized)||void 0===n?void 0:n.isPending)&&(null===(a=this.initialized)||void 0===a||a.reject(i)),(null===(l=this.addStrokeDeferred)||void 0===l?void 0:l.isPending)&&(null===(d=this.addStrokeDeferred)||void 0===d||d.reject(i)),(null===(h=this.exportDeferred)||void 0===h?void 0:h.isPending)&&(null===(c=this.exportDeferred)||void 0===c||c.reject(i)),(null===(u=this.convertDeferred)||void 0===u?void 0:u.isPending)&&(null===(p=this.convertDeferred)||void 0===p||p.reject(i)),(null===(m=this.importDeferred)||void 0===m?void 0:m.isPending)&&(null===(g=this.importDeferred)||void 0===g||g.reject(i)),(null===(v=this.resizeDeferred)||void 0===v?void 0:v.isPending)&&(null===(y=this.resizeDeferred)||void 0===y||y.reject(i)),(null===(f=this.undoDeferred)||void 0===f?void 0:f.isPending)&&(null===(b=this.undoDeferred)||void 0===b||b.reject(i)),(null===(x=this.redoDeferred)||void 0===x?void 0:x.isPending)&&(null===(S=this.redoDeferred)||void 0===S||S.reject(i)),(null===(w=this.clearDeferred)||void 0===w?void 0:w.isPending)&&this.clearDeferred.reject(i),(null===(_=this.waitForIdleDeferred)||void 0===_?void 0:_.isPending)&&this.waitForIdleDeferred.reject(i)}closeCallback(r){let s="";if(!this.currentErrorCode)switch(r.code){case 1e3:break;case 1001:s=i.RecognizerError.GOING_AWAY;break;case 1002:s=i.RecognizerError.PROTOCOL_ERROR;break;case 1003:s=i.RecognizerError.UNSUPPORTED_DATA;break;case 1006:s=i.RecognizerError.ABNORMAL_CLOSURE;break;case 1007:s=i.RecognizerError.INVALID_FRAME_PAYLOAD;break;case 1008:s=i.RecognizerError.POLICY_VIOLATION;break;case 1009:s=i.RecognizerError.MESSAGE_TOO_BIG;break;case 1011:s=i.RecognizerError.INTERNAL_ERROR;break;case 1012:s=i.RecognizerError.SERVICE_RESTART;break;case 1013:s=i.RecognizerError.TRY_AGAIN;break;case 1014:s=i.RecognizerError.BAD_GATEWAY;break;case 1015:s=i.RecognizerError.TLS_HANDSHAKE;break;default:__classPrivateFieldGet(this,De,"f").warn("closeCallback","unknow CloseEvent.code",{evt:r}),s=i.RecognizerError.CANT_ESTABLISH}const n=new Error(s||r.reason);this.rejectDeferredPending(n),this.currentErrorCode||1e3===r.code||this.internalEvent.emitError(n)}manageAckMessage(i){var r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("manageAckMessage",{websocketMessage:i});const s=i;s.hmacChallenge&&this.send({type:"hmac",hmac:yield computeHmac(s.hmacChallenge,this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey)}),s.iinkSessionId&&(this.sessionId=s.iinkSessionId);const n=structuredClone(this.recognitionConfiguration);isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.3.0")||delete n.convert,this.send(Object.assign(Object.assign({},n),{type:"configuration"})),null===(r=this.ackDeferred)||void 0===r||r.resolve()}))}manageContentPackageDescriptionMessage(){var i;return __awaiter(this,void 0,void 0,(function*(){this.reconnectionCount=0,yield null===(i=this.ackDeferred)||void 0===i?void 0:i.promise,__classPrivateFieldGet(this,De,"f").info("manageContentPackageDescriptionMessage"),this.currentPartId?this.send({type:"openContentPart",id:this.currentPartId,mimeTypes:this.mimeTypes}):this.send({type:"newContentPart",contentType:this.recognitionConfiguration.type,mimeTypes:this.mimeTypes})}))}managePartChangeMessage(i){var r;__classPrivateFieldGet(this,De,"f").info("managePartChangeMessage",{websocketMessage:i});const s=i;this.currentPartId=s.partId,null===(r=this.initialized)||void 0===r||r.resolve()}manageExportMessage(i){var r,s,n,a,l,d,h,c,u;__classPrivateFieldGet(this,De,"f").info("manageExportMessage",{websocketMessage:i});const p=i;p.exports["application/vnd.myscript.jiix"]&&(p.exports["application/vnd.myscript.jiix"]=JSON.parse(p.exports["application/vnd.myscript.jiix"].toString())),null===(r=this.initialized)||void 0===r||r.resolve(),null===(s=this.addStrokeDeferred)||void 0===s||s.resolve(p.exports),null===(n=this.exportDeferred)||void 0===n||n.resolve(p.exports),null===(a=this.convertDeferred)||void 0===a||a.resolve(p.exports),null===(l=this.importDeferred)||void 0===l||l.resolve(p.exports),null===(d=this.undoDeferred)||void 0===d||d.resolve(p.exports),null===(h=this.redoDeferred)||void 0===h||h.resolve(p.exports),null===(c=this.clearDeferred)||void 0===c||c.resolve(p.exports),null===(u=this.importPointEventsDeferred)||void 0===u||u.resolve(p.exports),this.internalEvent.emitExported(p.exports)}manageWaitForIdle(){var i;return __awaiter(this,void 0,void 0,(function*(){this.internalEvent.emitIdle(!0),null===(i=this.waitForIdleDeferred)||void 0===i||i.resolve()}))}manageErrorMessage(r){var s,n;const a=r;this.currentErrorCode=(null===(s=a.data)||void 0===s?void 0:s.code)||a.code;let l=(null===(n=a.data)||void 0===n?void 0:n.message)||a.message||i.RecognizerError.UNKNOW;switch(this.currentErrorCode){case"no.activity":l=i.RecognizerError.NO_ACTIVITY;break;case"access.not.granted":l=i.RecognizerError.WRONG_CREDENTIALS;break;case"session.too.old":l=i.RecognizerError.TOO_OLD}const d=new Error(l);this.rejectDeferredPending(d),this.internalEvent.emitError(d)}manageContentChangeMessage(i){__classPrivateFieldGet(this,De,"f").info("manageContentChangeMessage",{websocketMessage:i});const r=i,s={canRedo:r.canRedo,canUndo:r.canUndo,empty:r.empty,stackIndex:r.undoStackIndex,possibleUndoCount:r.possibleUndoCount};this.internalEvent.emitContextChange(s)}manageSVGPatchMessage(i){var r;__classPrivateFieldGet(this,De,"f").info("manageSVGPatchMessage",{websocketMessage:i}),null===(r=this.resizeDeferred)||void 0===r||r.resolve();const s=i;this.internalEvent.emitSVGPatch(s)}messageCallback(i){var r;__classPrivateFieldGet(this,De,"f").debug("messageCallback",{message:i}),this.currentErrorCode=void 0;const s=JSON.parse(i.data);if("pong"!==s.type)switch(this.pingCount=0,s.type){case"ack":this.manageAckMessage(s);break;case"contentPackageDescription":this.manageContentPackageDescriptionMessage();break;case"partChanged":this.managePartChangeMessage(s);break;case"newPart":null===(r=this.initialized)||void 0===r||r.resolve();break;case"contentChanged":this.manageContentChangeMessage(s);break;case"exported":this.manageExportMessage(s);break;case"svgPatch":this.manageSVGPatchMessage(s);break;case"error":this.manageErrorMessage(s);break;case"idle":this.manageWaitForIdle();break;default:__classPrivateFieldGet(this,De,"f").warn("messageCallback",`Message type unknow: "${s.type}".`)}}init(r,s){var n,a;return __awaiter(this,void 0,void 0,(function*(){try{return __classPrivateFieldGet(this,De,"f").info("init",{height:r,width:s}),this.destroy(),this.connected=new DeferredPromise,this.initialized=new DeferredPromise,this.ackDeferred=new DeferredPromise,this.viewSizeHeight=r,this.viewSizeWidth=s,this.pingCount=0,this.socket=new WebSocket(this.url),this.serverConfiguration.websocket.pingEnabled&&this.infinitePing(),this.socket.addEventListener("open",this.openCallback.bind(this)),this.socket.addEventListener("close",this.closeCallback.bind(this)),this.socket.addEventListener("message",this.messageCallback.bind(this)),this.initialized.promise}catch(r){const s=new Error(i.RecognizerError.CANT_ESTABLISH);return this.internalEvent.emitError(s),null===(n=this.initialized)||void 0===n||n.reject(s),null===(a=this.initialized)||void 0===a?void 0:a.promise}}))}send(i){return __awaiter(this,void 0,void 0,(function*(){return this.connected?(yield this.connected.promise,this.socket.readyState===this.socket.OPEN?(__classPrivateFieldGet(this,De,"f").debug("send",{message:i}),this.socket.send(JSON.stringify(i)),Promise.resolve()):this.socket.readyState!=this.socket.CONNECTING&&this.serverConfiguration.websocket.autoReconnect?(this.reconnectionCount++,this.serverConfiguration.websocket.maxRetryCount>=this.reconnectionCount?(__classPrivateFieldGet(this,De,"f").debug("send",`try to reconnect number: ${this.reconnectionCount}.`),this.internalEvent.emitClearMessage(),yield this.init(this.viewSizeHeight,this.viewSizeWidth),yield this.setPenStyle(this.penStyle),yield this.setPenStyleClasses(this.penStyleClasses),yield this.setTheme(this.theme),this.send(i)):Promise.reject(new Error("Unable to send message. The maximum number of connection attempts has been reached."))):void 0):Promise.reject(new Error("Recognizer must be initilized"))}))}addStrokes(i){var r,s;return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,De,"f").info("addStrokes",{strokes:i}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.addStrokeDeferred=new DeferredPromise,0===i.length?this.addStrokeDeferred.resolve({}):yield this.send({type:"addStrokes",strokes:i.map((i=>i.formatToSend()))}),null===(s=this.addStrokeDeferred)||void 0===s?void 0:s.promise}))}setPenStyle(i){var r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("setPenStyle",{penStyle:i}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.penStyle=i;const s={type:"setPenStyle",style:me.penStyleToCSS(i)};return this.send(s)}))}setPenStyleClasses(i){var r;return __awaiter(this,void 0,void 0,(function*(){yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.penStyleClasses=i,__classPrivateFieldGet(this,De,"f").info("setPenStyleClasses",{penStyleClasses:i});const s={type:"setPenStyleClasses",styleClasses:i};return this.send(s)}))}setTheme(i){var r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("setTheme",{theme:i}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.theme=i;const s={type:"setTheme",theme:me.themeToCSS(i)};return this.send(s)}))}export(i,r){var s,n;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("export",{model:i,requestedMimeTypes:r}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.exportDeferred=new DeferredPromise;const a=i.clone();let l=r||[];if(!l.length)switch(this.recognitionConfiguration.type){case"DIAGRAM":l=this.recognitionConfiguration.diagram.mimeTypes;break;case"MATH":l=this.recognitionConfiguration.math.mimeTypes;break;case"Raw Content":l=["application/vnd.myscript.jiix"];break;case"TEXT":l=this.recognitionConfiguration.text.mimeTypes;break;default:throw new Error(`Recognition type "${this.recognitionConfiguration.type}" is unknown.\n Possible types are:\n -DIAGRAM\n -MATH\n -Raw Content\n -TEXT`)}if(!l.length)return Promise.reject(new Error(`Export failed, no mimeTypes define in recognition ${this.recognitionConfiguration.type} configuration`));const d={type:"export",partId:this.currentPartId,mimeTypes:l};yield this.send(d);const h=yield null===(n=this.exportDeferred)||void 0===n?void 0:n.promise;return a.updatePositionReceived(),a.mergeExport(h),__classPrivateFieldGet(this,De,"f").debug("export",{model:a}),a}))}import(i,r,s){var n,a;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("import",{data:r,mimeType:s}),yield null===(n=this.initialized)||void 0===n?void 0:n.promise;const l=i.clone(),d=this.serverConfiguration.websocket.fileChunkSize,h=Math.random().toString(10).substring(2,6);this.importDeferred=new DeferredPromise;const readBlob=i=>{const r=new FileReader;return new Promise(((s,n)=>{r.onloadend=i=>{var r;return s(null===(r=i.target)||void 0===r?void 0:r.result)},r.onerror=()=>n(),r.readAsText(i)}))},c={type:"importFile",importFileId:h,mimeType:s};yield this.send(c);for(let i=0;i<r.size;i+=d){const s=r.slice(i,i+d,r.type),n={type:"fileChunk",importFileId:h,data:yield readBlob(s),lastChunk:i+d>r.size};yield this.send(n)}const u=yield null===(a=this.importDeferred)||void 0===a?void 0:a.promise;return this.importDeferred=void 0,l.mergeExport(u),l}))}resize(i){var r,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("resize",{model:i}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.resizeDeferred=new DeferredPromise;const n=i.clone();this.viewSizeHeight=n.height,this.viewSizeWidth=n.width;const a={type:"changeViewSize",height:this.viewSizeHeight,width:this.viewSizeWidth};return yield this.send(a),yield null===(s=this.resizeDeferred)||void 0===s?void 0:s.promise,n}))}importPointEvents(i){var r,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("importPointsEvents",{strokes:i}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.importPointEventsDeferred=new DeferredPromise;const n={type:"pointerEvents",events:i.map((i=>i.formatToSend()))};this.send(n);const a=yield null===(s=this.importPointEventsDeferred)||void 0===s?void 0:s.promise;return this.importPointEventsDeferred=void 0,__classPrivateFieldGet(this,De,"f").debug("importPointEvents",{exportPoints:a}),a}))}convert(i,r){var s,n;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("convert",{model:i,conversionState:r}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.convertDeferred=new DeferredPromise;const a=i.clone(),l={type:"convert",conversionState:r};yield this.send(l);const d=yield null===(n=this.convertDeferred)||void 0===n?void 0:n.promise;return a.updatePositionReceived(),a.mergeConvert(d),__classPrivateFieldGet(this,De,"f").debug("convert",{model:a}),a}))}waitForIdle(){var i,r;return __awaiter(this,void 0,void 0,(function*(){yield null===(i=this.initialized)||void 0===i?void 0:i.promise,this.waitForIdleDeferred=new DeferredPromise;return yield this.send({type:"waitForIdle"}),null===(r=this.waitForIdleDeferred)||void 0===r?void 0:r.promise}))}undo(i){var r,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("undo",{model:i}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise;const n=i.clone();this.undoDeferred=new DeferredPromise;yield this.send({type:"undo"});const a=yield null===(s=this.undoDeferred)||void 0===s?void 0:s.promise;return n.updatePositionReceived(),n.mergeExport(a),__classPrivateFieldGet(this,De,"f").debug("undo",{model:n}),this.undoDeferred=void 0,n}))}redo(i){var r,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("redo",{model:i}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise;const n=i.clone();this.redoDeferred=new DeferredPromise;yield this.send({type:"redo"});const a=yield null===(s=this.redoDeferred)||void 0===s?void 0:s.promise;return n.updatePositionReceived(),n.mergeExport(a),__classPrivateFieldGet(this,De,"f").debug("redo",{model:a}),this.redoDeferred=void 0,n}))}clear(i){var r,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,De,"f").info("clear",{model:i}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise;const n=i.clone();n.modificationDate=Date.now(),this.clearDeferred=new DeferredPromise;yield this.send({type:"clear"});const a=yield null===(s=this.clearDeferred)||void 0===s?void 0:s.promise;return n.updatePositionReceived(),n.mergeExport(a),this.clearDeferred=void 0,__classPrivateFieldGet(this,De,"f").info("clear",{model:n}),n}))}close(i,r){this.socket.readyState!==this.socket.OPEN&&this.socket.readyState!==this.socket.CONNECTING||(__classPrivateFieldGet(this,De,"f").info("close",{code:i,reason:r}),this.socket.removeEventListener("close",this.closeCallback),this.socket.removeEventListener("message",this.messageCallback),this.socket.removeEventListener("open",this.openCallback),this.socket.close(i,r))}destroy(){__classPrivateFieldGet(this,De,"f").info("destroy"),this.connected=void 0,this.initialized=void 0,this.ackDeferred=void 0,this.addStrokeDeferred=void 0,this.exportDeferred=void 0,this.convertDeferred=void 0,this.importDeferred=void 0,this.resizeDeferred=void 0,this.undoDeferred=void 0,this.redoDeferred=void 0,this.clearDeferred=void 0,this.socket&&(this.socket.removeEventListener("close",this.closeCallback),this.socket.removeEventListener("message",this.messageCallback),this.socket.removeEventListener("open",this.openCallback),this.close(1e3,"Recognizer destroyed"))}}De=new WeakMap;class CanvasRendererShape{constructor(){Re.set(this,LoggerManager.getLogger(i.LoggerClass.RENDERER)),this.symbols={table:"table",ellipse:"ellipse",line:"line"}}phi(i){let r=(i+Math.PI)%(2*Math.PI)-Math.PI;return r<-Math.PI&&(r+=2*Math.PI),__classPrivateFieldGet(this,Re,"f").debug("phi",{angle:i,returnedAngle:r}),r}drawEllipseArc(i,r){__classPrivateFieldGet(this,Re,"f").debug("drawEllipseArc",{context2D:i,shapeEllipse:r});const{centerPoint:s,maxRadius:n,minRadius:a,orientation:l,startAngle:d,sweepAngle:h}=r,c=Math.cos(l)*n,u=Math.cos(l)*a,p=Math.sin(l)*n,m=Math.sin(l)*a,g=Math.floor(Math.abs(h)/.02),v=[];i.save();try{i.beginPath();for(let r=0;r<=g;r++){const l=d+r/g*h,y=Math.atan2(Math.sin(l)/a,Math.cos(l)/n),f=Math.cos(y),b=Math.sin(y),x=s.x+c*f-m*b,S=s.y+u*b+p*f;0===r?i.moveTo(x,S):i.lineTo(x,S),0!==r&&r!==g||v.push({x:x,y:S})}i.stroke()}catch(i){__classPrivateFieldGet(this,Re,"f").error("drawEllipseArc",{error:i})}finally{i.restore()}return v}drawLine(i,r,s){__classPrivateFieldGet(this,Re,"f").debug("drawLine",{context2D:i,p1:r,p2:s}),i.save();try{i.beginPath(),i.moveTo(r.x,r.y),i.lineTo(s.x,s.y),i.stroke()}catch(i){__classPrivateFieldGet(this,Re,"f").error("drawLine",{error:i})}finally{i.restore()}}drawArrowHead(i,r,s,n){__classPrivateFieldGet(this,Re,"f").debug("drawArrowHead",{context2D:i,headPoint:r,angle:s,length:n});const a=this.phi(s+Math.PI*(7/8)),l=this.phi(s-Math.PI*(7/8));i.save();try{i.fillStyle=i.strokeStyle,i.moveTo(r.x,r.y),i.beginPath(),i.lineTo(r.x+n*Math.cos(a),r.y+n*Math.sin(a)),i.lineTo(r.x+n*Math.cos(l),r.y+n*Math.sin(l)),i.lineTo(r.x,r.y),i.fill()}catch(i){__classPrivateFieldGet(this,Re,"f").error("drawArrowHead",{error:i})}finally{i.restore()}}drawShapeEllipse(i,r){__classPrivateFieldGet(this,Re,"f").debug("drawShapeEllipse",{context2D:i,shapeEllipse:r});const s=this.drawEllipseArc(i,r);"ARROW_HEAD"===(null==r?void 0:r.beginDecoration)&&this.drawArrowHead(i,s[0],r.beginTangentAngle,12),"ARROW_HEAD"===(null==r?void 0:r.endDecoration)&&this.drawArrowHead(i,s[1],r.endTangentAngle,12)}drawShapeLine(i,r){__classPrivateFieldGet(this,Re,"f").debug("drawShapeLine",{context2D:i,shapeLine:r}),this.drawLine(i,r.firstPoint,r.lastPoint),"ARROW_HEAD"===r.beginDecoration&&this.drawArrowHead(i,r.firstPoint,r.beginTangentAngle,12),"ARROW_HEAD"===r.endDecoration&&this.drawArrowHead(i,r.lastPoint,r.endTangentAngle,12)}draw(i,r){switch(__classPrivateFieldGet(this,Re,"f").info("draw",{context2D:i,symbol:r}),i.save(),i.lineWidth=r.style.width,i.strokeStyle=r.style.color,r.type){case this.symbols.table:r.lines.forEach((r=>this.drawLine(i,r.p1,r.p2)));break;case this.symbols.ellipse:this.drawShapeEllipse(i,r);break;case this.symbols.line:this.drawShapeLine(i,r);break;default:__classPrivateFieldGet(this,Re,"f").warn("draw",`${r.type} not implemented`)}}}Re=new WeakMap;class CanvasRendererStroke{constructor(){Ae.set(this,LoggerManager.getLogger(i.LoggerClass.RENDERER))}renderArc(i,r,s){__classPrivateFieldGet(this,Ae,"f").debug("renderArc",{context2d:i,center:r,radius:s}),i.arc(r.x,r.y,s,0,2*Math.PI,!0)}renderLine(i,r,s,n){__classPrivateFieldGet(this,Ae,"f").debug("renderLine",{context2d:i,begin:r,end:s,width:n});const a=computeLinksPointers(r,computeAngleAxeRadian(r,s),n),l=computeLinksPointers(s,computeAngleAxeRadian(r,s),n);i.moveTo(a[0].x,a[0].y),i.lineTo(l[0].x,l[0].y),i.lineTo(l[1].x,l[1].y),i.lineTo(a[1].x,a[1].y)}renderFinal(i,r,s,n){__classPrivateFieldGet(this,Ae,"f").debug("renderFinal",{context2d:i,begin:r,end:s,width:n});const a=computeAngleAxeRadian(r,s),l=computeLinksPointers(s,a,n);i.moveTo(l[0].x,l[0].y);for(let r=1;r<=6;r++){const l=a-r*Math.PI/6;i.lineTo(s.x-s.p*n*Math.sin(l),s.y+s.p*n*Math.cos(l))}}renderQuadratic(i,r,s,n,a){__classPrivateFieldGet(this,Ae,"f").debug("renderQuadratic",{context2d:i,begin:r,end:s,ctrl:n,width:a});const l=computeLinksPointers(r,computeAngleAxeRadian(r,n),a),d=computeLinksPointers(s,computeAngleAxeRadian(n,s),a),h=computeLinksPointers(n,computeAngleAxeRadian(r,s),a);i.moveTo(l[0].x,l[0].y),i.quadraticCurveTo(h[0].x,h[0].y,d[0].x,d[0].y),i.lineTo(d[1].x,d[1].y),i.quadraticCurveTo(h[1].x,h[1].y,l[1].x,l[1].y)}draw(i,r){__classPrivateFieldGet(this,Ae,"f").info("draw",{context2d:i,stroke:r});const s=r.pointers.length,n=s-2,a=r.style.width>0?r.style.width:i.lineWidth,l=r.style.color?r.style.color:i.strokeStyle,d=r.pointers[0];i.save();try{if(i.beginPath(),s<3)this.renderArc(i,d,.6*a);else{this.renderArc(i,d,a*d.p);const l=computeMiddlePointer(d,r.pointers[1]);this.renderLine(i,d,l,a);for(let s=0;s<n;s++){const n=computeMiddlePointer(r.pointers[s],r.pointers[s+1]),l=computeMiddlePointer(r.pointers[s+1],r.pointers[s+2]),d=r.pointers[s+1];this.renderQuadratic(i,n,l,d,a)}const h=computeMiddlePointer(r.pointers[s-2],r.pointers[s-1]),c=r.pointers[s-1];this.renderLine(i,h,c,a);const u=r.pointers[s-2],p=r.pointers[s-1];this.renderFinal(i,u,p,a)}i.closePath(),void 0!==l&&(i.fillStyle=l,i.fill()),i.save()}catch(i){__classPrivateFieldGet(this,Ae,"f").error("draw",{error:i})}finally{i.restore()}}}Ae=new WeakMap;class CanvasRendererText{constructor(){Be.set(this,LoggerManager.getLogger(i.LoggerClass.RENDERER)),this.symbols={char:"char",string:"string",textLine:"textLine"}}drawUnderline(i,r,s){__classPrivateFieldGet(this,Be,"f").debug("#drawUnderline",{context2D:i,textUnderline:r,underline:s}),i.save();try{const n=r.data.width/r.label.length,a={x:r.data.topLeftPoint.x+s.data.firstCharacter*n,y:r.data.topLeftPoint.y+r.data.height},l={x:r.data.topLeftPoint.x+s.data.lastCharacter*n,y:r.data.topLeftPoint.y+r.data.height};i.beginPath(),i.moveTo(a.x,a.y),i.lineTo(l.x,l.y),i.stroke()}catch(i){__classPrivateFieldGet(this,Be,"f").error("#drawUnderline",{error:i})}finally{i.restore()}}drawText(i,r){__classPrivateFieldGet(this,Be,"f").debug("#drawText",{context2D:i,text:r}),i.save();try{i.font=`${r.data.textHeight}px serif`,i.textAlign="CENTER"===r.data.justificationType?"center":"left",i.textBaseline="bottom",i.fillStyle=i.strokeStyle,i.fillText(r.label,r.data.topLeftPoint.x,r.data.topLeftPoint.y+r.data.height)}catch(i){__classPrivateFieldGet(this,Be,"f").error("#drawText",{error:i})}finally{i.restore()}}drawTextLine(i,r){__classPrivateFieldGet(this,Be,"f").debug("#drawTextLine",{context2D:i,textUnderline:r}),this.drawText(i,r),r.underlineList.forEach((s=>{this.drawUnderline(i,r,s)}))}draw(i,r){switch(__classPrivateFieldGet(this,Be,"f").info("draw",{context2D:i,symbol:r}),i.lineWidth=r.style.width,i.strokeStyle=r.style.color,r.type){case this.symbols.char:case this.symbols.string:this.drawText(i,r);break;case this.symbols.textLine:this.drawTextLine(i,r);break;default:__classPrivateFieldGet(this,Be,"f").warn("draw",`${r.type} not implemented`)}}}Be=new WeakMap;class CanvasRenderer{constructor(r){$e.set(this,LoggerManager.getLogger(i.LoggerClass.RENDERER)),__classPrivateFieldGet(this,$e,"f").info("constructor",{config:r}),this.configuration=r,this.strokeRenderer=new CanvasRendererStroke,this.shapeRenderer=new CanvasRendererShape,this.textRenderer=new CanvasRendererText}createCanvas(i){__classPrivateFieldGet(this,$e,"f").debug("createCanvas",{type:i});const r=document.createElement("canvas");return r.id=i,r.classList.add(i),r.classList.add("ms-canvas"),r}resizeContent(){const i=window.devicePixelRatio;[this.context.renderingCanvas,this.context.capturingCanvas].forEach((r=>{var s;const n=r.parentNode,a=Math.max(this.configuration.minWidth,n.clientWidth),l=Math.max(this.configuration.minHeight,n.clientHeight);r.width=a*i,r.height=l*i,null===(s=r.getContext("2d"))||void 0===s||s.scale(i,i),r.style.width=`${a}px`,r.style.height=`${l}px`}))}drawSymbol(i,r){if(__classPrivateFieldGet(this,$e,"f").debug("drawSymbol",{symbol:r}),"stroke"===r.type){const s=r;"eraser"!==s.pointerType&&this.strokeRenderer.draw(i,s)}else Object.keys(this.textRenderer.symbols).includes(r.type)?this.textRenderer.draw(i,r):Object.keys(this.shapeRenderer.symbols).includes(r.type)?this.shapeRenderer.draw(i,r):__classPrivateFieldGet(this,$e,"f").warn("drawSymbol",`symbol type unknow: ${r.type}`)}init(i){__classPrivateFieldGet(this,$e,"f").info("init",{element:i});const r=this.createCanvas("ms-rendering-canvas");i.appendChild(r);const s=this.createCanvas("ms-capture-canvas");i.appendChild(s),this.context={parent:i,renderingCanvas:r,renderingCanvasContext:r.getContext("2d"),capturingCanvas:s,capturingCanvasContext:s.getContext("2d")},this.resizeContent()}drawModel(i){var r;__classPrivateFieldGet(this,$e,"f").info("drawModel",{model:i}),null===(r=this.context.renderingCanvasContext)||void 0===r||r.clearRect(0,0,this.context.renderingCanvas.width,this.context.renderingCanvas.height),i.symbols.forEach((i=>this.drawSymbol(this.context.renderingCanvasContext,i))),this.context.capturingCanvasContext.clearRect(0,0,this.context.capturingCanvas.width,this.context.capturingCanvas.height)}drawPendingStroke(i){__classPrivateFieldGet(this,$e,"f").info("drawPendingStroke",{stroke:i}),this.context.capturingCanvasContext.clearRect(0,0,this.context.capturingCanvas.width,this.context.capturingCanvas.height),i&&"eraser"!==(null==i?void 0:i.pointerType)&&this.strokeRenderer.draw(this.context.capturingCanvasContext,i)}resize(i){__classPrivateFieldGet(this,$e,"f").info("resize",{model:i}),this.resizeContent(),this.drawModel(i)}destroy(){__classPrivateFieldGet(this,$e,"f").info("destroy"),this.context.parent&&(this.context.parent.innerHTML="")}}$e=new WeakMap;const ze={arrowHeadStartMarker:"arrow-head-start",arrowHeadEndMaker:"arrow-head-end",selectionFilterId:"selection-filter",removalFilterId:"removal-filter",crossMarker:"cross-marker",noSelection:"pointer-events: none; -webkit-touch-callout: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;"},je="http://www.w3.org/2000/svg";class SVGBuilder{static createLayer(i,r={}){const s=document.createElementNS(je,"svg");return s.setAttribute("width",`${i.width}px`),s.setAttribute("height",`${i.height}px`),s.setAttribute("viewBox",`${i.x}, ${i.y}, ${i.width}, ${i.height}`),Object.keys(r).forEach((i=>{s.setAttribute(i,r[i])})),s}static createFilter(i,r={}){const s=document.createElementNS(je,"filter");return s.id=i,Object.keys(r).forEach((i=>{s.setAttribute(i,r[i])})),s}static createDefs(){return document.createElementNS(je,"defs")}static createMarker(i,r={}){const s=document.createElementNS(je,"marker");return s.setAttribute("id",i),Object.keys(r).forEach((i=>{s.setAttribute(i,r[i])})),s}static createComponentTransfert(){return document.createElementNS(je,"feComponentTransfer")}static createDropShadow({dx:i=0,dy:r=0,deviation:s=0,color:n="#3e68ff",opacity:a=1}){const l=document.createElementNS(je,"feDropShadow");return l.setAttribute("dx",i.toString()),l.setAttribute("dy",r.toString()),l.setAttribute("stdDeviation",s.toString()),l.setAttribute("flood-color",n),l.setAttribute("flood-opacity",a.toString()),l}static createTransfertFunctionTable(i,r){const s=document.createElementNS(je,i);return s.setAttribute("type","table"),s.setAttribute("tableValues",r),s}static createGroup(i={}){const r=document.createElementNS(je,"g");return Object.keys(i).forEach((s=>{r.setAttribute(s,i[s])})),r}static createLine(i,r,s={}){const n=document.createElementNS(je,"line");return n.setAttribute("x1",i.x.toString()),n.setAttribute("y1",i.y.toString()),n.setAttribute("x2",r.x.toString()),n.setAttribute("y2",r.y.toString()),Object.keys(s).forEach((i=>{n.setAttribute(i,s[i])})),n}static createCircle(i,r,s={}){const n=document.createElementNS(je,"circle");return n.setAttribute("cx",i.x.toString()),n.setAttribute("cy",i.y.toString()),n.setAttribute("r",r.toString()),Object.keys(s).forEach((i=>{n.setAttribute(i,s[i])})),n}static createPath(i={}){const r=document.createElementNS(je,"path");return Object.keys(i).forEach((s=>{r.setAttribute(s,i[s])})),r}static createPolygon(i,r={}){const s=document.createElementNS(je,"polygon");return s.setAttribute("points",i.join(",")),Object.keys(r).forEach((i=>{s.setAttribute(i,r[i])})),s}static createRect(i,r={}){const s=document.createElementNS(je,"rect");return s.setAttribute("x",i.x.toString()),s.setAttribute("y",i.y.toString()),s.setAttribute("width",i.width.toString()),s.setAttribute("height",i.height.toString()),Object.keys(r).forEach((i=>{s.setAttribute(i,r[i])})),s}static createTSpan(i,r={}){const s=document.createElementNS(je,"tspan");return s.textContent=i,Object.keys(r).forEach((i=>{s.setAttribute(i,r[i])})),s}static createForeignObject(i,r,s={}){const n=document.createElementNS(je,"foreignObject");return n.setAttribute("x",i.x.toString()),n.setAttribute("y",i.y.toString()),n.setAttribute("width",i.width.toString()),n.setAttribute("height",i.height.toString()),Object.keys(s).forEach((i=>{n.setAttribute(i,s[i])})),n.appendChild(r),n}static createText(i,r,s={}){const n=document.createElementNS(je,"text");return n.textContent=r,n.setAttribute("x",i.x.toString()),n.setAttribute("y",i.y.toString()),Object.keys(s).forEach((i=>{n.setAttribute(i,s[i])})),n}}class OISVGRendererEdgeUtil{static getLinePath(i){return`M ${i.start.x} ${i.start.y} L ${i.end.x} ${i.end.y}`}static getPolyLinePath(i){return`M ${i.vertices[0].x} ${i.vertices[0].y} ${i.vertices.map((i=>`L ${i.x} ${i.y}`)).join(" ")}`}static getArcPath(i){return`M ${i.vertices[0].x} ${i.vertices[0].y} Q ${i.vertices.map((i=>`${i.x} ${i.y}`)).join(" ")}`}static getSVGPath(r){switch(r.kind){case i.EdgeKind.Line:return OISVGRendererEdgeUtil.getLinePath(r);case i.EdgeKind.PolyEdge:return OISVGRendererEdgeUtil.getPolyLinePath(r);case i.EdgeKind.Arc:return OISVGRendererEdgeUtil.getArcPath(r);default:throw new Error(`Can't getSVGPath for edge cause kind is unknow: "${JSON.stringify(r)}"`)}}static getSVGElement(r){const s={id:r.id,type:r.type,kind:r.kind,"vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round"};r.selected&&(s.filter=`url(#${ze.selectionFilterId})`),r.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const n=SVGBuilder.createGroup(s),a={fill:"transparent",stroke:r.style.color||le.color,"stroke-width":(r.style.width||le.width).toString(),opacity:(r.style.opacity||le.opacity).toString(),d:OISVGRendererEdgeUtil.getSVGPath(r)};return r.startDecoration===i.EdgeDecoration.Arrow&&(a["marker-start"]=`url(#${ze.arrowHeadStartMarker})`),r.endDecoration===i.EdgeDecoration.Arrow&&(a["marker-end"]=`url(#${ze.arrowHeadEndMaker})`),n.appendChild(SVGBuilder.createPath(a)),n}}class OISVGRendererEraserUtil{static getSVGPath(i){if(i.pointers.length<1)return"";const r=i.pointers.at(0);if(1===i.pointers.length){const s=i.style.width||4;return`C ${r.x-s/2} ${r.y} Q ${r.x+s/2} ${r.y}`}const s=i.pointers.slice(1);return`${`M ${r.x} ${r.y}`} ${s.reduce(((i,r)=>`${i} ${r.x} ${r.y}`),"Q")}`}static getSVGElement(i){const r={id:i.id,type:"eraser","stroke-width":"12",stroke:"grey",opacity:"0.2",shadowBlur:"5","stroke-linecap":"round",fill:"transparent",d:OISVGRendererEraserUtil.getSVGPath(i)};return SVGBuilder.createPath(r)}}class OISVGRendererDecoratorUtil{static getSVGElement(r,{deleting:s,style:n,bounds:a}){const l={id:r.id,type:"decorator",kind:r.kind,"vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round"};let d;switch(l.opacity=(r.style.opacity||le.opacity).toString(),s&&(l.opacity=(.5*(r.style.opacity||le.opacity)).toString()),r.kind){case i.DecoratorKind.Highlight:{l.opacity=s?"0.25":"0.5",l.stroke="transparent",l.fill=r.style.color||le.color;const i={x:a.x-+(n.width||le.width),y:a.y-+(n.width||le.width),height:a.height+2*+(n.width||le.width),width:a.width+2*+(n.width||le.width)};d=SVGBuilder.createRect(i,l);break}case i.DecoratorKind.Surround:{l.fill="transparent",l.stroke=r.style.color||le.color,l["stroke-width"]=(r.style.width||le.width).toString();const i={x:a.x-+(n.width||le.width),y:a.y-+(n.width||le.width),height:a.height+2*+(n.width||le.width),width:a.width+2*+(n.width||le.width)};d=SVGBuilder.createRect(i,l);break}case i.DecoratorKind.Strikethrough:{l.fill="transparent",l.stroke=r.style.color||le.color,l["stroke-width"]=(r.style.width||le.width).toString();const i={x:a.xMin,y:a.yMid},s={x:a.xMax,y:a.yMid};d=SVGBuilder.createLine(i,s,l);break}case i.DecoratorKind.Underline:{l.fill="transparent",l.stroke=r.style.color||le.color,l["stroke-width"]=(r.style.width||le.width).toString();const i={x:a.xMin,y:a.yMax+ +(n.width||le.width)},s={x:a.xMax,y:a.yMax+ +(n.width||le.width)};d=SVGBuilder.createLine(i,s,l);break}}return d}}class OISVGRendererShapeUtil{static getPolygonePath(i){return`M ${i.points[0].x} ${i.points[0].y} ${i.points.slice(1).map((i=>`L ${i.x} ${i.y}`)).join(" ")} Z`}static getCirclePath(i){return`M ${i.center.x-i.radius} ${i.center.y} a ${i.radius} ${i.radius} 0 1 1 ${2*i.radius} 0 a ${i.radius} ${i.radius} 0 1 1 -${2*i.radius} 0 Z`}static getEllipsePath(i){return`M ${i.center.x-i.radiusX} ${i.center.y} a ${i.radiusX} ${i.radiusY} 0 1 1 ${2*i.radiusX} 0 a ${i.radiusX} ${i.radiusY} 0 1 1 -${2*i.radiusX} 0 Z`}static getSVGPath(r){switch(r.kind){case i.ShapeKind.Polygon:return OISVGRendererShapeUtil.getPolygonePath(r);case i.ShapeKind.Circle:return OISVGRendererShapeUtil.getCirclePath(r);case i.ShapeKind.Ellipse:return OISVGRendererShapeUtil.getEllipsePath(r);default:throw new Error(`Can't getSVGPath for shape cause kind is unknow: "${JSON.stringify(r)}"`)}}static getSVGElement(r){const s={id:r.id,type:r.type,kind:r.kind,"vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round"};r.selected&&(s.filter=`url(#${ze.selectionFilterId})`),r.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const n=SVGBuilder.createGroup(s),a={fill:r.style.fill||"transparent",stroke:r.style.color||le.color,"stroke-width":(r.style.width||le.width).toString(),opacity:(r.style.opacity||le.opacity).toString(),d:OISVGRendererShapeUtil.getSVGPath(r)};return r.kind===i.ShapeKind.Ellipse&&(a.transform=`rotate(${convertRadianToDegree(r.orientation)}, ${r.center.x}, ${r.center.y})`),n.appendChild(SVGBuilder.createPath(a)),n}}class OISVGRendererStrokeUtil{static getArcPath(i,r){return[`M ${i.x} ${i.y}`,`m ${-r} 0`,`a ${r} ${r} 0 1 0 ${2*r} 0`,`a ${r} ${r} 0 1 0 ${-2*r} 0`].join(" ")}static getLinePath(i,r,s){const n=computeLinksPointers(i,computeAngleAxeRadian(i,r),s),a=computeLinksPointers(r,computeAngleAxeRadian(i,r),s);return[`M ${n[0].x} ${n[0].y}`,`L ${a[0].x} ${a[0].y}`,`L ${a[1].x} ${a[1].y}`,`L ${n[1].x} ${n[1].y}`].join(" ")}static getFinalPath(i,r,s){const n=computeAngleAxeRadian(i,r),a=computeLinksPointers(r,n,s),l=[`M ${a[0].x} ${a[0].y}`];for(let i=1;i<=6;i++){const a=n-i*(Math.PI/6),d=+(r.x-r.p*s*Math.sin(a)).toFixed(3),h=+(r.y+r.p*s*Math.cos(a)).toFixed(3);l.push(`L ${d} ${h}`)}return l.join(" ")}static getQuadraticPath(i,r,s,n){const a=computeLinksPointers(i,computeAngleAxeRadian(i,s),n),l=computeLinksPointers(r,computeAngleAxeRadian(s,r),n),d=computeLinksPointers(s,computeAngleAxeRadian(i,r),n);return[`M ${a[0].x} ${a[0].y}`,`Q ${d[0].x} ${d[0].y} ${l[0].x} ${l[0].y}`,`L ${l[1].x} ${l[1].y}`,`Q ${d[1].x} ${d[1].y} ${a[1].x} ${a[1].y}`].join(" ")}static getSVGPath(i){const r=i.pointers.length;if(!r)return"";const s=i.style.width,n=r-2,a=i.pointers[0],l=[];if(r<3)l.push(this.getArcPath(a,.6*s));else{l.push(this.getArcPath(a,s*a.p)),l.push(this.getLinePath(a,computeMiddlePointer(a,i.pointers[1]),s));for(let r=0;r<n;r++){const n=computeMiddlePointer(i.pointers[r],i.pointers[r+1]),a=computeMiddlePointer(i.pointers[r+1],i.pointers[r+2]),d=i.pointers[r+1];l.push(this.getQuadraticPath(n,a,d,s))}const d=i.pointers[r-2],h=i.pointers[r-1];l.push(this.getLinePath(computeMiddlePointer(d,h),h,s)),l.push(this.getFinalPath(d,h,s))}return l.join(" ")}static getSVGElement(r){const s={id:r.id,type:"stroke","vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round"};r.selected&&(s.filter=`url(#${ze.selectionFilterId})`),r.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const n=SVGBuilder.createGroup(s),a={fill:r.style.color||le.color,"stroke-width":(r.style.width||le.width).toString(),opacity:(r.style.opacity||le.opacity).toString(),d:OISVGRendererStrokeUtil.getSVGPath(r)};return n.append(SVGBuilder.createPath(a)),r.decorators.forEach((s=>{const a=OISVGRendererDecoratorUtil.getSVGElement(s,r);a&&(s.kind===i.DecoratorKind.Highlight?n.prepend(a):n.append(a))})),n}}class OISVGRendererTextUtil{static getSVGElement(r){const s={id:r.id,type:r.type,"vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round",style:ze.noSelection,opacity:(r.style.opacity||le.opacity).toString()};r.rotation&&(s.transform=`rotate(${r.rotation.degree}, ${r.rotation.center.x}, ${r.rotation.center.y})`),r.selected&&(s.filter=`url(#${ze.selectionFilterId})`),r.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const n=SVGBuilder.createGroup(s),a=SVGBuilder.createText(r.point,"");return r.chars.forEach((i=>{const r={id:i.id,fill:i.color,"font-size":`${i.fontSize}px`,"font-weight":i.fontWeight.toString()};a.appendChild(SVGBuilder.createTSpan(i.label,r))})),n.append(a),r.decorators.forEach((s=>{const a=OISVGRendererDecoratorUtil.getSVGElement(s,r);a&&(s.kind===i.DecoratorKind.Highlight?n.prepend(a):n.append(a))})),n}}class OISVGRendererGroupUtil{static getChildElement(r){let s;switch(r.type){case i.SymbolType.Stroke:s=OISVGRendererStrokeUtil.getSVGElement(r);break;case i.SymbolType.Shape:s=OISVGRendererShapeUtil.getSVGElement(r);break;case i.SymbolType.Edge:s=OISVGRendererEdgeUtil.getSVGElement(r);break;case i.SymbolType.Text:s=OISVGRendererTextUtil.getSVGElement(r);break;case i.SymbolType.Group:s=OISVGRendererGroupUtil.getSVGElement(r)}return s}static getSVGElement(r){const s={id:r.id,type:"group","vector-effect":"non-scaling-stroke","stroke-linecap":"round","stroke-linejoin":"round",fill:r.style.color||le.color,"stroke-width":(r.style.width||le.width).toString(),opacity:(r.style.opacity||le.opacity).toString()};r.selected&&(s.filter=`url(#${ze.selectionFilterId})`),r.deleting&&(s.filter=`url(#${ze.removalFilterId})`);const n=SVGBuilder.createGroup(s);return r.children.forEach((i=>{n.append(OISVGRendererGroupUtil.getChildElement(i))})),r.decorators.forEach((s=>{const a=OISVGRendererDecoratorUtil.getSVGElement(s,r);a&&(s.kind===i.DecoratorKind.Highlight?n.prepend(a):n.append(a))})),n}}var Ve,We,He,Ue,Xe,Ke,Ye,Je,qe,Ze,Qe,et,tt,it,rt,st,nt,ot,at,lt,dt,ht,ct;class OISVGRenderer{constructor(r){Ve.set(this,LoggerManager.getLogger(i.LoggerClass.RENDERER)),this.groupGuidesId="guides-wrapper",this.verticalGuides=[],this.horizontalGuides=[],__classPrivateFieldGet(this,Ve,"f").info("constructor",{configuration:r}),this.configuration=r}initLayer(){const i=Math.max(this.configuration.minWidth,this.parent.clientWidth),r=Math.max(this.configuration.minHeight,this.parent.clientHeight);this.layer=SVGBuilder.createLayer({x:0,y:0,width:i,height:r}),this.layer.style.setProperty("height","auto"),this.layer.style.setProperty("width","auto"),this.layer.appendChild(this.createSVGTools()),this.parent.style.setProperty("overflow","auto"),this.parent.appendChild(this.layer)}createDefs(){const i=SVGBuilder.createDefs(),r=4,s=2.5,n={style:ze.noSelection,fill:"context-stroke",markerWidth:5..toString(),markerHeight:5..toString(),refX:r.toString(),refY:s.toString()},a=SVGBuilder.createMarker(ze.arrowHeadStartMarker,Object.assign(Object.assign({},n),{orient:"auto-start-reverse"}));a.appendChild(SVGBuilder.createPolygon([0,0,5,s,0,5],n)),i.appendChild(a);const l=SVGBuilder.createMarker(ze.arrowHeadEndMaker,Object.assign(Object.assign({},n),{orient:"auto"}));l.appendChild(SVGBuilder.createPolygon([0,0,5,s,0,5],n)),i.appendChild(l);const d={style:ze.noSelection,markerWidth:"5",markerHeight:"5",refX:"0",refY:"0",viewBox:"-5 -5 10 10"},h=SVGBuilder.createMarker(ze.crossMarker,d);return h.appendChild(SVGBuilder.createPath({d:"M -4,-4 L 4,4 M -4,4 L 4,-4",stroke:"white","stroke-width":"3"})),h.appendChild(SVGBuilder.createPath({d:"M -4,-4 L 4,4 M -4,4 L 4,-4",stroke:"context-stroke","stroke-width":"2"})),i.appendChild(h),i}createFilters(){const i=SVGBuilder.createGroup({id:"definition-group"}),r=SVGBuilder.createFilter(ze.removalFilterId,{filterUnits:"userSpaceOnUse"}),s=SVGBuilder.createComponentTransfert(),n=SVGBuilder.createTransfertFunctionTable("feFuncA","0 0.25");s.appendChild(n),r.appendChild(s),i.appendChild(r);const a=SVGBuilder.createFilter(ze.selectionFilterId,{filterUnits:"userSpaceOnUse"});return a.appendChild(SVGBuilder.createDropShadow({dx:-1,dy:-1,deviation:1})),i.appendChild(a),i}drawGuides(){var r,s;this.verticalGuides=[],this.horizontalGuides=[];const n=Number(null===(r=this.layer.getAttribute("height"))||void 0===r?void 0:r.replace("px","")),a=Number(null===(s=this.layer.getAttribute("width"))||void 0===s?void 0:s.replace("px","")),l=this.configuration.guides.gap,d=this.configuration.guides.gap/5,h={id:this.groupGuidesId,stroke:"grey",opacity:"0.5",style:ze.noSelection,role:i.SvgElementRole.Guide},c=SVGBuilder.createGroup(h);switch(this.configuration.guides.type){case"line":for(let i=l;i<n;i+=l){const r={x:l,y:i},s={x:a-l,y:i};this.horizontalGuides.push(i);const n=SVGBuilder.createLine(r,s,{"stroke-width":"1",style:ze.noSelection});c.appendChild(n)}break;case"grid":for(let i=0;i<n;i+=l){const r={x:0,y:i},s={x:a,y:i},n=SVGBuilder.createLine(r,s,{"stroke-width":"1",style:ze.noSelection});c.appendChild(n),this.horizontalGuides.push(i);for(let r=i+d;r<i+l;r+=d){this.horizontalGuides.push(r);const i=SVGBuilder.createLine({x:0,y:r},{x:a,y:r},{"stroke-width":"0.25",style:ze.noSelection});c.appendChild(i)}}for(let i=0;i<a;i+=l){const r={x:i,y:0},s={x:i,y:n},a=SVGBuilder.createLine(r,s,{"stroke-width":"1",style:ze.noSelection});c.appendChild(a),this.verticalGuides.push(i);for(let r=i+d;r<i+l;r+=d){this.verticalGuides.push(r);const i=SVGBuilder.createLine({x:r,y:0},{x:r,y:n},{"stroke-width":"0.25",style:ze.noSelection});c.appendChild(i)}}break;case"point":for(let i=l;i<a;i+=l){this.verticalGuides.push(i);for(let r=l;r<n;r+=l){this.horizontalGuides.push(r);const s=SVGBuilder.createCircle({x:i,y:r},1);c.appendChild(s)}}break;default:__classPrivateFieldGet(this,Ve,"f").error("drawGuides",`Guide type unknow: ${this.configuration.guides.type}`)}this.horizontalGuides=[...new Set(this.horizontalGuides)],this.verticalGuides=[...new Set(this.verticalGuides)],this.definitionGroup.appendChild(c)}removeGuides(){var i;this.verticalGuides=[],this.horizontalGuides=[],null===(i=this.layer.querySelector(`#${this.groupGuidesId}`))||void 0===i||i.remove()}createSVGTools(){return this.definitionGroup=SVGBuilder.createGroup({id:"definition-group"}),this.definitionGroup.appendChild(this.createDefs()),this.definitionGroup.appendChild(this.createFilters()),this.configuration.guides.enable&&this.drawGuides(),this.definitionGroup}init(i){__classPrivateFieldGet(this,Ve,"f").info("init",{element:i}),this.parent=i,this.parent.oncontextmenu=()=>!1,this.initLayer()}getAttribute(i,r){const s=this.layer.querySelector(`#${i}`);return null==s?void 0:s.getAttribute(r)}setAttribute(i,r,s){const n=this.layer.querySelector(`#${i}`);null==n||n.setAttribute(r,s)}buildElementFromSymbol(r){let s;switch(r.type){case i.SymbolType.Stroke:s=OISVGRendererStrokeUtil.getSVGElement(r);break;case i.SymbolType.Eraser:s=OISVGRendererEraserUtil.getSVGElement(r);break;case i.SymbolType.Shape:s=OISVGRendererShapeUtil.getSVGElement(r);break;case i.SymbolType.Edge:s=OISVGRendererEdgeUtil.getSVGElement(r);break;case i.SymbolType.Text:s=OISVGRendererTextUtil.getSVGElement(r);break;case i.SymbolType.Group:s=OISVGRendererGroupUtil.getSVGElement(r);break;default:__classPrivateFieldGet(this,Ve,"f").error("buildElementFromSymbol",`symbol unknow: "${JSON.stringify(r)}"`)}return s}prependElement(i){this.layer.prepend(i)}changeOrderSymbol(i,r){var s,n;const a=this.layer.querySelector(`#${i.id}`);if(a)switch(r){case"first":this.definitionGroup.insertAdjacentElement("afterend",a);break;case"last":this.layer.insertAdjacentElement("beforeend",a);break;case"forward":null===(s=a.nextElementSibling)||void 0===s||s.insertAdjacentElement("afterend",a);break;case"backward":a.previousElementSibling!==this.definitionGroup&&(null===(n=a.previousElementSibling)||void 0===n||n.insertAdjacentElement("beforebegin",a))}}appendElement(i){this.layer.appendChild(i)}removeElement(i){__classPrivateFieldGet(this,Ve,"f").debug("Element",{id:i});const r=this.layer.querySelector(`#${i}`);r&&r.remove()}drawSymbol(i){__classPrivateFieldGet(this,Ve,"f").debug("drawSymbol",{symbol:i});const r=this.layer.querySelector(`#${null==i?void 0:i.id}`),s=this.buildElementFromSymbol(i);return s&&(r?r.replaceWith(s):this.layer.appendChild(s)),s}replaceSymbol(i,r){__classPrivateFieldGet(this,Ve,"f").debug("drawSymbol",{symbols:r});const s=this.layer.querySelector(`#${i}`),n=r.map((i=>this.buildElementFromSymbol(i))).filter((i=>!!i));return n.length&&(s?(n.forEach((i=>s.insertAdjacentElement("beforebegin",i))),s.remove()):n.forEach((i=>this.layer.appendChild(i)))),n}removeSymbol(i){__classPrivateFieldGet(this,Ve,"f").debug("removeSymbol",{id:i}),this.removeElement(i)}drawCircle(i,r,s={}){__classPrivateFieldGet(this,Ve,"f").info("drawCircle",{point:i,radius:r,attrs:s}),this.layer.appendChild(SVGBuilder.createCircle(i,r,s))}drawRect(i,r={}){__classPrivateFieldGet(this,Ve,"f").info("drawCircle",{box:i,attrs:r}),this.layer.appendChild(SVGBuilder.createRect(i,r))}drawLine(i,r,s={}){__classPrivateFieldGet(this,Ve,"f").info("drawLine",{p1:i,p2:r,attrs:s}),this.layer.appendChild(SVGBuilder.createLine(i,r,s))}drawConnectionBetweenBox(i,r,s,n){const a=new Box(r).corners,l=new Box(s).corners,{p1:d,p2:h}=getClosestPoints(a,l),c=Object.assign({id:i,fill:"transparent",style:ze.noSelection},n);this.drawLine(d,h,c)}resize(i,r){__classPrivateFieldGet(this,Ve,"f").info("resize",{height:i,width:r}),this.layer.setAttribute("width",`${r}px`),this.layer.setAttribute("height",`${i}px`),this.layer.setAttribute("viewBox",`0, 0, ${r}, ${i}`),this.removeGuides(),this.configuration.guides.enable&&this.drawGuides()}getElementById(i){return this.layer.querySelector(`#${i}`)}getElements({tagName:i,attrs:r}){__classPrivateFieldGet(this,Ve,"f").info("getElements",{tagName:i,attrs:r});let s=i||"*";return r&&Object.keys(r).forEach((i=>{s+=`[${i}=${r[i]}]`})),this.layer.querySelectorAll(s)}clearElements({tagName:i,attrs:r}){__classPrivateFieldGet(this,Ve,"f").info("clearElements",{tagName:i,attrs:r}),this.getElements({tagName:i,attrs:r}).forEach((i=>i.remove()))}clear(){if(__classPrivateFieldGet(this,Ve,"f").info("clear"),this.layer){for(;this.layer.firstChild;)this.layer.firstChild.remove();this.layer.appendChild(this.createSVGTools())}}destroy(){this.layer&&this.layer.remove()}}Ve=new WeakMap;class SVGStroker{getArcPath(i,r){return[`M ${i.x},${i.y}`,`m ${-r},0`,`a ${r},${r} 0 1 0 ${2*r},0`,`a ${r},${r} 0 1 0 ${-2*r},0`].join(" ")}getLinePath(i,r,s){const n=computeLinksPointers(i,computeAngleAxeRadian(i,r),s),a=computeLinksPointers(r,computeAngleAxeRadian(i,r),s);return[`M ${n[0].x},${n[0].y}`,`L ${a[0].x},${a[0].y}`,`L ${a[1].x},${a[1].y}`,`L ${n[1].x},${n[1].y}`].join(" ")}getFinalPath(i,r,s){const n=computeAngleAxeRadian(i,r),a=computeLinksPointers(r,n,s),l=[`M ${a[0].x},${a[0].y}`];for(let i=1;i<=6;i++){const a=n-i*(Math.PI/6);l.push(`L ${r.x-r.p*s*Math.sin(a)},${r.y+r.p*s*Math.cos(a)}`)}return l.join(" ")}getQuadraticPath(i,r,s,n){const a=computeLinksPointers(i,computeAngleAxeRadian(i,s),n),l=computeLinksPointers(r,computeAngleAxeRadian(s,r),n),d=computeLinksPointers(s,computeAngleAxeRadian(i,r),n);return[`M ${a[0].x},${a[0].y}`,`Q ${d[0].x},${d[0].y} ${l[0].x},${l[0].y}`,`L ${l[1].x},${l[1].y}`,`Q ${d[1].x},${d[1].y} ${a[1].x},${a[1].y}`].join(" ")}buildSVGPath(i){const r=i.pointers.length,s=i.style.width,n=r-2,a=i.pointers[0],l=[];if(r<3)l.push(this.getArcPath(a,.6*s));else{l.push(this.getArcPath(a,s*a.p)),l.push(this.getLinePath(a,computeMiddlePointer(a,i.pointers[1]),s));for(let r=0;r<n;r++){const n=computeMiddlePointer(i.pointers[r],i.pointers[r+1]),a=computeMiddlePointer(i.pointers[r+1],i.pointers[r+2]),d=i.pointers[r+1];l.push(this.getQuadraticPath(n,a,d,s))}const d=i.pointers[r-2],h=i.pointers[r-1];l.push(this.getLinePath(computeMiddlePointer(d,h),h,s)),l.push(this.getFinalPath(d,h,s))}return l.join(" ")}drawStroke(i,r,s){const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.classList.add("pending-stroke"),n.setAttribute("id",r.id),n.setAttribute("type",r.pointerType),null==s||s.forEach((i=>{n.setAttribute(i.name,i.value)}));const a=this.buildSVGPath(r);n.setAttribute("d",`${a}Z`),i.appendChild(n)}}class WSSVGRenderer{constructor(r){We.set(this,LoggerManager.getLogger(i.LoggerClass.RENDERER)),__classPrivateFieldGet(this,We,"f").info("constructor",{config:r}),this.config=r,this.stroker=new SVGStroker}init(i){__classPrivateFieldGet(this,We,"f").info("init",{element:i}),i.style.fontSize="10px",this.context={parent:i}}drawStroke(i,r){let s;"eraser"===r.pointerType?(r.style.width=12,s="fill:grey;stroke:transparent;shadowBlur:5;opacity:0.2;"):s=`fill:${r.style.color};stroke:transparent;`,this.stroker.drawStroke(i,r,[{name:"style",value:s}])}replaceAll(i,r){const s=this.context.parent.querySelector(`svg[data-layer="${i}"]`);null==s||s.remove(),this.context.parent.insertAdjacentHTML("beforeend",r.svg);const n=this.context.parent.querySelector(`svg[data-layer="${i}"]`);if("MODEL"===i){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.id="pendingStrokes",n.appendChild(i)}}replaceElement(i){const r=this.context.parent.querySelector(`#${i.id}`);if(r){const s=r.parentNode;null==r||r.remove(),null==s||s.insertAdjacentHTML("beforeend",i.svg)}}appendChild(i,r){const s=r.parentId?`#${r.parentId}`:`svg[data-layer="${i}"]`,n=this.context.parent.querySelector(s);null==n||n.insertAdjacentHTML("beforeend",r.svg)}removeChild(i){var r;null===(r=this.context.parent.querySelector(`#${i.parentId} > *:nth-child(${i.index+1})`))||void 0===r||r.remove()}removeElement(i){const r=this.context.parent.querySelector(`#${i.id}`);r&&(i.id.includes("s")||i.id.includes("MODEL")?r.remove():(r.setAttribute("class","removed-stroke"),setTimeout((()=>{null==r||r.remove()}),100)))}insertBefore(i){const r=this.context.parent.querySelector(`#${i.refId}`);null==r||r.insertAdjacentHTML("beforebegin",i.svg)}setAttribute(i){const r=i.id?`#${i.id}`:"svg",s=this.context.parent.querySelector(r);null==s||s.setAttribute(i.name,i.value)}removeAttribute(i){const r=i.id?`#${i.id}`:"svg",s=this.context.parent.querySelector(r);null==s||s.removeAttribute(i.name)}updateLayer(i,r){switch(__classPrivateFieldGet(this,We,"f").info("updateLayer",{layerName:i,update:r}),r.type){case"REPLACE_ALL":this.replaceAll(i,r);break;case"REPLACE_ELEMENT":this.replaceElement(r);break;case"APPEND_CHILD":this.appendChild(i,r);break;case"REMOVE_ELEMENT":this.removeElement(r);break;case"REMOVE_CHILD":this.removeChild(r);break;case"INSERT_BEFORE":this.insertBefore(r);break;case"SET_ATTRIBUTE":this.setAttribute(r);break;case"REMOVE_ATTRIBUTE":this.removeAttribute(r);break;default:__classPrivateFieldGet(this,We,"f").warn("updateLayer",`update.type unknow ${r.type}`)}}updatesLayer(i,r){__classPrivateFieldGet(this,We,"f").info("updatesLayer",{layerName:i,updates:r}),r.forEach((r=>this.updateLayer(i,r))),this.clearPendingStroke()}clearPendingStroke(){__classPrivateFieldGet(this,We,"f").info("clearPendingStroke");const i=this.context.parent.querySelector("#pendingStrokes");i&&(i.innerHTML="")}drawPendingStroke(i){if(__classPrivateFieldGet(this,We,"f").info("drawPendingStroke",{stroke:i}),i){const r=this.context.parent.querySelector("#pendingStrokes");if(r){const s=r.querySelector(`#${null==i?void 0:i.id}`);s&&s.remove(),this.drawStroke(r,i)}}}clearErasingStrokes(){this.context.parent.querySelectorAll("[type=eraser]").forEach((i=>{i.remove()}))}resize(i){__classPrivateFieldGet(this,We,"f").info("resize",{model:i});const r=this.context.parent.getBoundingClientRect(),s=this.context.parent.querySelectorAll("svg"),n=Math.max(r.width,i.width),a=Math.max(r.height,i.height);s.forEach((i=>{i.setAttribute("viewBox",`0 0 ${n}, ${a}`),i.setAttribute("width",`${n}px`),i.setAttribute("height",`${a}px`)}))}destroy(){var i;__classPrivateFieldGet(this,We,"f").info("destroy",{context:this.context}),(null===(i=this.context)||void 0===i?void 0:i.parent)&&this.context.parent.querySelectorAll("svg").forEach((i=>i.remove()))}}We=new WeakMap;class OIConversionManager{constructor(r,s){He.set(this,LoggerManager.getLogger(i.LoggerClass.CONVERTER)),__classPrivateFieldGet(this,He,"f").info("constructor"),this.behaviors=r,this.fontSize=null==s?void 0:s.size,this.fontWeight=null==s?void 0:s.weight}get model(){return this.behaviors.model}get rowHeight(){return this.behaviors.configuration.rendering.guides.gap}computeFontSize(i){if(i.some((i=>i["bounding-box"]))){const r=convertMillimeterToPixel(computeAverage(i.map((i=>{var r;return(null===(r=i["bounding-box"])||void 0===r?void 0:r.height)||1}))));return 2*Math.round(Math.round(r*this.rowHeight)/this.rowHeight/2)}return Math.round(this.rowHeight/2)}buildChar(i,r,s){const n=i.grid.map((i=>({x:convertMillimeterToPixel(i.x),y:convertMillimeterToPixel(i.y)})));let a=this.fontWeight;a||(a=(r[0].style.width||1)>2?"bold":"normal");const l=r[0].style.color||"black";return{id:`text-char-${createUUID()}`,label:i.label,color:l,fontSize:s,fontWeight:a,bounds:Box.createFromPoints(n)}}buildWord(r,s,n,a){const l=Box.createFromBoxes([convertBoundingBoxMillimeterToPixel(r["bounding-box"])]),d=[];a=a||this.computeFontSize(s),s.forEach((i=>{const r=n.filter((r=>{var s;return null===(s=i.items)||void 0===s?void 0:s.some((i=>i["full-id"]===r.id))}));r.length&&d.push(this.buildChar(i,r,a))}));const h={x:l.xMin,y:l.yMax},c=new OIText(d,h,l,n[0].style),u=n.flatMap((i=>i.decorators));if(n.forEach((r=>{const s=this.model.getRootSymbol(r.id);if((null==s?void 0:s.type)===i.SymbolType.Group){const r=s,n=r.decorators.find((r=>r.kind===i.DecoratorKind.Highlight));n&&u.push(n);const a=r.decorators.find((r=>r.kind===i.DecoratorKind.Strikethrough));a&&u.push(a);const l=r.decorators.find((r=>r.kind===i.DecoratorKind.Surround));l&&u.push(l);const d=r.decorators.find((r=>r.kind===i.DecoratorKind.Underline));d&&u.push(d)}})),u.length){const r=u.find((r=>r.kind===i.DecoratorKind.Highlight));r&&c.decorators.push(new OIDecorator(i.DecoratorKind.Highlight,r.style));const s=u.find((r=>r.kind===i.DecoratorKind.Strikethrough));s&&c.decorators.push(new OIDecorator(i.DecoratorKind.Strikethrough,s.style));const n=u.find((r=>r.kind===i.DecoratorKind.Surround));n&&c.decorators.push(new OIDecorator(i.DecoratorKind.Surround,n.style));const a=u.find((r=>r.kind===i.DecoratorKind.Underline));a&&c.decorators.push(new OIDecorator(i.DecoratorKind.Underline,a.style))}return c}convertText(i,r,s){var n;if(!i.words)throw new Error("You need to active configuration.recognition.export.jiix.text.words = true");if(!i.chars)throw new Error("You need to active configuration.recognition.export.jiix.text.chars = true");if(!i.chars.some((i=>i.items)))throw new Error("You need to active configuration.recognition.export.jiix.strokes = true");const a=i.words,l=i.chars,d=[],h=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);let c=this.fontSize;s&&!c&&(c=2*Math.round(this.computeFontSize(l.filter((i=>{var r;return null===(r=i.items)||void 0===r?void 0:r.length})))/2));let u=!1,p=h.y+this.rowHeight,m=convertMillimeterToPixel((null===(n=a[0]["bounding-box"])||void 0===n?void 0:n.x)||0);return a.forEach((i=>{var n;if(" "===i.label)return void(m+=this.behaviors.texter.getSpaceWidth((null===(n=d.at(-1))||void 0===n?void 0:n.symbol.chars[0].fontSize)||this.rowHeight/2));const a=r.filter((r=>{var s;return null===(s=i.items)||void 0===s?void 0:s.some((i=>i["full-id"]===r.id))}));if(a.length){const r=l.slice(i["first-char"],(i["last-char"]||0)+1),n=this.buildWord(i,r,a,c);if(s){if(u){u=!1;const i=Math.round((n.point.y-p)/this.rowHeight)||1;p+=i*this.rowHeight,Math.abs(n.point.x-h.x)<2*this.behaviors.texter.getSpaceWidth(c)&&(m=h.x)}n.point.x=m,n.point.y=this.model.roundToLineGuide(p)}this.behaviors.texter.setBounds(n),m+=n.bounds.width,d.push({symbol:n,strokes:a})}u="\n"===i.label})),d}buildCircle(i,r){var s;const n={x:convertMillimeterToPixel(i.cx),y:convertMillimeterToPixel(i.cy)};return new OIShapeCircle(n,convertMillimeterToPixel(i.r),null===(s=r[0])||void 0===s?void 0:s.style)}buildEllipse(i,r){var s;const n={x:convertMillimeterToPixel(i.cx),y:convertMillimeterToPixel(i.cy)};return new OIShapeEllipse(n,convertMillimeterToPixel(i.rx),convertMillimeterToPixel(i.ry),i.orientation,null===(s=r[0])||void 0===s?void 0:s.style)}buildRectangle(i,r){var s;const n=convertMillimeterToPixel(i.height),a=convertMillimeterToPixel(i.width),l=convertMillimeterToPixel(i.x),d=convertMillimeterToPixel(i.y);return new OIShapePolygon([{x:l,y:d},{x:l+a,y:d},{x:l+a,y:d+n},{x:l,y:d+n}],null===(s=r[0])||void 0===s?void 0:s.style)}buildPolygon(i,r){var s;const n=[];for(let r=0;r<i.points.length;r+=2)n.push({x:convertMillimeterToPixel(i.points[r]),y:convertMillimeterToPixel(i.points[r+1])});return new OIShapePolygon(n,null===(s=r[0])||void 0===s?void 0:s.style)}buildRhombus(i,r){var s;const n=[];for(let r=0;r<i.points.length;r+=2)n.push({x:convertMillimeterToPixel(i.points[r]),y:convertMillimeterToPixel(i.points[r+1])});return new OIShapePolygon(n,null===(s=r[0])||void 0===s?void 0:s.style)}buildTriangle(i,r){var s;const n=[];for(let r=0;r<i.points.length;r+=2)n.push({x:convertMillimeterToPixel(i.points[r]),y:convertMillimeterToPixel(i.points[r+1])});return new OIShapePolygon(n,null===(s=r[0])||void 0===s?void 0:s.style)}buildParallelogram(i,r){var s;const n=[];for(let r=0;r<i.points.length;r+=2)n.push({x:convertMillimeterToPixel(i.points[r]),y:convertMillimeterToPixel(i.points[r+1])});return new OIShapePolygon(n,null===(s=r[0])||void 0===s?void 0:s.style)}convertNode(r,s){const n=s.filter((i=>{var s;return null===(s=r.items)||void 0===s?void 0:s.some((r=>r["full-id"]===i.id))}));if(!n.length)return;const a=n.filter(((i,r)=>n.findIndex((r=>i.id===r.id))===r));let l;switch(r.kind){case i.JIIXNodeKind.Circle:l=this.buildCircle(r,a);break;case i.JIIXNodeKind.Ellipse:l=this.buildEllipse(r,a);break;case i.JIIXNodeKind.Rectangle:l=this.buildRectangle(r,a);break;case i.JIIXNodeKind.Triangle:l=this.buildTriangle(r,a);break;case i.JIIXNodeKind.Parallelogram:l=this.buildParallelogram(r,a);break;case i.JIIXNodeKind.Polygon:l=this.buildPolygon(r,a);break;case i.JIIXNodeKind.Rhombus:l=this.buildRhombus(r,a);break;default:return void __classPrivateFieldGet(this,He,"f").warn("convertNode",`Conversion of Node with kind equal to ${JSON.stringify(r)} is unknow`)}return{symbol:l,strokes:a}}buildLine(i,r){var s;const n={x:convertMillimeterToPixel(i.x1),y:convertMillimeterToPixel(i.y1)},a={x:convertMillimeterToPixel(i.x2),y:convertMillimeterToPixel(i.y2)},l=computeAngleAxeRadian(n,a);return Math.abs(l%Math.PI)<.1?(n.y=+((n.y+a.y)/2).toFixed(3),a.y=n.y):Math.abs(l%(Math.PI/2))<.1&&(n.x=+((n.x+a.x)/2).toFixed(3),a.x=n.x),new OIEdgeLine(n,a,i.p1Decoration,i.p2Decoration,null===(s=r[0])||void 0===s?void 0:s.style)}buildPolyEdge(i,r){var s;const n={x:convertMillimeterToPixel(i.edges[0].x1),y:convertMillimeterToPixel(i.edges[0].y1)},a=i.edges.map((i=>({x:convertMillimeterToPixel(i.x2),y:convertMillimeterToPixel(i.y2)})));a.unshift(n);for(let i=0;i<a.length-1;i++){const r=a[i],s=a[i+1],n=computeAngleAxeRadian(r,s);Math.abs(n%Math.PI)<.1?(r.y=+((r.y+s.y)/2).toFixed(3),s.y=r.y):Math.abs(n%(Math.PI/2))<.1&&(r.x=+((r.x+s.x)/2).toFixed(3),s.x=r.x)}return new OIEdgePolyLine(a,i.edges[0].p1Decoration,i.edges.at(-1).p2Decoration,null===(s=r[0])||void 0===s?void 0:s.style)}buildArc(i,r){var s;const n={x:convertMillimeterToPixel(i.cx),y:convertMillimeterToPixel(i.cy)},a=convertMillimeterToPixel(i.rx),l=convertMillimeterToPixel(i.ry);return new OIEdgeArc(n,i.startAngle,i.sweepAngle,a,l,i.phi,i.startDecoration,i.endDecoration,null===(s=r[0])||void 0===s?void 0:s.style)}convertEdge(r,s){switch(r.kind){case i.JIIXEdgeKind.Line:{const i=s.filter((i=>{var s;return null===(s=r.items)||void 0===s?void 0:s.some((r=>r["full-id"]===i.id))}));if(!i.length)return;const n=i.filter(((r,s)=>i.findIndex((i=>r.id===i.id))===s));return{symbol:this.buildLine(r,n),strokes:n}}case i.JIIXEdgeKind.Arc:{const i=s.filter((i=>{var s;return null===(s=r.items)||void 0===s?void 0:s.some((r=>r["full-id"]===i.id))}));if(!i.length)return;const n=i.filter(((r,s)=>i.findIndex((i=>r.id===i.id))===s));return{symbol:this.buildArc(r,n),strokes:n}}case i.JIIXEdgeKind.PolyEdge:{const i=s.filter((i=>{var s;return null===(s=r.edges.flatMap((i=>i.items)))||void 0===s?void 0:s.some((r=>r["full-id"]===i.id))}));if(!i.length)return;const n=i.filter(((r,s)=>i.findIndex((i=>r.id===i.id))===s));return{symbol:this.buildPolyEdge(r,n),strokes:n}}default:return void __classPrivateFieldGet(this,He,"f").error("convertEdge",`Conversion of Edge with kind equal to ${JSON.stringify(r)} is unknow`)}}apply(i=[]){var r,s,n,a;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,He,"f").info("convert"),(null===(r=this.model.exports)||void 0===r?void 0:r["application/vnd.myscript.jiix"])||(yield this.behaviors.export(["application/vnd.myscript.jiix"])),this.behaviors.selector.removeSelectedGroup();const l=null===(s=this.model.exports)||void 0===s?void 0:s["application/vnd.myscript.jiix"];if(null===(n=null==l?void 0:l.elements)||void 0===n?void 0:n.length){const r=this.behaviors.extractStrokesFromSymbols(i.length?i:this.model.symbols),s=!(null===(a=l.elements)||void 0===a?void 0:a.some((i=>"Text"!==i.type))),n=[];l.elements.forEach((i=>{switch(i.type){case"Text":{const a=this.convertText(i,r,s);a&&n.push(...a);break}case"Node":{const s=this.convertNode(i,r);s&&n.push(s);break}case"Edge":{const s=this.convertEdge(i,r);s&&n.push(s);break}default:__classPrivateFieldGet(this,He,"f").warn("buildConversions",`Unknow jiix element type: ${i.type}`)}})),this.behaviors.addSymbols(n.map((i=>i.symbol)),!1),this.behaviors.removeSymbols(n.flatMap((i=>i.strokes.map((i=>i.id)))),!1),this.behaviors.history.push(this.model,{added:n.map((i=>i.symbol)),erased:n.flatMap((i=>i.strokes))})}}))}}He=new WeakMap,i.SurroundAction=void 0,(Ue=i.SurroundAction||(i.SurroundAction={})).Select="select",Ue.Surround="surround",Ue.Highlight="highlight",i.StrikeThroughAction=void 0,(Xe=i.StrikeThroughAction||(i.StrikeThroughAction={})).Erase="erase",Xe.Draw="draw",i.InsertAction=void 0,(Ke=i.InsertAction||(i.InsertAction={})).LineBreak="line-break",Ke.Insert="insert";class OIGestureManager{constructor(r,s){Ye.set(this,LoggerManager.getLogger(i.LoggerClass.GESTURE)),this.insertAction=i.InsertAction.LineBreak,this.surroundAction=i.SurroundAction.Select,this.strikeThroughAction=i.StrikeThroughAction.Draw,__classPrivateFieldGet(this,Ye,"f").info("constructor"),this.behaviors=r,this.surroundAction=(null==s?void 0:s.surround)||i.SurroundAction.Select,this.strikeThroughAction=(null==s?void 0:s.strikeThrough)||i.StrikeThroughAction.Draw,this.insertAction=(null==s?void 0:s.insert)||i.InsertAction.LineBreak}get renderer(){return this.behaviors.renderer}get recognizer(){return this.behaviors.recognizer}get translator(){return this.behaviors.translator}get texter(){return this.behaviors.texter}get model(){return this.behaviors.model}get history(){return this.behaviors.history}get currentStyle(){return this.behaviors.styler.currentPenStyle}get rowHeight(){return this.behaviors.configuration.rendering.guides.gap}get strokeSpaceWidth(){return this.behaviors.configuration.rendering.guides.gap/2}applySurroundGesture(r,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ye,"f").info("applySurroundGesture",{gestureStroke:r,gesture:s});const n={},a=this.model.symbols.filter((i=>r.bounds.contains(i.bounds))).map((i=>i.id));switch(this.surroundAction){case i.SurroundAction.Select:a.length&&(this.behaviors.internalEvent.emitIntention(i.Intention.Select),this.behaviors.select(a));break;case i.SurroundAction.Highlight:{const r=[];n.decorator=[],a.forEach((s=>{const a=this.model.getRootSymbol(s);if(a&&[i.SymbolType.Group,i.SymbolType.Stroke,i.SymbolType.Text].includes(a.type)&&!r.includes(a.id)){const s=a,l=new OIDecorator(i.DecoratorKind.Highlight,this.currentStyle),d=s.decorators.findIndex((r=>r.kind===i.DecoratorKind.Highlight)),h=-1===d;h?s.decorators.push(l):s.decorators.splice(d,1),this.model.updateSymbol(s),this.renderer.drawSymbol(s),r.push(s.id),n.decorator.push({symbol:s,decorator:l,added:h})}})),n.decorator.length&&this.history.push(this.model,n);break}case i.SurroundAction.Surround:{const r=[];n.decorator=[],a.forEach((s=>{const a=this.model.getRootSymbol(s);if(a&&[i.SymbolType.Group,i.SymbolType.Stroke,i.SymbolType.Text].includes(a.type)&&!r.includes(a.id)){const s=a,l=new OIDecorator(i.DecoratorKind.Surround,this.currentStyle),d=s.decorators.findIndex((r=>r.kind===i.DecoratorKind.Surround)),h=-1===d;h?s.decorators.push(l):s.decorators.splice(d,1),this.model.updateSymbol(s),this.renderer.drawSymbol(s),n.decorator.push({symbol:s,decorator:l,added:h}),r.push(s.id)}})),this.history.push(this.model,n);break}default:__classPrivateFieldGet(this,Ye,"f").error("applySurroundGesture",`Unknow surroundAction: ${this.surroundAction}, values allowed are: ${i.SurroundAction.Highlight}, ${i.SurroundAction.Select}, ${i.SurroundAction.Surround}`)}}))}computeScratchOnStrokes(i,r){var s;const n=[],a=null===(s=i.subStrokes)||void 0===s?void 0:s.find((i=>i.fullStrokeId===r.id));if(a){const i=new OIStroke;a.x.forEach(((r,s)=>i.addPointer({x:r,y:a.y[s],p:1,t:1})));const s=OIStroke.substract(r,i);s.before&&n.push(s.before),s.after&&n.push(s.after)}return n}computeScratchOnText(i,r){const s=r.getCharsOverlaps(i.pointers);return r.chars.length==s.length?void 0:(s.forEach((i=>{const s=r.chars.findIndex((r=>r.id===i.id));r.chars.splice(s,1)})),this.texter.updateBounds(r),r)}computeScratchOnSymbol(r,s,n){switch(n.type){case i.SymbolType.Stroke:{const i=this.computeScratchOnStrokes(s,n);return i.length?{replaced:i}:{erased:!0}}case i.SymbolType.Group:{const i=n.extractSymbols().filter((i=>!r.bounds.overlaps(i.bounds))),a=n.extractSymbols().filter((i=>r.bounds.overlaps(i.bounds))).map((i=>({symbol:i,result:this.computeScratchOnSymbol(r,s,i)})));if(0===i.length&&a.every((i=>i.result.erased)))return{erased:!0};{const r=i;a.forEach((i=>{i.result.replaced&&r.push(...i.result.replaced)}));const s=new OISymbolGroup(r,n.style);return s.decorators=n.decorators,{replaced:[s]}}}case i.SymbolType.Text:{const i=this.computeScratchOnText(r,n);return i?{replaced:[i]}:{erased:!0}}case i.SymbolType.Shape:case i.SymbolType.Edge:return{erased:!0}}}applyScratch(i,r){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Ye,"f").debug("applyScratchGesture",{gestureStroke:i,gesture:r}),!r.strokeIds.length)return void __classPrivateFieldGet(this,Ye,"f").warn("applyScratchGesture","Unable to apply underline because there are no strokes");const s=[],n=[],a={oldSymbols:[],newSymbols:[]};r.strokeIds.forEach((s=>{const l=this.model.getRootSymbol(s);if(l&&!n.some((i=>i.id===l.id))&&!a.oldSymbols.some((i=>i.id===l.id))){const s=this.computeScratchOnSymbol(i,r,l);s.erased?n.push(l):s.replaced&&(a.newSymbols.push(...s.replaced),a.oldSymbols.push(l))}}));const l=[],d={};s.length&&(l.push(this.behaviors.updateSymbols(s,!1)),d.updated=s),n.length&&(l.push(this.behaviors.removeSymbols(n.map((i=>i.id)),!1)),d.erased=n),a.newSymbols.length&&(d.replaced=a,l.push(this.behaviors.replaceSymbols(a.oldSymbols,a.newSymbols,!1))),this.history.push(this.model,d),yield Promise.all(l)}))}applyJoinGesture(r,s){var n;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ye,"f").debug("applyJoinGesture",{gestureStroke:r,gesture:s});const a=this.model.symbols.filter((i=>this.model.isSymbolAbove(r,i))),l=this.model.symbols.filter((i=>r.id!==i.id&&this.model.isSymbolInRow(r,i))),d=l.filter((i=>i.bounds.xMax<=r.bounds.xMid)),h=l.filter((i=>i.bounds.xMax>r.bounds.xMid&&i.bounds.xMin<=r.bounds.xMid)),c=l.filter((i=>i.bounds.xMin>r.bounds.xMid)),u=this.model.symbols.filter((i=>this.model.isSymbolBelow(r,i))),p={},m=[];if(h.length){const s=h[0];if((null==s?void 0:s.type)===i.SymbolType.Group){const i=s.extractSymbols().map((i=>i.clone())),n=i.filter((i=>i.bounds.xMid<=r.bounds.xMid)),a=i.filter((i=>i.bounds.xMid>r.bounds.xMid));if(n.length&&a.length){const r=Math.max(...n.map((i=>i.bounds.xMax)))-Math.min(...a.map((i=>i.bounds.xMin)));a.forEach((i=>this.translator.applyToSymbol(i,r,0)));const l=new OISymbolGroup(i,s.style);l.decorators=s.decorators.map((i=>i.clone())),p.replaced={oldSymbols:[s],newSymbols:[l]},c.length&&m.push({symbols:c,tx:r,ty:0});const d=u.filter((i=>this.model.isSymbolBelow(s,i)));d.length&&m.push({symbols:d,tx:0,ty:-this.rowHeight})}else if(c.length){const i=s.bounds.xMax-Math.min(...c.map((i=>i.bounds.xMin)));m.push({symbols:c,tx:i,ty:0})}}}else if(d.length&&c.length){const r=this.model.getLastSymbol(d),s=this.model.getFirstSymbol(c),n=Math.max(...d.map((i=>i.bounds.xMax)))-Math.min(...c.map((i=>i.bounds.xMin))),a=r.clone(),l=s.clone();this.translator.applyToSymbol(l,n,0);const h=r.type===i.SymbolType.Group?a.extractSymbols():[a];if(h.push(...l.type===i.SymbolType.Group?l.extractSymbols():[l]),h.every((r=>r.type===i.SymbolType.Text))){const i=h,n=new OIText(i.flatMap((i=>i.chars)),i[0].point,Box.createFromBoxes(i.map((i=>i.bounds))));this.texter.setBounds(n),p.replaced={oldSymbols:[r,s],newSymbols:[n]}}else{const n=new OISymbolGroup(h,r.style);[i.SymbolType.Group,i.SymbolType.Stroke,i.SymbolType.Text].includes(r.type)&&r.decorators.forEach((i=>{n.decorators.push(new OIDecorator(i.kind,i.style))})),[i.SymbolType.Group,i.SymbolType.Stroke,i.SymbolType.Text].includes(s.type)&&s.decorators.forEach((i=>{n.decorators.some((r=>r.kind==i.kind))||n.decorators.push(new OIDecorator(i.kind,i.style))})),p.replaced={oldSymbols:[r,s],newSymbols:[n]}}const u=c.filter((i=>i.id!==s.id));u.length&&m.push({symbols:u,tx:n,ty:0})}else if(d.length){const i=this.model.getLastSymbol(d),r=this.model.getFirstSymbol(u);if(r){if(this.model.roundToLineGuide(i.bounds.yMid)>=this.model.roundToLineGuide(r.bounds.yMid-this.rowHeight)){const s=u.filter((i=>this.model.isSymbolInRow(r,i)));if(s.length){const n=i.bounds.xMax+this.strokeSpaceWidth-r.bounds.xMin;m.push({symbols:s,tx:n,ty:-this.rowHeight})}const n=u.filter((i=>this.model.isSymbolBelow(r,i)));n.length&&m.push({symbols:n,tx:0,ty:-this.rowHeight})}}else m.push({symbols:u,tx:0,ty:-this.rowHeight})}else if(c.length){const i=this.model.getFirstSymbol(c),r=this.model.getLastSymbol(a);if(r){if(this.model.roundToLineGuide(r.bounds.yMid)>=this.model.roundToLineGuide(i.bounds.yMid-this.rowHeight)){const s=r.bounds.xMax+this.strokeSpaceWidth-i.bounds.xMin;m.push({symbols:c,tx:s,ty:-this.rowHeight})}else m.push({symbols:c,tx:0,ty:-this.rowHeight});u.length&&m.push({symbols:u,tx:0,ty:-this.rowHeight})}else m.push({symbols:c.concat(...u),tx:0,ty:-this.rowHeight})}(null===(n=p.replaced)||void 0===n?void 0:n.oldSymbols.length)&&this.behaviors.replaceSymbols(p.replaced.oldSymbols,p.replaced.newSymbols,!1),m.length&&(p.translate=m,Promise.all(m.map((i=>this.translator.translate(i.symbols,i.tx,i.ty,!1))))),this.history.push(this.model,p)}))}createStrokesFromGestureSubStroke(i,r){const s=[];if(r[0]){const n=new OIStroke(i.style);r[0].x.forEach(((s,a)=>{var l,d;n.pointers.push({x:s,y:r[0].y[a],p:(null===(l=i.pointers.at(a))||void 0===l?void 0:l.p)||1,t:(null===(d=i.pointers.at(a))||void 0===d?void 0:d.t)||Math.max(...n.pointers.map((i=>i.t+20)))})})),s.push(n)}if(r[1]){const n=new OIStroke(i.style);r[1].x.forEach(((s,a)=>{var l,d;n.pointers.push({x:s,y:r[1].y[a],p:(null===(l=i.pointers.at(n.pointers.length+a))||void 0===l?void 0:l.p)||1,t:(null===(d=i.pointers.at(n.pointers.length+a))||void 0===d?void 0:d.t)||Math.max(...n.pointers.map((i=>i.t+20)))})})),s.push(n)}return s}computeSplitStroke(i,r){let s;const n=this.createStrokesFromGestureSubStroke(i,r);return n[1]&&(s=n[1],this.translator.applyToSymbol(s,this.strokeSpaceWidth,0)),{before:n[0],after:s}}computeSplitStrokeInGroup(i,r,s){const n=[],a=r.extractSymbols(),l=[],d=[],h=s[0].fullStrokeId;return a.forEach((r=>{if(r.id===h){const i=this.computeSplitStroke(r,s);i.before&&l.push(i.before),i.after&&d.push(i.after)}else r.bounds.xMid<i.bounds.xMid?l.push(r):r.bounds.xMid>i.bounds.xMid&&(this.translator.applyToSymbol(r,this.strokeSpaceWidth,0),d.push(r))})),l.length&&n.push(new OISymbolGroup(l,r.style)),d.length&&n.push(new OISymbolGroup(d,r.style)),n}computeChangesOnSplitStroke(r,s,n){const a=[],l={oldSymbols:[],newSymbols:[]},d=this.model.symbols.filter((i=>r.id!==i.id&&this.model.isSymbolInRow(r,i)&&r.bounds.xMid<i.bounds.xMin)),h=this.model.getRootSymbol(s);if((null==h?void 0:h.type)===i.SymbolType.Group){const i=this.computeSplitStrokeInGroup(r,h,n);l.newSymbols.push(...i),l.oldSymbols.push(h)}else if((null==h?void 0:h.type)===i.SymbolType.Stroke){const i=this.computeSplitStroke(h,n);i.before&&l.newSymbols.push(i.before),i.after&&l.newSymbols.push(i.after),l.oldSymbols.push(h)}return d.length&&a.push({symbols:d,tx:this.strokeSpaceWidth,ty:0}),{translate:a,replaced:l}}computeChangesOnSplitGroup(i,r){const s=[],n={oldSymbols:[],newSymbols:[]},a=this.model.symbols.filter((r=>i.id!==r.id&&this.model.isSymbolInRow(i,r)&&i.bounds.xMid<r.bounds.xMin)),l=r.children.filter((r=>r.bounds.xMid<=i.bounds.xMid)),d=r.children.filter((r=>r.bounds.xMid>i.bounds.xMid));if(n.oldSymbols.push(r),l.length){const i=new OISymbolGroup(l.map((i=>i.clone())),r.style);i.decorators=r.decorators.map((i=>new OIDecorator(i.kind,i.style))),n.newSymbols.push(i)}if(d.length){const i=new OISymbolGroup(d.map((i=>i.clone())),r.style);i.decorators=r.decorators.map((i=>new OIDecorator(i.kind,i.style))),this.translator.applyToSymbol(i,this.strokeSpaceWidth,0),n.newSymbols.push(i)}return(null==a?void 0:a.length)&&s.push({symbols:a.filter((i=>i.id!==r.id)),tx:this.strokeSpaceWidth,ty:0}),{translate:s,replaced:n}}computeChangesOnSplitText(i,r){const s=[],n={oldSymbols:[],newSymbols:[]},a=this.model.symbols.filter((r=>i.id!==r.id&&this.model.isSymbolInRow(i,r)&&i.bounds.xMid<r.bounds.xMin)),l=r.chars.filter((r=>r.bounds.x+r.bounds.width/2<=i.bounds.xMid)),d=r.chars.filter((r=>r.bounds.x+r.bounds.width/2>i.bounds.xMid)),h=[];if(l.length&&d.length){const i=new OIText(l,r.point,Box.createFromBoxes(l.map((i=>i.bounds))));this.texter.setBounds(i),h.push(i);const s={x:i.point.x+i.bounds.width+this.texter.getSpaceWidth(computeAverage(i.chars.map((i=>i.fontSize)))),y:i.point.y},a=new OIText(d,s,Box.createFromBoxes(d.map((i=>i.bounds))));this.texter.setBounds(a),h.push(a),n.newSymbols=h,n.oldSymbols=[r]}return(null==a?void 0:a.length)&&s.push({symbols:a.filter((r=>r.id!==i.id)),tx:this.strokeSpaceWidth,ty:0}),{translate:s,replaced:n}}applyInsertGesture(r,s){var n,a,l;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ye,"f").debug("applyInsertGesture",{gestureStroke:r,gesture:s});const d=this.model.symbols.filter((i=>r.id!==i.id&&this.model.isSymbolInRow(r,i))),h=d.find((s=>s.type===i.SymbolType.Text&&isBetween(r.bounds.xMid,s.bounds.xMin,s.bounds.xMax))),c=d.find((s=>s.type===i.SymbolType.Group&&isBetween(r.bounds.xMid,s.bounds.xMin,s.bounds.xMax))),u=d.filter((i=>r.bounds.xMid>i.bounds.xMax)),p=d.filter((i=>r.bounds.xMid<i.bounds.xMin)),m=this.model.symbols.filter((i=>this.model.isSymbolBelow(r,i)));let g;if(s.strokeIds.length&&(null===(n=s.subStrokes)||void 0===n?void 0:n.length))g=this.computeChangesOnSplitStroke(r,s.strokeIds[0],s.subStrokes);else if(c)g=this.computeChangesOnSplitGroup(r,c);else if(h)g=this.computeChangesOnSplitText(r,h);else if(p.length){const r=[];let s=0;switch(u.length&&(s=Math.min(...u.map((i=>i.bounds.xMin)))-Math.min(...p.map((i=>i.bounds.xMin)))),this.insertAction){case i.InsertAction.LineBreak:r.push({symbols:p,tx:s,ty:this.rowHeight}),m.length&&r.push({symbols:m,tx:0,ty:this.rowHeight});break;case i.InsertAction.Insert:r.push({symbols:p,tx:2*this.strokeSpaceWidth,ty:0})}g={translate:r}}else u.length&&m.length&&this.insertAction===i.InsertAction.LineBreak&&(g={translate:[{symbols:m,tx:0,ty:this.rowHeight}]});if(g){const i=[];(null===(a=g.translate)||void 0===a?void 0:a.length)&&i.push(...g.translate.map((i=>this.translator.translate(i.symbols,i.tx,i.ty,!1)))),(null===(l=g.replaced)||void 0===l?void 0:l.newSymbols.length)&&i.push(this.behaviors.replaceSymbols(g.replaced.oldSymbols,g.replaced.newSymbols,!1)),this.history.push(this.model,g),yield Promise.all(i)}}))}applyUnderlineGesture(r,s){var n;return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Ye,"f").debug("applyUnderlineGesture",{gestureStroke:r,gesture:s}),!s.strokeIds.length)return void __classPrivateFieldGet(this,Ye,"f").warn("applyUnderlineGesture","Unable to apply underline because there are no strokes");const a={decorator:[]},l=[];s.strokeIds.forEach((r=>{var s;const n=this.model.getRootSymbol(r);if(n&&[i.SymbolType.Group,i.SymbolType.Stroke,i.SymbolType.Text].includes(n.type)&&!l.includes(n.id)){const r=n,d=new OIDecorator(i.DecoratorKind.Underline,this.currentStyle),h=r.decorators.findIndex((r=>r.kind===i.DecoratorKind.Underline)),c=-1===h;c?r.decorators.push(d):r.decorators.splice(h,1),this.model.updateSymbol(r),this.renderer.drawSymbol(r),null===(s=a.decorator)||void 0===s||s.push({symbol:r,decorator:d,added:c}),l.push(r.id)}})),(null===(n=a.decorator)||void 0===n?void 0:n.length)&&this.history.push(this.model,a)}))}applyStrikeThroughGesture(r,s){var n;return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Ye,"f").debug("applyStrikeThroughGesture",{gestureStroke:r,gesture:s}),s.strokeIds.length)switch(this.strikeThroughAction){case i.StrikeThroughAction.Draw:{const r={decorator:[]},a=[];s.strokeIds.forEach((s=>{var n;const l=this.model.getRootSymbol(s);if(l&&[i.SymbolType.Group,i.SymbolType.Stroke,i.SymbolType.Text].includes(l.type)&&!a.includes(l.id)){const s=l,d=new OIDecorator(i.DecoratorKind.Strikethrough,this.currentStyle),h=s.decorators.findIndex((r=>r.kind===i.DecoratorKind.Strikethrough)),c=-1===h;c?s.decorators.push(d):s.decorators.splice(h,1),this.model.updateSymbol(s),this.renderer.drawSymbol(s),null===(n=r.decorator)||void 0===n||n.push({symbol:s,decorator:d,added:c}),a.push(s.id)}})),(null===(n=r.decorator)||void 0===n?void 0:n.length)&&this.history.push(this.model,r);break}case i.StrikeThroughAction.Erase:return this.behaviors.removeSymbols(s.strokeIds);default:__classPrivateFieldGet(this,Ye,"f").warn("#applyStrikeThroughGesture",`Unknow OnStrikeThrough: ${this.strikeThroughAction}, values allowed are: ${i.StrikeThroughAction.Draw}, ${i.StrikeThroughAction.Erase}`)}else __classPrivateFieldGet(this,Ye,"f").warn("applyStrikeThroughGesture","Unable to apply strikethrough because there are no strokes")}))}apply(i,r){return __awaiter(this,void 0,void 0,(function*(){switch(__classPrivateFieldGet(this,Ye,"f").info("apply",{gestureStroke:i,gesture:r}),this.behaviors.updateSymbolsStyle([i.id],{opacity:(i.style.opacity||1)/2},!1),yield this.behaviors.groupStrokesByJIIXElement(),yield this.behaviors.removeSymbol(i.id,!1),r.gestureType){case"UNDERLINE":yield this.applyUnderlineGesture(i,r);break;case"SCRATCH":yield this.applyScratch(i,r);break;case"JOIN":yield this.applyJoinGesture(i,r);break;case"INSERT":yield this.applyInsertGesture(i,r);break;case"STRIKETHROUGH":yield this.applyStrikeThroughGesture(i,r);break;case"SURROUND":yield this.applySurroundGesture(i,r);break;default:__classPrivateFieldGet(this,Ye,"f").warn("apply",`Gesture unknow: ${r.gestureType}`)}return this.behaviors.svgDebugger.apply(),Promise.resolve()}))}getGestureFromContextLess(r){return __awaiter(this,void 0,void 0,(function*(){const s=yield this.recognizer.recognizeGesture(r);if(s)switch(s.gestureType){case"surround":return this.model.symbols.some((s=>!(s.id===r.id||!r.bounds.contains(s.bounds))&&(this.surroundAction===i.SurroundAction.Select||[i.SymbolType.Group,i.SymbolType.Stroke,i.SymbolType.Text].includes(s.type))))?{gestureType:"SURROUND",gestureStrokeId:r.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:[]}:void 0;case"left-right":case"right-left":{const s=this.model.symbols.filter((s=>[i.SymbolType.Text,i.SymbolType.Stroke,i.SymbolType.Group].includes(s.type)&&isBetween(s.bounds.xMid,r.bounds.xMin,r.bounds.xMax)&&isBetween(r.bounds.yMid,s.bounds.y+3*s.bounds.height/4,s.bounds.y+5*s.bounds.height/4)));if(s.length)return{gestureType:"UNDERLINE",gestureStrokeId:r.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:s.map((i=>i.id))};const n=this.model.symbols.filter((s=>[i.SymbolType.Text,i.SymbolType.Stroke,i.SymbolType.Group].includes(s.type)&&isBetween(s.bounds.xMid,r.bounds.xMin,r.bounds.xMax)&&isBetween(r.bounds.yMid,s.bounds.y+s.bounds.height/4,s.bounds.y+3*s.bounds.height/4)));return n.length?{gestureType:"STRIKETHROUGH",gestureStrokeId:r.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:n.map((i=>i.id))}:void 0}case"scratch":{const s=this.model.symbols.filter((s=>s.id!==r.id&&(r.bounds.overlaps(s.bounds)&&[i.SymbolType.Stroke,i.SymbolType.Text,i.SymbolType.Group].includes(s.type)||r.bounds.contains(s.bounds)&&[i.SymbolType.Shape,i.SymbolType.Edge].includes(s.type))));return s.length?{gestureType:"SCRATCH",gestureStrokeId:r.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:s.map((i=>i.id))}:void 0}case"bottom-top":return this.model.symbols.some((s=>s.id!==r.id&&[i.SymbolType.Text,i.SymbolType.Stroke,i.SymbolType.Group].includes(s.type)&&isBetween(s.bounds.yMid,r.bounds.yMin,r.bounds.yMax)))?{gestureType:"JOIN",gestureStrokeId:r.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:[]}:void 0;case"top-bottom":return this.model.symbols.some((s=>s.id!==r.id&&[i.SymbolType.Text,i.SymbolType.Stroke,i.SymbolType.Group].includes(s.type)&&isBetween(s.bounds.yMid,r.bounds.yMin,r.bounds.yMax)))?{gestureType:"INSERT",gestureStrokeId:r.id,strokeAfterIds:[],strokeBeforeIds:[],strokeIds:[]}:void 0;default:return}}))}}Ye=new WeakMap;class OIResizeManager{constructor(r){Je.set(this,LoggerManager.getLogger(i.LoggerClass.TRANSFORMER)),this.keepRatio=!1,__classPrivateFieldGet(this,Je,"f").info("constructor"),this.behaviors=r}get model(){return this.behaviors.model}applyToStroke(i,r,s,n){return __classPrivateFieldGet(this,Je,"f").debug("applyToStroke",{stroke:i,origin:r,scaleX:s,scaleY:n}),i.pointers.forEach((i=>{i.x=+(r.x+s*(i.x-r.x)).toFixed(3),i.y=+(r.y+n*(i.y-r.y)).toFixed(3)})),i}applyToShape(r,s,n,a){switch(__classPrivateFieldGet(this,Je,"f").debug("applyToShape",{shape:r,origin:s,scaleX:n,scaleY:a}),r.kind){case i.ShapeKind.Ellipse:{const i=Math.cos(r.orientation),l=Math.sin(r.orientation);return r.center.x=+(r.center.x+((n-1)*i+(a-1)*l)*(r.center.x-s.x)).toFixed(3),r.center.y=+(r.center.y+((n-1)*-l+(a-1)*i)*(r.center.y-s.y)).toFixed(3),r.radiusX=+Math.abs(r.radiusX*(n*i-a*l)).toFixed(3),r.radiusY=+Math.abs(r.radiusY*(n*l+a*i)).toFixed(3),r}case i.ShapeKind.Circle:return r.radius=+(r.radius*(n+a)/2).toFixed(3),r.center.x=+(s.x+n*(r.center.x-s.x)).toFixed(3),r.center.y=+(s.y+a*(r.center.y-s.y)).toFixed(3),r;case i.ShapeKind.Polygon:return r.points.forEach((i=>{i.x=+(s.x+n*(i.x-s.x)).toFixed(3),i.y=+(s.y+a*(i.y-s.y)).toFixed(3)})),r;default:throw new Error(`Can't apply resize on shape, kind unknow: ${JSON.stringify(r)}`)}}applyToEdge(r,s,n,a){switch(__classPrivateFieldGet(this,Je,"f").debug("applyToEdge",{edge:r,origin:s,scaleX:n,scaleY:a}),r.kind){case i.EdgeKind.Arc:{const i=Math.cos(r.phi),l=Math.sin(r.phi);return r.center.x=+(r.center.x+((n-1)*i+(a-1)*l)*(r.center.x-s.x)).toFixed(3),r.center.y=+(r.center.y+((n-1)*-l+(a-1)*i)*(r.center.y-s.y)).toFixed(3),r.radiusX=+(r.radiusX*Math.abs(n*i+a*l)).toFixed(3),r.radiusY=+(r.radiusY*Math.abs(n*l+a*i)).toFixed(3),n<0?(r.startAngle=+(Math.PI-r.startAngle).toFixed(3),r.sweepAngle*=-1):a<0&&(r.sweepAngle*=-1),r}case i.EdgeKind.Line:return r.start.x=+(s.x+n*(r.start.x-s.x)).toFixed(3),r.start.y=+(s.y+a*(r.start.y-s.y)).toFixed(3),r.end.x=+(s.x+n*(r.end.x-s.x)).toFixed(3),r.end.y=+(s.y+a*(r.end.y-s.y)).toFixed(3),r;case i.EdgeKind.PolyEdge:return r.points.forEach((i=>(i.x=+(s.x+n*(i.x-s.x)).toFixed(3),i.y=+(s.y+a*(i.y-s.y)).toFixed(3),i))),r;default:throw new Error(`Can't apply resize on edge, kind unknow: ${JSON.stringify(r)}`)}}applyOnText(i,r,s,n){return i.point.x=+(r.x+s*(i.point.x-r.x)).toFixed(3),i.point.y=+(r.y+n*(i.point.y-r.y)).toFixed(3),i.chars.forEach((i=>{i.fontSize=+(i.fontSize*(s+n)/2).toFixed(3)})),this.behaviors.texter.updateBounds(i)}applyOnGroup(i,r,s,n){return i.children.forEach((i=>this.applyToSymbol(i,r,s,n))),i}applyToSymbol(r,s,n,a){switch(__classPrivateFieldGet(this,Je,"f").info("applyToSymbol",{symbol:r,scaleX:n,scaleY:a}),r.type){case i.SymbolType.Stroke:return this.applyToStroke(r,s,n,a);case i.SymbolType.Shape:return this.applyToShape(r,s,n,a);case i.SymbolType.Edge:return this.applyToEdge(r,s,n,a);case i.SymbolType.Text:return this.applyOnText(r,s,n,a);case i.SymbolType.Group:return this.applyOnGroup(r,s,n,a);default:throw new Error(`Can't apply resize on symbol, type unknow: ${JSON.stringify(r)}`)}}setTransformOrigin(i,r,s){this.behaviors.renderer.setAttribute(i,"transform-origin",`${r}px ${s}px`)}scaleElement(i,r,s){__classPrivateFieldGet(this,Je,"f").info("scaleElement",{id:i,sx:r,sy:s}),this.behaviors.renderer.setAttribute(i,"transform",`scale(${r},${s})`)}start(r,s){__classPrivateFieldGet(this,Je,"f").info("start",{target:r}),this.interactElementsGroup=r.closest(`[role=${i.SvgElementRole.InteractElementsGroup}]`),this.direction=r.getAttribute("resize-direction"),this.keepRatio=this.model.symbolsSelected.some((r=>r.type===i.SymbolType.Text||r.type===i.SymbolType.Shape&&r.kind===i.ShapeKind.Circle)),this.transformOrigin=s,this.boundingBox=Box.createFromPoints(this.model.symbolsSelected.flatMap((i=>i.vertices))),this.setTransformOrigin(this.interactElementsGroup.id,this.transformOrigin.x,this.transformOrigin.y),this.model.symbolsSelected.forEach((i=>{this.setTransformOrigin(i.id,this.transformOrigin.x,this.transformOrigin.y)})),this.behaviors.selector.hideInteractElements()}continue(i){if(__classPrivateFieldGet(this,Je,"f").info("continue",{point:i}),!this.interactElementsGroup)throw new Error("Can't resize, you must call start before");const r=i,s=["e-resize","ne-resize","se-resize","w-resize","nw-resize","sw-resize"].includes(this.direction),n=["n-resize","ne-resize","nw-resize","s-resize","se-resize","sw-resize"].includes(this.direction),{x:a,y:l}=this.behaviors.snaps.snapResize(i,s,n);r.x=a,r.y=l;let d=0,h=0;["e-resize","ne-resize","se-resize"].includes(this.direction)?d=r.x-this.boundingBox.xMax:["w-resize","nw-resize","sw-resize"].includes(this.direction)&&(d=this.boundingBox.xMin-r.x),["n-resize","ne-resize","nw-resize"].includes(this.direction)?h=this.boundingBox.yMin-r.y:["s-resize","se-resize","sw-resize"].includes(this.direction)&&(h=r.y-this.boundingBox.yMax);let c=this.boundingBox.width?1+d/this.boundingBox.width:1,u=this.boundingBox.height?1+h/this.boundingBox.height:1;return this.keepRatio&&(["n-resize","s-resize"].includes(this.direction)?c=u:(["e-resize","w-resize"].includes(this.direction)||(c=Math.max(c,u)),u=c)),this.scaleElement(this.interactElementsGroup.id,c,u),this.model.symbolsSelected.forEach((i=>{this.scaleElement(i.id,c,u)})),{scaleX:c,scaleY:u}}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Je,"f").info("end",{point:i});const{scaleX:r,scaleY:s}=this.continue(i);this.behaviors.snaps.clearSnapToElementLines();const n=this.model.symbolsSelected.map((i=>i.clone()));this.model.symbolsSelected.forEach((i=>{this.applyToSymbol(i,this.transformOrigin,r,s),this.behaviors.renderer.drawSymbol(i),this.model.updateSymbol(i)}));const a=this.behaviors.extractStrokesFromSymbols(this.model.symbolsSelected);this.behaviors.recognizer.transformScale(a.map((i=>i.id)),r,s,this.transformOrigin.x,this.transformOrigin.y),this.behaviors.history.push(this.model,{scale:[{symbols:n,origin:Object.assign({},this.transformOrigin),scaleX:r,scaleY:s}]}),this.behaviors.selector.resetSelectedGroup(this.model.symbolsSelected),this.interactElementsGroup=void 0,this.behaviors.selector.showInteractElements(),this.behaviors.svgDebugger.apply()}))}}Je=new WeakMap;class OIRotationManager{constructor(r){qe.set(this,LoggerManager.getLogger(i.LoggerClass.TRANSFORMER)),__classPrivateFieldGet(this,qe,"f").info("constructor"),this.behaviors=r}get model(){return this.behaviors.model}applyToStroke(i,r,s){return i.pointers.forEach((i=>{const{x:n,y:a}=computeRotatedPoint(i,r,s);i.x=n,i.y=a})),i}applyToShape(r,s,n){switch(r.kind){case i.ShapeKind.Ellipse:return r.center=computeRotatedPoint(r.center,s,n),r.orientation=(r.orientation+n)%(2*Math.PI),r;case i.ShapeKind.Circle:return r.center=computeRotatedPoint(r.center,s,n),r;case i.ShapeKind.Polygon:return r.points.forEach((i=>{const{x:r,y:a}=computeRotatedPoint(i,s,n);i.x=r,i.y=a})),r;default:throw new Error(`Can't apply rotate on shape, kind unknow: ${JSON.stringify(r)}`)}}applyToEdge(r,s,n){switch(r.kind){case i.EdgeKind.Arc:return r.phi=(r.phi-n)%(2*Math.PI),r.center=computeRotatedPoint(r.center,s,n),r;case i.EdgeKind.Line:return r.start=computeRotatedPoint(r.start,s,n),r.end=computeRotatedPoint(r.end,s,n),r;case i.EdgeKind.PolyEdge:return r.points=r.points.map((i=>computeRotatedPoint(i,s,n))),r;default:throw new Error(`Can't apply rotate on edge, kind unknow: ${JSON.stringify(r)}`)}}applyOnText(i,r,s){var n;return i.rotation={degree:convertRadianToDegree(s)+((null===(n=i.rotation)||void 0===n?void 0:n.degree)||0),center:r},this.behaviors.texter.updateBounds(i)}applyOnGroup(i,r,s){return i.children.forEach((i=>this.applyToSymbol(i,r,s))),i}applyToSymbol(r,s,n){switch(r.type){case i.SymbolType.Stroke:return this.applyToStroke(r,s,n);case i.SymbolType.Shape:return this.applyToShape(r,s,n);case i.SymbolType.Edge:return this.applyToEdge(r,s,n);case i.SymbolType.Text:return this.applyOnText(r,s,n);case i.SymbolType.Group:return this.applyOnGroup(r,s,n);default:throw new Error(`Can't apply rotate on symbol, type unknow: ${JSON.stringify(r)}`)}}setTransformOrigin(i,r,s){this.behaviors.renderer.setAttribute(i,"transform-origin",`${r}px ${s}px`)}rotateElement(i,r){__classPrivateFieldGet(this,qe,"f").info("rotateElement",{id:i,degree:r}),this.behaviors.renderer.setAttribute(i,"transform",`rotate(${r})`)}start(r,s){__classPrivateFieldGet(this,qe,"f").info("start",{target:r}),this.interactElementsGroup=r.closest(`[role=${i.SvgElementRole.InteractElementsGroup}]`);const n=Box.createFromPoints(this.model.symbolsSelected.flatMap((i=>i.vertices)));this.center={x:n.xMin+n.width/2,y:n.yMid},this.origin=s,this.setTransformOrigin(this.interactElementsGroup.id,this.center.x,this.center.y),this.model.symbolsSelected.forEach((i=>{this.setTransformOrigin(i.id,this.center.x,this.center.y)})),this.behaviors.selector.hideInteractElements()}continue(i){if(__classPrivateFieldGet(this,qe,"f").info("continue",{point:i}),!this.interactElementsGroup)throw new Error("Can't rotate, you must call start before");let r=Math.round(convertRadianToDegree(computeAngleRadian(this.origin,this.center,i)));return r=this.behaviors.snaps.snapRotation(r),i.x-this.center.x<0&&(r=360-r),this.rotateElement(this.interactElementsGroup.id,r),this.model.symbolsSelected.forEach((i=>{this.rotateElement(i.id,r)})),r}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,qe,"f").info("end",{point:i});const r=convertDegreeToRadian(this.continue(i))%(2*Math.PI),s=this.model.symbolsSelected.map((i=>i.clone()));this.model.symbolsSelected.forEach((i=>{this.applyToSymbol(i,this.center,r),this.behaviors.renderer.drawSymbol(i),this.model.updateSymbol(i)}));const n=this.behaviors.extractStrokesFromSymbols(this.model.symbolsSelected);this.behaviors.recognizer.transformRotate(n.map((i=>i.id)),r,this.center.x,this.center.y),this.behaviors.history.push(this.model,{rotate:[{symbols:s,angle:r,center:Object.assign({},this.center)}]}),this.behaviors.selector.resetSelectedGroup(this.model.symbolsSelected),this.interactElementsGroup=void 0,this.behaviors.selector.showInteractElements(),this.behaviors.svgDebugger.apply()}))}}qe=new WeakMap;class OISelectionManager{constructor(r){Ze.set(this,LoggerManager.getLogger(i.LoggerClass.SELECTION)),Qe.set(this,"selecting-rect"),__classPrivateFieldGet(this,Ze,"f").info("constructor"),this.behaviors=r}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}get internalEvent(){return this.behaviors.internalEvent}get rotator(){return this.behaviors.rotator}get translator(){return this.behaviors.translator}get resizer(){return this.behaviors.resizer}get selectionBox(){if(this.startSelectionPoint&&this.endSelectionPoint)return Box.createFromPoints([this.startSelectionPoint,this.endSelectionPoint])}drawSelectingRect(i){this.clearSelectingRect();const r={id:__classPrivateFieldGet(this,Qe,"f"),fill:"transparent",stroke:"grey",opacity:"0.25"};this.renderer.appendElement(SVGBuilder.createRect(i,r))}clearSelectingRect(){this.renderer.clearElements({attrs:{id:__classPrivateFieldGet(this,Qe,"f")}})}getPoint(i){const{clientLeft:r,scrollLeft:s,clientTop:n,scrollTop:a}=this.renderer.parent,l=this.renderer.parent.getBoundingClientRect();return{x:i.clientX-l.left-r+s,y:i.clientY-l.top-n+a}}createTranslateRect(r){const s={role:i.SvgElementRole.Translate,style:"cursor:move",fill:"transparent",stroke:"transparent"},n={height:r.height,width:r.width,x:r.x,y:r.y},a=SVGBuilder.createRect(n,s),handler=i=>{i.preventDefault(),i.stopPropagation(),this.translator.continue(this.getPoint(i))},endHandler=i=>{i.preventDefault(),i.stopPropagation(),this.translator.end(this.getPoint(i)),this.renderer.layer.removeEventListener("pointermove",handler),this.renderer.layer.removeEventListener("pointercancel",endHandler),this.renderer.layer.removeEventListener("pointerleave",endHandler),this.renderer.layer.removeEventListener("pointerup",endHandler)};return a.addEventListener("pointerdown",(i=>{0===i.button&&1===i.buttons&&(i.preventDefault(),i.stopPropagation(),this.translator.start(i.target,this.getPoint(i)),this.renderer.layer.addEventListener("pointermove",handler),this.renderer.layer.addEventListener("pointercancel",endHandler),this.renderer.layer.addEventListener("pointerleave",endHandler),this.renderer.layer.addEventListener("pointerup",endHandler))})),a}createRotateGroup(r){const s=SVGBuilder.createGroup({role:i.SvgElementRole.Rotate,"vector-effect":"non-scaling-size",style:"cursor:pointer;",opacity:"1"}),n={x:r.x+r.width/2,y:r.y-40},a={role:i.SvgElementRole.Rotate,"stroke-width":"2",stroke:"black",fill:"white"};s.appendChild(SVGBuilder.createCircle(n,8,a));const d={role:i.SvgElementRole.Rotate,fill:"black"};s.appendChild(SVGBuilder.createCircle(n,4,d));const h={role:i.SvgElementRole.Rotate,stroke:"black","stroke-width":"2"};s.appendChild(SVGBuilder.createLine({x:n.x,y:n.y+8},{x:n.x,y:r.y-l},h));const handler=i=>{i.preventDefault(),i.stopPropagation(),this.rotator.continue(this.getPoint(i))},endHandler=i=>{i.preventDefault(),i.stopPropagation(),this.rotator.end(this.getPoint(i)),this.renderer.layer.removeEventListener("pointermove",handler),this.renderer.layer.removeEventListener("pointercancel",endHandler),this.renderer.layer.removeEventListener("pointerleave",endHandler),this.renderer.layer.removeEventListener("pointerup",endHandler)};return s.addEventListener("pointerdown",(i=>{0===i.button&&1===i.buttons&&(i.preventDefault(),i.stopPropagation(),this.rotator.start(i.target,this.getPoint(i)),this.renderer.layer.addEventListener("pointermove",handler),this.renderer.layer.addEventListener("pointercancel",endHandler),this.renderer.layer.addEventListener("pointerleave",endHandler),this.renderer.layer.addEventListener("pointerup",endHandler))})),s}createResizeGroup(r){const s=SVGBuilder.createGroup({role:i.SvgElementRole.Resize,"vector-effect":"non-scaling-size","stroke-width":"4",stroke:"#3e68ff"}),n={x:r.x-l,y:r.y-l},a={x:r.x+r.width+l,y:r.y-l},d={x:r.x+r.width+l,y:r.y+r.height+l},h={x:r.x-l,y:r.y+r.height+l},bindEl=(i,r)=>{const handler=i=>{i.preventDefault(),i.stopPropagation(),this.resizer.continue(this.getPoint(i))},endHandler=i=>{i.preventDefault(),i.stopPropagation(),this.resizer.end(this.getPoint(i)),this.renderer.layer.removeEventListener("pointermove",handler),this.renderer.layer.removeEventListener("pointercancel",endHandler),this.renderer.layer.removeEventListener("pointerleave",endHandler),this.renderer.layer.removeEventListener("pointerup",endHandler)};i.addEventListener("pointerdown",(i=>{0===i.button&&1===i.buttons&&(i.preventDefault(),i.stopPropagation(),this.resizer.start(i.target,r),this.renderer.layer.addEventListener("pointermove",handler),this.renderer.layer.addEventListener("pointercancel",endHandler),this.renderer.layer.addEventListener("pointerleave",endHandler),this.renderer.layer.addEventListener("pointerup",endHandler))}))};[{direction:"n-resize",p1:n,p2:a,transformOrigin:{x:r.x+r.width/2,y:r.y+r.height}},{direction:"e-resize",p1:a,p2:d,transformOrigin:{x:r.x,y:r.y+r.height/2}},{direction:"s-resize",p1:h,p2:d,transformOrigin:{x:r.x+r.width/2,y:r.y}},{direction:"w-resize",p1:n,p2:h,transformOrigin:{x:r.x+r.width,y:r.y+r.height/2}}].forEach((r=>{const n={role:i.SvgElementRole.Resize,"resize-direction":r.direction,"transform-origin":JSON.stringify(r.transformOrigin),style:`cursor:${r.direction};`},a=SVGBuilder.createLine(r.p1,r.p2,n);bindEl(a,r.transformOrigin),s.appendChild(a)}));return[{direction:"nw-resize",p:n,transformOrigin:{x:r.x+r.width,y:r.y+r.height}},{direction:"ne-resize",p:a,transformOrigin:{x:r.x,y:r.y+r.height}},{direction:"se-resize",p:d,transformOrigin:{x:r.x,y:r.y}},{direction:"sw-resize",p:h,transformOrigin:{x:r.x+r.width,y:r.y}}].forEach((r=>{const n={"stroke-width":"4",role:i.SvgElementRole.Resize,"resize-direction":r.direction,"transform-origin":JSON.stringify(r.transformOrigin),transform:"scale(1, 1)",fill:"white",style:`cursor:${r.direction};`},a=SVGBuilder.createCircle(r.p,5,n);bindEl(a,r.transformOrigin),s.appendChild(a)})),s}createInteractElementsGroup(r){if(__classPrivateFieldGet(this,Ze,"f").info("createInteractElementsGroup",{symbols:r}),!r.length)return;const s=r.map((i=>({symbol:i,element:this.renderer.getElementById(i.id)}))),n=Box.createFromBoxes(r.map((i=>({x:i.bounds.x-(i.style.width||1),y:i.bounds.y-(i.style.width||1),height:i.bounds.height+2*(i.style.width||1),width:i.bounds.width+2*(i.style.width||1)})))),a=Box.createFromPoints(r.flatMap((i=>i.vertices))),l=Box.createFromBoxes([n,a]),d={id:`selected-${Date.now()}`,role:i.SvgElementRole.InteractElementsGroup},h=SVGBuilder.createGroup(d);h.appendChild(this.createTranslateRect(l)),h.appendChild(this.createResizeGroup(l)),h.appendChild(this.createRotateGroup(l));const c={style:"pointer-events: none",fill:"transparent",stroke:"#3e68ff","stroke-width":"1","stroke-dasharray":"4","vector-effect":"non-scaling-size",transform:"rotate(0, 0, 0)"};return s.forEach((r=>{var s,n,a;if(r.element){const l={x:r.symbol.bounds.x-(r.symbol.style.width||1),y:r.symbol.bounds.y-(r.symbol.style.width||1),height:r.symbol.bounds.height+2*(r.symbol.style.width||1),width:r.symbol.bounds.width+2*(r.symbol.style.width||1)};if(r.symbol.type===i.SymbolType.Text){const i=r.symbol;c.transform=`rotate(${(null===(s=i.rotation)||void 0===s?void 0:s.degree)||0}, ${(null===(n=i.rotation)||void 0===n?void 0:n.center.x)||0}, ${(null===(a=i.rotation)||void 0===a?void 0:a.center.y)||0})`}else c.transform="rotate(0, 0, 0)";h.prepend(SVGBuilder.createRect(l,c))}})),h}drawSelectedGroup(i){if(i.length){if(this.selectedGroup=this.createInteractElementsGroup(i),this.selectedGroup){this.renderer.layer.appendChild(this.selectedGroup);const i=this.selectedGroup.getBBox();this.behaviors.menu.context.position.x=i.x+i.width/2-this.renderer.parent.clientLeft,this.behaviors.menu.context.position.y=i.y+i.height-this.renderer.parent.clientTop,this.behaviors.menu.context.show()}this.behaviors.menu.update()}}resetSelectedGroup(i){__classPrivateFieldGet(this,Ze,"f").info("resetSelectedGroup",{symbols:i}),this.removeSelectedGroup(),this.drawSelectedGroup(i)}removeSelectedGroup(){var i;__classPrivateFieldGet(this,Ze,"f").info("removeSelectedGroup"),this.behaviors.menu.context.hide(),null===(i=this.selectedGroup)||void 0===i||i.remove(),this.selectedGroup=void 0}hideInteractElements(){var r;this.behaviors.menu.context.hide();const s=`[role=${i.SvgElementRole.Resize}],[role=${i.SvgElementRole.Rotate}],[role=${i.SvgElementRole.Translate}]`;null===(r=this.selectedGroup)||void 0===r||r.querySelectorAll(s).forEach((i=>{i.setAttribute("visibility","hidden")}))}showInteractElements(){var r;this.behaviors.menu.context.show();const s=`[role=${i.SvgElementRole.Resize}],[role=${i.SvgElementRole.Rotate}],[role=${i.SvgElementRole.Translate}]`;null===(r=this.selectedGroup)||void 0===r||r.querySelectorAll(s).forEach((i=>i.setAttribute("visibility","visible")))}start(i){this.startSelectionPoint=i,this.endSelectionPoint=i,this.drawSelectingRect(this.selectionBox)}continue(i){if(!this.startSelectionPoint)throw new Error("You need to call startSelectionByBox before");this.endSelectionPoint=i;const r=[];return this.model.symbols.forEach((i=>{i.selected!==i.overlaps(this.selectionBox)&&(i.selected=i.overlaps(this.selectionBox),r.push(i),this.renderer.drawSymbol(i))})),this.drawSelectingRect(this.selectionBox),r}end(i){this.endSelectionPoint=i;const r=this.continue(i);return this.startSelectionPoint=void 0,this.endSelectionPoint=void 0,this.clearSelectingRect(),this.drawSelectedGroup(this.model.symbolsSelected),this.internalEvent.emitSelected(this.model.symbolsSelected),this.behaviors.menu.style.update(),r}}Ze=new WeakMap,Qe=new WeakMap;class OISnapManager{constructor(r,s){et.set(this,LoggerManager.getLogger(i.LoggerClass.CONVERTER)),__classPrivateFieldGet(this,et,"f").info("constructor"),this.behaviors=r,this.snapToElement=void 0===(null==s?void 0:s.element)||s.element,this.snapToGrid=void 0===(null==s?void 0:s.grid)||s.grid,this.snapAngle=void 0!==(null==s?void 0:s.angle)?s.angle:0}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}get selectionSnapPoints(){return Box.createFromPoints(this.model.symbolsSelected.flatMap((i=>i.snapPoints))).snapPoints}get otherSnapPoints(){const i=this.model.symbolsSelected.map((i=>i.id));return this.model.symbols.filter((r=>!i.includes(r.id))).flatMap((i=>i.snapPoints))}get snapThreshold(){return this.behaviors.configuration.rendering.guides.gap/2}getNearestVerticalGuide(i){return this.renderer.verticalGuides.length?this.renderer.verticalGuides.reduce(((r,s)=>Math.abs(s-i)<Math.abs(r-i)?s:r)):i}getNearestHorizontalGuide(i){return this.renderer.horizontalGuides.length?this.renderer.horizontalGuides.reduce(((r,s)=>Math.abs(s-i)<Math.abs(r-i)?s:r)):i}getGuidePointToSnap(i){return{x:this.getNearestVerticalGuide(i.x),y:this.getNearestHorizontalGuide(i.y)}}drawSnapToElementLines(i){const r={role:"snap-to-element",fill:"transparent",stroke:"blue","stroke-width":"2",style:ze.noSelection,"marker-start":`url(#${ze.crossMarker})`,"marker-end":`url(#${ze.crossMarker})`};i.forEach((i=>{this.renderer.drawLine(i.p1,i.p2,r)}))}clearSnapToElementLines(){this.renderer.clearElements({attrs:{role:"snap-to-element"}})}getSnapLinesInfos(i,r){const s={nudge:{x:1/0,y:1/0},verticales:[],horizontales:[]};return i.length&&r.length?(i.forEach((i=>{r.forEach((r=>{this.snapThreshold>Math.abs(r.x-i.x)&&(Math.abs(s.nudge.x)>Math.abs(r.x-i.x)?(s.nudge.x=r.x-i.x,s.verticales=[{p1:Object.assign({},i),p2:r}]):s.nudge.x===r.x-i.x&&s.verticales.push({p1:Object.assign({},i),p2:r})),this.snapThreshold>Math.abs(r.y-i.y)&&(Math.abs(s.nudge.y)>Math.abs(r.y-i.y)?(s.nudge.y=r.y-i.y,s.horizontales=[{p1:Object.assign({},i),p2:r}]):s.nudge.y===r.y-i.y&&s.horizontales.push({p1:Object.assign({},i),p2:r}))}))})),s):s}snapResize(i,r=!0,s=!0){if(this.clearSnapToElementLines(),!this.snapToElement&&!this.snapToGrid)return i;let n={x:1/0,y:1/0};this.snapToGrid&&(n=this.getGuidePointToSnap(i));const a=[];if(this.snapToElement){const l=this.getSnapLinesInfos([i],this.otherSnapPoints);r&&Math.abs(l.nudge.x)<=Math.abs(i.x-n.x)&&(n.x=i.x+l.nudge.x,a.push(...l.verticales)),s&&Math.abs(l.nudge.y)<=Math.abs(i.y-n.y)&&(n.y=i.y+l.nudge.y,a.push(...l.horizontales))}return n.x===1/0&&(n.x=i.x),n.y===1/0&&(n.y=i.y),a.forEach((i=>i.p1=n)),this.drawSnapToElementLines(a),n}snapTranslate(i,r){this.clearSnapToElementLines();const s={x:i,y:r};if(!this.snapToElement&&!this.snapToGrid)return s;const n=this.selectionSnapPoints.map((s=>({x:s.x+i,y:s.y+r})));let a=1/0,l=1/0;this.snapToGrid&&n.forEach((n=>{const d=this.getGuidePointToSnap(n);a>Math.abs(d.x-n.x)&&(s.x=d.x-n.x+i,a=Math.abs(d.x-n.x)),l>Math.abs(d.y-n.y)&&(s.y=d.y-n.y+r,l=Math.abs(d.y-n.y))}));const d=[];if(this.snapToElement){const h=this.getSnapLinesInfos(n,this.otherSnapPoints);a>=Math.abs(h.nudge.x)&&h.verticales.length&&(s.x=h.nudge.x+i,d.push(...h.verticales)),l>=Math.abs(h.nudge.y)&&h.horizontales.length&&(s.y=h.nudge.y+r,d.push(...h.horizontales))}return d.length&&(d.forEach((n=>{n.p1.x+=s.x-i,n.p1.y+=s.y-r})),this.drawSnapToElementLines(d)),s}snapRotation(i){return this.snapAngle>0?this.snapAngle*Math.round(i/this.snapAngle):i}}et=new WeakMap;class OITextManager{constructor(r){tt.set(this,LoggerManager.getLogger(i.LoggerClass.CONVERTER)),__classPrivateFieldGet(this,tt,"f").info("constructor"),this.behaviors=r}get renderer(){return this.behaviors.renderer}get rowHeight(){return this.behaviors.configuration.rendering.guides.gap}get model(){return this.behaviors.model}drawSymbolHidden(i){var r;const s=i.clone();s.id="text-to-measure",s.chars.forEach((i=>i.id+="to-measure")),null===(r=this.renderer.layer.querySelector(`#${s.id}`))||void 0===r||r.remove();const n=this.renderer.buildElementFromSymbol(s);return n.setAttribute("visibility","hidden"),this.renderer.prependElement(n),n}setCharsBounds(i,r){const s=r.querySelector("text");if(s)for(let r=0;r<s.getNumberOfChars();r++){const n=i.chars.at(r);if(n){const i=s.getExtentOfChar(r);n.bounds=new Box(i)}}return i}setBounds(i){const r=this.drawSymbolHidden(i);i.bounds=this.getElementBoundingBox(r),this.setCharsBounds(i,r)}getElementBoundingBox(i){return new Box(i.querySelector("text").getBBox({stroke:!0,markers:!0,clipped:!0,fill:!0}))}getBoundingBox(i){const r=this.drawSymbolHidden(i);return this.getElementBoundingBox(r)}getSpaceWidth(i){var r;const s=new Box({height:0,width:0,x:0,y:0}),n={id:"text-char-space",label:"-",color:"",fontSize:i,fontWeight:"normal",bounds:s};return null===(r=this.getBoundingBox(new OIText([n],{x:0,y:0},s)))||void 0===r?void 0:r.width}updateBounds(i){return this.setBounds(i),this.model.updateSymbol(i),i}moveTextAfter(r,s){const n=this.model.getSymbolsByRowOrdered().find((i=>i.rowIndex===this.model.getSymbolRowIndex(r)));if(n){const a=n.symbols.filter((s=>s.type===i.SymbolType.Text&&s.bounds.xMid>r.bounds.xMid));return a.forEach((i=>{i.point.x+=s,this.updateBounds(i),this.model.updateSymbol(i),this.renderer.drawSymbol(i)})),a}}}tt=new WeakMap;class OITranslateManager{constructor(r){it.set(this,LoggerManager.getLogger(i.LoggerClass.TRANSFORMER)),__classPrivateFieldGet(this,it,"f").info("constructor"),this.behaviors=r}get model(){return this.behaviors.model}applyToStroke(i,r,s){return i.pointers.forEach((i=>{i.x+=r,i.y+=s})),i}applyToShape(r,s,n){switch(r.kind){case i.ShapeKind.Ellipse:case i.ShapeKind.Circle:return r.center.x+=s,r.center.y+=n,r;case i.ShapeKind.Polygon:return r.points.forEach((i=>{i.x+=s,i.y+=n})),r;default:throw new Error(`Can't apply translate on shape, kind unknow: ${JSON.stringify(r)}`)}}applyToEdge(r,s,n){switch(r.kind){case i.EdgeKind.Arc:return r.center.x+=s,r.center.y+=n,r;case i.EdgeKind.Line:return r.start.x+=s,r.start.y+=n,r.end.x+=s,r.end.y+=n,r;case i.EdgeKind.PolyEdge:return r.points.forEach((i=>{i.x+=s,i.y+=n})),r}return r}applyOnText(i,r,s){return i.rotation&&(i.rotation.center={x:i.rotation.center.x+r,y:i.rotation.center.y+s}),i.point.x+=r,i.point.y+=s,this.behaviors.texter.updateBounds(i)}applyOnGroup(i,r,s){return i.children.forEach((i=>this.applyToSymbol(i,r,s))),i}applyToSymbol(r,s,n){switch(__classPrivateFieldGet(this,it,"f").info("applyToSymbol",{symbol:r,tx:s,ty:n}),r.type){case i.SymbolType.Stroke:return this.applyToStroke(r,s,n);case i.SymbolType.Shape:return this.applyToShape(r,s,n);case i.SymbolType.Edge:return this.applyToEdge(r,s,n);case i.SymbolType.Text:return this.applyOnText(r,s,n);case i.SymbolType.Group:return this.applyOnGroup(r,s,n);default:throw new Error(`Can't apply translate on symbol, type unknow: ${JSON.stringify(r)}`)}}translate(i,r,s,n=!0){__classPrivateFieldGet(this,it,"f").info("translate",{symbols:i,tx:r,ty:s}),i.forEach((i=>{this.applyToSymbol(i,r,s),this.model.updateSymbol(i),this.behaviors.renderer.drawSymbol(i)})),n&&this.behaviors.history.push(this.model,{translate:[{symbols:this.model.symbolsSelected,tx:r,ty:s}]});const a=this.behaviors.extractStrokesFromSymbols(i);return this.behaviors.recognizer.transformTranslate(a.map((i=>i.id)),r,s)}translateElement(i,r,s){__classPrivateFieldGet(this,it,"f").info("translateElement",{id:i,tx:r,ty:s}),this.behaviors.renderer.setAttribute(i,"transform",`translate(${r},${s})`)}start(r,s){__classPrivateFieldGet(this,it,"f").info("start",{origin:s}),this.interactElementsGroup=r.closest(`[role=${i.SvgElementRole.InteractElementsGroup}]`),this.transformOrigin=s,this.behaviors.selector.hideInteractElements()}continue(i){if(__classPrivateFieldGet(this,it,"f").info("continue",{point:i}),!this.interactElementsGroup)throw new Error("Can't translate, you must call start before");let r=i.x-this.transformOrigin.x,s=i.y-this.transformOrigin.y;const n=this.behaviors.snaps.snapTranslate(r,s);return r=n.x,s=n.y,this.translateElement(this.interactElementsGroup.id,r,s),this.model.symbolsSelected.forEach((i=>{this.translateElement(i.id,r,s)})),{tx:r,ty:s}}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,it,"f").info("end",{point:i});const{tx:r,ty:s}=this.continue(i);this.behaviors.snaps.clearSnapToElementLines(),this.translate(this.model.symbolsSelected,r,s),this.behaviors.selector.resetSelectedGroup(this.model.symbolsSelected),this.interactElementsGroup=void 0,this.behaviors.svgDebugger.apply()}))}}it=new WeakMap;class OIWriteManager{constructor(r){rt.set(this,LoggerManager.getLogger(i.LoggerClass.WRITE)),st.set(this,i.WriteTool.Pencil),this.detectGesture=!0,__classPrivateFieldGet(this,rt,"f").info("constructor"),this.behaviors=r}get tool(){return __classPrivateFieldGet(this,st,"f")}set tool(r){__classPrivateFieldSet(this,st,r,"f"),r!==i.WriteTool.Pencil?this.renderer.parent.classList.add("shape"):this.renderer.parent.classList.remove("shape"),this.behaviors.unselectAll()}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}get history(){return this.behaviors.history}get gestureManager(){return this.behaviors.gesture}get snaps(){return this.behaviors.snaps}get recognizer(){return this.behaviors.recognizer}needContextLessGesture(r){const s=new Box(r.bounds);return s.x-=l,s.y-=l,s.width+=20,s.height+=20,this.detectGesture&&this.model.symbols.some((r=>{switch(r.type){case i.SymbolType.Stroke:return!1;case i.SymbolType.Group:return!r.containsOnlyStroke()&&r.extractSymbols().some((i=>i.bounds.overlaps(s)));default:return r.bounds.overlaps(s)}}))}createCurrentSymbol(r,s,n){switch(__classPrivateFieldGet(this,rt,"f").debug("createCurrentSymbol",{pointer:r,style:s,pointerType:n}),this.tool){case i.WriteTool.Pencil:this.model.currentSymbol=new OIStroke(s,n);break;case i.WriteTool.Rectangle:this.model.currentSymbol=OIShapePolygon.createRectangleBetweenPoints(r,r,s);break;case i.WriteTool.Triangle:this.model.currentSymbol=OIShapePolygon.createTriangleBetweenPoints(r,r,s);break;case i.WriteTool.Parallelogram:this.model.currentSymbol=OIShapePolygon.createParallelogramBetweenPoints(r,r,s);break;case i.WriteTool.Rhombus:this.model.currentSymbol=OIShapePolygon.createRhombusBetweenPoints(r,r,s);break;case i.WriteTool.Circle:this.model.currentSymbol=OIShapeCircle.createBetweenPoints(r,r,s);break;case i.WriteTool.Ellipse:this.model.currentSymbol=OIShapeEllipse.createBetweenPoints(r,r,s);break;case i.WriteTool.Line:case i.WriteTool.Arrow:case i.WriteTool.DoubleArrow:{let n,a;this.tool===i.WriteTool.Arrow?a=i.EdgeDecoration.Arrow:this.tool===i.WriteTool.DoubleArrow&&(n=i.EdgeDecoration.Arrow,a=i.EdgeDecoration.Arrow),this.model.currentSymbol=new OIEdgeLine(r,r,n,a,s);break}default:throw new Error(`Can't create symbol, tool is unknow: "${this.tool}"`)}return this.updateCurrentSymbol(r)}updateCurrentSymbolShape(r){switch(this.tool){case i.WriteTool.Rectangle:OIShapePolygon.updateRectangleBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,r);break;case i.WriteTool.Triangle:OIShapePolygon.updateTriangleBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,r);break;case i.WriteTool.Parallelogram:OIShapePolygon.updateParallelogramBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,r);break;case i.WriteTool.Rhombus:OIShapePolygon.updateRhombusBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,r);break;case i.WriteTool.Circle:OIShapeCircle.updateBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,r);break;case i.WriteTool.Ellipse:OIShapeEllipse.updateBetweenPoints(this.model.currentSymbol,this.currentSymbolOrigin,r)}}updateCurrentSymbolEdge(r){const s=this.model.currentSymbol;if(s.kind===i.EdgeKind.Line)s.end=r}updateCurrentSymbol(r){if(__classPrivateFieldGet(this,rt,"f").debug("updateCurrentSymbol",{pointer:r}),!this.model.currentSymbol)throw new Error("Can't update current symbol because currentSymbol is undefined");switch(this.model.currentSymbol.type){case i.SymbolType.Stroke:this.model.currentSymbol.addPointer(r);break;case i.SymbolType.Shape:this.updateCurrentSymbolShape(r);break;case i.SymbolType.Edge:this.updateCurrentSymbolEdge(r)}return this.model.currentSymbol}start(r,s,n){__classPrivateFieldGet(this,rt,"f").info("startWriting",{style:r,pointer:s,pointerType:n});const a=s;if(this.tool!==i.WriteTool.Pencil){const{x:i,y:r}=this.snaps.snapResize(s);a.x=i,a.y=r}this.currentSymbolOrigin=a,this.createCurrentSymbol(a,r,n),this.renderer.drawSymbol(this.model.currentSymbol)}continue(r){__classPrivateFieldGet(this,rt,"f").info("continueWriting",{pointer:r});const s=r;if(this.tool!==i.WriteTool.Pencil){const{x:i,y:n}=this.snaps.snapResize(r);s.x=i,s.y=n}this.updateCurrentSymbol(s),this.renderer.drawSymbol(this.model.currentSymbol)}interactWithBackend(i){return __awaiter(this,void 0,void 0,(function*(){const r=i.clone();let s;if(this.needContextLessGesture(i)&&(s=yield this.gestureManager.getGestureFromContextLess(r)),s)this.history.pop(),this.recognizer.addStrokes([r],this.detectGesture),this.gestureManager.apply(r,s);else{const i=yield this.recognizer.addStrokes([r],this.detectGesture);i&&(this.history.pop(),this.gestureManager.apply(this.model.getRootSymbol(i.gestureStrokeId),i))}}))}end(r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,rt,"f").info("finishWriting",{pointer:r});const s=r;if(this.tool!==i.WriteTool.Pencil){const{x:i,y:n}=this.snaps.snapResize(r);s.x=i,s.y=n}const n=this.updateCurrentSymbol(s);this.model.currentSymbol=void 0,this.currentSymbolOrigin=void 0,this.snaps.clearSnapToElementLines(),this.renderer.drawSymbol(n),this.model.addSymbol(n),this.history.push(this.model,{added:[n]}),n.type===i.SymbolType.Stroke&&(yield this.interactWithBackend(n))}))}}rt=new WeakMap,st=new WeakMap;class OIEraseManager{constructor(r){nt.set(this,LoggerManager.getLogger(i.LoggerClass.WRITE)),__classPrivateFieldGet(this,nt,"f").info("constructor"),this.behaviors=r}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}start(i){__classPrivateFieldGet(this,nt,"f").info("startErase",{pointer:i}),this.currentEraser=new OIEraser,this.currentEraser.pointers.push(i),this.renderer.drawSymbol(this.currentEraser)}continue(i){if(__classPrivateFieldGet(this,nt,"f").info("continueErase",{pointer:i}),!this.currentEraser)throw new Error("Can't update current eraser because currentEraser is undefined");this.currentEraser.pointers.push(i),this.renderer.drawSymbol(this.currentEraser);const r={p1:this.currentEraser.pointers.at(-1),p2:this.currentEraser.pointers.at(-2)};this.model.symbols.forEach((i=>{i.isIntersected(r)&&(i.deleting=!0)})),this.model.symbolsToDelete.map((i=>this.renderer.drawSymbol(i)))}end(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,nt,"f").info("finishErasing",{pointer:i}),this.continue(i),this.renderer.removeSymbol(this.currentEraser.id),this.currentEraser=void 0,this.behaviors.removeSymbols(this.model.symbolsToDelete.map((i=>i.id)))}))}}nt=new WeakMap;class OIDebugSVGManager{constructor(r){ot.set(this,LoggerManager.getLogger(i.LoggerClass.SVGDEBUG)),at.set(this,!1),lt.set(this,!1),dt.set(this,!1),ht.set(this,!1),ct.set(this,!1),__classPrivateFieldGet(this,ot,"f").info("constructor"),this.behaviors=r}get model(){return this.behaviors.model}get renderer(){return this.behaviors.renderer}get snapPointsVisibility(){return __classPrivateFieldGet(this,at,"f")}set snapPointsVisibility(i){__classPrivateFieldSet(this,at,i,"f"),this.debugSnapPoints()}get verticesVisibility(){return __classPrivateFieldGet(this,lt,"f")}set verticesVisibility(i){__classPrivateFieldSet(this,lt,i,"f"),this.debugVertices()}get boundingBoxVisibility(){return __classPrivateFieldGet(this,dt,"f")}set boundingBoxVisibility(i){__classPrivateFieldSet(this,dt,i,"f"),__classPrivateFieldGet(this,dt,"f")?this.showBoundingBox():this.hideBoundingBox()}get recognitionBoxVisibility(){return __classPrivateFieldGet(this,ht,"f")}set recognitionBoxVisibility(i){__classPrivateFieldSet(this,ht,i,"f"),this.debugRecognitionBox()}get recognitionItemBoxVisibility(){return __classPrivateFieldGet(this,ct,"f")}set recognitionItemBoxVisibility(i){__classPrivateFieldSet(this,ct,i,"f"),this.debugRecognitionItemBox()}showSnapPoints(){__classPrivateFieldGet(this,ot,"f").info("showSnapPoints"),this.model.currentSymbol&&this.model.currentSymbol.snapPoints.forEach((i=>this.renderer.drawCircle(i,2,{fill:"blue",debug:"snap-points"}))),this.model.symbols.forEach((i=>i.snapPoints.forEach((i=>this.renderer.drawCircle(i,2,{fill:"blue",debug:"snap-points"})))))}hideSnapPoints(){__classPrivateFieldGet(this,ot,"f").info("hideSnapPoints"),this.renderer.clearElements({attrs:{debug:"snap-points"}})}debugSnapPoints(){this.hideSnapPoints(),this.snapPointsVisibility&&this.showSnapPoints()}showVertices(){__classPrivateFieldGet(this,ot,"f").info("showVertices"),this.model.currentSymbol&&this.model.currentSymbol.vertices.forEach((i=>this.renderer.drawCircle(i,2,{fill:"red",debug:"vertices"}))),this.model.symbols.forEach((i=>i.vertices.forEach((i=>this.renderer.drawCircle(i,2,{fill:"red",debug:"vertices"})))))}hideVertices(){__classPrivateFieldGet(this,ot,"f").info("hideVertices"),this.renderer.clearElements({attrs:{debug:"vertices"}})}debugVertices(){this.hideVertices(),this.verticesVisibility&&this.showVertices()}drawBoundingBox(r){const s={style:"pointer-events: none",fill:"transparent",stroke:"red","stroke-width":"1","stroke-dasharray":"5 5","vector-effect":"non-scaling-stroke",debug:"bounding-box"},n={style:"pointer-events: none",fill:"transparent",stroke:"orange","stroke-width":"1","stroke-dasharray":"0 5 0","vector-effect":"non-scaling-stroke",debug:"bounding-box"};r.forEach((r=>{const a=this.renderer.getElementById(r.id);if(a)if(r.type===i.SymbolType.Text){const i=r;let l="";i.rotation&&(l=`rotate(${i.rotation.degree}, ${i.rotation.center.x}, ${i.rotation.center.y})`),i.chars.forEach((i=>{const r=Object.assign(Object.assign({},n),{char:i.label,transform:l});a.insertAdjacentElement("beforebegin",SVGBuilder.createRect(i.bounds,r))}));const d=Object.assign(Object.assign({},s),{symbol:r.id,transform:l});a.insertAdjacentElement("beforebegin",SVGBuilder.createRect(r.bounds,d))}else{const i=Object.assign(Object.assign({},s),{symbol:r.id});a.insertAdjacentElement("beforebegin",SVGBuilder.createRect(r.bounds,i))}}))}showBoundingBox(){__classPrivateFieldGet(this,ot,"f").info("showBoundingBox"),this.model.currentSymbol&&this.drawBoundingBox([this.model.currentSymbol]),this.drawBoundingBox(this.model.symbols)}hideBoundingBox(){__classPrivateFieldGet(this,ot,"f").info("hideBoundingBox"),this.renderer.clearElements({attrs:{debug:"bounding-box"}})}debugBoundingBox(){this.hideBoundingBox(),this.boundingBoxVisibility&&this.showBoundingBox()}drawRecognitionBox(i,r){const s="green",n=SVGBuilder.createGroup({debug:"recognition-box"}),a=SVGBuilder.createRect(i,{fill:"transparent",stroke:s,style:ze.noSelection});n.appendChild(a);const l=SVGBuilder.createGroup({id:`infos-group-${createUUID()}`}),d=i.x+i.width;let h=i.y+10;null==r||r.forEach((i=>{l.appendChild(SVGBuilder.createText({x:d,y:h},i,{stroke:s,style:ze.noSelection})),h+=20})),n.appendChild(l),this.renderer.layer.appendChild(n);const c=l.getBBox(),u={width:c.width+10,height:c.height+10,x:c.x-5,y:c.y-5},p=SVGBuilder.createRect(u,{fill:"white",style:"cursor:move",stroke:s});l.prepend(p);const translateEl=r=>{r.preventDefault(),r.stopPropagation();const n=Number(this.renderer.getAttribute(l.id,"originX")),a=Number(this.renderer.getAttribute(l.id,"originY")),d=r.clientX-n,h=r.clientY-a;this.renderer.setAttribute(l.id,"transform",`translate(${d},${h})`);const c={width:u.width,height:u.height,x:u.x+d,y:u.y+h};this.renderer.removeSymbol(`connection-${l.id}`),this.renderer.drawConnectionBetweenBox(`connection-${l.id}`,i,c,{stroke:s,debug:"recognition-box-link"})};p.addEventListener("pointerdown",(i=>{i.preventDefault(),i.stopPropagation(),this.renderer.getAttribute(l.id,"originX")||(this.renderer.setAttribute(l.id,"originX",i.clientX.toString()),this.renderer.setAttribute(l.id,"originY",i.clientY.toString())),this.renderer.layer.addEventListener("pointermove",translateEl),this.renderer.layer.addEventListener("pointerup",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl))),this.renderer.layer.addEventListener("pointerleave",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl))),this.renderer.layer.addEventListener("pointercancel",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl)))}))}showRecognitionBox(){var r,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,ot,"f").info("showRecognitionBox"),yield this.behaviors.export(["application/vnd.myscript.jiix"]);const n=null===(r=this.model.exports)||void 0===r?void 0:r["application/vnd.myscript.jiix"];if(__classPrivateFieldGet(this,ot,"f").debug("showRecognitionBox",{jiix:n}),n){if(!n["bounding-box"])return void __classPrivateFieldGet(this,ot,"f").warn("drawRecognitionBox",'You must to enabled configuration.recognition.exports["bounding-box"]');null===(s=n.elements)||void 0===s||s.forEach((r=>{var s;switch(r.type){case"Node":if(r["bounding-box"]){const i=convertBoundingBoxMillimeterToPixel(r["bounding-box"]),s=["bounding-box","items","id"],n=Object.keys(r).filter((i=>!s.includes(i))).map((i=>`${i}: ${JSON.stringify(r[i])}`));this.drawRecognitionBox(i,n)}break;case"Text":null===(s=r.words)||void 0===s||s.forEach((i=>{if(null==i?void 0:i["bounding-box"]){const s=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);this.drawRecognitionBox(s,[`type: ${r.type}`,`candidates: ${JSON.stringify(i.candidates||[])}`])}}));break;case"Edge":if(r.kind===i.JIIXEdgeKind.PolyEdge){const i=[`type: ${r.type}`,`kind: ${r.kind}`];r.edges.forEach(((r,s)=>{let n=`edge-${s}: [{ x1: ${r.x1}, y2: ${r.y1} },{ x2: ${r.x2}, y2: ${r.y2} }]`;r.p1Decoration&&(n+=`, p1Decoration: ${r.p1Decoration}`),r.p2Decoration&&(n+=`, p2Decoration: ${r.p2Decoration}`),i.push(n)}));const s=convertBoundingBoxMillimeterToPixel(Box.createFromBoxes(r.edges.map((i=>i["bounding-box"]))));this.drawRecognitionBox(s,i)}else if(r["bounding-box"]){const i=convertBoundingBoxMillimeterToPixel(r["bounding-box"]),s=["bounding-box","items","id","ports","connected"],n=Object.keys(r).filter((i=>!s.includes(i))).map((i=>`${i}: ${JSON.stringify(r[i])}`));this.drawRecognitionBox(i,n)}break;default:__classPrivateFieldGet(this,ot,"f").warn("drawRecognitionBox",`Unknow jiix element type: ${r.type}`)}}))}}))}clearRecognitionBox(){__classPrivateFieldGet(this,ot,"f").info("clearRecognitionBox"),this.renderer.clearElements({attrs:{debug:"recognition-box"}}),this.renderer.clearElements({attrs:{debug:"recognition-box-link"}})}debugRecognitionBox(){return __awaiter(this,void 0,void 0,(function*(){this.clearRecognitionBox(),__classPrivateFieldGet(this,ht,"f")&&this.showRecognitionBox()}))}drawRecognitionItemBox(i,r,s){const n="blue",a=SVGBuilder.createGroup({debug:"recognition-item-box"}),l=SVGBuilder.createRect(i,{fill:"transparent",stroke:n,style:ze.noSelection});a.appendChild(l);const d=i.x;let h=i.y-14;const c=SVGBuilder.createGroup({id:`chars-group-${createUUID()}`});r&&c.appendChild(SVGBuilder.createText({x:d,y:h},`label: ${r}`,{fill:n,"font-size":14..toString(),style:ze.noSelection})),(null==s?void 0:s.length)&&(h+=14,c.appendChild(SVGBuilder.createText({x:d,y:h},`[${s.join(", ")}]`,{fill:n,"font-size":14..toString(),style:ze.noSelection}))),a.appendChild(c),this.renderer.layer.appendChild(a);const u=c.getBBox(),p={width:u.width+10,height:u.height+10,x:u.x-5,y:u.y-5},m=SVGBuilder.createRect(p,{fill:"white",style:"cursor:move",stroke:n});c.prepend(m);const translateEl=r=>{r.preventDefault(),r.stopPropagation();const s=Number(this.renderer.getAttribute(c.id,"originX")),a=Number(this.renderer.getAttribute(c.id,"originY")),l=r.clientX-s,d=r.clientY-a;this.renderer.setAttribute(c.id,"transform",`translate(${l},${d})`);const h={width:p.width,height:p.height,x:p.x+l,y:p.y+d};this.renderer.removeSymbol(`connection-${c.id}`),this.renderer.drawConnectionBetweenBox(`connection-${c.id}`,i,h,{stroke:n,debug:"recognition-item-box-link"})};m.addEventListener("pointerdown",(i=>{i.preventDefault(),i.stopPropagation(),this.renderer.getAttribute(c.id,"originX")||(this.renderer.setAttribute(c.id,"originX",i.clientX.toString()),this.renderer.setAttribute(c.id,"originY",i.clientY.toString())),this.renderer.layer.addEventListener("pointermove",translateEl)})),this.renderer.layer.addEventListener("pointerup",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl))),this.renderer.layer.addEventListener("pointerleave",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl))),this.renderer.layer.addEventListener("pointercancel",(()=>this.renderer.layer.removeEventListener("pointermove",translateEl)))}showRecognitionItemBox(){var r,s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,ot,"f").info("showRecognitionBoxItem"),yield this.behaviors.export(["application/vnd.myscript.jiix"]);const n=null===(r=this.model.exports)||void 0===r?void 0:r["application/vnd.myscript.jiix"];__classPrivateFieldGet(this,ot,"f").debug("showRecognitionBoxItem",{jiix:n}),n&&(null===(s=n.elements)||void 0===s||s.forEach((r=>{var s;switch(r.type){case"Text":null===(s=r.chars)||void 0===s||s.forEach((i=>{if(null==i?void 0:i["bounding-box"]){const r=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);this.drawRecognitionItemBox(r,i.label,i.candidates)}}));break;case"Node":if(null==r?void 0:r["bounding-box"]){const i=convertBoundingBoxMillimeterToPixel(r["bounding-box"]);this.drawRecognitionItemBox(i,r.kind)}break;case"Edge":if(r.kind===i.JIIXEdgeKind.PolyEdge)r.edges.forEach((i=>{const r=convertBoundingBoxMillimeterToPixel(i["bounding-box"]);this.drawRecognitionItemBox(r,i.kind)}));else if(r["bounding-box"]){const i=convertBoundingBoxMillimeterToPixel(r["bounding-box"]);this.drawRecognitionItemBox(i,r.kind)}break;default:__classPrivateFieldGet(this,ot,"f").warn("drawRecognitionBoxItem",`Unknow jiix element type: ${r.type}`)}})))}))}clearRecognitionItemBox(){__classPrivateFieldGet(this,ot,"f").info("clearRecognitionBoxItem"),this.renderer.clearElements({attrs:{debug:"recognition-item-box"}}),this.renderer.clearElements({attrs:{debug:"recognition-item-box-link"}})}debugRecognitionItemBox(){return __awaiter(this,void 0,void 0,(function*(){this.clearRecognitionItemBox(),__classPrivateFieldGet(this,ct,"f")&&this.showRecognitionItemBox()}))}apply(){this.debugBoundingBox(),this.debugVertices(),this.debugSnapPoints(),this.debugRecognitionBox(),this.debugRecognitionItemBox()}}ot=new WeakMap,at=new WeakMap,lt=new WeakMap,dt=new WeakMap,ht=new WeakMap,ct=new WeakMap;var ut='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';class OIMenu{constructor(){this.thicknessList=[{label:"S",value:1},{label:"M",value:2},{label:"L",value:4},{label:"XL",value:8}],this.fontSizeList=[{label:"Auto",value:0},{label:"S",value:.5},{label:"M",value:.75},{label:"L",value:1}],this.fontWeightList=[{label:"Auto",value:void 0},{label:"Normal",value:"normal"},{label:"Bold",value:"bold"}],this.colors=["#000000","#808080","#ffffff","transparent","#ff0000","#ff6400","#ffc800","#ffff00","#0000ff","#0064ff","#00c8ff","#00ffff","#008000","#00af00","#00e100","#00ff00"]}createToolTip(i,r,s="top"){i.classList.add("ms-tooltip");const n=document.createElement("span");return n.classList.add("ms-tooltip-content",s),n.textContent=r,i.appendChild(n),i}createWrapCollapsible(i,r){const s=document.createElement("div");s.classList.add("collapsible-wrapper");const n=document.createElement("div");n.classList.add("collapsible-header"),n.textContent=r;const a=document.createElement("span");a.classList.add("collapsible-header-icon"),a.innerHTML=ut,n.appendChild(a),n.style.setProperty("pointer","cursor");const l=document.createElement("div");return l.classList.add("collapsible-content"),n.addEventListener("pointerup",(()=>s.classList.toggle("active"))),s.appendChild(n),l.appendChild(i),s.appendChild(l),s}createSeparatorHorizontal(){const i=document.createElement("hr");return i.classList.add("separator"),i.classList.add("horizontal"),i}createSeparatorVertical(){const i=document.createElement("hr");return i.classList.add("separator"),i.classList.add("vertical"),i}createMenuItemBoolean(i){const r=document.createElement("div");r.classList.add("ms-menu-item",i.type);const s=document.createElement("span");s.textContent=i.label,r.appendChild(s);const n=document.createElement("input");return n.id=i.id,n.setAttribute("type","checkbox"),i.disabled&&(n.disabled=!0),"indeterminate"===i.initValue?n.indeterminate=!0:n.checked=i.initValue,n.addEventListener("change",(r=>i.callback(r.target.checked))),r.appendChild(n),r}createMenuItemSelect(i){const r=document.createElement("div");r.classList.add("ms-menu-item",i.type);const s=document.createElement("span");s.textContent=i.label,r.appendChild(s);const n=document.createElement("select");return n.id=i.id,i.disabled&&(n.disabled=!0),i.values.forEach((r=>{const s=r.value===i.initValue,a=new Option(r.label,r.value.toString(),s,s);n.appendChild(a)})),n.addEventListener("change",(r=>i.callback(r.target.value))),r.appendChild(n),r}createMenuItemButton(i){const r=document.createElement("button");return r.classList.add("ms-menu-item","ms-menu-button"),r.innerHTML=i.icon||i.label,r.addEventListener("pointerup",i.callback),i.tooltip?this.createToolTip(r,i.tooltip.label,i.tooltip.position):r}createMenuItemButtonList(i){const r=document.createElement("div");r.classList.add("ms-menu-item",i.type),r.id=i.id;const s=document.createElement("span");return s.textContent=i.label,r.appendChild(s),i.values.forEach((s=>{const n=document.createElement("button");i.disabled&&(n.disabled=!0),n.id=`${i.id}-${s.value}-btn`,i.initValue===s.value&&n.classList.add("active"),n.textContent=s.label,n.addEventListener("pointerup",(()=>{i.callback(s.value),r.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),n.classList.add("active")})),r.appendChild(n)})),r}createMenuItemColorList(i){const r=document.createElement("div");r.classList.add("ms-menu-item",i.type),r.id=i.id;const s=document.createElement("span");return s.textContent=i.label,r.appendChild(s),r.appendChild(this.createColorList(i)),r}createColorList(i){const r=document.createElement("div");return r.id=`${i.id}-list`,r.classList.add("ms-menu-row","color-list"),i.values.forEach((s=>{const n=document.createElement("button");i.disabled&&(n.disabled=!0),n.id=`${i.id}-${s.replace("#","")}-btn`,n.classList.add("ms-menu-button","square");const a=document.createElement("div");a.classList.add("color"),i.fill?(a.style.setProperty("background-color",s),a.style.setProperty("border","1px solid lightgrey")):(a.style.setProperty("background-color","transparent"),a.style.setProperty("border",`3px solid ${s}`)),"#ffffff"===s&&a.style.setProperty("border","1px solid black"),"transparent"===s&&a.style.setProperty("background-image","linear-gradient(45deg, #AAA 10%, transparent 20%, #AAA 30%, transparent 40%, #AAA 50%, transparent 60%, #AAA 70%, transparent 80%, #AAA 90%, transparent 100%)"),i.initValue===s&&n.classList.add("active"),n.appendChild(a),n.addEventListener("pointerup",(a=>{a.preventDefault(),a.stopPropagation(),i.callback(s),r.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),n.classList.add("active")})),r.appendChild(n)})),r}createMenuItem(i){switch(i.type){case"checkbox":return this.createMenuItemBoolean(i);case"select":return this.createMenuItemSelect(i);case"list":return this.createMenuItemButtonList(i);case"colors":return this.createMenuItemColorList(i);default:return this.createMenuItemButton(i)}}}var pt;class OIMenuSub{constructor(i){if(this.element=document.createElement("div"),this.element.classList.add("sub-menu"),this.element.appendChild(i.trigger),this.content=document.createElement("div"),i.menuTitle){const r=document.createElement("h3");r.classList.add("ms-menu-title"),r.textContent=i.menuTitle,this.content.appendChild(r)}this.content.classList.add("sub-menu-content",i.position),this.content.appendChild(i.subMenu),this.element.appendChild(this.content),i.trigger.addEventListener("pointerdown",(()=>this.toggle())),document.addEventListener("pointerdown",(i=>{this.element.contains(i.target)||this.close()}))}open(){this.content.classList.add("open")}close(){this.content.classList.remove("open")}toggle(){this.content.classList.toggle("open")}unwrap(){this.content.classList.remove("sub-menu-content"),this.element.insertAdjacentElement("beforebegin",this.content),this.element.style.display="none"}wrap(){this.content.classList.add("sub-menu-content"),this.element.appendChild(this.content),this.element.style.display="block"}}class OIMenuAction extends OIMenu{constructor(r,s="ms-menu-action"){super(),pt.set(this,LoggerManager.getLogger(i.LoggerClass.MENU)),this.guideGaps=[{label:"S",value:"25"},{label:"M",value:"50"},{label:"L",value:"100"},{label:"XL",value:"150"}],this.id=s,this.behaviors=r}get model(){return this.behaviors.model}get isMobile(){return this.behaviors.renderer.parent.clientWidth<700}createMenuClear(){return this.menuClear=document.createElement("button"),this.menuClear.id=`${this.id}-clear`,this.menuClear.classList.add("ms-menu-button","square"),this.menuClear.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M20 9L18.005 20.3463C17.8369 21.3026 17.0062 22 16.0353 22H7.96474C6.99379 22 6.1631 21.3026 5.99496 20.3463L4 9"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M21 6L15.375 6M3 6L8.625 6M8.625 6V4C8.625 2.89543 9.52043 2 10.625 2H13.375C14.4796 2 15.375 2.89543 15.375 4V6M8.625 6L15.375 6"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuClear.addEventListener("pointerup",(()=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.clear`),this.behaviors.clear()})),this.createToolTip(this.menuClear,"Clear","bottom")}createMenuLanguage(){const i=document.createElement("button");i.id=this.id,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M13 2.04932C13 2.04932 16 5.99994 16 11.9999C16 17.9999 13 21.9506 13 21.9506"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M11 21.9506C11 21.9506 8 17.9999 8 11.9999C8 5.99994 11 2.04932 11 2.04932"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path d="M2.62964 15.5H21.3704" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M2.62964 8.5H21.3704" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const r=document.createElement("select");r.classList.add("select-language"),r.id=`${this.id}-language`,getAvailableLanguageList(this.behaviors.configuration).then((i=>{const s=i.result;Object.keys(s).forEach((i=>{const n=i===this.behaviors.configuration.recognition.lang,a=new Option(s[i],i,n,n);r.appendChild(a)}))})),r.addEventListener("change",(i=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.selectLanguage`);const r=i.target.value;this.behaviors.changeLanguage(r)}));const s={trigger:i,subMenu:r,position:"bottom-right"};return this.menuLanguage=new OIMenuSub(s),this.menuLanguage.element}createMenuUndo(){return this.menuUndo=document.createElement("button"),this.menuUndo.id=`${this.id}-undo`,this.menuUndo.classList.add("ms-menu-button","square"),this.menuUndo.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M4.5 8C8.5 8 11 8 15 8C15 8 15 8 15 8C15 8 20 8 20 12.7059C20 18 15 18 15 18C11.5714 18 9.71429 18 6.28571 18"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M7.5 11.5C6.13317 10.1332 5.36683 9.36683 4 8C5.36683 6.63317 6.13317 5.86683 7.5 4.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuUndo.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,pt,"f").info(`${this.id}.undo`),yield this.behaviors.undo()})))),this.createToolTip(this.menuUndo,"Undo","bottom")}createMenuRedo(){return this.menuRedo=document.createElement("button"),this.menuRedo.id=`${this.id}-redo`,this.menuRedo.classList.add("ms-menu-button","square"),this.menuRedo.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M19.5 8C15.5 8 13 8 9 8C9 8 9 8 9 8C9 8 4 8 4 12.7059C4 18 9 18 9 18C12.4286 18 14.2857 18 17.7143 18"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M16.5 11.5C17.8668 10.1332 18.6332 9.36683 20 8C18.6332 6.63317 17.8668 5.86683 16.5 4.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuRedo.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,pt,"f").info(`${this.id}.redo`),yield this.behaviors.redo()})))),this.createToolTip(this.menuRedo,"Redo","bottom")}createMenuConvert(){return this.menuConvert=document.createElement("button"),this.menuConvert.id=`${this.id}-convert`,this.menuConvert.classList.add("ms-menu-button","square"),this.menuConvert.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M2 5H9M16 5H13.5M9 5L13.5 5M9 5V3M13.5 5C12.6795 7.73513 10.9612 10.3206 9 12.5929M4 17.5C5.58541 16.1411 7.376 14.4744 9 12.5929M9 12.5929C8 11.5 6.4 9.3 6 8.5M9 12.5929L12 15.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M13.5 21L14.6429 18M21.5 21L20.3571 18M14.6429 18L17.5 10.5L20.3571 18M14.6429 18H20.3571"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuConvert.addEventListener("pointerup",(()=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.convert`),this.behaviors.convert()})),this.createToolTip(this.menuConvert,"Convert","bottom")}createMenuGesture(){const r=document.createElement("button");r.id=`${this.id}-gesture`,r.classList.add("ms-menu-button","square"),r.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M18 7.5L18.9187 7.65312C20.0497 7.84162 20.791 8.94046 20.5423 10.0598L20.0143 12.4357C20.0048 12.4784 20 12.5223 20 12.5661C20 15.1904 20 17.5 20 17.5C20 17.5 20 17.5 20 17.5C20 19.5 18.4 21.5 16 21.5C14.1259 21.5 11.0119 21.5 9.41979 21.5C8.83594 21.5 8.28132 21.2449 7.90136 20.8016L3.35288 15.495C2.85811 14.9178 2.84375 14.0703 3.31868 13.4767V13.4767C3.93438 12.707 5.09624 12.6814 5.74526 13.4231L8 16V12.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M9 5L8.20966 5.13172C7.03189 5.32802 6.28739 6.50588 6.61542 7.65395L8 12.5"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M11 12.5L8.92263 4.60598C8.69579 3.744 9.25886 2.87352 10.1381 2.72699V2.72699C10.9097 2.59838 11.6523 3.07873 11.8514 3.83526L14 12"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M17 12.5L18 7.5L18.2475 6.01515C18.3869 5.17836 17.8216 4.38694 16.9848 4.24747V4.24747C16.16 4.11 15.3767 4.65763 15.2226 5.47955L14 12"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n';const s=document.createElement("div");s.classList.add("ms-menu-colmun");const n=[];for(const r in i.SurroundAction){const s=i.SurroundAction[r];n.push({label:r,value:s})}const a=[];for(const r in i.StrikeThroughAction){const s=i.StrikeThroughAction[r];a.push({label:r,value:s})}const l=[];for(const r in i.InsertAction){const s=i.InsertAction[r];l.push({label:r,value:s})}[{type:"checkbox",id:`${this.id}-gesture-detect`,label:"Detect gesture",initValue:this.behaviors.writer.detectGesture,callback:r=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.gesture-detect`,{value:r}),this.behaviors.writer.detectGesture=r,this.behaviors.intention=i.Intention.Write,this.behaviors.writer.tool=i.WriteTool.Pencil}},{type:"select",id:`${this.id}-gesture-surround`,label:"On surround",values:n,initValue:this.behaviors.gesture.surroundAction,callback:r=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.gesture-surround`,{value:r}),this.behaviors.gesture.surroundAction=r,this.behaviors.intention=i.Intention.Write,this.behaviors.writer.tool=i.WriteTool.Pencil}},{type:"select",id:`${this.id}-gesture-strikethrough`,label:"On strikethrough",values:a,initValue:this.behaviors.gesture.strikeThroughAction,callback:r=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.gesture-strikethrough`,{value:r}),this.behaviors.gesture.strikeThroughAction=r,this.behaviors.intention=i.Intention.Write,this.behaviors.writer.tool=i.WriteTool.Pencil}},{type:"select",id:`${this.id}-gesture-strikethrough`,label:"On insert",values:l,initValue:this.behaviors.gesture.insertAction,callback:r=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.gesture-InsertAction`,{value:r}),this.behaviors.gesture.insertAction=r,this.behaviors.intention=i.Intention.Write,this.behaviors.writer.tool=i.WriteTool.Pencil}}].forEach((i=>{s.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:r,menuTitle:"Gesture",subMenu:s,position:"right-top"}).element}createMenuGuide(){const i=document.createElement("button");i.id=`${this.id}-guide`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 21V3H21V21H3Z" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 16.5H12H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 12H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 7.5H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M16.5 3V12V21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M12 3V21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M7.5 3V21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const r=document.createElement("div");r.classList.add("ms-menu-colmun");[{type:"checkbox",id:`${this.id}-guide-enable`,label:"Show guide",initValue:this.behaviors.configuration.rendering.guides.enable,callback:i=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.guide-enable`,{value:i}),this.behaviors.configuration.rendering.guides.enable=i,this.behaviors.renderingConfiguration=this.behaviors.configuration.rendering}},{type:"select",id:`${this.id}-guide-type`,label:"Guide style",values:[{label:"Line",value:"line"},{label:"Grid",value:"grid"},{label:"Point",value:"point"}],initValue:this.behaviors.configuration.rendering.guides.type,callback:i=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.guide-type`,{value:i}),this.behaviors.configuration.rendering.guides.type=i,this.behaviors.renderingConfiguration=this.behaviors.configuration.rendering}},{type:"list",id:`${this.id}-guide-size`,label:"Guide style",values:this.guideGaps,initValue:this.behaviors.configuration.rendering.guides.gap.toString(),callback:i=>{__classPrivateFieldGet(this,pt,"f").info(`${this.id}.guide-size`,{value:i}),this.behaviors.configuration.rendering.guides.gap=+i,this.behaviors.renderingConfiguration=this.behaviors.configuration.rendering}}].forEach((i=>{r.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:i,menuTitle:"Guide",subMenu:r,position:"right-top"}).element}createMenuSnap(){const i=document.createElement("button");i.id=`${this.id}-snap`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M 19 14 C 17.8954 14 17 13.1046 17 12 C 17 10.8954 17.8954 10 19 10 C 20.1046 10 21 10.8954 21 12 C 21 13.1046 20.1046 14 19 14 Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path d="M 4 12 H 17 M 17 12 L 14 9 M 17 12 L 14 15" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const r=document.createElement("div");r.classList.add("ms-menu-colmun");[{type:"checkbox",id:`${this.id}-snap-to-guide`,label:"Snap to guide",initValue:this.behaviors.snaps.snapToGrid,callback:i=>this.behaviors.snaps.snapToGrid=i},{type:"checkbox",id:`${this.id}-snap-to-element`,label:"Snap to element",initValue:this.behaviors.snaps.snapToElement,callback:i=>this.behaviors.snaps.snapToElement=i},{type:"select",id:`${this.id}-snap-angle`,label:"Snap angle",values:[{label:"None",value:"0"},{label:"10",value:"10"},{label:"30",value:"30"},{label:"45",value:"45"},{label:"90",value:"90"},{label:"180",value:"180"}],initValue:this.behaviors.snaps.snapAngle.toString(),callback:i=>this.behaviors.snaps.snapAngle=+i}].forEach((i=>{r.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:i,menuTitle:"Snap",subMenu:r,position:"right-top"}).element}createMenuDebug(){const i=document.createElement("button");i.id=`${this.id}-debug`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  stroke-width="1"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M5.81249 7C5.81249 7 5.35861 7.62759 4.81552 8.66667M18.1875 7C18.1875 7 18.6414 7.62759 19.1845 8.66667M4.81552 8.66667C4.0067 10.2142 3 12.6743 3 15.3333C5.8125 15.3333 7.49999 17 7.49999 17C7.49999 17 8.62499 22 12 22C15.375 22 16.5 17 16.5 17C16.5 17 18.1875 15.3333 21 15.3333C21 12.6743 19.9933 10.2142 19.1845 8.66667M4.81552 8.66667C4.81552 8.66667 1.875 6.44436 4.81552 2C5.81249 2.55556 8.625 4.77778 8.625 4.77778C8.625 4.77778 10.3125 3.66667 12 3.66667C13.6875 3.66667 15.375 4.77778 15.375 4.77778C15.375 4.77778 18.1875 2.55556 19.3125 2C22.125 6.44456 19.1845 8.66667 19.1845 8.66667"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path d="M11 18L12 18M13 18L12 18M12 18L12 19" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M8.5 12.5L10 14" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M15.5 12.5L14 14" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const r=[{type:"checkbox",id:`${this.id}-debug-bounding-box`,label:"Show bounding box",initValue:this.behaviors.svgDebugger.boundingBoxVisibility,callback:i=>this.behaviors.svgDebugger.boundingBoxVisibility=i},{type:"checkbox",id:`${this.id}-debug-recognition-box`,label:"Show recognition box",initValue:this.behaviors.svgDebugger.recognitionBoxVisibility,callback:i=>this.behaviors.svgDebugger.recognitionBoxVisibility=i},{type:"checkbox",id:`${this.id}-debug-bounding-item-box`,label:"Show recognition item box",initValue:this.behaviors.svgDebugger.recognitionItemBoxVisibility,callback:i=>this.behaviors.svgDebugger.recognitionItemBoxVisibility=i},{type:"checkbox",id:`${this.id}-debug-snap-points`,label:"Show snap points",initValue:this.behaviors.svgDebugger.snapPointsVisibility,callback:i=>this.behaviors.svgDebugger.snapPointsVisibility=i},{type:"checkbox",id:`${this.id}-debug-vertices`,label:"Show vertices",initValue:this.behaviors.svgDebugger.verticesVisibility,callback:i=>this.behaviors.svgDebugger.verticesVisibility=i}],s=document.createElement("div");s.classList.add("ms-menu-colmun"),r.forEach((i=>{s.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:i,menuTitle:"Debug",subMenu:s,position:"right-top"}).element}createMenuExport(){const i=document.createElement("button");i.id=`${this.id}-export`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="#000000"\n>\n  <path d="M6 20L18 20" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M12 4V16M12 16L15.5 12.5M12 16L8.5 12.5" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const r=[{type:"button",id:`${this.id}-export-json`,label:"json",callback:()=>{this.behaviors.downloadAsJson()}},{type:"button",id:`${this.id}-export-svg`,label:"svg",callback:()=>{this.behaviors.downloadAsSVG()}},{type:"button",id:`${this.id}-export-png`,label:"png",callback:()=>{this.behaviors.downloadAsPNG()}}],s=document.createElement("div");s.classList.add("ms-menu-colmun"),r.forEach((i=>{s.appendChild(this.createMenuItem(i))}));return new OIMenuSub({trigger:i,menuTitle:"Export",subMenu:s,position:"right-top"}).element}readFileAsText(i){return __awaiter(this,void 0,void 0,(function*(){return new Promise(((r,s)=>{const n=new FileReader;n.onerror=s,n.onload=()=>{r(n.result)},i&&n.readAsText(i)}))}))}createMenuImport(){const i=document.createElement("button");i.id=`${this.id}-import`,i.classList.add("ms-menu-button","square"),i.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="#000000"\n>\n  <path d="M6 20L18 20" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M12 16V4M12 4L15.5 7.5M12 4L8.5 7.5" stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const r=document.createElement("div");r.classList.add("ms-menu-colmun");const s=document.createElement("input");s.type="file",s.accept=".json",s.multiple=!1,s.addEventListener("change",(()=>{var i;n.disabled=!(null===(i=s.files)||void 0===i?void 0:i.length)})),r.appendChild(s);const n=document.createElement("button");n.classList.add("ms-menu-button"),n.innerText="Import",n.disabled=!0,r.appendChild(n),n.addEventListener("pointerup",(i=>__awaiter(this,void 0,void 0,(function*(){var r;i.preventDefault(),i.stopPropagation();try{if(null===(r=s.files)||void 0===r?void 0:r.length){const i=yield this.readFileAsText(s.files[0]),r=JSON.parse(i);yield this.behaviors.createSymbols(r),s.value="",n.disabled=!0}}catch(i){this.behaviors.internalEvent.emitError(new Error(i))}}))));return new OIMenuSub({trigger:i,menuTitle:"Import",subMenu:r,position:"right-top"}).element}unselectAll(){var i;null===(i=this.wrapper)||void 0===i||i.querySelectorAll("*").forEach((i=>i.classList.remove("active")))}closeAllSubMenu(){var i;null===(i=this.wrapper)||void 0===i||i.querySelectorAll(".open").forEach((i=>i.classList.remove("open")))}render(i){if(this.behaviors.configuration.menu.action.enable){const r=document.createElement("button");r.id=this.id,r.classList.add("ms-menu-button","square"),r.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 5H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 12H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M3 19H21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const s=document.createElement("div");s.classList.add("ms-menu-colmun"),s.appendChild(this.createMenuGesture()),s.appendChild(this.createMenuGuide()),s.appendChild(this.createMenuSnap()),s.appendChild(this.createMenuDebug()),s.appendChild(this.createMenuImport()),s.appendChild(this.createMenuExport()),this.wrapper=document.createElement("div"),this.wrapper.classList.add("ms-menu","ms-menu-top-left","ms-menu-row"),this.wrapper.appendChild(new OIMenuSub({trigger:r,subMenu:s,position:"bottom"}).element),this.wrapper.appendChild(this.createMenuLanguage()),this.wrapper.appendChild(this.createMenuClear()),this.wrapper.appendChild(this.createMenuUndo()),this.wrapper.appendChild(this.createMenuRedo()),this.wrapper.appendChild(this.createMenuConvert()),i.appendChild(this.wrapper),this.update(),this.show()}}update(){this.menuLanguage&&(this.isMobile?this.menuLanguage.wrap():this.menuLanguage.unwrap()),this.menuClear&&(this.menuClear.disabled=this.behaviors.history.context.empty),this.menuUndo&&(this.menuUndo.disabled=!this.behaviors.history.context.canUndo),this.menuRedo&&(this.menuRedo.disabled=!this.behaviors.history.context.canRedo),this.menuConvert&&(this.menuConvert.disabled=!this.behaviors.extractStrokesFromSymbols(this.model.symbols).length)}show(){this.wrapper&&(this.wrapper.style.visibility="visible")}hide(){this.wrapper&&(this.wrapper.style.visibility="hidden")}destroy(){if(this.wrapper){for(;this.wrapper.lastChild;)this.wrapper.removeChild(this.wrapper.lastChild);this.wrapper.remove(),this.wrapper=void 0,this.menuClear=void 0,this.menuUndo=void 0,this.menuRedo=void 0,this.menuConvert=void 0}}}pt=new WeakMap;var mt,gt='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M 21 5 V 17.986 C 21 19 21 19 20 19 H 4 C 3 19 3 19 3.015 17.986 V 5 C 3 4 3 4 4 4 H 20.4 C 21 4 21 4 21 5 Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',vt='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 20L21 4" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';class OIMenuIntention extends OIMenu{constructor(r,s="ms-menu-intention"){super(),mt.set(this,LoggerManager.getLogger(i.LoggerClass.MENU)),this.id=s,__classPrivateFieldGet(this,mt,"f").info("constructor"),this.behaviors=r}createMenuWrite(){return this.writeBtn=document.createElement("button"),this.writeBtn.id=`${this.id}-write-pencil`,this.writeBtn.classList.add("ms-menu-button","square"),this.writeBtn.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M14.3632 5.65156L15.8431 4.17157C16.6242 3.39052 17.8905 3.39052 18.6716 4.17157L20.0858 5.58579C20.8668 6.36683 20.8668 7.63316 20.0858 8.41421L18.6058 9.8942M14.3632 5.65156L4.74749 15.2672C4.41542 15.5993 4.21079 16.0376 4.16947 16.5054L3.92738 19.2459C3.87261 19.8659 4.39148 20.3848 5.0115 20.33L7.75191 20.0879C8.21972 20.0466 8.65806 19.8419 8.99013 19.5099L18.6058 9.8942M14.3632 5.65156L18.6058 9.8942"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.writeBtn.addEventListener("pointerup",(()=>{this.unselectAll(),this.writeBtn.classList.add("active"),this.behaviors.intention=i.Intention.Write,this.behaviors.writer.tool=i.WriteTool.Pencil})),this.createToolTip(this.writeBtn,"Write")}createMenuMove(){return this.menuMove=document.createElement("button"),this.menuMove.id=`${this.id}-move`,this.menuMove.classList.add("ms-menu-button","square"),this.menuMove.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M7 10.5L4.99591 13.1721C4.41845 13.9421 4.47127 15.0141 5.1216 15.7236L8.9055 19.8515C9.28432 20.2647 9.81826 20.5 10.3789 20.5C11.4651 20.5 13.2415 20.5 15 20.5C17.4 20.5 19 19 19 16.5C19 16.5 19 16.5 19 16.5C19 16.5 19 9.64287 19 7.92859"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M16 8.49995C16 8.49995 16 8.37483 16 7.92852C16 5.6428 19 5.6428 19 7.92852"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M13 8.50008C13 8.50008 13 7.91978 13 7.02715M13 6.50008C13 6.50008 13 6.804 13 7.02715M16 8.50008C16 8.50008 16 8.37496 16 7.92865C16 7.70549 16 7.25031 16 7.02715C16 4.74144 13 4.74144 13 7.02715"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M13 8.50008C13 8.50008 13 7.91978 13 7.02715C13 4.74144 16 4.74144 16 7.02715C16 7.25031 16 7.70549 16 7.92865C16 8.37496 16 8.50008 16 8.50008"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M10 8.50005C10 8.50005 10 7.85719 10 6.50005C10 4.21434 13 4.21434 13 6.50005C13 6.50005 13 6.50005 13 6.50005C13 6.50005 13 6.80397 13 7.02713C13 7.91975 13 8.50005 13 8.50005"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M7 13.5001V6.50006C7 5.67164 7.67157 5.00006 8.5 5.00006V5.00006C9.32843 5.00006 10 5.55527 10 6.38369C10 6.42151 10 6.4603 10 6.50006C10 7.85721 10 8.50006 10 8.50006"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuMove.addEventListener("pointerup",(()=>{this.unselectAll(),this.menuMove.classList.add("active"),this.behaviors.intention=i.Intention.Move})),this.createToolTip(this.menuMove,"Move")}createMenuSelect(){return this.menuSelect=document.createElement("button"),this.menuSelect.id=`${this.id}-select`,this.menuSelect.classList.add("ms-menu-button","square"),this.menuSelect.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M4.9984 2H2V4.9984H4.9984V2Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M4.99854 3.50098H18.9987"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path d="M3.5 4.99854V19.0005" stroke="currentColor" stroke-width="1" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M20.4978 5V19.002" stroke="currentColor" stroke-width="1" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M4.99854 20.501H18.9987" stroke="currentColor" stroke-width="1" stroke-miterlimit="1.5" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path\n    d="M4.9984 19H2V21.9984H4.9984V19Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M21.9974 2.00195H18.999V5.00035H21.9974V2.00195Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    d="M21.9974 19.002H18.999V22.0004H21.9974V19.002Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    fill-rule="evenodd"\n    clip-rule="evenodd"\n    d="M10.9966 15.002L7.99658 8.00195L14.9966 11.002L11.9986 12.0009L10.9966 15.002Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n  <path\n    fill-rule="evenodd"\n    clip-rule="evenodd"\n    d="M11.999 12.002L14.997 15.002L11.999 12.002Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-miterlimit="1.5"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuSelect.addEventListener("pointerup",(()=>{this.unselectAll(),this.menuSelect.classList.add("active"),this.behaviors.intention=i.Intention.Select})),this.createToolTip(this.menuSelect,"Select")}createMenuErase(){return this.menuErase=document.createElement("button"),this.menuErase.id=`${this.id}-erase`,this.menuErase.classList.add("ms-menu-button","square"),this.menuErase.innerHTML='<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M21 21L9 21" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M15.889 14.8891L8.46436 7.46448" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path\n    d="M2.8934 12.6066L12.0858 3.41421C12.8668 2.63317 14.1332 2.63317 14.9142 3.41421L19.864 8.36396C20.645 9.14501 20.645 10.4113 19.864 11.1924L10.6213 20.435C10.2596 20.7968 9.76894 21 9.25736 21C8.74577 21 8.25514 20.7968 7.8934 20.435L2.8934 15.435C2.11235 14.654 2.11235 13.3877 2.8934 12.6066Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',this.menuErase.addEventListener("pointerup",(()=>{this.unselectAll(),this.menuErase.classList.add("active"),this.behaviors.intention=i.Intention.Erase})),this.createToolTip(this.menuErase,"Erase")}createShapeSubMenu(r,s){const n=document.createElement("button");return n.id=`${this.id}-write-shape-${s}`,n.classList.add("ms-menu-button","square"),n.innerHTML=r,n.addEventListener("pointerup",(()=>{this.unselectAll(),this.behaviors.intention=i.Intention.Write,this.behaviors.writer.tool=s,n.classList.add("active"),this.menuShape.innerHTML=r,this.menuShape.classList.add("active");const a=this.menuShape.nextSibling;a&&a.classList.remove("open")})),this.createToolTip(n,s.toString())}createMenuShape(){this.menuShape=document.createElement("button"),this.menuShape.id=`${this.id}-write-shape`,this.menuShape.classList.add("ms-menu-button","square"),this.menuShape.innerHTML=gt,this.subMenuShape={circle:this.createShapeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',i.WriteTool.Circle),rectangle:this.createShapeSubMenu(gt,i.WriteTool.Rectangle),triangle:this.createShapeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M11.4752 2.94682C11.7037 2.53464 12.2963 2.53464 12.5248 2.94682L21.8985 19.8591C22.1202 20.259 21.831 20.75 21.3738 20.75H2.62625C2.16902 20.75 1.87981 20.259 2.10146 19.8591L11.4752 2.94682Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',i.WriteTool.Triangle),ellipse:this.createShapeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M 12 19 C 18 19 22 17 22 12 C 22 7 18 5 12 5 C 6 5 2 7 2 12 C 2 17 6 19 12 19 Z"\n    stroke="currentColor"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',i.WriteTool.Ellipse),rhombus:this.createShapeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M11.5757 1.42426C11.81 1.18995 12.1899 1.18995 12.4243 1.42426L22.5757 11.5757C22.81 11.81 22.8101 12.1899 22.5757 12.4243L12.4243 22.5757C12.19 22.81 11.8101 22.8101 11.5757 22.5757L1.42426 12.4243C1.18995 12.19 1.18995 11.8101 1.42426 11.5757L11.5757 1.42426Z"\n    stroke="#000000"\n    stroke-width="1"\n    stroke-linecap="round"\n    stroke-linejoin="round"\n  ></path>\n</svg>\n',i.WriteTool.Rhombus)};const r=document.createElement("div");r.id=`${this.id}-write-shape-list`,r.classList.add("ms-menu-row","sub-menu-content-shape"),r.appendChild(this.subMenuShape.rectangle),r.appendChild(this.subMenuShape.circle),r.appendChild(this.subMenuShape.ellipse),r.appendChild(this.subMenuShape.triangle),r.appendChild(this.subMenuShape.rhombus);const s={trigger:this.menuShape,subMenu:r,position:"top"};return new OIMenuSub(s).element}createEdgeSubMenu(r,s){const n=document.createElement("button");return n.id=`${this.id}-write-edge-${s}`,n.classList.add("ms-menu-button","square"),n.innerHTML=r,n.addEventListener("pointerup",(()=>{this.unselectAll(),this.behaviors.intention=i.Intention.Write,this.behaviors.writer.tool=s,n.classList.add("active"),this.menuEdge.innerHTML=r,this.menuEdge.classList.add("active");const a=this.menuEdge.nextSibling;a&&a.classList.remove("open")})),this.createToolTip(n,s.toString())}createMenuEdge(){this.menuEdge=document.createElement("button"),this.menuEdge.id=`${this.id}-write-edge`,this.menuEdge.classList.add("ms-menu-button","square"),this.menuEdge.innerHTML=vt,this.subMenuEdge={line:this.createEdgeSubMenu(vt,i.WriteTool.Line),arrow:this.createEdgeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 20L21 4" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M15 5L21 4L 20 10" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n',i.WriteTool.Arrow),doubleArrow:this.createEdgeSubMenu('<svg\n  width="24px"\n  height="24px"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path d="M3 20L21 4" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M9 19L3 20L 4 14" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M15 5L21 4L 20 10" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n',i.WriteTool.DoubleArrow)};const r=document.createElement("div");r.id=`${this.id}-write-edge-list`,r.classList.add("ms-menu-row","sub-menu-content-edge"),r.appendChild(this.subMenuEdge.line),r.appendChild(this.subMenuEdge.arrow),r.appendChild(this.subMenuEdge.doubleArrow);const s={trigger:this.menuEdge,subMenu:r,position:"top"};return new OIMenuSub(s).element}unselectAll(){var i;null===(i=this.wrapper)||void 0===i||i.querySelectorAll("*").forEach((i=>i.classList.remove("active")))}update(){var r,s,n,a,l,d,h,c,u,p,m,g,v,y,f,b,x,S,w,_,P,E,k,M,C;switch(this.unselectAll(),this.behaviors.intention){case i.Intention.Erase:null===(r=this.menuErase)||void 0===r||r.classList.add("active");break;case i.Intention.Move:null===(s=this.menuMove)||void 0===s||s.classList.add("active");break;case i.Intention.Select:null===(n=this.menuSelect)||void 0===n||n.classList.add("active");break;case i.Intention.Write:switch(this.behaviors.writer.tool){case i.WriteTool.Circle:null===(a=this.menuShape)||void 0===a||a.classList.add("active"),null===(d=null===(l=this.subMenuShape)||void 0===l?void 0:l.circle)||void 0===d||d.classList.add("active");break;case i.WriteTool.Ellipse:null===(h=this.menuShape)||void 0===h||h.classList.add("active"),null===(u=null===(c=this.subMenuShape)||void 0===c?void 0:c.ellipse)||void 0===u||u.classList.add("active");break;case i.WriteTool.Triangle:null===(p=this.menuShape)||void 0===p||p.classList.add("active"),null===(g=null===(m=this.subMenuShape)||void 0===m?void 0:m.triangle)||void 0===g||g.classList.add("active");break;case i.WriteTool.Rectangle:null===(v=this.menuShape)||void 0===v||v.classList.add("active"),null===(f=null===(y=this.subMenuShape)||void 0===y?void 0:y.rectangle)||void 0===f||f.classList.add("active");break;case i.WriteTool.Line:null===(b=this.menuEdge)||void 0===b||b.classList.add("active"),null===(S=null===(x=this.subMenuEdge)||void 0===x?void 0:x.line)||void 0===S||S.classList.add("active");break;case i.WriteTool.Arrow:null===(w=this.menuEdge)||void 0===w||w.classList.add("active"),null===(P=null===(_=this.subMenuEdge)||void 0===_?void 0:_.arrow)||void 0===P||P.classList.add("active");break;case i.WriteTool.DoubleArrow:null===(E=this.menuEdge)||void 0===E||E.classList.add("active"),null===(M=null===(k=this.subMenuEdge)||void 0===k?void 0:k.doubleArrow)||void 0===M||M.classList.add("active");break;default:null===(C=this.writeBtn)||void 0===C||C.classList.add("active")}}}render(i){this.behaviors.configuration.menu.intention.enable&&(this.wrapper=document.createElement("div"),this.wrapper.classList.add("ms-menu","ms-menu-bottom","ms-menu-row"),this.wrapper.appendChild(this.createMenuWrite()),this.wrapper.appendChild(this.createMenuMove()),this.wrapper.appendChild(this.createMenuSelect()),this.wrapper.appendChild(this.createMenuErase()),this.wrapper.appendChild(this.createMenuEdge()),this.wrapper.appendChild(this.createMenuShape()),i.appendChild(this.wrapper),this.update(),this.show())}show(){this.wrapper&&(this.wrapper.style.visibility="visible")}hide(){this.wrapper&&(this.wrapper.style.visibility="hidden")}destroy(){if(this.wrapper){for(;this.wrapper.lastChild;)this.wrapper.removeChild(this.wrapper.lastChild);this.wrapper.remove(),this.writeBtn=void 0,this.menuSelect=void 0,this.menuMove=void 0,this.menuErase=void 0,this.menuShape=void 0,this.subMenuShape=void 0,this.menuEdge=void 0,this.subMenuEdge=void 0,this.wrapper=void 0}}}mt=new WeakMap;var yt,ft,bt;class OIMenuStyle extends OIMenu{constructor(r,s="ms-menu-style"){super(),yt.set(this,LoggerManager.getLogger(i.LoggerClass.MENU)),this.id=s,__classPrivateFieldGet(this,yt,"f").info("constructor"),this.behaviors=r}get model(){return this.behaviors.model}get symbolsSelected(){return this.model.symbolsSelected}get writeShape(){return![i.WriteTool.Arrow,i.WriteTool.DoubleArrow,i.WriteTool.Line,i.WriteTool.Pencil].includes(this.behaviors.writer.tool)}get rowHeight(){return this.behaviors.configuration.rendering.guides.gap}get isMobile(){return this.behaviors.renderer.parent.clientWidth<700}createMenuStroke(){var i,r;const s=this.symbolsSelected.map((i=>i.style)),n=s.length&&s.every((i=>{var r;return i.color===(null===(r=s[0])||void 0===r?void 0:r.color)})),a=n&&(null===(i=s[0])||void 0===i?void 0:i.color)?null===(r=s[0])||void 0===r?void 0:r.color:this.behaviors.currentPenStyle.color||"rgb(0, 0, 0)",l={type:"colors",label:"Colors",id:`${this.id}-color`,fill:!1,values:this.colors,initValue:a,callback:i=>{this.behaviors.setPenStyle({color:i}),this.behaviors.updateSymbolsStyle(this.symbolsSelected.map((i=>i.id)),{color:i})}},d=this.createColorList(l);return this.menuColorStroke=this.createWrapCollapsible(d,"Colors"),this.menuColorStroke.id=`${this.id}-color`,this.menuColorStroke}createMenuColorFill(){var i,r;const s=this.symbolsSelected.map((i=>i.style)),n=s.length&&s.every((i=>{var r;return i.color===(null===(r=s[0])||void 0===r?void 0:r.color)})),a=n&&(null===(i=s[0])||void 0===i?void 0:i.color)?null===(r=s[0])||void 0===r?void 0:r.color:this.behaviors.currentPenStyle.color||"rgb(0, 0, 0)",l={type:"colors",label:"Fill",id:`${this.id}-fill`,fill:!0,values:this.colors,initValue:a,callback:i=>{this.behaviors.setPenStyle({fill:i}),this.behaviors.updateSymbolsStyle(this.symbolsSelected.map((i=>i.id)),{fill:i})}},d=this.createColorList(l);return this.menuColorFill=this.createWrapCollapsible(d,"Fill"),this.menuColorFill.id=`${this.id}-fill`,this.menuColorFill}createMenuThickness(){var i;const r=document.createElement("div");r.id=`${this.id}-thickness-list`,r.classList.add("ms-menu-row","thickness-list");const s=this.symbolsSelected.map((i=>i.style)),n=s.length&&s.every((i=>{var r;return i.width===(null===(r=s[0])||void 0===r?void 0:r.width)})),a=n?null===(i=s[0])||void 0===i?void 0:i.width:this.behaviors.currentPenStyle.width||2;return this.thicknessList.forEach((i=>{const s=document.createElement("button");s.id=`${this.id}-thickness-${i.label}-btn`,s.classList.add("ms-menu-button","square"),s.textContent=i.label,a===i.value&&s.classList.add("active"),s.addEventListener("pointerup",(n=>{n.preventDefault(),n.stopPropagation(),this.behaviors.setPenStyle({width:i.value}),r.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),s.classList.add("active"),this.symbolsSelected.length&&(this.behaviors.updateSymbolsStyle(this.symbolsSelected.map((i=>i.id)),{width:i.value}),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected))})),r.appendChild(s)})),this.menuThickness=this.createWrapCollapsible(r,"Thickness"),this.menuThickness.id=`${this.id}-thickness`,this.menuThickness}createMenuFontSize(){const r=document.createElement("div");return r.id=`${this.id}-font-size-list`,r.classList.add("ms-menu-row","font-size-list"),this.fontSizeList.forEach((s=>{const n=document.createElement("button");n.id=`${this.id}-font-size-${s.label}-btn`,n.classList.add("ms-menu-button","square"),n.textContent=s.label,(this.behaviors.converter.fontSize||0)===s.value*this.rowHeight&&n.classList.add("active"),n.addEventListener("pointerup",(a=>{if(a.preventDefault(),a.stopPropagation(),r.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),n.classList.add("active"),0===s.value)this.behaviors.converter.fontSize=void 0;else{const r=s.value*this.rowHeight;this.behaviors.converter.fontSize=r;const n=this.symbolsSelected.filter((r=>r.type===i.SymbolType.Text||r.type===i.SymbolType.Group&&r.extractSymbols().some((r=>r.type===i.SymbolType.Text))));this.behaviors.updateTextFontStyle(n.map((i=>i.id)),{fontSize:r}),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}})),r.appendChild(n)})),this.menuFontSize=this.createWrapCollapsible(r,"Font size"),this.menuFontSize.id=`${this.id}-font-size`,this.menuFontSize}createMenuFontWeight(){const r=document.createElement("div");return r.id=`${this.id}-font-weight-list`,r.classList.add("ms-menu-row","font-weight-list"),this.fontWeightList.forEach((s=>{const n=document.createElement("button");n.id=`${this.id}-font-weight-${s.label}-btn`,n.classList.add("ms-menu-button","center"),n.textContent=s.label,this.behaviors.converter.fontWeight===s.value&&n.classList.add("active"),n.addEventListener("pointerup",(a=>{if(a.preventDefault(),a.stopPropagation(),r.querySelectorAll("*").forEach((i=>i.classList.remove("active"))),n.classList.add("active"),this.behaviors.converter.fontWeight=""===s.value?void 0:s.value,this.behaviors.converter.fontWeight){const r=this.symbolsSelected.filter((r=>r.type===i.SymbolType.Text||r.type===i.SymbolType.Group&&r.extractSymbols().some((r=>r.type===i.SymbolType.Text))));this.behaviors.updateTextFontStyle(r.map((i=>i.id)),{fontWeight:this.behaviors.converter.fontWeight}),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}})),r.appendChild(n)})),this.menuFontWeight=this.createWrapCollapsible(r,"Font weight"),this.menuFontWeight.id=`${this.id}-font-weight`,this.menuFontWeight}createMenuOpacity(){var i,r;const s=this.symbolsSelected.map((i=>i.style)),n=s.length&&s.every((i=>{var r;return i.opacity===(null===(r=s[0])||void 0===r?void 0:r.opacity)})),a=100*(n&&(null===(i=s[0])||void 0===i?void 0:i.opacity)?null===(r=s[0])||void 0===r?void 0:r.opacity:this.behaviors.currentPenStyle.opacity||1),l=document.createElement("div");l.id=`${this.id}-opacity-input-wrapper`;const d=document.createElement("input");d.id=`${this.id}-opacity-input`,d.setAttribute("name","opacity"),d.setAttribute("type","range"),d.setAttribute("step","1"),d.setAttribute("min","1"),d.setAttribute("max","100"),l.appendChild(d);const h=document.createElement("output");return h.setAttribute("for","opacity"),h.classList.add("tooltip"),h.innerHTML=a?`${a}`:"-",l.appendChild(h),a&&d.setAttribute("value",a.toString()),d.addEventListener("input",(i=>{const r=i.target.value;h.innerHTML=`${r}%`,this.behaviors.setPenStyle({opacity:r/100}),this.symbolsSelected.length&&this.behaviors.updateSymbolsStyle(this.symbolsSelected.map((i=>i.id)),{opacity:r/100})})),this.menuStrokeOpacity=this.createWrapCollapsible(l,"Opacity"),this.menuStrokeOpacity.id=`${this.id}-opacity`,this.menuStrokeOpacity}render(i){if(this.behaviors.configuration.menu.style.enable){this.triggerBtn=document.createElement("button"),this.triggerBtn.id=this.id,this.triggerBtn.classList.add("ms-menu-button","square"),this.triggerBtn.innerHTML='<svg\n  width="24px"\n  height="24px"\n  stroke-width="1"\n  viewBox="0 0 24 24"\n  fill="none"\n  xmlns="http://www.w3.org/2000/svg"\n  color="currentColor"\n>\n  <path\n    d="M20.5096 9.54C20.4243 9.77932 20.2918 9.99909 20.12 10.1863C19.9483 10.3735 19.7407 10.5244 19.5096 10.63C18.2796 11.1806 17.2346 12.0745 16.5002 13.2045C15.7659 14.3345 15.3733 15.6524 15.3696 17C15.3711 17.4701 15.418 17.9389 15.5096 18.4C15.5707 18.6818 15.5747 18.973 15.5215 19.2564C15.4682 19.5397 15.3588 19.8096 15.1996 20.05C15.0649 20.2604 14.8877 20.4403 14.6793 20.5781C14.4709 20.7158 14.2359 20.8085 13.9896 20.85C13.4554 20.9504 12.9131 21.0006 12.3696 21C11.1638 21.0006 9.97011 20.7588 8.85952 20.2891C7.74893 19.8194 6.74405 19.1314 5.90455 18.2657C5.06506 17.4001 4.40807 16.3747 3.97261 15.2502C3.53714 14.1257 3.33208 12.9252 3.36959 11.72C3.4472 9.47279 4.3586 7.33495 5.92622 5.72296C7.49385 4.11097 9.60542 3.14028 11.8496 3H12.3596C14.0353 3.00042 15.6777 3.46869 17.1017 4.35207C18.5257 5.23544 19.6748 6.49885 20.4196 8C20.6488 8.47498 20.6812 9.02129 20.5096 9.52V9.54Z"\n    stroke="currentColor"\n    stroke-width="1"\n  ></path>\n  <path d="M8 16.01L8.01 15.9989" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M6 12.01L6.01 11.9989" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M8 8.01L8.01 7.99889" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M12 6.01L12.01 5.99889" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n  <path d="M16 8.01L16.01 7.99889" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path>\n</svg>\n';const r=document.createElement("div");r.classList.add("ms-menu-colmun"),r.appendChild(this.createMenuStroke()),r.appendChild(this.createMenuColorFill()),r.appendChild(this.createMenuThickness()),r.appendChild(this.createMenuFontSize()),r.appendChild(this.createMenuFontWeight()),r.appendChild(this.createMenuOpacity());const s={trigger:this.triggerBtn,subMenu:r,position:"bottom-left"};this.subMenu=new OIMenuSub(s),this.wrapper=document.createElement("div"),this.wrapper.classList.add("ms-menu","ms-menu-top-right"),this.wrapper.appendChild(this.subMenu.element),i.appendChild(this.wrapper),this.update()}}update(){if(this.subMenu&&(this.isMobile?this.subMenu.wrap():this.subMenu.unwrap()),this.behaviors.intention===i.Intention.Write)this.show(),this.menuColorStroke&&(this.menuColorStroke.style.display="block"),this.menuColorFill&&(this.menuColorFill.style.display=this.writeShape?"block":"none"),this.menuThickness&&(this.menuThickness.style.display="block"),this.menuFontSize&&(this.menuFontSize.style.display="block"),this.menuFontWeight&&(this.menuFontWeight.style.display="block"),this.menuStrokeOpacity&&(this.menuStrokeOpacity.style.display="block");else if(this.behaviors.intention===i.Intention.Select){if(this.show(),this.menuColorStroke&&(this.menuColorStroke.style.display="block"),this.menuColorFill){const r=this.model.symbolsSelected.length&&this.model.symbolsSelected.some((r=>r.type===i.SymbolType.Shape));this.menuColorFill.style.display=r?"block":"none"}this.menuThickness&&(this.menuThickness.style.display="block"),this.menuFontSize&&(this.menuFontSize.style.display="block"),this.menuFontWeight&&(this.menuFontWeight.style.display="block"),this.menuStrokeOpacity&&(this.menuStrokeOpacity.style.display="block")}else this.hide()}show(){this.wrapper&&(this.wrapper.style.visibility="visible")}hide(){this.wrapper&&(this.wrapper.style.visibility="hidden")}destroy(){if(this.wrapper){for(;this.wrapper.lastChild;)this.wrapper.removeChild(this.wrapper.lastChild);this.wrapper.remove(),this.wrapper=void 0,this.subMenu=void 0,this.triggerBtn=void 0,this.menuColorStroke=void 0,this.menuColorFill=void 0,this.menuThickness=void 0,this.menuFontSize=void 0,this.menuFontWeight=void 0,this.menuStrokeOpacity=void 0}}}yt=new WeakMap;class OIMenuContext extends OIMenu{constructor(r,s="ms-menu-context"){super(),ft.set(this,LoggerManager.getLogger(i.LoggerClass.MENU)),this.id=s,__classPrivateFieldGet(this,ft,"f").info("constructor"),this.behaviors=r,this.position={x:0,y:0,scrollLeft:0,scrollTop:0}}get symbolsSelected(){return this.behaviors.model.symbolsSelected}get haveSymbolsSelected(){return this.symbolsSelected.length>0}get symbolsDecorable(){return this.symbolsSelected.filter((r=>[i.SymbolType.Stroke.toString(),i.SymbolType.Text.toString(),i.SymbolType.Group.toString()].includes(r.type)))}get showDecorator(){return this.symbolsDecorable.length>0}createMenuEdit(){const r=document.createElement("button");r.id=`${this.id}-edit-trigger`,r.classList.add("ms-menu-button");const s=document.createElement("span");s.innerText="Edit",r.appendChild(s);const n=document.createElement("span");n.style.setProperty("width","32px"),n.style.setProperty("transform","rotate(270deg)"),n.innerHTML=ut,r.appendChild(n);const a=document.createElement("div");a.classList.add("ms-menu-colmun"),this.editInput=document.createElement("input"),a.appendChild(this.editInput),this.editSaveBtn=document.createElement("button"),this.editSaveBtn.classList.add("ms-menu-button"),this.editSaveBtn.innerText="Save",a.appendChild(this.editSaveBtn),this.editSaveBtn.addEventListener("pointerdown",(r=>__awaiter(this,void 0,void 0,(function*(){r.stopPropagation();const s=this.behaviors.model.symbolsSelected.find((r=>r.type===i.SymbolType.Text));if(s){const i=s.chars[0];s.chars=[];for(let r=0;r<this.editInput.value.length;r++)s.chars.push({label:this.editInput.value.charAt(r),id:createUUID(),color:i.color,fontSize:i.fontSize,fontWeight:i.fontWeight,bounds:i.bounds});yield this.behaviors.updateSymbol(s),this.behaviors.selector.resetSelectedGroup([s])}}))));const l={trigger:r,subMenu:a,position:"right"};return this.editMenu=new OIMenuSub(l).element,this.editMenu}createMenuDuplicate(){return this.duplicateBtn=document.createElement("button"),this.duplicateBtn.id=`${this.id}-duplicate`,this.duplicateBtn.textContent="Duplicate",this.duplicateBtn.classList.add("ms-menu-button"),this.duplicateBtn.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){const r=this.symbolsSelected.map((r=>{const s=r.clone();for(;this.behaviors.model.symbols.find((i=>i.id===s.id));)if(s.id=s.id.slice(0,-36)+`-${createUUID()}`,s.type===i.SymbolType.Group){s.extractSymbols().forEach((i=>i.id=i.id.slice(0,-36)+`-${createUUID()}`))}return s.selected=!0,this.behaviors.translator.applyToSymbol(s,l,l),s}));this.behaviors.unselectAll(),yield this.behaviors.addSymbols(r),this.behaviors.selector.drawSelectedGroup(r)})))),this.duplicateBtn}createMenuGroup(){return this.groupBtn=document.createElement("button"),this.groupBtn.id=`${this.id}-duplicate`,this.groupBtn.textContent="Group",this.groupBtn.classList.add("ms-menu-button"),this.groupBtn.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){if(1===this.symbolsSelected.length&&this.symbolsSelected[0].type===i.SymbolType.Group){const i=this.behaviors.ungroupSymbol(this.symbolsSelected[0]);this.behaviors.select(i.map((i=>i.id)))}else{const i=this.symbolsSelected.slice();this.behaviors.unselectAll();const r=this.behaviors.groupSymbols(i);r.selected=!0,this.behaviors.select([r.id])}})))),this.groupBtn}createMenuConvert(){return this.convertBtn=document.createElement("button"),this.convertBtn.id=`${this.id}-convert`,this.convertBtn.textContent="Convert",this.convertBtn.classList.add("ms-menu-button"),this.convertBtn.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){try{this.behaviors.internalEvent.emitIdle(!1),yield this.behaviors.converter.apply(this.symbolsSelected)}catch(i){throw __classPrivateFieldGet(this,ft,"f").error("convert",i),this.behaviors.internalEvent.emitError(i),i}finally{this.behaviors.updateLayerInfos()}})))),this.convertBtn}createMenuRemove(){return this.removeBtn=document.createElement("button"),this.removeBtn.id=`${this.id}-remove`,this.removeBtn.textContent="Remove",this.removeBtn.classList.add("ms-menu-button"),this.removeBtn.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){this.behaviors.selector.removeSelectedGroup(),yield this.behaviors.removeSymbols(this.symbolsSelected.map((i=>i.id))),this.behaviors.menu.update()})))),this.removeBtn}createMenuReorder(){const i=document.createElement("button");i.id=`${this.id}-reorder`,i.classList.add("ms-menu-button");const r=document.createElement("span");r.innerText="Reorder",i.appendChild(r);const s=document.createElement("span");s.style.setProperty("width","32px"),s.style.setProperty("transform","rotate(270deg)"),s.innerHTML=ut,i.appendChild(s);const n=[{type:"button",id:`${this.id}-reorder-first`,label:"Bring to front",callback:()=>{this.behaviors.changeOrderSymbols(this.symbolsSelected,"last"),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}},{type:"button",id:`${this.id}-reorder-forward`,label:"Bring forward",callback:()=>{this.behaviors.changeOrderSymbols(this.symbolsSelected,"forward"),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}},{type:"button",id:`${this.id}-reorder-backward`,label:"Send backward",callback:()=>{this.behaviors.changeOrderSymbols(this.symbolsSelected,"backward"),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}},{type:"button",id:`${this.id}-reorder-last`,label:"Send to back",callback:()=>{this.behaviors.changeOrderSymbols(this.symbolsSelected.slice().reverse(),"first"),this.behaviors.selector.resetSelectedGroup(this.symbolsSelected)}}],a=document.createElement("div");a.classList.add("ms-menu-colmun"),n.forEach((i=>{a.appendChild(this.createMenuItem(i))}));const l={trigger:i,subMenu:a,position:"right"};return this.reorderMenu=new OIMenuSub(l).element,this.reorderMenu}createDecoratorSubMenu(i,r){const s=document.createElement("button");s.id=`${this.id}-decorator-${r}`,s.classList.add("ms-menu-button");const n=document.createElement("span");n.innerText=i,s.appendChild(n);const a=document.createElement("span");a.style.setProperty("width","32px"),a.style.setProperty("transform","rotate(270deg)"),a.innerHTML=ut,s.appendChild(a);const l=[{type:"checkbox",id:`${this.id}-decorator-${r}-enable`,label:"Enable",initValue:!1,callback:i=>{var s;this.symbolsDecorable.forEach((s=>{if(i)s.decorators.some((i=>i.kind===r))||s.decorators.push(new OIDecorator(r,this.behaviors.currentPenStyle));else{const i=s.decorators.findIndex((i=>i.kind===r));i>-1&&s.decorators.splice(i,1)}this.behaviors.model.updateSymbol(s),this.behaviors.renderer.drawSymbol(s)})),document.querySelectorAll(`#${this.id}-decorator-${r}-color button`).forEach((r=>{r.disabled=!i,r.classList.remove("active")})),i&&(null===(s=document.querySelector(`#${this.id}-decorator-${r}-color button`))||void 0===s||s.classList.add("active"))}},{type:"colors",label:"Colors",id:`${this.id}-decorator-${r}-color`,fill:!1,values:this.colors.filter(((i,r)=>!(r%4))),initValue:this.colors[0],disabled:!0,callback:i=>{this.symbolsDecorable.forEach((s=>{const n=s.decorators.find((i=>i.kind===r));n&&(n.style.color=i,this.behaviors.model.updateSymbol(s),this.behaviors.renderer.drawSymbol(s))}))}}],d=document.createElement("div");d.classList.add("ms-menu-colmun"),l.forEach((i=>{d.appendChild(this.createMenuItem(i))}));const h={trigger:s,subMenu:d,position:"right"};return this.decoratorMenu=new OIMenuSub(h).element}createMenuDecorator(){const r=document.createElement("button");r.id=`${this.id}-decorator`,r.classList.add("ms-menu-button");const s=document.createElement("span");s.innerText="Decorator",r.appendChild(s);const n=document.createElement("span");n.style.setProperty("width","32px"),n.style.setProperty("transform","rotate(270deg)"),n.innerHTML=ut,r.appendChild(n);const a=document.createElement("div");a.classList.add("ms-menu-colmun"),a.appendChild(this.createDecoratorSubMenu("Hightlight",i.DecoratorKind.Highlight)),a.appendChild(this.createDecoratorSubMenu("Surround",i.DecoratorKind.Surround)),a.appendChild(this.createDecoratorSubMenu("Underline",i.DecoratorKind.Underline)),a.appendChild(this.createDecoratorSubMenu("Strikethrough",i.DecoratorKind.Strikethrough));const l={trigger:r,subMenu:a,position:"right"};return this.decoratorMenu=new OIMenuSub(l).element,this.decoratorMenu}createMenuExport(){const i=document.createElement("button");i.id=`${this.id}-export`,i.classList.add("ms-menu-button");const r=document.createElement("span");r.innerText="Export",i.appendChild(r);const s=document.createElement("span");s.style.setProperty("width","32px"),s.style.setProperty("transform","rotate(270deg)"),s.innerHTML=ut,i.appendChild(s);const n=[{type:"button",id:`${this.id}-export-json`,label:"json",callback:()=>this.behaviors.downloadAsJson(this.haveSymbolsSelected)},{type:"button",id:`${this.id}-export-svg`,label:"svg",callback:()=>this.behaviors.downloadAsSVG(this.haveSymbolsSelected)},{type:"button",id:`${this.id}-export-png`,label:"png",callback:()=>this.behaviors.downloadAsPNG(this.haveSymbolsSelected)}],a=document.createElement("div");a.classList.add("ms-menu-colmun"),n.forEach((i=>{a.appendChild(this.createMenuItem(i))}));const l={trigger:i,subMenu:a,position:"right"};return this.menuExport=new OIMenuSub(l).element,this.menuExport}createMenuSelectAll(){const i=document.createElement("button");return i.id=`${this.id}-duplicate`,i.textContent="Select all",i.classList.add("ms-menu-button"),i.addEventListener("pointerup",(()=>__awaiter(this,void 0,void 0,(function*(){return this.behaviors.selectAll()})))),i}updateDecoratorSubMenu(){var r,s;this.showDecorator?(null===(r=this.decoratorMenu)||void 0===r||r.style.removeProperty("display"),Object.values(i.DecoratorKind).forEach((i=>{var r;const s=document.getElementById(`${this.id}-decorator-${i}-enable`);if(s){document.querySelectorAll(`#${this.id}-decorator-${i}-color button`).forEach((i=>i.classList.remove("active")));const n=this.symbolsDecorable.flatMap((i=>i.decorators)).filter((r=>r.kind===i));if(n.length&&n.every((i=>i.style.color===n[0].style.color))){const s=document.getElementById(`${this.id}-decorator-${i}-color-${null===(r=n[0].style.color)||void 0===r?void 0:r.replace("#","")}-btn`);null==s||s.classList.add("active")}this.symbolsDecorable.filter((r=>r.decorators.some((r=>r.kind===i)))).length===this.symbolsDecorable.length?(s.checked=!0,document.querySelectorAll(`#${this.id}-decorator-${i}-color button`).forEach((i=>{i.disabled=!1})),s.indeterminate=!1):this.symbolsDecorable.filter((r=>!r.decorators.some((r=>r.kind===i)))).length===this.symbolsDecorable.length?(s.checked=!1,document.querySelectorAll(`#${this.id}-decorator-${i}-color button`).forEach((i=>{i.disabled=!0})),s.indeterminate=!1):(s.setAttribute("indeterminate","true"),s.indeterminate=!0,document.querySelectorAll(`#${this.id}-decorator-${i}-color button`).forEach((i=>{i.disabled=!1})))}}))):null===(s=this.decoratorMenu)||void 0===s||s.style.setProperty("display","none")}updateGroupMenu(){var r;this.groupBtn&&this.haveSymbolsSelected?(this.groupBtn.style.removeProperty("display"),1===this.symbolsSelected.length&&this.symbolsSelected[0].type===i.SymbolType.Group?this.groupBtn.textContent="UnGroup":this.groupBtn.textContent="Group"):null===(r=this.groupBtn)||void 0===r||r.style.setProperty("display","none")}update(){var r,s,n,a,l,d,h,c,u,p,m,g,v,y,f;if(null===(r=this.wrapper)||void 0===r||r.style.setProperty("left",this.position.x-this.position.scrollLeft+"px"),null===(s=this.wrapper)||void 0===s||s.style.setProperty("top",this.position.y-this.position.scrollTop+"px"),this.haveSymbolsSelected){const r=this.behaviors.model.symbolsSelected.find((r=>r.type===i.SymbolType.Text));this.editMenu&&this.editInput&&1===this.behaviors.model.symbolsSelected.length&&r?(this.editMenu.style.removeProperty("display"),this.editInput.value=r.label):null===(n=this.editMenu)||void 0===n||n.style.setProperty("display","none"),this.behaviors.extractStrokesFromSymbols(this.symbolsSelected).length?null===(a=this.convertBtn)||void 0===a||a.style.removeProperty("display"):null===(l=this.convertBtn)||void 0===l||l.style.setProperty("display","none"),null===(d=this.reorderMenu)||void 0===d||d.style.removeProperty("display"),null===(h=this.duplicateBtn)||void 0===h||h.style.removeProperty("display"),null===(c=this.removeBtn)||void 0===c||c.style.removeProperty("display"),null===(u=this.menuExport)||void 0===u||u.style.removeProperty("display")}else null===(p=this.editMenu)||void 0===p||p.style.setProperty("display","none"),null===(m=this.convertBtn)||void 0===m||m.style.setProperty("display","none"),null===(g=this.reorderMenu)||void 0===g||g.style.setProperty("display","none"),null===(v=this.duplicateBtn)||void 0===v||v.style.setProperty("display","none"),null===(y=this.removeBtn)||void 0===y||y.style.setProperty("display","none"),null===(f=this.menuExport)||void 0===f||f.style.setProperty("display","none");this.updateDecoratorSubMenu(),this.updateGroupMenu()}render(i){var r;this.wrapper=document.createElement("div"),this.wrapper.id=`${this.id}-wrapper`,this.wrapper.classList.add("ms-menu","ms-menu-context"),this.wrapper.appendChild(this.createMenuEdit()),this.wrapper.appendChild(this.createMenuDecorator()),this.wrapper.appendChild(this.createMenuReorder()),this.wrapper.appendChild(this.createMenuExport()),this.wrapper.appendChild(this.createMenuConvert()),this.wrapper.appendChild(this.createMenuGroup()),this.wrapper.appendChild(this.createMenuDuplicate()),this.wrapper.appendChild(this.createMenuRemove()),this.wrapper.appendChild(this.createMenuSelectAll()),this.wrapper.style.setProperty("display","none"),i.appendChild(this.wrapper),null===(r=i.parentElement)||void 0===r||r.addEventListener("scroll",(()=>{var r,s;this.position.scrollLeft=(null===(r=i.parentElement)||void 0===r?void 0:r.scrollLeft)||0,this.position.scrollTop=(null===(s=i.parentElement)||void 0===s?void 0:s.scrollTop)||0,this.update()}))}show(){var i;this.update(),null===(i=this.wrapper)||void 0===i||i.style.setProperty("display","block")}hide(){var i;null===(i=this.wrapper)||void 0===i||i.style.setProperty("display","none")}destroy(){}}ft=new WeakMap;class OIMenuManager{constructor(r,s){if(bt.set(this,LoggerManager.getLogger(i.LoggerClass.MENU)),__classPrivateFieldGet(this,bt,"f").info("constructor"),this.behaviors=r,null==s?void 0:s.style){const i=s.style;this.style=new i(this.behaviors)}else this.style=new OIMenuStyle(this.behaviors);if(null==s?void 0:s.intention){const i=s.intention;this.intention=new i(this.behaviors)}else this.intention=new OIMenuIntention(this.behaviors);if(null==s?void 0:s.action){const i=s.action;this.action=new i(this.behaviors)}else this.action=new OIMenuAction(this.behaviors);if(null==s?void 0:s.context){const i=s.context;this.context=new i(this.behaviors)}else this.context=new OIMenuContext(this.behaviors)}render(i){this.behaviors.configuration.menu.enable&&(this.layer=i,this.behaviors.configuration.menu.action.enable&&this.action.render(this.layer),this.behaviors.configuration.menu.style.enable&&this.style.render(this.layer),this.behaviors.configuration.menu.intention.enable&&this.intention.render(this.layer),this.behaviors.configuration.menu.context.enable&&this.context.render(this.layer))}update(){this.action.update(),this.intention.update(),this.style.update()}show(){this.action.show(),this.intention.show(),this.style.show()}hide(){this.action.hide(),this.intention.hide(),this.style.hide()}destroy(){this.action.destroy(),this.intention.destroy(),this.style.destroy()}}bt=new WeakMap;class OIMoveManager{constructor(i){this.behaviors=i}get renderer(){return this.behaviors.renderer}start(i){this.origin={left:this.renderer.parent.scrollLeft,top:this.renderer.parent.scrollTop,x:i.clientX,y:i.clientY}}continue(i){if(!this.origin)throw new Error("Can't move cause origin is undefined");const r=i.clientX-this.origin.x,s=i.clientY-this.origin.y;this.renderer.parent.scrollTop=this.origin.top-s,this.renderer.parent.scrollLeft=this.origin.left-r}end(i){return __awaiter(this,void 0,void 0,(function*(){this.continue(i),this.origin=void 0}))}}const getInitialUndoRedoContext=()=>({stackIndex:0,possibleUndoCount:0,canRedo:!1,canUndo:!1,empty:!0});var xt,St,wt,_t,Pt,Et,kt,Mt,Ct,Gt,Tt,It,Lt,Ft,Ot,Dt,Rt,At,Bt,$t,Nt,zt,jt,Vt,Wt,Ht,Ut,Xt,Kt,Yt,Jt,qt,Zt,Qt,ei,ti,ii,ri,si,ni,oi,ai,li,di,hi,ci,ui,pi,mi,gi,vi,yi,fi,bi,xi,Si,wi,_i,Pi,Ei,ki,Mi,Ci,Gi,Ti,Ii,Li,Fi,Oi,Di,Ri,Ai,Bi,$i,Ni,zi,ji,Vi,Wi,Hi,Ui,Xi,Ki,Yi,Ji,qi,Zi;class HistoryManager{constructor(r){xt.set(this,LoggerManager.getLogger(i.LoggerClass.HISTORY)),__classPrivateFieldGet(this,xt,"f").info("constructor",{configuration:r}),this.configuration=r,this.context={stackIndex:0,possibleUndoCount:0,canRedo:!1,canUndo:!1,empty:!0},this.stack=[]}get internalEvent(){return InternalEvent.getInstance()}updateContext(){this.context.canRedo=this.stack.length-1>this.context.stackIndex,this.context.canUndo=this.context.stackIndex>0,this.context.empty=0===this.stack[this.context.stackIndex].symbols.length}push(i){__classPrivateFieldGet(this,xt,"f").info("push",{model:i}),this.context.stackIndex+1<this.stack.length&&this.stack.splice(this.context.stackIndex+1),this.stack.push(i.clone()),this.context.stackIndex=this.stack.length-1,this.stack.length>this.configuration.maxStackSize&&(this.stack.shift(),this.context.stackIndex--),this.updateContext(),this.internalEvent.emitContextChange(this.context)}updateStack(i){__classPrivateFieldGet(this,xt,"f").info("updateStack",{model:i});const r=this.stack.findIndex((r=>r.modificationDate===i.modificationDate));r>-1&&this.stack.splice(r,1,i.clone()),this.updateContext(),this.internalEvent.emitContextChange(this.context)}undo(){__classPrivateFieldGet(this,xt,"f").info("undo"),this.context.canUndo&&(this.context.stackIndex--,this.updateContext(),this.internalEvent.emitContextChange(this.context));const i=this.stack[this.context.stackIndex].clone();return __classPrivateFieldGet(this,xt,"f").debug("undo",i),i}redo(){__classPrivateFieldGet(this,xt,"f").info("redo"),this.context.canRedo&&(this.context.stackIndex++,this.updateContext(),this.internalEvent.emitContextChange(this.context));const i=this.stack[this.context.stackIndex].clone();return __classPrivateFieldGet(this,xt,"f").debug("redo",i),i}}xt=new WeakMap;class OIHistoryManager{constructor(r){St.set(this,LoggerManager.getLogger(i.LoggerClass.HISTORY)),__classPrivateFieldGet(this,St,"f").info("constructor",{configuration:r}),this.configuration=r,this.context={stackIndex:0,possibleUndoCount:0,canRedo:!1,canUndo:!1,empty:!0},this.stack=[]}get internalEvent(){return InternalEvent.getInstance()}updateContext(){this.context.canRedo=this.stack.length-1>this.context.stackIndex,this.context.canUndo=this.context.stackIndex>0,this.context.empty=0===this.stack[this.context.stackIndex].model.symbols.length}isChangesEmpty(i){var r,s,n,a,l,d,h,c,u,p,m,g,v,y,f;return!((null===(r=i.added)||void 0===r?void 0:r.length)||(null===(s=i.updated)||void 0===s?void 0:s.length)||(null===(n=i.erased)||void 0===n?void 0:n.length)||(null===(a=i.replaced)||void 0===a?void 0:a.oldSymbols.length)||(null===(l=i.matrix)||void 0===l?void 0:l.symbols.length)||(null===(d=i.translate)||void 0===d?void 0:d.length)||(null===(h=i.rotate)||void 0===h?void 0:h.length)||(null===(c=i.scale)||void 0===c?void 0:c.length)||(null===(p=null===(u=i.style)||void 0===u?void 0:u.symbols)||void 0===p?void 0:p.length)||(null===(g=null===(m=i.order)||void 0===m?void 0:m.symbols)||void 0===g?void 0:g.length)||(null===(v=i.decorator)||void 0===v?void 0:v.length)||(null===(y=i.group)||void 0===y?void 0:y.symbols.length)||(null===(f=i.ungroup)||void 0===f?void 0:f.group))}init(i){this.stack.push({model:i.clone(),changes:{}}),this.internalEvent.emitContextChange(this.context)}push(i,r){__classPrivateFieldGet(this,St,"f").info("push",{model:i,changes:r}),this.isChangesEmpty(r)||(this.context.stackIndex+1<this.stack.length&&this.stack.splice(this.context.stackIndex+1),this.stack.push({model:i.clone(),changes:r}),this.context.stackIndex=this.stack.length-1,this.stack.length>this.configuration.maxStackSize&&(this.stack.shift(),this.context.stackIndex--),this.updateContext(),this.internalEvent.emitContextChange(this.context))}pop(){__classPrivateFieldGet(this,St,"f").info("pop"),this.stack.pop(),this.context.stackIndex=this.stack.length-1,this.updateContext()}reverseChanges(i){var r,s,n;const a={};return i.added&&(a.erased=i.added),i.erased&&(a.added=i.erased),i.replaced&&(a.replaced={newSymbols:i.replaced.oldSymbols,oldSymbols:i.replaced.newSymbols}),i.matrix&&(a.matrix={symbols:i.matrix.symbols,matrix:new MatrixTransform(i.matrix.matrix.xx,i.matrix.matrix.yx,i.matrix.matrix.xy,i.matrix.matrix.yy,i.matrix.matrix.tx,i.matrix.matrix.ty).invert()}),(null===(r=i.translate)||void 0===r?void 0:r.length)&&(a.translate=i.translate.map((i=>({symbols:i.symbols,tx:-i.tx,ty:-i.ty})))),(null===(s=i.rotate)||void 0===s?void 0:s.length)&&(a.rotate=i.rotate.map((i=>({symbols:i.symbols,angle:2*Math.PI-i.angle,center:i.center})))),(null===(n=i.scale)||void 0===n?void 0:n.length)&&(a.scale=i.scale.map((i=>({symbols:i.symbols,origin:i.origin,scaleX:1/i.scaleX,scaleY:1/i.scaleY})))),a}undo(){__classPrivateFieldGet(this,St,"f").info("undo");const i=this.stack[this.context.stackIndex];this.context.canUndo&&(this.context.stackIndex--,this.updateContext(),this.internalEvent.emitContextChange(this.context));const r=this.stack[this.context.stackIndex];return __classPrivateFieldGet(this,St,"f").debug("undo",r),{model:r.model,changes:this.reverseChanges(i.changes)}}redo(){__classPrivateFieldGet(this,St,"f").info("redo"),this.context.canRedo&&(this.context.stackIndex++,this.updateContext(),this.internalEvent.emitContextChange(this.context));const i=this.stack[this.context.stackIndex];return __classPrivateFieldGet(this,St,"f").debug("redo",i),i}clear(){this.context={stackIndex:0,possibleUndoCount:0,canRedo:!1,canUndo:!1,empty:!0},this.stack=[]}}St=new WeakMap;class OIBehaviors{constructor(r,s){var n,a,l;this.name="OIBehaviors",wt.set(this,LoggerManager.getLogger(i.LoggerClass.BEHAVIORS)),_t.set(this,void 0),Pt.set(this,void 0),Et.set(this,void 0),kt.set(this,void 0),__classPrivateFieldGet(this,wt,"f").info("constructor",{options:r}),__classPrivateFieldSet(this,_t,new Configuration(null==r?void 0:r.configuration),"f"),this.layerInfos=s,this.styler=new StyleManager(Object.assign({},le,null==r?void 0:r.penStyle),null==r?void 0:r.theme),this.grabber=new OIPointerEventGrabber(__classPrivateFieldGet(this,_t,"f").grabber),this.recognizer=new OIRecognizer(__classPrivateFieldGet(this,_t,"f").server,__classPrivateFieldGet(this,_t,"f").recognition),this.renderer=new OISVGRenderer(__classPrivateFieldGet(this,_t,"f").rendering),this.history=new OIHistoryManager(__classPrivateFieldGet(this,_t,"f")["undo-redo"]),this.writer=new OIWriteManager(this),this.eraser=new OIEraseManager(this),this.gesture=new OIGestureManager(this,null===(n=r.behaviors)||void 0===n?void 0:n.gesture),this.resizer=new OIResizeManager(this),this.rotator=new OIRotationManager(this),this.translator=new OITranslateManager(this),this.converter=new OIConversionManager(this,r.fontStyle),this.texter=new OITextManager(this),this.selector=new OISelectionManager(this),this.svgDebugger=new OIDebugSVGManager(this),this.snaps=new OISnapManager(this,null===(a=r.behaviors)||void 0===a?void 0:a.snap),this.move=new OIMoveManager(this),this.menu=new OIMenuManager(this,null===(l=r.behaviors)||void 0===l?void 0:l.menu),__classPrivateFieldSet(this,Et,i.Intention.Write,"f"),__classPrivateFieldSet(this,Pt,new OIModel(__classPrivateFieldGet(this,_t,"f").rendering.minWidth,__classPrivateFieldGet(this,_t,"f").rendering.minHeight,this.configuration.rendering.guides.gap),"f")}get internalEvent(){return InternalEvent.getInstance()}get intention(){return __classPrivateFieldGet(this,Et,"f")}set intention(r){var s,n,a,l,d,h,c,u,p,m,g,v,y,f,b,x;switch(__classPrivateFieldSet(this,Et,r,"f"),__classPrivateFieldGet(this,Et,"f")){case i.Intention.Erase:null===(s=this.renderer.parent)||void 0===s||s.classList.remove("draw"),null===(n=this.renderer.parent)||void 0===n||n.classList.add("erase"),null===(a=this.renderer.parent)||void 0===a||a.classList.remove("select"),null===(l=this.renderer.parent)||void 0===l||l.classList.remove("move");break;case i.Intention.Select:null===(d=this.renderer.parent)||void 0===d||d.classList.remove("draw"),null===(h=this.renderer.parent)||void 0===h||h.classList.remove("erase"),null===(c=this.renderer.parent)||void 0===c||c.classList.add("select"),null===(u=this.renderer.parent)||void 0===u||u.classList.remove("move");break;case i.Intention.Move:null===(p=this.renderer.parent)||void 0===p||p.classList.remove("draw"),null===(m=this.renderer.parent)||void 0===m||m.classList.remove("erase"),null===(g=this.renderer.parent)||void 0===g||g.classList.remove("select"),null===(v=this.renderer.parent)||void 0===v||v.classList.add("move");break;default:null===(y=this.renderer.parent)||void 0===y||y.classList.add("draw"),null===(f=this.renderer.parent)||void 0===f||f.classList.remove("erase"),null===(b=this.renderer.parent)||void 0===b||b.classList.remove("select"),null===(x=this.renderer.parent)||void 0===x||x.classList.remove("move")}this.unselectAll()}get model(){return __classPrivateFieldGet(this,Pt,"f")}get configuration(){return __classPrivateFieldGet(this,_t,"f")}set renderingConfiguration(i){this.configuration.rendering=mergeDeep(this.configuration.rendering,i);const r=Math.max(this.renderer.parent.clientHeight,this.configuration.rendering.minHeight),s=Math.max(this.renderer.parent.clientWidth,this.configuration.rendering.minWidth);this.renderer.resize(r,s),this.model.rowHeight=this.configuration.rendering.guides.gap,this.history.stack.forEach((i=>i.model.rowHeight=this.model.rowHeight))}get currentPenStyle(){return this.styler.currentPenStyle}get penStyle(){return this.styler.penStyle}setPenStyle(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,wt,"f").info("setPenStyle",{penStyle:i}),this.styler.setPenStyle(Object.assign({},this.currentPenStyle,i)),Promise.resolve()}))}get penStyleClasses(){return this.styler.penStyleClasses}setPenStyleClasses(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,wt,"f").info("setPenStyleClasses",{penStyleClasses:i}),this.styler.setPenStyleClasses(i),Promise.resolve()}))}get theme(){return this.styler.theme}setTheme(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,wt,"f").info("setTheme",{theme:i}),this.styler.setTheme(i),Promise.resolve()}))}updateLayerInfos(){clearTimeout(__classPrivateFieldGet(this,kt,"f")),__classPrivateFieldSet(this,kt,setTimeout((()=>{this.menu.update(),this.svgDebugger.apply(),this.recognizer.waitForIdle()}),1500),"f")}onPointerDown(r,s){__classPrivateFieldGet(this,wt,"f").debug("onPointerDown",{evt:r,pointer:s}),this.internalEvent.emitIdle(!1);try{switch(this.unselectAll(),__classPrivateFieldGet(this,Et,"f")){case i.Intention.Erase:this.eraser.start(s);break;case i.Intention.Select:this.selector.start(s);break;case i.Intention.Move:this.move.start(r);break;default:this.writer.start(this.currentPenStyle,s,r.pointerType)}}catch(i){__classPrivateFieldGet(this,wt,"f").error("onPointerDown",i),this.grabber.stopPointerEvent(),this.internalEvent.emitError(i)}finally{this.svgDebugger.apply()}}onPointerMove(r,s){__classPrivateFieldGet(this,wt,"f").debug("onPointerMove",{pointer:s});try{switch(__classPrivateFieldGet(this,Et,"f")){case i.Intention.Erase:this.eraser.continue(s);break;case i.Intention.Select:this.selector.continue(s);break;case i.Intention.Move:this.move.continue(r);break;default:this.writer.continue(s)}}catch(i){__classPrivateFieldGet(this,wt,"f").error("onPointerMove",i),this.internalEvent.emitError(i)}finally{this.svgDebugger.apply()}}onPointerUp(r,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").debug("onPointerUp",{pointer:s});try{switch(__classPrivateFieldGet(this,Et,"f")){case i.Intention.Erase:this.eraser.end(s);break;case i.Intention.Select:this.selector.end(s);break;case i.Intention.Move:this.move.end(r);break;default:this.writer.end(s)}}catch(i){this.undo(),__classPrivateFieldGet(this,wt,"f").error("onPointerUp",i),this.internalEvent.emitError(i)}finally{this.updateLayerInfos()}}))}onContextMenu(r,s){return __awaiter(this,void 0,void 0,(function*(){if(this.intention===i.Intention.Select){let n=!1,a=r;const l=[i.SymbolType.Edge.toString(),i.SymbolType.Shape.toString(),i.SymbolType.Stroke.toString(),i.SymbolType.Text.toString()];for(;a&&"svg"!==a.tagName&&!n;)l.includes(a.getAttribute("type"))?n=!0:a=a.parentElement;this.unselectAll(),(null==a?void 0:a.id)?(this.model.selectSymbol(a.id),this.renderer.drawSymbol(this.model.symbolsSelected[0]),this.selector.drawSelectedGroup(this.model.symbolsSelected)):(this.menu.context.position.x=s.x+this.renderer.parent.clientLeft,this.menu.context.position.y=s.y+this.renderer.parent.clientTop,this.menu.context.show())}}))}init(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("init",{domElement:i}),this.renderer.init(i),this.menu.render(this.layerInfos),this.grabber.attach(this.renderer.layer),this.grabber.onPointerDown=this.onPointerDown.bind(this),this.grabber.onPointerMove=this.onPointerMove.bind(this),this.grabber.onPointerUp=this.onPointerUp.bind(this),this.grabber.onContextMenu=this.onContextMenu.bind(this),this.model.width=Math.max(i.clientWidth,__classPrivateFieldGet(this,_t,"f").rendering.minWidth),this.model.height=Math.max(i.clientHeight,__classPrivateFieldGet(this,_t,"f").rendering.minHeight),this.model.rowHeight=this.configuration.rendering.guides.gap,this.history.init(this.model),yield this.recognizer.init(),yield this.setPenStyle(this.penStyle),yield this.setTheme(this.theme),yield this.setPenStyleClasses(this.penStyleClasses)}))}changeLanguage(r){return __awaiter(this,void 0,void 0,(function*(){try{__classPrivateFieldGet(this,wt,"f").info("changeLanguage",{code:r}),this.internalEvent.emitIdle(!1),this.configuration.recognition.lang=r,yield this.recognizer.destroy(),this.recognizer=new OIRecognizer(__classPrivateFieldGet(this,_t,"f").server,__classPrivateFieldGet(this,_t,"f").recognition),yield this.recognizer.init(),yield this.recognizer.addStrokes(this.model.symbols.filter((r=>r.type===i.SymbolType.Stroke)),!1)}catch(i){throw __classPrivateFieldGet(this,wt,"f").error("changeLanguage",i),this.internalEvent.emitError(i),i}finally{this.updateLayerInfos()}}))}createShape(r){switch(r.kind){case i.ShapeKind.Circle:return OIShapeCircle.create(r);case i.ShapeKind.Ellipse:return OIShapeEllipse.create(r);case i.ShapeKind.Polygon:return OIShapePolygon.create(r);default:throw new Error(`Unable to create shape, kind: "${r.kind}" is unknown`)}}createEdge(r){switch(r.kind){case i.EdgeKind.Arc:return OIEdgeArc.create(r);case i.EdgeKind.Line:return OIEdgeLine.create(r);case i.EdgeKind.PolyEdge:return OIEdgePolyLine.create(r);default:throw new Error(`Unable to create edge, kind: "${r.kind}" is unknown`)}}createGroup(r){var s;if(!(null===(s=r.children)||void 0===s?void 0:s.length))throw new Error("Unable to create group, no children");const n=r.children.map((r=>{switch(null==r?void 0:r.type){case i.SymbolType.Stroke:return OIStroke.create(r);case i.SymbolType.Shape:return this.createShape(r);case i.SymbolType.Edge:return this.createEdge(r);case i.SymbolType.Text:return OIText.create(r);case i.SymbolType.Group:return this.createGroup(r);default:throw new Error(`Unable to create group, symbol type '${JSON.stringify(r)} is unknow`)}})),a=new OISymbolGroup(n,r.style);return r.id&&(a.id=r.id),r.decorators&&(a.decorators=r.decorators.map((i=>new OIDecorator(i.kind,i.style)))),a}createStroke(i){return OIStroke.create(i)}createText(i){return OIText.create(i)}createSymbol(r){return __awaiter(this,void 0,void 0,(function*(){try{switch(r.type){case i.SymbolType.Stroke:return yield this.addSymbol(this.createStroke(r));case i.SymbolType.Shape:return yield this.addSymbol(this.createShape(r));case i.SymbolType.Edge:return yield this.addSymbol(this.createEdge(r));case i.SymbolType.Text:return yield this.addSymbol(this.createText(r));case i.SymbolType.Group:return yield this.addSymbol(this.createGroup(r));default:throw new Error(`Unable to create symbol, type: "${r.type}" is unknown`)}}catch(i){throw __classPrivateFieldGet(this,wt,"f").error("createSymbol",i),this.updateLayerInfos(),this.internalEvent.emitError(i),i}}))}createSymbols(r){return __awaiter(this,void 0,void 0,(function*(){try{const s=[],n=[];if(r.forEach((r=>{try{switch(r.type){case i.SymbolType.Stroke:n.push(this.createStroke(r));break;case i.SymbolType.Shape:n.push(this.createShape(r));break;case i.SymbolType.Edge:n.push(this.createEdge(r));break;case i.SymbolType.Text:n.push(this.createText(r));break;case i.SymbolType.Group:n.push(this.createGroup(r));break;default:s.push(`Unable to create symbol, type: "${r.type}" is unknown`)}}catch(i){s.push(i.message||i)}})),s.length)throw new Error(s.join("\n"));return yield this.addSymbols(n)}catch(i){throw __classPrivateFieldGet(this,wt,"f").error("importPointEvents",i),this.internalEvent.emitError(i),i}}))}addSymbol(r,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("addSymbol",{sym:r}),this.internalEvent.emitIdle(!1),r.type===i.SymbolType.Text?this.texter.updateBounds(r):r.type===i.SymbolType.Group&&r.extractSymbols().forEach((r=>{r.type===i.SymbolType.Text&&this.texter.updateBounds(r)})),this.model.addSymbol(r),this.renderer.drawSymbol(r);const n=this.extractStrokesFromSymbols([r]);return this.recognizer.addStrokes(n,!1),s&&this.history.push(this.model,{added:[r]}),this.updateLayerInfos(),r}))}addSymbols(r,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("addSymbol",{symList:r}),this.internalEvent.emitIdle(!1),r.forEach((r=>{r.type===i.SymbolType.Text?this.texter.updateBounds(r):r.type===i.SymbolType.Group&&r.extractSymbols().forEach((r=>{r.type===i.SymbolType.Text&&this.texter.updateBounds(r)})),this.model.addSymbol(r),this.renderer.drawSymbol(r)}));const n=this.extractStrokesFromSymbols(r);return this.recognizer.addStrokes(n,!1),s&&this.history.push(this.model,{added:r}),this.updateLayerInfos(),r}))}updateSymbol(r,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("updateSymbol",{sym:r}),this.internalEvent.emitIdle(!1),r.type===i.SymbolType.Text?this.texter.updateBounds(r):r.type===i.SymbolType.Group&&r.extractSymbols().forEach((r=>{r.type===i.SymbolType.Text&&this.texter.updateBounds(r)})),this.model.updateSymbol(r),this.renderer.drawSymbol(r);const n=this.extractStrokesFromSymbols([r]);return this.recognizer.replaceStrokes(n.map((i=>i.id)),n),s&&this.history.push(this.model,{updated:[r]}),this.updateLayerInfos(),r}))}updateSymbols(r,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("updateSymbol",{symList:r}),this.internalEvent.emitIdle(!1),r.forEach((r=>{r.type===i.SymbolType.Text?this.texter.updateBounds(r):r.type===i.SymbolType.Group&&r.extractSymbols().forEach((r=>{r.type===i.SymbolType.Text&&this.texter.updateBounds(r)})),this.model.updateSymbol(r),this.renderer.drawSymbol(r)}));const n=this.extractStrokesFromSymbols(r);return this.recognizer.replaceStrokes(n.map((i=>i.id)),n),s&&this.history.push(this.model,{updated:r}),this.updateLayerInfos(),r}))}updateSymbolsStyle(r,s,n=!0){__classPrivateFieldGet(this,wt,"f").info("updateSymbolsStyle",{symbolIds:r,style:s});const a=[];this.model.symbols.forEach((n=>{r.includes(n.id)&&(n.style=Object.assign({},n.style,s),n.type===i.SymbolType.Text?n.chars.forEach((i=>{s.color&&(i.color=s.color)})):n.type===i.SymbolType.Group&&n.updateChildrenStyle(),this.renderer.drawSymbol(n),this.model.updateSymbol(n),n.modificationDate=Date.now(),a.push(n))})),a.length&&a.forEach((r=>{if(r.type===i.SymbolType.Text){const i=r.bounds.width;this.texter.updateBounds(r);const s=r.bounds.width-i;0!==s&&this.texter.moveTextAfter(r,s)}})),n&&a.length&&this.history.push(this.model,{style:{symbols:a,style:s}})}updateTextFontStyle(r,{fontSize:s,fontWeight:n}){__classPrivateFieldGet(this,wt,"f").info("updateTextFontStyle",{textIds:r,fontSize:s,fontWeight:n});const a=[],l=[];this.model.symbols.forEach((d=>{if(r.includes(d.id))if(d.type===i.SymbolType.Text){d.chars.forEach((i=>{s&&(i.fontSize=s),n&&(i.fontWeight=n)}));const i=d.bounds.width;this.texter.updateBounds(d),this.renderer.drawSymbol(d);const r=d.bounds.width-i;if(0!==r){const i=this.texter.moveTextAfter(d,r);(null==i?void 0:i.length)&&l.push({symbols:i,tx:r,ty:0})}d.modificationDate=Date.now(),a.push(d)}else d.type===i.SymbolType.Group&&d.extractSymbols().some((r=>r.type===i.SymbolType.Text))&&(d.extractSymbols().forEach((r=>{if(r.type===i.SymbolType.Text){r.chars.forEach((i=>{s&&(i.fontSize=s),n&&(i.fontWeight=n)}));const i=d.bounds.width;this.texter.updateBounds(r);const a=d.bounds.width-i,h=this.texter.moveTextAfter(r,a);(null==h?void 0:h.length)&&l.push({symbols:h,tx:a,ty:0}),r.modificationDate=Date.now()}})),d.modificationDate=Date.now(),this.renderer.drawSymbol(d),a.push(d))})),a.length&&this.history.push(this.model,{style:{symbols:a,fontSize:s},translate:l})}replaceSymbols(i,r,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("replaceSymbol",{oldSymbols:i,newSymbols:r}),this.internalEvent.emitIdle(!1);const n=this.extractStrokesFromSymbols(i),a=this.extractStrokesFromSymbols(r),l=i[0];l&&(this.model.replaceSymbol(l.id,r),this.renderer.replaceSymbol(l.id,r),i.slice(1).forEach((i=>{this.renderer.removeSymbol(i.id),this.model.removeSymbol(i.id)})),n.length&&a.length?this.recognizer.replaceStrokes(n.map((i=>i.id)),a):n.length?this.recognizer.eraseStrokes(n.map((i=>i.id))):this.recognizer.addStrokes(a,!1),s&&this.history.push(this.model,{replaced:{oldSymbols:i,newSymbols:r}}),this.updateLayerInfos())}))}changeOrderSymbol(i,r){this.model.changeOrderSymbol(i.id,r),this.renderer.changeOrderSymbol(i,r),this.history.push(this.model,{order:{symbols:[i],position:r}})}changeOrderSymbols(i,r){i.forEach((i=>{this.model.changeOrderSymbol(i.id,r),this.renderer.changeOrderSymbol(i,r)})),this.history.push(this.model,{order:{symbols:i,position:r}})}groupSymbols(i){const r=this.createGroup({children:i});return i.forEach((i=>{this.model.removeSymbol(i.id),this.renderer.removeSymbol(i.id)})),this.model.addSymbol(r),this.history.push(this.model,{group:{symbols:i}}),r}ungroupSymbol(i){return i.children.forEach((i=>this.renderer.drawSymbol(i))),this.renderer.removeSymbol(i.id),this.model.replaceSymbol(i.id,i.children),this.history.push(this.model,{ungroup:{group:i}}),i.children}groupStrokesByJIIXElement(){var r,s;return __awaiter(this,void 0,void 0,(function*(){yield this.export(["application/vnd.myscript.jiix"]);const n=this.model.symbols.filter((r=>r.type===i.SymbolType.Stroke)),a=null===(r=this.model.exports)||void 0===r?void 0:r["application/vnd.myscript.jiix"];null===(s=null==a?void 0:a.elements)||void 0===s||s.forEach((r=>{var s;if("Text"===r.type){null===(s=r.words)||void 0===s||s.forEach((r=>{var s,a;const l=n.filter((i=>{var s;return null===(s=r.items)||void 0===s?void 0:s.map((i=>i["full-id"])).includes(i.id)}));if(l.length){const n=[];let d=l[0].style;(null===(s=r.items)||void 0===s?void 0:s.length)!==l.length&&(null===(a=r.items)||void 0===a||a.forEach((r=>{const s=this.model.getRootSymbol(r["full-id"]);(null==s?void 0:s.type)===i.SymbolType.Group&&(n.push(...s.decorators),d=Object.assign({},d,s.style),l.push(...s.extractStrokes()),this.model.removeSymbol(s.id),this.renderer.removeSymbol(s.id))})));const h=this.createGroup({children:l,style:d});n.forEach((i=>{h.decorators.some((r=>r.kind===i.kind))||h.decorators.push(i)})),l.map((i=>{this.model.removeSymbol(i.id),this.renderer.removeSymbol(i.id)})),this.model.addSymbol(h),this.renderer.drawSymbol(h)}}))}else{const i=n.filter((i=>{var s;return null===(s=r.items)||void 0===s?void 0:s.map((i=>i["full-id"])).includes(i.id)}));if(i.length){const r=this.createGroup({children:i});i.map((i=>{this.model.removeSymbol(i.id),this.renderer.removeSymbol(i.id)})),this.model.addSymbol(r),this.renderer.drawSymbol(r)}}}))}))}removeSymbol(r,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("removeSymbol",{id:r});const n=this.model.getRootSymbol(r);if(n){if(this.internalEvent.emitIdle(!1),n.type===i.SymbolType.Group){const i=n.extractStrokes().map((i=>i.id));n.removeChilds([r]),n.children.length?(this.model.updateSymbol(n),this.renderer.drawSymbol(n),i.includes(r)&&this.recognizer.eraseStrokes([r])):(this.recognizer.eraseStrokes(i),this.model.removeSymbol(n.id),this.renderer.removeSymbol(n.id))}else this.recognizer.eraseStrokes([r]),this.model.removeSymbol(n.id),this.renderer.removeSymbol(n.id);s&&this.history.push(this.model,{erased:[n]}),this.updateLayerInfos()}else this.renderer.removeSymbol(r),this.recognizer.eraseStrokes([r])}))}removeSymbols(r,s=!0){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("removeSymbol",{ids:r});const n=[],a=[],l=[];if(r.forEach((s=>{const d=this.model.getRootSymbol(s);if(d)if(d.id===s)switch(n.push(d),d.type){case i.SymbolType.Stroke:l.push(d.id);break;case i.SymbolType.Group:l.push(...d.extractStrokes().map((i=>i.id)))}else{const i=d.clone();l.push(...i.extractStrokes().map((i=>i.id)).filter((i=>r.includes(i)))),i.removeChilds(r),i.children.length?a.push(i):n.push(i)}})),this.recognizer.eraseStrokes(l),n.forEach((i=>{this.model.removeSymbol(i.id),this.renderer.removeSymbol(i.id)})),a.forEach((i=>{this.model.updateSymbol(i),this.renderer.drawSymbol(i)})),s){const i={};(n.length||a.length)&&(n.length&&(i.erased=n),a.length&&(i.updated=a),this.history.push(this.model,i),this.updateLayerInfos())}return this.internalEvent.emitIdle(!1),n}))}select(i){this.selector.removeSelectedGroup(),this.model.symbols.forEach((r=>{r.selected=i.includes(r.id),this.renderer.drawSymbol(r)})),this.selector.drawSelectedGroup(this.model.symbolsSelected),this.internalEvent.emitSelected(this.model.symbolsSelected)}selectAll(){this.selector.removeSelectedGroup(),this.model.symbols.forEach((i=>{i.selected=!0,this.renderer.drawSymbol(i)})),this.selector.drawSelectedGroup(this.model.symbolsSelected),this.internalEvent.emitSelected(this.model.symbolsSelected)}unselectAll(){this.menu.context.hide(),this.menu.update(),this.model.symbolsSelected.length&&(this.model.symbolsSelected.forEach((i=>{i.selected=!1,this.renderer.drawSymbol(i)})),this.selector.removeSelectedGroup(),this.internalEvent.emitSelected(this.model.symbolsSelected))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,wt,"f").info("importPointEvents",{partialStrokes:i}),this.internalEvent.emitIdle(!1);const r=convertPartialStrokesToOIStrokes(i);return r.forEach((i=>{this.model.addSymbol(i),this.renderer.drawSymbol(i)})),this.recognizer.addStrokes(r,!1),this.history.push(this.model,{added:r}),__classPrivateFieldGet(this,wt,"f").debug("importPointEvents",this.model),this.updateLayerInfos(),this.model}))}triggerDownload(i,r){const s=document.createElement("a");s.setAttribute("href",r),s.setAttribute("download",i),document.body.appendChild(s),s.click(),s.remove()}getSymbolsBounds(i,r=10){const s=Box.createFromBoxes(i.map((i=>i.bounds)));return s.x-=r,s.y-=r,s.width+=2*r,s.height+=2*r,s}buildBlobFromSymbols(i,r){const s=SVGBuilder.createLayer(r);i.forEach((i=>{var r;const n=null===(r=this.renderer.getElementById(i.id))||void 0===r?void 0:r.cloneNode(!0);n&&s.appendChild(n)}));const n=(new XMLSerializer).serializeToString(s);return new Blob([n],{type:"image/svg+xml;charset=utf-8"})}getExportName(i){const r={year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"};try{return`iink-ts-${(new Date).toLocaleDateString(navigator.language,r)}.${i}`}catch(s){return`iink-ts-${(new Date).toLocaleDateString("en-US",r)}.${i}`}}downloadAsSVG(i=!1){const r=i?this.model.symbolsSelected:this.model.symbols,s=this.getSymbolsBounds(r),n=this.buildBlobFromSymbols(r,s),a=URL.createObjectURL(n);this.triggerDownload(this.getExportName("svg"),a)}downloadAsPNG(i=!1){const r=i?this.model.symbolsSelected:this.model.symbols,s=this.getSymbolsBounds(r),n=this.buildBlobFromSymbols(r,s),a=URL.createObjectURL(n),l=new Image;l.width=s.width,l.height=s.height,l.src=a,l.onload=()=>{const i=document.createElement("canvas");i.width=l.width,i.height=l.height;i.getContext("2d").drawImage(l,0,0),URL.revokeObjectURL(a);const r=i.toDataURL("image/png").replace("image/png","image/octet-stream");this.triggerDownload(this.getExportName("png"),r)}}downloadAsJson(i=!1){const r=i?this.model.symbolsSelected:this.model.symbols,s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(r,null,2));this.triggerDownload(this.getExportName("json"),s)}extractStrokesFromSymbols(r){if(!(null==r?void 0:r.length))return[];const s=[];return r.forEach((r=>{switch(r.type){case i.SymbolType.Stroke:s.push(r);break;case i.SymbolType.Group:s.push(...r.extractStrokes())}})),s}extractBackendChanges(i){var r,s,n,a,l;const d={};d.added=this.extractStrokesFromSymbols(i.added),d.erased=this.extractStrokesFromSymbols(i.erased);const h=this.extractStrokesFromSymbols(i.updated),c=h.concat(this.extractStrokesFromSymbols(null===(r=i.replaced)||void 0===r?void 0:r.oldSymbols)),u=h.concat(this.extractStrokesFromSymbols(null===(s=i.replaced)||void 0===s?void 0:s.newSymbols));return c.length&&u.length?d.replaced={oldStrokes:c,newStrokes:u}:(d.added.push(...u),d.erased.push(...c)),i.matrix&&(d.matrix={strokes:this.extractStrokesFromSymbols(i.matrix.symbols),matrix:i.matrix.matrix}),(null===(n=i.translate)||void 0===n?void 0:n.length)&&(d.translate=[],i.translate.forEach((i=>{const r=this.extractStrokesFromSymbols(i.symbols);r.length&&d.translate.push({strokes:r,tx:i.tx,ty:i.ty})}))),(null===(a=i.scale)||void 0===a?void 0:a.length)&&(d.scale=[],i.scale.forEach((i=>{const r=this.extractStrokesFromSymbols(i.symbols);r.length&&d.scale.push({strokes:r,origin:i.origin,scaleX:i.scaleX,scaleY:i.scaleY})}))),(null===(l=i.rotate)||void 0===l?void 0:l.length)&&(d.rotate=[],i.rotate.forEach((i=>{const r=this.extractStrokesFromSymbols(i.symbols);r.length&&d.rotate.push({strokes:r,center:i.center,angle:i.angle})}))),d}undo(){var i,r,s,n,a;return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,wt,"f").info("undo"),this.history.context.canUndo){this.internalEvent.emitIdle(!1),this.unselectAll();const l=this.history.undo(),d=l.model.extractDifferenceSymbols(this.model);__classPrivateFieldSet(this,Pt,l.model.clone(),"f"),__classPrivateFieldGet(this,wt,"f").debug("undo",{previousStackItem:l});const h=this.extractBackendChanges(l.changes);d.removed.forEach((i=>this.renderer.removeSymbol(i.id))),d.added.forEach((i=>this.renderer.drawSymbol(i))),((null===(i=h.added)||void 0===i?void 0:i.length)||(null===(r=h.erased)||void 0===r?void 0:r.length)||h.replaced||h.matrix||(null===(s=h.translate)||void 0===s?void 0:s.length)||(null===(n=h.scale)||void 0===n?void 0:n.length)||(null===(a=h.rotate)||void 0===a?void 0:a.length))&&(yield this.recognizer.undo(h)),this.updateLayerInfos()}return this.model}))}redo(){var i,r,s,n,a;return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,wt,"f").info("redo"),this.history.context.canRedo){this.internalEvent.emitIdle(!1),this.unselectAll();const l=this.history.redo(),d=l.model.extractDifferenceSymbols(this.model);__classPrivateFieldSet(this,Pt,l.model.clone(),"f"),__classPrivateFieldGet(this,wt,"f").debug("redo",{modifications:d});const h=this.extractBackendChanges(l.changes);d.removed.forEach((i=>this.renderer.removeSymbol(i.id))),d.added.forEach((i=>this.renderer.drawSymbol(i))),((null===(i=h.added)||void 0===i?void 0:i.length)||(null===(r=h.erased)||void 0===r?void 0:r.length)||h.replaced||h.matrix||(null===(s=h.translate)||void 0===s?void 0:s.length)||(null===(n=h.scale)||void 0===n?void 0:n.length)||(null===(a=h.rotate)||void 0===a?void 0:a.length))&&(yield this.recognizer.redo(h)),this.updateLayerInfos()}return this.model}))}export(i){return __awaiter(this,void 0,void 0,(function*(){try{__classPrivateFieldGet(this,wt,"f").info("export",{mimeTypes:i});const r=yield this.recognizer.export(i);this.model.mergeExport(r)}catch(i){throw __classPrivateFieldGet(this,wt,"f").error("export",{error:i}),this.internalEvent.emitError(i),i}return this.model}))}convert(){return __awaiter(this,void 0,void 0,(function*(){try{this.internalEvent.emitIdle(!1),yield this.converter.apply()}catch(i){throw __classPrivateFieldGet(this,wt,"f").error("convert",i),this.internalEvent.emitError(i),i}finally{this.updateLayerInfos()}return this.model}))}resize(i,r){return __awaiter(this,void 0,void 0,(function*(){return this.internalEvent.emitIdle(!1),__classPrivateFieldGet(this,wt,"f").info("resize",{height:i,width:r}),this.model.height=i,this.model.width=r,this.renderer.resize(i,r),this.menu.update(),this.internalEvent.emitIdle(!0),this.model}))}clear(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,wt,"f").info("clear"),this.internalEvent.emitIdle(!1),this.model.symbols.length){this.selector.removeSelectedGroup();const i=this.model.symbols;this.renderer.clear(),this.model.clear(),this.history.push(this.model,{erased:i}),this.recognizer.clear(),this.internalEvent.emitSelected(this.model.symbolsSelected)}return this.updateLayerInfos(),this.model}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,wt,"f").info("destroy"),this.grabber.detach(),this.renderer.destroy(),this.menu.destroy(),this.recognizer.destroy(),this.model.clear(),this.history.clear(),Promise.resolve()}))}}wt=new WeakMap,_t=new WeakMap,Pt=new WeakMap,Et=new WeakMap,kt=new WeakMap;class RestBehaviors{constructor(r){var s,n,a,l;if(this.name="RestBehaviors",Mt.set(this,LoggerManager.getLogger(i.LoggerClass.BEHAVIORS)),Ct.set(this,void 0),Gt.set(this,void 0),Tt.set(this,void 0),It.set(this,void 0),__classPrivateFieldGet(this,Mt,"f").info("constructor",{options:r}),__classPrivateFieldSet(this,Ct,new Configuration(null==r?void 0:r.configuration),"f"),this.styleManager=new StyleManager(null==r?void 0:r.penStyle,null==r?void 0:r.theme),null===(s=r.behaviors)||void 0===s?void 0:s.grabber){const i=null===(n=r.behaviors)||void 0===n?void 0:n.grabber;this.grabber=new i(__classPrivateFieldGet(this,Ct,"f").grabber)}else this.grabber=new PointerEventGrabber(__classPrivateFieldGet(this,Ct,"f").grabber);if(null===(a=r.behaviors)||void 0===a?void 0:a.recognizer){const i=null===(l=r.behaviors)||void 0===l?void 0:l.recognizer;this.recognizer=new i(__classPrivateFieldGet(this,Ct,"f").server,__classPrivateFieldGet(this,Ct,"f").recognition)}else this.recognizer=new RestRecognizer(__classPrivateFieldGet(this,Ct,"f").server,__classPrivateFieldGet(this,Ct,"f").recognition);this.renderer=new CanvasRenderer(__classPrivateFieldGet(this,Ct,"f").rendering),this.intention=i.Intention.Write,__classPrivateFieldSet(this,Gt,new Model,"f"),this.history=new HistoryManager(__classPrivateFieldGet(this,Ct,"f")["undo-redo"])}onPointerDown(r,s){var n;__classPrivateFieldGet(this,Mt,"f").info("onPointerDown",{intention:this.intention,evt:r,point:s});const{pointerType:a}=r,l=Object.assign({},null===(n=this.theme)||void 0===n?void 0:n.ink,this.currentPenStyle);switch(this.intention){case i.Intention.Erase:this.model.removeStrokesFromPoint(s).length>0&&this.renderer.drawModel(this.model);break;case i.Intention.Write:this.model.initCurrentStroke(s,a,l),this.drawCurrentStroke();break;default:__classPrivateFieldGet(this,Mt,"f").warn("#onPointerDown",`onPointerDown intention unknow: "${this.intention}"`)}}onPointerMove(r,s){switch(__classPrivateFieldGet(this,Mt,"f").info("onPointerMove",{intention:this.intention,point:s}),this.intention){case i.Intention.Erase:this.model.removeStrokesFromPoint(s).length>0&&this.renderer.drawModel(this.model);break;case i.Intention.Write:this.model.appendToCurrentStroke(s),this.drawCurrentStroke();break;default:__classPrivateFieldGet(this,Mt,"f").warn("#onPointerMove",`onPointerMove intention unknow: "${this.intention}"`)}}onPointerUp(r,s){var n;return __awaiter(this,void 0,void 0,(function*(){switch(__classPrivateFieldGet(this,Mt,"f").info("onPointerUp",{intention:this.intention,point:s}),this.intention){case i.Intention.Erase:this.model.removeStrokesFromPoint(s),(null===(n=this.history.stack.at(-1))||void 0===n?void 0:n.modificationDate)!==this.model.modificationDate&&(yield this.updateModelRendering());break;case i.Intention.Write:this.model.endCurrentStroke(s),yield this.updateModelRendering();break;default:__classPrivateFieldGet(this,Mt,"f").warn("#onPointerUp",`onPointerUp intention unknow: "${this.intention}"`)}}))}get internalEvent(){return InternalEvent.getInstance()}get model(){return __classPrivateFieldGet(this,Gt,"f")}get currentPenStyle(){return this.styleManager.currentPenStyle}get penStyle(){return this.styleManager.penStyle}setPenStyle(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("setPenStyle",{penStyle:i}),this.styleManager.setPenStyle(i),Promise.resolve()}))}get penStyleClasses(){return this.styleManager.penStyleClasses}setPenStyleClasses(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("setPenStyleClasses",{penStyleClasses:i}),this.styleManager.setPenStyleClasses(i),Promise.resolve()}))}get theme(){return this.styleManager.theme}setTheme(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("setTheme",{theme:i}),this.styleManager.setTheme(i),Promise.resolve()}))}get configuration(){return __classPrivateFieldGet(this,Ct,"f")}init(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("init",{domElement:i}),this.model.width=Math.max(i.clientWidth,__classPrivateFieldGet(this,Ct,"f").rendering.minWidth),this.model.height=Math.max(i.clientHeight,__classPrivateFieldGet(this,Ct,"f").rendering.minHeight),this.history.push(this.model),this.renderer.init(i),this.grabber.attach(i),this.grabber.onPointerDown=this.onPointerDown.bind(this),this.grabber.onPointerMove=this.onPointerMove.bind(this),this.grabber.onPointerUp=this.onPointerUp.bind(this),Promise.resolve()}))}drawCurrentStroke(){__classPrivateFieldGet(this,Mt,"f").debug("drawCurrentStroke",{stroke:this.model.currentSymbol}),this.renderer.drawPendingStroke(this.model.currentSymbol)}updateModelRendering(){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Mt,"f").info("updateModelRendering"),this.renderer.drawModel(this.model);const i=new DeferredPromise;if(this.history.push(this.model),"DEMAND"!==__classPrivateFieldGet(this,Ct,"f").triggers.exportContent){clearTimeout(__classPrivateFieldGet(this,It,"f"));let r=this.model.clone();__classPrivateFieldSet(this,It,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){try{r=yield this.recognizer.export(r),this.history.updateStack(r),this.model.modificationDate===r.modificationDate&&(this.model.exports=r.exports),i.resolve(this.model)}catch(r){__classPrivateFieldGet(this,Mt,"f").error("updateModelRendering",{error:r}),this.internalEvent.emitError(r),i.reject(r)}}))),"QUIET_PERIOD"===__classPrivateFieldGet(this,Ct,"f").triggers.exportContent?__classPrivateFieldGet(this,Ct,"f").triggers.exportContentDelay:0),"f")}else i.resolve(this.model);return yield i.promise,this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,Mt,"f").debug("updateModelRendering",this.model.exports),i.promise}))}export(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Mt,"f").info("export",{mimeTypes:i});const r=yield this.recognizer.export(this.model.clone(),i);return this.model.modificationDate===r.modificationDate&&this.model.mergeExport(r.exports),this.history.updateStack(r),__classPrivateFieldGet(this,Mt,"f").debug("export",this.model),this.model}))}convert(i,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Mt,"f").info("convert",{conversionState:i,requestedMimeTypes:r});const s=yield this.recognizer.convert(this.model,i,r);return Object.assign(__classPrivateFieldGet(this,Gt,"f"),s),__classPrivateFieldGet(this,Mt,"f").debug("convert",this.model),this.model}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){const r=[];i.forEach(((i,s)=>{var n,a;let l=!0;const d=new Stroke(i.style||de,i.pointerType);if(i.id&&(d.id=i.id),!(null===(n=i.pointers)||void 0===n?void 0:n.length))return r.push(`stroke ${s+1} has not pointers`),void(l=!1);null===(a=i.pointers)||void 0===a||a.forEach(((i,n)=>{if(!i)return r.push(`stroke ${s+1} has no pointer at ${n}`),void(l=!1);const a={p:i.p||1,t:i.t||n,x:0,y:0};return null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(r.push(`stroke ${s+1} has no x at pointer at ${n}`),void(l=!1)):(a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(r.push(`stroke ${s+1} has no y at pointer at ${n}`),void(l=!1)):(a.y=i.y,void(l&&d.pointers.push(a))))})),l&&this.model.addStroke(d)})),r.length&&this.internalEvent.emitError(new Error(r.join("\n")));try{const i=yield this.updateModelRendering();return Object.assign(__classPrivateFieldGet(this,Gt,"f"),i),this.model}catch(i){throw this.internalEvent.emitError(i),i}}))}resize(i,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Mt,"f").info("resize",{height:i,width:r});const s=new DeferredPromise;return this.model.height=i,this.model.width=r,this.renderer.resize(this.model),this.model.symbols.length?(clearTimeout(__classPrivateFieldGet(this,Tt,"f")),__classPrivateFieldSet(this,Tt,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){const i=yield this.recognizer.resize(this.model);s.resolve(i)}))),__classPrivateFieldGet(this,Ct,"f").triggers.resizeTriggerDelay),"f")):s.resolve(this.model),__classPrivateFieldSet(this,Gt,yield s.promise,"f"),__classPrivateFieldGet(this,Mt,"f").debug("resize",{model:this.model}),this.internalEvent.emitExported(this.model.exports),this.model}))}undo(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("undo"),__classPrivateFieldSet(this,Gt,this.history.undo(),"f"),this.renderer.drawModel(__classPrivateFieldGet(this,Gt,"f")),__classPrivateFieldSet(this,Gt,yield this.recognizer.export(__classPrivateFieldGet(this,Gt,"f")),"f"),this.history.updateStack(__classPrivateFieldGet(this,Gt,"f")),this.internalEvent.emitExported(__classPrivateFieldGet(this,Gt,"f").exports),__classPrivateFieldGet(this,Mt,"f").debug("undo",__classPrivateFieldGet(this,Gt,"f")),__classPrivateFieldGet(this,Gt,"f")}))}redo(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("redo"),__classPrivateFieldSet(this,Gt,this.history.redo(),"f"),this.renderer.drawModel(__classPrivateFieldGet(this,Gt,"f")),__classPrivateFieldSet(this,Gt,yield this.recognizer.export(__classPrivateFieldGet(this,Gt,"f")),"f"),this.history.updateStack(__classPrivateFieldGet(this,Gt,"f")),this.internalEvent.emitExported(__classPrivateFieldGet(this,Gt,"f").exports),__classPrivateFieldGet(this,Mt,"f").debug("redo",__classPrivateFieldGet(this,Gt,"f")),__classPrivateFieldGet(this,Gt,"f")}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("clear"),this.model.clear(),this.history.push(this.model),this.renderer.drawModel(this.model),this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,Mt,"f").debug("clear",this.model),this.model}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Mt,"f").info("destroy"),this.grabber.detach(),this.renderer.destroy(),Promise.resolve()}))}}Mt=new WeakMap,Ct=new WeakMap,Gt=new WeakMap,Tt=new WeakMap,It=new WeakMap;class WSBehaviors{constructor(r){var s,n,a,l;if(this.name="WSBehaviors",Lt.set(this,LoggerManager.getLogger(i.LoggerClass.BEHAVIORS)),Ft.set(this,void 0),Ot.set(this,void 0),Dt.set(this,void 0),__classPrivateFieldGet(this,Lt,"f").info("constructor",{options:r}),__classPrivateFieldSet(this,Ft,new Configuration(null==r?void 0:r.configuration),"f"),this.styleManager=new StyleManager(null==r?void 0:r.penStyle,null==r?void 0:r.theme),null===(s=r.behaviors)||void 0===s?void 0:s.grabber){const i=null===(n=r.behaviors)||void 0===n?void 0:n.grabber;this.grabber=new i(__classPrivateFieldGet(this,Ft,"f").grabber)}else this.grabber=new PointerEventGrabber(__classPrivateFieldGet(this,Ft,"f").grabber);if(null===(a=r.behaviors)||void 0===a?void 0:a.recognizer){const i=null===(l=r.behaviors)||void 0===l?void 0:l.recognizer;this.recognizer=new i(__classPrivateFieldGet(this,Ft,"f").server,__classPrivateFieldGet(this,Ft,"f").recognition)}else this.recognizer=new WSRecognizer(__classPrivateFieldGet(this,Ft,"f").server,__classPrivateFieldGet(this,Ft,"f").recognition);this.renderer=new WSSVGRenderer(__classPrivateFieldGet(this,Ft,"f").rendering),this.intention=i.Intention.Write,__classPrivateFieldSet(this,Ot,new Model,"f"),this.history=new HistoryManager(__classPrivateFieldGet(this,Ft,"f")["undo-redo"])}get internalEvent(){return InternalEvent.getInstance()}get model(){return __classPrivateFieldGet(this,Ot,"f")}get configuration(){return __classPrivateFieldGet(this,Ft,"f")}get currentPenStyle(){return this.styleManager.currentPenStyle}get penStyle(){return this.styleManager.penStyle}setPenStyle(i){return __classPrivateFieldGet(this,Lt,"f").info("setPenStyle",{penStyle:i}),this.styleManager.setPenStyle(i),__classPrivateFieldGet(this,Lt,"f").debug("setPenStyle",this.styleManager.penStyle),this.recognizer.setPenStyle(this.styleManager.penStyle)}get penStyleClasses(){return this.styleManager.penStyleClasses}setPenStyleClasses(i){return __classPrivateFieldGet(this,Lt,"f").info("setPenStyleClasses",{penClass:i}),this.styleManager.setPenStyleClasses(i),__classPrivateFieldGet(this,Lt,"f").debug("setPenStyleClasses",this.styleManager.penStyleClasses),this.recognizer.setPenStyleClasses(this.styleManager.penStyleClasses)}get theme(){return this.styleManager.theme}setTheme(i){return __classPrivateFieldGet(this,Lt,"f").info("setTheme",{theme:i}),this.styleManager.setTheme(i),__classPrivateFieldGet(this,Lt,"f").debug("setTheme",this.styleManager.theme),this.recognizer.setTheme(this.styleManager.theme)}onExport(i){__classPrivateFieldGet(this,Lt,"f").debug("onExport",{exports:i}),this.model.mergeExport(i)}onPointerDown(r,s){var n;__classPrivateFieldGet(this,Lt,"f").info("onPointerDown",{intention:this.intention,evt:r,point:s});let{pointerType:a}=r;const l=Object.assign({},null===(n=this.theme)||void 0===n?void 0:n.ink,this.currentPenStyle);this.intention===i.Intention.Erase&&(a="eraser"),this.model.initCurrentStroke(s,a,l),this.drawCurrentStroke()}onPointerMove(i,r){__classPrivateFieldGet(this,Lt,"f").info("onPointerMove",{intention:this.intention,point:r}),this.model.appendToCurrentStroke(r),this.drawCurrentStroke()}onPointerUp(i,r){return __awaiter(this,void 0,void 0,(function*(){try{__classPrivateFieldGet(this,Lt,"f").info("onPointerUp",{intention:this.intention,point:r}),this.model.endCurrentStroke(r),yield this.synchronizeModelWithBackend()}catch(i){this.internalEvent.emitError(i)}}))}onSVGPatch(i){__classPrivateFieldGet(this,Lt,"f").info("onSVGPatch",{evt:i}),this.renderer.updatesLayer(i.layer,i.updates)}init(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Lt,"f").info("init",{domElement:i});const r=window.getComputedStyle(i);this.model.width=Math.max(parseInt(r.width.replace("px","")),__classPrivateFieldGet(this,Ft,"f").rendering.minWidth),this.model.height=Math.max(parseInt(r.height.replace("px","")),__classPrivateFieldGet(this,Ft,"f").rendering.minHeight),this.history.push(this.model),this.renderer.init(i),this.grabber.attach(i),this.grabber.onPointerDown=this.onPointerDown.bind(this),this.grabber.onPointerMove=this.onPointerMove.bind(this),this.grabber.onPointerUp=this.onPointerUp.bind(this),this.internalEvent.addExportedListener(this.onExport.bind(this)),this.internalEvent.addSVGPatchListener(this.onSVGPatch.bind(this)),yield this.recognizer.init(this.model.height,this.model.width),yield this.setPenStyle(this.penStyle),yield this.setTheme(this.theme),yield this.setPenStyleClasses(this.penStyleClasses)}))}drawCurrentStroke(){__classPrivateFieldGet(this,Lt,"f").debug("drawCurrentStroke",{stroke:this.model.currentSymbol});const i=this.model.currentSymbol;i&&this.renderer.drawPendingStroke(i)}synchronizeModelWithBackend(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Lt,"f").info("synchronizeModelWithBackend"),"DEMAND"!==__classPrivateFieldGet(this,Ft,"f").triggers.exportContent){const i=this.model.extractUnsentStrokes();this.model.updatePositionSent(),this.history.push(this.model),this.renderer.clearErasingStrokes();const r=yield this.recognizer.addStrokes(i);this.model.mergeExport(r),this.history.updateStack(this.model)}return __classPrivateFieldGet(this,Lt,"f").debug("synchronizeModelWithBackend",this.model),this.model}))}waitForIdle(){return __awaiter(this,void 0,void 0,(function*(){return this.recognizer.waitForIdle()}))}export(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Lt,"f").info("export",{mimeTypes:i});try{if("DEMAND"===__classPrivateFieldGet(this,Ft,"f").triggers.exportContent){const i=this.model.extractUnsentStrokes();this.model.updatePositionSent();const r=yield this.recognizer.addStrokes(i);return this.model.updatePositionReceived(),this.model.mergeExport(r),__classPrivateFieldGet(this,Lt,"f").debug("export",this.model),this.model}return this.recognizer.export(this.model,i)}catch(i){return __classPrivateFieldGet(this,Lt,"f").error("export",{error:i}),this.internalEvent.emitError(i),Promise.reject(i)}}))}convert(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Lt,"f").info("convert",{conversionState:i}),this.history.push(this.model),this.history.stack.push(this.model.clone()),__classPrivateFieldSet(this,Ot,yield this.recognizer.convert(this.model,i),"f"),__classPrivateFieldGet(this,Lt,"f").debug("convert",this.model),this.history.push(this.model),this.model}))}import(i,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Lt,"f").info("import",{data:i,mimeType:r}),this.history.stack.push(this.model.clone());const s=yield this.recognizer.import(this.model,i,r);return this.history.push(s),s}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Lt,"f").info("importPointEvents",{strokes:i});const r=[],s=i.map(((i,s)=>{var n,a;const l=new Stroke(i.style||de,i.pointerType);i.id&&(l.id=i.id),i.pointerType&&(l.pointerType=i.pointerType),(null===(n=i.pointers)||void 0===n?void 0:n.length)||r.push(`stroke ${s+1} has not pointers`);let d=!0;return null===(a=i.pointers)||void 0===a||a.forEach(((i,n)=>{if(d=!0,!i)return void r.push(`stroke ${s+1} has no pointer at ${n}`);const a={p:i.p||1,t:i.t||n,x:0,y:0};null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(r.push(`stroke ${s+1} has no x at pointer at ${n}`),d=!1):a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(r.push(`stroke ${s+1} has no y at pointer at ${n}`),d=!1):a.y=i.y,d&&l.pointers.push(a)})),l}));r.length&&this.internalEvent.emitError(new Error(r.join("\n"))),s.map((i=>this.model.addStroke(i)));const n=yield this.recognizer.importPointEvents(s);return this.model.mergeExport(n),__classPrivateFieldGet(this,Lt,"f").debug("importPointEvents",this.model),this.model}))}resize(i,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Lt,"f").info("resize",{height:i,width:r});const s=new DeferredPromise;this.model.height=i,this.model.width=r;const n=this.model.clone();return this.renderer.resize(n),clearTimeout(__classPrivateFieldGet(this,Dt,"f")),__classPrivateFieldSet(this,Dt,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){try{const i=yield this.recognizer.resize(n);s.resolve(i)}catch(n){__classPrivateFieldGet(this,Lt,"f").error("resize",{height:i,width:r,error:n}),s.reject(n)}}))),__classPrivateFieldGet(this,Ft,"f").triggers.resizeTriggerDelay),"f"),__classPrivateFieldSet(this,Ot,yield s.promise,"f"),this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,Lt,"f").debug("resize",this.model),this.model}))}undo(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Lt,"f").info("undo"),this.history.context.canUndo)return __classPrivateFieldSet(this,Ot,this.history.undo(),"f"),this.recognizer.undo(this.model);throw new Error("Undo not allowed")}))}redo(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Lt,"f").info("redo"),this.history.context.canRedo)return __classPrivateFieldSet(this,Ot,this.history.redo(),"f"),__classPrivateFieldGet(this,Lt,"f").debug("undo",__classPrivateFieldGet(this,Ot,"f")),this.recognizer.redo(this.model);throw new Error("Redo not allowed")}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Lt,"f").info("clear"),this.model.clear(),this.history.push(this.model),this.recognizer.clear(this.model)}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Lt,"f").info("destroy"),this.grabber.detach(),this.renderer.destroy(),this.recognizer.destroy(),Promise.resolve()}))}}Lt=new WeakMap,Ft=new WeakMap,Ot=new WeakMap,Dt=new WeakMap;class SmartGuide{constructor(){Rt.add(this),At.set(this,void 0),Bt.set(this,void 0),$t.set(this,void 0),Nt.set(this,void 0),zt.set(this,void 0),jt.set(this,void 0),Vt.set(this,void 0),Wt.set(this,void 0),Ht.set(this,void 0),Ut.set(this,void 0),Xt.set(this,void 0),Kt.set(this,void 0),Yt.set(this,LoggerManager.getLogger(i.LoggerClass.SMARTGUIDE)),ai.set(this,(i=>{var r,s;__classPrivateFieldGet(this,Yt,"f").info("showCandidates",{target:i});const n=parseInt(i.id.replace("word-","").replace(this.uuid,"")),a=null===(r=this.jiix)||void 0===r?void 0:r.words;this.wordToChange=a[n],this.wordToChange&&(this.wordToChange.id=n.toString(),__classPrivateFieldGet(this,Vt,"f").innerHTML="",(null===(s=this.wordToChange)||void 0===s?void 0:s.candidates)&&(__classPrivateFieldGet(this,Vt,"f").style.display="flex",this.wordToChange.candidates.forEach(((i,r)=>{var s;(null===(s=this.wordToChange)||void 0===s?void 0:s.label)===i?__classPrivateFieldGet(this,Vt,"f").innerHTML+=`<span id="cdt-${r}${this.uuid}" class="selected-word">${i}</span>`:__classPrivateFieldGet(this,Vt,"f").innerHTML+=`<span id="cdt-${r}${this.uuid}">${i}</span>`})),i.appendChild(__classPrivateFieldGet(this,Vt,"f"))))})),ci.set(this,(i=>{__classPrivateFieldGet(this,Yt,"f").info("onClickEllipsis",{evt:i}),i.preventDefault(),i.stopPropagation(),__classPrivateFieldGet(this,Kt,"f")?__classPrivateFieldGet(this,Rt,"m",hi).call(this):__classPrivateFieldGet(this,Rt,"m",di).call(this),__classPrivateFieldGet(this,Rt,"m",li).call(this)})),ui.set(this,(i=>{__classPrivateFieldGet(this,Yt,"f").info("onClickConvert",{evt:i}),i.preventDefault(),i.stopPropagation(),this.internalEvent.emitConvert(),__classPrivateFieldGet(this,Rt,"m",hi).call(this)})),gi.set(this,(i=>__awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Yt,"f").info("onClickCopy",{evt:i}),i.preventDefault(),i.stopPropagation();try{__classPrivateFieldGet(this,Rt,"m",hi).call(this);let i="Nothing to copy";if(__classPrivateFieldGet(this,Nt,"f").innerText){i=`"${__classPrivateFieldGet(this,Nt,"f").innerText}" copied to clipboard`;const r=__classPrivateFieldGet(this,Rt,"m",pi).call(this,__classPrivateFieldGet(this,Nt,"f").innerText);__classPrivateFieldGet(this,$t,"f").appendChild(r),__classPrivateFieldGet(this,Rt,"m",mi).call(this,r),document.execCommand("copy"),r.remove()}this.internalEvent.emitNotif({message:i,timeout:1500})}catch(i){__classPrivateFieldGet(this,Yt,"f").error("onClickCopy",i),this.internalEvent.emitError(i)}})))),vi.set(this,(i=>{__classPrivateFieldGet(this,Yt,"f").info("onClickDelete",{evt:i}),i.preventDefault(),i.stopPropagation(),this.internalEvent.emitClear(),__classPrivateFieldGet(this,Rt,"m",hi).call(this)})),yi.set(this,(i=>{var r,s,n,a,l;__classPrivateFieldGet(this,Yt,"f").info("onClickCandidate",{evt:i}),i.preventDefault(),i.stopPropagation();const d=i.target.innerText;(null===(r=this.jiix)||void 0===r?void 0:r.words)&&d!==(null===(s=this.wordToChange)||void 0===s?void 0:s.label)&&(null===(a=null===(n=this.wordToChange)||void 0===n?void 0:n.candidates)||void 0===a?void 0:a.includes(d))&&(this.jiix.words[parseInt(null===(l=this.wordToChange)||void 0===l?void 0:l.id)].label=d,this.internalEvent.emitImportJIIX(this.jiix)),__classPrivateFieldGet(this,Vt,"f").style.display="none"})),fi.set(this,(i=>{__classPrivateFieldGet(this,Yt,"f").info("onClickPrompter",{evt:i}),i.preventDefault(),i.stopPropagation(),__classPrivateFieldGet(this,Rt,"m",hi).call(this);const r=i.target;r.id!==__classPrivateFieldGet(this,Nt,"f").id?__classPrivateFieldGet(this,ai,"f").call(this,r):__classPrivateFieldGet(this,Rt,"m",li).call(this)})),bi.set(this,(i=>{i.preventDefault(),i.stopPropagation()})),xi.set(this,(()=>{__classPrivateFieldGet(this,Rt,"m",li).call(this),__classPrivateFieldGet(this,Rt,"m",hi).call(this)})),__classPrivateFieldGet(this,Yt,"f").info("constructor"),this.uuid=createUUID(),this.margin={bottom:0,left:0,right:0,top:0},__classPrivateFieldGet(this,Rt,"m",Jt).call(this),__classPrivateFieldGet(this,Rt,"m",qt).call(this),__classPrivateFieldGet(this,Rt,"m",Zt).call(this),__classPrivateFieldGet(this,Rt,"m",Qt).call(this),__classPrivateFieldGet(this,Rt,"m",ei).call(this),__classPrivateFieldGet(this,Rt,"m",ti).call(this),__classPrivateFieldGet(this,Rt,"m",ii).call(this),__classPrivateFieldGet(this,Rt,"m",ri).call(this),__classPrivateFieldGet(this,Rt,"m",si).call(this),__classPrivateFieldGet(this,Rt,"m",ni).call(this),__classPrivateFieldGet(this,Rt,"m",oi).call(this)}get internalEvent(){return InternalEvent.getInstance()}init(i,r,s){__classPrivateFieldGet(this,Yt,"f").info("init",{domElement:i,margin:r,renderingConfiguration:s}),i.appendChild(__classPrivateFieldGet(this,At,"f")),__classPrivateFieldGet(this,At,"f").appendChild(__classPrivateFieldGet(this,Bt,"f")),__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,jt,"f")),__classPrivateFieldGet(this,$t,"f").appendChild(__classPrivateFieldGet(this,Nt,"f")),__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,$t,"f")),__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,zt,"f")),__classPrivateFieldGet(this,Wt,"f").appendChild(__classPrivateFieldGet(this,Ht,"f")),__classPrivateFieldGet(this,Wt,"f").appendChild(__classPrivateFieldGet(this,Ut,"f")),__classPrivateFieldGet(this,Wt,"f").appendChild(__classPrivateFieldGet(this,Xt,"f")),__classPrivateFieldGet(this,Wt,"f").classList.add("close"),__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,Wt,"f")),__classPrivateFieldSet(this,Kt,!1,"f"),__classPrivateFieldGet(this,Vt,"f").style.display="none",__classPrivateFieldGet(this,Bt,"f").appendChild(__classPrivateFieldGet(this,Vt,"f")),this.margin=r,this.renderingConfiguration=s,__classPrivateFieldGet(this,Rt,"m",Si).call(this),this.resize()}resize(){__classPrivateFieldGet(this,Yt,"f").info("resize");const i=convertMillimeterToPixel(this.margin.left),r=convertMillimeterToPixel(this.margin.right);__classPrivateFieldGet(this,Bt,"f").style.marginLeft=`${i}px`,__classPrivateFieldGet(this,Bt,"f").style.marginRight=`${r}px`}update(i){var r,s;__classPrivateFieldGet(this,Yt,"f").info("update",{exports:i}),this.jiix=i;const createWordSpan=(i,r)=>{const s=document.createElement("span");return s.id=`word-${i}${this.uuid}`,r?s.textContent=r.label:s.innerHTML="&nbsp;",__classPrivateFieldGet(this,Yt,"f").debug("update",{span:s}),s};(()=>{var i;if(__classPrivateFieldGet(this,Yt,"f").info("populatePrompter"),__classPrivateFieldGet(this,Nt,"f").innerHTML="",null===(i=this.jiix)||void 0===i?void 0:i.words){const i=this.jiix.words,r=document.createDocumentFragment();i.forEach(((s,n)=>{var a,l,d;if(" "===s.label||s.label.includes("\n"))r.appendChild(createWordSpan(n));else if(n!==i.length-1)r.appendChild(createWordSpan(n,s));else{__classPrivateFieldGet(this,Nt,"f").appendChild(r),this.lastWord&&(this.lastWord=s);const i=createWordSpan(n,s);(null===(a=this.lastWord)||void 0===a?void 0:a.candidates)!==s.candidates&&(null===(l=this.lastWord)||void 0===l?void 0:l.label)!==s.label&&(this.lastWord=s),(null===(d=this.wordToChange)||void 0===d?void 0:d.id)===n.toString()?(i.classList.add("modified-word"),this.wordToChange=void 0):i.classList.add("added-word"),__classPrivateFieldGet(this,Nt,"f").appendChild(i),__classPrivateFieldGet(this,$t,"f").scrollLeft=i.offsetLeft,__classPrivateFieldGet(this,Yt,"f").debug("update => populatePrompter",{span:i,lastWord:this.lastWord})}}))}})(),(null===(s=null===(r=this.jiix)||void 0===r?void 0:r.words)||void 0===s?void 0:s.length)?__classPrivateFieldGet(this,zt,"f").style.setProperty("pointer-events","auto"):__classPrivateFieldGet(this,zt,"f").style.setProperty("pointer-events","none")}clear(){__classPrivateFieldGet(this,Yt,"f").info("clear"),__classPrivateFieldGet(this,Nt,"f").innerHTML="",__classPrivateFieldGet(this,Vt,"f").innerHTML=""}destroy(){__classPrivateFieldGet(this,Yt,"f").info("destroy"),__classPrivateFieldGet(this,Rt,"m",wi).call(this),__classPrivateFieldGet(this,At,"f").remove()}}At=new WeakMap,Bt=new WeakMap,$t=new WeakMap,Nt=new WeakMap,zt=new WeakMap,jt=new WeakMap,Vt=new WeakMap,Wt=new WeakMap,Ht=new WeakMap,Ut=new WeakMap,Xt=new WeakMap,Kt=new WeakMap,Yt=new WeakMap,ai=new WeakMap,ci=new WeakMap,ui=new WeakMap,gi=new WeakMap,vi=new WeakMap,yi=new WeakMap,fi=new WeakMap,bi=new WeakMap,xi=new WeakMap,Rt=new WeakSet,Jt=function _SmartGuide_createRootElement(){__classPrivateFieldSet(this,At,document.createElement("div"),"f"),__classPrivateFieldGet(this,At,"f").id=`smartguide-${this.uuid}`,__classPrivateFieldGet(this,At,"f").classList.add("smartguide"),__classPrivateFieldGet(this,At,"f").addEventListener("pointerdown",(i=>{i.preventDefault(),i.stopPropagation()}))},qt=function _SmartGuide_createWrapperElement(){__classPrivateFieldSet(this,Bt,document.createElement("div"),"f"),__classPrivateFieldGet(this,Bt,"f").id=`smartguide-wrapper-${this.uuid}`,__classPrivateFieldGet(this,Bt,"f").classList.add("smartguide-wrapper")},Zt=function _SmartGuide_createPrompterContainerElement(){__classPrivateFieldSet(this,$t,document.createElement("div"),"f"),__classPrivateFieldGet(this,$t,"f").id=`prompter-container-${this.uuid}`,__classPrivateFieldGet(this,$t,"f").classList.add("prompter-container")},Qt=function _SmartGuide_createPrompterTextElement(){__classPrivateFieldSet(this,Nt,document.createElement("div"),"f"),__classPrivateFieldGet(this,Nt,"f").id=`prompter-text-${this.uuid}`,__classPrivateFieldGet(this,Nt,"f").classList.add("prompter-text"),__classPrivateFieldGet(this,Nt,"f").setAttribute("touch-action","none")},ei=function _SmartGuide_createEllipsisElement(){__classPrivateFieldSet(this,zt,document.createElement("div"),"f"),__classPrivateFieldGet(this,zt,"f").id=`ellipsis-${this.uuid}`,__classPrivateFieldGet(this,zt,"f").classList.add("ellipsis"),__classPrivateFieldGet(this,zt,"f").innerHTML="..."},ti=function _SmartGuide_createTagElement(){__classPrivateFieldSet(this,jt,document.createElement("div"),"f"),__classPrivateFieldGet(this,jt,"f").id=`tag-icon-${this.uuid}`,__classPrivateFieldGet(this,jt,"f").classList.add("tag-icon"),__classPrivateFieldGet(this,jt,"f").innerHTML="&#182;"},ii=function _SmartGuide_createCandidatesElement(){__classPrivateFieldSet(this,Vt,document.createElement("div"),"f"),__classPrivateFieldGet(this,Vt,"f").id=`candidates-${this.uuid}`,__classPrivateFieldGet(this,Vt,"f").classList.add("candidates")},ri=function _SmartGuide_createMoreMenuElement(){__classPrivateFieldSet(this,Wt,document.createElement("div"),"f"),__classPrivateFieldGet(this,Wt,"f").id=`more-menu-${this.uuid}`,__classPrivateFieldGet(this,Wt,"f").classList.add("more-menu")},si=function _SmartGuide_createConvertElement(){__classPrivateFieldSet(this,Ht,document.createElement("button"),"f"),__classPrivateFieldGet(this,Ht,"f").id=`convert-${this.uuid}`,__classPrivateFieldGet(this,Ht,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,Ht,"f").innerHTML="Convert"},ni=function _SmartGuide_createCopyElement(){__classPrivateFieldSet(this,Ut,document.createElement("button"),"f"),__classPrivateFieldGet(this,Ut,"f").id=`copy-${this.uuid}`,__classPrivateFieldGet(this,Ut,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,Ut,"f").innerHTML="Copy"},oi=function _SmartGuide_createDeleteElement(){__classPrivateFieldSet(this,Xt,document.createElement("button"),"f"),__classPrivateFieldGet(this,Xt,"f").id=`delete-${this.uuid}`,__classPrivateFieldGet(this,Xt,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,Xt,"f").innerHTML="Delete"},li=function _SmartGuide_hideCandidates(){__classPrivateFieldGet(this,Vt,"f").style.display="none"},di=function _SmartGuide_openMenu(){__classPrivateFieldGet(this,Wt,"f").classList.add("open"),__classPrivateFieldGet(this,Wt,"f").classList.remove("close"),__classPrivateFieldSet(this,Kt,!0,"f")},hi=function _SmartGuide_closeMenu(){__classPrivateFieldGet(this,Wt,"f").classList.add("close"),__classPrivateFieldGet(this,Wt,"f").classList.remove("open"),__classPrivateFieldSet(this,Kt,!1,"f")},pi=function _SmartGuide_createTextAreaElement(i){const r="rtl"===document.documentElement.getAttribute("dir"),s=document.createElement("textarea");s.style.fontSize="12pt",s.style.display="absolute",s.style[r?"right":"left"]="-9999px";const n=window.pageYOffset||document.documentElement.scrollTop;return s.style.top=`${n}px`,s.setAttribute("readonly",""),s.value=i,s},mi=function _SmartGuide_selectText(i){if(navigator.userAgent.match(/ipad|iphone/i)){const r=document.createRange();r.selectNodeContents(i);const s=window.getSelection();s&&(s.removeAllRanges(),s.addRange(r),i.setSelectionRange(0,999999))}else i.select()},Si=function _SmartGuide_addListeners(){__classPrivateFieldGet(this,At,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,bi,"f").bind(this)),__classPrivateFieldGet(this,zt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ci,"f").bind(this)),__classPrivateFieldGet(this,Ht,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ui,"f").bind(this)),__classPrivateFieldGet(this,Ut,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,gi,"f").bind(this)),__classPrivateFieldGet(this,Xt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,vi,"f").bind(this)),__classPrivateFieldGet(this,Nt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,fi,"f").bind(this)),__classPrivateFieldGet(this,Vt,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,yi,"f").bind(this)),document.addEventListener("pointerdown",__classPrivateFieldGet(this,xi,"f").bind(this))},wi=function _SmartGuide_removeListeners(){__classPrivateFieldGet(this,At,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,bi,"f")),__classPrivateFieldGet(this,zt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,ci,"f")),__classPrivateFieldGet(this,Ht,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,ui,"f")),__classPrivateFieldGet(this,Ut,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,gi,"f")),__classPrivateFieldGet(this,Xt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,vi,"f")),__classPrivateFieldGet(this,Nt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,fi,"f")),__classPrivateFieldGet(this,Vt,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,yi,"f")),document.removeEventListener("pointerdown",__classPrivateFieldGet(this,xi,"f"))};Pi=new WeakMap,Ei=new WeakMap,ki=new WeakMap,Mi=new WeakMap,Ci=new WeakMap,Gi=new WeakMap,Ti=new WeakMap,Ii=new WeakMap,Li=new WeakMap,Fi=new WeakMap,Oi=new WeakMap,Di=new WeakMap,Ri=new WeakMap,Xi=new WeakMap,Ki=new WeakMap,Yi=new WeakMap,Ji=new WeakMap,_i=new WeakSet,Ai=function _Editor_setCursorIntention(){switch(this.behaviors.intention){case i.Intention.Erase:this.wrapperHTML.classList.remove("draw"),this.wrapperHTML.classList.add("erase"),this.wrapperHTML.classList.remove("select");break;case i.Intention.Select:this.wrapperHTML.classList.remove("draw"),this.wrapperHTML.classList.remove("erase"),this.wrapperHTML.classList.add("select");break;default:this.wrapperHTML.classList.add("draw"),this.wrapperHTML.classList.remove("erase"),this.wrapperHTML.classList.remove("select")}},Bi=function _Editor_createLoader(){return __classPrivateFieldSet(this,Ei,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ei,"f").classList.add("loader"),__classPrivateFieldGet(this,Ei,"f").style.display="none",__classPrivateFieldGet(this,Ei,"f")},$i=function _Editor_createMessage(){__classPrivateFieldSet(this,ki,document.createElement("div"),"f"),__classPrivateFieldGet(this,ki,"f").classList.add("message-container"),__classPrivateFieldGet(this,ki,"f").style.display="none",__classPrivateFieldSet(this,Ci,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ci,"f").classList.add("message-overlay"),__classPrivateFieldGet(this,ki,"f").appendChild(__classPrivateFieldGet(this,Ci,"f")),__classPrivateFieldSet(this,Mi,document.createElement("div"),"f"),__classPrivateFieldGet(this,Mi,"f").classList.add("message-modal");const i=document.createElement("button");return i.classList.add("ms-button","close"),i.addEventListener("pointerup",(()=>this.closeMessageModal())),__classPrivateFieldGet(this,Mi,"f").appendChild(i),__classPrivateFieldSet(this,Gi,document.createElement("p"),"f"),__classPrivateFieldGet(this,Mi,"f").appendChild(__classPrivateFieldGet(this,Gi,"f")),__classPrivateFieldGet(this,ki,"f").appendChild(__classPrivateFieldGet(this,Mi,"f")),__classPrivateFieldGet(this,ki,"f")},Ni=function _Editor_createEditorState(){return __classPrivateFieldSet(this,Ti,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ti,"f").classList.add("state"),__classPrivateFieldSet(this,Li,document.createElement("div"),"f"),__classPrivateFieldGet(this,Li,"f").textContent="idle",__classPrivateFieldGet(this,Li,"f").style.display="block",__classPrivateFieldGet(this,Ti,"f").appendChild(__classPrivateFieldGet(this,Li,"f")),__classPrivateFieldSet(this,Ii,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ii,"f").classList.add("busy"),__classPrivateFieldGet(this,Ii,"f").style.display="none",__classPrivateFieldGet(this,Ti,"f").appendChild(__classPrivateFieldGet(this,Ii,"f")),__classPrivateFieldGet(this,Ti,"f").style.display="none",__classPrivateFieldGet(this,Ti,"f")},zi=function _Editor_updateEditorState(i){this.configuration.offscreen?(__classPrivateFieldGet(this,Ti,"f").style.display="block",i?(__classPrivateFieldGet(this,Li,"f").style.display="block",__classPrivateFieldGet(this,Ii,"f").style.display="none"):(__classPrivateFieldGet(this,Li,"f").style.display="none",__classPrivateFieldGet(this,Ii,"f").style.display="block")):__classPrivateFieldGet(this,Ti,"f").style.display="none"},ji=function _Editor_createLayerInfos(){return __classPrivateFieldSet(this,Pi,document.createElement("div"),"f"),__classPrivateFieldGet(this,Pi,"f").classList.add("ms-layer-infos"),__classPrivateFieldGet(this,Pi,"f").appendChild(__classPrivateFieldGet(this,_i,"m",Bi).call(this)),__classPrivateFieldGet(this,Pi,"f").appendChild(__classPrivateFieldGet(this,_i,"m",$i).call(this)),__classPrivateFieldGet(this,Pi,"f").appendChild(__classPrivateFieldGet(this,_i,"m",Ni).call(this)),__classPrivateFieldGet(this,Pi,"f")},Vi=function _Editor_instantiateBehaviors(i){var r;if(this.logger.info("instantiateBehaviors",{options:i}),!(null==i?void 0:i.configuration))throw new Error("Configuration required");this.internalEvents.removeAllListeners(),__classPrivateFieldGet(this,Fi,"f")&&__classPrivateFieldGet(this,Fi,"f").destroy(),i.configuration.offscreen?__classPrivateFieldSet(this,Fi,new OIBehaviors(i,__classPrivateFieldGet(this,Pi,"f")),"f"):"REST"===(null===(r=i.configuration.server)||void 0===r?void 0:r.protocol)?__classPrivateFieldSet(this,Fi,new RestBehaviors(i),"f"):__classPrivateFieldSet(this,Fi,new WSBehaviors(i),"f"),this.logger.debug("instantiateBehaviors",__classPrivateFieldGet(this,Fi,"f"))},Wi=function _Editor_initializeBehaviors(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("initializeBehaviors","start"),__classPrivateFieldSet(this,Di,new DeferredPromise,"f"),__classPrivateFieldGet(this,Ei,"f").style.display="initial",this.closeMessageModal(),this.behaviors.init(this.wrapperHTML).then((()=>__awaiter(this,void 0,void 0,(function*(){this.logger.info("initializeBehaviors","then"),this.wrapperHTML.editor=this,__classPrivateFieldGet(this,Di,"f").resolve(),this.events.emitLoaded()})))).catch((i=>{this.logger.error("initializeBehaviors",i),__classPrivateFieldGet(this,Di,"f").reject(i),this.showError(i)})).finally((()=>(this.logger.debug("initializeBehaviors","finally"),__classPrivateFieldGet(this,Ei,"f").style.display="none",__classPrivateFieldGet(this,_i,"m",zi).call(this,!0),__classPrivateFieldGet(this,Di,"f").promise)))}))},Hi=function _Editor_initializeSmartGuide(){var i;if(null===(i=__classPrivateFieldGet(this,Oi,"f"))||void 0===i||i.destroy(),this.logger.info("initializeSmartGuide",{smartGuide:this.configuration.rendering.smartGuide}),this.configuration.rendering.smartGuide.enable){let i;switch(__classPrivateFieldSet(this,Oi,new SmartGuide,"f"),this.configuration.recognition.type){case"TEXT":i=this.configuration.recognition.text.margin;break;case"MATH":i=this.configuration.recognition.math.margin;break;default:i={top:20,left:10,right:10,bottom:10}}__classPrivateFieldGet(this,Oi,"f").init(__classPrivateFieldGet(this,Pi,"f"),i,this.configuration.rendering)}},Ui=function _Editor_addInternalListeners(){this.internalEvents.removeAllListeners(),this.internalEvents.addConvertListener(this.convert.bind(this)),this.internalEvents.addClearListener(this.clear.bind(this)),this.internalEvents.addErrorListener(this.showError.bind(this)),this.internalEvents.addNotifListener(this.showNotif.bind(this)),this.internalEvents.addClearMessageListener(this.closeMessageModal.bind(this)),this.internalEvents.addImportJIIXListener(__classPrivateFieldGet(this,_i,"m",Zi).bind(this)),this.internalEvents.addExportedListener(__classPrivateFieldGet(this,_i,"m",qi).bind(this)),this.internalEvents.addContextChangeListener(__classPrivateFieldGet(this,Yi,"f").bind(this)),this.internalEvents.addIdleListener(__classPrivateFieldGet(this,Ji,"f").bind(this)),this.internalEvents.addSelectedListener(__classPrivateFieldGet(this,Xi,"f").bind(this)),this.internalEvents.addIntentionListener(__classPrivateFieldGet(this,Ki,"f").bind(this))},qi=function _Editor_onExport(i){var r;if(this.logger.info("onExport",{exports:i}),this.configuration.rendering.smartGuide.enable&&i&&i["application/vnd.myscript.jiix"]){const s=i["application/vnd.myscript.jiix"];null===(r=__classPrivateFieldGet(this,Oi,"f"))||void 0===r||r.update(s)}this.events.emitExported(i)},Zi=function _Editor_onImportJIIX(r){this.logger.info("onImportJIIX",{jiix:r}),this.import(new Blob([JSON.stringify(r)],{type:i.ExportType.JIIX}),i.ExportType.JIIX)},i.Box=Box,i.CanvasRenderer=CanvasRenderer,i.CanvasRendererShape=CanvasRendererShape,i.CanvasRendererStroke=CanvasRendererStroke,i.CanvasRendererText=CanvasRendererText,i.Configuration=Configuration,i.DefaultConfiguration=$,i.DefaultConvertionConfiguration=T,i.DefaultDebugConfiguration=k,i.DefaultDiagramConfiguration=f,i.DefaultDiagramConvertConfiguration=y,i.DefaultEraserConfiguration=v,i.DefaultExportConfiguration=x,i.DefaultGrabberConfiguration=m,i.DefaultGuidesConfiguration=L,i.DefaultJiixConfiguration=b,i.DefaultListenerConfiguration=p,i.DefaultLoggerConfiguration=N,i.DefaultMarginConfiguration=S,i.DefaultMathConfiguration=P,i.DefaultMathUndoRedoConfiguration=_,i.DefaultMenuConfiguration=g,i.DefaultPenStyle=de,i.DefaultRawContentConfiguration=E,i.DefaultRecognitionConfiguration=I,i.DefaultRecognitionRendererConfiguration=M,i.DefaultRenderingConfiguration=O,i.DefaultServerConfiguration=D,i.DefaultSmartGuidesConfiguration=F,i.DefaultSolverConfiguration=w,i.DefaultStyle=le,i.DefaultTextConfiguration=G,i.DefaultTextGuidesConfiguration=C,i.DefaultTheme=he,i.DefaultTriggerConfiguration=R,i.DefaultUndoRedoConfiguration=A,i.DeferredPromise=DeferredPromise,i.Editor=class Editor{constructor(r,s,n="ms-editor"){_i.add(this),this.logger=LoggerManager.getLogger(i.LoggerClass.EDITOR),Pi.set(this,void 0),Ei.set(this,void 0),ki.set(this,void 0),Mi.set(this,void 0),Ci.set(this,void 0),Gi.set(this,void 0),Ti.set(this,void 0),Ii.set(this,void 0),Li.set(this,void 0),Fi.set(this,void 0),Oi.set(this,void 0),Di.set(this,void 0),Ri.set(this,void 0),Xi.set(this,(i=>{this.events.emitSelected(i)})),Ki.set(this,(i=>{this.intention=i,this.events.emitIntention(i)})),Yi.set(this,(i=>{this.events.emitChanged(i)})),Ji.set(this,(i=>{__classPrivateFieldGet(this,_i,"m",zi).call(this,i),this.events.emitIdle(i)})),__classPrivateFieldSet(this,Di,new DeferredPromise,"f"),this.loggerConfiguration=mergeDeep({},s.logger,N),this.logger.info("constructor",{wrapperHTML:r,options:s,globalClassCss:n}),this.wrapperHTML=r,this.wrapperHTML.classList.add(n),this.wrapperHTML.classList.add("draw"),this.events.setElement(this.wrapperHTML);const a=document.createElement("style");a.appendChild(document.createTextNode(".ms-editor{color:#1a9fff;font-family:sans-serif;height:100%;overflow:auto;position:relative;width:100%;z-index:10}#editor:active,#editor:focus{-webkit-tap-highlight-color:transparent}.ms-editor input:not([type=checkbox]):not([type=color]):not([type=range]),.ms-editor select{-webkit-tap-highlight-color:transparent;-webkit-appearance:none;appearance:none;border:1px solid #ced5d9;border-radius:3px;color:#131f26;font:600 14px Source Sans Pro,sans-serif;height:2rem;padding:0 10px}.ms-editor input[type=file]{border:none!important}.ms-editor input[type=file]:focus{border:none!important;box-shadow:none!important}.ms-editor input[type=file]:focus::file-selector-button{border:1px solid #1a9fff!important}.ms-editor input[type=file]::file-selector-button{background-color:#fff;border:1px solid rgba(0,0,0,.16);border-radius:4px;box-shadow:0 1px 0 rgba(0,0,0,.05);cursor:pointer;height:2rem;margin:0 auto 0 8px;padding:0 16px;transition:background-color .2s}.ms-editor input[type=file]::file-selector-button:hover{background-color:#f3f4f6}.ms-editor input[type=file]::file-selector-button:active{background-color:#e5e7eb}.ms-editor select{background:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTQuNDIyLjI2Yy0uMjMzLS4zMzctLjYxLS4zMzctLjg0NCAwTC4xNzUgNS4xN0MtLjE0MiA1LjYyOC4wNDggNiAuNjEgNmg2Ljc4Yy41NTggMCAuNzU0LS4zNy40MzUtLjgzTDQuNDIyLjI2em0uMDIgMTMuNDdjLS4yMzYuMzQyLS42MTguMzQ3LS44NS4wMUwuMTY3IDguODE4Qy0uMTQ2IDguMzY3LjA0OCA4IC42MDggOGg2Ljc4M2MuNTU4IDAgLjc1NS4zNy40MzcuODNsLTMuMzg1IDQuOXoiIGZpbGw9IiMxMzFGMjYiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvc3ZnPg==) 100% no-repeat #fff;padding:0 25px 0 10px}.ms-editor input:not([type=checkbox]):not([type=color]):not([type=range]):not([type=file]):focus,.ms-editor select:focus{border:1px solid #1a9fff;box-shadow:0 1px 1px 0 rgba(0,0,0,.16);outline:0}.ms-editor.draw{cursor:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m14.363 5.652 1.48-1.48a2 2 0 0 1 2.829 0l1.414 1.414a2 2 0 0 1 0 2.828l-1.48 1.48m-4.243-4.242-9.616 9.615a2 2 0 0 0-.578 1.238l-.242 2.74a1 1 0 0 0 1.084 1.085l2.74-.242a2 2 0 0 0 1.24-.578l9.615-9.616m-4.243-4.242 4.243 4.242' stroke='%23000' fill='%23fff' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\") 5 20,pointer}.ms-editor.draw.shape{cursor:crosshair}.ms-editor.erase{cursor:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m2.893 12.607 9.193-9.193a2 2 0 0 1 2.828 0l4.95 4.95a2 2 0 0 1 0 2.828l-9.243 9.243a1.929 1.929 0 0 1-2.728 0l-5-5a2 2 0 0 1 0-2.828Z' stroke='%23000' fill='%23fff' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M21 21H9M15.889 14.89 8.464 7.463' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\") 5 20,auto}.ms-editor.move{cursor:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' xmlns='http://www.w3.org/2000/svg' fill='%23fff'%3E%3Cpath d='m7 10.5-2.004 2.672a2 2 0 0 0 .126 2.552l3.784 4.128c.378.413.912.648 1.473.648H15c2.4 0 4-1.5 4-4 0 0 0 0 0 0V7.929M16 8.5v-.571c0-2.286 3-2.286 3 0' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M13 8.5V7.027m0-.527v.527M16 8.5V7.027c0-2.286-3-2.286-3 0' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M13 8.5V7.027c0-2.286 3-2.286 3 0V8.5M10 8.5v-2c0-2.286 3-2.286 3 0 0 0 0 0 0 0v2M7 13.5v-7A1.5 1.5 0 0 1 8.5 5v0c.828 0 1.5.555 1.5 1.384V8.5' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\") 10 10,auto}.ms-editor.select{cursor:context-menu}.ms-editor canvas,.ms-editor svg{left:0;position:absolute;top:0;z-index:20}.ms-editor canvas.ms-rendering-canvas{background-image:linear-gradient(90deg,#f5f6f7 1px,transparent 0),linear-gradient(180deg,#f5f6f7 1px,transparent 0);background-size:18px 18px;pointer-events:none;z-index:9}.ms-editor .ms-layer-infos{height:100%;left:0;pointer-events:none;position:sticky;top:0;user-select:none;width:100%;z-index:25}.ms-editor .ms-layer-infos>*{cursor:auto;pointer-events:all;user-select:none}.ms-editor .loader{-webkit-animation:spin 2s linear infinite;animation:spin 2s linear infinite;border:16px solid #f5f6f7;border-radius:50%;border-top-color:#1a9fff;height:120px;left:calc(50% - 60px);position:absolute;top:calc(50% - 60px);width:120px;z-index:30}.ms-editor .state{background-color:#f5f6f7;box-shadow:1px 1px 5px rgba(0,0,0,.25),-1px -1px 5px rgba(0,0,0,.25);color:#717171;cursor:auto;height:50px;left:0;padding:12px;position:absolute;top:calc(100% - 50px);width:50px;z-index:99}.ms-editor .state .busy{-webkit-animation:spin 2s linear infinite;animation:spin 2s linear infinite;border:4px solid #1a9fff;border-radius:100%;border-right-color:#f5f6f7;color:#717171;height:100%;width:100%}.ms-editor .state .idle{align-items:center;display:flex;justify-content:center}.ms-editor .message-container,.ms-editor .message-overlay{height:100%;position:absolute;width:100%}.ms-editor .message-overlay{background-color:hsla(0,0%,73%,.25);z-index:99}.ms-editor .message-modal{word-wrap:break-word;background-color:#fff;box-shadow:1px 1px 5px rgba(0,0,0,.25),-1px -1px 5px rgba(0,0,0,.25);font-size:16px;left:calc(50% - 150px);max-height:50%;overflow:auto;padding:12px;position:absolute;text-align:center;top:50%;transform:translateY(-50%);width:300px;z-index:999}.ms-editor .message-modal.error-msg:before{content:url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgNzYuNSA2MTIgNDU5IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWluWU1pbiBtZWV0Ij48cGF0aCBmaWxsPSIjMUE5RkZGIiBkPSJNNDk0LjcgMjI5LjVjLTE3Ljg1MS04Ni43LTk0LjM1MS0xNTMtMTg4LjctMTUzLTM4LjI1IDAtNzMuOTUgMTAuMi0xMDIgMzAuNmwzOC4yNSAzOC4yNWMxNy44NS0xMi43NSA0MC44LTE3Ljg1IDYzLjc1LTE3Ljg1IDc2LjUgMCAxNDAuMjUgNjMuNzUgMTQwLjI1IDE0MC4yNXYxMi43NWgzOC4yNWM0My4zNSAwIDc2LjUgMzMuMTUgNzYuNSA3Ni41IDAgMjguMDUtMTUuMyA1My41NS00MC44IDY2LjNsMzguMjUgMzguMjVDNTkxLjYgNDM4LjYgNjEyIDQwMC4zNSA2MTIgMzU3YzAtNjYuMy01My41NS0xMjIuNC0xMTcuMy0xMjcuNXpNNzYuNSAxMDkuNjVsNzEuNCA2OC44NUM2Ni4zIDE4My42IDAgMjQ5LjkgMCAzMzEuNWMwIDg0LjE1IDY4Ljg1IDE1MyAxNTMgMTUzaDI5OC4zNWw1MSA1MSAzMy4xNS0zMy4xNUwxMDkuNjUgNzYuNSA3Ni41IDEwOS42NXpNMTk2LjM1IDIyOS41bDIwNCAyMDRIMTUzYy01Ni4xIDAtMTAyLTQ1LjktMTAyLTEwMnM0NS45LTEwMiAxMDItMTAyaDQzLjM1eiIvPjwvc3ZnPg==\")}.ms-editor .message-modal.info-msg:before{background-image:url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMUE5RkZGIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiLz48cGF0aCBkPSJNMTIgMTZ2LTRNMTIgOGguMDEiLz48L3N2Zz4=\");background-size:100% 100%;content:\"\";display:block;height:25px;margin:auto;padding-bottom:10px;width:25px}.ms-editor .message-modal .ms-button{background-color:#fff;background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' fill='none' xmlns='http://www.w3.org/2000/svg' color='%23000'%3E%3Cpath d='M9.172 14.828 12.001 12m2.828-2.828L12.001 12m0 0L9.172 9.172M12.001 12l2.828 2.828M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Z' stroke='%23000' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\");background-position:50%;background-repeat:no-repeat;border:none;border-radius:4px;color:#000;cursor:pointer;font-size:inherit;height:32px;padding:0;position:absolute;right:0;top:0;width:32px}.ms-editor .message-modal .ms-button:hover{background-color:#eee}.ms-editor .ms-tooltip .ms-tooltip-content{background-color:#fff;border-radius:5px;box-shadow:0 2px 5px 0 rgba(0,0,0,.225);color:#000;display:none;font-weight:700;opacity:1!important;padding:5px;position:absolute;white-space:nowrap;width:auto;z-index:9999}.ms-editor .ms-menu-title{background-color:#b3dfff;border-radius:5px 5px 0 0;font-size:16px;font-weight:700;margin-top:0;padding:2px;text-align:center}.ms-editor .ms-tooltip .ms-tooltip-content.top{left:50%;top:0;transform:translate(-50%,-100%)}.ms-editor .ms-tooltip .ms-tooltip-content.left{left:0;top:50%;transform:translate(-100%,-50%)}.ms-editor .ms-tooltip .ms-tooltip-content.right{right:0;top:50%;transform:translate(100%,-50%)}.ms-editor .ms-tooltip .ms-tooltip-content.bottom{bottom:0;left:50%;transform:translate(-50%,100%)}.ms-editor .smartguide{box-shadow:2px 2px 12px #bdbdbd;cursor:default;font-size:16px;left:0;line-height:48px;padding-bottom:12px;padding-top:12px;position:absolute;top:0;width:100%;z-index:40}.ms-editor .smartguide .smartguide-wrapper{border-bottom:1px solid #959da6;display:flex}.ms-editor .smartguide .tag-icon{background-color:hsla(0,0%,100%,.9);border-left:1px solid #959da6;border-right:1px solid #959da6;border-top:1px solid #959da6;font-size:large;height:100%;line-height:48px;padding:0 18px;z-index:31}.ms-editor .smartguide .ellipsis,.ms-editor .smartguide .tag-icon{color:#959da6;font-weight:700;height:48px;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;width:48px}.ms-editor .smartguide .ellipsis{-webkit-tap-highlight-color:transparent;cursor:pointer;font-size:x-large;line-height:38px;padding:0 8px}.ms-editor .smartguide .ellipsis:active{background-color:#e0e0e0}.ms-editor .smartguide .prompter-container{-webkit-tap-highlight-color:transparent;color:#bfbfbf;display:block;height:48px;line-height:48px;overflow:hidden;text-align:left;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap;width:calc(100% - 96px)}.ms-editor .smartguide .prompter-container>div>span{cursor:pointer;display:inline-block}.ms-editor .smartguide .prompter-container .prompter-text{margin-left:12px}.ms-editor .smartguide .prompter-container .prompter-text .added-word{animation:word-added .1s linear,color-input 3s ease-in-out}.ms-editor .smartguide .prompter-container .prompter-text .modified-word{animation:word-modified .1s linear,color-input 3s ease-in-out}.ms-editor .smartguide .candidates{-webkit-tap-highlight-color:transparent;background-color:#f5f5f5;border-radius:3px;box-shadow:2px 2px 12px #bdbdbd,-2px 2px 12px #bdbdbd;color:#000;flex-direction:column;line-height:30px;position:absolute;text-align:center;z-index:100}.ms-editor .smartguide .candidates>span{cursor:pointer;padding:2px 20px}.ms-editor .smartguide .candidates>span:hover{background-color:#eee}.ms-editor .smartguide .candidates>span:active{background-color:#e0e0e0}.ms-editor .smartguide .candidates .selected-word{background-color:#e0e0e0;font-weight:700}.ms-editor .smartguide .more-menu{background-color:#f5f5f5;border-radius:3px;bottom:0;box-shadow:2px 2px 12px #bdbdbd;display:flex;flex-direction:column;line-height:30px;margin-right:12px;overflow:hidden;position:absolute;right:0;transform:translateY(100%);transition:max-height 1s ease-out,opacity 1s,visibility .5s linear;z-index:100}.ms-editor .smartguide .more-menu.open{max-height:500px;opacity:1;visibility:visible}.ms-editor .smartguide .more-menu.close{max-height:0;opacity:0;visibility:hidden}.ms-editor .smartguide .more-menu .options-label-button{-webkit-tap-highlight-color:transparent;background:transparent;border:none;box-sizing:border-box;color:#000;cursor:pointer;font-size:16px;height:40px;margin:0;outline:none;padding:0 24px}.ms-editor .smartguide .more-menu .options-label-button:hover{background-color:#eee;padding:4px}.ms-editor .smartguide .more-menu .options-label-button:active{background-color:#e0e0e0}.ms-editor .ps__rail-x{top:32px!important}.ms-editor .collapsible-wrapper .collapsible-header{align-items:center;color:#424242;cursor:pointer;display:flex;justify-content:space-between}.ms-editor .collapsible-wrapper .collapsible-header:hover{background-color:#efefef}.ms-editor .collapsible-wrapper .collapsible-header .collapsible-header-icon{align-items:center;display:flex;height:32px;justify-content:center;padding:4px;position:relative;transition:transform .5s;width:32px}.ms-editor .collapsible-wrapper.active .collapsible-header .collapsible-header-icon{transform:rotate(180deg)}.ms-editor .collapsible-wrapper .collapsible-content{max-height:0;overflow:auto;transition:max-height .5s}.ms-editor .collapsible-wrapper.active .collapsible-content{max-height:200px}.ms-editor hr.separator.horizontal{border:none;border-top:1px solid #d3d3d3;margin:5px 0;max-height:1px;max-width:100%;min-height:1px;min-width:100%}.ms-editor hr.separator.vertical{border:none;border-left:1px solid #d3d3d3;margin:0 5px;max-height:100%;max-width:1px;min-height:100%;min-width:1px}.ms-editor .ms-menu{background-color:#fff;box-shadow:1px 1px 5px rgba(0,0,0,.25),-1px -1px 5px rgba(0,0,0,.25);cursor:auto;padding:5px;pointer-events:all;z-index:99}.ms-editor .ms-menu-top-left{border-radius:0 0 5px 5px;left:5px;position:absolute;top:0}.ms-editor .ms-menu-bottom{border-radius:5px;bottom:8px;left:50%;position:absolute;transform:translateX(-50%)}.ms-editor .ms-menu-top-right{border-radius:0 0 5px 5px;position:absolute;right:5px;top:0}.ms-editor .ms-menu-colmun{display:flex;flex-direction:column;justify-content:center}.ms-editor .ms-menu-row{display:flex;flex-direction:row;justify-content:center}.ms-editor .ms-menu-item{align-items:center;display:flex;gap:5px;justify-content:space-between;padding:5px;width:100%}.ms-editor .ms-menu .select-language{height:32px;padding:0 8px;width:auto}.ms-editor .ms-menu-item.list button{align-items:center;background-color:#fff;border:none;border-radius:4px;cursor:pointer;display:flex;font-size:inherit;height:32px;justify-content:center;padding:0;position:relative;width:32px}.ms-editor .ms-menu-item.list button:hover{background-color:#efefef}.ms-editor .ms-menu-item.list button.active{border:1px solid #1a9fff}.ms-editor .ms-menu .color-list{cursor:pointer;flex-wrap:wrap;gap:2px;margin:auto;max-width:150px;min-width:150px;padding:4px}.ms-editor .ms-menu .font-size-list,.ms-editor .ms-menu .thickness-list{cursor:pointer;flex-wrap:wrap;gap:2px;margin:auto;max-width:150px;min-width:150px;padding:0}.ms-editor .ms-menu .ms-menu-button{-webkit-touch-callout:none;align-items:center;background-color:#fff;border:none;border-radius:4px;color:#000;cursor:pointer;display:flex;font-size:inherit;height:32px;justify-content:space-between;padding:4px;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:100%}.ms-editor .ms-menu svg{height:20px;position:relative;width:20px}.ms-editor .ms-menu .ms-menu-button.center{justify-content:center}.ms-editor .ms-menu .ms-menu-button.square{justify-content:center;width:32px}.ms-editor .ms-menu .ms-menu-button .color{border-radius:100%;height:75%;margin:auto;width:75%}.ms-editor .ms-menu .ms-menu-button:hover{background-color:#efefef}.ms-editor .ms-menu .ms-menu-button:disabled{background-color:hsla(0,0%,100%,.4);color:rgba(0,0,0,.4);opacity:.5;pointer-events:none}.ms-editor .ms-menu .ms-menu-button:active,.ms-editor .ms-menu .ms-menu-button:focus{background-color:#1aa0ff55;outline:none}.ms-editor .ms-menu .ms-menu-button.active{border:1px solid #1a9fff;color:#1a9fff}.ms-editor .sub-menu{overflow:visible;position:relative}.ms-editor .sub-menu .sub-menu-content{background-color:#fff;border-radius:5px;box-shadow:1px 1px 5px rgba(0,0,0,.25),-1px -1px 5px rgba(0,0,0,.25);color:#000;display:none;padding:5px;position:absolute;white-space:nowrap;width:auto;z-index:100}.ms-editor .sub-menu .sub-menu-content.open{display:block}.ms-editor .sub-menu .sub-menu-content.top{left:50%;top:-8px;transform:translate(-50%,-100%)}.ms-editor .sub-menu .sub-menu-content.bottom{bottom:-8px;left:50%;transform:translate(-50%,100%)}.ms-editor .sub-menu .sub-menu-content.bottom-left{bottom:-8px;right:0;transform:translateY(100%)}.ms-editor .sub-menu .sub-menu-content.right-top{right:-8px;top:0;transform:translate(100%)}.ms-editor .sub-menu .sub-menu-content.right{right:-8px;top:50%;transform:translate(100%,-50%)}.ms-editor .ms-menu-context{position:absolute}.ms-editor output.tooltip{background-color:#fff;border-radius:5px;box-shadow:0 2px 5px 0 rgba(0,0,0,.225);color:#000;display:none;font-weight:700;left:50%;padding:5px;position:absolute;transform:translate(-50%,-250%);white-space:nowrap;width:auto}.ms-editor input:focus+output.tooltip,.ms-editor input:focus-visible+output.tooltip,.ms-editor input:hover+output.tooltip{display:block}.ms-editor .removed-stroke{opacity:0;transition:opacity .1s ease-in-out}.ms-editor .added-stroke{animation:opacity-appear .2s}@keyframes color-input{0%{color:#000}to{color:#bfbfbf}}@keyframes word-added{0%{transform:translate(5px)}to{transform:none}}@keyframes word-modified{0%{transform:translateY(5px)}to{transform:none}}@keyframes opacity-appear{0%{opacity:0}to{opacity:1}}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg)}to{-webkit-transform:rotate(1turn)}}")),this.wrapperHTML.appendChild(a),this.wrapperHTML.appendChild(__classPrivateFieldGet(this,_i,"m",ji).call(this)),__classPrivateFieldGet(this,_i,"m",Vi).call(this,s)}get loggerConfiguration(){return __classPrivateFieldGet(this,Ri,"f")}set loggerConfiguration(i){__classPrivateFieldSet(this,Ri,Object.assign({},N,i),"f"),LoggerManager.setLoggerLevel(__classPrivateFieldGet(this,Ri,"f"))}get initializationPromise(){return __classPrivateFieldGet(this,Di,"f").promise}get model(){return this.behaviors.model}get behaviors(){return __classPrivateFieldGet(this,Fi,"f")}get configuration(){return this.behaviors.configuration}set configuration(i){this.logger.info("set configuration",{configuration:i}),__classPrivateFieldGet(this,_i,"m",Vi).call(this,{configuration:i}),this.initialize()}get intention(){return this.behaviors.intention}set intention(i){this.logger.info("set intention",i),this.behaviors.intention=i,__classPrivateFieldGet(this,_i,"m",Ai).call(this)}get events(){return PublicEvent.getInstance()}get internalEvents(){return InternalEvent.getInstance()}get context(){return this.behaviors.history.context}get grabber(){return this.behaviors.grabber}get currentPenStyle(){return this.behaviors.currentPenStyle}get penStyle(){return this.behaviors.penStyle}set penStyle(i){this.logger.info("set penStyle",{ps:i}),this.behaviors.setPenStyle(i)}get theme(){return this.behaviors.theme}set theme(i){this.logger.info("set theme",{t:i}),this.behaviors.setTheme(i)}get penStyleClasses(){return this.behaviors.penStyleClasses}set penStyleClasses(i){this.logger.info("set penStyleClasses",{psc:i}),this.behaviors.setPenStyleClasses(i)}closeMessageModal(){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,ki,"f").style.display="none",__classPrivateFieldGet(this,Gi,"f").innerText="",__classPrivateFieldGet(this,Mi,"f").classList.contains("error-msg")&&(__classPrivateFieldGet(this,Mi,"f").classList.remove("error-msg"),yield this.behaviors.destroy(),this.initialize())}))}showError(i){__classPrivateFieldGet(this,Mi,"f").classList.add("error-msg"),__classPrivateFieldGet(this,Mi,"f").classList.remove("info-msg"),__classPrivateFieldGet(this,ki,"f").style.display="block",__classPrivateFieldGet(this,Gi,"f").innerText="string"==typeof i?i:i.message}showNotif(i){__classPrivateFieldGet(this,Mi,"f").classList.add("info-msg"),__classPrivateFieldGet(this,Mi,"f").classList.remove("error-msg"),__classPrivateFieldGet(this,ki,"f").style.display="block",__classPrivateFieldGet(this,Gi,"f").innerText=i.message,setTimeout((()=>{this.closeMessageModal()}),i.timeout||2500)}initialize(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("initialize"),__classPrivateFieldGet(this,_i,"m",Ui).call(this),yield __classPrivateFieldGet(this,_i,"m",Wi).call(this),__classPrivateFieldGet(this,_i,"m",Hi).call(this)}))}waitForIdle(){return __awaiter(this,void 0,void 0,(function*(){if(this.behaviors.waitForIdle)return this.behaviors.waitForIdle()}))}undo(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("undo"),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.undo(),this.logger.debug("undo",this.model),this.model}))}redo(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("redo"),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.redo(),this.logger.debug("redo",this.model),this.model}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("clear"),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.clear(),this.events.emitCleared(this.model),this.logger.debug("clear",this.model),this.model}))}resize(){var i;return __awaiter(this,void 0,void 0,(function*(){this.logger.info("resize"),yield __classPrivateFieldGet(this,Di,"f").promise,this.configuration.rendering.smartGuide.enable&&(null===(i=__classPrivateFieldGet(this,Oi,"f"))||void 0===i||i.resize());const r=window.getComputedStyle(this.wrapperHTML),s=Math.max(parseInt(r.height.replace("px","")),this.configuration.rendering.minHeight),n=Math.max(parseInt(r.width.replace("px","")),this.configuration.rendering.minWidth);return yield this.behaviors.resize(s,n),this.logger.debug("resize",this.model),this.model}))}export(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("export",{mimeTypes:i}),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.export(i),this.logger.debug("export",this.model),this.model}))}convert(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("export",{params:i}),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.convert(null==i?void 0:i.conversionState,null==i?void 0:i.mimeTypes),this.events.emitConverted(this.model.converts),this.logger.debug("convert",this.model),this.model}))}import(i,r){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info("import",{data:i,mimeType:r}),yield __classPrivateFieldGet(this,Di,"f").promise,this.behaviors.import){let s;return s=i instanceof Blob?i:"string"==typeof i?new Blob([i]):new Blob([JSON.stringify(i)]),yield this.behaviors.import(s,r),this.events.emitImported(this.model.exports),this.logger.debug("import",this.model),this.model}return Promise.reject("Import impossible, behaviors has no import function")}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("importPointEvents",{strokes:i}),yield __classPrivateFieldGet(this,Di,"f").promise,yield this.behaviors.importPointEvents(i),this.events.emitImported(this.model.exports),this.logger.debug("importPointEvents",this.model),this.model}))}},i.HistoryManager=HistoryManager,i.InternalEvent=InternalEvent,i.Logger=Logger,i.LoggerManager=LoggerManager,i.MatrixTransform=MatrixTransform,i.Model=Model,i.OIBehaviors=OIBehaviors,i.OIConversionManager=OIConversionManager,i.OIDebugSVGManager=OIDebugSVGManager,i.OIDecorator=OIDecorator,i.OIEdgeArc=OIEdgeArc,i.OIEdgeBase=OIEdgeBase,i.OIEdgeLine=OIEdgeLine,i.OIEdgePolyLine=OIEdgePolyLine,i.OIEraseManager=OIEraseManager,i.OIEraser=OIEraser,i.OIGestureManager=OIGestureManager,i.OIHistoryManager=OIHistoryManager,i.OIMenu=OIMenu,i.OIMenuAction=OIMenuAction,i.OIMenuContext=OIMenuContext,i.OIMenuIntention=OIMenuIntention,i.OIMenuManager=OIMenuManager,i.OIMenuStyle=OIMenuStyle,i.OIMenuSub=OIMenuSub,i.OIModel=OIModel,i.OIMoveManager=OIMoveManager,i.OIPointerEventGrabber=OIPointerEventGrabber,i.OIRecognizer=OIRecognizer,i.OIResizeManager=OIResizeManager,i.OIRotationManager=OIRotationManager,i.OISVGRenderer=OISVGRenderer,i.OISVGRendererConst=ze,i.OISVGRendererDecoratorUtil=OISVGRendererDecoratorUtil,i.OISVGRendererEdgeUtil=OISVGRendererEdgeUtil,i.OISVGRendererEraserUtil=OISVGRendererEraserUtil,i.OISVGRendererGroupUtil=OISVGRendererGroupUtil,i.OISVGRendererShapeUtil=OISVGRendererShapeUtil,i.OISVGRendererStrokeUtil=OISVGRendererStrokeUtil,i.OISVGRendererTextUtil=OISVGRendererTextUtil,i.OISelectionManager=OISelectionManager,i.OIShapeBase=OIShapeBase,i.OIShapeCircle=OIShapeCircle,i.OIShapeEllipse=OIShapeEllipse,i.OIShapePolygon=OIShapePolygon,i.OISnapManager=OISnapManager,i.OIStroke=OIStroke,i.OISymbolBase=OISymbolBase,i.OISymbolGroup=OISymbolGroup,i.OIText=OIText,i.OITextManager=OITextManager,i.OITranslateManager=OITranslateManager,i.OIWriteManager=OIWriteManager,i.PointerEventGrabber=PointerEventGrabber,i.PublicEvent=PublicEvent,i.RestBehaviors=RestBehaviors,i.RestRecognizer=RestRecognizer,i.SELECTION_MARGIN=l,i.SVGBuilder=SVGBuilder,i.SVGStroker=SVGStroker,i.SmartGuide=SmartGuide,i.Stroke=Stroke,i.StyleHelper=me,i.StyleManager=StyleManager,i.WSBehaviors=WSBehaviors,i.WSRecognizer=WSRecognizer,i.WSSVGRenderer=WSSVGRenderer,i.computeAngleAxeRadian=computeAngleAxeRadian,i.computeAngleRadian=computeAngleRadian,i.computeAverage=computeAverage,i.computeDistance=computeDistance,i.computeDistanceBetweenPointAndSegment=function computeDistanceBetweenPointAndSegment(i,r){return computeDistance(i,computeNearestPointOnSegment(i,r))},i.computeHmac=computeHmac,i.computeLinksPointers=computeLinksPointers,i.computeMiddlePointer=computeMiddlePointer,i.computeNearestPointOnSegment=computeNearestPointOnSegment,i.computePointOnEllipse=computePointOnEllipse,i.computeRotatedPoint=computeRotatedPoint,i.convertBoundingBoxMillimeterToPixel=convertBoundingBoxMillimeterToPixel,i.convertDegreeToRadian=convertDegreeToRadian,i.convertMillimeterToPixel=convertMillimeterToPixel,i.convertPartialStrokesToOIStrokes=convertPartialStrokesToOIStrokes,i.convertPartialStrokesToStrokes=function convertPartialStrokesToStrokes(i){const r=[],s=[];if(i.forEach(((i,n)=>{var a,l;let d=!0;const h=new Stroke(i.style||de,i.pointerType);if(i.id&&(h.id=i.id),!(null===(a=i.pointers)||void 0===a?void 0:a.length))return r.push(`stroke ${n+1} has not pointers`),void(d=!1);null===(l=i.pointers)||void 0===l||l.forEach(((i,s)=>{if(!i)return r.push(`stroke ${n+1} has no pointer at ${s}`),void(d=!1);const a={p:i.p||1,t:i.t||s,x:0,y:0};return null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(r.push(`stroke ${n+1} has no x at pointer at ${s}`),void(d=!1)):(a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(r.push(`stroke ${n+1} has no y at pointer at ${s}`),void(d=!1)):(a.y=i.y,void(d&&h.pointers.push(a))))})),d&&s.push(h)})),r.length)throw new Error(r.join("\n"));return s},i.convertPixelToMillimeter=function convertPixelToMillimeter(i){return+(i/96*25.4).toFixed(3)},i.convertRadianToDegree=convertRadianToDegree,i.createPointsOnSegment=function createPointsOnSegment(i,r,s=1){const n=[],a=computeDistance(i,r);let l=s;for(;l<a;){const d={x:i.x+l*(r.x-i.x)/a,y:i.y+l*(r.y-i.y)/a};n.push(d),l+=s}return n},i.createUUID=createUUID,i.findIntersectBetweenSegmentAndCircle=findIntersectBetweenSegmentAndCircle,i.findIntersectionBetween2Segment=findIntersectionBetween2Segment,i.getAvailableFontList=function getAvailableFontList(i){var r,s,n;return __awaiter(this,void 0,void 0,(function*(){if(!(null===(r=null==i?void 0:i.server)||void 0===r?void 0:r.scheme)&&!(null===(s=null==i?void 0:i.server)||void 0===s?void 0:s.host))return Promise.reject("Failed to get fonts: configuration.server.scheme & configuration.server.host are required!");if(!(null===(n=null==i?void 0:i.recognition)||void 0===n?void 0:n.lang))return Promise.reject("Failed to get fonts: configuration.recognition.lang is required!");const a=i.server,l=yield fetch(`${a.scheme}://${a.host}/api/v4.0/iink/font/google/language/`+i.recognition.lang),{result:d}=yield l.json();return d.sort()}))},i.getAvailableLanguageList=getAvailableLanguageList,i.getClosestPoint=getClosestPoint,i.getClosestPoints=getClosestPoints,i.getInitialUndoRedoContext=getInitialUndoRedoContext,i.isBetween=isBetween,i.isPointInsideBox=function isPointInsideBox(i,r){return isBetween(i.x,r.x,r.x+r.width)&&isBetween(i.y,r.y,r.y+r.height)},i.isPointInsidePolygon=isPointInsidePolygon,i.isValidNumber=isValidNumber,i.isValidPoint=isValidPoint,i.isVersionSuperiorOrEqual=isVersionSuperiorOrEqual,i.mergeDeep=mergeDeep,i.scalaire=scalaire}));
//# sourceMappingURL=iink.min.js.map
